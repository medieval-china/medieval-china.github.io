"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderTextLayer=void 0;var _util=require("../shared/util.js"),renderTextLayer=function(){var w=30,C=.8,S=new Map,N=/\S/;function r(t,e,n,a){var r,i=document.createElement("span"),o={angle:0,canvasWidth:0,isWhitespace:!1,originalTransform:null,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,scale:1};if(t._textDivs.push(i),r=e.str,!N.test(r))return o.isWhitespace=!0,void t._textDivProperties.set(i,o);var s=_util.Util.transform(t._viewport.transform,e.transform),l=Math.atan2(s[1],s[0]),h=n[e.fontName];h.vertical&&(l+=Math.PI/2);var c,d,x=Math.hypot(s[2],s[3]),u=x*function(t,e){var n=S.get(t);if(n)return n;e.save(),e.font="".concat(w,"px ").concat(t);var a=e.measureText(""),r=a.fontBoundingBoxAscent,i=Math.abs(a.fontBoundingBoxDescent);if(r){e.restore();var o=r/(r+i);return S.set(t,o),o}e.strokeStyle="red",e.clearRect(0,0,w,w),e.strokeText("g",0,0);var s=e.getImageData(0,0,w,w).data;i=0;for(var l=s.length-1-3;0<=l;l-=4)if(0<s[l]){i=Math.ceil(l/4/w);break}e.clearRect(0,0,w,w),e.strokeText("A",0,w);for(var h=r=0,c=(s=e.getImageData(0,0,w,w).data).length;h<c;h+=4)if(0<s[h]){r=w-Math.floor(h/4/w);break}if(e.restore(),r){var d=r/(r+i);return S.set(t,d),d}return S.set(t,C),C}(h.fontFamily,a);d=0===l?(c=s[4],s[5]-u):(c=s[4]+u*Math.sin(l),s[5]-u*Math.cos(l)),i.style.left="".concat(c,"px"),i.style.top="".concat(d,"px"),i.style.fontSize="".concat(x,"px"),i.style.fontFamily=h.fontFamily,i.textContent=e.str,i.dir=e.dir,t._fontInspectorEnabled&&(i.dataset.fontName=e.fontName),0!==l&&(o.angle=l*(180/Math.PI));var p=!1;if(1<e.str.length)p=!0;else if(e.transform[0]!==e.transform[3]){var f=Math.abs(e.transform[0]),v=Math.abs(e.transform[3]);f!==v&&1.5<Math.max(f,v)/Math.min(f,v)&&(p=!0)}if(p&&(h.vertical?o.canvasWidth=e.height*t._viewport.scale:o.canvasWidth=e.width*t._viewport.scale),t._textDivProperties.set(i,o),t._textContentStream&&t._layoutText(i),t._enhanceTextSelection){var _=1,m=0;0!==l&&(_=Math.cos(l),m=Math.sin(l));var g,y,T=(h.vertical?e.height:e.width)*t._viewport.scale,b=x;y=0!==l?(g=[_,m,-m,_,c,d],_util.Util.getAxialAlignedBoundingBox([0,0,T,b],g)):[c,d,c+T,d+b],t._bounds.push({left:y[0],top:y[1],right:y[2],bottom:y[3],div:i,size:[T,b],m:g})}}function s(t){if(!t._canceled){var e=t._textDivs,n=t._capability,a=e.length;if(1e5<a)return t._renderingDone=!0,void n.resolve();if(!t._textContentStream)for(var r=0;r<a;r++)t._layoutText(e[r]);t._renderingDone=!0,n.resolve()}}function p(t,e,n){for(var a=0,r=0;r<n;r++){var i=t[e++];0<i&&(a=a?Math.min(i,a):i)}return a}function l(d){for(var x=d._bounds,t=d._viewport,u=function(r,t,e){var i=e.map(function(t,e){return{x1:t.left,y1:t.top,x2:t.right,y2:t.bottom,index:e,x1New:void 0,x2New:void 0}});a(r,i);var o=new Array(e.length);return i.forEach(function(t){var e=t.index;o[e]={left:t.x1New,top:0,right:t.x2New,bottom:0}}),e.map(function(t,e){var n=o[e],a=i[e];a.x1=t.top,a.y1=r-n.right,a.x2=t.bottom,a.y2=r-n.left,a.index=e,a.x1New=void 0,a.x2New=void 0}),a(t,i),i.forEach(function(t){var e=t.index;o[e].top=t.x1New,o[e].bottom=t.x2New}),o}(t.width,t.height,x),e=function(t){var e=x[t].div,n=d._textDivProperties.get(e);if(0===n.angle)return n.paddingLeft=x[t].left-u[t].left,n.paddingTop=x[t].top-u[t].top,n.paddingRight=u[t].right-x[t].right,n.paddingBottom=u[t].bottom-x[t].bottom,d._textDivProperties.set(e,n),"continue";var a=u[t],r=x[t],i=r.m,o=i[0],s=i[1],l=[[0,0],[0,r.size[1]],[r.size[0],0],r.size],h=new Float64Array(64);l.forEach(function(t,e){var n=_util.Util.applyTransform(t,i);h[e+0]=o&&(a.left-n[0])/o,h[e+4]=s&&(a.top-n[1])/s,h[e+8]=o&&(a.right-n[0])/o,h[e+12]=s&&(a.bottom-n[1])/s,h[e+16]=s&&(a.left-n[0])/-s,h[e+20]=o&&(a.top-n[1])/o,h[e+24]=s&&(a.right-n[0])/-s,h[e+28]=o&&(a.bottom-n[1])/o,h[e+32]=o&&(a.left-n[0])/-o,h[e+36]=s&&(a.top-n[1])/-s,h[e+40]=o&&(a.right-n[0])/-o,h[e+44]=s&&(a.bottom-n[1])/-s,h[e+48]=s&&(a.left-n[0])/s,h[e+52]=o&&(a.top-n[1])/-o,h[e+56]=s&&(a.right-n[0])/s,h[e+60]=o&&(a.bottom-n[1])/-o});var c=1+Math.min(Math.abs(o),Math.abs(s));n.paddingLeft=p(h,32,16)/c,n.paddingTop=p(h,48,16)/c,n.paddingRight=p(h,0,16)/c,n.paddingBottom=p(h,16,16)/c,d._textDivProperties.set(e,n)},n=0;n<u.length;n++)e(n)}function a(n,t){t.sort(function(t,e){return t.x1-e.x1||t.index-e.index});var u=[{start:-1/0,end:1/0,boundary:{x1:-1/0,y1:-1/0,x2:0,y2:1/0,index:-1,x1New:0,x2New:0}}];t.forEach(function(t){for(var e=0;e<u.length&&u[e].end<=t.y1;)e++;for(var n,a,r=u.length-1;0<=r&&u[r].start>=t.y2;)r--;var i,o,s=-1/0;for(i=e;i<=r;i++){var l=void 0;s<(l=(a=(n=u[i]).boundary).x2>t.x1?a.index>t.index?a.x1New:t.x1:void 0===a.x2New?(a.x2+t.x1)/2:a.x2New)&&(s=l)}for(t.x1New=s,i=e;i<=r;i++)void 0===(a=(n=u[i]).boundary).x2New?a.x2>t.x1?a.index>t.index&&(a.x2New=a.x2):a.x2New=s:a.x2New>s&&(a.x2New=Math.max(s,a.x2));var h=[],c=null;for(i=e;i<=r;i++){var d=(a=(n=u[i]).boundary).x2>t.x2?a:t;c===d?h[h.length-1].end=n.end:(h.push({start:n.start,end:n.end,boundary:d}),c=d)}for(u[e].start<t.y1&&(h[0].start=t.y1,h.unshift({start:u[e].start,end:t.y1,boundary:u[e].boundary})),t.y2<u[r].end&&(h[h.length-1].end=t.y2,h.push({start:t.y2,end:u[r].end,boundary:u[r].boundary})),i=e;i<=r;i++)if(void 0===(a=(n=u[i]).boundary).x2New){var x=!1;for(o=e-1;!x&&0<=o&&u[o].start>=a.y1;o--)x=u[o].boundary===a;for(o=r+1;!x&&o<u.length&&u[o].end<=a.y2;o++)x=u[o].boundary===a;for(o=0;!x&&o<h.length;o++)x=h[o].boundary===a;x||(a.x2New=s)}Array.prototype.splice.apply(u,[e,r-e+1].concat(h))}),u.forEach(function(t){var e=t.boundary;void 0===e.x2New&&(e.x2New=Math.max(n,e.x2))})}function n(t){var e,n=this,a=t.textContent,r=t.textContentStream,i=t.container,o=t.viewport,s=t.textDivs,l=t.textContentItemsStr,h=t.enhanceTextSelection;this._textContent=a,this._textContentStream=r,this._container=i,this._document=i.ownerDocument,this._viewport=o,this._textDivs=s||[],this._textContentItemsStr=l||[],this._enhanceTextSelection=!!h,this._fontInspectorEnabled=!(null===(e=globalThis.FontInspector)||void 0===e||!e.enabled),this._reader=null,this._layoutTextLastFontSize=null,this._layoutTextLastFontFamily=null,this._layoutTextCtx=null,this._textDivProperties=new WeakMap,this._renderingDone=!1,this._canceled=!1,this._capability=(0,_util.createPromiseCapability)(),this._renderTimer=null,this._bounds=[],this._capability.promise.finally(function(){n._layoutTextCtx&&(n._layoutTextCtx.canvas.width=0,n._layoutTextCtx.canvas.height=0,n._layoutTextCtx=null)}).catch(function(){})}return n.prototype={get promise(){return this._capability.promise},cancel:function(){this._canceled=!0,this._reader&&(this._reader.cancel(new _util.AbortException("TextLayer task cancelled.")),this._reader=null),null!==this._renderTimer&&(clearTimeout(this._renderTimer),this._renderTimer=null),this._capability.reject(new Error("TextLayer task cancelled."))},_processItems:function(t,e){for(var n=0,a=t.length;n<a;n++)this._textContentItemsStr.push(t[n].str),r(this,t[n],e,this._layoutTextCtx)},_layoutText:function(t){var e=this._textDivProperties.get(t);if(!e.isWhitespace){var n="";if(0!==e.canvasWidth){var a=t.style,r=a.fontSize,i=a.fontFamily;r===this._layoutTextLastFontSize&&i===this._layoutTextLastFontFamily||(this._layoutTextCtx.font="".concat(r," ").concat(i),this._layoutTextLastFontSize=r,this._layoutTextLastFontFamily=i);var o=this._layoutTextCtx.measureText(t.textContent).width;0<o&&(e.scale=e.canvasWidth/o,n="scaleX(".concat(e.scale,")"))}0!==e.angle&&(n="rotate(".concat(e.angle,"deg) ").concat(n)),0<n.length&&(this._enhanceTextSelection&&(e.originalTransform=n),t.style.transform=n),this._textDivProperties.set(t,e),this._container.appendChild(t)}},_render:function(t){var a=this,r=(0,_util.createPromiseCapability)(),i=Object.create(null),e=this._document.createElement("canvas");if(e.height=e.width=w,e.mozOpaque=!0,this._layoutTextCtx=e.getContext("2d",{alpha:!1}),this._textContent){var n=this._textContent.items,o=this._textContent.styles;this._processItems(n,o),r.resolve()}else{if(!this._textContentStream)throw new Error('Neither "textContent" nor "textContentStream" parameters specified.');this._reader=this._textContentStream.getReader(),function n(){a._reader.read().then(function(t){var e=t.value;t.done?r.resolve():(Object.assign(i,e.styles),a._processItems(e.items,i),n())},r.reject)}()}r.promise.then(function(){i=null,t?a._renderTimer=setTimeout(function(){s(a),a._renderTimer=null},t):s(a)},this._capability.reject)},expandTextDivs:function(t){if(this._enhanceTextSelection&&this._renderingDone){null!==this._bounds&&(l(this),this._bounds=null);for(var e=[],n=[],a=0,r=this._textDivs.length;a<r;a++){var i=this._textDivs[a],o=this._textDivProperties.get(i);o.isWhitespace||(t?(e.length=0,n.length=0,o.originalTransform&&e.push(o.originalTransform),0<o.paddingTop?(n.push("".concat(o.paddingTop,"px")),e.push("translateY(".concat(-o.paddingTop,"px)"))):n.push(0),0<o.paddingRight?n.push("".concat(o.paddingRight/o.scale,"px")):n.push(0),0<o.paddingBottom?n.push("".concat(o.paddingBottom,"px")):n.push(0),0<o.paddingLeft?(n.push("".concat(o.paddingLeft/o.scale,"px")),e.push("translateX(".concat(-o.paddingLeft/o.scale,"px)"))):n.push(0),i.style.padding=n.join(" "),e.length&&(i.style.transform=e.join(" "))):(i.style.padding=null,i.style.transform=o.originalTransform))}}}},function(t){var e=new n({textContent:t.textContent,textContentStream:t.textContentStream,container:t.container,viewport:t.viewport,textDivs:t.textDivs,textContentItemsStr:t.textContentItemsStr,enhanceTextSelection:t.enhanceTextSelection});return e._render(t.timeout),e}}();exports.renderTextLayer=renderTextLayer;