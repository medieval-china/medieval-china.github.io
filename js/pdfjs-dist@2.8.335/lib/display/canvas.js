"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _createForOfIteratorHelper(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var r=0,a=function(){};return{s:a,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,s=!0,o=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){o=!0,n=t},f:function(){try{s||null==i.return||i.return()}finally{if(o)throw n}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=new Array(e);i<e;i++)r[i]=t[i];return r}Object.defineProperty(exports,"__esModule",{value:!0}),exports.CanvasGraphics=void 0;var _util=require("../shared/util.js"),_pattern_helper=require("./pattern_helper.js"),MIN_FONT_SIZE=16,MAX_FONT_SIZE=100,MAX_GROUP_SIZE=4096,COMPILE_TYPE3_GLYPHS=!0,MAX_SIZE_TO_COMPILE=1e3,FULL_CHUNK_HEIGHT=16,LINEWIDTH_SCALE_FACTOR=1.000001;function addContextCurrentTransform(o){if(!o.mozCurrentTransform){o._originalSave=o.save,o._originalRestore=o.restore,o._originalRotate=o.rotate,o._originalScale=o.scale,o._originalTranslate=o.translate,o._originalTransform=o.transform,o._originalSetTransform=o.setTransform,o._originalResetTransform=o.resetTransform,o._transformMatrix=o._transformMatrix||[1,0,0,1,0,0],o._transformStack=[];try{var t=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(o),"lineWidth");o._setLineWidth=t.set,o._getLineWidth=t.get,Object.defineProperty(o,"lineWidth",{set:function(t){this._setLineWidth(t*LINEWIDTH_SCALE_FACTOR)},get:function(){return this._getLineWidth()}})}catch(t){}Object.defineProperty(o,"mozCurrentTransform",{get:function(){return this._transformMatrix}}),Object.defineProperty(o,"mozCurrentTransformInverse",{get:function(){var t=this._transformMatrix,e=t[0],i=t[1],r=t[2],a=t[3],n=t[4],s=t[5],o=e*a-i*r,h=i*r-e*a;return[a/o,i/h,r/h,e/o,(a*n-r*s)/h,(i*n-e*s)/o]}}),o.save=function(){var t=this._transformMatrix;this._transformStack.push(t),this._transformMatrix=t.slice(0,6),this._originalSave()},o.restore=function(){var t=this._transformStack.pop();t&&(this._transformMatrix=t,this._originalRestore())},o.translate=function(t,e){var i=this._transformMatrix;i[4]=i[0]*t+i[2]*e+i[4],i[5]=i[1]*t+i[3]*e+i[5],this._originalTranslate(t,e)},o.scale=function(t,e){var i=this._transformMatrix;i[0]=i[0]*t,i[1]=i[1]*t,i[2]=i[2]*e,i[3]=i[3]*e,this._originalScale(t,e)},o.transform=function(t,e,i,r,a,n){var s=this._transformMatrix;this._transformMatrix=[s[0]*t+s[2]*e,s[1]*t+s[3]*e,s[0]*i+s[2]*r,s[1]*i+s[3]*r,s[0]*a+s[2]*n+s[4],s[1]*a+s[3]*n+s[5]],o._originalTransform(t,e,i,r,a,n)},o.setTransform=function(t,e,i,r,a,n){this._transformMatrix=[t,e,i,r,a,n],o._originalSetTransform(t,e,i,r,a,n)},o.resetTransform=function(){this._transformMatrix=[1,0,0,1,0,0],o._originalResetTransform()},o.rotate=function(t){var e=Math.cos(t),i=Math.sin(t),r=this._transformMatrix;this._transformMatrix=[r[0]*e+r[2]*i,r[1]*e+r[3]*i,r[0]*-i+r[2]*e,r[1]*-i+r[3]*e,r[4],r[5]],this._originalRotate(t)}}}var CachedCanvases=function(){function t(t){this.canvasFactory=t,this.cache=Object.create(null)}return t.prototype={getCanvas:function(t,e,i,r){var a;return void 0!==this.cache[t]?(a=this.cache[t],this.canvasFactory.reset(a,e,i),a.context.setTransform(1,0,0,1,0,0)):(a=this.canvasFactory.create(e,i),this.cache[t]=a),r&&addContextCurrentTransform(a.context),a},clear:function(){for(var t in this.cache){var e=this.cache[t];this.canvasFactory.destroy(e),delete this.cache[t]}}},t}();function compileType3Glyph(t){var e,i,r,a,s=t.width,o=t.height,n=s+1,h=new Uint8Array(n*(o+1)),c=new Uint8Array([0,2,4,0,1,0,5,4,8,10,0,8,0,2,1,0]),l=s+7&-8,f=t.data,u=new Uint8Array(l*o),p=0;for(e=0,i=f.length;e<i;e++)for(var m=f[e],v=128;0<v;)u[p++]=m&v?0:255,v>>=1;var d=0;for((p=0)!==u[p]&&(h[0]=1,++d),r=1;r<s;r++)u[p]!==u[p+1]&&(h[r]=u[p]?2:1,++d),p++;for(0!==u[p]&&(h[r]=2,++d),e=1;e<o;e++){a=e*n,u[(p=e*l)-l]!==u[p]&&(h[a]=u[p]?1:8,++d);var g=(u[p]?4:0)+(u[p-l]?8:0);for(r=1;r<s;r++)c[g=(g>>2)+(u[p+1]?4:0)+(u[p-l+1]?8:0)]&&(h[a+r]=c[g],++d),p++;if(u[p-l]!==u[p]&&(h[a+r]=u[p]?2:4,++d),1e3<d)return null}for(a=e*n,0!==u[p=l*(o-1)]&&(h[a]=8,++d),r=1;r<s;r++)u[p]!==u[p+1]&&(h[a+r]=u[p]?4:8,++d),p++;if(0!==u[p]&&(h[a+r]=4,++d),1e3<d)return null;var x=new Int32Array([0,n,-1,0,-n,0,0,0,1]),_=[];for(e=0;d&&e<=o;e++){for(var S=e*n,b=S+s;S<b&&!h[S];)S++;if(S!==b){var T=[S%n,e],C=S,M=h[S];do{for(var k=x[M];!h[S+=k];);var y=h[S];5!==y&&10!==y?(M=y,h[S]=0):(M=y&51*M>>4,h[S]&=M>>2|M<<2),T.push(S%n),T.push(S/n|0),h[S]||--d}while(C!==S);_.push(T),--e}}return function(t){t.save(),t.scale(1/s,-1/o),t.translate(0,-o),t.beginPath();for(var e=0,i=_.length;e<i;e++){var r=_[e];t.moveTo(r[0],r[1]);for(var a=2,n=r.length;a<n;a+=2)t.lineTo(r[a],r[a+1])}t.fill(),t.beginPath(),t.restore()}}var CanvasExtraState=function(){function t(){this.alphaIsShape=!1,this.fontSize=0,this.fontSizeScale=1,this.textMatrix=_util.IDENTITY_MATRIX,this.textMatrixScale=1,this.fontMatrix=_util.FONT_IDENTITY_MATRIX,this.leading=0,this.x=0,this.y=0,this.lineX=0,this.lineY=0,this.charSpacing=0,this.wordSpacing=0,this.textHScale=1,this.textRenderingMode=_util.TextRenderingMode.FILL,this.textRise=0,this.fillColor="#000000",this.strokeColor="#000000",this.patternFill=!1,this.fillAlpha=1,this.strokeAlpha=1,this.lineWidth=1,this.activeSMask=null,this.resumeSMaskCtx=null,this.transferMaps=null}return t.prototype={clone:function(){return Object.create(this)},setCurrentPoint:function(t,e){this.x=t,this.y=e}},t}(),CanvasGraphics=function(){function s(t,e,i,r,a,n,s){this.ctx=t,this.current=new CanvasExtraState,this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=e,this.objs=i,this.canvasFactory=r,this.webGLContext=a,this.imageLayer=n,this.groupStack=[],this.processingType3=null,this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.contentVisible=!0,this.markedContentStack=[],this.optionalContentConfig=s,this.cachedCanvases=new CachedCanvases(this.canvasFactory),t&&addContextCurrentTransform(t),this._cachedGetSinglePixelWidth=null}function d(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if("undefined"!=typeof ImageData&&e instanceof ImageData)t.putImageData(e,0,0);else{var r,a,n,s,o,h,c,l,f,u=e.height,p=e.width,m=u%FULL_CHUNK_HEIGHT,v=(u-m)/FULL_CHUNK_HEIGHT,d=0===m?v:v+1,g=t.createImageData(p,FULL_CHUNK_HEIGHT),x=0,_=e.data,S=g.data;if(i)switch(i.length){case 1:h=i[0],c=i[0],l=i[0],f=i[0];break;case 4:h=i[0],c=i[1],l=i[2],f=i[3]}if(e.kind===_util.ImageKind.GRAYSCALE_1BPP){var b=_.byteLength,T=new Uint32Array(S.buffer,0,S.byteLength>>2),C=T.length,M=p+7>>3,k=4294967295,y=_util.IsLittleEndianCached.value?4278190080:255;if(f&&255===f[0]&&0===f[255]){var I=[y,k];k=I[0],y=I[1]}for(a=0;a<d;a++){for(s=a<v?FULL_CHUNK_HEIGHT:m,n=r=0;n<s;n++){for(var L=b-x,P=0,O=M<L?p:8*L-7,F=-8&O,E=0,w=0;P<F;P+=8)w=_[x++],T[r++]=128&w?k:y,T[r++]=64&w?k:y,T[r++]=32&w?k:y,T[r++]=16&w?k:y,T[r++]=8&w?k:y,T[r++]=4&w?k:y,T[r++]=2&w?k:y,T[r++]=1&w?k:y;for(;P<O;P++)0===E&&(w=_[x++],E=128),T[r++]=w&E?k:y,E>>=1}for(;r<C;)T[r++]=0;t.putImageData(g,0,a*FULL_CHUNK_HEIGHT)}}else if(e.kind===_util.ImageKind.RGBA_32BPP){var A=!!(h||c||l);for(o=p*FULL_CHUNK_HEIGHT*4,a=n=0;a<v;a++){if(S.set(_.subarray(x,x+o)),x+=o,A)for(var R=0;R<o;R+=4)h&&(S[R+0]=h[S[R+0]]),c&&(S[R+1]=c[S[R+1]]),l&&(S[R+2]=l[S[R+2]]);t.putImageData(g,0,n),n+=FULL_CHUNK_HEIGHT}if(a<d){if(o=p*m*4,S.set(_.subarray(x,x+o)),A)for(var G=0;G<o;G+=4)h&&(S[G+0]=h[S[G+0]]),c&&(S[G+1]=c[S[G+1]]),l&&(S[G+2]=l[S[G+2]]);t.putImageData(g,0,n)}}else{if(e.kind!==_util.ImageKind.RGB_24BPP)throw new Error("bad image kind: ".concat(e.kind));var H=!!(h||c||l);for(o=p*(s=FULL_CHUNK_HEIGHT),a=0;a<d;a++){for(v<=a&&(o=p*(s=m)),r=0,n=o;n--;)S[r++]=_[x++],S[r++]=_[x++],S[r++]=_[x++],S[r++]=255;if(H)for(var U=0;U<r;U+=4)h&&(S[U+0]=h[S[U+0]]),c&&(S[U+1]=c[S[U+1]]),l&&(S[U+2]=l[S[U+2]]);t.putImageData(g,0,a*FULL_CHUNK_HEIGHT)}}}}function v(t,e){for(var i=e.height,r=e.width,a=i%FULL_CHUNK_HEIGHT,n=(i-a)/FULL_CHUNK_HEIGHT,s=0===a?n:n+1,o=t.createImageData(r,FULL_CHUNK_HEIGHT),h=0,c=e.data,l=o.data,f=0;f<s;f++){for(var u=f<n?FULL_CHUNK_HEIGHT:a,p=3,m=0;m<u;m++)for(var v=void 0,d=0,g=0;g<r;g++)d||(v=c[h++],d=128),l[p]=v&d?0:255,p+=4,d>>=1;t.putImageData(o,0,f*FULL_CHUNK_HEIGHT)}}function m(t,e){for(var i=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font"],r=0,a=i.length;r<a;r++){var n=i[r];void 0!==t[n]&&(e[n]=t[n])}void 0!==t.setLineDash&&(e.setLineDash(t.getLineDash()),e.lineDashOffset=t.lineDashOffset)}function l(t){t.strokeStyle="#000000",t.fillStyle="#000000",t.fillRule="nonzero",t.globalAlpha=1,t.lineWidth=1,t.lineCap="butt",t.lineJoin="miter",t.miterLimit=10,t.globalCompositeOperation="source-over",t.font="10px sans-serif",void 0!==t.setLineDash&&(t.setLineDash([]),t.lineDashOffset=0)}function g(t,e,i,r){for(var a=t.length,n=3;n<a;n+=4){var s=t[n];if(0===s)t[n-3]=e,t[n-2]=i,t[n-1]=r;else if(s<255){var o=255-s;t[n-3]=t[n-3]*s+e*o>>8,t[n-2]=t[n-2]*s+i*o>>8,t[n-1]=t[n-1]*s+r*o>>8}}}function x(t,e,i){for(var r=t.length,a=3;a<r;a+=4){var n=i?i[t[a]]:t[a];e[a]=e[a]*n*(1/255)|0}}function _(t,e,i){for(var r=t.length,a=3;a<r;a+=4){var n=77*t[a-3]+152*t[a-2]+28*t[a-1];e[a]=i?e[a]*i[n>>8]>>8:e[a]*n>>16}}function i(t,e,i,r){var a=e.canvas,n=e.context;t.setTransform(e.scaleX,0,0,e.scaleY,e.offsetX,e.offsetY);var s=e.backdrop||null;if(!e.transferMap&&r.isEnabled){var o=r.composeSMask({layer:i.canvas,mask:a,properties:{subtype:e.subtype,backdrop:s}});return t.setTransform(1,0,0,1,0,0),void t.drawImage(o,e.offsetX,e.offsetY)}!function(t,e,i,r,a,n,s){var o,h=!!n,c=h?n[0]:0,l=h?n[1]:0,f=h?n[2]:0;o="Luminosity"===a?_:x;for(var u=Math.min(r,Math.ceil(1048576/i)),p=0;p<r;p+=u){var m=Math.min(u,r-p),v=t.getImageData(0,p,i,m),d=e.getImageData(0,p,i,m);h&&g(v.data,c,l,f),o(v.data,d.data,s),t.putImageData(d,0,p)}}(n,i,a.width,a.height,e.subtype,s,e.transferMap),t.drawImage(a,0,0)}var e=["butt","round","square"],r=["miter","round","bevel"],t={},a={};for(var n in s.prototype={beginDrawing:function(t){var e=t.transform,i=t.viewport,r=t.transparency,a=void 0!==r&&r,n=t.background,s=void 0===n?null:n,o=this.ctx.canvas.width,h=this.ctx.canvas.height;if(this.ctx.save(),this.ctx.fillStyle=s||"rgb(255, 255, 255)",this.ctx.fillRect(0,0,o,h),this.ctx.restore(),a){var c=this.cachedCanvases.getCanvas("transparent",o,h,!0);this.compositeCtx=this.ctx,this.transparentCanvas=c.canvas,this.ctx=c.context,this.ctx.save(),this.ctx.transform.apply(this.ctx,this.compositeCtx.mozCurrentTransform)}this.ctx.save(),l(this.ctx),e&&this.ctx.transform.apply(this.ctx,e),this.ctx.transform.apply(this.ctx,i.transform),this.baseTransform=this.ctx.mozCurrentTransform.slice(),this._combinedScaleFactor=Math.hypot(this.baseTransform[0],this.baseTransform[2]),this.imageLayer&&this.imageLayer.beginLayout()},executeOperatorList:function(t,e,i,r){var a=t.argsArray,n=t.fnArray,s=e||0,o=a.length;if(o===s)return s;for(var h,c=10<o-s&&"function"==typeof i,l=c?Date.now()+15:0,f=0,u=this.commonObjs,p=this.objs;;){if(void 0!==r&&s===r.nextBreakPoint)return r.breakIt(s,i),s;if((h=n[s])!==_util.OPS.dependency)this[h].apply(this,a[s]);else{var m,v=_createForOfIteratorHelper(a[s]);try{for(v.s();!(m=v.n()).done;){var d=m.value,g=d.startsWith("g_")?u:p;if(!g.has(d))return g.get(d,i),s}}catch(t){v.e(t)}finally{v.f()}}if(++s===o)return s;if(c&&10<++f){if(Date.now()>l)return i(),s;f=0}}},endDrawing:function(){for(;this.stateStack.length||null!==this.current.activeSMask;)this.restore();this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null),this.cachedCanvases.clear(),this.webGLContext.clear(),this.imageLayer&&this.imageLayer.endLayout()},setLineWidth:function(t){this.current.lineWidth=t,this.ctx.lineWidth=t},setLineCap:function(t){this.ctx.lineCap=e[t]},setLineJoin:function(t){this.ctx.lineJoin=r[t]},setMiterLimit:function(t){this.ctx.miterLimit=t},setDash:function(t,e){var i=this.ctx;void 0!==i.setLineDash&&(i.setLineDash(t),i.lineDashOffset=e)},setRenderingIntent:function(t){},setFlatness:function(t){},setGState:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e],a=r[0],n=r[1];switch(a){case"LW":this.setLineWidth(n);break;case"LC":this.setLineCap(n);break;case"LJ":this.setLineJoin(n);break;case"ML":this.setMiterLimit(n);break;case"D":this.setDash(n[0],n[1]);break;case"RI":this.setRenderingIntent(n);break;case"FL":this.setFlatness(n);break;case"Font":this.setFont(n[0],n[1]);break;case"CA":this.current.strokeAlpha=r[1];break;case"ca":this.current.fillAlpha=r[1],this.ctx.globalAlpha=r[1];break;case"BM":this.ctx.globalCompositeOperation=n;break;case"SMask":this.current.activeSMask&&(0<this.stateStack.length&&this.stateStack[this.stateStack.length-1].activeSMask===this.current.activeSMask?this.suspendSMaskGroup():this.endSMaskGroup()),this.current.activeSMask=n?this.tempSMask:null,this.current.activeSMask&&this.beginSMaskGroup(),this.tempSMask=null;break;case"TR":this.current.transferMaps=n}}},beginSMaskGroup:function(){var t=this.current.activeSMask,e=t.canvas.width,i=t.canvas.height,r="smaskGroupAt"+this.groupLevel,a=this.cachedCanvases.getCanvas(r,e,i,!0),n=this.ctx,s=n.mozCurrentTransform;this.ctx.save();var o=a.context;o.scale(1/t.scaleX,1/t.scaleY),o.translate(-t.offsetX,-t.offsetY),o.transform.apply(o,s),t.startTransformInverse=o.mozCurrentTransformInverse,m(n,o),this.ctx=o,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(n),this.groupLevel++},suspendSMaskGroup:function(){var t=this.ctx;this.groupLevel--,this.ctx=this.groupStack.pop(),i(this.ctx,this.current.activeSMask,t,this.webGLContext),this.ctx.restore(),this.ctx.save(),m(t,this.ctx),this.current.resumeSMaskCtx=t;var e=_util.Util.transform(this.current.activeSMask.startTransformInverse,t.mozCurrentTransform);this.ctx.transform.apply(this.ctx,e),t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()},resumeSMaskGroup:function(){var t=this.current.resumeSMaskCtx,e=this.ctx;this.ctx=t,this.groupStack.push(e),this.groupLevel++},endSMaskGroup:function(){var t=this.ctx;this.groupLevel--,this.ctx=this.groupStack.pop(),i(this.ctx,this.current.activeSMask,t,this.webGLContext),this.ctx.restore(),m(t,this.ctx);var e=_util.Util.transform(this.current.activeSMask.startTransformInverse,t.mozCurrentTransform);this.ctx.transform.apply(this.ctx,e)},save:function(){this.ctx.save();var t=this.current;this.stateStack.push(t),this.current=t.clone(),this.current.resumeSMaskCtx=null},restore:function(){this.current.resumeSMaskCtx&&this.resumeSMaskGroup(),null===this.current.activeSMask||0!==this.stateStack.length&&this.stateStack[this.stateStack.length-1].activeSMask===this.current.activeSMask||this.endSMaskGroup(),0!==this.stateStack.length?(this.current=this.stateStack.pop(),this.ctx.restore(),this.pendingClip=null,this._cachedGetSinglePixelWidth=null):this.current.activeSMask=null},transform:function(t,e,i,r,a,n){this.ctx.transform(t,e,i,r,a,n),this._cachedGetSinglePixelWidth=null},constructPath:function(t,e){for(var i=this.ctx,r=this.current,a=r.x,n=r.y,s=0,o=0,h=t.length;s<h;s++)switch(0|t[s]){case _util.OPS.rectangle:a=e[o++],n=e[o++];var c=e[o++],l=e[o++],f=a+c,u=n+l;i.moveTo(a,n),0===c||0===l?i.lineTo(f,u):(i.lineTo(f,n),i.lineTo(f,u),i.lineTo(a,u)),i.closePath();break;case _util.OPS.moveTo:a=e[o++],n=e[o++],i.moveTo(a,n);break;case _util.OPS.lineTo:a=e[o++],n=e[o++],i.lineTo(a,n);break;case _util.OPS.curveTo:a=e[o+4],n=e[o+5],i.bezierCurveTo(e[o],e[o+1],e[o+2],e[o+3],a,n),o+=6;break;case _util.OPS.curveTo2:i.bezierCurveTo(a,n,e[o],e[o+1],e[o+2],e[o+3]),a=e[o+2],n=e[o+3],o+=4;break;case _util.OPS.curveTo3:a=e[o+2],n=e[o+3],i.bezierCurveTo(e[o],e[o+1],a,n,a,n),o+=4;break;case _util.OPS.closePath:i.closePath()}r.setCurrentPoint(a,n)},closePath:function(){this.ctx.closePath()},stroke:function(t){t=void 0===t||t;var e=this.ctx,i=this.current.strokeColor;if(e.globalAlpha=this.current.strokeAlpha,this.contentVisible)if("object"===_typeof(i)&&null!=i&&i.getPattern){e.save();var r=e.mozCurrentTransform,a=_util.Util.singularValueDecompose2dScale(r)[0];e.strokeStyle=i.getPattern(e,this);var n=this.getSinglePixelWidth(),s=this.current.lineWidth*a;n<0&&s<=-n?(e.resetTransform(),e.lineWidth=Math.round(this._combinedScaleFactor)):e.lineWidth=Math.max(n,s),e.stroke(),e.restore()}else{var o=this.getSinglePixelWidth();o<0&&-o>=this.current.lineWidth?(e.save(),e.resetTransform(),e.lineWidth=Math.round(this._combinedScaleFactor),e.stroke(),e.restore()):(e.lineWidth=Math.max(o,this.current.lineWidth),e.stroke())}t&&this.consumePath(),e.globalAlpha=this.current.fillAlpha},closeStroke:function(){this.closePath(),this.stroke()},fill:function(t){t=void 0===t||t;var e=this.ctx,i=this.current.fillColor,r=!1;this.current.patternFill&&(e.save(),this.baseTransform&&e.setTransform.apply(e,this.baseTransform),e.fillStyle=i.getPattern(e,this),r=!0),this.contentVisible&&(this.pendingEOFill?(e.fill("evenodd"),this.pendingEOFill=!1):e.fill()),r&&e.restore(),t&&this.consumePath()},eoFill:function(){this.pendingEOFill=!0,this.fill()},fillStroke:function(){this.fill(!1),this.stroke(!1),this.consumePath()},eoFillStroke:function(){this.pendingEOFill=!0,this.fillStroke()},closeFillStroke:function(){this.closePath(),this.fillStroke()},closeEOFillStroke:function(){this.pendingEOFill=!0,this.closePath(),this.fillStroke()},endPath:function(){this.consumePath()},clip:function(){this.pendingClip=t},eoClip:function(){this.pendingClip=a},beginText:function(){this.current.textMatrix=_util.IDENTITY_MATRIX,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0},endText:function(){var t=this.pendingTextPaths,e=this.ctx;if(void 0!==t){e.save(),e.beginPath();for(var i=0;i<t.length;i++){var r=t[i];e.setTransform.apply(e,r.transform),e.translate(r.x,r.y),r.addToPath(e,r.fontSize)}e.restore(),e.clip(),e.beginPath(),delete this.pendingTextPaths}else e.beginPath()},setCharSpacing:function(t){this.current.charSpacing=t},setWordSpacing:function(t){this.current.wordSpacing=t},setHScale:function(t){this.current.textHScale=t/100},setLeading:function(t){this.current.leading=-t},setFont:function(t,e){var i=this.commonObjs.get(t),r=this.current;if(!i)throw new Error("Can't find font for ".concat(t));if(r.fontMatrix=i.fontMatrix||_util.FONT_IDENTITY_MATRIX,0!==r.fontMatrix[0]&&0!==r.fontMatrix[3]||(0,_util.warn)("Invalid font matrix for font "+t),r.fontDirection=e<0?(e=-e,-1):1,this.current.font=i,this.current.fontSize=e,!i.isType3Font){var a=i.loadedName||"sans-serif",n="normal";i.black?n="900":i.bold&&(n="bold");var s=i.italic?"italic":"normal",o='"'.concat(a,'", ').concat(i.fallbackName),h=e;e<MIN_FONT_SIZE?h=MIN_FONT_SIZE:MAX_FONT_SIZE<e&&(h=MAX_FONT_SIZE),this.current.fontSizeScale=e/h,this.ctx.font="".concat(s," ").concat(n," ").concat(h,"px ").concat(o)}},setTextRenderingMode:function(t){this.current.textRenderingMode=t},setTextRise:function(t){this.current.textRise=t},moveText:function(t,e){this.current.x=this.current.lineX+=t,this.current.y=this.current.lineY+=e},setLeadingMoveText:function(t,e){this.setLeading(-e),this.moveText(t,e)},setTextMatrix:function(t,e,i,r,a,n){this.current.textMatrix=[t,e,i,r,a,n],this.current.textMatrixScale=Math.hypot(t,e),this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0},nextLine:function(){this.moveText(0,this.current.leading)},paintChar:function(t,e,i,r,a){var n,s=this.ctx,o=this.current,h=o.font,c=o.textRenderingMode,l=o.fontSize/o.fontSizeScale,f=c&_util.TextRenderingMode.FILL_STROKE_MASK,u=!!(c&_util.TextRenderingMode.ADD_TO_PATH_FLAG),p=o.patternFill&&!h.missingFile;((h.disableFontFace||u||p)&&(n=h.getPathGenerator(this.commonObjs,t)),h.disableFontFace||p?(s.save(),s.translate(e,i),s.beginPath(),n(s,l),r&&s.setTransform.apply(s,r),f!==_util.TextRenderingMode.FILL&&f!==_util.TextRenderingMode.FILL_STROKE||s.fill(),f!==_util.TextRenderingMode.STROKE&&f!==_util.TextRenderingMode.FILL_STROKE||(a&&(s.resetTransform(),s.lineWidth=Math.round(this._combinedScaleFactor)),s.stroke()),s.restore()):(f!==_util.TextRenderingMode.FILL&&f!==_util.TextRenderingMode.FILL_STROKE||s.fillText(t,e,i),f!==_util.TextRenderingMode.STROKE&&f!==_util.TextRenderingMode.FILL_STROKE||(a?(s.save(),s.moveTo(e,i),s.resetTransform(),s.lineWidth=Math.round(this._combinedScaleFactor),s.strokeText(t,0,0),s.restore()):s.strokeText(t,e,i))),u)&&(this.pendingTextPaths||(this.pendingTextPaths=[])).push({transform:s.mozCurrentTransform,x:e,y:i,fontSize:l,addToPath:n})},get isFontSubpixelAAEnabled(){var t=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10).context;t.scale(1.5,1),t.fillText("I",0,10);for(var e=t.getImageData(0,0,10,10).data,i=!1,r=3;r<e.length;r+=4)if(0<e[r]&&e[r]<255){i=!0;break}return(0,_util.shadow)(this,"isFontSubpixelAAEnabled",i)},showText:function(t){var e=this.current,i=e.font;if(i.isType3Font)return this.showType3Text(t);var r=e.fontSize;if(0!==r){var a,n=this.ctx,s=e.fontSizeScale,o=e.charSpacing,h=e.wordSpacing,c=e.fontDirection,l=e.textHScale*c,f=t.length,u=i.vertical,p=u?1:-1,m=i.defaultVMetrics,v=r*e.fontMatrix[0],d=e.textRenderingMode===_util.TextRenderingMode.FILL&&!i.disableFontFace&&!e.patternFill;if(n.save(),e.patternFill){n.save();var g=e.fillColor.getPattern(n,this);a=n.mozCurrentTransform,n.restore(),n.fillStyle=g}n.transform.apply(n,e.textMatrix),n.translate(e.x,e.y+e.textRise),0<c?n.scale(l,-1):n.scale(l,1);var x=e.lineWidth,_=!1,S=e.textMatrixScale;if(0===S||0===x){var b=e.textRenderingMode&_util.TextRenderingMode.FILL_STROKE_MASK;b!==_util.TextRenderingMode.STROKE&&b!==_util.TextRenderingMode.FILL_STROKE||(this._cachedGetSinglePixelWidth=null,_=(x=this.getSinglePixelWidth())<0)}else x/=S;1!==s&&(n.scale(s,s),x/=s),n.lineWidth=x;var T,C=0;for(T=0;T<f;++T){var M=t[T];if((0,_util.isNum)(M))C+=p*M*r/1e3;else{var k=!1,y=(M.isSpace?h:0)+o,I=M.fontChar,L=M.accent,P=void 0,O=void 0,F=M.width;if(u){var E=M.vmetric||m,w=-(M.vmetric?E[1]:.5*F)*v,A=E[2]*v;F=E?-E[0]:F,P=w/s,O=(C+A)/s}else P=C/s,O=0;if(i.remeasure&&0<F){var R=1e3*n.measureText(I).width/r*s;if(F<R&&this.isFontSubpixelAAEnabled){var G=F/R;k=!0,n.save(),n.scale(G,1),P/=G}else F!==R&&(P+=(F-R)/2e3*r/s)}if(this.contentVisible&&(M.isInFont||i.missingFile))if(d&&!L)n.fillText(I,P,O);else if(this.paintChar(I,P,O,a,_),L){var H=P+r*L.offset.x/s,U=O-r*L.offset.y/s;this.paintChar(L.fontChar,H,U,a,_)}C+=u?F*v-y*c:F*v+y*c,k&&n.restore()}}u?e.y-=C:e.x+=C*l,n.restore()}},showType3Text:function(t){var e,i,r,a,n=this.ctx,s=this.current,o=s.font,h=s.fontSize,c=s.fontDirection,l=o.vertical?1:-1,f=s.charSpacing,u=s.wordSpacing,p=s.textHScale*c,m=s.fontMatrix||_util.FONT_IDENTITY_MATRIX,v=t.length;if(!(s.textRenderingMode===_util.TextRenderingMode.INVISIBLE)&&0!==h){for(this._cachedGetSinglePixelWidth=null,n.save(),n.transform.apply(n,s.textMatrix),n.translate(s.x,s.y),n.scale(p,c),e=0;e<v;++e)if(i=t[e],(0,_util.isNum)(i))a=l*i*h/1e3,this.ctx.translate(a,0),s.x+=a*p;else{var d=(i.isSpace?u:0)+f,g=o.charProcOperatorList[i.operatorListId];if(g)this.contentVisible&&(this.processingType3=i,this.save(),n.scale(h,h),n.transform.apply(n,m),this.executeOperatorList(g),this.restore()),r=_util.Util.applyTransform([i.width,0],m)[0]*h+d,n.translate(r,0),s.x+=r*p;else(0,_util.warn)('Type3 character "'.concat(i.operatorListId,'" is not available.'))}n.restore(),this.processingType3=null}},setCharWidth:function(t,e){},setCharWidthAndBounds:function(t,e,i,r,a,n){this.ctx.rect(i,r,a-i,n-r),this.clip(),this.endPath()},getColorN_Pattern:function(t){var e,i=this;if("TilingPattern"===t[0]){var r=t[1],a=this.baseTransform||this.ctx.mozCurrentTransform.slice(),n={createCanvasGraphics:function(t){return new s(t,i.commonObjs,i.objs,i.canvasFactory,i.webGLContext)}};e=new _pattern_helper.TilingPattern(t,r,this.ctx,n,a)}else e=(0,_pattern_helper.getShadingPatternFromIR)(t);return e},setStrokeColorN:function(){this.current.strokeColor=this.getColorN_Pattern(arguments)},setFillColorN:function(){this.current.fillColor=this.getColorN_Pattern(arguments),this.current.patternFill=!0},setStrokeRGBColor:function(t,e,i){var r=_util.Util.makeHexColor(t,e,i);this.ctx.strokeStyle=r,this.current.strokeColor=r},setFillRGBColor:function(t,e,i){var r=_util.Util.makeHexColor(t,e,i);this.ctx.fillStyle=r,this.current.fillColor=r,this.current.patternFill=!1},shadingFill:function(t){if(this.contentVisible){var e=this.ctx;this.save();var i=(0,_pattern_helper.getShadingPatternFromIR)(t);e.fillStyle=i.getPattern(e,this,!0);var r=e.mozCurrentTransformInverse;if(r){var a=e.canvas,n=a.width,s=a.height,o=_util.Util.applyTransform([0,0],r),h=_util.Util.applyTransform([0,s],r),c=_util.Util.applyTransform([n,0],r),l=_util.Util.applyTransform([n,s],r),f=Math.min(o[0],h[0],c[0],l[0]),u=Math.min(o[1],h[1],c[1],l[1]),p=Math.max(o[0],h[0],c[0],l[0]),m=Math.max(o[1],h[1],c[1],l[1]);this.ctx.fillRect(f,u,p-f,m-u)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.restore()}},beginInlineImage:function(){(0,_util.unreachable)("Should not call beginInlineImage")},beginImageData:function(){(0,_util.unreachable)("Should not call beginImageData")},paintFormXObjectBegin:function(t,e){if(this.contentVisible&&(this.save(),this.baseTransformStack.push(this.baseTransform),Array.isArray(t)&&6===t.length&&this.transform.apply(this,t),this.baseTransform=this.ctx.mozCurrentTransform,e)){var i=e[2]-e[0],r=e[3]-e[1];this.ctx.rect(e[0],e[1],i,r),this.clip(),this.endPath()}},paintFormXObjectEnd:function(){this.contentVisible&&(this.restore(),this.baseTransform=this.baseTransformStack.pop())},beginGroup:function(t){if(this.contentVisible){this.save();var e=this.ctx;t.isolated||(0,_util.info)("TODO: Support non-isolated groups."),t.knockout&&(0,_util.warn)("Knockout groups not supported.");var i=e.mozCurrentTransform;if(t.matrix&&e.transform.apply(e,t.matrix),!t.bbox)throw new Error("Bounding box is required.");var r=_util.Util.getAxialAlignedBoundingBox(t.bbox,e.mozCurrentTransform),a=[0,0,e.canvas.width,e.canvas.height];r=_util.Util.intersect(r,a)||[0,0,0,0];var n=Math.floor(r[0]),s=Math.floor(r[1]),o=Math.max(Math.ceil(r[2])-n,1),h=Math.max(Math.ceil(r[3])-s,1),c=1,l=1;MAX_GROUP_SIZE<o&&(c=o/MAX_GROUP_SIZE,o=MAX_GROUP_SIZE),MAX_GROUP_SIZE<h&&(l=h/MAX_GROUP_SIZE,h=MAX_GROUP_SIZE);var f="groupAt"+this.groupLevel;t.smask&&(f+="_smask_"+this.smaskCounter++%2);var u=this.cachedCanvases.getCanvas(f,o,h,!0),p=u.context;p.scale(1/c,1/l),p.translate(-n,-s),p.transform.apply(p,i),t.smask?this.smaskStack.push({canvas:u.canvas,context:p,offsetX:n,offsetY:s,scaleX:c,scaleY:l,subtype:t.smask.subtype,backdrop:t.smask.backdrop,transferMap:t.smask.transferMap||null,startTransformInverse:null}):(e.setTransform(1,0,0,1,0,0),e.translate(n,s),e.scale(c,l)),m(e,p),this.ctx=p,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(e),this.groupLevel++,this.current.activeSMask=null}},endGroup:function(t){if(this.contentVisible){this.groupLevel--;var e=this.ctx;this.ctx=this.groupStack.pop(),void 0!==this.ctx.imageSmoothingEnabled?this.ctx.imageSmoothingEnabled=!1:this.ctx.mozImageSmoothingEnabled=!1,t.smask?this.tempSMask=this.smaskStack.pop():this.ctx.drawImage(e.canvas,0,0),this.restore()}},beginAnnotations:function(){this.save(),this.baseTransform&&this.ctx.setTransform.apply(this.ctx,this.baseTransform)},endAnnotations:function(){this.restore()},beginAnnotation:function(t,e,i){if(this.save(),l(this.ctx),this.current=new CanvasExtraState,Array.isArray(t)&&4===t.length){var r=t[2]-t[0],a=t[3]-t[1];this.ctx.rect(t[0],t[1],r,a),this.clip(),this.endPath()}this.transform.apply(this,e),this.transform.apply(this,i)},endAnnotation:function(){this.restore()},paintImageMaskXObject:function(t){if(this.contentVisible){var e=this.ctx,i=t.width,r=t.height,a=this.current.fillColor,n=this.current.patternFill,s=this.processingType3;if(COMPILE_TYPE3_GLYPHS&&s&&void 0===s.compiled&&(s.compiled=i<=MAX_SIZE_TO_COMPILE&&r<=MAX_SIZE_TO_COMPILE?compileType3Glyph({data:t.data,width:i,height:r}):null),null!=s&&s.compiled)s.compiled(e);else{var o=this.cachedCanvases.getCanvas("maskCanvas",i,r),h=o.context;h.save(),v(h,t),h.globalCompositeOperation="source-in",h.fillStyle=n?a.getPattern(h,this):a,h.fillRect(0,0,i,r),h.restore(),this.paintInlineImageXObject(o.canvas)}}},paintImageMaskXObjectRepeat:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length?arguments[4]:void 0,n=5<arguments.length?arguments[5]:void 0;if(this.contentVisible){var s=t.width,o=t.height,h=this.current.fillColor,c=this.current.patternFill,l=this.cachedCanvases.getCanvas("maskCanvas",s,o),f=l.context;f.save(),v(f,t),f.globalCompositeOperation="source-in",f.fillStyle=c?h.getPattern(f,this):h,f.fillRect(0,0,s,o),f.restore();for(var u=this.ctx,p=0,m=n.length;p<m;p+=2)u.save(),u.transform(e,i,r,a,n[p],n[p+1]),u.scale(1,-1),u.drawImage(l.canvas,0,0,s,o,0,-1,1,1),u.restore()}},paintImageMaskXObjectGroup:function(t){if(this.contentVisible)for(var e=this.ctx,i=this.current.fillColor,r=this.current.patternFill,a=0,n=t.length;a<n;a++){var s=t[a],o=s.width,h=s.height,c=this.cachedCanvases.getCanvas("maskCanvas",o,h),l=c.context;l.save(),v(l,s),l.globalCompositeOperation="source-in",l.fillStyle=r?i.getPattern(l,this):i,l.fillRect(0,0,o,h),l.restore(),e.save(),e.transform.apply(e,s.transform),e.scale(1,-1),e.drawImage(c.canvas,0,0,o,h,0,-1,1,1),e.restore()}},paintImageXObject:function(t){if(this.contentVisible){var e=t.startsWith("g_")?this.commonObjs.get(t):this.objs.get(t);e?this.paintInlineImageXObject(e):(0,_util.warn)("Dependent image isn't ready yet")}},paintImageXObjectRepeat:function(t,e,i,r){if(this.contentVisible){var a=t.startsWith("g_")?this.commonObjs.get(t):this.objs.get(t);if(a){for(var n=a.width,s=a.height,o=[],h=0,c=r.length;h<c;h+=2)o.push({transform:[e,0,0,i,r[h],r[h+1]],x:0,y:0,w:n,h:s});this.paintInlineImageXObjectGroup(a,o)}else(0,_util.warn)("Dependent image isn't ready yet")}},paintInlineImageXObject:function(t){if(this.contentVisible){var e=t.width,i=t.height,r=this.ctx;this.save(),r.scale(1/e,-1/i);var a,n,s,o=r.mozCurrentTransformInverse,h=Math.max(Math.hypot(o[0],o[1]),1),c=Math.max(Math.hypot(o[2],o[3]),1);a="function"==typeof HTMLElement&&t instanceof HTMLElement||!t.data?t:(d(s=(n=this.cachedCanvases.getCanvas("inlineImage",e,i)).context,t,this.current.transferMaps),n.canvas);for(var l=e,f=i,u="prescale1";2<h&&1<l||2<c&&1<f;){var p=l,m=f;2<h&&1<l&&(h/=l/(p=Math.ceil(l/2))),2<c&&1<f&&(c/=f/(m=Math.ceil(f/2))),(s=(n=this.cachedCanvases.getCanvas(u,p,m)).context).clearRect(0,0,p,m),s.drawImage(a,0,0,l,f,0,0,p,m),a=n.canvas,l=p,f=m,u="prescale1"===u?"prescale2":"prescale1"}if(r.drawImage(a,0,0,l,f,0,-i,e,i),this.imageLayer){var v=this.getCanvasPosition(0,-i);this.imageLayer.appendImage({imgData:t,left:v[0],top:v[1],width:e/o[0],height:i/o[3]})}this.restore()}},paintInlineImageXObjectGroup:function(t,e){if(this.contentVisible){var i=this.ctx,r=t.width,a=t.height,n=this.cachedCanvases.getCanvas("inlineImage",r,a);d(n.context,t,this.current.transferMaps);for(var s=0,o=e.length;s<o;s++){var h=e[s];if(i.save(),i.transform.apply(i,h.transform),i.scale(1,-1),i.drawImage(n.canvas,h.x,h.y,h.w,h.h,0,-1,1,1),this.imageLayer){var c=this.getCanvasPosition(h.x,h.y);this.imageLayer.appendImage({imgData:t,left:c[0],top:c[1],width:r,height:a})}i.restore()}}},paintSolidColorImageMask:function(){this.contentVisible&&this.ctx.fillRect(0,0,1,1)},markPoint:function(t){},markPointProps:function(t,e){},beginMarkedContent:function(t){this.markedContentStack.push({visible:!0})},beginMarkedContentProps:function(t,e){"OC"===t?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(e)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()},endMarkedContent:function(){this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()},beginCompat:function(){},endCompat:function(){},consumePath:function(){var t=this.ctx;this.pendingClip&&(this.pendingClip===a?t.clip("evenodd"):t.clip(),this.pendingClip=null),t.beginPath()},getSinglePixelWidth:function(){if(null===this._cachedGetSinglePixelWidth){var t=this.ctx.mozCurrentTransform,e=Math.abs(t[0]*t[3]-t[2]*t[1]),i=Math.pow(t[0],2)+Math.pow(t[2],2),r=Math.pow(t[1],2)+Math.pow(t[3],2),a=Math.sqrt(Math.max(i,r))/e;i!==r&&1<this._combinedScaleFactor*a?this._cachedGetSinglePixelWidth=-this._combinedScaleFactor*a:e>Number.EPSILON?this._cachedGetSinglePixelWidth=a:this._cachedGetSinglePixelWidth=1}return this._cachedGetSinglePixelWidth},getCanvasPosition:function(t,e){var i=this.ctx.mozCurrentTransform;return[i[0]*t+i[2]*e+i[4],i[1]*t+i[3]*e+i[5]]},isContentVisible:function(){for(var t=this.markedContentStack.length-1;0<=t;t--)if(!this.markedContentStack[t].visible)return!1;return!0}},_util.OPS)s.prototype[_util.OPS[n]]=s.prototype[n];return s}();exports.CanvasGraphics=CanvasGraphics;