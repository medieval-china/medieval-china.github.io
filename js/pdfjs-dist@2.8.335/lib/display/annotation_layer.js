"use strict";function _get(){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,n){var a=_superPropBase(t,e);if(a){var r=Object.getOwnPropertyDescriptor(a,e);return r.get?r.get.call(arguments.length<3?t:n):r.value}}).apply(this,arguments)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var a,r,i,o,l=[],s=!0,c=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;s=!1}else for(;!(s=(a=i.call(n)).done)&&(l.push(a.value),l.length!==e);s=!0);}catch(t){c=!0,r=t}finally{try{if(!s&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(a){var r=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(a);if(r){var n=_getPrototypeOf(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return _possibleConstructorReturn(this,t)}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _createForOfIteratorHelper(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,r=function(){};return{s:r,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){l=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,_toPropertyKey(a.key),a)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0===n)return("string"===e?String:Number)(t);var a=n.call(t,e||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnnotationLayer=void 0;var _display_utils=require("./display_utils.js"),_util=require("../shared/util.js"),_annotation_storage=require("./annotation_storage.js"),_scripting_utils=require("../shared/scripting_utils.js"),AnnotationElementFactory=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"create",value:function(t){switch(t.data.annotationType){case _util.AnnotationType.LINK:return new LinkAnnotationElement(t);case _util.AnnotationType.TEXT:return new TextAnnotationElement(t);case _util.AnnotationType.WIDGET:switch(t.data.fieldType){case"Tx":return new TextWidgetAnnotationElement(t);case"Btn":return t.data.radioButton?new RadioButtonWidgetAnnotationElement(t):t.data.checkBox?new CheckboxWidgetAnnotationElement(t):new PushButtonWidgetAnnotationElement(t);case"Ch":return new ChoiceWidgetAnnotationElement(t)}return new WidgetAnnotationElement(t);case _util.AnnotationType.POPUP:return new PopupAnnotationElement(t);case _util.AnnotationType.FREETEXT:return new FreeTextAnnotationElement(t);case _util.AnnotationType.LINE:return new LineAnnotationElement(t);case _util.AnnotationType.SQUARE:return new SquareAnnotationElement(t);case _util.AnnotationType.CIRCLE:return new CircleAnnotationElement(t);case _util.AnnotationType.POLYLINE:return new PolylineAnnotationElement(t);case _util.AnnotationType.CARET:return new CaretAnnotationElement(t);case _util.AnnotationType.INK:return new InkAnnotationElement(t);case _util.AnnotationType.POLYGON:return new PolygonAnnotationElement(t);case _util.AnnotationType.HIGHLIGHT:return new HighlightAnnotationElement(t);case _util.AnnotationType.UNDERLINE:return new UnderlineAnnotationElement(t);case _util.AnnotationType.SQUIGGLY:return new SquigglyAnnotationElement(t);case _util.AnnotationType.STRIKEOUT:return new StrikeOutAnnotationElement(t);case _util.AnnotationType.STAMP:return new StampAnnotationElement(t);case _util.AnnotationType.FILEATTACHMENT:return new FileAttachmentAnnotationElement(t);default:return new AnnotationElement(t)}}}]),t}(),AnnotationElement=function(){function s(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=e.isRenderable,a=void 0!==n&&n,r=e.ignoreBorder,i=void 0!==r&&r,o=e.createQuadrilaterals,l=void 0!==o&&o;_classCallCheck(this,s),this.isRenderable=a,this.data=t.data,this.layer=t.layer,this.page=t.page,this.viewport=t.viewport,this.linkService=t.linkService,this.downloadManager=t.downloadManager,this.imageResourcesPath=t.imageResourcesPath,this.renderInteractiveForms=t.renderInteractiveForms,this.svgFactory=t.svgFactory,this.annotationStorage=t.annotationStorage,this.enableScripting=t.enableScripting,this.hasJSActions=t.hasJSActions,this._mouseState=t.mouseState,a&&(this.container=this._createContainer(i)),l&&(this.quadrilaterals=this._createQuadrilaterals(i))}return _createClass(s,[{key:"_createContainer",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],e=this.data,n=this.page,a=this.viewport,r=document.createElement("section"),i=e.rect[2]-e.rect[0],o=e.rect[3]-e.rect[1];r.setAttribute("data-annotation-id",e.id);var l=_util.Util.normalizeRect([e.rect[0],n.view[3]-e.rect[1]+n.view[1],e.rect[2],n.view[3]-e.rect[3]+n.view[1]]);if(r.style.transform="matrix(".concat(a.transform.join(","),")"),r.style.transformOrigin="".concat(-l[0],"px ").concat(-l[1],"px"),!t&&0<e.borderStyle.width){r.style.borderWidth="".concat(e.borderStyle.width,"px"),e.borderStyle.style!==_util.AnnotationBorderStyleType.UNDERLINE&&(i-=2*e.borderStyle.width,o-=2*e.borderStyle.width);var s=e.borderStyle.horizontalCornerRadius,c=e.borderStyle.verticalCornerRadius;if(0<s||0<c){var u="".concat(s,"px / ").concat(c,"px");r.style.borderRadius=u}switch(e.borderStyle.style){case _util.AnnotationBorderStyleType.SOLID:r.style.borderStyle="solid";break;case _util.AnnotationBorderStyleType.DASHED:r.style.borderStyle="dashed";break;case _util.AnnotationBorderStyleType.BEVELED:(0,_util.warn)("Unimplemented border style: beveled");break;case _util.AnnotationBorderStyleType.INSET:(0,_util.warn)("Unimplemented border style: inset");break;case _util.AnnotationBorderStyleType.UNDERLINE:r.style.borderBottomStyle="solid"}e.color?r.style.borderColor=_util.Util.makeHexColor(0|e.color[0],0|e.color[1],0|e.color[2]):r.style.borderWidth=0}return r.style.left="".concat(l[0],"px"),r.style.top="".concat(l[1],"px"),r.style.width="".concat(i,"px"),r.style.height="".concat(o,"px"),r}},{key:"_createQuadrilaterals",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(!this.data.quadPoints)return null;var e,n=[],a=this.data.rect,r=_createForOfIteratorHelper(this.data.quadPoints);try{for(r.s();!(e=r.n()).done;){var i=e.value;this.data.rect=[i[2].x,i[2].y,i[1].x,i[1].y],n.push(this._createContainer(t))}}catch(t){r.e(t)}finally{r.f()}return this.data.rect=a,n}},{key:"_createPopup",value:function(t,e){var n=this.container;this.quadrilaterals&&(t=t||this.quadrilaterals,n=this.quadrilaterals[0]),t||((t=document.createElement("div")).style.height=n.style.height,t.style.width=n.style.width,n.appendChild(t));var a=new PopupElement({container:n,trigger:t,color:e.color,title:e.title,modificationDate:e.modificationDate,contents:e.contents,hideWrapper:!0}).render();a.style.left=n.style.width,n.appendChild(a)}},{key:"_renderQuadrilaterals",value:function(e){return this.quadrilaterals.forEach(function(t){t.className=e}),this.quadrilaterals}},{key:"render",value:function(){(0,_util.unreachable)("Abstract method `AnnotationElement.render` called")}}]),s}(),LinkAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.url||t.data.dest||t.data.action||t.data.isTooltipOnly||t.data.actions&&(t.data.actions.Action||t.data.actions["Mouse Up"]||t.data.actions["Mouse Down"]));return n.call(this,t,{isRenderable:e,createQuadrilaterals:!0})}return _createClass(a,[{key:"render",value:function(){var t=this.data,e=this.linkService,a=document.createElement("a");return t.url?(0,_display_utils.addLinkAttributes)(a,{url:t.url,target:t.newWindow?_display_utils.LinkTarget.BLANK:e.externalLinkTarget,rel:e.externalLinkRel,enabled:e.externalLinkEnabled}):t.action?this._bindNamedAction(a,t.action):t.dest?this._bindLink(a,t.dest):t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions?this._bindJSAction(a,t):this._bindLink(a,""),this.quadrilaterals?this._renderQuadrilaterals("linkAnnotation").map(function(t,e){var n=0===e?a:a.cloneNode();return t.appendChild(n),t}):(this.container.className="linkAnnotation",this.container.appendChild(a),this.container)}},{key:"_bindLink",value:function(t,e){var n=this;t.href=this.linkService.getDestinationHash(e),t.onclick=function(){return e&&n.linkService.goToDestination(e),!1},(e||""===e)&&(t.className="internalLink")}},{key:"_bindNamedAction",value:function(t,e){var n=this;t.href=this.linkService.getAnchorUrl(""),t.onclick=function(){return n.linkService.executeNamedAction(e),!1},t.className="internalLink"}},{key:"_bindJSAction",value:function(n,a){var r=this;n.href=this.linkService.getAnchorUrl("");for(var i=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]),t=function(){var e=l[o],t=i.get(e);if(!t)return"continue";n[t]=function(){var t;return null===(t=r.linkService.eventBus)||void 0===t||t.dispatch("dispatcheventinsandbox",{source:r,detail:{id:a.id,name:e}}),!1}},o=0,l=Object.keys(a.actions);o<l.length;o++)t();n.className="internalLink"}}]),a}(),TextAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e})}return _createClass(a,[{key:"render",value:function(){this.container.className="textAnnotation";var t=document.createElement("img");return t.style.height=this.container.style.height,t.style.width=this.container.style.width,t.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",t.alt="[ Annotation]",t.dataset.l10nId="text_annotation_type",t.dataset.l10nArgs=JSON.stringify({type:this.data.name}),this.data.hasPopup||this._createPopup(t,this.data),this.container.appendChild(t),this.container}}]),a}(),WidgetAnnotationElement=function(t){_inherits(n,AnnotationElement);var e=_createSuper(n);function n(){return _classCallCheck(this,n),e.apply(this,arguments)}return _createClass(n,[{key:"render",value:function(){return this.data.alternativeText&&(this.container.title=this.data.alternativeText),this.container}},{key:"_getKeyModifier",value:function(t){return navigator.platform.includes("Win")&&t.ctrlKey||navigator.platform.includes("Mac")&&t.metaKey}},{key:"_setEventListener",value:function(t,e,n,a){var r=this;e.includes("mouse")?t.addEventListener(e,function(t){var e;null===(e=r.linkService.eventBus)||void 0===e||e.dispatch("dispatcheventinsandbox",{source:r,detail:{id:r.data.id,name:n,value:a(t),shift:t.shiftKey,modifier:r._getKeyModifier(t)}})}):t.addEventListener(e,function(t){var e;null===(e=r.linkService.eventBus)||void 0===e||e.dispatch("dispatcheventinsandbox",{source:r,detail:{id:r.data.id,name:n,value:t.target.checked}})})}},{key:"_setEventListeners",value:function(t,e,n){var a,r=_createForOfIteratorHelper(e);try{for(r.s();!(a=r.n()).done;){var i,o=_slicedToArray(a.value,2),l=o[0],s=o[1];("Action"===s||null!==(i=this.data.actions)&&void 0!==i&&i[s])&&this._setEventListener(t,l,s,n)}}catch(t){r.e(t)}finally{r.f()}}},{key:"_setColor",value:function(t){for(var e=t.detail,n=t.target.style,a=0,r=["bgColor","fillColor","fgColor","textColor","borderColor","strokeColor"];a<r.length;a++){var i=r[a],o=e[i];if(o)switch(o=_scripting_utils.ColorConverters["".concat(o[0],"_HTML")](o.slice(1)),i){case"bgColor":case"fillColor":n.backgroundColor=o;break;case"fgColor":case"textColor":n.color=o;break;case"borderColor":case"strokeColor":n.borderColor=o}}}}]),n}(),TextWidgetAnnotationElement=function(t){_inherits(a,WidgetAnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=t.renderInteractiveForms||!t.data.hasAppearance&&!!t.data.fieldValue;return n.call(this,t,{isRenderable:e})}return _createClass(a,[{key:"render",value:function(){var i=this,n=this.annotationStorage,o=this.data.id;this.container.className="textWidgetAnnotation";var t=null;if(this.renderInteractiveForms){var e=n.getValue(o,{value:this.data.fieldValue,valueAsString:this.data.fieldValue}),a=e.valueAsString||e.value||"",l={userValue:null,formattedValue:null,beforeInputSelectionRange:null,beforeInputValue:null};this.data.multiLine?(t=document.createElement("textarea")).textContent=a:((t=document.createElement("input")).type="text",t.setAttribute("value",a)),l.userValue=a,t.setAttribute("id",o),t.addEventListener("input",function(t){n.setValue(o,{value:t.target.value})});var r=function(t){l.formattedValue&&(t.target.value=l.formattedValue),t.target.setSelectionRange(0,0),l.beforeInputSelectionRange=null};if(this.enableScripting&&this.hasJSActions){var s;t.addEventListener("focus",function(t){l.userValue&&(t.target.value=l.userValue)}),t.addEventListener("updatefromsandbox",function(a){var r=a.detail,e={value:function(){l.userValue=r.value||"",n.setValue(o,{value:l.userValue.toString()}),l.formattedValue||(a.target.value=l.userValue)},valueAsString:function(){l.formattedValue=r.valueAsString||"",a.target!==document.activeElement&&(a.target.value=l.formattedValue),n.setValue(o,{formattedValue:l.formattedValue})},focus:function(){setTimeout(function(){return a.target.focus({preventScroll:!1})},0)},userName:function(){a.target.title=r.userName},hidden:function(){a.target.style.visibility=r.hidden?"hidden":"visible",n.setValue(o,{hidden:r.hidden})},editable:function(){a.target.disabled=!r.editable},selRange:function(){var t=_slicedToArray(r.selRange,2),e=t[0],n=t[1];0<=e&&n<a.target.value.length&&a.target.setSelectionRange(e,n)}};Object.keys(r).filter(function(t){return t in e}).forEach(function(t){return e[t]()}),i._setColor(a)}),t.addEventListener("keydown",function(t){var e;l.beforeInputValue=t.target.value;var n=-1;"Escape"===t.key?n=0:"Enter"===t.key?n=2:"Tab"===t.key&&(n=3),-1!==n&&(l.userValue=t.target.value,null===(e=i.linkService.eventBus)||void 0===e||e.dispatch("dispatcheventinsandbox",{source:i,detail:{id:o,name:"Keystroke",value:t.target.value,willCommit:!0,commitKey:n,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}}))});var c=r;r=null,t.addEventListener("blur",function(t){var e;i._mouseState.isDown&&(l.userValue=t.target.value,null===(e=i.linkService.eventBus)||void 0===e||e.dispatch("dispatcheventinsandbox",{source:i,detail:{id:o,name:"Keystroke",value:t.target.value,willCommit:!0,commitKey:1,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}}));c(t)}),t.addEventListener("mousedown",function(t){l.beforeInputValue=t.target.value,l.beforeInputSelectionRange=null}),t.addEventListener("keyup",function(t){t.target.selectionStart===t.target.selectionEnd&&(l.beforeInputSelectionRange=null)}),t.addEventListener("select",function(t){l.beforeInputSelectionRange=[t.target.selectionStart,t.target.selectionEnd]}),null!==(s=this.data.actions)&&void 0!==s&&s.Keystroke&&t.addEventListener("input",function(t){var e,n=-1,a=-1;if(l.beforeInputSelectionRange){var r=_slicedToArray(l.beforeInputSelectionRange,2);n=r[0],a=r[1]}null===(e=i.linkService.eventBus)||void 0===e||e.dispatch("dispatcheventinsandbox",{source:i,detail:{id:o,name:"Keystroke",value:l.beforeInputValue,change:t.data,willCommit:!1,selStart:n,selEnd:a}})}),this._setEventListeners(t,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],function(t){return t.target.value})}if(r&&t.addEventListener("blur",r),t.disabled=this.data.readOnly,t.name=this.data.fieldName,null!==this.data.maxLen&&(t.maxLength=this.data.maxLen),this.data.comb){var u=(this.data.rect[2]-this.data.rect[0])/this.data.maxLen;t.classList.add("comb"),t.style.letterSpacing="calc(".concat(u,"px - 1ch)")}}else(t=document.createElement("div")).textContent=this.data.fieldValue,t.style.verticalAlign="middle",t.style.display="table-cell";return this._setTextStyle(t),this.container.appendChild(t),this.container}},{key:"_setTextStyle",value:function(t){var e=this.data.defaultAppearanceData,n=e.fontSize,a=e.fontColor,r=t.style;n&&(r.fontSize="".concat(n,"px")),r.color=_util.Util.makeHexColor(a[0],a[1],a[2]),null!==this.data.textAlignment&&(r.textAlign=["left","center","right"][this.data.textAlignment])}}]),a}(),CheckboxWidgetAnnotationElement=function(t){_inherits(n,WidgetAnnotationElement);var e=_createSuper(n);function n(t){return _classCallCheck(this,n),e.call(this,t,{isRenderable:t.renderInteractiveForms})}return _createClass(n,[{key:"render",value:function(){var a=this,i=this.annotationStorage,t=this.data,o=t.id,e=i.getValue(o,{value:t.fieldValue&&(t.exportValue&&t.exportValue===t.fieldValue||!t.exportValue&&"Off"!==t.fieldValue)}).value;this.container.className="buttonWidgetAnnotation checkBox";var n=document.createElement("input");return n.disabled=t.readOnly,n.type="checkbox",n.name=this.data.fieldName,e&&n.setAttribute("checked",!0),n.setAttribute("id",o),n.addEventListener("change",function(t){var e,n=t.target.name,a=_createForOfIteratorHelper(document.getElementsByName(n));try{for(a.s();!(e=a.n()).done;){var r=e.value;r!==t.target&&(r.checked=!1,i.setValue(r.parentNode.getAttribute("data-annotation-id"),{value:!1}))}}catch(t){a.e(t)}finally{a.f()}i.setValue(o,{value:t.target.checked})}),this.enableScripting&&this.hasJSActions&&(n.addEventListener("updatefromsandbox",function(t){var e=t.detail,n={value:function(){t.target.checked="Off"!==e.value,i.setValue(o,{value:t.target.checked})},focus:function(){setTimeout(function(){return t.target.focus({preventScroll:!1})},0)},hidden:function(){t.target.style.visibility=e.hidden?"hidden":"visible",i.setValue(o,{hidden:e.hidden})},editable:function(){t.target.disabled=!e.editable}};Object.keys(e).filter(function(t){return t in n}).forEach(function(t){return n[t]()}),a._setColor(t)}),this._setEventListeners(n,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],function(t){return t.target.checked})),this.container.appendChild(n),this.container}}]),n}(),RadioButtonWidgetAnnotationElement=function(t){_inherits(n,WidgetAnnotationElement);var e=_createSuper(n);function n(t){return _classCallCheck(this,n),e.call(this,t,{isRenderable:t.renderInteractiveForms})}return _createClass(n,[{key:"render",value:function(){var t=this;this.container.className="buttonWidgetAnnotation radioButton";var l=this.annotationStorage,e=this.data,s=e.id,n=l.getValue(s,{value:e.fieldValue===e.buttonValue}).value,a=document.createElement("input");if(a.disabled=e.readOnly,a.type="radio",a.name=e.fieldName,n&&a.setAttribute("checked",!0),a.setAttribute("id",s),a.addEventListener("change",function(t){var e,n=t.target,a=_createForOfIteratorHelper(document.getElementsByName(n.name));try{for(a.s();!(e=a.n()).done;){var r=e.value;r!==n&&l.setValue(r.getAttribute("id"),{value:!1})}}catch(t){a.e(t)}finally{a.f()}l.setValue(s,{value:n.checked})}),this.enableScripting&&this.hasJSActions){var c=e.buttonValue;a.addEventListener("updatefromsandbox",function(i){var o=i.detail,e={value:function(){var t,e=c===o.value,n=_createForOfIteratorHelper(document.getElementsByName(i.target.name));try{for(n.s();!(t=n.n()).done;){var a=t.value,r=a.getAttribute("id");a.checked=r===s&&e,l.setValue(r,{value:a.checked})}}catch(t){n.e(t)}finally{n.f()}},focus:function(){setTimeout(function(){return i.target.focus({preventScroll:!1})},0)},hidden:function(){i.target.style.visibility=o.hidden?"hidden":"visible",l.setValue(s,{hidden:o.hidden})},editable:function(){i.target.disabled=!o.editable}};Object.keys(o).filter(function(t){return t in e}).forEach(function(t){return e[t]()}),t._setColor(i)}),this._setEventListeners(a,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],function(t){return t.target.checked})}return this.container.appendChild(a),this.container}}]),n}(),PushButtonWidgetAnnotationElement=function(t){_inherits(n,LinkAnnotationElement);var e=_createSuper(n);function n(){return _classCallCheck(this,n),e.apply(this,arguments)}return _createClass(n,[{key:"render",value:function(){var t=_get(_getPrototypeOf(n.prototype),"render",this).call(this);return t.className="buttonWidgetAnnotation pushButton",this.data.alternativeText&&(t.title=this.data.alternativeText),t}}]),n}(),ChoiceWidgetAnnotationElement=function(t){_inherits(n,WidgetAnnotationElement);var e=_createSuper(n);function n(t){return _classCallCheck(this,n),e.call(this,t,{isRenderable:t.renderInteractiveForms})}return _createClass(n,[{key:"render",value:function(){var r=this;this.container.className="choiceWidgetAnnotation";var c=this.annotationStorage,u=this.data.id;c.getValue(u,{value:0<this.data.fieldValue.length?this.data.fieldValue[0]:void 0});var d=document.createElement("select");d.disabled=this.data.readOnly,d.name=this.data.fieldName,d.setAttribute("id",u),this.data.combo||(d.size=this.data.options.length,this.data.multiSelect&&(d.multiple=!0));var t,e=_createForOfIteratorHelper(this.data.options);try{for(e.s();!(t=e.n()).done;){var n=t.value,a=document.createElement("option");a.textContent=n.displayValue,a.value=n.exportValue,this.data.fieldValue.includes(n.exportValue)&&a.setAttribute("selected",!0),d.appendChild(a)}}catch(t){e.e(t)}finally{e.f()}var h=function(t,e){var n=e?"value":"textContent",a=t.target.options;return t.target.multiple?Array.prototype.filter.call(a,function(t){return t.selected}).map(function(t){return t[n]}):-1===a.selectedIndex?null:a[a.selectedIndex][n]},p=function(t){var e=t.target.options;return Array.prototype.map.call(e,function(t){return{displayValue:t.textContent,exportValue:t.value}})};return this.enableScripting&&this.hasJSActions?(d.addEventListener("updatefromsandbox",function(l){var s=l.detail,e={value:function(){var t=d.options,e=s.value,n=new Set(Array.isArray(e)?e:[e]);Array.prototype.forEach.call(t,function(t){t.selected=n.has(t.value)}),c.setValue(u,{value:h(l,!0)})},multipleSelection:function(){d.multiple=!0},remove:function(){var t=d.options,e=s.remove;(t[e].selected=!1,d.remove(e),0<t.length)&&(-1===Array.prototype.findIndex.call(t,function(t){return t.selected})&&(t[0].selected=!0));c.setValue(u,{value:h(l,!0),items:p(l)})},clear:function(){for(;0!==d.length;)d.remove(0);c.setValue(u,{value:null,items:[]})},insert:function(){var t=s.insert,e=t.index,n=t.displayValue,a=t.exportValue,r=document.createElement("option");r.textContent=n,r.value=a,d.insertBefore(r,d.children[e]),c.setValue(u,{value:h(l,!0),items:p(l)})},items:function(){for(var t=s.items;0!==d.length;)d.remove(0);var e,n=_createForOfIteratorHelper(t);try{for(n.s();!(e=n.n()).done;){var a=e.value,r=a.displayValue,i=a.exportValue,o=document.createElement("option");o.textContent=r,o.value=i,d.appendChild(o)}}catch(t){n.e(t)}finally{n.f()}0<d.options.length&&(d.options[0].selected=!0),c.setValue(u,{value:h(l,!0),items:p(l)})},indices:function(){var n=new Set(s.indices),t=l.target.options;Array.prototype.forEach.call(t,function(t,e){t.selected=n.has(e)}),c.setValue(u,{value:h(l,!0)})},focus:function(){setTimeout(function(){return l.target.focus({preventScroll:!1})},0)},hidden:function(){l.target.style.visibility=s.hidden?"hidden":"visible",c.setValue(u,{hidden:s.hidden})},editable:function(){l.target.disabled=!s.editable}};Object.keys(s).filter(function(t){return t in e}).forEach(function(t){return e[t]()}),r._setColor(l)}),d.addEventListener("input",function(t){var e,n=h(t,!0),a=h(t,!1);c.setValue(u,{value:n}),null===(e=r.linkService.eventBus)||void 0===e||e.dispatch("dispatcheventinsandbox",{source:r,detail:{id:u,name:"Keystroke",value:a,changeEx:n,willCommit:!0,commitKey:1,keyDown:!1}})}),this._setEventListeners(d,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"]],function(t){return t.target.checked})):d.addEventListener("input",function(t){c.setValue(u,{value:h(t)})}),this.container.appendChild(d),this.container}}]),n}(),PopupAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!(!t.data.title&&!t.data.contents);return n.call(this,t,{isRenderable:e})}return _createClass(a,[{key:"render",value:function(){if(this.container.className="popupAnnotation",["Line","Square","Circle","PolyLine","Polygon","Ink"].includes(this.data.parentType))return this.container;var t='[data-annotation-id="'.concat(this.data.parentId,'"]'),e=this.layer.querySelectorAll(t);if(0===e.length)return this.container;var n=new PopupElement({container:this.container,trigger:Array.from(e),color:this.data.color,title:this.data.title,modificationDate:this.data.modificationDate,contents:this.data.contents}),a=this.page,r=_util.Util.normalizeRect([this.data.parentRect[0],a.view[3]-this.data.parentRect[1]+a.view[1],this.data.parentRect[2],a.view[3]-this.data.parentRect[3]+a.view[1]]),i=r[0]+this.data.parentRect[2]-this.data.parentRect[0],o=r[1];return this.container.style.transformOrigin="".concat(-i,"px ").concat(-o,"px"),this.container.style.left="".concat(i,"px"),this.container.style.top="".concat(o,"px"),this.container.appendChild(n.render()),this.container}}]),a}(),PopupElement=function(){function e(t){_classCallCheck(this,e),this.container=t.container,this.trigger=t.trigger,this.color=t.color,this.title=t.title,this.modificationDate=t.modificationDate,this.contents=t.contents,this.hideWrapper=t.hideWrapper||!1,this.pinned=!1}return _createClass(e,[{key:"render",value:function(){var e=this,t=document.createElement("div");t.className="popupWrapper",this.hideElement=this.hideWrapper?t:this.container,this.hideElement.hidden=!0;var n=document.createElement("div");n.className="popup";var a=this.color;if(a){var r=.7*(255-a[0])+a[0],i=.7*(255-a[1])+a[1],o=.7*(255-a[2])+a[2];n.style.backgroundColor=_util.Util.makeHexColor(0|r,0|i,0|o)}var l=document.createElement("h1");l.textContent=this.title,n.appendChild(l);var s=_display_utils.PDFDateString.toDateObject(this.modificationDate);if(s){var c=document.createElement("span");c.textContent="1762013335257, ",c.dataset.l10nId="annotation_date_string",c.dataset.l10nArgs=JSON.stringify({date:s.toLocaleDateString(),time:s.toLocaleTimeString()}),n.appendChild(c)}var u=this._formatContents(this.contents);return n.appendChild(u),Array.isArray(this.trigger)||(this.trigger=[this.trigger]),this.trigger.forEach(function(t){t.addEventListener("click",e._toggle.bind(e)),t.addEventListener("mouseover",e._show.bind(e,!1)),t.addEventListener("mouseout",e._hide.bind(e,!1))}),n.addEventListener("click",this._hide.bind(this,!0)),t.appendChild(n),t}},{key:"_formatContents",value:function(t){for(var e=document.createElement("p"),n=t.split(/(?:\r\n?|\n)/),a=0,r=n.length;a<r;++a){var i=n[a];e.appendChild(document.createTextNode(i)),a<r-1&&e.appendChild(document.createElement("br"))}return e}},{key:"_toggle",value:function(){this.pinned?this._hide(!0):this._show(!0)}},{key:"_show",value:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0]&&(this.pinned=!0),this.hideElement.hidden&&(this.hideElement.hidden=!1,this.container.style.zIndex+=1)}},{key:"_hide",value:function(){(!(0<arguments.length&&void 0!==arguments[0])||arguments[0])&&(this.pinned=!1),this.hideElement.hidden||this.pinned||(this.hideElement.hidden=!0,this.container.style.zIndex-=1)}}]),e}(),FreeTextAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0})}return _createClass(a,[{key:"render",value:function(){return this.container.className="freeTextAnnotation",this.data.hasPopup||this._createPopup(null,this.data),this.container}}]),a}(),LineAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0})}return _createClass(a,[{key:"render",value:function(){this.container.className="lineAnnotation";var t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n),r=this.svgFactory.createElement("svg:line");return r.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]),r.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]),r.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]),r.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]),r.setAttribute("stroke-width",t.borderStyle.width||1),r.setAttribute("stroke","transparent"),a.appendChild(r),this.container.append(a),this._createPopup(r,t),this.container}}]),a}(),SquareAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0})}return _createClass(a,[{key:"render",value:function(){this.container.className="squareAnnotation";var t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n),r=t.borderStyle.width,i=this.svgFactory.createElement("svg:rect");return i.setAttribute("x",r/2),i.setAttribute("y",r/2),i.setAttribute("width",e-r),i.setAttribute("height",n-r),i.setAttribute("stroke-width",r||1),i.setAttribute("stroke","transparent"),i.setAttribute("fill","none"),a.appendChild(i),this.container.append(a),this._createPopup(i,t),this.container}}]),a}(),CircleAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0})}return _createClass(a,[{key:"render",value:function(){this.container.className="circleAnnotation";var t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n),r=t.borderStyle.width,i=this.svgFactory.createElement("svg:ellipse");return i.setAttribute("cx",e/2),i.setAttribute("cy",n/2),i.setAttribute("rx",e/2-r/2),i.setAttribute("ry",n/2-r/2),i.setAttribute("stroke-width",r||1),i.setAttribute("stroke","transparent"),i.setAttribute("fill","none"),a.appendChild(i),this.container.append(a),this._createPopup(i,t),this.container}}]),a}(),PolylineAnnotationElement=function(t){_inherits(r,AnnotationElement);var a=_createSuper(r);function r(t){var e;_classCallCheck(this,r);var n=!!(t.data.hasPopup||t.data.title||t.data.contents);return(e=a.call(this,t,{isRenderable:n,ignoreBorder:!0})).containerClassName="polylineAnnotation",e.svgElementName="svg:polyline",e}return _createClass(r,[{key:"render",value:function(){this.container.className=this.containerClassName;var t,e=this.data,n=e.rect[2]-e.rect[0],a=e.rect[3]-e.rect[1],r=this.svgFactory.create(n,a),i=[],o=_createForOfIteratorHelper(e.vertices);try{for(o.s();!(t=o.n()).done;){var l=t.value,s=l.x-e.rect[0],c=e.rect[3]-l.y;i.push(s+","+c)}}catch(t){o.e(t)}finally{o.f()}i=i.join(" ");var u=this.svgFactory.createElement(this.svgElementName);return u.setAttribute("points",i),u.setAttribute("stroke-width",e.borderStyle.width||1),u.setAttribute("stroke","transparent"),u.setAttribute("fill","none"),r.appendChild(u),this.container.append(r),this._createPopup(u,e),this.container}}]),r}(),PolygonAnnotationElement=function(t){_inherits(a,PolylineAnnotationElement);var n=_createSuper(a);function a(t){var e;return _classCallCheck(this,a),(e=n.call(this,t)).containerClassName="polygonAnnotation",e.svgElementName="svg:polygon",e}return _createClass(a)}(),CaretAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0})}return _createClass(a,[{key:"render",value:function(){return this.container.className="caretAnnotation",this.data.hasPopup||this._createPopup(null,this.data),this.container}}]),a}(),InkAnnotationElement=function(t){_inherits(r,AnnotationElement);var a=_createSuper(r);function r(t){var e;_classCallCheck(this,r);var n=!!(t.data.hasPopup||t.data.title||t.data.contents);return(e=a.call(this,t,{isRenderable:n,ignoreBorder:!0})).containerClassName="inkAnnotation",e.svgElementName="svg:polyline",e}return _createClass(r,[{key:"render",value:function(){this.container.className=this.containerClassName;var t,e=this.data,n=e.rect[2]-e.rect[0],a=e.rect[3]-e.rect[1],r=this.svgFactory.create(n,a),i=_createForOfIteratorHelper(e.inkLists);try{for(i.s();!(t=i.n()).done;){var o,l=t.value,s=[],c=_createForOfIteratorHelper(l);try{for(c.s();!(o=c.n()).done;){var u=o.value,d=u.x-e.rect[0],h=e.rect[3]-u.y;s.push("".concat(d,",").concat(h))}}catch(t){c.e(t)}finally{c.f()}s=s.join(" ");var p=this.svgFactory.createElement(this.svgElementName);p.setAttribute("points",s),p.setAttribute("stroke-width",e.borderStyle.width||1),p.setAttribute("stroke","transparent"),p.setAttribute("fill","none"),this._createPopup(p,e),r.appendChild(p)}}catch(t){i.e(t)}finally{i.f()}return this.container.append(r),this.container}}]),r}(),HighlightAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}return _createClass(a,[{key:"render",value:function(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("highlightAnnotation"):(this.container.className="highlightAnnotation",this.container)}}]),a}(),UnderlineAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}return _createClass(a,[{key:"render",value:function(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("underlineAnnotation"):(this.container.className="underlineAnnotation",this.container)}}]),a}(),SquigglyAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}return _createClass(a,[{key:"render",value:function(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("squigglyAnnotation"):(this.container.className="squigglyAnnotation",this.container)}}]),a}(),StrikeOutAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}return _createClass(a,[{key:"render",value:function(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("strikeoutAnnotation"):(this.container.className="strikeoutAnnotation",this.container)}}]),a}(),StampAnnotationElement=function(t){_inherits(a,AnnotationElement);var n=_createSuper(a);function a(t){_classCallCheck(this,a);var e=!!(t.data.hasPopup||t.data.title||t.data.contents);return n.call(this,t,{isRenderable:e,ignoreBorder:!0})}return _createClass(a,[{key:"render",value:function(){return this.container.className="stampAnnotation",this.data.hasPopup||this._createPopup(null,this.data),this.container}}]),a}(),FileAttachmentAnnotationElement=function(t){_inherits(l,AnnotationElement);var o=_createSuper(l);function l(t){var e,n;_classCallCheck(this,l);var a=(n=o.call(this,t,{isRenderable:!0})).data.file,r=a.filename,i=a.content;return n.filename=(0,_display_utils.getFilenameFromUrl)(r),n.content=i,null===(e=n.linkService.eventBus)||void 0===e||e.dispatch("fileattachmentannotation",{source:_assertThisInitialized(n),id:(0,_util.stringToPDFString)(r),filename:r,content:i}),n}return _createClass(l,[{key:"render",value:function(){this.container.className="fileAttachmentAnnotation";var t=document.createElement("div");return t.style.height=this.container.style.height,t.style.width=this.container.style.width,t.addEventListener("dblclick",this._download.bind(this)),this.data.hasPopup||!this.data.title&&!this.data.contents||this._createPopup(t,this.data),this.container.appendChild(t),this.container}},{key:"_download",value:function(){var t;null===(t=this.downloadManager)||void 0===t||t.openOrDownloadData(this.container,this.content,this.filename)}}]),l}(),AnnotationLayer=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"render",value:function(t){var e,n=[],a=[],r=_createForOfIteratorHelper(t.annotations);try{for(r.s();!(e=r.n()).done;){var i=e.value;i&&(i.annotationType!==_util.AnnotationType.POPUP?n.push(i):a.push(i))}}catch(t){r.e(t)}finally{r.f()}a.length&&n.push.apply(n,a);for(var o=0,l=n;o<l.length;o++){var s=l[o],c=AnnotationElementFactory.create({data:s,layer:t.div,page:t.page,viewport:t.viewport,linkService:t.linkService,downloadManager:t.downloadManager,imageResourcesPath:t.imageResourcesPath||"",renderInteractiveForms:!1!==t.renderInteractiveForms,svgFactory:new _display_utils.DOMSVGFactory,annotationStorage:t.annotationStorage||new _annotation_storage.AnnotationStorage,enableScripting:t.enableScripting,hasJSActions:t.hasJSActions,mouseState:t.mouseState||{isDown:!1}});if(c.isRenderable){var u=c.render();if(s.hidden&&(u.style.visibility="hidden"),Array.isArray(u)){var d,h=_createForOfIteratorHelper(u);try{for(h.s();!(d=h.n()).done;){var p=d.value;t.div.appendChild(p)}}catch(t){h.e(t)}finally{h.f()}}else c instanceof PopupAnnotationElement?t.div.prepend(u):t.div.appendChild(u)}}}},{key:"update",value:function(t){var e,n="matrix(".concat(t.viewport.transform.join(","),")"),a=_createForOfIteratorHelper(t.annotations);try{for(a.s();!(e=a.n()).done;){var r=e.value,i=t.div.querySelectorAll('[data-annotation-id="'.concat(r.id,'"]'));i&&i.forEach(function(t){t.style.transform=n})}}catch(t){a.e(t)}finally{a.f()}t.div.hidden=!1}}]),t}();exports.AnnotationLayer=AnnotationLayer;