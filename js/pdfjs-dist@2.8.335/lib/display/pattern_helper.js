"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getShadingPatternFromIR=getShadingPatternFromIR,exports.TilingPattern=void 0;var _util=require("../shared/util.js"),ShadingIRs={};function applyBoundingBox(t,e){if(e&&"undefined"!=typeof Path2D){var a=e[2]-e[0],r=e[3]-e[1],s=new Path2D;s.rect(e[0],e[1],a,r),t.clip(s)}}ShadingIRs.RadialAxial={fromIR:function(t){var i=t[1],n=t[2],o=t[3],l=t[4],c=t[5],h=t[6],f=t[7];return{getPattern:function(t){var e;applyBoundingBox(t,n),"axial"===i?e=t.createLinearGradient(l[0],l[1],c[0],c[1]):"radial"===i&&(e=t.createRadialGradient(l[0],l[1],h,c[0],c[1],f));for(var a=0,r=o.length;a<r;++a){var s=o[a];e.addColorStop(s[0],s[1])}return e}}}};var createMeshCanvas=function(){function u(t,e,a,r,s,i,n,o){var l,c=e.coords,h=e.colors,f=t.data,u=4*t.width;c[a+1]>c[r+1]&&(l=a,a=r,r=l,l=i,i=n,n=l),c[r+1]>c[s+1]&&(l=r,r=s,s=l,l=n,n=o,o=l),c[a+1]>c[r+1]&&(l=a,a=r,r=l,l=i,i=n,n=l);var p=(c[a]+e.offsetX)*e.scaleX,v=(c[a+1]+e.offsetY)*e.scaleY,d=(c[r]+e.offsetX)*e.scaleX,g=(c[r+1]+e.offsetY)*e.scaleY,m=(c[s]+e.offsetX)*e.scaleX,x=(c[s+1]+e.offsetY)*e.scaleY;if(!(x<=v))for(var y,S,M,b,C,P,T,w,k=h[i],I=h[i+1],R=h[i+2],X=h[n],Y=h[n+1],_=h[n+2],D=h[o],F=h[o+1],A=h[o+2],B=Math.round(v),U=Math.round(x),z=B;z<=U;z++){if(z<g){var L=void 0;y=p-(p-d)*(L=z<v?0:v===g?1:(v-z)/(v-g)),S=k-(k-X)*L,M=I-(I-Y)*L,b=R-(R-_)*L}else{var G=void 0;y=d-(d-m)*(G=x<z?1:g===x?0:(g-z)/(g-x)),S=X-(X-D)*G,M=Y-(Y-F)*G,b=_-(_-A)*G}var V=void 0;C=p-(p-m)*(V=z<v?0:x<z?1:(v-z)/(v-x)),P=k-(k-D)*V,T=I-(I-F)*V,w=R-(R-A)*V;for(var E=Math.round(Math.min(y,C)),j=Math.round(Math.max(y,C)),O=u*z+4*E,q=E;q<=j;q++)(V=(y-q)/(y-C))<0?V=0:1<V&&(V=1),f[O++]=S-(S-P)*V|0,f[O++]=M-(M-T)*V|0,f[O++]=b-(b-w)*V|0,f[O++]=255}}function w(t,e,a){var r,s,i=e.coords,n=e.colors;switch(e.type){case"lattice":var o=e.verticesPerRow,l=Math.floor(i.length/o)-1,c=o-1;for(r=0;r<l;r++)for(var h=r*o,f=0;f<c;f++,h++)u(t,a,i[h],i[h+1],i[h+o],n[h],n[h+1],n[h+o]),u(t,a,i[h+o+1],i[h+1],i[h+o],n[h+o+1],n[h+1],n[h+o]);break;case"triangles":for(r=0,s=i.length;r<s;r+=3)u(t,a,i[r],i[r+1],i[r+2],n[r],n[r+1],n[r+2]);break;default:throw new Error("illegal figure")}}return function(t,e,a,r,s,i,n,o){var l,c,h,f,u=Math.floor(t[0]),p=Math.floor(t[1]),v=Math.ceil(t[2])-u,d=Math.ceil(t[3])-p,g=Math.min(Math.ceil(Math.abs(v*e[0]*1.1)),3e3),m=Math.min(Math.ceil(Math.abs(d*e[1]*1.1)),3e3),x=v/g,y=d/m,S={coords:a,colors:r,offsetX:-u,offsetY:-p,scaleX:1/x,scaleY:1/y},M=g+4,b=m+4;if(o.isEnabled)l=o.drawFigures({width:g,height:m,backgroundColor:i,figures:s,context:S}),(c=n.getCanvas("mesh",M,b,!1)).context.drawImage(l,2,2),l=c.canvas;else{var C=(c=n.getCanvas("mesh",M,b,!1)).context,P=C.createImageData(g,m);if(i){var T=P.data;for(h=0,f=T.length;h<f;h+=4)T[h]=i[0],T[h+1]=i[1],T[h+2]=i[2],T[h+3]=255}for(h=0;h<s.length;h++)w(P,s[h],S);C.putImageData(P,2,2),l=c.canvas}return{canvas:l,offsetX:u-2*x,offsetY:p-2*y,scaleX:x,scaleY:y}}}();function getShadingPatternFromIR(t){var e=ShadingIRs[t[0]];if(!e)throw new Error("Unknown IR type: ".concat(t[0]));return e.fromIR(t)}ShadingIRs.Mesh={fromIR:function(t){var n=t[2],o=t[3],l=t[4],c=t[5],h=t[6],f=t[7],u=t[8];return{getPattern:function(t,e,a){var r;if(applyBoundingBox(t,f),a)r=_util.Util.singularValueDecompose2dScale(t.mozCurrentTransform);else if(r=_util.Util.singularValueDecompose2dScale(e.baseTransform),h){var s=_util.Util.singularValueDecompose2dScale(h);r=[r[0]*s[0],r[1]*s[1]]}var i=createMeshCanvas(c,r,n,o,l,a?null:u,e.cachedCanvases,e.webGLContext);return a||(t.setTransform.apply(t,e.baseTransform),h&&t.transform.apply(t,h)),t.translate(i.offsetX,i.offsetY),t.scale(i.scaleX,i.scaleY),t.createPattern(i.canvas,"no-repeat")}}}},ShadingIRs.Dummy={fromIR:function(){return{getPattern:function(){return"hotpink"}}}};var TilingPattern=function(){var o=1,l=2;function t(t,e,a,r,s){this.operatorList=t[2],this.matrix=t[3]||[1,0,0,1,0,0],this.bbox=t[4],this.xstep=t[5],this.ystep=t[6],this.paintType=t[7],this.tilingType=t[8],this.color=e,this.canvasGraphicsFactory=r,this.baseTransform=s,this.ctx=a}return t.prototype={createPatternCanvas:function(t){var e=this.operatorList,a=this.bbox,r=this.xstep,s=this.ystep,i=this.paintType,n=this.tilingType,o=this.color,l=this.canvasGraphicsFactory;(0,_util.info)("TilingType: "+n);var c=a[0],h=a[1],f=a[2],u=a[3],p=_util.Util.singularValueDecompose2dScale(this.matrix),v=_util.Util.singularValueDecompose2dScale(this.baseTransform),d=[p[0]*v[0],p[1]*v[1]],g=this.getSizeAndScale(r,this.ctx.canvas.width,d[0]),m=this.getSizeAndScale(s,this.ctx.canvas.height,d[1]),x=t.cachedCanvases.getCanvas("pattern",g.size,m.size,!0),y=x.context,S=l.createCanvasGraphics(y);return S.groupLevel=t.groupLevel,this.setFillAndStrokeStyleToContext(S,i,o),S.transform(g.scale,0,0,m.scale,0,0),S.transform(1,0,0,1,-c,-h),this.clipBbox(S,a,c,h,f,u),S.executeOperatorList(e),this.ctx.transform(1,0,0,1,c,h),this.ctx.scale(1/g.scale,1/m.scale),x.canvas},getSizeAndScale:function(t,e,a){t=Math.abs(t);var r=Math.max(3e3,e),s=Math.ceil(t*a);return r<=s?s=r:a=s/t,{scale:a,size:s}},clipBbox:function(t,e,a,r,s,i){if(Array.isArray(e)&&4===e.length){var n=s-a,o=i-r;t.ctx.rect(a,r,n,o),t.clip(),t.endPath()}},setFillAndStrokeStyleToContext:function(t,e,a){var r=t.ctx,s=t.current;switch(e){case o:var i=this.ctx;r.fillStyle=i.fillStyle,r.strokeStyle=i.strokeStyle,s.fillColor=i.fillStyle,s.strokeColor=i.strokeStyle;break;case l:var n=_util.Util.makeHexColor(a[0],a[1],a[2]);r.fillStyle=n,r.strokeStyle=n,s.fillColor=n,s.strokeColor=n;break;default:throw new _util.FormatError("Unsupported paint type: ".concat(e))}},getPattern:function(t,e){(t=this.ctx).setTransform.apply(t,this.baseTransform),t.transform.apply(t,this.matrix);var a=this.createPatternCanvas(e);return t.createPattern(a,"repeat")}},t}();exports.TilingPattern=TilingPattern;