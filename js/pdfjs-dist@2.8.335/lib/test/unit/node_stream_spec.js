"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o,i,u=[],l=!0,s=!1;try{if(o=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=o.call(r)).done)&&(u.push(n.value),u.length!==t);l=!0);}catch(e){s=!0,a=e}finally{try{if(!l&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(s)throw a}}return u}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var _util=require("../../shared/util.js"),_is_node=require("../../shared/is_node.js"),_node_stream=require("../../display/node_stream.js");if(!_is_node.isNodeJS)throw new Error('The "node_stream" unit-tests can only be run in Node.js environments.');var path=require("path"),url=require("url"),http=require("http"),fs=require("fs");describe("node_stream",function(){var t=null,A=null,E=url.parse(encodeURI("file://"+path.join(process.cwd(),"./test/pdfs/tracemonkey.pdf"))).href,x=1016315;beforeAll(function(e){t=http.createServer(function(l,s){var d=process.cwd()+"/test/pdfs"+l.url;fs.lstat(d,function(e,t){if(e)return s.writeHead(404),void s.end("File ".concat(l.url," not found!"));if(l.headers.range){var r=_slicedToArray(l.headers.range.split("=")[1].split("-").map(function(e){return Number(e)}),2),n=r[0],a=r[1],o=fs.createReadStream(d,{start:n,end:a});s.writeHead(206,{"Content-Type":"application/pdf"}),o.pipe(s)}else{var i=t.size,u=fs.createReadStream(d);s.writeHead(200,{"Content-Type":"application/pdf","Content-Length":i,"Accept-Ranges":"bytes"}),u.pipe(s)}})}).listen(0),A=t.address().port,e()}),afterAll(function(e){t.close(),e()}),it("read both http(s) and filesystem pdf files",function(t){var r,n,a,o,e=new _node_stream.PDFNodeStream({url:"http://127.0.0.1:".concat(A,"/tracemonkey.pdf"),rangeChunkSize:65536,disableStream:!0,disableRange:!0}),i=new _node_stream.PDFNodeStream({url:E,rangeChunkSize:65536,disableStream:!0,disableRange:!0}),u=e.getFullReader(),l=i.getFullReader(),s=u.headersReady.then(function(){r=u.isStreamingSupported,n=u.isRangeSupported}),d=l.headersReady.then(function(){a=l.isStreamingSupported,o=l.isRangeSupported}),c=0,p=0;Promise.all([function t(){return u.read().then(function(e){if(!e.done)return c+=e.value.byteLength,t()})}(),function t(){return l.read().then(function(e){if(!e.done)return p+=e.value.byteLength,t()})}(),s,d]).then(function(e){expect(r).toEqual(!1),expect(n).toEqual(!1),expect(a).toEqual(!1),expect(o).toEqual(!1),expect(c).toEqual(x),expect(c).toEqual(p),t()}).catch(function(e){t.fail(e)})}),it("read custom ranges for both http(s) and filesystem urls",function(t){var e,r,n,a,o,i,u=32768,l=new _node_stream.PDFNodeStream({url:"http://127.0.0.1:".concat(A,"/tracemonkey.pdf"),length:x,rangeChunkSize:u,disableStream:!0,disableRange:!1}),s=new _node_stream.PDFNodeStream({url:E,length:x,rangeChunkSize:u,disableStream:!0,disableRange:!1}),d=l.getFullReader(),c=s.getFullReader(),p=d.headersReady.then(function(){e=d.isStreamingSupported,r=d.isRangeSupported,d.cancel(new _util.AbortException("Don't need fullReader1.")),n=!0}),f=c.headersReady.then(function(){a=c.isStreamingSupported,o=c.isRangeSupported,c.cancel(new _util.AbortException("Don't need fullReader2.")),i=!0}),h=507,y=l.getRangeReader(983040,x-h),m=l.getRangeReader(x-h,x),g=s.getRangeReader(983040,x-h),b=s.getRangeReader(x-h,x),_={value:0},S={value:0},R={value:0},v={value:0},q=function t(r,n){return r.read().then(function(e){if(!e.done)return n.value+=e.value.byteLength,t(r,n)})};Promise.all([q(y,_),q(m,S),q(g,R),q(b,v),p,f]).then(function(){expect(_.value).toEqual(u),expect(S.value).toEqual(h),expect(R.value).toEqual(u),expect(v.value).toEqual(h),expect(e).toEqual(!1),expect(r).toEqual(!0),expect(n).toEqual(!0),expect(a).toEqual(!1),expect(o).toEqual(!0),expect(i).toEqual(!0),t()}).catch(function(e){t.fail(e)})})});