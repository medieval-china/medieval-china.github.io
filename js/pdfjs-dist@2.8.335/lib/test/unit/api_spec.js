"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var o,r,a,i,c=[],s=!0,u=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;s=!1}else for(;!(s=(o=a.call(n)).done)&&(c.push(o.value),c.length!==e);s=!0);}catch(t){u=!0,r=t}finally{try{if(!s&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw r}}return c}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _regeneratorRuntime(){_regeneratorRuntime=function(){return i};var i={},t=Object.prototype,l=t.hasOwnProperty,p=Object.defineProperty||function(t,e,n){t[e]=n.value},e="function"==typeof Symbol?Symbol:{},r=e.iterator||"@@iterator",n=e.asyncIterator||"@@asyncIterator",o=e.toStringTag||"@@toStringTag";function a(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{a({},"")}catch(t){a=function(t,e,n){return t[e]=n}}function c(t,e,n,o){var a,i,c,s,r=e&&e.prototype instanceof h?e:h,u=Object.create(r.prototype),l=new w(o||[]);return p(u,"_invoke",{value:(a=t,i=n,c=l,s="suspendedStart",function(t,e){if("executing"===s)throw new Error("Generator is already running");if("completed"===s){if("throw"===t)throw e;return b()}for(c.method=t,c.arg=e;;){var n=c.delegate;if(n){var o=v(n,c);if(o){if(o===d)continue;return o}}if("next"===c.method)c.sent=c._sent=c.arg;else if("throw"===c.method){if("suspendedStart"===s)throw s="completed",c.arg;c.dispatchException(c.arg)}else"return"===c.method&&c.abrupt("return",c.arg);s="executing";var r=f(a,i,c);if("normal"===r.type){if(s=c.done?"completed":"suspendedYield",r.arg===d)continue;return{value:r.arg,done:c.done}}"throw"===r.type&&(s="completed",c.method="throw",c.arg=r.arg)}})}),u}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}i.wrap=c;var d={};function h(){}function s(){}function u(){}var g={};a(g,r,function(){return this});var m=Object.getPrototypeOf,x=m&&m(m(D([])));x&&x!==t&&l.call(x,r)&&(g=x);var _=u.prototype=h.prototype=Object.create(g);function y(t){["next","throw","return"].forEach(function(e){a(t,e,function(t){return this._invoke(e,t)})})}function E(s,u){var e;p(this,"_invoke",{value:function(n,o){function t(){return new u(function(t,e){!function e(t,n,o,r){var a=f(s[t],s,n);if("throw"!==a.type){var i=a.arg,c=i.value;return c&&"object"==_typeof(c)&&l.call(c,"__await")?u.resolve(c.__await).then(function(t){e("next",t,o,r)},function(t){e("throw",t,o,r)}):u.resolve(c).then(function(t){i.value=t,o(i)},function(t){return e("throw",t,o,r)})}r(a.arg)}(n,o,t,e)})}return e=e?e.then(t,t):t()}})}function v(t,e){var n=e.method,o=t.iterator[n];if(void 0===o)return e.delegate=null,"throw"===n&&t.iterator.return&&(e.method="return",e.arg=void 0,v(t,e),"throw"===e.method)||"return"!==n&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+n+"' method")),d;var r=f(o,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,d;var a=r.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,d):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,d)}function P(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function q(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function w(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(P,this),this.reset(!0)}function D(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(l.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:b}}function b(){return{value:void 0,done:!0}}return p(_,"constructor",{value:s.prototype=u,configurable:!0}),p(u,"constructor",{value:s,configurable:!0}),s.displayName=a(u,o,"GeneratorFunction"),i.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===s||"GeneratorFunction"===(e.displayName||e.name))},i.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,a(t,o,"GeneratorFunction")),t.prototype=Object.create(_),t},i.awrap=function(t){return{__await:t}},y(E.prototype),a(E.prototype,n,function(){return this}),i.AsyncIterator=E,i.async=function(t,e,n,o,r){void 0===r&&(r=Promise);var a=new E(c(t,e,n,o),r);return i.isGeneratorFunction(e)?a:a.next().then(function(t){return t.done?t.value:a.next()})},y(_),a(_,o,"Generator"),a(_,r,function(){return this}),a(_,"toString",function(){return"[object Generator]"}),i.keys=function(t){var n=Object(t),o=[];for(var e in n)o.push(e);return o.reverse(),function t(){for(;o.length;){var e=o.pop();if(e in n)return t.value=e,t.done=!1,t}return t.done=!0,t}},i.values=D,w.prototype={constructor:w,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(q),!t)for(var e in this)"t"===e.charAt(0)&&l.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var o=this;function t(t,e){return a.type="throw",a.arg=n,o.next=t,e&&(o.method="next",o.arg=void 0),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e],a=r.completion;if("root"===r.tryLoc)return t("end");if(r.tryLoc<=this.prev){var i=l.call(r,"catchLoc"),c=l.call(r,"finallyLoc");if(i&&c){if(this.prev<r.catchLoc)return t(r.catchLoc,!0);if(this.prev<r.finallyLoc)return t(r.finallyLoc)}else if(i){if(this.prev<r.catchLoc)return t(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return t(r.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;0<=n;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&l.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var r=o;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var a=r?r.completion:{};return a.type=t,a.arg=e,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),q(n),d}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var o=n.completion;if("throw"===o.type){var r=o.arg;q(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:D(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},i}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function asyncGeneratorStep(t,e,n,o,r,a,i){try{var c=t[a](i),s=c.value}catch(t){return void n(t)}c.done?e(s):Promise.resolve(s).then(o,r)}function _asyncToGenerator(c){return function(){var t=this,i=arguments;return new Promise(function(e,n){var o=c.apply(t,i);function r(t){asyncGeneratorStep(o,e,n,r,a,"next",t)}function a(t){asyncGeneratorStep(o,e,n,r,a,"throw",t)}r(void 0)})}}var _test_utils=require("./test_utils.js"),_util=require("../../shared/util.js"),_api=require("../../display/api.js"),_display_utils=require("../../display/display_utils.js"),_ui_utils=require("../../web/ui_utils.js"),_image_utils=require("../../core/image_utils.js"),_worker_options=require("../../display/worker_options.js"),_is_node=require("../../shared/is_node.js"),_metadata=require("../../display/metadata.js");describe("api",function(){var l,s="basicapi.pdf",i=105779,a=(0,_test_utils.buildGetDocumentParams)(s);function u(t){setTimeout(function(){t()},10)}beforeAll(function(t){l=new _api.DefaultCanvasFactory,t()}),afterAll(function(t){l=null,t()}),describe("getDocument",function(){it("creates pdf doc from URL-string",_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n,o;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=_test_utils.TEST_PDFS_PATH+s,n=(0,_api.getDocument)(e),t.next=4,n.promise;case 4:return o=t.sent,expect(_typeof(e)).toEqual("string"),expect(o instanceof _api.PDFDocumentProxy).toEqual(!0),expect(o.numPages).toEqual(3),t.next=10,n.destroy();case 10:case"end":return t.stop()}},t)}))),it("creates pdf doc from URL-object",_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n,o;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return _is_node.isNodeJS&&pending("window.location is not supported in Node.js."),e=new URL(_test_utils.TEST_PDFS_PATH+s,window.location),n=(0,_api.getDocument)(e),t.next=5,n.promise;case 5:return o=t.sent,expect(e instanceof URL).toEqual(!0),expect(o instanceof _api.PDFDocumentProxy).toEqual(!0),expect(o.numPages).toEqual(3),t.next=11,n.destroy();case 11:case"end":return t.stop()}},t)}))),it("creates pdf doc from URL",function(e){var n=(0,_api.getDocument)(a),o=(0,_util.createPromiseCapability)();n.onProgress=function(t){o.settled||o.resolve(t)};var t=[o.promise,n.promise];Promise.all(t).then(function(t){expect(0<=t[0].loaded/t[0].total).toEqual(!0),expect(t[1]instanceof _api.PDFDocumentProxy).toEqual(!0),expect(n).toEqual(t[1].loadingTask),n.destroy().then(e)}).catch(e.fail)}),it("creates pdf doc from URL and aborts before worker initialized",function(e){var t=(0,_api.getDocument)(a),n=t.destroy();t.promise.then(function(t){e.fail("shall fail loading")}).catch(function(t){expect(!0).toEqual(!0),n.then(e)})}),it("creates pdf doc from URL and aborts loading after worker initialized",function(e){var t=(0,_api.getDocument)(a);t._worker.promise.then(function(){return t.destroy()}).then(function(t){expect(!0).toEqual(!0),e()}).catch(e.fail)}),it("creates pdf doc from typed array",function(o){_test_utils.DefaultFileReaderFactory.fetch({path:_test_utils.TEST_PDFS_PATH+s}).then(function(t){expect(t.length).toEqual(i);var e=(0,_api.getDocument)(t),n=(0,_util.createPromiseCapability)();return e.onProgress=function(t){n.resolve(t)},Promise.all([e.promise,n.promise]).then(function(t){expect(t[0]instanceof _api.PDFDocumentProxy).toEqual(!0),expect(t[1].loaded/t[1].total).toEqual(1),e.destroy().then(o)})}).catch(o.fail)}),it("creates pdf doc from invalid PDF file",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("bug1020226.pdf"));n.promise.then(function(){e.fail("shall fail loading")}).catch(function(t){expect(t instanceof _util.InvalidPDFException).toEqual(!0),expect(t.message).toEqual("Invalid PDF structure."),n.destroy().then(e)})}),it("creates pdf doc from non-existent URL",function(e){_is_node.isNodeJS||pending("Fails intermittently on linux in browsers.");var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("non-existent.pdf"));n.promise.then(function(t){e.fail("shall fail loading")}).catch(function(t){expect(t instanceof _util.MissingPDFException).toEqual(!0),n.destroy().then(e)})}),it("creates pdf doc from PDF file protected with user and owner password",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("pr6531_1.pdf")),o=(0,_util.createPromiseCapability)(),r=(0,_util.createPromiseCapability)();n.onPassword=function(t,e){return e!==_util.PasswordResponses.NEED_PASSWORD||o.settled?e!==_util.PasswordResponses.INCORRECT_PASSWORD||r.settled?void expect(!1).toEqual(!0):(r.resolve(),void t("asdfasdf")):(o.resolve(),void t("qwerty"))};var t=[o.promise,r.promise,n.promise];Promise.all(t).then(function(t){expect(t[2]instanceof _api.PDFDocumentProxy).toEqual(!0),n.destroy().then(e)}).catch(e.fail)}),it("creates pdf doc from PDF file protected with only a user password",function(t){var e="pr6531_2.pdf",n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(e,{password:""})),o=n.promise.then(function(){return t.fail("shall fail with no password"),Promise.reject(new Error("loadingTask should be rejected"))},function(t){return expect(t instanceof _util.PasswordException).toEqual(!0),expect(t.code).toEqual(_util.PasswordResponses.NEED_PASSWORD),n.destroy()}),r=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(e,{password:"qwerty"})),a=r.promise.then(function(){return t.fail("shall fail with wrong password"),Promise.reject(new Error("loadingTask should be rejected"))},function(t){return expect(t instanceof _util.PasswordException).toEqual(!0),expect(t.code).toEqual(_util.PasswordResponses.INCORRECT_PASSWORD),r.destroy()}),i=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(e,{password:"asdfasdf"})),c=i.promise.then(function(t){return expect(t instanceof _api.PDFDocumentProxy).toEqual(!0),i.destroy()});Promise.all([o,a,c]).then(function(){t()}).catch(t.fail)}),it("creates pdf doc from password protected PDF file and aborts/throws in the onPassword callback (issue 7806)",function(t){var n,e="issue3371.pdf",o=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(e)),r=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(e,{password:"qwerty"}));o.onPassword=function(t,e){e!==_util.PasswordResponses.NEED_PASSWORD?expect(!1).toEqual(!0):n=o.destroy()};var a=o.promise.then(function(){return t.fail("shall fail since the loadingTask should be destroyed"),Promise.reject(new Error("loadingTask should be rejected"))},function(t){return expect(t instanceof _util.PasswordException).toEqual(!0),expect(t.code).toEqual(_util.PasswordResponses.NEED_PASSWORD),n});r.onPassword=function(t,e){if(e===_util.PasswordResponses.INCORRECT_PASSWORD)throw new Error("Incorrect password");expect(!1).toEqual(!0)};var i=r.promise.then(function(){return t.fail("shall fail since the onPassword callback should throw"),Promise.reject(new Error("loadingTask should be rejected"))},function(t){return expect(t instanceof _util.PasswordException).toEqual(!0),expect(t.code).toEqual(_util.PasswordResponses.INCORRECT_PASSWORD),r.destroy()});Promise.all([a,i]).then(function(){t()}).catch(t.fail)}),it("creates pdf doc from empty typed array",function(e){var n=(0,_api.getDocument)(new Uint8Array(0));n.promise.then(function(){e.fail("shall not open empty file")},function(t){expect(t instanceof _util.InvalidPDFException),expect(t.message).toEqual("The PDF file is empty, i.e. its size is zero bytes."),n.destroy().then(e)})})}),describe("PDFWorker",function(){it("worker created or destroyed",function(t){_is_node.isNodeJS&&pending("Worker is not supported in Node.js.");var e=new _api.PDFWorker({name:"test1"});e.promise.then(function(){expect(e.name).toEqual("test1"),expect(!!e.port).toEqual(!0),expect(e.destroyed).toEqual(!1),expect(!!e._webWorker).toEqual(!0),expect(e.port===e._webWorker).toEqual(!0),e.destroy(),expect(!!e.port).toEqual(!1),expect(e.destroyed).toEqual(!0),t()}).catch(t.fail)}),it("worker created or destroyed by getDocument",function(e){_is_node.isNodeJS&&pending("Worker is not supported in Node.js.");var n,o=(0,_api.getDocument)(a);o.promise.then(function(){n=o._worker,expect(!!n).toEqual(!0)}),o.promise.then(function(){return o.destroy()}).then(function(){var t=o._worker;expect(!!t).toEqual(!1),expect(n.destroyed).toEqual(!0),e()}).catch(e.fail)}),it("worker created and can be used in getDocument",function(t){_is_node.isNodeJS&&pending("Worker is not supported in Node.js.");var n=new _api.PDFWorker({name:"test1"}),o=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(s,{worker:n}));o.promise.then(function(){var t=o._worker;expect(!!t).toEqual(!1);var e=o._transport.messageHandler.comObj;expect(e===n.port).toEqual(!0)}),o.promise.then(function(){return o.destroy()}).then(function(){expect(n.destroyed).toEqual(!1),n.destroy(),t()}).catch(t.fail)}),it("creates more than one worker",function(t){_is_node.isNodeJS&&pending("Worker is not supported in Node.js.");var e=new _api.PDFWorker({name:"test1"}),n=new _api.PDFWorker({name:"test2"}),o=new _api.PDFWorker({name:"test3"});Promise.all([e.promise,n.promise,o.promise]).then(function(){expect(e.port!==n.port&&e.port!==o.port&&n.port!==o.port).toEqual(!0),e.destroy(),n.destroy(),o.destroy(),t()}).catch(t.fail)}),it("gets current workerSrc",function(){_is_node.isNodeJS&&pending("Worker is not supported in Node.js.");var t=_api.PDFWorker.getWorkerSrc();expect(_typeof(t)).toEqual("string"),expect(t).toEqual(_worker_options.GlobalWorkerOptions.workerSrc)})}),describe("PDFDocument",function(){var n,r;beforeAll(function(e){(n=(0,_api.getDocument)(a)).promise.then(function(t){r=t,e()})}),afterAll(function(t){n.destroy().then(t)}),it("gets number of pages",function(){expect(r.numPages).toEqual(3)}),it("gets fingerprint",function(){expect(r.fingerprint).toEqual("ea8b35919d6279a369e835bde778611b")}),it("gets page",function(e){r.getPage(1).then(function(t){expect(t instanceof _api.PDFPageProxy).toEqual(!0),expect(t.pageNumber).toEqual(1),e()}).catch(e.fail)}),it("gets non-existent page",function(t){var e=r.getPage(100),n=r.getPage(2.5),o=r.getPage("1");e=e.then(function(){throw new Error("shall fail for out-of-range pageNumber parameter")},function(t){expect(t instanceof Error).toEqual(!0)}),n=n.then(function(){throw new Error("shall fail for non-integer pageNumber parameter")},function(t){expect(t instanceof Error).toEqual(!0)}),o=o.then(function(){throw new Error("shall fail for non-number pageNumber parameter")},function(t){expect(t instanceof Error).toEqual(!0)}),Promise.all([e,n,o]).then(function(){t()}).catch(t.fail)}),it("gets page, from /Pages tree with circular reference",function(t){var e=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("Pages-tree-refs.pdf")),n=e.promise.then(function(t){return t.getPage(1).then(function(t){expect(t instanceof _api.PDFPageProxy).toEqual(!0),expect(t.ref).toEqual({num:6,gen:0})},function(t){throw new Error("shall not fail for valid page")})}),o=e.promise.then(function(t){return t.getPage(2).then(function(t){throw new Error("shall fail for invalid page")},function(t){expect(t instanceof Error).toEqual(!0),expect(t.message).toEqual("Pages tree contains circular reference.")})});Promise.all([n,o]).then(function(){e.destroy().then(t)},t.fail)}),it("gets page index",function(e){r.getPageIndex({num:17,gen:0}).then(function(t){expect(t).toEqual(1),e()}).catch(e.fail)}),it("gets invalid page index",function(e){r.getPageIndex({num:3,gen:0}).then(function(){e.fail("shall fail for invalid page reference.")}).catch(function(t){expect(t instanceof Error).toEqual(!0),e()})}),it("gets destinations, from /Dests dictionary",function(e){r.getDestinations().then(function(t){expect(t).toEqual({chapter1:[{gen:0,num:17},{name:"XYZ"},0,841.89,null]}),e()}).catch(e.fail)}),it("gets a destination, from /Dests dictionary",function(e){r.getDestination("chapter1").then(function(t){expect(t).toEqual([{gen:0,num:17},{name:"XYZ"},0,841.89,null]),e()}).catch(e.fail)}),it("gets a non-existent destination, from /Dests dictionary",function(e){r.getDestination("non-existent-named-destination").then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("gets destinations, from /Names (NameTree) dictionary",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue6204.pdf"));n.promise.then(function(t){return t.getDestinations()}).then(function(t){expect(t).toEqual({"Page.1":[{num:1,gen:0},{name:"XYZ"},0,375,null],"Page.2":[{num:6,gen:0},{name:"XYZ"},0,375,null]}),n.destroy().then(e)}).catch(e.fail)}),it("gets a destination, from /Names (NameTree) dictionary",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue6204.pdf"));n.promise.then(function(t){return t.getDestination("Page.1")}).then(function(t){expect(t).toEqual([{num:1,gen:0},{name:"XYZ"},0,375,null]),n.destroy().then(e)}).catch(e.fail)}),it("gets a non-existent destination, from /Names (NameTree) dictionary",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue6204.pdf"));n.promise.then(function(t){return t.getDestination("non-existent-named-destination")}).then(function(t){expect(t).toEqual(null),n.destroy().then(e)}).catch(e.fail)}),it("gets non-string destination",function(t){var e=r.getDestination(4.3),n=r.getDestination(!0),o=r.getDestination([{num:17,gen:0},{name:"XYZ"},0,841.89,null]);e=e.then(function(){throw new Error("shall fail for non-string destination.")},function(t){expect(t instanceof Error).toEqual(!0)}),n=n.then(function(){throw new Error("shall fail for non-string destination.")},function(t){expect(t instanceof Error).toEqual(!0)}),o=o.then(function(){throw new Error("shall fail for non-string destination.")},function(t){expect(t instanceof Error).toEqual(!0)}),Promise.all([e,n,o]).then(t,t.fail)}),it("gets non-existent page labels",function(e){r.getPageLabels().then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("gets page labels",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("bug793632.pdf")),t=n.promise.then(function(t){return t.getPageLabels()}),o=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue1453.pdf")),r=o.promise.then(function(t){return t.getPageLabels()}),a=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("rotation.pdf")),i=a.promise.then(function(t){return t.getPageLabels()}),c=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("bad-PageLabels.pdf")),s=c.promise.then(function(t){return t.getPageLabels()});Promise.all([t,r,i,s]).then(function(t){expect(t[0]).toEqual(["i","ii","iii","1"]),expect(t[1]).toEqual(["Front Page1"]),expect(t[2]).toEqual(["1","2"]),expect(t[3]).toEqual(["X3"]),Promise.all([n.destroy(),o.destroy(),a.destroy(),c.destroy()]).then(e)}).catch(e.fail)}),it("gets default page layout",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"));n.promise.then(function(t){return t.getPageLayout()}).then(function(t){expect(t).toEqual(""),n.destroy().then(e)}).catch(e.fail)}),it("gets non-default page layout",function(e){r.getPageLayout().then(function(t){expect(t).toEqual("SinglePage"),e()}).catch(e.fail)}),it("gets default page mode",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"));n.promise.then(function(t){return t.getPageMode()}).then(function(t){expect(t).toEqual("UseNone"),n.destroy().then(e)}).catch(e.fail)}),it("gets non-default page mode",function(e){r.getPageMode().then(function(t){expect(t).toEqual("UseOutlines"),e()}).catch(e.fail)}),it("gets default viewer preferences",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"));n.promise.then(function(t){return t.getViewerPreferences()}).then(function(t){expect(t).toEqual(null),n.destroy().then(e)}).catch(e.fail)}),it("gets non-default viewer preferences",function(e){r.getViewerPreferences().then(function(t){expect(t).toEqual({Direction:"L2R"}),e()}).catch(e.fail)}),it("gets default open action",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"));n.promise.then(function(t){return t.getOpenAction()}).then(function(t){expect(t).toEqual(null),n.destroy().then(e)}).catch(e.fail)}),it("gets non-default open action (with destination)",function(e){r.getOpenAction().then(function(t){expect(t.dest).toEqual([{num:15,gen:0},{name:"FitH"},null]),expect(t.action).toBeUndefined(),e()}).catch(e.fail)}),it("gets non-default open action (with Print action)",function(t){var e=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("bug1001080.pdf")),n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue11442_reduced.pdf")),o=e.promise.then(function(t){return t.getOpenAction()}).then(function(t){return expect(t.dest).toBeUndefined(),expect(t.action).toEqual("Print"),e.destroy()}),r=n.promise.then(function(t){return t.getOpenAction()}).then(function(t){return expect(t.dest).toBeUndefined(),expect(t.action).toEqual("Print"),n.destroy()});Promise.all([o,r]).then(t,t.fail)}),it("gets non-existent attachments",function(e){r.getAttachments().then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("gets attachments",function(n){var o=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("attachment.pdf"));o.promise.then(function(t){return t.getAttachments()}).then(function(t){var e=t["foo.txt"];expect(e.filename).toEqual("foo.txt"),expect(e.content).toEqual(new Uint8Array([98,97,114,32,98,97,122,32,10])),o.destroy().then(n)}).catch(n.fail)}),it("gets javascript",function(e){r.getJavaScript().then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("gets javascript with printing instructions (JS action)",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue6106.pdf"));n.promise.then(function(t){return t.getJavaScript()}).then(function(t){expect(t).toEqual(["this.print({bUI:true,bSilent:false,bShrinkToFit:true});"]),expect(t[0]).toMatch(_ui_utils.AutoPrintRegExp),n.destroy().then(e)}).catch(e.fail)}),it("gets JSActions (none)",function(e){r.getJSActions().then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("gets JSActions",function(i){var c=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("doc_actions.pdf"));c.promise.then(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){var n,o,r,a,i;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.getJSActions();case 2:return n=t.sent,t.next=5,e.getPage(1);case 5:return o=t.sent,t.next=8,e.getPage(3);case 8:return r=t.sent,t.next=11,o.getJSActions();case 11:return a=t.sent,t.next=14,r.getJSActions();case 14:return i=t.sent,t.abrupt("return",[n,a,i]);case 16:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}()).then(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){var n,o,r,a;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:n=_slicedToArray(e,3),o=n[0],r=n[1],a=n[2],expect(o).toEqual({DidPrint:['this.getField("Text2").value = "DidPrint";'],DidSave:['this.getField("Text2").value = "DidSave";'],WillClose:['this.getField("Text1").value = "WillClose";'],WillPrint:['this.getField("Text1").value = "WillPrint";'],WillSave:['this.getField("Text1").value = "WillSave";']}),expect(r).toEqual({PageOpen:['this.getField("Text1").value = "PageOpen 1";'],PageClose:['this.getField("Text2").value = "PageClose 1";']}),expect(a).toEqual({PageOpen:['this.getField("Text5").value = "PageOpen 3";'],PageClose:['this.getField("Text6").value = "PageClose 3";']}),c.destroy().then(i);case 5:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}()).catch(i.fail)}),it("gets non-existent outline",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"));n.promise.then(function(t){return t.getOutline()}).then(function(t){expect(t).toEqual(null),n.destroy().then(e)}).catch(e.fail)}),it("gets outline",function(n){r.getOutline().then(function(t){expect(Array.isArray(t)).toEqual(!0),expect(t.length).toEqual(2);var e=t[1];expect(e.title).toEqual("Chapter 1"),expect(Array.isArray(e.dest)).toEqual(!0),expect(e.url).toEqual(null),expect(e.unsafeUrl).toBeUndefined(),expect(e.newWindow).toBeUndefined(),expect(e.bold).toEqual(!0),expect(e.italic).toEqual(!1),expect(e.color).toEqual(new Uint8ClampedArray([0,64,128])),expect(e.items.length).toEqual(1),expect(e.items[0].title).toEqual("Paragraph 1.1"),n()}).catch(n.fail)}),it("gets outline containing a url",function(o){var r=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue3214.pdf"));r.promise.then(function(t){t.getOutline().then(function(t){expect(Array.isArray(t)).toEqual(!0),expect(t.length).toEqual(5);var e=t[2];expect(_typeof(e.title)).toEqual("string"),expect(e.dest).toEqual(null),expect(e.url).toEqual("http://google.com/"),expect(e.unsafeUrl).toEqual("http://google.com"),expect(e.newWindow).toBeUndefined();var n=t[1];expect(n.bold).toEqual(!1),expect(n.italic).toEqual(!0),expect(n.color).toEqual(new Uint8ClampedArray([0,0,0])),r.destroy().then(o)})}).catch(o.fail)}),it("gets non-existent permissions",function(e){r.getPermissions().then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("gets permissions",function(e){var n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue9972-1.pdf")),t=n.promise.then(function(t){return t.getPermissions()}),o=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue9972-2.pdf")),r=o.promise.then(function(t){return t.getPermissions()}),a=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue9972-3.pdf")),i=a.promise.then(function(t){return t.getPermissions()}),c=Object.keys(_util.PermissionFlag).length;Promise.all([t,r,i]).then(function(t){expect(t[0].length).toEqual(c-1),expect(t[0].includes(_util.PermissionFlag.MODIFY_CONTENTS)).toBeFalsy(),expect(t[1].length).toEqual(c-2),expect(t[1].includes(_util.PermissionFlag.PRINT)).toBeFalsy(),expect(t[1].includes(_util.PermissionFlag.PRINT_HIGH_QUALITY)).toBeFalsy(),expect(t[2].length).toEqual(c-1),expect(t[2].includes(_util.PermissionFlag.COPY)).toBeFalsy(),Promise.all([n.destroy(),o.destroy(),a.destroy()]).then(e)}).catch(e.fail)}),it("gets metadata",function(a){r.getMetadata().then(function(t){var e=t.info,n=t.metadata,o=t.contentDispositionFilename,r=t.contentLength;expect(e.Title).toEqual("Basic API Test"),expect(e.Custom).toEqual(void 0),expect(e.PDFFormatVersion).toEqual("1.7"),expect(e.IsLinearized).toEqual(!1),expect(e.IsAcroFormPresent).toEqual(!1),expect(e.IsXFAPresent).toEqual(!1),expect(e.IsCollectionPresent).toEqual(!1),expect(n instanceof _metadata.Metadata).toEqual(!0),expect(n.get("dc:title")).toEqual("Basic API Test"),expect(o).toEqual(null),expect(r).toEqual(i),a()}).catch(a.fail)}),it("gets metadata, with custom info dict entries",function(i){var c=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"));c.promise.then(function(t){return t.getMetadata()}).then(function(t){var e=t.info,n=t.metadata,o=t.contentDispositionFilename,r=t.contentLength;expect(e.Creator).toEqual("TeX"),expect(e.Producer).toEqual("pdfeTeX-1.21a"),expect(e.CreationDate).toEqual("D:20090401163925-07'00'");var a=e.Custom;expect("object"===_typeof(a)&&null!==a).toEqual(!0),expect(a["PTEX.Fullbanner"]).toEqual("This is pdfeTeX, Version 3.141592-1.21a-2.2 (Web2C 7.5.4) kpathsea version 3.5.6"),expect(e.PDFFormatVersion).toEqual("1.4"),expect(e.IsLinearized).toEqual(!1),expect(e.IsAcroFormPresent).toEqual(!1),expect(e.IsXFAPresent).toEqual(!1),expect(e.IsCollectionPresent).toEqual(!1),expect(n).toEqual(null),expect(o).toEqual(null),expect(r).toEqual(1016315),c.destroy().then(i)}).catch(i.fail)}),it("gets metadata, with missing PDF header (bug 1606566)",function(a){var i=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("bug1606566.pdf"));i.promise.then(function(t){return t.getMetadata()}).then(function(t){var e=t.info,n=t.metadata,o=t.contentDispositionFilename,r=t.contentLength;expect(e.PDFFormatVersion).toEqual(null),expect(e.IsLinearized).toEqual(!1),expect(e.IsAcroFormPresent).toEqual(!1),expect(e.IsXFAPresent).toEqual(!1),expect(e.IsCollectionPresent).toEqual(!1),expect(n).toEqual(null),expect(o).toEqual(null),expect(r).toEqual(624),i.destroy().then(a)}).catch(a.fail)}),it("gets markInfo",function(e){(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("annotation-line.pdf")).promise.then(function(t){return t.getMarkInfo()}).then(function(t){expect(t.Marked).toEqual(!0),expect(t.UserProperties).toEqual(!1),expect(t.Suspects).toEqual(!1),e()}).catch(e.fail)}),it("gets data",function(e){r.getData().then(function(t){expect(t instanceof Uint8Array).toEqual(!0),expect(t.length).toEqual(i),e()}).catch(e.fail)}),it("gets download info",function(e){r.getDownloadInfo().then(function(t){expect(t).toEqual({length:i}),e()}).catch(e.fail)}),it("gets document stats",function(e){r.getStats().then(function(t){expect(t).toEqual({streamTypes:{},fontTypes:{}}),e()}).catch(e.fail)}),it("cleans up document resources",_asyncToGenerator(_regeneratorRuntime().mark(function t(){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.cleanup();case 2:expect(!0).toEqual(!0);case 3:case"end":return t.stop()}},t)}))),it("checks that fingerprints are unique",function(o){var r=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue4436r.pdf")),a=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue4575.pdf"));Promise.all([r.promise,a.promise]).then(function(t){var e=t[0].fingerprint,n=t[1].fingerprint;expect(e).not.toEqual(n),expect(e).toEqual("2f695a83d6e7553c24fc08b7ac69712d"),expect(n).toEqual("04c7126b34a46b6d4d6e7a1eff7edcb6"),Promise.all([r.destroy(),a.destroy()]).then(o)}).catch(o.fail)}),describe("Cross-origin",function(){var a;function n(e,t,n){_is_node.isNodeJS&&pending("Cannot simulate cross-origin requests in Node.js");var o=(0,_test_utils.buildGetDocumentParams)(t,n),r=new URL(o.url);return"localhost"===r.hostname?r.hostname="127.0.0.1":"127.0.0.1"===o.url.hostname?r.hostname="localhost":pending("Can only run cross-origin test on localhost!"),o.url=r.href,(a=(0,_api.getDocument)(o)).promise.then(function(t){return t.destroy()}).then(function(){expect(e).toEqual(!0)},function(t){e&&expect(t).toEqual("There should not be any error"),expect(e).toEqual(!1)})}function e(t,e){return n(!0,t,e)}function o(t,e){return n(!1,t,e)}afterEach(function(t){a&&!a.destroyed?a.destroy().then(t):t()}),it("server disallows cors",function(t){o("basicapi.pdf").then(t)}),it("server allows cors without credentials, default withCredentials",function(t){e("basicapi.pdf?cors=withoutCredentials").then(t)}),it("server allows cors without credentials, and withCredentials=false",function(t){e("basicapi.pdf?cors=withoutCredentials",{withCredentials:!1}).then(t)}),it("server allows cors without credentials, but withCredentials=true",function(t){o("basicapi.pdf?cors=withoutCredentials",{withCredentials:!0}).then(t)}),it("server allows cors with credentials, and withCredentials=true",function(t){e("basicapi.pdf?cors=withCredentials",{withCredentials:!0}).then(t)}),it("server allows cors with credentials, and withCredentials=false",function(t){e("basicapi.pdf?cors=withCredentials",{withCredentials:!1}).then(t)})})}),describe("Page",function(){var n,i,c;beforeAll(function(e){(n=(0,_api.getDocument)(a)).promise.then(function(t){(i=t).getPage(1).then(function(t){c=t,e()})}).catch(e.fail)}),afterAll(function(t){n.destroy().then(t)}),it("gets page number",function(){expect(c.pageNumber).toEqual(1)}),it("gets rotate",function(){expect(c.rotate).toEqual(0)}),it("gets ref",function(){expect(c.ref).toEqual({num:15,gen:0})}),it("gets userUnit",function(){expect(c.userUnit).toEqual(1)}),it("gets view",function(){expect(c.view).toEqual([0,0,595.28,841.89])}),it("gets view, with empty/invalid bounding boxes",function(a){var i=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("boundingBox_invalid.pdf"));i.promise.then(function(t){var e=t.numPages;expect(e).toEqual(3);for(var n=[],o=0;o<e;o++)n[o]=t.getPage(o+1).then(function(t){return t.view});Promise.all(n).then(function(t){var e=_slicedToArray(t,3),n=e[0],o=e[1],r=e[2];expect(n).toEqual([0,0,612,792]),expect(o).toEqual([0,0,800,600]),expect(r).toEqual([0,0,600,800]),i.destroy().then(a)})}).catch(a.fail)}),it("gets viewport",function(){var t=c.getViewport({scale:1.5,rotation:90});expect(t.viewBox).toEqual(c.view),expect(t.scale).toEqual(1.5),expect(t.rotation).toEqual(90),expect(t.transform).toEqual([0,1.5,1.5,0,0,0]),expect(t.width).toEqual(1262.835),expect(t.height).toEqual(892.92)}),it('gets viewport with "offsetX/offsetY" arguments',function(){var t=c.getViewport({scale:1,rotation:0,offsetX:100,offsetY:-100});expect(t.transform).toEqual([1,0,0,-1,100,741.89])}),it('gets viewport respecting "dontFlip" argument',function(){var t=c.getViewport({scale:1,rotation:0}),e=c.getViewport({scale:1,rotation:0,dontFlip:!0});expect(e).not.toEqual(t),expect(e).toEqual(t.clone({dontFlip:!0})),expect(t.transform).toEqual([1,0,0,-1,0,841.89]),expect(e.transform).toEqual([1,0,-0,1,0,0])}),it("gets viewport with invalid rotation",function(){expect(function(){c.getViewport({scale:1,rotation:45})}).toThrow(new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees."))}),it("gets annotations",function(t){var e=c.getAnnotations().then(function(t){expect(t.length).toEqual(4)}),n=c.getAnnotations({intent:"display"}).then(function(t){expect(t.length).toEqual(4)}),o=c.getAnnotations({intent:"print"}).then(function(t){expect(t.length).toEqual(4)});Promise.all([e,n,o]).then(function(){t()}).catch(t.fail)}),it("gets annotations containing relative URLs (bug 766086)",function(r){var t="bug766086.pdf",a=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(t)),e=a.promise.then(function(t){return t.getPage(1).then(function(t){return t.getAnnotations()})}),i=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(t,{docBaseUrl:"http://www.example.com/test/pdfs/qwerty.pdf"})),n=i.promise.then(function(t){return t.getPage(1).then(function(t){return t.getAnnotations()})}),c=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(t,{docBaseUrl:"qwerty.pdf"})),o=c.promise.then(function(t){return t.getPage(1).then(function(t){return t.getAnnotations()})});Promise.all([e,n,o]).then(function(t){var e=t[0],n=t[1],o=t[2];expect(e[0].url).toBeUndefined(),expect(e[0].unsafeUrl).toEqual("../../0021/002156/215675E.pdf#15"),expect(n[0].url).toEqual("http://www.example.com/0021/002156/215675E.pdf#15"),expect(n[0].unsafeUrl).toEqual("../../0021/002156/215675E.pdf#15"),expect(o[0].url).toBeUndefined(),expect(o[0].unsafeUrl).toEqual("../../0021/002156/215675E.pdf#15"),Promise.all([a.destroy(),i.destroy(),c.destroy()]).then(r)}).catch(r.fail)}),it("gets text content",function(e){var t=[c.getTextContent(),c.getTextContent({normalizeWhitespace:!0,disableCombineTextItems:!0})];Promise.all(t).then(function(t){expect(!!t[0].items).toEqual(!0),expect(t[0].items.length).toEqual(7),expect(!!t[0].styles).toEqual(!0),expect(JSON.stringify(t[0])).toEqual(JSON.stringify(t[1])),e()}).catch(e.fail)}),it("gets text content, with correct properties (issue 8276)",function(o){var r=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue8276_reduced.pdf"));r.promise.then(function(t){t.getPage(1).then(function(t){t.getTextContent().then(function(t){var e=t.items,n=t.styles;expect(e.length).toEqual(1),expect(Object.keys(n)).toEqual(["Times"]),expect(e[0]).toEqual({dir:"ltr",fontName:"Times",height:18,str:"Issue 8276",transform:[18,0,0,18,441.81,708.4499999999999],width:77.49}),expect(n.Times).toEqual({fontFamily:"serif",ascent:NaN,descent:NaN,vertical:!1}),r.destroy().then(o)})})}).catch(o.fail)}),it("gets operator list",function(e){c.getOperatorList().then(function(t){expect(!!t.fnArray).toEqual(!0),expect(!!t.argsArray).toEqual(!0),expect(t.lastChunk).toEqual(!0),e()}).catch(e.fail)}),it("gets operatorList with JPEG image (issue 4888)",function(a){var i=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("cmykjpeg.pdf"));i.promise.then(function(t){t.getPage(1).then(function(r){r.getOperatorList().then(function(t){var e=t.fnArray.indexOf(_util.OPS.paintImageXObject),n=t.argsArray[e],o=r.objs.get(n[0]).data;expect(o instanceof Uint8ClampedArray).toEqual(!0),expect(o.length).toEqual(9e4),i.destroy().then(a)})})}).catch(a.fail)}),it("gets operatorList, from corrupt PDF file (issue 8702), with/without `stopAtErrors` set",function(t){var e=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue8702.pdf",{stopAtErrors:!1})),n=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue8702.pdf",{stopAtErrors:!0})),o=e.promise.then(function(t){return t.getPage(1).then(function(t){return t.getOperatorList().then(function(t){return expect(t.fnArray.length).toBeGreaterThan(100),expect(t.argsArray.length).toBeGreaterThan(100),expect(t.lastChunk).toEqual(!0),e.destroy()})})}),r=n.promise.then(function(t){return t.getPage(1).then(function(t){return t.getOperatorList().then(function(t){return expect(t.fnArray.length).toEqual(0),expect(t.argsArray.length).toEqual(0),expect(t.lastChunk).toEqual(!0),n.destroy()})})});Promise.all([o,r]).then(t,t.fail)}),it("gets document stats after parsing page",function(e){var t=c.getOperatorList().then(function(){return i.getStats()}),n={};n[_util.StreamType.FLATE]=!0;var o={};o[_util.FontType.TYPE1]=!0,o[_util.FontType.CIDFONTTYPE2]=!0,t.then(function(t){expect(t).toEqual({streamTypes:n,fontTypes:o}),e()}).catch(e.fail)}),it("gets page stats after parsing page, without `pdfBug` set",function(e){c.getOperatorList().then(function(t){return c.stats}).then(function(t){expect(t).toEqual(null),e()},e.fail)}),it("gets page stats after parsing page, with `pdfBug` set",function(n){var o=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(s,{pdfBug:!0}));o.promise.then(function(t){return t.getPage(1).then(function(e){return e.getOperatorList().then(function(t){return e.stats})})}).then(function(t){expect(t instanceof _display_utils.StatTimer).toEqual(!0),expect(t.times.length).toEqual(1);var e=_slicedToArray(t.times,1)[0];expect(e.name).toEqual("Page Request"),expect(e.end-e.start).toBeGreaterThanOrEqual(0),o.destroy().then(n)},n.fail)}),it("gets page stats after rendering page, with `pdfBug` set",function(a){var i,c=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(s,{pdfBug:!0}));c.promise.then(function(t){return t.getPage(1).then(function(t){var e=t.getViewport({scale:1});return i=l.create(e.width,e.height),t.render({canvasContext:i.context,canvasFactory:l,viewport:e}).promise.then(function(){return t.stats})})}).then(function(t){expect(t instanceof _display_utils.StatTimer).toEqual(!0),expect(t.times.length).toEqual(3);var e=_slicedToArray(t.times,3),n=e[0],o=e[1],r=e[2];expect(n.name).toEqual("Page Request"),expect(n.end-n.start).toBeGreaterThanOrEqual(0),expect(o.name).toEqual("Rendering"),expect(o.end-o.start).toBeGreaterThan(0),expect(r.name).toEqual("Overall"),expect(r.end-r.start).toBeGreaterThan(0),l.destroy(i),c.destroy().then(a)},a.fail)}),it("cancels rendering of page",function(e){var t=c.getViewport({scale:1}),n=l.create(t.width,t.height),o=c.render({canvasContext:n.context,canvasFactory:l,viewport:t});o.cancel(),o.promise.then(function(){e.fail("shall cancel rendering")}).catch(function(t){expect(t instanceof _display_utils.RenderingCancelledException).toEqual(!0),expect(t.message).toEqual("Rendering cancelled, page 1"),expect(t.type).toEqual("canvas"),l.destroy(n),e()})}),it("re-render page, using the same canvas, after cancelling rendering",function(t){var e=c.getViewport({scale:1}),n=l.create(e.width,e.height),o=c.render({canvasContext:n.context,canvasFactory:l,viewport:e});o.cancel(),o.promise.then(function(){throw new Error("shall cancel rendering")},function(t){expect(t instanceof _display_utils.RenderingCancelledException).toEqual(!0)}).then(function(){return c.render({canvasContext:n.context,canvasFactory:l,viewport:e}).promise}).then(function(){l.destroy(n),t()},t.fail)}),it("multiple render() on the same canvas",function(t){var e=i.getOptionalContentConfig(),n=c.getViewport({scale:1}),o=l.create(n.width,n.height),r=c.render({canvasContext:o.context,canvasFactory:l,viewport:n,optionalContentConfigPromise:e}),a=c.render({canvasContext:o.context,canvasFactory:l,viewport:n,optionalContentConfigPromise:e});Promise.all([r.promise,a.promise.then(function(){t.fail("shall fail rendering")},function(t){expect(/multiple render\(\)/.test(t.message)).toEqual(!0)})]).then(t)}),it("cleans up document resources after rendering of page",_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n,o,r,a,i;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(s)),t.next=3,e.promise;case 3:return n=t.sent,t.next=6,n.getPage(1);case 6:return o=t.sent,r=o.getViewport({scale:1}),a=l.create(r.width,r.height),i=o.render({canvasContext:a.context,canvasFactory:l,viewport:r}),t.next=12,i.promise;case 12:return t.next=14,n.cleanup();case 14:return expect(!0).toEqual(!0),l.destroy(a),t.next=18,e.destroy();case 18:case"end":return t.stop()}},t)}))),it("cleans up document resources during rendering of page",_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n,o,r,a,i;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf")),t.next=3,e.promise;case 3:return n=t.sent,t.next=6,n.getPage(1);case 6:return o=t.sent,r=o.getViewport({scale:1}),a=l.create(r.width,r.height),(i=o.render({canvasContext:a.context,canvasFactory:l,viewport:r})).onContinue=function(t){u(t)},t.prev=11,t.next=14,n.cleanup();case 14:throw new Error("shall fail cleanup");case 17:t.prev=17,t.t0=t.catch(11),expect(t.t0 instanceof Error).toEqual(!0),expect(t.t0.message).toEqual("startCleanup: Page 1 is currently rendering.");case 21:return t.next=23,i.promise;case 23:return l.destroy(a),t.next=26,e.destroy();case 26:case"end":return t.stop()}},t,null,[[11,17]])}))),it("caches image resources at the document/page level as expected (issue 11878)",_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n,o,r,a,i,c,s,u,l,p,f,d,h,g,m,x;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=_image_utils.GlobalImageCache.NUM_PAGES_THRESHOLD,n=2550,o=3300,r=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("issue11878.pdf")),t.next=4,r.promise;case 4:a=t.sent,i=null,c=1;case 7:if(c<=a.numPages)return t.next=10,a.getPage(c);t.next=24;break;case 10:return s=t.sent,t.next=13,s.getOperatorList();case 13:u=t.sent,l=s.commonObjs,p=s.objs,f=u.fnArray.indexOf(_util.OPS.paintImageXObject),d=_slicedToArray(u.argsArray[f],3),h=d[0],g=d[1],m=d[2],c<e?(expect(h).toEqual("img_p".concat(c-1,"_1")),expect(p.has(h)).toEqual(!0),expect(l.has(h)).toEqual(!1)):(expect(h).toEqual("g_".concat(r.docId,"_img_p").concat(e-1,"_1")),expect(p.has(h)).toEqual(!1),expect(l.has(h)).toEqual(!0)),expect(g).toEqual(n),expect(m).toEqual(o),1===c?(i=p.get(h),expect(i.width).toEqual(n),expect(i.height).toEqual(o),expect(i.kind).toEqual(_util.ImageKind.RGB_24BPP),expect(i.data instanceof Uint8ClampedArray).toEqual(!0),expect(i.data.length).toEqual(25245e3)):(x=(e<=c?l:p).get(h),expect(x.width).toEqual(i.width),expect(x.height).toEqual(i.height),expect(x.kind).toEqual(i.kind),expect(x.data instanceof Uint8ClampedArray).toEqual(!0),expect(x.data.every(function(t,e){return t===i.data[e]})).toEqual(!0));case 21:c++,t.next=7;break;case 24:return t.next=26,r.destroy();case 26:i=null;case 27:case"end":return t.stop()}},t)})))}),describe("Multiple `getDocument` instances",function(){var r=(0,_test_utils.buildGetDocumentParams)("tracemonkey.pdf"),a=(0,_test_utils.buildGetDocumentParams)("TAMReview.pdf"),i=(0,_test_utils.buildGetDocumentParams)("issue6068.pdf"),u=[];function c(t){return e.apply(this,arguments)}function e(){return(e=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){var n,o,r,a,i,c,s;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=(0,_api.getDocument)(e),u.push(n),t.next=4,n.promise;case 4:return o=t.sent,t.next=7,o.getPage(1);case 7:return r=t.sent,a=r.getViewport({scale:1.2}),i=l.create(a.width,a.height),c=r.render({canvasContext:i.context,canvasFactory:l,viewport:a}),t.next=13,c.promise;case 13:return s=i.canvas.toDataURL(),l.destroy(i),t.abrupt("return",s);case 16:case"end":return t.stop()}},t)}))).apply(this,arguments)}afterEach(function(t){var e=u.map(function(t){return t.destroy()});Promise.all(e).then(t)}),it("should correctly render PDFs in parallel",function(t){var e,n,o;c(r).then(function(t){return e=t,c(a)}).then(function(t){return n=t,c(i)}).then(function(t){return o=t,Promise.all([c(r),c(a),c(i)])}).then(function(t){return expect(t[0]).toEqual(e),expect(t[1]).toEqual(n),expect(t[2]).toEqual(o),!0}).then(function(){t()}).catch(t.fail)})}),describe("PDFDataRangeTransport",function(){var i;beforeAll(function(t){i=_test_utils.DefaultFileReaderFactory.fetch({path:_test_utils.TEST_PDFS_PATH+"tracemonkey.pdf"}),t()}),afterAll(function(){i=null}),it("should fetch document info and page using ranges",function(e){var r,a=0;i.then(function(n){var t=n.subarray(0,4e3),o=new _api.PDFDataRangeTransport(n.length,t);return o.requestDataRange=function(t,e){a++,u(function(){o.onDataProgress(4e3),o.onDataRange(t,n.subarray(t,e))})},(r=(0,_api.getDocument)(o)).promise}).then(function(t){return expect(t.numPages).toEqual(14),t.getPage(10)}).then(function(t){expect(t.rotate).toEqual(0),expect(a).toBeGreaterThan(2),r.destroy().then(e)}).catch(e.fail)}),it("should fetch document info and page using range and streaming",function(e){var r,a=0;i.then(function(n){var t=n.subarray(0,4e3),o=new _api.PDFDataRangeTransport(n.length,t);return o.requestDataRange=function(t,e){1===++a&&o.onDataProgressiveRead(n.subarray(4e3)),u(function(){o.onDataRange(t,n.subarray(t,e))})},(r=(0,_api.getDocument)(o)).promise}).then(function(t){return expect(t.numPages).toEqual(14),t.getPage(10)}).then(function(t){expect(t.rotate).toEqual(0),expect(a).toEqual(1),u(function(){r.destroy().then(e)})}).catch(e.fail)}),it("should fetch document info and page, without range, using complete initialData",function(e){var n,o=0;i.then(function(t){var e=new _api.PDFDataRangeTransport(t.length,t,!0);return e.requestDataRange=function(t,e){o++},(n=(0,_api.getDocument)({disableRange:!0,range:e})).promise}).then(function(t){return expect(t.numPages).toEqual(14),t.getPage(10)}).then(function(t){expect(t.rotate).toEqual(0),expect(o).toEqual(0),n.destroy().then(e)}).catch(e.fail)})})});