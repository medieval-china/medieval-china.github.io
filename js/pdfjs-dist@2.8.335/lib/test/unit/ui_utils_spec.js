"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,r,a,u=[],l=!0,s=!1;try{if(r=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=r.call(i)).done)&&(u.push(n.value),u.length!==e);l=!0);}catch(t){s=!0,o=t}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(s)throw o}}return u}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,u=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return a=t.done,t},e:function(t){u=!0,r=t},f:function(){try{a||null==i.return||i.return()}finally{if(u)throw r}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}var _ui_utils=require("../../web/ui_utils.js"),_is_node=require("../../shared/is_node.js");describe("ui_utils",function(){describe("binary search",function(){function t(t){return t}function e(t){return 3<t}it("empty array",function(){expect((0,_ui_utils.binarySearchFirstItem)([],t)).toEqual(0)}),it("single boolean entry",function(){expect((0,_ui_utils.binarySearchFirstItem)([!1],t)).toEqual(1),expect((0,_ui_utils.binarySearchFirstItem)([!0],t)).toEqual(0)}),it("three boolean entries",function(){expect((0,_ui_utils.binarySearchFirstItem)([!0,!0,!0],t)).toEqual(0),expect((0,_ui_utils.binarySearchFirstItem)([!1,!0,!0],t)).toEqual(1),expect((0,_ui_utils.binarySearchFirstItem)([!1,!1,!0],t)).toEqual(2),expect((0,_ui_utils.binarySearchFirstItem)([!1,!1,!1],t)).toEqual(3)}),it("three numeric entries",function(){expect((0,_ui_utils.binarySearchFirstItem)([0,1,2],e)).toEqual(3),expect((0,_ui_utils.binarySearchFirstItem)([2,3,4],e)).toEqual(2),expect((0,_ui_utils.binarySearchFirstItem)([4,5,6],e)).toEqual(0)})}),describe("EventBus",function(){it("dispatch event",function(){var t=new _ui_utils.EventBus,e=0;t.on("test",function(t){expect(t).toEqual(void 0),e++}),t.dispatch("test"),expect(e).toEqual(1)}),it("dispatch event with arguments",function(){var t=new _ui_utils.EventBus,e=0;t.on("test",function(t){expect(t).toEqual({abc:123}),e++}),t.dispatch("test",{abc:123}),expect(e).toEqual(1)}),it("dispatch different event",function(){var t=new _ui_utils.EventBus,e=0;t.on("test",function(){e++}),t.dispatch("nottest"),expect(e).toEqual(0)}),it("dispatch event multiple times",function(){var t=new _ui_utils.EventBus,e=0;t.dispatch("test"),t.on("test",function(){e++}),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(2)}),it("dispatch event to multiple handlers",function(){var t=new _ui_utils.EventBus,e=0;t.on("test",function(){e++}),t.on("test",function(){e++}),t.dispatch("test"),expect(e).toEqual(2)}),it("dispatch to detached",function(){var t=new _ui_utils.EventBus,e=0,i=function(){e++};t.on("test",i),t.dispatch("test"),t.off("test",i),t.dispatch("test"),expect(e).toEqual(1)}),it("dispatch to wrong detached",function(){var t=new _ui_utils.EventBus,e=0;t.on("test",function(){e++}),t.dispatch("test"),t.off("test",function(){e++}),t.dispatch("test"),expect(e).toEqual(2)}),it("dispatch to detached during handling",function(){var t=new _ui_utils.EventBus,e=0,i=function(){t.off("test",n),e++},n=function(){t.off("test",i),e++};t.on("test",i),t.on("test",n),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(2)}),it("dispatch event to handlers with/without 'once' option",function(){var t=new _ui_utils.EventBus,e=0,i=0;t.on("test",function(){e++}),t.on("test",function(){i++},{once:!0}),t.dispatch("test"),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(3),expect(i).toEqual(1)}),it("should not re-dispatch to DOM",function(t){_is_node.isNodeJS&&pending("Document in not supported in Node.js.");var e=new _ui_utils.EventBus,i=0;function n(){t.fail("shall not dispatch DOM event.")}e.on("test",function(t){expect(t).toEqual(void 0),i++}),document.addEventListener("test",n),e.dispatch("test"),Promise.resolve().then(function(){expect(i).toEqual(1),document.removeEventListener("test",n),t()})})}),describe("isValidRotation",function(){it("should reject non-integer angles",function(){expect((0,_ui_utils.isValidRotation)()).toEqual(!1),expect((0,_ui_utils.isValidRotation)(null)).toEqual(!1),expect((0,_ui_utils.isValidRotation)(NaN)).toEqual(!1),expect((0,_ui_utils.isValidRotation)([90])).toEqual(!1),expect((0,_ui_utils.isValidRotation)("90")).toEqual(!1),expect((0,_ui_utils.isValidRotation)(90.5)).toEqual(!1)}),it("should reject non-multiple of 90 degree angles",function(){expect((0,_ui_utils.isValidRotation)(45)).toEqual(!1),expect((0,_ui_utils.isValidRotation)(-123)).toEqual(!1)}),it("should accept valid angles",function(){expect((0,_ui_utils.isValidRotation)(0)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(90)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(-270)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(540)).toEqual(!0)})}),describe("isPortraitOrientation",function(){it("should be portrait orientation",function(){expect((0,_ui_utils.isPortraitOrientation)({width:200,height:400})).toEqual(!0),expect((0,_ui_utils.isPortraitOrientation)({width:500,height:500})).toEqual(!0)}),it("should be landscape orientation",function(){expect((0,_ui_utils.isPortraitOrientation)({width:600,height:300})).toEqual(!1)})}),describe("waitOnEventOrTimeout",function(){var o;beforeAll(function(t){o=new _ui_utils.EventBus,t()}),afterAll(function(){o=null}),it("should reject invalid parameters",function(t){var e=(0,_ui_utils.waitOnEventOrTimeout)({target:"window",name:"DOMContentLoaded"}).then(function(){throw new Error("Should reject invalid parameters.")},function(t){expect(t instanceof Error).toEqual(!0)}),i=(0,_ui_utils.waitOnEventOrTimeout)({target:o,name:""}).then(function(){throw new Error("Should reject invalid parameters.")},function(t){expect(t instanceof Error).toEqual(!0)}),n=(0,_ui_utils.waitOnEventOrTimeout)({target:o,name:"pagerendered",delay:-1e3}).then(function(){throw new Error("Should reject invalid parameters.")},function(t){expect(t instanceof Error).toEqual(!0)});Promise.all([e,i,n]).then(t,t.fail)}),it("should resolve on event, using the DOM",function(e){_is_node.isNodeJS&&pending("Document in not supported in Node.js.");var t=document.createElement("button"),i=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"click",delay:1e4});t.click(),i.then(function(t){expect(t).toEqual(_ui_utils.WaitOnType.EVENT),e()},e.fail)}),it("should resolve on timeout, using the DOM",function(e){_is_node.isNodeJS&&pending("Document in not supported in Node.js.");var t=document.createElement("button");(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"click",delay:10}).then(function(t){expect(t).toEqual(_ui_utils.WaitOnType.TIMEOUT),e()},e.fail)}),it("should resolve on event, using the EventBus",function(e){var t=(0,_ui_utils.waitOnEventOrTimeout)({target:o,name:"pagerendered",delay:1e4});o.dispatch("pagerendered"),t.then(function(t){expect(t).toEqual(_ui_utils.WaitOnType.EVENT),e()},e.fail)}),it("should resolve on timeout, using the EventBus",function(e){(0,_ui_utils.waitOnEventOrTimeout)({target:o,name:"pagerendered",delay:10}).then(function(t){expect(t).toEqual(_ui_utils.WaitOnType.TIMEOUT),e()},e.fail)})}),describe("getPageSizeInches",function(){it("gets page size (in inches)",function(){var t=(0,_ui_utils.getPageSizeInches)({view:[0,0,595.28,841.89],userUnit:1,rotate:0}),e=t.width,i=t.height;expect(+e.toPrecision(3)).toEqual(8.27),expect(+i.toPrecision(4)).toEqual(11.69)}),it("gets page size (in inches), for non-default /Rotate entry",function(){var t=(0,_ui_utils.getPageSizeInches)({view:[0,0,612,792],userUnit:1,rotate:0}),e=t.width,i=t.height;expect(e).toEqual(8.5),expect(i).toEqual(11);var n=(0,_ui_utils.getPageSizeInches)({view:[0,0,612,792],userUnit:1,rotate:90}),o=n.width,r=n.height;expect(o).toEqual(11),expect(r).toEqual(8.5)})}),describe("getVisibleElements",function(){function d(t){var e,i=[],n=0,o=0,r=_createForOfIteratorHelper(t);try{for(r.s();!(e=r.n()).done;){var a,u=e.value,l=u.reduce(function(t,e){return Math.max(t,e[1])},0),s=-9,c=_createForOfIteratorHelper(u);try{for(c.s();!(a=c.n()).done;){var f=_slicedToArray(a.value,2),d=f[0],h=f[1],p={offsetLeft:s,offsetTop:n+(l-h)/2-9,clientWidth:d,clientHeight:h,clientLeft:9,clientTop:9};i.push({id:o,div:p}),++o,s+=d+11}}catch(t){c.e(t)}finally{c.f()}n+=l+11}}catch(t){r.e(t)}finally{r.f()}return i}function u(t,e){var i,n=[],o=t.scrollLeft,r=t.scrollTop,a=o+t.clientWidth,u=r+t.clientHeight,l=_createForOfIteratorHelper(e);try{for(l.s();!(i=l.n()).done;){var s=i.value,c=s.div,f=c.offsetLeft+c.clientLeft,d=f+c.clientWidth,h=c.offsetTop+c.clientTop,p=h+c.clientHeight;if(f<a&&o<d&&h<u&&r<p){var _=Math.max(0,r-h)+Math.max(0,p-u),v=Math.max(0,o-f)+Math.max(0,d-a),E=(c.clientHeight-_)/c.clientHeight,m=(c.clientWidth-v)/c.clientWidth,y=E*m*100|0;n.push({id:s.id,x:f,y:h,view:s,percent:y,widthPercent:100*m|0})}}}catch(t){l.e(t)}finally{l.f()}return{first:n[0],last:n[n.length-1],views:n}}function t(t){for(var n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],e=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=t.reduce(function(t,e){var i=e.div;return Math.max(t,n?Math.abs(i.offsetLeft+i.clientLeft+i.clientWidth):i.offsetTop+i.clientTop+i.clientHeight)},0),o=-i;o<i;o+=7)for(var r=o+5;r<i;r+=r-o){var a=n?{scrollTop:0,scrollLeft:o,clientHeight:1e4,clientWidth:r-o}:{scrollTop:o,scrollLeft:0,clientHeight:r-o,clientWidth:1e4};expect((0,_ui_utils.getVisibleElements)({scrollEl:a,views:t,sortByVisibility:!1,horizontal:n,rtl:e})).toEqual(u(a,t))}}it("with pages of varying height",function(){t(d([[[50,20],[20,50]],[[30,12],[12,30]],[[20,50],[50,20]],[[50,20],[20,50]]]))}),it("widescreen challenge",function(){t(d([[[10,50],[10,60],[10,70],[10,80],[10,90]],[[10,90],[10,80],[10,70],[10,60],[10,50]],[[10,50],[10,60],[10,70],[10,80],[10,90]]]))}),it("works with horizontal scrolling",function(){t(d([[[10,50],[20,20],[30,10]]]),!0)}),it("works with horizontal scrolling with RTL-documents",function(){t(d([[[-10,50],[-20,20],[-30,10]]]),!0,!0)}),it("handles `sortByVisibility` correctly",function(){var t,e={scrollTop:75,scrollLeft:0,clientHeight:750,clientWidth:1500},i=d([[[100,150]],[[100,150]],[[100,150]]]),n=(0,_ui_utils.getVisibleElements)({scrollEl:e,views:i}),o=(0,_ui_utils.getVisibleElements)({scrollEl:e,views:i,sortByVisibility:!0}),r=[],a=[],u=_createForOfIteratorHelper(n.views);try{for(u.s();!(t=u.n()).done;){var l=t.value;r.push(l.id)}}catch(t){u.e(t)}finally{u.f()}var s,c=_createForOfIteratorHelper(o.views);try{for(c.s();!(s=c.n()).done;){var f=s.value;a.push(f.id)}}catch(t){c.e(t)}finally{c.f()}expect(r).toEqual([0,1,2]),expect(a).toEqual([1,2,0])}),it("handles views being empty",function(){expect((0,_ui_utils.getVisibleElements)({scrollEl:{scrollTop:10,scrollLeft:0,clientHeight:750,clientWidth:1500},views:[]})).toEqual({first:void 0,last:void 0,views:[]})}),it("handles all views being hidden (without errors)",function(){var t=d([[[100,150]],[[100,150]],[[100,150]]]);expect((0,_ui_utils.getVisibleElements)({scrollEl:{scrollTop:1e5,scrollLeft:0,clientHeight:750,clientWidth:1500},views:t})).toEqual({first:void 0,last:void 0,views:[]})}),describe("backtrackBeforeAllVisibleElements",function(){var e=[10,50],i=[10,10];it("handles case 1",function(){var t=d([[[10,20],[10,20],[10,20],[10,20]],[e,i,e,i],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]],[[10,20]]]);expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(4,t,71)).toEqual(4)}),it("handles case 2",function(){var t=d([[[10,20],[10,20],[10,20],[10,20]],[e,i,e,e],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]);expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(6,t,71)).toEqual(4)}),it("handles case 3",function(){var t=d([[[10,20],[10,20],[10,20],[10,20]],[e,i,e,i],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]);expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(8,t,71)).toEqual(4)}),it("handles case 4",function(){var t=d([[[10,20],[10,20],[10,20],[10,20]],[e,i,e,i],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]);expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(4,t,41)).toEqual(4)})})}),describe("moveToEndOfArray",function(){it("works on empty arrays",function(){var t=[];(0,_ui_utils.moveToEndOfArray)(t,function(){}),expect(t).toEqual([])}),it("works when moving everything",function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,function(){return!0}),expect(t).toEqual([1,2,3,4,5])}),it("works when moving some things",function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,function(t){return t%2==0}),expect(t).toEqual([1,3,5,2,4])}),it("works when moving one thing",function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,function(t){return 1===t}),expect(t).toEqual([2,3,4,5,1])}),it("works when moving nothing",function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,function(t){return 0===t}),expect(t).toEqual([1,2,3,4,5])})})});