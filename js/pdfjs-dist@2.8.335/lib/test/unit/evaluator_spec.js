"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,_toPropertyKey(a.key),a)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);var a=r.call(t,e||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}var _test_utils=require("./test_utils.js"),_primitives=require("../../core/primitives.js"),_util=require("../../shared/util.js"),_stream=require("../../core/stream.js"),_operator_list=require("../../core/operator_list.js"),_evaluator=require("../../core/evaluator.js"),_worker=require("../../core/worker.js");describe("evaluator",function(){function e(){this.inputs=[]}function i(){}function u(t,e,r,a){var n=new _operator_list.OperatorList,o=new _worker.WorkerTask("OperatorListCheck");t.getOperatorList({stream:e,task:o,resources:r,operatorList:n}).then(function(){a(n)},function(t){a(t)})}var l;e.prototype={send:function(t,e){this.inputs.push({name:t,data:e})}},i.prototype={get:function(t){return this[t]}},beforeAll(function(t){l=new _evaluator.PartialEvaluator({xref:new _test_utils.XRefMock,handler:new e,pageIndex:0,idFactory:(0,_test_utils.createIdFactory)(0)}),t()}),afterAll(function(){l=null}),describe("splitCombinedOperations",function(){it("should reject unknown operations",function(e){var t=new _stream.StringStream("fTT");u(l,t,new i,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(1),expect(t.fnArray[0]).toEqual(_util.OPS.fill),expect(t.argsArray[0]).toEqual(null),e()})}),it("should handle one operation",function(e){var t=new _stream.StringStream("Q");u(l,t,new i,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(1),expect(t.fnArray[0]).toEqual(_util.OPS.restore),e()})}),it("should handle two glued operations",function(e){var t=new _primitives.Dict;t.set("Subtype",_primitives.Name.get("Image")),t.set("Width",1),t.set("Height",1);var r=new _stream.Stream([0]);r.dict=t;var a=new _primitives.Dict;a.set("Res1",r);var n=new i;n.XObject=a;var o=new _stream.StringStream("/Res1 DoQ");u(l,o,n,function(t){expect(t.fnArray.length).toEqual(3),expect(t.fnArray[0]).toEqual(_util.OPS.dependency),expect(t.fnArray[1]).toEqual(_util.OPS.paintImageXObject),expect(t.fnArray[2]).toEqual(_util.OPS.restore),expect(t.argsArray.length).toEqual(3),expect(t.argsArray[0]).toEqual(["img_p0_1"]),expect(t.argsArray[1]).toEqual(["img_p0_1",1,1]),expect(t.argsArray[2]).toEqual(null),e()})}),it("should handle three glued operations",function(e){var t=new _stream.StringStream("fff");u(l,t,new i,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(3),expect(t.fnArray[0]).toEqual(_util.OPS.fill),expect(t.fnArray[1]).toEqual(_util.OPS.fill),expect(t.fnArray[2]).toEqual(_util.OPS.fill),e()})}),it("should handle three glued operations #2",function(e){var t=new i;t.Res1={};var r=new _stream.StringStream("B*Bf*");u(l,r,t,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(3),expect(t.fnArray[0]).toEqual(_util.OPS.eoFillStroke),expect(t.fnArray[1]).toEqual(_util.OPS.fillStroke),expect(t.fnArray[2]).toEqual(_util.OPS.eoFill),e()})}),it("should handle glued operations and operands",function(e){var t=new _stream.StringStream("f5 Ts");u(l,t,new i,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(2),expect(t.fnArray[0]).toEqual(_util.OPS.fill),expect(t.fnArray[1]).toEqual(_util.OPS.setTextRise),expect(t.argsArray.length).toEqual(2),expect(t.argsArray[1].length).toEqual(1),expect(t.argsArray[1][0]).toEqual(5),e()})}),it("should handle glued operations and literals",function(e){var t=new _stream.StringStream("trueifalserinulln");u(l,t,new i,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(3),expect(t.fnArray[0]).toEqual(_util.OPS.setFlatness),expect(t.fnArray[1]).toEqual(_util.OPS.setRenderingIntent),expect(t.fnArray[2]).toEqual(_util.OPS.endPath),expect(t.argsArray.length).toEqual(3),expect(t.argsArray[0].length).toEqual(1),expect(t.argsArray[0][0]).toEqual(!0),expect(t.argsArray[1].length).toEqual(1),expect(t.argsArray[1][0]).toEqual(!1),expect(t.argsArray[2]).toEqual(null),e()})})}),describe("validateNumberOfArgs",function(){it("should execute if correct number of arguments",function(e){var t=new _stream.StringStream("5 1 d0");u(l,t,new i,function(t){expect(t.argsArray[0][0]).toEqual(5),expect(t.argsArray[0][1]).toEqual(1),expect(t.fnArray[0]).toEqual(_util.OPS.setCharWidth),e()})}),it("should execute if too many arguments",function(e){var t=new _stream.StringStream("5 1 4 d0");u(l,t,new i,function(t){expect(t.argsArray[0][0]).toEqual(1),expect(t.argsArray[0][1]).toEqual(4),expect(t.fnArray[0]).toEqual(_util.OPS.setCharWidth),e()})}),it("should execute if nested commands",function(e){var t=new _primitives.Dict;t.set("LW",2),t.set("CA",.5);var r=new _primitives.Dict;r.set("GS2",t);var a=new i;a.ExtGState=r;var n=new _stream.StringStream("/F2 /GS2 gs 5.711 Tf");u(l,n,a,function(t){expect(t.fnArray.length).toEqual(3),expect(t.fnArray[0]).toEqual(_util.OPS.setGState),expect(t.fnArray[1]).toEqual(_util.OPS.dependency),expect(t.fnArray[2]).toEqual(_util.OPS.setFont),expect(t.argsArray.length).toEqual(3),expect(t.argsArray[0]).toEqual([[["LW",2],["CA",.5]]]),expect(t.argsArray[1]).toEqual(["g_font_error"]),expect(t.argsArray[2]).toEqual(["g_font_error",5.711]),e()})}),it("should skip if too few arguments",function(e){var t=new _stream.StringStream("5 d0");u(l,t,new i,function(t){expect(t.argsArray).toEqual([]),expect(t.fnArray).toEqual([]),e()})}),it("should error if (many) path operators have too few arguments (bug 1443140)",function(e){var t=new Array(26),r=t.join("10 Td\n"),a=new _stream.StringStream(r);u(l,a,new i,function(t){expect(t.argsArray).toEqual([]),expect(t.fnArray).toEqual([]),e()});var n=t.join("20 l\n"),o=new _stream.StringStream(n);u(l,o,new i,function(t){expect(t instanceof _util.FormatError).toEqual(!0),expect(t.message).toEqual("Invalid command l: expected 2 args, but received 1 args."),e()})}),it("should close opened saves",function(e){var t=new _stream.StringStream("qq");u(l,t,new i,function(t){expect(!!t.fnArray&&!!t.argsArray).toEqual(!0),expect(t.fnArray.length).toEqual(4),expect(t.fnArray[0]).toEqual(_util.OPS.save),expect(t.fnArray[1]).toEqual(_util.OPS.save),expect(t.fnArray[2]).toEqual(_util.OPS.restore),expect(t.fnArray[3]).toEqual(_util.OPS.restore),e()})}),it("should error on paintXObject if name is missing",function(e){var t=new _stream.StringStream("/ Do");u(l,t,new i,function(t){expect(t instanceof _util.FormatError).toEqual(!0),expect(t.message).toEqual("XObject must be referred to by name."),e()})}),it("should skip paintXObject if subtype is PS",function(e){var t=new _primitives.Dict;t.set("Subtype",_primitives.Name.get("PS"));var r=new _stream.Stream([],0,0,t),a=new _primitives.Dict;a.set("Res1",r);var n=new _primitives.Dict;n.set("XObject",a);var o=new _stream.StringStream("/Res1 Do");u(l,o,n,function(t){expect(t.argsArray).toEqual([]),expect(t.fnArray).toEqual([]),e()})})}),describe("thread control",function(){it("should abort operator list parsing",function(t){var e=new _stream.StringStream("qqQQ"),r=new i,a=new _operator_list.OperatorList,n=new _worker.WorkerTask("OperatorListAbort");n.terminate(),l.getOperatorList({stream:e,task:n,resources:r,operatorList:a}).catch(function(){expect(!!a.fnArray&&!!a.argsArray).toEqual(!0),expect(a.fnArray.length).toEqual(0),t()})}),it("should abort text parsing parsing",function(t){var e=new i,r=new _stream.StringStream("qqQQ"),a=new _worker.WorkerTask("TextContentAbort");a.terminate(),l.getTextContent({stream:r,task:a,resources:e}).catch(function(){expect(!0).toEqual(!0),t()})})}),describe("operator list",function(){var e=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"enqueue",value:function(){}}]),t}();it("should get correct total length after flushing",function(){var t=new _operator_list.OperatorList(null,new e);t.addOp(_util.OPS.save,null),t.addOp(_util.OPS.restore,null),expect(t.totalLength).toEqual(2),expect(t.length).toEqual(2),t.flush(),expect(t.totalLength).toEqual(2),expect(t.length).toEqual(0)})})});