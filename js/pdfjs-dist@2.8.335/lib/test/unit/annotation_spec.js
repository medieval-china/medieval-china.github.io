"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,a,o,r,s=[],l=!0,c=!1;try{if(o=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=o.call(n)).done)&&(s.push(i.value),s.length!==e);l=!0);}catch(t){c=!0,a=t}finally{try{if(!l&&null!=n.return&&(r=n.return(),Object(r)!==r))return}finally{if(c)throw a}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _regeneratorRuntime(){_regeneratorRuntime=function(){return r};var r={},t=Object.prototype,u=t.hasOwnProperty,p=Object.defineProperty||function(t,e,n){t[e]=n.value},e="function"==typeof Symbol?Symbol:{},a=e.iterator||"@@iterator",n=e.asyncIterator||"@@asyncIterator",i=e.toStringTag||"@@toStringTag";function o(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{o({},"")}catch(t){o=function(t,e,n){return t[e]=n}}function s(t,e,n,i){var o,r,s,l,a=e&&e.prototype instanceof v?e:v,c=Object.create(a.prototype),u=new E(i||[]);return p(c,"_invoke",{value:(o=t,r=n,s=u,l="suspendedStart",function(t,e){if("executing"===l)throw new Error("Generator is already running");if("completed"===l){if("throw"===t)throw e;return q()}for(s.method=t,s.arg=e;;){var n=s.delegate;if(n){var i=x(n,s);if(i){if(i===d)continue;return i}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===l)throw l="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);l="executing";var a=f(o,r,s);if("normal"===a.type){if(l=s.done?"completed":"suspendedYield",a.arg===d)continue;return{value:a.arg,done:s.done}}"throw"===a.type&&(l="completed",s.method="throw",s.arg=a.arg)}})}),c}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}r.wrap=s;var d={};function v(){}function l(){}function c(){}var _={};o(_,a,function(){return this});var m=Object.getPrototypeOf,y=m&&m(m(R([])));y&&y!==t&&u.call(y,a)&&(_=y);var g=c.prototype=v.prototype=Object.create(_);function h(t){["next","throw","return"].forEach(function(e){o(t,e,function(t){return this._invoke(e,t)})})}function w(l,c){var e;p(this,"_invoke",{value:function(n,i){function t(){return new c(function(t,e){!function e(t,n,i,a){var o=f(l[t],l,n);if("throw"!==o.type){var r=o.arg,s=r.value;return s&&"object"==_typeof(s)&&u.call(s,"__await")?c.resolve(s.__await).then(function(t){e("next",t,i,a)},function(t){e("throw",t,i,a)}):c.resolve(s).then(function(t){r.value=t,i(r)},function(t){return e("throw",t,i,a)})}a(o.arg)}(n,i,t,e)})}return e=e?e.then(t,t):t()}})}function x(t,e){var n=e.method,i=t.iterator[n];if(void 0===i)return e.delegate=null,"throw"===n&&t.iterator.return&&(e.method="return",e.arg=void 0,x(t,e),"throw"===e.method)||"return"!==n&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+n+"' method")),d;var a=f(i,t.iterator,e.arg);if("throw"===a.type)return e.method="throw",e.arg=a.arg,e.delegate=null,d;var o=a.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,d):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,d)}function T(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function A(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(T,this),this.reset(!0)}function R(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(u.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:q}}function q(){return{value:void 0,done:!0}}return p(g,"constructor",{value:l.prototype=c,configurable:!0}),p(c,"constructor",{value:l,configurable:!0}),l.displayName=o(c,i,"GeneratorFunction"),r.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===l||"GeneratorFunction"===(e.displayName||e.name))},r.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,o(t,i,"GeneratorFunction")),t.prototype=Object.create(g),t},r.awrap=function(t){return{__await:t}},h(w.prototype),o(w.prototype,n,function(){return this}),r.AsyncIterator=w,r.async=function(t,e,n,i,a){void 0===a&&(a=Promise);var o=new w(s(t,e,n,i),a);return r.isGeneratorFunction(e)?o:o.next().then(function(t){return t.done?t.value:o.next()})},h(g),o(g,i,"Generator"),o(g,a,function(){return this}),o(g,"toString",function(){return"[object Generator]"}),r.keys=function(t){var n=Object(t),i=[];for(var e in n)i.push(e);return i.reverse(),function t(){for(;i.length;){var e=i.pop();if(e in n)return t.value=e,t.done=!1,t}return t.done=!0,t}},r.values=R,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(A),!t)for(var e in this)"t"===e.charAt(0)&&u.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var i=this;function t(t,e){return o.type="throw",o.arg=n,i.next=t,e&&(i.method="next",i.arg=void 0),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var a=this.tryEntries[e],o=a.completion;if("root"===a.tryLoc)return t("end");if(a.tryLoc<=this.prev){var r=u.call(a,"catchLoc"),s=u.call(a,"finallyLoc");if(r&&s){if(this.prev<a.catchLoc)return t(a.catchLoc,!0);if(this.prev<a.finallyLoc)return t(a.finallyLoc)}else if(r){if(this.prev<a.catchLoc)return t(a.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return t(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;0<=n;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&u.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=t,o.arg=e,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),A(n),d}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var i=n.completion;if("throw"===i.type){var a=i.arg;A(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:R(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},r}function asyncGeneratorStep(t,e,n,i,a,o,r){try{var s=t[o](r),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,a)}function _asyncToGenerator(s){return function(){var t=this,r=arguments;return new Promise(function(e,n){var i=s.apply(t,r);function a(t){asyncGeneratorStep(i,e,n,a,o,"next",t)}function o(t){asyncGeneratorStep(i,e,n,a,o,"throw",t)}a(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0===n)return("string"===e?String:Number)(t);var i=n.call(t,e||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var _annotation=require("../../core/annotation.js"),_util=require("../../shared/util.js"),_test_utils=require("./test_utils.js"),_primitives=require("../../core/primitives.js"),_parser=require("../../core/parser.js"),_api=require("../../display/api.js"),_evaluator=require("../../core/evaluator.js"),_stream=require("../../core/stream.js"),_worker=require("../../core/worker.js");describe("annotation",function(){var h,w,x,s=function(){function e(t){_classCallCheck(this,e),this.docBaseUrl=t.docBaseUrl||null,this.pdfDocument={catalog:{acroForm:new _primitives.Dict}}}return _createClass(e,[{key:"ensure",value:function(n,i,a){return new Promise(function(t){var e=n[i];t("function"==typeof e?e.apply(n,a):e)})}},{key:"ensureCatalog",value:function(t,e){return this.ensure(this.pdfDocument.catalog,t,e)}},{key:"ensureDoc",value:function(t,e){return this.ensure(this.pdfDocument,t,e)}}]),e}();function i(){this.inputs=[]}i.prototype={send:function(t,e){this.inputs.push({name:t,data:e})}},beforeAll(_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return h=new s({docBaseUrl:null}),e=new _api.DefaultCMapReaderFactory({baseUrl:_test_utils.CMAP_PARAMS.cMapUrl,isCompressed:_test_utils.CMAP_PARAMS.cMapPacked}),n=new Map,t.t0=n,t.next=6,e.fetch({name:"UniJIS-UTF16-H"});case 6:return t.t1=t.sent,t.t0.set.call(t.t0,"UniJIS-UTF16-H",t.t1),t.t2=n,t.next=11,e.fetch({name:"Adobe-Japan1-UCS2"});case 11:t.t3=t.sent,t.t2.set.call(t.t2,"Adobe-Japan1-UCS2",t.t3),w=(0,_test_utils.createIdFactory)(0),x=new _evaluator.PartialEvaluator({xref:new _test_utils.XRefMock,handler:new i,pageIndex:0,idFactory:(0,_test_utils.createIdFactory)(0),fontCache:new _primitives.RefSetCache,builtInCMapCache:n});case 15:case"end":return t.stop()}},t)}))),afterAll(function(){x=w=h=null}),describe("AnnotationFactory",function(){it("should get id for annotation",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Link"));var e=_primitives.Ref.get(10,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.id).toEqual("10R"),n()},n.fail)}),it("should handle, and get fallback IDs for, annotations that are not indirect objects (issue 7569)",function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link"));var n=new _test_utils.XRefMock,i=(0,_test_utils.createIdFactory)(0),a=_annotation.AnnotationFactory.create(n,e,h,i).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.id).toEqual("annot_p0_1")}),o=_annotation.AnnotationFactory.create(n,e,h,i).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.id).toEqual("annot_p0_2")});Promise.all([a,o]).then(t,t.fail)}),it("should handle missing /Subtype",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot"));var e=_primitives.Ref.get(1,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toBeUndefined(),n()},n.fail)})}),describe("getQuadPoints",function(){var i,a;beforeEach(function(t){i=new _primitives.Dict,a=[],t()}),afterEach(function(){a=i=null}),it("should ignore missing quadpoints",function(){expect((0,_annotation.getQuadPoints)(i,a)).toEqual(null)}),it("should ignore non-array values",function(){i.set("QuadPoints","foo"),expect((0,_annotation.getQuadPoints)(i,a)).toEqual(null)}),it("should ignore arrays where the length is not a multiple of eight",function(){i.set("QuadPoints",[1,2,3,4,5,6,7,8,9,10]),expect((0,_annotation.getQuadPoints)(i,a)).toEqual(null)}),it("should ignore quadpoints if one coordinate lies outside the rectangle",function(){a=[10,10,20,20];for(var t=0,e=[[11,11,12,12,9,13,14,14],[11,11,12,12,13,9,14,14],[11,11,12,12,21,13,14,14],[11,11,12,12,13,21,14,14]];t<e.length;t++){var n=e[t];i.set("QuadPoints",n),expect((0,_annotation.getQuadPoints)(i,a)).toEqual(null)}}),it("should process quadpoints in the standard order",function(){a=[10,10,20,20],i.set("QuadPoints",[10,20,20,20,10,10,20,10,11,19,19,19,11,11,19,11]),expect((0,_annotation.getQuadPoints)(i,a)).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}],[{x:11,y:19},{x:19,y:19},{x:11,y:11},{x:19,y:11}]])}),it("should normalize and process quadpoints in non-standard orders",function(){a=[10,10,20,20];for(var t=0,e=[[10,20,20,20,20,10,10,10],[10,10,20,10,10,20,20,20],[10,10,20,10,20,20,10,20]];t<e.length;t++){var n=e[t];i.set("QuadPoints",n),expect((0,_annotation.getQuadPoints)(i,a)).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}]])}})}),describe("Annotation",function(){var e,n;beforeAll(function(t){e=new _primitives.Dict,n=_primitives.Ref.get(1,0),t()}),afterAll(function(){e=n=null}),it("should set and get valid contents",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setContents("Foo bar baz"),expect(t.contents).toEqual("Foo bar baz")}),it("should not set and get invalid contents",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setContents(void 0),expect(t.contents).toEqual("")}),it("should set and get a valid modification date",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setModificationDate("D:20190422"),expect(t.modificationDate).toEqual("D:20190422")}),it("should not set and get an invalid modification date",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setModificationDate(void 0),expect(t.modificationDate).toEqual(null)}),it("should set and get flags",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setFlags(13),expect(t.hasFlag(_util.AnnotationFlag.INVISIBLE)).toEqual(!0),expect(t.hasFlag(_util.AnnotationFlag.NOZOOM)).toEqual(!0),expect(t.hasFlag(_util.AnnotationFlag.PRINT)).toEqual(!0),expect(t.hasFlag(_util.AnnotationFlag.READONLY)).toEqual(!1),expect(t.hasFlag(_util.AnnotationFlag.HIDDEN)).toEqual(!1)}),it("should be viewable and not printable by default",function(){var t=new _annotation.Annotation({dict:e,ref:n});expect(t.viewable).toEqual(!0),expect(t.printable).toEqual(!1)}),it("should set and get a valid rectangle",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setRectangle([117,694,164.298,720]),expect(t.rectangle).toEqual([117,694,164.298,720])}),it("should not set and get an invalid rectangle",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setRectangle([117,694,164.298]),expect(t.rectangle).toEqual([0,0,0,0])}),it("should reject a color if it is not an array",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setColor("red"),expect(t.color).toEqual(new Uint8ClampedArray([0,0,0]))}),it("should set and get a transparent color",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setColor([]),expect(t.color).toEqual(null)}),it("should set and get a grayscale color",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setColor([.4]),expect(t.color).toEqual(new Uint8ClampedArray([102,102,102]))}),it("should set and get an RGB color",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setColor([0,0,1]),expect(t.color).toEqual(new Uint8ClampedArray([0,0,255]))}),it("should set and get a CMYK color",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setColor([.1,.92,.84,.02]),expect(t.color).toEqual(new Uint8ClampedArray([234,59,48]))}),it("should not set and get an invalid color",function(){var t=new _annotation.Annotation({dict:e,ref:n});t.setColor([.4,.6]),expect(t.color).toEqual(new Uint8ClampedArray([0,0,0]))})}),describe("AnnotationBorderStyle",function(){it("should set and get a valid width",function(){var t=new _annotation.AnnotationBorderStyle;t.setWidth(3),expect(t.width).toEqual(3)}),it("should not set and get an invalid width",function(){var t=new _annotation.AnnotationBorderStyle;t.setWidth("three"),expect(t.width).toEqual(1)}),it("should set the width to zero, when the input is a `Name` (issue 10385)",function(){var t=new _annotation.AnnotationBorderStyle;t.setWidth(_primitives.Name.get("0"));var e=new _annotation.AnnotationBorderStyle;e.setWidth(_primitives.Name.get("5")),expect(t.width).toEqual(0),expect(e.width).toEqual(0)}),it("should set and get a valid style",function(){var t=new _annotation.AnnotationBorderStyle;t.setStyle(_primitives.Name.get("D")),expect(t.style).toEqual(_util.AnnotationBorderStyleType.DASHED)}),it("should not set and get an invalid style",function(){var t=new _annotation.AnnotationBorderStyle;t.setStyle("Dashed"),expect(t.style).toEqual(_util.AnnotationBorderStyleType.SOLID)}),it("should set and get a valid dash array",function(){var t=new _annotation.AnnotationBorderStyle;t.setDashArray([1,2,3]),expect(t.dashArray).toEqual([1,2,3])}),it("should not set and get an invalid dash array",function(){var t=new _annotation.AnnotationBorderStyle;t.setDashArray([0,0]),expect(t.dashArray).toEqual([3])}),it("should set and get a valid horizontal corner radius",function(){var t=new _annotation.AnnotationBorderStyle;t.setHorizontalCornerRadius(3),expect(t.horizontalCornerRadius).toEqual(3)}),it("should not set and get an invalid horizontal corner radius",function(){var t=new _annotation.AnnotationBorderStyle;t.setHorizontalCornerRadius("three"),expect(t.horizontalCornerRadius).toEqual(0)}),it("should set and get a valid vertical corner radius",function(){var t=new _annotation.AnnotationBorderStyle;t.setVerticalCornerRadius(3),expect(t.verticalCornerRadius).toEqual(3)}),it("should not set and get an invalid vertical corner radius",function(){var t=new _annotation.AnnotationBorderStyle;t.setVerticalCornerRadius("three"),expect(t.verticalCornerRadius).toEqual(0)})}),describe("MarkupAnnotation",function(){var e,i;beforeAll(function(t){e=new _primitives.Dict,i=_primitives.Ref.get(1,0),t()}),afterAll(function(){e=i=null}),it("should set and get a valid creation date",function(){var t=new _annotation.MarkupAnnotation({dict:e,ref:i});t.setCreationDate("D:20190422"),expect(t.creationDate).toEqual("D:20190422")}),it("should not set and get an invalid creation date",function(){var t=new _annotation.MarkupAnnotation({dict:e,ref:i});t.setCreationDate(void 0),expect(t.creationDate).toEqual(null)}),it("should not parse IRT/RT when not defined",function(n){e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Text"));var t=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(t,i,h,w).then(function(t){var e=t.data;expect(e.inReplyTo).toBeUndefined(),expect(e.replyType).toBeUndefined(),n()},n.fail)}),it("should parse IRT and set default RT when not defined.",function(n){var i=_primitives.Ref.get(819,0),t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Text"));var e=_primitives.Ref.get(820,0),a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Text")),a.set("IRT",i);var o=new _test_utils.XRefMock([{ref:i,data:t},{ref:e,data:a}]);t.assignXref(o),a.assignXref(o),_annotation.AnnotationFactory.create(o,e,h,w).then(function(t){var e=t.data;expect(e.inReplyTo).toEqual(i.toString()),expect(e.replyType).toEqual("R"),n()},n.fail)}),it("should parse IRT/RT for a group type",function(n){var i=_primitives.Ref.get(819,0),t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Text")),t.set("T","ParentTitle"),t.set("Contents","ParentText"),t.set("CreationDate","D:20180423"),t.set("M","D:20190423"),t.set("C",[0,0,1]);var e=_primitives.Ref.get(820,0),a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Popup")),a.set("Parent",i),t.set("Popup",e);var o=_primitives.Ref.get(821,0),r=new _primitives.Dict;r.set("Type",_primitives.Name.get("Annot")),r.set("Subtype",_primitives.Name.get("Text")),r.set("IRT",i),r.set("RT",_primitives.Name.get("Group")),r.set("T","ReplyTitle"),r.set("Contents","ReplyText"),r.set("CreationDate","D:20180523"),r.set("M","D:20190523"),r.set("C",[.4]);var s=new _test_utils.XRefMock([{ref:i,data:t},{ref:e,data:a},{ref:o,data:r}]);t.assignXref(s),a.assignXref(s),r.assignXref(s),_annotation.AnnotationFactory.create(s,o,h,w).then(function(t){var e=t.data;expect(e.inReplyTo).toEqual(i.toString()),expect(e.replyType).toEqual("Group"),expect(e.title).toEqual("ParentTitle"),expect(e.contents).toEqual("ParentText"),expect(e.creationDate).toEqual("D:20180423"),expect(e.modificationDate).toEqual("D:20190423"),expect(e.color).toEqual(new Uint8ClampedArray([0,0,255])),expect(e.hasPopup).toEqual(!0),n()},n.fail)}),it("should parse IRT/RT for a reply type",function(n){var i=_primitives.Ref.get(819,0),t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Text")),t.set("T","ParentTitle"),t.set("Contents","ParentText"),t.set("CreationDate","D:20180423"),t.set("M","D:20190423"),t.set("C",[0,0,1]);var e=_primitives.Ref.get(820,0),a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Popup")),a.set("Parent",i),t.set("Popup",e);var o=_primitives.Ref.get(821,0),r=new _primitives.Dict;r.set("Type",_primitives.Name.get("Annot")),r.set("Subtype",_primitives.Name.get("Text")),r.set("IRT",i),r.set("RT",_primitives.Name.get("R")),r.set("T","ReplyTitle"),r.set("Contents","ReplyText"),r.set("CreationDate","D:20180523"),r.set("M","D:20190523"),r.set("C",[.4]);var s=new _test_utils.XRefMock([{ref:i,data:t},{ref:e,data:a},{ref:o,data:r}]);t.assignXref(s),a.assignXref(s),r.assignXref(s),_annotation.AnnotationFactory.create(s,o,h,w).then(function(t){var e=t.data;expect(e.inReplyTo).toEqual(i.toString()),expect(e.replyType).toEqual("R"),expect(e.title).toEqual("ReplyTitle"),expect(e.contents).toEqual("ReplyText"),expect(e.creationDate).toEqual("D:20180523"),expect(e.modificationDate).toEqual("D:20190523"),expect(e.color).toEqual(new Uint8ClampedArray([102,102,102])),expect(e.hasPopup).toEqual(!1),n()},n.fail)})}),describe("TextAnnotation",function(){it("should not parse state model and state when not defined",function(n){var t=_primitives.Ref.get(819,0),e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Text")),e.set("Contents","TestText");var i=_primitives.Ref.get(820,0),a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Text")),a.set("IRT",t),a.set("RT",_primitives.Name.get("R")),a.set("Contents","ReplyText");var o=new _test_utils.XRefMock([{ref:t,data:e},{ref:i,data:a}]);e.assignXref(o),a.assignXref(o),_annotation.AnnotationFactory.create(o,i,h,w).then(function(t){var e=t.data;expect(e.stateModel).toBeNull(),expect(e.state).toBeNull(),n()},n.fail)}),it("should correctly parse state model and state when defined",function(n){var t=_primitives.Ref.get(819,0),e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Text"));var i=_primitives.Ref.get(820,0),a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Text")),a.set("IRT",t),a.set("RT",_primitives.Name.get("R")),a.set("StateModel","Review"),a.set("State","Rejected");var o=new _test_utils.XRefMock([{ref:t,data:e},{ref:i,data:a}]);e.assignXref(o),a.assignXref(o),_annotation.AnnotationFactory.create(o,i,h,w).then(function(t){var e=t.data;expect(e.stateModel).toEqual("Review"),expect(e.state).toEqual("Rejected"),n()},n.fail)})}),describe("LinkAnnotation",function(){it("should correctly parse a URI action",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("URI")),t.set("URI","http://www.ctan.org/tex-archive/info/lshort");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(820,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual("http://www.ctan.org/tex-archive/info/lshort"),expect(e.unsafeUrl).toEqual("http://www.ctan.org/tex-archive/info/lshort"),expect(e.dest).toBeUndefined(),n()},n.fail)}),it("should correctly parse a URI action, where the URI entry is missing a protocol",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("URI")),t.set("URI","www.hmrc.gov.uk");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(353,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual("http://www.hmrc.gov.uk/"),expect(e.unsafeUrl).toEqual("http://www.hmrc.gov.uk"),expect(e.dest).toBeUndefined(),n()},n.fail)}),it("should correctly parse a URI action, where the URI entry has an incorrect encoding (bug 1122280)",function(n){var t=new _stream.StringStream("<<\n/Type /Action\n/S /URI\n/URI (http://www.example.com/\\303\\274\\303\\266\\303\\244)\n>>\n"),e=new _parser.Parser({lexer:new _parser.Lexer(t),xref:null}).getObj(),i=new _primitives.Dict;i.set("Type",_primitives.Name.get("Annot")),i.set("Subtype",_primitives.Name.get("Link")),i.set("A",e);var a=_primitives.Ref.get(8,0),o=new _test_utils.XRefMock([{ref:a,data:i}]);_annotation.AnnotationFactory.create(o,a,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual(new URL((0,_util.stringToUTF8String)("http://www.example.com/Ã¼Ã¶Ã¤")).href),expect(e.unsafeUrl).toEqual((0,_util.stringToUTF8String)("http://www.example.com/Ã¼Ã¶Ã¤")),expect(e.dest).toBeUndefined(),n()},n.fail)}),it("should correctly parse a GoTo action",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("GoTo")),t.set("D","page.157");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(798,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toBeUndefined(),expect(e.unsafeUrl).toBeUndefined(),expect(e.dest).toEqual("page.157"),n()},n.fail)}),it("should correctly parse a GoToR action, where the FileSpec entry is a string containing a relative URL",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("GoToR")),t.set("F","../../0013/001346/134685E.pdf"),t.set("D","4.3"),t.set("NewWindow",!0);var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(489,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toBeUndefined(),expect(e.unsafeUrl).toEqual("../../0013/001346/134685E.pdf#4.3"),expect(e.dest).toBeUndefined(),expect(e.newWindow).toEqual(!0),n()},n.fail)}),it('should correctly parse a GoToR action, containing a relative URL, with the "docBaseUrl" parameter specified',function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("GoToR")),t.set("F","../../0013/001346/134685E.pdf"),t.set("D","4.3");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(489,0),a=new _test_utils.XRefMock([{ref:i,data:e}]),o=new s({docBaseUrl:"http://www.example.com/test/pdfs/qwerty.pdf"});_annotation.AnnotationFactory.create(a,i,o,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual("http://www.example.com/0013/001346/134685E.pdf#4.3"),expect(e.unsafeUrl).toEqual("../../0013/001346/134685E.pdf#4.3"),expect(e.dest).toBeUndefined(),n()},n.fail)}),it("should correctly parse a GoToR action, with named destination",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("GoToR")),t.set("F","http://www.example.com/test.pdf"),t.set("D","15");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(495,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual("http://www.example.com/test.pdf#15"),expect(e.unsafeUrl).toEqual("http://www.example.com/test.pdf#15"),expect(e.dest).toBeUndefined(),expect(e.newWindow).toBeFalsy(),n()},n.fail)}),it("should correctly parse a GoToR action, with explicit destination array",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("GoToR")),t.set("F","http://www.example.com/test.pdf"),t.set("D",[14,_primitives.Name.get("XYZ"),null,298.043,null]);var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(489,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual(new URL('http://www.example.com/test.pdf#[14,{"name":"XYZ"},null,298.043,null]').href),expect(e.unsafeUrl).toEqual('http://www.example.com/test.pdf#[14,{"name":"XYZ"},null,298.043,null]'),expect(e.dest).toBeUndefined(),expect(e.newWindow).toBeFalsy(),n()},n.fail)}),it('should correctly parse a Launch action, where the FileSpec dict contains a relative URL, with the "docBaseUrl" parameter specified',function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("FileSpec")),t.set("F","Part II/Part II.pdf"),t.set("UF","Part II/Part II.pdf");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("Launch")),e.set("F",t),e.set("NewWindow",!0);var i=new _primitives.Dict;i.set("Type",_primitives.Name.get("Annot")),i.set("Subtype",_primitives.Name.get("Link")),i.set("A",e);var a=_primitives.Ref.get(88,0),o=new _test_utils.XRefMock([{ref:a,data:i}]),r=new s({docBaseUrl:"http://www.example.com/test/pdfs/qwerty.pdf"});_annotation.AnnotationFactory.create(o,a,r,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual(new URL("http://www.example.com/test/pdfs/Part II/Part II.pdf").href),expect(e.unsafeUrl).toEqual("Part II/Part II.pdf"),expect(e.dest).toBeUndefined(),expect(e.newWindow).toEqual(!0),n()},n.fail)}),it("should recover valid URLs from JavaScript actions having certain white-listed formats",function(t){function e(t){var e=t.jsEntry,n=t.expectedUrl,i=t.expectedUnsafeUrl,a=t.expectedNewWindow,o=new _primitives.Dict;o.set("Type",_primitives.Name.get("Action")),o.set("S",_primitives.Name.get("JavaScript")),o.set("JS",e);var r=new _primitives.Dict;r.set("Type",_primitives.Name.get("Annot")),r.set("Subtype",_primitives.Name.get("Link")),r.set("A",o);var s=_primitives.Ref.get(46,0),l=new _test_utils.XRefMock([{ref:s,data:r}]);return _annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual(n),expect(e.unsafeUrl).toEqual(i),expect(e.dest).toBeUndefined(),expect(e.newWindow).toEqual(a)})}var n=e({jsEntry:'function someFun() { return "qwerty"; } someFun();',expectedUrl:void 0,expectedUnsafeUrl:void 0,expectedNewWindow:void 0}),i=e({jsEntry:"window.open('http://www.example.com/test.pdf')",expectedUrl:new URL("http://www.example.com/test.pdf").href,expectedUnsafeUrl:"http://www.example.com/test.pdf",expectedNewWindow:void 0}),a=e({jsEntry:new _stream.StringStream('app.launchURL("http://www.example.com/test.pdf", true)'),expectedUrl:new URL("http://www.example.com/test.pdf").href,expectedUnsafeUrl:"http://www.example.com/test.pdf",expectedNewWindow:!0});Promise.all([n,i,a]).then(t,t.fail)}),it("should correctly parse a Named action",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("Named")),t.set("N",_primitives.Name.get("GoToPage"));var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("A",t);var i=_primitives.Ref.get(12,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toBeUndefined(),expect(e.unsafeUrl).toBeUndefined(),expect(e.action).toEqual("GoToPage"),n()},n.fail)}),it("should correctly parse a simple Dest",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Link")),t.set("Dest",_primitives.Name.get("LI0"));var e=_primitives.Ref.get(583,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toBeUndefined(),expect(e.unsafeUrl).toBeUndefined(),expect(e.dest).toEqual("LI0"),n()},n.fail)}),it("should correctly parse a simple Dest, with explicit destination array",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Link")),t.set("Dest",[_primitives.Ref.get(17,0),_primitives.Name.get("XYZ"),0,841.89,null]);var e=_primitives.Ref.get(10,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toBeUndefined(),expect(e.unsafeUrl).toBeUndefined(),expect(e.dest).toEqual([{num:17,gen:0},{name:"XYZ"},0,841.89,null]),n()},n.fail)}),it("should correctly parse a Dest, which violates the specification by containing a dictionary",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Action")),t.set("S",_primitives.Name.get("GoTo")),t.set("D","page.157");var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("Dest",t);var i=_primitives.Ref.get(798,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toBeUndefined(),expect(e.unsafeUrl).toBeUndefined(),expect(e.dest).toEqual("page.157"),n()},n.fail)}),it("should not set quadpoints if not defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Link"));var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.quadPoints).toBeUndefined(),n()},n.fail)}),it("should set quadpoints if defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Link")),t.set("Rect",[10,10,20,20]),t.set("QuadPoints",[10,20,20,20,10,10,20,10]);var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.quadPoints).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}]]),n()},n.fail)})}),describe("WidgetAnnotation",function(){var o;beforeEach(function(t){(o=new _primitives.Dict).set("Type",_primitives.Name.get("Annot")),o.set("Subtype",_primitives.Name.get("Widget")),t()}),afterEach(function(){o=null}),it("should handle unknown field names",function(n){var t=_primitives.Ref.get(20,0),e=new _test_utils.XRefMock([{ref:t,data:o}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.fieldName).toEqual(""),n()},n.fail)}),it("should construct the field name when there are no ancestors",function(n){o.set("T","foo");var t=_primitives.Ref.get(21,0),e=new _test_utils.XRefMock([{ref:t,data:o}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.fieldName).toEqual("foo"),n()},n.fail)}),it("should construct the field name when there are ancestors",function(n){var t=new _primitives.Dict;t.set("T","foo");var e=new _primitives.Dict;e.set("Parent",t),e.set("T","bar"),o.set("Parent",e),o.set("T","baz");var i=_primitives.Ref.get(22,0),a=new _test_utils.XRefMock([{ref:i,data:o}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.fieldName).toEqual("foo.bar.baz"),n()},n.fail)}),it("should construct the field name if a parent is not a dictionary (issue 8143)",function(n){var t=new _primitives.Dict;t.set("Parent",null),t.set("T","foo"),o.set("Parent",t),o.set("T","bar");var e=_primitives.Ref.get(22,0),i=new _test_utils.XRefMock([{ref:e,data:o}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.fieldName).toEqual("foo.bar"),n()},n.fail)})}),describe("TextWidgetAnnotation",function(){var g,u,p;beforeEach(function(t){(g=new _primitives.Dict).set("Type",_primitives.Name.get("Annot")),g.set("Subtype",_primitives.Name.get("Widget")),g.set("FT",_primitives.Name.get("Tx"));var e=new _primitives.Dict;e.set("BaseFont",_primitives.Name.get("Helvetica")),e.set("Type",_primitives.Name.get("Font")),e.set("Subtype",_primitives.Name.get("Type1"));var n=new _primitives.Dict;n.set("BaseFont",_primitives.Name.get("MSGothic")),n.set("Type",_primitives.Name.get("Font")),n.set("Subtype",_primitives.Name.get("Type0")),n.set("Encoding",_primitives.Name.get("UniJIS-UTF16-H")),n.set("Name",_primitives.Name.get("MSGothic"));var i=new _primitives.Dict;i.set("Ordering","Japan1"),i.set("Registry","Adobe"),i.set("Supplement","5");var a=new _primitives.Dict;a.set("FontName",_primitives.Name.get("MSGothic")),a.set("CapHeight","680");var o=new _primitives.Dict;o.set("BaseFont",_primitives.Name.get("MSGothic")),o.set("CIDSystemInfo",i),o.set("Subtype",_primitives.Name.get("CIDFontType2")),o.set("Type",_primitives.Name.get("Font")),o.set("FontDescriptor",a),n.set("DescendantFonts",[o]);var r=_primitives.Ref.get(314,0),s=_primitives.Ref.get(159,0);u={ref:r,data:e},p={ref:s,data:n};var l=new _primitives.Dict,c=new _primitives.Dict;c.set("Helv",r),l.set("Font",c),g.set("DA","/Helv 5 Tf"),g.set("DR",l),g.set("Rect",[0,0,32,10]),t()}),afterEach(function(){g=u=p=null}),it("should handle unknown text alignment, maximum length and flags",function(n){g.set("DV","foo");var t=_primitives.Ref.get(124,0),e=new _test_utils.XRefMock([{ref:t,data:g}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.textAlignment).toEqual(null),expect(e.maxLen).toEqual(null),expect(e.readOnly).toEqual(!1),expect(e.hidden).toEqual(!1),expect(e.multiLine).toEqual(!1),expect(e.comb).toEqual(!1),expect(e.defaultFieldValue).toEqual("foo"),n()},n.fail)}),it("should not set invalid text alignment, maximum length and flags",function(n){g.set("Q","center"),g.set("MaxLen","five"),g.set("Ff","readonly");var t=_primitives.Ref.get(43,0),e=new _test_utils.XRefMock([{ref:t,data:g}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.textAlignment).toEqual(null),expect(e.maxLen).toEqual(null),expect(e.readOnly).toEqual(!1),expect(e.hidden).toEqual(!1),expect(e.multiLine).toEqual(!1),expect(e.comb).toEqual(!1),n()},n.fail)}),it("should set valid text alignment, maximum length and flags",function(n){g.set("Q",1),g.set("MaxLen",20),g.set("Ff",_util.AnnotationFieldFlag.READONLY+_util.AnnotationFieldFlag.MULTILINE);var t=_primitives.Ref.get(84,0),e=new _test_utils.XRefMock([{ref:t,data:g}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.textAlignment).toEqual(1),expect(e.maxLen).toEqual(20),expect(e.readOnly).toEqual(!0),expect(e.hidden).toEqual(!1),expect(e.multiLine).toEqual(!0),n()},n.fail)}),it("should reject comb fields without a maximum length",function(n){g.set("Ff",_util.AnnotationFieldFlag.COMB);var t=_primitives.Ref.get(46,0),e=new _test_utils.XRefMock([{ref:t,data:g}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.comb).toEqual(!1),n()},n.fail)}),it("should accept comb fields with a maximum length",function(n){g.set("MaxLen",20),g.set("Ff",_util.AnnotationFieldFlag.COMB);var t=_primitives.Ref.get(46,0),e=new _test_utils.XRefMock([{ref:t,data:g}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.comb).toEqual(!0),n()},n.fail)}),it("should only accept comb fields when the flags are valid",function(t){for(var i=[_util.AnnotationFieldFlag.MULTILINE,_util.AnnotationFieldFlag.PASSWORD,_util.AnnotationFieldFlag.FILESELECT],a=_util.AnnotationFieldFlag.COMB+_util.AnnotationFieldFlag.MULTILINE+_util.AnnotationFieldFlag.PASSWORD+_util.AnnotationFieldFlag.FILESELECT,e=Promise.resolve(),n=0,o=i.length;n<=o;n++)e=e.then(function(){g.set("MaxLen",20),g.set("Ff",a);var t=_primitives.Ref.get(93,0),e=new _test_utils.XRefMock([{ref:t,data:g}]);return _annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET);var n=0===i.length;expect(e.comb).toEqual(n),n||(a-=i.pop())})});e.then(t,t.fail)}),it("should render regular text for printing",function(e){var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},u]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"test\\print"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Helv 5 Tf 1 0 0 1 0 0 Tm 2.00 2.00 Td (test\\\\print) Tj ET Q EMC"),e()},e.fail)}),it("should render regular text in Japanese for printing",function(e){g.get("DR").get("Font").set("Goth",p.ref),g.set("DA","/Goth 5 Tf");var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},p]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"こんにちは世界の"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Goth 5 Tf 1 0 0 1 0 0 Tm"+" 2.00 2.00 Td (".concat("0S00k0a0oNuL0n",") Tj ET Q EMC")),e()},e.fail)}),it("should render regular text for printing using normal appearance",function(e){var t=_primitives.Ref.get(271,0),n=new _primitives.Dict,i=new _primitives.Dict,a=new _stream.StringStream("0.1 0.2 0.3 rg");a.dict=i,n.set("N",a),g.set("AP",n);var o=new _test_utils.XRefMock([{ref:t,data:g},u]),r=new _worker.WorkerTask("test print");x.xref=o,_annotation.AnnotationFactory.create(o,t,h,w).then(function(t){var e=new Map;return t.getOperatorList(x,r,!1,e)}).then(function(t){expect(t.argsArray.length).toEqual(3),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(t.argsArray[1]).toEqual(new Uint8ClampedArray([26,51,76])),e()}).catch(e.fail)}),it("should render auto-sized text for printing",function(e){g.set("DA","/Helv 0 Tf");var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},u]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"test (print)"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Helv 8 Tf 0 g 1 0 0 1 0 0 Tm 2.00 2.00 Td (test \\(print\\)) Tj ET Q EMC"),e()},e.fail)}),it("should render auto-sized text in Japanese for printing",function(e){g.get("DR").get("Font").set("Goth",p.ref),g.set("DA","/Goth 0 Tf");var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},p]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"こんにちは世界の"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Goth 8 Tf 0 g 1 0 0 1 0 0 Tm"+" 2.00 2.00 Td (".concat("0S00k0a0oNuL0n",") Tj ET Q EMC")),e()},e.fail)}),it("should not render a password for printing",function(e){g.set("Ff",_util.AnnotationFieldFlag.PASSWORD);var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},u]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"mypassword"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual(null),e()},e.fail)}),it("should render multiline text for printing",function(e){g.set("Ff",_util.AnnotationFieldFlag.MULTILINE);var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},u]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"a aa aaa aaaa aaaaa aaaaaa pneumonoultramicroscopicsilicovolcanoconiosis"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Helv 5 Tf 1 0 0 1 0 10 Tm 2.00 -5.00 Td (a aa aaa ) Tj\n0.00 -5.00 Td (aaaa aaaaa ) Tj\n0.00 -5.00 Td (aaaaaa ) Tj\n0.00 -5.00 Td (pneumonoultr) Tj\n0.00 -5.00 Td (amicroscopi) Tj\n0.00 -5.00 Td (csilicovolca) Tj\n0.00 -5.00 Td (noconiosis) Tj ET Q EMC"),e()},e.fail)}),it("should render multiline text in Japanese for printing",function(e){g.set("Ff",_util.AnnotationFieldFlag.MULTILINE),g.get("DR").get("Font").set("Goth",p.ref),g.set("DA","/Goth 5 Tf");var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},p]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"こんにちは世界の"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Goth 5 Tf 1 0 0 1 0 10 Tm 2.00 -5.00 Td (0S00k0a0o) Tj\n0.00 -5.00 Td (NuL0n) Tj ET Q EMC"),e()},e.fail)}),it("should render multiline text with various EOL for printing",function(e){g.set("Ff",_util.AnnotationFieldFlag.MULTILINE),g.set("Rect",[0,0,128,10]);var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},u]),i=new _worker.WorkerTask("test print");x.xref=n;_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"Lorem ipsum dolor sit amet, consectetur adipiscing elit.\rAliquam vitae felis ac lectus bibendum ultricies quis non diam.\nMorbi id porttitor quam, a iaculis dui.\r\nPellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.\n\r\n\rNulla consectetur, ligula in tincidunt placerat, velit augue consectetur orci, sed mattis libero nunc ut massa.\rEtiam facilisis tempus interdum."}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Helv 5 Tf 1 0 0 1 0 10 Tm 2.00 -5.00 Td (Lorem ipsum dolor sit amet, consectetur adipiscing elit.) Tj\n0.00 -5.00 Td (Aliquam vitae felis ac lectus bibendum ultricies quis non) Tj\n0.00 -5.00 Td ( diam.) Tj\n0.00 -5.00 Td (Morbi id porttitor quam, a iaculis dui.) Tj\n0.00 -5.00 Td (Pellentesque habitant morbi tristique senectus et netus ) Tj\n0.00 -5.00 Td (et malesuada fames ac turpis egestas.) Tj\n0.00 -5.00 Td () Tj\n0.00 -5.00 Td () Tj\n0.00 -5.00 Td (Nulla consectetur, ligula in tincidunt placerat, velit ) Tj\n0.00 -5.00 Td (augue consectetur orci, sed mattis libero nunc ut massa.) Tj\n0.00 -5.00 Td (Etiam facilisis tempus interdum.) Tj ET Q EMC"),e()},e.fail)}),it("should render comb for printing",function(e){g.set("Ff",_util.AnnotationFieldFlag.COMB),g.set("MaxLen",4);var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},u]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"aa(aa)a\\"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Helv 5 Tf 1 0 0 1 2 2 Tm (a) Tj 8.00 0 Td (a) Tj 8.00 0 Td (\\() Tj 8.00 0 Td (a) Tj 8.00 0 Td (a) Tj 8.00 0 Td (\\)) Tj 8.00 0 Td (a) Tj 8.00 0 Td (\\\\) Tj ET Q EMC"),e()},e.fail)}),it("should render comb with Japanese text for printing",function(e){g.set("Ff",_util.AnnotationFieldFlag.COMB),g.set("MaxLen",4),g.get("DR").get("Font").set("Goth",p.ref),g.set("DA","/Goth 5 Tf"),g.set("Rect",[0,0,32,10]);var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:g},p]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"こんにちは世界の"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Goth 5 Tf 1 0 0 1 2 2 Tm (0S) Tj 8.00 0 Td (0) Tj 8.00 0 Td (0k) Tj 8.00 0 Td (0a) Tj 8.00 0 Td (0o) Tj 8.00 0 Td (N) Tj 8.00 0 Td (uL) Tj 8.00 0 Td (0n) Tj ET Q EMC"),e()},e.fail)}),it("should save text",function(a){var t=_primitives.Ref.get(123,0),e=new _test_utils.XRefMock([{ref:t,data:g},u]);x.xref=e;var n=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"hello world"}),t.save(x,n,e)},a.fail).then(function(t){expect(t.length).toEqual(2);var e=_slicedToArray(t,2),n=e[0],i=e[1];expect(n.ref).toEqual(_primitives.Ref.get(123,0)),expect(i.ref).toEqual(_primitives.Ref.get(2,0)),n.data=n.data.replace(/\(D:[0-9]+\)/,"(date)"),expect(n.data).toEqual("123 0 obj\n<< /Type /Annot /Subtype /Widget /FT /Tx /DA (/Helv 5 Tf) /DR << /Font << /Helv 314 0 R>>>> /Rect [0 0 32 10] /V (hello world) /AP << /N 2 0 R>> /M (date)>>\nendobj\n"),expect(i.data).toEqual("2 0 obj\n<< /Length 77 /Subtype /Form /Resources << /Font << /Helv 314 0 R>>>> /BBox [0 0 32 10]>> stream\n/Tx BMC q BT /Helv 5 Tf 1 0 0 1 0 0 Tm 2.00 2.00 Td (hello world) Tj ET Q EMC\nendstream\nendobj\n"),a()},a.fail)}),it("should get field object for usage in JS sandbox",function(n){var t=_primitives.Ref.get(123,0),e=_primitives.Ref.get(141,0),i=_primitives.Ref.get(262,0),a=_primitives.Ref.get(314,0),o=_primitives.Ref.get(271,0),r=_primitives.Ref.get(577,0),s=_primitives.Ref.get(413,0),l=new _primitives.Dict,c=new _primitives.Dict,u=new _primitives.Dict,p=new _primitives.Dict,f=new _primitives.Dict,d=new _primitives.Dict,v=new _test_utils.XRefMock([{ref:t,data:g},{ref:e,data:l},{ref:i,data:c},{ref:a,data:u},{ref:s,data:d},{ref:o,data:p},{ref:r,data:f}]),_=_primitives.Name.get("JavaScript"),m=new _primitives.Dict,y=new _primitives.Dict;y.set("JS","hello()"),y.set("S",_),m.set("E",y),l.set("JS","world()"),l.set("S",_),l.set("Next",[a,o,r,e]),u.set("JS","olleh()"),u.set("S",_),u.set("Next",s),d.set("JS","foo()"),d.set("S",_),d.set("Next",a),p.set("JS","dlrow()"),p.set("S",_),p.set("Next",e),f.set("JS","oof()"),f.set("S",_),c.set("JS","bar()"),c.set("S",_),c.set("Next",i),m.set("D",i),m.set("X",e),g.set("AA",m),x.xref=v,_annotation.AnnotationFactory.create(v,t,h,w).then(function(t){return t.getFieldObject()}).then(function(t){var e=t.actions;expect(e["Mouse Enter"]).toEqual(["hello()"]),expect(e["Mouse Exit"]).toEqual(["world()","olleh()","foo()","dlrow()","oof()"]),expect(e["Mouse Down"]).toEqual(["bar()"]),n()},n.fail)}),it("should save Japanese text",function(o){g.get("DR").get("Font").set("Goth",p.ref),g.set("DA","/Goth 5 Tf");var t=_primitives.Ref.get(123,0),e=new _test_utils.XRefMock([{ref:t,data:g},p]);x.xref=e;var n=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"こんにちは世界の"}),t.save(x,n,e)},o.fail).then(function(t){var e="0S00k0a0oNuL0n";expect(t.length).toEqual(2);var n=_slicedToArray(t,2),i=n[0],a=n[1];expect(i.ref).toEqual(_primitives.Ref.get(123,0)),expect(a.ref).toEqual(_primitives.Ref.get(2,0)),i.data=i.data.replace(/\(D:[0-9]+\)/,"(date)"),expect(i.data).toEqual("123 0 obj\n<< /Type /Annot /Subtype /Widget /FT /Tx /DA (/Goth 5 Tf) /DR << /Font << /Helv 314 0 R /Goth 159 0 R>>>> /Rect [0 0 32 10] "+"/V (þÿ".concat(e,") /AP << /N 2 0 R>> /M (date)>>\nendobj\n")),expect(a.data).toEqual("2 0 obj\n<< /Length 82 /Subtype /Form /Resources << /Font << /Helv 314 0 R /Goth 159 0 R>>>> /BBox [0 0 32 10]>> stream\n"+"/Tx BMC q BT /Goth 5 Tf 1 0 0 1 0 0 Tm 2.00 2.00 Td (".concat(e,") Tj ")+"ET Q EMC\nendstream\nendobj\n"),o()},o.fail)})}),describe("ButtonWidgetAnnotation",function(){var u;beforeEach(function(t){(u=new _primitives.Dict).set("Type",_primitives.Name.get("Annot")),u.set("Subtype",_primitives.Name.get("Widget")),u.set("FT",_primitives.Name.get("Btn")),t()}),afterEach(function(){u=null}),it("should handle checkboxes with export value",function(n){u.set("V",_primitives.Name.get("1")),u.set("DV",_primitives.Name.get("2"));var t=new _primitives.Dict,e=new _primitives.Dict;e.set("Off",0),e.set("Checked",1),t.set("N",e),u.set("AP",t);var i=_primitives.Ref.get(124,0),a=new _test_utils.XRefMock([{ref:i,data:u}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.checkBox).toEqual(!0),expect(e.fieldValue).toEqual("1"),expect(e.defaultFieldValue).toEqual("2"),expect(e.radioButton).toEqual(!1),expect(e.exportValue).toEqual("Checked"),n()},n.fail)}),it("should handle checkboxes without export value",function(n){u.set("V",_primitives.Name.get("1")),u.set("DV",_primitives.Name.get("2"));var t=_primitives.Ref.get(124,0),e=new _test_utils.XRefMock([{ref:t,data:u}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.checkBox).toEqual(!0),expect(e.fieldValue).toEqual("1"),expect(e.defaultFieldValue).toEqual("2"),expect(e.radioButton).toEqual(!1),n()},n.fail)}),it("should handle checkboxes without /Off appearance",function(n){u.set("V",_primitives.Name.get("1")),u.set("DV",_primitives.Name.get("2"));var t=new _primitives.Dict,e=new _primitives.Dict;e.set("Checked",1),t.set("N",e),u.set("AP",t);var i=_primitives.Ref.get(124,0),a=new _test_utils.XRefMock([{ref:i,data:u}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.checkBox).toEqual(!0),expect(e.fieldValue).toEqual("1"),expect(e.defaultFieldValue).toEqual("2"),expect(e.radioButton).toEqual(!1),expect(e.exportValue).toEqual("Checked"),n()},n.fail)}),it("should render checkbox with fallback font for printing",function(e){var t=new _primitives.Dict,n=new _primitives.Dict,i=new _primitives.Dict,a=new _primitives.Dict,o=new _stream.StringStream("/ 12 Tf (4) Tj");o.dict=i;var r=new _stream.StringStream("");r.dict=a,i.set("BBox",[0,0,8,8]),i.set("FormType",1),i.set("Matrix",[1,0,0,1,0,0]),n.set("Checked",o),n.set("Off",r),t.set("N",n),u.set("AP",t);var s=_primitives.Ref.get(124,0),l=new _test_utils.XRefMock([{ref:s,data:u}]),c=new _worker.WorkerTask("test print");x.options={ignoreErrors:!0},_annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),t.getOperatorList(x,c,!1,e)}).then(function(t){expect(t.argsArray.length).toEqual(5),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.dependency,_util.OPS.setFont,_util.OPS.showText,_util.OPS.endAnnotation]),expect(t.argsArray[3][0][0].fontChar).toEqual("✔"),e()}).catch(e.fail)}),it("should render checkboxes for printing",function(e){var t=new _primitives.Dict,n=new _primitives.Dict,i=new _primitives.Dict,a=new _primitives.Dict,o=new _stream.StringStream("0.1 0.2 0.3 rg");o.dict=i;var r=new _stream.StringStream("0.3 0.2 0.1 rg");r.dict=a,i.set("BBox",[0,0,8,8]),i.set("FormType",1),i.set("Matrix",[1,0,0,1,0,0]),n.set("Checked",o),n.set("Off",r),t.set("N",n),u.set("AP",t);var s=_primitives.Ref.get(124,0),l=new _test_utils.XRefMock([{ref:s,data:u}]),c=new _worker.WorkerTask("test print");_annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),Promise.all([t,t.getOperatorList(x,c,!1,e)])},e.fail).then(function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];return expect(i.argsArray.length).toEqual(3),expect(i.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(i.argsArray[1]).toEqual(new Uint8ClampedArray([26,51,76])),n},e.fail).then(function(t){var e=new Map;return e.set(t.data.id,{value:!1}),t.getOperatorList(x,c,!1,e)},e.fail).then(function(t){expect(t.argsArray.length).toEqual(3),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(t.argsArray[1]).toEqual(new Uint8ClampedArray([76,51,26])),e()},e.fail)}),it("should render checkboxes for printing two times",function(e){var t=new _primitives.Dict,n=new _primitives.Dict,i=new _primitives.Dict,a=new _primitives.Dict,o=new _stream.StringStream("0.1 0.2 0.3 rg");o.dict=i;var r=new _stream.StringStream("0.3 0.2 0.1 rg");r.dict=a,i.set("BBox",[0,0,8,8]),i.set("FormType",1),i.set("Matrix",[1,0,0,1,0,0]),n.set("Checked",o),n.set("Off",r),t.set("N",n),u.set("AP",t),u.set("AS",_primitives.Name.get("Off"));var s=_primitives.Ref.get(1249,0),l=new _test_utils.XRefMock([{ref:s,data:u}]),c=new _worker.WorkerTask("test print");_annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),Promise.all([t,t.getOperatorList(x,c,!1,e)])}).then(function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];return expect(i.argsArray.length).toEqual(3),expect(i.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(i.argsArray[1]).toEqual(new Uint8ClampedArray([26,51,76])),n}).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),t.getOperatorList(x,c,!1,e)}).then(function(t){expect(t.argsArray.length).toEqual(3),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(t.argsArray[1]).toEqual(new Uint8ClampedArray([26,51,76])),e()}).catch(e.fail)}),it("should render checkboxes for printing using normal appearance",function(e){var t=new _primitives.Dict,n=new _primitives.Dict,i=new _primitives.Dict,a=new _primitives.Dict,o=new _stream.StringStream("0.1 0.2 0.3 rg");o.dict=i;var r=new _stream.StringStream("0.3 0.2 0.1 rg");r.dict=a,i.set("BBox",[0,0,8,8]),i.set("FormType",1),i.set("Matrix",[1,0,0,1,0,0]),n.set("Checked",o),n.set("Off",r),t.set("N",n),u.set("AP",t),u.set("AS",_primitives.Name.get("Checked"));var s=_primitives.Ref.get(124,0),l=new _test_utils.XRefMock([{ref:s,data:u}]),c=new _worker.WorkerTask("test print");_annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=new Map;return t.getOperatorList(x,c,!1,e)}).then(function(t){expect(t.argsArray.length).toEqual(3),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(t.argsArray[1]).toEqual(new Uint8ClampedArray([26,51,76])),e()}).catch(e.fail)}),it("should save checkboxes",function(e){var t=new _primitives.Dict,n=new _primitives.Dict;n.set("Checked",_primitives.Ref.get(314,0)),n.set("Off",_primitives.Ref.get(271,0)),t.set("N",n),u.set("AP",t),u.set("V",_primitives.Name.get("Off"));var i=_primitives.Ref.get(123,0),a=new _test_utils.XRefMock([{ref:i,data:u}]);x.xref=a;var o=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),Promise.all([t,t.save(x,o,e)])},e.fail).then(function(t){var e=_slicedToArray(t,2),n=e[0],i=_slicedToArray(e[1],1)[0];return i.data=i.data.replace(/\(D:[0-9]+\)/,"(date)"),expect(i.ref).toEqual(_primitives.Ref.get(123,0)),expect(i.data).toEqual("123 0 obj\n<< /Type /Annot /Subtype /Widget /FT /Btn /AP << /N << /Checked 314 0 R /Off 271 0 R>>>> /V /Checked /AS /Checked /M (date)>>\nendobj\n"),n},e.fail).then(function(t){var e=new Map;return e.set(t.data.id,{value:!1}),t.save(x,o,e)},e.fail).then(function(t){expect(t).toEqual(null),e()},e.fail)}),it("should handle radio buttons with a field value",function(n){var t=new _primitives.Dict;t.set("V",_primitives.Name.get("1"));var e=new _primitives.Dict;e.set("2",null);var i=new _primitives.Dict;i.set("N",e),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("Parent",t),u.set("AP",i);var a=_primitives.Ref.get(124,0),o=new _test_utils.XRefMock([{ref:a,data:u}]);_annotation.AnnotationFactory.create(o,a,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.checkBox).toEqual(!1),expect(e.radioButton).toEqual(!0),expect(e.fieldValue).toEqual("1"),expect(e.buttonValue).toEqual("2"),n()},n.fail)}),it("should handle radio buttons with a field value not an ascii string",function(n){var t=new _primitives.Dict;t.set("V",_primitives.Name.get("I=ðàe3"));var e=new _primitives.Dict;e.set("I=ðàe3",null);var i=new _primitives.Dict;i.set("N",e),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("Parent",t),u.set("AP",i);var a=_primitives.Ref.get(124,0),o=new _test_utils.XRefMock([{ref:a,data:u}]);_annotation.AnnotationFactory.create(o,a,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.checkBox).toEqual(!1),expect(e.radioButton).toEqual(!0),expect(e.fieldValue).toEqual("‚I=‚ðﬁàŠe3"),expect(e.buttonValue).toEqual("‚I=‚ðﬁàŠe3"),n()},n.fail)}),it("should handle radio buttons without a field value",function(n){var t=new _primitives.Dict;t.set("2",null);var e=new _primitives.Dict;e.set("N",t),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("AP",e);var i=_primitives.Ref.get(124,0),a=new _test_utils.XRefMock([{ref:i,data:u}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.checkBox).toEqual(!1),expect(e.radioButton).toEqual(!0),expect(e.fieldValue).toEqual(null),expect(e.buttonValue).toEqual("2"),n()},n.fail)}),it("should render radio buttons for printing",function(e){var t=new _primitives.Dict,n=new _primitives.Dict,i=new _primitives.Dict,a=new _primitives.Dict,o=new _stream.StringStream("0.1 0.2 0.3 rg");o.dict=i;var r=new _stream.StringStream("0.3 0.2 0.1 rg");r.dict=a,i.set("BBox",[0,0,8,8]),i.set("FormType",1),i.set("Matrix",[1,0,0,1,0,0]),n.set("Checked",o),n.set("Off",r),t.set("N",n),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("AP",t);var s=_primitives.Ref.get(124,0),l=new _test_utils.XRefMock([{ref:s,data:u}]),c=new _worker.WorkerTask("test print");_annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),Promise.all([t,t.getOperatorList(x,c,!1,e)])},e.fail).then(function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];return expect(i.argsArray.length).toEqual(3),expect(i.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(i.argsArray[1]).toEqual(new Uint8ClampedArray([26,51,76])),n},e.fail).then(function(t){var e=new Map;return e.set(t.data.id,{value:!1}),t.getOperatorList(x,c,!1,e)},e.fail).then(function(t){expect(t.argsArray.length).toEqual(3),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(t.argsArray[1]).toEqual(new Uint8ClampedArray([76,51,26])),e()},e.fail)}),it("should render radio buttons for printing using normal appearance",function(e){var t=new _primitives.Dict,n=new _primitives.Dict,i=new _primitives.Dict,a=new _primitives.Dict,o=new _stream.StringStream("0.1 0.2 0.3 rg");o.dict=i;var r=new _stream.StringStream("0.3 0.2 0.1 rg");r.dict=a,i.set("BBox",[0,0,8,8]),i.set("FormType",1),i.set("Matrix",[1,0,0,1,0,0]),n.set("Checked",o),n.set("Off",r),t.set("N",n),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("AP",t),u.set("AS",_primitives.Name.get("Off"));var s=_primitives.Ref.get(124,0),l=new _test_utils.XRefMock([{ref:s,data:u}]),c=new _worker.WorkerTask("test print");_annotation.AnnotationFactory.create(l,s,h,w).then(function(t){var e=new Map;return t.getOperatorList(x,c,!1,e)}).then(function(t){expect(t.argsArray.length).toEqual(3),expect(t.fnArray).toEqual([_util.OPS.beginAnnotation,_util.OPS.setFillRGBColor,_util.OPS.endAnnotation]),expect(t.argsArray[1]).toEqual(new Uint8ClampedArray([76,51,26])),e()}).catch(e.fail)}),it("should save radio buttons",function(e){var t=new _primitives.Dict,n=new _primitives.Dict;n.set("Checked",_primitives.Ref.get(314,0)),n.set("Off",_primitives.Ref.get(271,0)),t.set("N",n),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("AP",t);var i=_primitives.Ref.get(123,0),a=_primitives.Ref.get(456,0),o=new _primitives.Dict;o.set("V",_primitives.Name.get("Off")),o.set("Kids",[i]),u.set("Parent",a);var r=new _test_utils.XRefMock([{ref:i,data:u},{ref:a,data:o}]);o.xref=r,u.xref=r,x.xref=r;var s=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(r,i,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),Promise.all([t,t.save(x,s,e)])},e.fail).then(function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];expect(i.length).toEqual(2);var a=_slicedToArray(i,2),o=a[0],r=a[1];return o.data=o.data.replace(/\(D:[0-9]+\)/,"(date)"),expect(o.ref).toEqual(_primitives.Ref.get(123,0)),expect(o.data).toEqual("123 0 obj\n<< /Type /Annot /Subtype /Widget /FT /Btn /Ff 32768 /AP << /N << /Checked 314 0 R /Off 271 0 R>>>> /Parent 456 0 R /AS /Checked /M (date)>>\nendobj\n"),expect(r.ref).toEqual(_primitives.Ref.get(456,0)),expect(r.data).toEqual("456 0 obj\n<< /V /Checked /Kids [123 0 R]>>\nendobj\n"),n},e.fail).then(function(t){var e=new Map;return e.set(t.data.id,{value:!1}),t.save(x,s,e)},e.fail).then(function(t){expect(t).toEqual(null),e()},e.fail)}),it("should save radio buttons without a field value",function(r){var t=new _primitives.Dict,e=new _primitives.Dict;e.set("Checked",_primitives.Ref.get(314,0)),e.set("Off",_primitives.Ref.get(271,0)),t.set("N",e),u.set("Ff",_util.AnnotationFieldFlag.RADIO),u.set("AP",t);var n=_primitives.Ref.get(123,0),i=_primitives.Ref.get(456,0),a=new _primitives.Dict;a.set("Kids",[n]),u.set("Parent",i);var o=new _test_utils.XRefMock([{ref:n,data:u},{ref:i,data:a}]);a.xref=o,u.xref=o,x.xref=o;var s=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(o,n,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:!0}),Promise.all([t,t.save(x,s,e)])}).then(function(t){var e=_slicedToArray(t,2),n=(e[0],e[1]);expect(n.length).toEqual(2);var i=_slicedToArray(n,2),a=i[0],o=i[1];a.data=a.data.replace(/\(D:[0-9]+\)/,"(date)"),expect(a.ref).toEqual(_primitives.Ref.get(123,0)),expect(a.data).toEqual("123 0 obj\n<< /Type /Annot /Subtype /Widget /FT /Btn /Ff 32768 /AP << /N << /Checked 314 0 R /Off 271 0 R>>>> /Parent 456 0 R /AS /Checked /M (date)>>\nendobj\n"),expect(o.ref).toEqual(_primitives.Ref.get(456,0)),expect(o.data).toEqual("456 0 obj\n<< /Kids [123 0 R] /V /Checked>>\nendobj\n"),r()}).catch(r.fail)}),it("should save nothing",function(e){var t=_primitives.Ref.get(124,0),n=new _test_utils.XRefMock([{ref:t,data:u}]),i=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return t.save(x,i,e)}).then(function(t){expect(t).toEqual(null),e()}).catch(e.fail)}),it("should handle push buttons",function(n){var t=_primitives.Ref.get(124,0);u.set("Ff",_util.AnnotationFieldFlag.PUSHBUTTON);var e=new _primitives.Dict;e.set("S",_primitives.Name.get("JavaScript")),e.set("JS","do_something();"),u.set("A",e);var i=new _test_utils.XRefMock([{ref:t,data:u}]);_annotation.AnnotationFactory.create(i,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.pushButton).toEqual(!0),expect(e.actions.Action).toEqual(["do_something();"]),n()},n.fail)}),it("should handle push buttons that act as a tooltip only",function(n){var t=_primitives.Ref.get(124,0);u.set("Ff",_util.AnnotationFieldFlag.PUSHBUTTON),u.set("TU","An alternative text");var e=new _test_utils.XRefMock([{ref:t,data:u}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.pushButton).toEqual(!0),expect(e.alternativeText).toEqual("An alternative text"),n()},n.fail)}),it("should handle URL in A dict in push buttons",function(n){var t=_primitives.Ref.get(124,0);u.set("Ff",_util.AnnotationFieldFlag.PUSHBUTTON);var e=new _primitives.Dict;e.set("S",_primitives.Name.get("JavaScript")),e.set("JS","app.launchURL('https://developer.mozilla.org/en-US/', true)"),u.set("A",e);var i=new _test_utils.XRefMock([{ref:t,data:u}]);_annotation.AnnotationFactory.create(i,t,h,w).then(function(t){var e=t.data;expect(e.url).toEqual("https://developer.mozilla.org/en-US/"),n()},n.fail)}),it("should handle URL in AA dict in push buttons",function(n){var t=_primitives.Ref.get(124,0);u.set("Ff",_util.AnnotationFieldFlag.PUSHBUTTON);var e=new _primitives.Dict;e.set("S",_primitives.Name.get("JavaScript")),e.set("JS","app.launchURL('https://developer.mozilla.org/en-US/', true)");var i=new _primitives.Dict;i.set("D",e),u.set("AA",i);var a=new _test_utils.XRefMock([{ref:t,data:u}]);_annotation.AnnotationFactory.create(a,t,h,w).then(function(t){var e=t.data;expect(e.url).toEqual("https://developer.mozilla.org/en-US/"),n()},n.fail)})}),describe("ChoiceWidgetAnnotation",function(){var l,o;beforeEach(function(t){(l=new _primitives.Dict).set("Type",_primitives.Name.get("Annot")),l.set("Subtype",_primitives.Name.get("Widget")),l.set("FT",_primitives.Name.get("Ch"));var e=new _primitives.Dict;e.set("BaseFont",_primitives.Name.get("Helvetica")),e.set("Type",_primitives.Name.get("Font")),e.set("Subtype",_primitives.Name.get("Type1"));var n=_primitives.Ref.get(314,0);o={ref:n,data:e};var i=new _primitives.Dict,a=new _primitives.Dict;a.set("Helv",n),i.set("Font",a),l.set("DA","/Helv 5 Tf"),l.set("DR",i),l.set("Rect",[0,0,32,10]),t()}),afterEach(function(){l=o=null}),it("should handle missing option arrays",function(n){var t=_primitives.Ref.get(122,0),e=new _test_utils.XRefMock([{ref:t,data:l}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.options).toEqual([]),n()},n.fail)}),it("should handle option arrays with array elements",function(n){var t=_primitives.Ref.get(20,0),e=_primitives.Ref.get(10,0),i=["bar_export",t],a=[["foo_export","Foo"],e],o=[{exportValue:"foo_export",displayValue:"Foo"},{exportValue:"bar_export",displayValue:"Bar"}];l.set("Opt",a);var r=_primitives.Ref.get(123,0),s=new _test_utils.XRefMock([{ref:r,data:l},{ref:t,data:"Bar"},{ref:e,data:i}]);_annotation.AnnotationFactory.create(s,r,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.options).toEqual(o),n()},n.fail)}),it("should handle option arrays with string elements",function(n){var t=_primitives.Ref.get(10,0),e=["Foo",t],i=[{exportValue:"Foo",displayValue:"Foo"},{exportValue:"Bar",displayValue:"Bar"}];l.set("Opt",e);var a=_primitives.Ref.get(981,0),o=new _test_utils.XRefMock([{ref:a,data:l},{ref:t,data:"Bar"}]);_annotation.AnnotationFactory.create(o,a,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.options).toEqual(i),n()},n.fail)}),it("should handle inherited option arrays (issue 8094)",function(n){var i=[{exportValue:"Value1",displayValue:"Description1"},{exportValue:"Value2",displayValue:"Description2"}],t=new _primitives.Dict;t.set("Opt",[["Value1","Description1"],["Value2","Description2"]]),l.set("Parent",t);var e=_primitives.Ref.get(123,0),a=new _test_utils.XRefMock([{ref:e,data:l}]);_annotation.AnnotationFactory.create(a,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.options).toEqual(i),n()},n.fail)}),it("should decode form values",function(n){var t="þÿ\0F\0o\0o";l.set("Opt",[t]),l.set("V",t),l.set("DV",_primitives.Name.get("foo"));var e=_primitives.Ref.get(984,0),i=new _test_utils.XRefMock([{ref:e,data:l}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.fieldValue).toEqual(["Foo"]),expect(e.defaultFieldValue).toEqual("foo"),expect(e.options).toEqual([{exportValue:"Foo",displayValue:"Foo"}]),n()},n.fail)}),it("should convert the field value to an array",function(t){for(var i=[null,"Foo",["Foo","Bar"]],a=[[],["Foo"],["Foo","Bar"]],e=Promise.resolve(),n=function(n,t){e=e.then(function(){l.set("V",i[n]);var t=_primitives.Ref.get(968,0),e=new _test_utils.XRefMock([{ref:t,data:l}]);return _annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.fieldValue).toEqual(a[n])})})},o=0,r=i.length;o<r;o++)n(o);e.then(t,t.fail)}),it("should handle unknown flags",function(n){var t=_primitives.Ref.get(166,0),e=new _test_utils.XRefMock([{ref:t,data:l}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.readOnly).toEqual(!1),expect(e.hidden).toEqual(!1),expect(e.combo).toEqual(!1),expect(e.multiSelect).toEqual(!1),n()},n.fail)}),it("should not set invalid flags",function(n){l.set("Ff","readonly");var t=_primitives.Ref.get(165,0),e=new _test_utils.XRefMock([{ref:t,data:l}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.readOnly).toEqual(!1),expect(e.hidden).toEqual(!1),expect(e.combo).toEqual(!1),expect(e.multiSelect).toEqual(!1),n()},n.fail)}),it("should set valid flags",function(n){l.set("Ff",_util.AnnotationFieldFlag.READONLY+_util.AnnotationFieldFlag.COMBO+_util.AnnotationFieldFlag.MULTISELECT);var t=_primitives.Ref.get(512,0),e=new _test_utils.XRefMock([{ref:t,data:l}]);_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(e.readOnly).toEqual(!0),expect(e.hidden).toEqual(!1),expect(e.combo).toEqual(!0),expect(e.multiSelect).toEqual(!0),n()},n.fail)}),it("should render choice for printing",function(e){var t=_primitives.Ref.get(271,0),n=new _test_utils.XRefMock([{ref:t,data:l},o]),i=new _worker.WorkerTask("test print");x.xref=n,_annotation.AnnotationFactory.create(n,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"a value"}),t._getAppearance(x,i,e)},e.fail).then(function(t){expect(t).toEqual("/Tx BMC q BT /Helv 5 Tf 1 0 0 1 0 0 Tm 2.00 2.00 Td (a value) Tj ET Q EMC"),e()},e.fail)}),it("should save choice",function(a){l.set("Opt",["A","B","C"]),l.set("V","A");var t=_primitives.Ref.get(123,0),e=new _test_utils.XRefMock([{ref:t,data:l}]);x.xref=e;var n=new _worker.WorkerTask("test save");_annotation.AnnotationFactory.create(e,t,h,w).then(function(t){var e=new Map;return e.set(t.data.id,{value:"C"}),t.save(x,n,e)},a.fail).then(function(t){expect(t.length).toEqual(2);var e=_slicedToArray(t,2),n=e[0],i=e[1];expect(n.ref).toEqual(_primitives.Ref.get(123,0)),expect(i.ref).toEqual(_primitives.Ref.get(1,0)),n.data=n.data.replace(/\(D:[0-9]+\)/,"(date)"),expect(n.data).toEqual("123 0 obj\n<< /Type /Annot /Subtype /Widget /FT /Ch /DA (/Helv 5 Tf) /DR << /Font << /Helv 314 0 R>>>> /Rect [0 0 32 10] /Opt [(A) (B) (C)] /V (C) /AP << /N 1 0 R>> /M (date)>>\nendobj\n"),expect(i.data).toEqual("1 0 obj\n<< /Length 67 /Subtype /Form /Resources << /Font << /Helv 314 0 R>>>> /BBox [0 0 32 10]>> stream\n/Tx BMC q BT /Helv 5 Tf 1 0 0 1 0 0 Tm 2.00 2.00 Td (C) Tj ET Q EMC\nendstream\nendobj\n"),a()},a.fail)})}),describe("LineAnnotation",function(){it("should set the line coordinates",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Line")),t.set("L",[1,2,3,4]);var e=_primitives.Ref.get(122,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINE),expect(e.lineCoordinates).toEqual([1,2,3,4]),n()},n.fail)})}),describe("FileAttachmentAnnotation",function(){it("should correctly parse a file attachment",function(n){var t=new _stream.StringStream("<<\n/Type /EmbeddedFile\n/Subtype /text#2Fplain\n>>\nstream\nTest attachmentendstream\n"),e=new _parser.Parser({lexer:new _parser.Lexer(t),xref:null,allowStreams:!0}),i=_primitives.Ref.get(18,0),a=e.getObj(),o=new _primitives.Dict;o.set("F",i);var r=_primitives.Ref.get(19,0),s=new _primitives.Dict;s.set("Type",_primitives.Name.get("Filespec")),s.set("Desc",""),s.set("EF",o),s.set("UF","Test.txt");var l=_primitives.Ref.get(20,0),c=new _primitives.Dict;c.set("Type",_primitives.Name.get("Annot")),c.set("Subtype",_primitives.Name.get("FileAttachment")),c.set("FS",r),c.set("T","Topic"),c.set("Contents","Test.txt");var u=new _test_utils.XRefMock([{ref:i,data:a},{ref:r,data:s},{ref:l,data:c}]);o.assignXref(u),s.assignXref(u),c.assignXref(u),_annotation.AnnotationFactory.create(u,l,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.FILEATTACHMENT),expect(e.file.filename).toEqual("Test.txt"),expect(e.file.content).toEqual((0,_util.stringToBytes)("Test attachment")),n()},n.fail)})}),describe("PopupAnnotation",function(){it("should inherit properties from its parent",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Text")),t.set("M","D:20190423"),t.set("C",[0,0,1]);var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Popup")),e.set("Parent",t);var i=_primitives.Ref.get(13,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;t.viewable;expect(e.annotationType).toEqual(_util.AnnotationType.POPUP),expect(e.modificationDate).toEqual("D:20190423"),expect(e.color).toEqual(new Uint8ClampedArray([0,0,255])),n()},n.fail)}),it("should handle missing parent properties",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Text"));var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Popup")),e.set("Parent",t);var i=_primitives.Ref.get(13,0),a=new _test_utils.XRefMock([{ref:i,data:e}]);_annotation.AnnotationFactory.create(a,i,h,w).then(function(t){var e=t.data;t.viewable;expect(e.annotationType).toEqual(_util.AnnotationType.POPUP),expect(e.modificationDate).toEqual(null),expect(e.color).toEqual(null),n()},n.fail)}),it("should inherit the parent flags when the Popup is not viewable, but the parent is (PR 7352)",function(i){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Text")),t.set("F",28);var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Popup")),e.set("F",25),e.set("Parent",t);var n=_primitives.Ref.get(13,0),a=new _test_utils.XRefMock([{ref:n,data:e}]);_annotation.AnnotationFactory.create(a,n,h,w).then(function(t){var e=t.data,n=t.viewable;expect(e.annotationType).toEqual(_util.AnnotationType.POPUP),expect(e.annotationFlags).toEqual(25),expect(n).toEqual(!0),i()},i.fail)}),it("should correctly inherit Contents from group-master annotation if parent has ReplyType == Group",function(n){var t=_primitives.Ref.get(819,0),e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Text")),e.set("T","Correct Title"),e.set("Contents","Correct Text"),e.set("M","D:20190423"),e.set("C",[0,0,1]);var i=_primitives.Ref.get(820,0),a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Text")),a.set("IRT",t),a.set("RT",_primitives.Name.get("Group")),a.set("T","Reply Title"),a.set("Contents","Reply Text"),a.set("M","D:20190523"),a.set("C",[.4]);var o=_primitives.Ref.get(821,0),r=new _primitives.Dict;r.set("Type",_primitives.Name.get("Annot")),r.set("Subtype",_primitives.Name.get("Popup")),r.set("T","Wrong Title"),r.set("Contents","Wrong Text"),r.set("Parent",i),r.set("M","D:20190623"),r.set("C",[.8]),a.set("Popup",o);var s=new _test_utils.XRefMock([{ref:t,data:e},{ref:i,data:a},{ref:o,data:r}]);e.assignXref(s),r.assignXref(s),a.assignXref(s),_annotation.AnnotationFactory.create(s,o,h,w).then(function(t){var e=t.data;expect(e.title).toEqual("Correct Title"),expect(e.contents).toEqual("Correct Text"),expect(e.modificationDate).toEqual("D:20190423"),expect(e.color).toEqual(new Uint8ClampedArray([0,0,255])),n()},n.fail)})}),describe("InkAnnotation",function(){it("should handle a single ink list",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Ink")),t.set("InkList",[[1,1,1,2,2,2,3,3]]);var e=_primitives.Ref.get(142,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.INK),expect(e.inkLists.length).toEqual(1),expect(e.inkLists[0]).toEqual([{x:1,y:1},{x:1,y:2},{x:2,y:2},{x:3,y:3}]),n()},n.fail)}),it("should handle multiple ink lists",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Ink")),t.set("InkList",[[1,1,1,2],[3,3,4,5]]);var e=_primitives.Ref.get(143,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.INK),expect(e.inkLists.length).toEqual(2),expect(e.inkLists[0]).toEqual([{x:1,y:1},{x:1,y:2}]),expect(e.inkLists[1]).toEqual([{x:3,y:3},{x:4,y:5}]),n()},n.fail)})}),describe("HightlightAnnotation",function(){it("should set quadpoints to null if not defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Highlight"));var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.HIGHLIGHT),expect(e.quadPoints).toEqual(null),n()},n.fail)}),it("should set quadpoints if defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Highlight")),t.set("Rect",[10,10,20,20]),t.set("QuadPoints",[10,20,20,20,10,10,20,10]);var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.HIGHLIGHT),expect(e.quadPoints).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}]]),n()},n.fail)}),it("should set quadpoints to null when empty",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Highlight")),t.set("Rect",[10,10,20,20]),t.set("QuadPoints",[]);var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.HIGHLIGHT),expect(e.quadPoints).toEqual(null),n()},n.fail)})}),describe("UnderlineAnnotation",function(){it("should set quadpoints to null if not defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Underline"));var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.UNDERLINE),expect(e.quadPoints).toEqual(null),n()},n.fail)}),it("should set quadpoints if defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Underline")),t.set("Rect",[10,10,20,20]),t.set("QuadPoints",[10,20,20,20,10,10,20,10]);var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.UNDERLINE),expect(e.quadPoints).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}]]),n()},n.fail)})}),describe("SquigglyAnnotation",function(){it("should set quadpoints to null if not defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Squiggly"));var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.SQUIGGLY),expect(e.quadPoints).toEqual(null),n()},n.fail)}),it("should set quadpoints if defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Squiggly")),t.set("Rect",[10,10,20,20]),t.set("QuadPoints",[10,20,20,20,10,10,20,10]);var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.SQUIGGLY),expect(e.quadPoints).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}]]),n()},n.fail)})}),describe("StrikeOutAnnotation",function(){it("should set quadpoints to null if not defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("StrikeOut"));var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.STRIKEOUT),expect(e.quadPoints).toEqual(null),n()},n.fail)}),it("should set quadpoints if defined",function(n){var t=new _primitives.Dict;t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("StrikeOut")),t.set("Rect",[10,10,20,20]),t.set("QuadPoints",[10,20,20,20,10,10,20,10]);var e=_primitives.Ref.get(121,0),i=new _test_utils.XRefMock([{ref:e,data:t}]);_annotation.AnnotationFactory.create(i,e,h,w).then(function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.STRIKEOUT),expect(e.quadPoints).toEqual([[{x:10,y:20},{x:20,y:20},{x:10,y:10},{x:20,y:10}]]),n()},n.fail)})})});