"use strict";var _cmap=require("../../core/cmap.js"),_test_utils=require("./test_utils.js"),_api=require("../../display/api.js"),_primitives=require("../../core/primitives.js"),_stream=require("../../core/stream.js");describe("cmap",function(){var a;beforeAll(function(e){var t=new _api.DefaultCMapReaderFactory({baseUrl:_test_utils.CMAP_PARAMS.cMapUrl,isCompressed:_test_utils.CMAP_PARAMS.cMapPacked});a=function(e){return t.fetch({name:e})},e()}),afterAll(function(){a=null}),it("parses beginbfchar",function(t){var e=new _stream.StringStream("2 beginbfchar\n<03> <00>\n<04> <01>\nendbfchar\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.lookup(3)).toEqual(String.fromCharCode(0)),expect(e.lookup(4)).toEqual(String.fromCharCode(1)),expect(e.lookup(5)).toBeUndefined(),t()}).catch(function(e){t.fail(e)})}),it("parses beginbfrange with range",function(t){var e=new _stream.StringStream("1 beginbfrange\n<06> <0B> 0\nendbfrange\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.lookup(5)).toBeUndefined(),expect(e.lookup(6)).toEqual(String.fromCharCode(0)),expect(e.lookup(11)).toEqual(String.fromCharCode(5)),expect(e.lookup(12)).toBeUndefined(),t()}).catch(function(e){t.fail(e)})}),it("parses beginbfrange with array",function(t){var e=new _stream.StringStream("1 beginbfrange\n<0D> <12> [ 0 1 2 3 4 5 ]\nendbfrange\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.lookup(12)).toBeUndefined(),expect(e.lookup(13)).toEqual(0),expect(e.lookup(18)).toEqual(5),expect(e.lookup(19)).toBeUndefined(),t()}).catch(function(e){t.fail(e)})}),it("parses begincidchar",function(t){var e=new _stream.StringStream("1 begincidchar\n<14> 0\nendcidchar\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.lookup(20)).toEqual(0),expect(e.lookup(21)).toBeUndefined(),t()}).catch(function(e){t.fail(e)})}),it("parses begincidrange",function(t){var e=new _stream.StringStream("1 begincidrange\n<0016> <001B>   0\nendcidrange\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.lookup(21)).toBeUndefined(),expect(e.lookup(22)).toEqual(0),expect(e.lookup(27)).toEqual(5),expect(e.lookup(28)).toBeUndefined(),t()}).catch(function(e){t.fail(e)})}),it("decodes codespace ranges",function(a){var e=new _stream.StringStream("1 begincodespacerange\n<01> <02>\n<00000003> <00000004>\nendcodespacerange\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){var t={};e.readCharCode(String.fromCharCode(1),0,t),expect(t.charcode).toEqual(1),expect(t.length).toEqual(1),e.readCharCode(String.fromCharCode(0,0,0,3),0,t),expect(t.charcode).toEqual(3),expect(t.length).toEqual(4),a()}).catch(function(e){a.fail(e)})}),it("decodes 4 byte codespace ranges",function(a){var e=new _stream.StringStream("1 begincodespacerange\n<8EA1A1A1> <8EA1FEFE>\nendcodespacerange\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){var t={};e.readCharCode(String.fromCharCode(142,161,161,161),0,t),expect(t.charcode).toEqual(2392957345),expect(t.length).toEqual(4),a()}).catch(function(e){a.fail(e)})}),it("read usecmap",function(t){var e=new _stream.StringStream("/Adobe-Japan1-1 usecmap\n");_cmap.CMapFactory.create({encoding:e,fetchBuiltInCMap:a,useCMap:null}).then(function(e){expect(e instanceof _cmap.CMap).toEqual(!0),expect(e.useCMap).not.toBeNull(),expect(e.builtInCMap).toBeFalsy(),expect(e.length).toEqual(8359),expect(e.isIdentityCMap).toEqual(!1),t()}).catch(function(e){t.fail(e)})}),it("parses cmapname",function(t){var e=new _stream.StringStream("/CMapName /Identity-H def\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.name).toEqual("Identity-H"),t()}).catch(function(e){t.fail(e)})}),it("parses wmode",function(t){var e=new _stream.StringStream("/WMode 1 def\n");_cmap.CMapFactory.create({encoding:e}).then(function(e){expect(e.vertical).toEqual(!0),t()}).catch(function(e){t.fail(e)})}),it("loads built in cmap",function(t){_cmap.CMapFactory.create({encoding:_primitives.Name.get("Adobe-Japan1-1"),fetchBuiltInCMap:a,useCMap:null}).then(function(e){expect(e instanceof _cmap.CMap).toEqual(!0),expect(e.useCMap).toBeNull(),expect(e.builtInCMap).toBeTruthy(),expect(e.length).toEqual(8359),expect(e.isIdentityCMap).toEqual(!1),t()}).catch(function(e){t.fail(e)})}),it("loads built in identity cmap",function(t){_cmap.CMapFactory.create({encoding:_primitives.Name.get("Identity-H"),fetchBuiltInCMap:a,useCMap:null}).then(function(e){expect(e instanceof _cmap.IdentityCMap).toEqual(!0),expect(e.vertical).toEqual(!1),expect(e.length).toEqual(65536),expect(function(){return e.isIdentityCMap}).toThrow(new Error("should not access .isIdentityCMap")),t()}).catch(function(e){t.fail(e)})}),it("attempts to load a non-existent built-in CMap",function(t){_cmap.CMapFactory.create({encoding:_primitives.Name.get("null"),fetchBuiltInCMap:a,useCMap:null}).then(function(){t.fail("No CMap should be loaded")},function(e){expect(e instanceof Error).toEqual(!0),expect(e.message).toEqual("Unknown CMap name: null"),t()})}),it("attempts to load a built-in CMap without the necessary API parameters",function(t){_cmap.CMapFactory.create({encoding:_primitives.Name.get("Adobe-Japan1-1"),fetchBuiltInCMap:function(e){return new _api.DefaultCMapReaderFactory({}).fetch({name:e})},useCMap:null}).then(function(){t.fail("No CMap should be loaded")},function(e){expect(e instanceof Error).toEqual(!0),expect(e.message).toEqual('The CMap "baseUrl" parameter must be specified, ensure that the "cMapUrl" and "cMapPacked" API parameters are provided.'),t()})}),it("attempts to load a built-in CMap with inconsistent API parameters",function(a){_cmap.CMapFactory.create({encoding:_primitives.Name.get("Adobe-Japan1-1"),fetchBuiltInCMap:function(e){return new _api.DefaultCMapReaderFactory({baseUrl:_test_utils.CMAP_PARAMS.cMapUrl,isCompressed:!1}).fetch({name:e})},useCMap:null}).then(function(){a.fail("No CMap should be loaded")},function(e){expect(e instanceof Error).toEqual(!0);var t=e.message;expect(t.startsWith("Unable to load CMap at: ")).toEqual(!0),expect(t.endsWith("/external/bcmaps/Adobe-Japan1-1")).toEqual(!0),a()})})});