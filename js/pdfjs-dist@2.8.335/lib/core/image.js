"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _regeneratorRuntime(){_regeneratorRuntime=function(){return a};var a={},e=Object.prototype,u=e.hasOwnProperty,l=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",i=t.toStringTag||"@@toStringTag";function o(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{o({},"")}catch(e){o=function(e,t,r){return e[t]=r}}function s(e,t,r,i){var o,a,s,c,n=t&&t.prototype instanceof m?t:m,h=Object.create(n.prototype),u=new P(i||[]);return l(h,"_invoke",{value:(o=e,a=r,s=u,c="suspendedStart",function(e,t){if("executing"===c)throw new Error("Generator is already running");if("completed"===c){if("throw"===e)throw t;return S()}for(s.method=e,s.arg=t;;){var r=s.delegate;if(r){var i=k(r,s);if(i){if(i===d)continue;return i}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===c)throw c="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);c="executing";var n=f(o,a,s);if("normal"===n.type){if(c=s.done?"completed":"suspendedYield",n.arg===d)continue;return{value:n.arg,done:s.done}}"throw"===n.type&&(c="completed",s.method="throw",s.arg=n.arg)}})}),h}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}a.wrap=s;var d={};function m(){}function c(){}function h(){}var p={};o(p,n,function(){return this});var g=Object.getPrototypeOf,v=g&&g(g(I([])));v&&v!==e&&u.call(v,n)&&(p=v);var y=h.prototype=m.prototype=Object.create(p);function w(e){["next","throw","return"].forEach(function(t){o(e,t,function(e){return this._invoke(t,e)})})}function _(c,h){var t;l(this,"_invoke",{value:function(r,i){function e(){return new h(function(e,t){!function t(e,r,i,n){var o=f(c[e],c,r);if("throw"!==o.type){var a=o.arg,s=a.value;return s&&"object"==_typeof(s)&&u.call(s,"__await")?h.resolve(s.__await).then(function(e){t("next",e,i,n)},function(e){t("throw",e,i,n)}):h.resolve(s).then(function(e){a.value=e,i(a)},function(e){return t("throw",e,i,n)})}n(o.arg)}(r,i,e,t)})}return t=t?t.then(e,e):e()}})}function k(e,t){var r=t.method,i=e.iterator[r];if(void 0===i)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var n=f(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,d;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function C(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function I(t){if(t){var e=t[n];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function e(){for(;++r<t.length;)if(u.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:S}}function S(){return{value:void 0,done:!0}}return l(y,"constructor",{value:c.prototype=h,configurable:!0}),l(h,"constructor",{value:c,configurable:!0}),c.displayName=o(h,i,"GeneratorFunction"),a.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===c||"GeneratorFunction"===(t.displayName||t.name))},a.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,o(e,i,"GeneratorFunction")),e.prototype=Object.create(y),e},a.awrap=function(e){return{__await:e}},w(_.prototype),o(_.prototype,r,function(){return this}),a.AsyncIterator=_,a.async=function(e,t,r,i,n){void 0===n&&(n=Promise);var o=new _(s(e,t,r,i),n);return a.isGeneratorFunction(t)?o:o.next().then(function(e){return e.done?e.value:o.next()})},w(y),o(y,i,"Generator"),o(y,n,function(){return this}),o(y,"toString",function(){return"[object Generator]"}),a.keys=function(e){var r=Object(e),i=[];for(var t in r)i.push(t);return i.reverse(),function e(){for(;i.length;){var t=i.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},a.values=I,P.prototype={constructor:P,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(C),!e)for(var t in this)"t"===t.charAt(0)&&u.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var i=this;function e(e,t){return o.type="throw",o.arg=r,i.next=e,t&&(i.method="next",i.arg=void 0),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t],o=n.completion;if("root"===n.tryLoc)return e("end");if(n.tryLoc<=this.prev){var a=u.call(n,"catchLoc"),s=u.call(n,"finallyLoc");if(a&&s){if(this.prev<n.catchLoc)return e(n.catchLoc,!0);if(this.prev<n.finallyLoc)return e(n.finallyLoc)}else if(a){if(this.prev<n.catchLoc)return e(n.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return e(n.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&u.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var o=n?n.completion:{};return o.type=e,o.arg=t,n?(this.method="next",this.next=n.finallyLoc,d):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),C(r),d}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var n=i.arg;C(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:I(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),d}},a}function asyncGeneratorStep(e,t,r,i,n,o,a){try{var s=e[o](a),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(i,n)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,r){var i=s.apply(e,a);function n(e){asyncGeneratorStep(i,t,r,n,o,"next",e)}function o(e){asyncGeneratorStep(i,t,r,n,o,"throw",e)}n(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var i=r.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFImage=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_colorspace=require("./colorspace.js"),_stream=require("./stream.js"),_jpeg_stream=require("./jpeg_stream.js"),_jpx=require("./jpx.js");function decodeAndClamp(e,t,r,i){return(e=t+e*r)<0?e=0:i<e&&(e=i),e}function resizeImageMask(e,t,r,i,n,o){var a,s=n*o;a=t<=8?new Uint8Array(s):t<=16?new Uint16Array(s):new Uint32Array(s);var c,h,u,l,f=r/n,d=i/o,m=0,p=new Uint16Array(n),g=r;for(c=0;c<n;c++)p[c]=Math.floor(c*f);for(c=0;c<o;c++)for(u=Math.floor(c*d)*g,h=0;h<n;h++)l=u+p[h],a[m++]=e[l];return a}var PDFImage=function(){function x(e){var t=e.xref,r=e.res,i=e.image,n=e.isInline,o=void 0!==n&&n,a=e.smask,s=void 0===a?null:a,c=e.mask,h=void 0===c?null:c,u=e.isMask,l=void 0!==u&&u,f=e.pdfFunctionFactory,d=e.localColorSpaceCache;_classCallCheck(this,x);var m=(this.image=i).dict,p=m.get("Filter");if((0,_primitives.isName)(p))switch(p.name){case"JPXDecode":var g=new _jpx.JpxImage;g.parseImageProperties(i.stream),i.stream.reset(),i.width=g.width,i.height=g.height,i.bitsPerComponent=g.bitsPerComponent,i.numComps=g.componentsCount;break;case"JBIG2Decode":i.bitsPerComponent=1,i.numComps=1}var v=m.get("Width","W"),y=m.get("Height","H");if(Number.isInteger(i.width)&&0<i.width&&Number.isInteger(i.height)&&0<i.height&&(i.width!==v||i.height!==y)&&((0,_util.warn)("PDFImage - using the Width/Height of the image data, rather than the image dictionary."),v=i.width,y=i.height),v<1||y<1)throw new _util.FormatError("Invalid image width: ".concat(v," or height: ").concat(y));this.width=v,this.height=y,this.interpolate=m.get("Interpolate","I")||!1,this.imageMask=m.get("ImageMask","IM")||!1,this.matte=m.get("Matte")||!1;var w=i.bitsPerComponent;if(!w&&!(w=m.get("BitsPerComponent","BPC"))){if(!this.imageMask)throw new _util.FormatError("Bits per component missing in image: ".concat(this.imageMask));w=1}if(this.bpc=w,!this.imageMask){var _=m.getRaw("ColorSpace")||m.getRaw("CS");if(!_)switch((0,_util.info)("JPX images (which do not require color spaces)"),i.numComps){case 1:_=_primitives.Name.get("DeviceGray");break;case 3:_=_primitives.Name.get("DeviceRGB");break;case 4:_=_primitives.Name.get("DeviceCMYK");break;default:throw new Error("JPX images with ".concat(i.numComps," ")+"color components not supported.")}this.colorSpace=_colorspace.ColorSpace.parse({cs:_,xref:t,resources:o?r:null,pdfFunctionFactory:f,localColorSpaceCache:d}),this.numComps=this.colorSpace.numComps}if(this.decode=m.getArray("Decode","D"),this.needsDecode=!1,this.decode&&(this.colorSpace&&!this.colorSpace.isDefaultDecode(this.decode,w)||l&&!_colorspace.ColorSpace.isDefaultDecode(this.decode,1))){this.needsDecode=!0;var k=(1<<w)-1;this.decodeCoefficients=[],this.decodeAddends=[];for(var b=this.colorSpace&&"Indexed"===this.colorSpace.name,C=0,P=0;C<this.decode.length;C+=2,++P){var I=this.decode[C],S=this.decode[C+1];this.decodeCoefficients[P]=b?(S-I)/k:S-I,this.decodeAddends[P]=b?I:k*I}}if(s)this.smask=new x({xref:t,res:r,image:s,isInline:o,pdfFunctionFactory:f,localColorSpaceCache:d});else if(h){if((0,_primitives.isStream)(h))h.dict.get("ImageMask","IM")?this.mask=new x({xref:t,res:r,image:h,isInline:o,isMask:!0,pdfFunctionFactory:f,localColorSpaceCache:d}):(0,_util.warn)("Ignoring /Mask in image without /ImageMask.");else this.mask=h}}var t;return _createClass(x,[{key:"drawWidth",get:function(){return Math.max(this.width,this.smask&&this.smask.width||0,this.mask&&this.mask.width||0)}},{key:"drawHeight",get:function(){return Math.max(this.height,this.smask&&this.smask.height||0,this.mask&&this.mask.height||0)}},{key:"decodeBuffer",value:function(e){var t,r,i=this.bpc,n=this.numComps,o=this.decodeAddends,a=this.decodeCoefficients,s=(1<<i)-1;if(1!==i){var c=0;for(t=0,r=this.width*this.height;t<r;t++)for(var h=0;h<n;h++)e[c]=decodeAndClamp(e[c],o[h],a[h],s),c++}else for(t=0,r=e.length;t<r;t++)e[t]=+!e[t]}},{key:"getComponents",value:function(e){var t=this.bpc;if(8===t)return e;var r,i=this.width,n=this.height,o=this.numComps,a=i*n*o,s=0;r=t<=8?new Uint8Array(a):t<=16?new Uint16Array(a):new Uint32Array(a);var c,h,u=i*o,l=(1<<t)-1,f=0;if(1===t)for(var d,m,p,g=0;g<n;g++){for(m=f+(-8&u),p=f+u;f<m;)h=e[s++],r[f]=h>>7&1,r[f+1]=h>>6&1,r[f+2]=h>>5&1,r[f+3]=h>>4&1,r[f+4]=h>>3&1,r[f+5]=h>>2&1,r[f+6]=h>>1&1,r[f+7]=1&h,f+=8;if(f<p)for(h=e[s++],d=128;f<p;)r[f++]=+!!(h&d),d>>=1}else{var v=0;for(f=h=0,c=a;f<c;++f){for(f%u==0&&(v=h=0);v<t;)h=h<<8|e[s++],v+=8;var y=v-t,w=h>>y;w<0?w=0:l<w&&(w=l),r[f]=w,h&=(1<<y)-1,v=y}}return r}},{key:"fillOpacity",value:function(e,t,r,i,n){var o,a,s,c,h,u,l=this.smask,f=this.mask;if(l)a=l.width,s=l.height,o=new Uint8ClampedArray(a*s),l.fillGrayBuffer(o),a===t&&s===r||(o=resizeImageMask(o,l.bpc,a,s,t,r));else if(f)if(f instanceof x){for(a=f.width,s=f.height,o=new Uint8ClampedArray(a*s),f.numComps=1,f.fillGrayBuffer(o),c=0,h=a*s;c<h;++c)o[c]=255-o[c];a===t&&s===r||(o=resizeImageMask(o,f.bpc,a,s,t,r))}else{if(!Array.isArray(f))throw new _util.FormatError("Unknown mask format.");o=new Uint8ClampedArray(t*r);var d=this.numComps;for(c=0,h=t*r;c<h;++c){var m=0,p=c*d;for(u=0;u<d;++u){var g=n[p+u],v=2*u;if(g<f[v]||g>f[v+1]){m=255;break}}o[c]=m}}if(o)for(c=0,u=3,h=t*i;c<h;++c,u+=4)e[u]=o[c];else for(c=0,u=3,h=t*i;c<h;++c,u+=4)e[u]=255}},{key:"undoPreblend",value:function(e,t,r){var i=this.smask&&this.smask.matte;if(i)for(var n=this.colorSpace.getRgb(i,0),o=n[0],a=n[1],s=n[2],c=t*r*4,h=0;h<c;h+=4){var u=e[h+3];if(0!==u){var l=255/u;e[h]=(e[h]-o)*l+o,e[h+1]=(e[h+1]-a)*l+a,e[h+2]=(e[h+2]-s)*l+s}else e[h]=255,e[h+1]=255,e[h+2]=255}}},{key:"createImageData",value:function(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=this.drawWidth,i=this.drawHeight,n={width:r,height:i,kind:0,data:null},o=this.numComps,a=this.width,s=this.height,c=this.bpc,h=a*o*c+7>>3;if(!t){var u;if("DeviceGray"===this.colorSpace.name&&1===c?u=_util.ImageKind.GRAYSCALE_1BPP:"DeviceRGB"!==this.colorSpace.name||8!==c||this.needsDecode||(u=_util.ImageKind.RGB_24BPP),u&&!this.smask&&!this.mask&&r===a&&i===s){if(n.kind=u,e=this.getImageBytes(s*h),this.image instanceof _stream.DecodeStream)n.data=e;else{var l=new Uint8ClampedArray(e.length);l.set(e),n.data=l}if(this.needsDecode){(0,_util.assert)(u===_util.ImageKind.GRAYSCALE_1BPP,"PDFImage.createImageData: The image must be grayscale.");for(var f=n.data,d=0,m=f.length;d<m;d++)f[d]^=255}return n}if(this.image instanceof _jpeg_stream.JpegStream&&!this.smask&&!this.mask){var p=s*h;switch(this.colorSpace.name){case"DeviceGray":p*=3;case"DeviceRGB":case"DeviceCMYK":return n.kind=_util.ImageKind.RGB_24BPP,n.data=this.getImageBytes(p,r,i,!0),n}}}var g,v,y=0|(e=this.getImageBytes(s*h)).length/h*i/s,w=this.getComponents(e);return t||this.smask||this.mask?(n.kind=_util.ImageKind.RGBA_32BPP,n.data=new Uint8ClampedArray(r*i*4),g=1,v=!0,this.fillOpacity(n.data,r,i,y,w)):(n.kind=_util.ImageKind.RGB_24BPP,n.data=new Uint8ClampedArray(r*i*3),g=0,v=!1),this.needsDecode&&this.decodeBuffer(w),this.colorSpace.fillRgb(n.data,a,s,r,i,y,c,w,g),v&&this.undoPreblend(n.data,r,y),n}},{key:"fillGrayBuffer",value:function(e){var t=this.numComps;if(1!==t)throw new _util.FormatError("Reading gray scale from a color image: ".concat(t));var r,i,n=this.width,o=this.height,a=this.bpc,s=n*t*a+7>>3,c=this.getImageBytes(o*s),h=this.getComponents(c);if(1!==a){this.needsDecode&&this.decodeBuffer(h),i=n*o;var u=255/((1<<a)-1);for(r=0;r<i;++r)e[r]=u*h[r]}else if(i=n*o,this.needsDecode)for(r=0;r<i;++r)e[r]=h[r]-1&255;else for(r=0;r<i;++r)e[r]=255&-h[r]}},{key:"getImageBytes",value:function(e,t,r){var i=3<arguments.length&&void 0!==arguments[3]&&arguments[3];return this.image.reset(),this.image.drawWidth=t||this.width,this.image.drawHeight=r||this.height,this.image.forceRGB=!!i,this.image.getBytes(e,!0)}}],[{key:"buildImage",value:(t=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var r,i,n,o,a,s,c,h,u,l,f,d;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.xref,i=t.res,n=t.image,o=t.isInline,a=void 0!==o&&o,s=t.pdfFunctionFactory,c=t.localColorSpaceCache,l=u=null,f=(h=n).dict.get("SMask"),d=n.dict.get("Mask"),f?u=f:d&&((0,_primitives.isStream)(d)||Array.isArray(d)?l=d:(0,_util.warn)("Unsupported mask format.")),e.abrupt("return",new x({xref:r,res:i,image:h,isInline:a,smask:u,mask:l,pdfFunctionFactory:s,localColorSpaceCache:c}));case 8:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})},{key:"createMask",value:function(e){var t,r,i=e.imgArray,n=e.width,o=e.height,a=e.imageIsFromDecodeStream,s=e.inverseDecode,c=(n+7>>3)*o,h=i.byteLength;if(!a||s&&!(c===h))if(s)for((t=new Uint8ClampedArray(c)).set(i),r=h;r<c;r++)t[r]=255;else(t=new Uint8ClampedArray(h)).set(i);else t=i;if(s)for(r=0;r<h;r++)t[r]^=255;return{data:t,width:n,height:o}}}]),x}();exports.PDFImage=PDFImage;