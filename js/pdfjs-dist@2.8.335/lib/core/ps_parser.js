"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,_toPropertyKey(o.key),o)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);var o=r.call(t,e||"default");if("object"!==_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PostScriptParser=exports.PostScriptLexer=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),PostScriptParser=function(){function e(t){_classCallCheck(this,e),this.lexer=t,this.operators=[],this.token=null,this.prev=null}return _createClass(e,[{key:"nextToken",value:function(){this.prev=this.token,this.token=this.lexer.getToken()}},{key:"accept",value:function(t){return this.token.type===t&&(this.nextToken(),!0)}},{key:"expect",value:function(t){if(this.accept(t))return!0;throw new _util.FormatError("Unexpected symbol: found ".concat(this.token.type," expected ").concat(t,"."))}},{key:"parse",value:function(){return this.nextToken(),this.expect(PostScriptTokenTypes.LBRACE),this.parseBlock(),this.expect(PostScriptTokenTypes.RBRACE),this.operators}},{key:"parseBlock",value:function(){for(;;)if(this.accept(PostScriptTokenTypes.NUMBER))this.operators.push(this.prev.value);else if(this.accept(PostScriptTokenTypes.OPERATOR))this.operators.push(this.prev.value);else{if(!this.accept(PostScriptTokenTypes.LBRACE))return;this.parseCondition()}}},{key:"parseCondition",value:function(){var t=this.operators.length;if(this.operators.push(null,null),this.parseBlock(),this.expect(PostScriptTokenTypes.RBRACE),this.accept(PostScriptTokenTypes.IF))this.operators[t]=this.operators.length,this.operators[t+1]="jz";else{if(!this.accept(PostScriptTokenTypes.LBRACE))throw new _util.FormatError("PS Function: error parsing conditional.");var e=this.operators.length;this.operators.push(null,null);var r=this.operators.length;this.parseBlock(),this.expect(PostScriptTokenTypes.RBRACE),this.expect(PostScriptTokenTypes.IFELSE),this.operators[e]=this.operators.length,this.operators[e+1]="j",this.operators[t]=r,this.operators[t+1]="jz"}}}]),e}();exports.PostScriptParser=PostScriptParser;var PostScriptTokenTypes={LBRACE:0,RBRACE:1,NUMBER:2,OPERATOR:3,IF:4,IFELSE:5},PostScriptToken=function(){var o=Object.create(null);return function(){function r(t,e){_classCallCheck(this,r),this.type=t,this.value=e}return _createClass(r,null,[{key:"getOperator",value:function(t){var e=o[t];return e||(o[t]=new r(PostScriptTokenTypes.OPERATOR,t))}},{key:"LBRACE",get:function(){return(0,_util.shadow)(this,"LBRACE",new r(PostScriptTokenTypes.LBRACE,"{"))}},{key:"RBRACE",get:function(){return(0,_util.shadow)(this,"RBRACE",new r(PostScriptTokenTypes.RBRACE,"}"))}},{key:"IF",get:function(){return(0,_util.shadow)(this,"IF",new r(PostScriptTokenTypes.IF,"IF"))}},{key:"IFELSE",get:function(){return(0,_util.shadow)(this,"IFELSE",new r(PostScriptTokenTypes.IFELSE,"IFELSE"))}}]),r}()}(),PostScriptLexer=function(){function e(t){_classCallCheck(this,e),this.stream=t,this.nextChar(),this.strBuf=[]}return _createClass(e,[{key:"nextChar",value:function(){return this.currentChar=this.stream.getByte()}},{key:"getToken",value:function(){for(var t=!1,e=this.currentChar;;){if(e<0)return _primitives.EOF;if(t)10!==e&&13!==e||(t=!1);else if(37===e)t=!0;else if(!(0,_core_utils.isWhiteSpace)(e))break;e=this.nextChar()}switch(0|e){case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 43:case 45:case 46:return new PostScriptToken(PostScriptTokenTypes.NUMBER,this.getNumber());case 123:return this.nextChar(),PostScriptToken.LBRACE;case 125:return this.nextChar(),PostScriptToken.RBRACE}var r=this.strBuf;for(r.length=0,r[0]=String.fromCharCode(e);0<=(e=this.nextChar())&&(65<=e&&e<=90||97<=e&&e<=122);)r.push(String.fromCharCode(e));var o=r.join("");switch(o.toLowerCase()){case"if":return PostScriptToken.IF;case"ifelse":return PostScriptToken.IFELSE;default:return PostScriptToken.getOperator(o)}}},{key:"getNumber",value:function(){var t=this.currentChar,e=this.strBuf;for(e.length=0,e[0]=String.fromCharCode(t);0<=(t=this.nextChar())&&(48<=t&&t<=57||45===t||46===t);)e.push(String.fromCharCode(t));var r=parseFloat(e.join(""));if(isNaN(r))throw new _util.FormatError("Invalid floating point number: ".concat(r));return r}}]),e}();exports.PostScriptLexer=PostScriptLexer;