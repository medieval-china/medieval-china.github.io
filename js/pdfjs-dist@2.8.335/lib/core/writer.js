"use strict";function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,a,i,o,u=[],l=!0,c=!1;try{if(i=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;l=!1}else for(;!(l=(n=i.call(t)).done)&&(u.push(n.value),u.length!==r);l=!0);}catch(e){c=!0,a=e}finally{try{if(!l&&null!=t.return&&(o=t.return(),Object(o)!==o))return}finally{if(c)throw a}}return u}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==t.return||t.return()}finally{if(u)throw i}}}}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}Object.defineProperty(exports,"__esModule",{value:!0}),exports.incrementalUpdate=incrementalUpdate,exports.writeDict=writeDict;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_xml_parser=require("./xml_parser.js"),_crypto=require("./crypto.js");function writeDict(e,r,t){r.push("<<");var n,a=_createForOfIteratorHelper(e.getKeys());try{for(a.s();!(n=a.n()).done;){var i=n.value;r.push(" /".concat((0,_core_utils.escapePDFName)(i)," ")),writeValue(e.getRaw(i),r,t)}}catch(e){a.e(e)}finally{a.f()}r.push(">>")}function writeStream(e,r,t){writeDict(e.dict,r,t),r.push(" stream\n");var n=(0,_util.bytesToString)(e.getBytes());null!==t&&(n=t.encryptString(n)),r.push(n),r.push("\nendstream\n")}function writeArray(e,r,t){r.push("[");var n,a=!0,i=_createForOfIteratorHelper(e);try{for(i.s();!(n=i.n()).done;){var o=n.value;a?a=!1:r.push(" "),writeValue(o,r,t)}}catch(e){i.e(e)}finally{i.f()}r.push("]")}function numberToString(e){if(Number.isInteger(e))return e.toString();var r=Math.round(100*e);return r%100==0?(r/100).toString():r%10==0?e.toFixed(1):e.toFixed(2)}function writeValue(e,r,t){(0,_primitives.isName)(e)?r.push("/".concat((0,_core_utils.escapePDFName)(e.name))):(0,_primitives.isRef)(e)?r.push("".concat(e.num," ").concat(e.gen," R")):Array.isArray(e)?writeArray(e,r,t):"string"==typeof e?(null!==t&&(e=t.encryptString(e)),r.push("(".concat((0,_util.escapeString)(e),")"))):"number"==typeof e?r.push(numberToString(e)):(0,_primitives.isDict)(e)?writeDict(e,r,t):(0,_primitives.isStream)(e)&&writeStream(e,r,t)}function writeInt(e,r,t,n){for(var a=r+t-1;t-1<a;a--)n[a]=255&e,e>>=8;return t+r}function writeString(e,r,t){for(var n=0,a=e.length;n<a;n++)t[r+n]=255&e.charCodeAt(n)}function computeMD5(e,r){for(var t=Math.floor(Date.now()/1e3),n=r.filename||"",a=[t.toString(),n,e.toString()],i=a.reduce(function(e,r){return e+r.length},0),o=0,u=Object.values(r.info);o<u.length;o++){var l=u[o];a.push(l),i+=l.length}for(var c=new Uint8Array(i),s=0,f=0,p=a;f<p.length;f++){var h=p[f];writeString(h,s,c),s+=h.length}return(0,_util.bytesToString)((0,_crypto.calculateMD5)(c))}function updateXFA(e,r,t){if(null!==e&&null!==t){var n,a=t.fetchIfRef(e),i=(0,_util.bytesToString)(a.getBytes()),o=new _xml_parser.SimpleXMLParser({hasAttributes:!0}).parseFromString(i),u=_createForOfIteratorHelper(r);try{for(u.s();!(n=u.n()).done;){var l=n.value.xfa;if(l){var c=l.path,s=l.value;if(c){var f=o.documentElement.searchNode((0,_core_utils.parseXFAPath)(c),0);f?f.childNodes=[new _xml_parser.SimpleDOMNode("#text",s)]:(0,_util.warn)("Node not found for path: ".concat(c))}}}}catch(e){u.e(e)}finally{u.f()}var p=[];o.documentElement.dump(p);var h=p.join(""),y=t.encrypt;if(y)h=y.createCipherTransform(e.num,e.gen).encryptString(h);var m="".concat(e.num," ").concat(e.gen," obj\n")+"<< /Type /EmbeddedFile /Length ".concat(h.length,">>\nstream\n")+h+"\nendstream\nendobj\n";r.push({ref:e,data:m})}}function incrementalUpdate(e){var r=e.originalData,t=e.xrefInfo,n=e.newRefs,a=e.xref,i=void 0===a?null:a,o=e.datasetsRef;updateXFA(void 0===o?null:o,n,i);var u,l,c=new _primitives.Dict(null),s=t.newRef,f=r[r.length-1];l=10===f||13===f?(u=[],r.length):(u=["\n"],r.length+1),c.set("Size",s.num+1),c.set("Prev",t.startXRef),c.set("Type",_primitives.Name.get("XRef")),null!==t.rootRef&&c.set("Root",t.rootRef),null!==t.infoRef&&c.set("Info",t.infoRef),null!==t.encrypt&&c.set("Encrypt",t.encrypt),n.push({ref:s,data:""});var p,h=[[0,1,65535]],y=[0,1],m=0,d=_createForOfIteratorHelper(n=n.sort(function(e,r){return e.ref.num-r.ref.num}));try{for(d.s();!(p=d.n()).done;){var v=p.value,g=v.ref,_=v.data;m=Math.max(m,l),h.push([1,l,Math.min(g.gen,65535)]),l+=_.length,y.push(g.num),y.push(1),u.push(_)}}catch(e){d.e(e)}finally{d.f()}if(c.set("Index",y),0!==t.fileIds.length){var b=computeMD5(l,t);c.set("ID",[t.fileIds[0],b])}var w=[1,Math.ceil(Math.log2(m)/8),2],S=(w[0]+w[1]+w[2])*h.length;c.set("W",w),c.set("Length",S),u.push("".concat(s.num," ").concat(s.gen," obj\n")),writeDict(c,u,null),u.push(" stream\n");var A=u.reduce(function(e,r){return e+r.length},0),I="\nendstream\nendobj\nstartxref\n".concat(l,"\n%%EOF\n"),T=new Uint8Array(r.length+A+S+I.length);T.set(r);var j,x=r.length,D=_createForOfIteratorHelper(u);try{for(D.s();!(j=D.n()).done;){var F=j.value;writeString(F,x,T),x+=F.length}}catch(e){D.e(e)}finally{D.f()}for(var R=0,O=h;R<O.length;R++){var M=_slicedToArray(O[R],3),N=M[0],H=M[1],L=M[2];x=writeInt(N,w[0],x,T),x=writeInt(H,w[1],x,T),x=writeInt(L,w[2],x,T)}return writeString(I,x,T),T}