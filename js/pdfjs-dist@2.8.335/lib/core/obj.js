"use strict";function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(i){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(i);if(n){var r=_getPrototypeOf(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _regeneratorRuntime(){_regeneratorRuntime=function(){return s};var s={},e=Object.prototype,l=e.hasOwnProperty,f=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",i=t.toStringTag||"@@toStringTag";function a(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,r){return e[t]=r}}function o(e,t,r,i){var a,s,o,c,n=t&&t.prototype instanceof v?t:v,u=Object.create(n.prototype),l=new D(i||[]);return f(u,"_invoke",{value:(a=e,s=r,o=l,c="suspendedStart",function(e,t){if("executing"===c)throw new Error("Generator is already running");if("completed"===c){if("throw"===e)throw t;return P()}for(o.method=e,o.arg=t;;){var r=o.delegate;if(r){var i=w(r,o);if(i){if(i===p)continue;return i}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if("suspendedStart"===c)throw c="completed",o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);c="executing";var n=h(a,s,o);if("normal"===n.type){if(c=o.done?"completed":"suspendedYield",n.arg===p)continue;return{value:n.arg,done:o.done}}"throw"===n.type&&(c="completed",o.method="throw",o.arg=n.arg)}})}),u}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}s.wrap=o;var p={};function v(){}function c(){}function u(){}var m={};a(m,n,function(){return this});var g=Object.getPrototypeOf,d=g&&g(g(x([])));d&&d!==e&&l.call(d,n)&&(m=d);var _=u.prototype=v.prototype=Object.create(m);function y(e){["next","throw","return"].forEach(function(t){a(e,t,function(e){return this._invoke(t,e)})})}function b(c,u){var t;f(this,"_invoke",{value:function(r,i){function e(){return new u(function(e,t){!function t(e,r,i,n){var a=h(c[e],c,r);if("throw"!==a.type){var s=a.arg,o=s.value;return o&&"object"==_typeof(o)&&l.call(o,"__await")?u.resolve(o.__await).then(function(e){t("next",e,i,n)},function(e){t("throw",e,i,n)}):u.resolve(o).then(function(e){s.value=e,i(s)},function(e){return t("throw",e,i,n)})}n(a.arg)}(r,i,e,t)})}return t=t?t.then(e,e):e()}})}function w(e,t){var r=t.method,i=e.iterator[r];if(void 0===i)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),p;var n=h(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function D(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function x(t){if(t){var e=t[n];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function e(){for(;++r<t.length;)if(l.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:P}}function P(){return{value:void 0,done:!0}}return f(_,"constructor",{value:c.prototype=u,configurable:!0}),f(u,"constructor",{value:c,configurable:!0}),c.displayName=a(u,i,"GeneratorFunction"),s.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===c||"GeneratorFunction"===(t.displayName||t.name))},s.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,a(e,i,"GeneratorFunction")),e.prototype=Object.create(_),e},s.awrap=function(e){return{__await:e}},y(b.prototype),a(b.prototype,r,function(){return this}),s.AsyncIterator=b,s.async=function(e,t,r,i,n){void 0===n&&(n=Promise);var a=new b(o(e,t,r,i),n);return s.isGeneratorFunction(t)?a:a.next().then(function(e){return e.done?e.value:a.next()})},y(_),a(_,i,"Generator"),a(_,n,function(){return this}),a(_,"toString",function(){return"[object Generator]"}),s.keys=function(e){var r=Object(e),i=[];for(var t in r)i.push(t);return i.reverse(),function e(){for(;i.length;){var t=i.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},s.values=x,D.prototype={constructor:D,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&l.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var i=this;function e(e,t){return a.type="throw",a.arg=r,i.next=e,t&&(i.method="next",i.arg=void 0),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t],a=n.completion;if("root"===n.tryLoc)return e("end");if(n.tryLoc<=this.prev){var s=l.call(n,"catchLoc"),o=l.call(n,"finallyLoc");if(s&&o){if(this.prev<n.catchLoc)return e(n.catchLoc,!0);if(this.prev<n.finallyLoc)return e(n.finallyLoc)}else if(s){if(this.prev<n.catchLoc)return e(n.catchLoc,!0)}else{if(!o)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return e(n.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&l.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var a=n?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,p):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var n=i.arg;R(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:x(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},s}function asyncGeneratorStep(e,t,r,i,n,a,s){try{var o=e[a](s),c=o.value}catch(e){return void r(e)}o.done?t(c):Promise.resolve(c).then(i,n)}function _asyncToGenerator(o){return function(){var e=this,s=arguments;return new Promise(function(t,r){var i=o.apply(e,s);function n(e){asyncGeneratorStep(i,t,r,n,a,"next",e)}function a(e){asyncGeneratorStep(i,t,r,n,a,"throw",e)}n(void 0)})}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i,n,a,s,o=[],c=!0,u=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(i=a.call(r)).done)&&(o.push(i.value),o.length!==t);c=!0);}catch(e){u=!0,n=e}finally{try{if(!c&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw n}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(o)throw a}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var i=r.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.XRef=exports.ObjectLoader=exports.FileSpec=exports.Catalog=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_parser=require("./parser.js"),_crypto=require("./crypto.js"),_colorspace=require("./colorspace.js"),_image_utils=require("./image_utils.js"),_metadata_parser=require("./metadata_parser.js");function fetchDestination(e){return(0,_primitives.isDict)(e)?e.get("D"):e}var Catalog=function(){function m(e,t){if(_classCallCheck(this,m),this.pdfManager=e,this.xref=t,this._catDict=t.getCatalogObj(),!(0,_primitives.isDict)(this._catDict))throw new _util.FormatError("Catalog object is not a dictionary.");this.fontCache=new _primitives.RefSetCache,this.builtInCMapCache=new Map,this.globalImageCache=new _image_utils.GlobalImageCache,this.pageKidsCountCache=new _primitives.RefSetCache,this.nonBlendModesSet=new _primitives.RefSet}return _createClass(m,[{key:"version",get:function(){var e=this._catDict.get("Version");return(0,_primitives.isName)(e)?(0,_util.shadow)(this,"version",e.name):(0,_util.shadow)(this,"version",null)}},{key:"collection",get:function(){var e=null;try{var t=this._catDict.get("Collection");(0,_primitives.isDict)(t)&&0<t.size&&(e=t)}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.info)("Cannot fetch Collection entry; assuming no collection is present.")}return(0,_util.shadow)(this,"collection",e)}},{key:"acroForm",get:function(){var e=null;try{var t=this._catDict.get("AcroForm");(0,_primitives.isDict)(t)&&0<t.size&&(e=t)}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.info)("Cannot fetch AcroForm entry; assuming no forms are present.")}return(0,_util.shadow)(this,"acroForm",e)}},{key:"metadata",get:function(){var e=this._catDict.getRaw("Metadata");if(!(0,_primitives.isRef)(e))return(0,_util.shadow)(this,"metadata",null);var t=!(this.xref.encrypt&&this.xref.encrypt.encryptMetadata),r=this.xref.fetch(e,t),i=null;if((0,_primitives.isStream)(r)&&(0,_primitives.isDict)(r.dict)){var n=r.dict.get("Type"),a=r.dict.get("Subtype");if((0,_primitives.isName)(n,"Metadata")&&(0,_primitives.isName)(a,"XML"))try{var s=(0,_util.stringToUTF8String)((0,_util.bytesToString)(r.getBytes()));s&&(i=new _metadata_parser.MetadataParser(s).serializable)}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.info)("Skipping invalid metadata.")}}return(0,_util.shadow)(this,"metadata",i)}},{key:"markInfo",get:function(){var e=null;try{e=this._readMarkInfo()}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)("Unable to read mark info.")}return(0,_util.shadow)(this,"markInfo",e)}},{key:"_readMarkInfo",value:function(){var e=this._catDict.get("MarkInfo");if(!(0,_primitives.isDict)(e))return null;var t=Object.assign(Object.create(null),{Marked:!1,UserProperties:!1,Suspects:!1});for(var r in t)if(e.has(r)){var i=e.get(r);(0,_util.isBool)(i)&&(t[r]=i)}return t}},{key:"toplevelPagesDict",get:function(){var e=this._catDict.get("Pages");if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Invalid top-level pages dictionary.");return(0,_util.shadow)(this,"toplevelPagesDict",e)}},{key:"documentOutline",get:function(){var e=null;try{e=this._readDocumentOutline()}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)("Unable to read document outline.")}return(0,_util.shadow)(this,"documentOutline",e)}},{key:"_readDocumentOutline",value:function(){var e=this._catDict.get("Outlines");if(!(0,_primitives.isDict)(e))return null;if(e=e.getRaw("First"),!(0,_primitives.isRef)(e))return null;var t={items:[]},r=[{obj:e,parent:t}],i=new _primitives.RefSet;i.put(e);for(var n=this.xref,a=new Uint8ClampedArray(3);0<r.length;){var s=r.shift(),o=n.fetchIfRef(s.obj);if(null!==o){if(!o.has("Title"))throw new _util.FormatError("Invalid outline item encountered.");var c={url:null,dest:null};m.parseDestDictionary({destDict:o,resultObj:c,docBaseUrl:this.pdfManager.docBaseUrl});var u=o.get("Title"),l=o.get("F")||0,f=o.getArray("C"),h=o.get("Count"),p=a;!Array.isArray(f)||3!==f.length||0===f[0]&&0===f[1]&&0===f[2]||(p=_colorspace.ColorSpace.singletons.rgb.getRgb(f,0));var v={dest:c.dest,url:c.url,unsafeUrl:c.unsafeUrl,newWindow:c.newWindow,title:(0,_util.stringToPDFString)(u),color:p,count:Number.isInteger(h)?h:void 0,bold:!!(2&l),italic:!!(1&l),items:[]};s.parent.items.push(v),e=o.getRaw("First"),(0,_primitives.isRef)(e)&&!i.has(e)&&(r.push({obj:e,parent:v}),i.put(e)),e=o.getRaw("Next"),(0,_primitives.isRef)(e)&&!i.has(e)&&(r.push({obj:e,parent:s.parent}),i.put(e))}}return 0<t.items.length?t.items:null}},{key:"permissions",get:function(){var e=null;try{e=this._readPermissions()}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)("Unable to read permissions.")}return(0,_util.shadow)(this,"permissions",e)}},{key:"_readPermissions",value:function(){var e=this.xref.trailer.get("Encrypt");if(!(0,_primitives.isDict)(e))return null;var t=e.get("P");if(!(0,_util.isNum)(t))return null;t+=Math.pow(2,32);var r=[];for(var i in _util.PermissionFlag){var n=_util.PermissionFlag[i];t&n&&r.push(n)}return r}},{key:"optionalContentConfig",get:function(){var e=null;try{var t=this._catDict.get("OCProperties");if(!t)return(0,_util.shadow)(this,"optionalContentConfig",null);var r=t.get("D");if(!r)return(0,_util.shadow)(this,"optionalContentConfig",null);var i=t.get("OCGs");if(!Array.isArray(i))return(0,_util.shadow)(this,"optionalContentConfig",null);var n,a=[],s=[],o=_createForOfIteratorHelper(i);try{for(o.s();!(n=o.n()).done;){var c=n.value;if((0,_primitives.isRef)(c)){s.push(c);var u=this.xref.fetchIfRef(c);a.push({id:c.toString(),name:(0,_util.isString)(u.get("Name"))?(0,_util.stringToPDFString)(u.get("Name")):null,intent:(0,_util.isString)(u.get("Intent"))?(0,_util.stringToPDFString)(u.get("Intent")):null})}}}catch(e){o.e(e)}finally{o.f()}(e=this._readOptionalContentConfig(r,s)).groups=a}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)("Unable to read optional content config: ".concat(e))}return(0,_util.shadow)(this,"optionalContentConfig",e)}},{key:"_readOptionalContentConfig",value:function(e,f){function t(e){var t=[];if(Array.isArray(e)){var r,i=_createForOfIteratorHelper(e);try{for(i.s();!(r=i.n()).done;){var n=r.value;(0,_primitives.isRef)(n)&&(f.includes(n)&&t.push(n.toString()))}}catch(e){i.e(e)}finally{i.f()}}return t}function a(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(!Array.isArray(e))return null;var r,i=[],n=_createForOfIteratorHelper(e);try{for(n.s();!(r=n.n()).done;){var a=r.value;if((0,_primitives.isRef)(a)&&f.includes(a))p.put(a),i.push(a.toString());else{var s=h(a,t);s&&i.push(s)}}}catch(e){n.e(e)}finally{n.f()}if(0<t)return i;var o,c=[],u=_createForOfIteratorHelper(f);try{for(u.s();!(o=u.n()).done;){var l=o.value;p.has(l)||c.push(l.toString())}}catch(e){u.e(e)}finally{u.f()}return c.length&&i.push({name:null,order:c}),i}function h(e,t){if(++t>o)return(0,_util.warn)("parseNestedOrder - reached MAX_NESTED_LEVELS."),null;var r=s.fetchIfRef(e);if(!Array.isArray(r))return null;var i=s.fetchIfRef(r[0]);if("string"!=typeof i)return null;var n=a(r.slice(1),t);return n&&n.length?{name:(0,_util.stringToPDFString)(i),order:n}:null}var s=this.xref,p=new _primitives.RefSet,o=10;return{name:(0,_util.isString)(e.get("Name"))?(0,_util.stringToPDFString)(e.get("Name")):null,creator:(0,_util.isString)(e.get("Creator"))?(0,_util.stringToPDFString)(e.get("Creator")):null,baseState:(0,_primitives.isName)(e.get("BaseState"))?e.get("BaseState").name:null,on:t(e.get("ON")),off:t(e.get("OFF")),order:a(e.get("Order")),groups:null}}},{key:"numPages",get:function(){var e=this.toplevelPagesDict.get("Count");if(!Number.isInteger(e))throw new _util.FormatError("Page count in top-level pages dictionary is not an integer.");return(0,_util.shadow)(this,"numPages",e)}},{key:"destinations",get:function(){var e=this._readDests(),r=Object.create(null);if(e instanceof NameTree){var t=e.getAll();for(var i in t)r[i]=fetchDestination(t[i])}else e instanceof _primitives.Dict&&e.forEach(function(e,t){t&&(r[e]=fetchDestination(t))});return(0,_util.shadow)(this,"destinations",r)}},{key:"getDestination",value:function(e){var t=this._readDests();return t instanceof NameTree||t instanceof _primitives.Dict?fetchDestination(t.get(e)||null):null}},{key:"_readDests",value:function(){var e=this._catDict.get("Names");return e&&e.has("Dests")?new NameTree(e.getRaw("Dests"),this.xref):this._catDict.has("Dests")?this._catDict.get("Dests"):void 0}},{key:"pageLabels",get:function(){var e=null;try{e=this._readPageLabels()}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)("Unable to read page labels.")}return(0,_util.shadow)(this,"pageLabels",e)}},{key:"_readPageLabels",value:function(){var e=this._catDict.getRaw("PageLabels");if(!e)return null;for(var t=new Array(this.numPages),r=null,i="",n=new NumberTree(e,this.xref).getAll(),a="",s=1,o=0,c=this.numPages;o<c;o++){if(o in n){var u=n[o];if(!(0,_primitives.isDict)(u))throw new _util.FormatError("PageLabel is not a dictionary.");if(u.has("Type")&&!(0,_primitives.isName)(u.get("Type"),"PageLabel"))throw new _util.FormatError("Invalid type in PageLabel dictionary.");if(u.has("S")){var l=u.get("S");if(!(0,_primitives.isName)(l))throw new _util.FormatError("Invalid style in PageLabel dictionary.");r=l.name}else r=null;if(u.has("P")){var f=u.get("P");if(!(0,_util.isString)(f))throw new _util.FormatError("Invalid prefix in PageLabel dictionary.");i=(0,_util.stringToPDFString)(f)}else i="";if(u.has("St")){var h=u.get("St");if(!(Number.isInteger(h)&&1<=h))throw new _util.FormatError("Invalid start in PageLabel dictionary.");s=h}else s=1}switch(r){case"D":a=s;break;case"R":case"r":a=(0,_core_utils.toRomanNumerals)(s,"r"===r);break;case"A":case"a":for(var p="a"===r?97:65,v=s-1,m=String.fromCharCode(p+v%26),g=[],d=0,_=v/26|0;d<=_;d++)g.push(m);a=g.join("");break;default:if(r)throw new _util.FormatError('Invalid style "'.concat(r,'" in PageLabel dictionary.'));a=""}t[o]=i+a,s++}return t}},{key:"pageLayout",get:function(){var e=this._catDict.get("PageLayout"),t="";if((0,_primitives.isName)(e))switch(e.name){case"SinglePage":case"OneColumn":case"TwoColumnLeft":case"TwoColumnRight":case"TwoPageLeft":case"TwoPageRight":t=e.name}return(0,_util.shadow)(this,"pageLayout",t)}},{key:"pageMode",get:function(){var e=this._catDict.get("PageMode"),t="UseNone";if((0,_primitives.isName)(e))switch(e.name){case"UseNone":case"UseOutlines":case"UseThumbs":case"FullScreen":case"UseOC":case"UseAttachments":t=e.name}return(0,_util.shadow)(this,"pageMode",t)}},{key:"viewerPreferences",get:function(){var i=this,e={HideToolbar:_util.isBool,HideMenubar:_util.isBool,HideWindowUI:_util.isBool,FitWindow:_util.isBool,CenterWindow:_util.isBool,DisplayDocTitle:_util.isBool,NonFullScreenPageMode:_primitives.isName,Direction:_primitives.isName,ViewArea:_primitives.isName,ViewClip:_primitives.isName,PrintArea:_primitives.isName,PrintClip:_primitives.isName,PrintScaling:_primitives.isName,Duplex:_primitives.isName,PickTrayByPDFSize:_util.isBool,PrintPageRange:Array.isArray,NumCopies:Number.isInteger},t=this._catDict.get("ViewerPreferences"),r=null;if((0,_primitives.isDict)(t))for(var n in e)if(t.has(n)){var a=t.get(n);if(e[n](a)){var s=void 0;switch(n){case"NonFullScreenPageMode":switch(a.name){case"UseNone":case"UseOutlines":case"UseThumbs":case"UseOC":s=a.name;break;default:s="UseNone"}break;case"Direction":switch(a.name){case"L2R":case"R2L":s=a.name;break;default:s="L2R"}break;case"ViewArea":case"ViewClip":case"PrintArea":case"PrintClip":switch(a.name){case"MediaBox":case"CropBox":case"BleedBox":case"TrimBox":case"ArtBox":s=a.name;break;default:s="CropBox"}break;case"PrintScaling":switch(a.name){case"None":case"AppDefault":s=a.name;break;default:s="AppDefault"}break;case"Duplex":switch(a.name){case"Simplex":case"DuplexFlipShortEdge":case"DuplexFlipLongEdge":s=a.name;break;default:s="None"}break;case"PrintPageRange":if(a.length%2!=0)break;a.every(function(e,t,r){return Number.isInteger(e)&&0<e&&(0===t||e>=r[t-1])&&e<=i.numPages})&&(s=a);break;case"NumCopies":0<a&&(s=a);break;default:if("boolean"!=typeof a)throw new _util.FormatError("viewerPreferences - expected a boolean value for: ".concat(n));s=a}void 0!==s?(r||(r=Object.create(null)),r[n]=s):(0,_util.info)('Bad value in ViewerPreferences for "'.concat(n,'".'))}else(0,_util.info)('Bad value in ViewerPreferences for "'.concat(n,'".'))}return(0,_util.shadow)(this,"viewerPreferences",r)}},{key:"openAction",get:function(){var e=this._catDict.get("OpenAction"),t=Object.create(null);if((0,_primitives.isDict)(e)){var r=new _primitives.Dict(this.xref);r.set("A",e);var i={url:null,dest:null,action:null};m.parseDestDictionary({destDict:r,resultObj:i}),Array.isArray(i.dest)?t.dest=i.dest:i.action&&(t.action=i.action)}else Array.isArray(e)&&(t.dest=e);return(0,_util.shadow)(this,"openAction",0<(0,_util.objectSize)(t)?t:null)}},{key:"attachments",get:function(){var e=this._catDict.get("Names"),t=null;if(e&&e.has("EmbeddedFiles")){var r=new NameTree(e.getRaw("EmbeddedFiles"),this.xref).getAll();for(var i in r){var n=new FileSpec(r[i],this.xref);t||(t=Object.create(null)),t[(0,_util.stringToPDFString)(i)]=n.serializable}}return(0,_util.shadow)(this,"attachments",t)}},{key:"_collectJavaScript",value:function(){var e=this._catDict.get("Names"),n=null;function t(e,t){var r=t.get("S");if((0,_primitives.isName)(r,"JavaScript")){var i=t.get("JS");if((0,_primitives.isStream)(i))i=(0,_util.bytesToString)(i.getBytes());else if(!(0,_util.isString)(i))return;null===n&&(n=Object.create(null)),n[e]=(0,_util.stringToPDFString)(i)}}if(e&&e.has("JavaScript")){var r=new NameTree(e.getRaw("JavaScript"),this.xref).getAll();for(var i in r){var a=r[i];(0,_primitives.isDict)(a)&&t(i,a)}}var s=this._catDict.get("OpenAction");return(0,_primitives.isDict)(s)&&(0,_primitives.isName)(s.get("S"),"JavaScript")&&t("OpenAction",s),n}},{key:"javaScript",get:function(){var e=this._collectJavaScript();return(0,_util.shadow)(this,"javaScript",e?Object.values(e):null)}},{key:"jsActions",get:function(){var e=this._collectJavaScript(),t=(0,_core_utils.collectActions)(this.xref,this._catDict,_util.DocumentActionEventType);if(!t&&e&&(t=Object.create(null)),t&&e)for(var r=0,i=Object.entries(e);r<i.length;r++){var n=_slicedToArray(i[r],2),a=n[0],s=n[1];a in t?t[a].push(s):t[a]=[s]}return(0,_util.shadow)(this,"jsActions",t)}},{key:"fontFallback",value:function(n,a){var t=[];return this.fontCache.forEach(function(e){t.push(e)}),Promise.all(t).then(function(e){var t,r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(i.loadedName===n)return void i.fallback(a)}}catch(e){r.e(e)}finally{r.f()}})}},{key:"cleanup",value:function(){var i=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];(0,_primitives.clearPrimitiveCaches)(),this.globalImageCache.clear(e),this.pageKidsCountCache.clear(),this.nonBlendModesSet.clear();var t=[];return this.fontCache.forEach(function(e){t.push(e)}),Promise.all(t).then(function(e){var t,r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){delete t.value.dict.cacheKey}}catch(e){r.e(e)}finally{r.f()}i.fontCache.clear(),i.builtInCMapCache.clear()})}},{key:"getPageDict",value:function(a){var s,o=(0,_util.createPromiseCapability)(),c=[this._catDict.getRaw("Pages")],u=new _primitives.RefSet,l=this.xref,f=this.pageKidsCountCache,h=0;return function n(){for(var e=function(){var t=c.pop();if((0,_primitives.isRef)(t))return 0<(s=f.get(t))&&h+s<a?(h+=s,"continue"):(u.has(t)?o.reject(new _util.FormatError("Pages tree contains circular reference.")):(u.put(t),l.fetchAsync(t).then(function(e){(0,_primitives.isDict)(e,"Page")||(0,_primitives.isDict)(e)&&!e.has("Kids")?a===h?(t&&!f.has(t)&&f.put(t,1),o.resolve([e,t])):(h++,n()):(c.push(e),n())},o.reject)),{v:void 0});if(!(0,_primitives.isDict)(t))return o.reject(new _util.FormatError("Page dictionary kid reference points to wrong type of object.")),{v:void 0};if(s=t.get("Count"),Number.isInteger(s)&&0<=s){var e=t.objId;if(e&&!f.has(e)&&f.put(e,s),h+s<=a)return h+=s,"continue"}var r=t.get("Kids");if(!Array.isArray(r))return(0,_primitives.isName)(t.get("Type"),"Page")||!t.has("Type")&&t.has("Contents")?h===a?(o.resolve([t,null]),{v:void 0}):(h++,"continue"):(o.reject(new _util.FormatError("Page dictionary kids object is not an array.")),{v:void 0});for(var i=r.length-1;0<=i;i--)c.push(r[i])};c.length;){var t=e();if("continue"!==t&&"object"===_typeof(t))return t.v}o.reject(new Error("Page index ".concat(a," not found.")))}(),o.promise}},{key:"getPageIndex",value:function(t){var u=this.xref;var a=0;return function n(e){return(s=e,c=0,u.fetchAsync(s).then(function(e){if((0,_primitives.isRefsEqual)(s,t)&&!(0,_primitives.isDict)(e,"Page")&&(!(0,_primitives.isDict)(e)||e.has("Type")||!e.has("Contents")))throw new _util.FormatError("The reference does not point to a /Page dictionary.");if(!e)return null;if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Node must be a dictionary.");return o=e.getRaw("Parent"),e.getAsync("Parent")}).then(function(e){if(!e)return null;if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Parent must be a dictionary.");return e.getAsync("Kids")}).then(function(e){if(!e)return null;for(var t=[],r=!1,i=0,n=e.length;i<n;i++){var a=e[i];if(!(0,_primitives.isRef)(a))throw new _util.FormatError("Kid must be a reference.");if((0,_primitives.isRefsEqual)(a,s)){r=!0;break}t.push(u.fetchAsync(a).then(function(e){if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Kid node must be a dictionary.");e.has("Count")?c+=e.get("Count"):c++}))}if(!r)throw new _util.FormatError("Kid reference not found in parent's kids.");return Promise.all(t).then(function(){return[c,o]})})).then(function(e){if(!e)return a;var t=_slicedToArray(e,2),r=t[0],i=t[1];return a+=r,n(i)});var s,o,c}(t)}}],[{key:"parseDestDictionary",value:function(e){var t=e.destDict;if((0,_primitives.isDict)(t)){var r=e.resultObj;if("object"===_typeof(r)){var i,n,a,s=e.docBaseUrl||null,o=t.get("A");if((0,_primitives.isDict)(o)||(t.has("Dest")?o=t.get("Dest"):(o=t.get("AA"),(0,_primitives.isDict)(o)&&(o.has("D")?o=o.get("D"):o.has("U")&&(o=o.get("U"))))),(0,_primitives.isDict)(o)){var c=o.get("S");if(!(0,_primitives.isName)(c))return void(0,_util.warn)("parseDestDictionary: Invalid type in Action dictionary.");var u=c.name;switch(u){case"URI":i=o.get("URI"),(0,_primitives.isName)(i)?i="/"+i.name:(0,_util.isString)(i)&&(i=(a=i).startsWith("www.")?"http://".concat(a):a);break;case"GoTo":n=o.get("D");break;case"Launch":case"GoToR":var l=o.get("F");(0,_primitives.isDict)(l)?i=l.get("F")||null:(0,_util.isString)(l)&&(i=l);var f=o.get("D");if(f&&((0,_primitives.isName)(f)&&(f=f.name),(0,_util.isString)(i))){var h=i.split("#")[0];(0,_util.isString)(f)?i=h+"#"+f:Array.isArray(f)&&(i=h+"#"+JSON.stringify(f))}var p=o.get("NewWindow");(0,_util.isBool)(p)&&(r.newWindow=p);break;case"Named":var v=o.get("N");(0,_primitives.isName)(v)&&(r.action=v.name);break;case"JavaScript":var m,g=o.get("JS");if((0,_primitives.isStream)(g)?m=(0,_util.bytesToString)(g.getBytes()):(0,_util.isString)(g)&&(m=g),m){var d=new RegExp("^\\s*("+["app.launchURL","window.open"].join("|").split(".").join("\\.")+")\\((?:'|\")([^'\"]*)(?:'|\")(?:,\\s*(\\w+)\\)|\\))","i").exec((0,_util.stringToPDFString)(m));if(d&&d[2]){i=d[2],"true"===d[3]&&"app.launchURL"===d[1]&&(r.newWindow=!0);break}}default:if("JavaScript"===u||"ResetForm"===u||"SubmitForm"===u)break;(0,_util.warn)('parseDestDictionary - unsupported action: "'.concat(u,'".'))}}else t.has("Dest")&&(n=t.get("Dest"));if((0,_util.isString)(i)){i=function(t){try{return(0,_util.stringToUTF8String)(t)}catch(e){return t}}(i);var _=(0,_util.createValidAbsoluteUrl)(i,s);_&&(r.url=_.href),r.unsafeUrl=i}n&&((0,_primitives.isName)(n)&&(n=n.name),((0,_util.isString)(n)||Array.isArray(n))&&(r.dest=n))}else(0,_util.warn)("parseDestDictionary: `resultObj` must be an object.")}else(0,_util.warn)("parseDestDictionary: `destDict` must be a dictionary.")}}]),m}();exports.Catalog=Catalog;var XRef=function(){function e(e,t){this.stream=e,this.pdfManager=t,this.entries=[],this.xrefstms=Object.create(null),this._cacheMap=new Map,this.stats={streamTypes:Object.create(null),fontTypes:Object.create(null)},this._newRefNum=null}return e.prototype={getNewRef:function(){return null===this._newRefNum&&(this._newRefNum=this.entries.length),_primitives.Ref.get(this._newRefNum++,0)},resetNewRef:function(){this._newRefNum=null},setStartXRef:function(e){this.startXRefQueue=[e]},parse:function(e){var t,r,i;(t=e?((0,_util.warn)("Indexing all PDF objects"),this.indexObjects()):this.readXRef()).assignXref(this),this.trailer=t;try{r=t.get("Encrypt")}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)('XRef.parse - Invalid "Encrypt" reference: "'.concat(e,'".'))}if((0,_primitives.isDict)(r)){var n=t.get("ID"),a=n&&n.length?n[0]:"";r.suppressEncryption=!0,this.encrypt=new _crypto.CipherTransformFactory(r,a,this.pdfManager.password)}try{i=t.get("Root")}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)('XRef.parse - Invalid "Root" reference: "'.concat(e,'".'))}if(!(0,_primitives.isDict)(i)||!i.has("Pages")){if(!e)throw new _core_utils.XRefParseException;throw new _util.FormatError("Invalid root reference")}this.root=i},processXRefTable:function(e){"tableState"in this||(this.tableState={entryNum:0,streamPos:e.lexer.stream.pos,parserBuf1:e.buf1,parserBuf2:e.buf2});var t=this.readXRefTable(e);if(!(0,_primitives.isCmd)(t,"trailer"))throw new _util.FormatError("Invalid XRef table: could not find trailer dictionary");var r=e.getObj();if(!(0,_primitives.isDict)(r)&&r.dict&&(r=r.dict),!(0,_primitives.isDict)(r))throw new _util.FormatError("Invalid XRef table: could not parse trailer dictionary");return delete this.tableState,r},readXRefTable:function(e){var t,r=e.lexer.stream,i=this.tableState;for(r.pos=i.streamPos,e.buf1=i.parserBuf1,e.buf2=i.parserBuf2;;){if(!("firstEntryNum"in i&&"entryCount"in i)){if((0,_primitives.isCmd)(t=e.getObj(),"trailer"))break;i.firstEntryNum=t,i.entryCount=e.getObj()}var n=i.firstEntryNum,a=i.entryCount;if(!Number.isInteger(n)||!Number.isInteger(a))throw new _util.FormatError("Invalid XRef table: wrong types in subsection header");for(var s=i.entryNum;s<a;s++){i.streamPos=r.pos,i.entryNum=s,i.parserBuf1=e.buf1,i.parserBuf2=e.buf2;var o={};o.offset=e.getObj(),o.gen=e.getObj();var c=e.getObj();if(c instanceof _primitives.Cmd)switch(c.cmd){case"f":o.free=!0;break;case"n":o.uncompressed=!0}if(!Number.isInteger(o.offset)||!Number.isInteger(o.gen)||!o.free&&!o.uncompressed)throw new _util.FormatError("Invalid entry in XRef subsection: ".concat(n,", ").concat(a));0===s&&o.free&&1===n&&(n=0),this.entries[s+n]||(this.entries[s+n]=o)}i.entryNum=0,i.streamPos=r.pos,i.parserBuf1=e.buf1,i.parserBuf2=e.buf2,delete i.firstEntryNum,delete i.entryCount}if(this.entries[0]&&!this.entries[0].free)throw new _util.FormatError("Invalid XRef table: unexpected first object");return t},processXRefStream:function(e){if(!("streamState"in this)){var t=e.dict,r=t.get("W"),i=t.get("Index");i||(i=[0,t.get("Size")]),this.streamState={entryRanges:i,byteWidths:r,entryNum:0,streamPos:e.pos}}return this.readXRefStream(e),delete this.streamState,e.dict},readXRefStream:function(e){var t,r,i=this.streamState;e.pos=i.streamPos;for(var n=i.byteWidths,a=n[0],s=n[1],o=n[2],c=i.entryRanges;0<c.length;){var u=c[0],l=c[1];if(!Number.isInteger(u)||!Number.isInteger(l))throw new _util.FormatError("Invalid XRef range fields: ".concat(u,", ").concat(l));if(!Number.isInteger(a)||!Number.isInteger(s)||!Number.isInteger(o))throw new _util.FormatError("Invalid XRef entry fields length: ".concat(u,", ").concat(l));for(t=i.entryNum;t<l;++t){i.entryNum=t,i.streamPos=e.pos;var f=0,h=0,p=0;for(r=0;r<a;++r)f=f<<8|e.getByte();for(0===a&&(f=1),r=0;r<s;++r)h=h<<8|e.getByte();for(r=0;r<o;++r)p=p<<8|e.getByte();var v={};switch(v.offset=h,v.gen=p,f){case 0:v.free=!0;break;case 1:v.uncompressed=!0;break;case 2:break;default:throw new _util.FormatError("Invalid XRef entry type: ".concat(f))}this.entries[u+t]||(this.entries[u+t]=v)}i.entryNum=0,i.streamPos=e.pos,c.splice(0,2)}},indexObjects:function(){var n=10,a=13,s=60;function e(e,t){for(var r="",i=e[t];i!==n&&i!==a&&i!==s&&!(++t>=e.length);)r+=String.fromCharCode(i),i=e[t];return r}function t(e,t,r){for(var i=r.length,n=e.length,a=0;t<n;){for(var s=0;s<i&&e[t+s]===r[s];)++s;if(i<=s)break;t++,a++}return a}var r=/^(\d+)\s+(\d+)\s+obj\b/,i=/\bendobj[\b\s]$/,o=/\s+(\d+\s+\d+\s+obj[\b\s<])$/,c=new Uint8Array([116,114,97,105,108,101,114]),u=new Uint8Array([115,116,97,114,116,120,114,101,102]),l=new Uint8Array([111,98,106]),f=new Uint8Array([47,88,82,101,102]);this.entries.length=0;var h=this.stream;h.pos=0;for(var p,v=h.getBytes(),m=h.start,g=v.length,d=[],_=[];m<g;){var y=v[m];if(9!==y&&y!==n&&y!==a&&32!==y)if(37!==y){var b,w=e(v,m);if(w.startsWith("xref")&&(4===w.length||/\s/.test(w[4])))m+=t(v,m,c),d.push(m),m+=t(v,m,u);else if(b=r.exec(w)){var S=0|b[1],R=0|b[2];this.entries[S]&&this.entries[S].gen!==R||(this.entries[S]={offset:m-h.start,gen:R,uncompressed:!0});for(var D=void 0,x=m+w.length;x<v.length;){var P=x+t(v,x,l)+4;D=P-m;var j=Math.max(P-25,x),O=(0,_util.bytesToString)(v.subarray(j,P));if(i.test(O))break;var N=o.exec(O);if(N&&N[1]){(0,_util.warn)('indexObjects: Found new "obj" inside of another "obj", caused by missing "endobj" -- trying to recover.'),D-=N[1].length;break}x=P}var k=v.subarray(m,m+D),E=t(k,0,f);E<D&&k[E+5]<64&&(_.push(m-h.start),this.xrefstms[m-h.start]=1),m+=D}else w.startsWith("trailer")&&(7===w.length||/\s/.test(w[7]))?(d.push(m),m+=t(v,m,u)):m+=w.length+1}else do{if(g<=++m)break;y=v[m]}while(y!==n&&y!==a);else++m}for(var C=0,I=_.length;C<I;++C)this.startXRefQueue.push(_[C]),this.readXRef(!0);for(var F=0,A=d.length;F<A;++F){h.pos=d[F];var T=new _parser.Parser({lexer:new _parser.Lexer(h),xref:this,allowStreams:!0,recoveryMode:!0}),L=T.getObj();if((0,_primitives.isCmd)(L,"trailer")){var X=T.getObj();if((0,_primitives.isDict)(X)){try{var M=X.get("Root");if(!(M instanceof _primitives.Dict))continue;var B=M.get("Pages");if(!(B instanceof _primitives.Dict))continue;var U=B.get("Count");if(!Number.isInteger(U))continue}catch(e){continue}if(X.has("ID"))return X;p=X}}}if(p)return p;throw new _util.InvalidPDFException("Invalid PDF structure.")},readXRef:function(e){var t=this.stream,r=Object.create(null);try{for(;this.startXRefQueue.length;){var i=this.startXRefQueue[0];if(r[i])(0,_util.warn)("readXRef - skipping XRef table since it was already parsed."),this.startXRefQueue.shift();else{r[i]=!0,t.pos=i+t.start;var n,a=new _parser.Parser({lexer:new _parser.Lexer(t),xref:this,allowStreams:!0}),s=a.getObj();if((0,_primitives.isCmd)(s,"xref")){if(n=this.processXRefTable(a),this.topDict||(this.topDict=n),s=n.get("XRefStm"),Number.isInteger(s)){var o=s;o in this.xrefstms||(this.xrefstms[o]=1,this.startXRefQueue.push(o))}}else{if(!Number.isInteger(s))throw new _util.FormatError("Invalid XRef stream header");if(!Number.isInteger(a.getObj())||!(0,_primitives.isCmd)(a.getObj(),"obj")||!(0,_primitives.isStream)(s=a.getObj()))throw new _util.FormatError("Invalid XRef stream");if(n=this.processXRefStream(s),this.topDict||(this.topDict=n),!n)throw new _util.FormatError("Failed to read XRef stream")}s=n.get("Prev"),Number.isInteger(s)?this.startXRefQueue.push(s):(0,_primitives.isRef)(s)&&this.startXRefQueue.push(s.num),this.startXRefQueue.shift()}}return this.topDict}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.info)("(while reading XRef): "+e)}if(!e)throw new _core_utils.XRefParseException},getEntry:function(e){var t=this.entries[e];return t&&!t.free&&t.offset?t:null},fetchIfRef:function(e,t){return e instanceof _primitives.Ref?this.fetch(e,t):e},fetch:function(e,t){if(!(e instanceof _primitives.Ref))throw new Error("ref object is not a reference");var r=e.num,i=this._cacheMap.get(r);if(void 0!==i)return i instanceof _primitives.Dict&&!i.objId&&(i.objId=e.toString()),i;var n=this.getEntry(r);return null===n?this._cacheMap.set(r,n):(n=n.uncompressed?this.fetchUncompressed(e,n,t):this.fetchCompressed(e,n,t),(0,_primitives.isDict)(n)?n.objId=e.toString():(0,_primitives.isStream)(n)&&(n.dict.objId=e.toString())),n},fetchUncompressed:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=e.gen,n=e.num;if(t.gen!==i)throw new _core_utils.XRefEntryException("Inconsistent generation in XRef: ".concat(e));var a=this.stream.makeSubStream(t.offset+this.stream.start),s=new _parser.Parser({lexer:new _parser.Lexer(a),xref:this,allowStreams:!0}),o=s.getObj(),c=s.getObj(),u=s.getObj();if(o!==n||c!==i||!(u instanceof _primitives.Cmd))throw new _core_utils.XRefEntryException("Bad (uncompressed) XRef entry: ".concat(e));if("obj"===u.cmd)return t=this.encrypt&&!r?s.getObj(this.encrypt.createCipherTransform(n,i)):s.getObj(),(0,_primitives.isStream)(t)||this._cacheMap.set(n,t),t;if(u.cmd.startsWith("obj")&&(n=parseInt(u.cmd.substring(3),10),!Number.isNaN(n)))return n;throw new _core_utils.XRefEntryException("Bad (uncompressed) XRef entry: ".concat(e))},fetchCompressed:function(e,t){2<arguments.length&&void 0!==arguments[2]&&arguments[2];var r=t.offset,i=this.fetch(_primitives.Ref.get(r,0));if(!(0,_primitives.isStream)(i))throw new _util.FormatError("bad ObjStm stream");var n=i.dict.get("First"),a=i.dict.get("N");if(!Number.isInteger(n)||!Number.isInteger(a))throw new _util.FormatError("invalid first and n parameters for ObjStm stream");for(var s=new _parser.Parser({lexer:new _parser.Lexer(i),xref:this,allowStreams:!0}),o=new Array(a),c=new Array(a),u=0;u<a;++u){var l=s.getObj();if(!Number.isInteger(l))throw new _util.FormatError("invalid object number in the ObjStm stream: ".concat(l));var f=s.getObj();if(!Number.isInteger(f))throw new _util.FormatError("invalid object offset in the ObjStm stream: ".concat(f));o[u]=l,c[u]=f}for(var h=(i.start||0)+n,p=new Array(a),v=0;v<a;++v){var m=v<a-1?c[v+1]-c[v]:void 0;if(m<0)throw new _util.FormatError("Invalid offset in the ObjStm stream.");var g=(s=new _parser.Parser({lexer:new _parser.Lexer(i.makeSubStream(h+c[v],m,i.dict)),xref:this,allowStreams:!0})).getObj();if(p[v]=g,!(0,_primitives.isStream)(g)){var d=o[v],_=this.entries[d];_&&_.offset===r&&_.gen===v&&this._cacheMap.set(d,g)}}if(void 0===(t=p[t.gen]))throw new _core_utils.XRefEntryException("Bad (compressed) XRef entry: ".concat(e));return t},fetchIfRefAsync:function(t,r){var i=this;return _asyncToGenerator(_regeneratorRuntime().mark(function e(){return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t instanceof _primitives.Ref)return e.abrupt("return",i.fetchAsync(t,r));e.next=2;break;case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}},e)}))()},fetchAsync:function(t,r){var i=this;return _asyncToGenerator(_regeneratorRuntime().mark(function e(){return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",i.fetch(t,r));case 4:if(e.prev=4,e.t0=e.catch(0),e.t0 instanceof _core_utils.MissingDataException){e.next=8;break}throw e.t0;case 8:return e.next=10,i.pdfManager.requestRange(e.t0.begin,e.t0.end);case 10:return e.abrupt("return",i.fetchAsync(t,r));case 11:case"end":return e.stop()}},e,null,[[0,4]])}))()},getCatalogObj:function(){return this.root}},e}();exports.XRef=XRef;var NameOrNumberTree=function(){function i(e,t,r){_classCallCheck(this,i),this.constructor===i&&(0,_util.unreachable)("Cannot initialize NameOrNumberTree."),this.root=e,this.xref=t,this._type=r}return _createClass(i,[{key:"getAll",value:function(){var e=Object.create(null);if(!this.root)return e;var t=this.xref,r=new _primitives.RefSet;r.put(this.root);for(var i=[this.root];0<i.length;){var n=t.fetchIfRef(i.shift());if((0,_primitives.isDict)(n))if(n.has("Kids"))for(var a=n.get("Kids"),s=0,o=a.length;s<o;s++){var c=a[s];if(r.has(c))throw new _util.FormatError('Duplicate entry in "'.concat(this._type,'" tree.'));i.push(c),r.put(c)}else{var u=n.get(this._type);if(Array.isArray(u))for(var l=0,f=u.length;l<f;l+=2)e[t.fetchIfRef(u[l])]=t.fetchIfRef(u[l+1])}}return e}},{key:"get",value:function(e){if(!this.root)return null;for(var t=this.xref,r=t.fetchIfRef(this.root),i=0;r.has("Kids");){if(10<++i)return(0,_util.warn)('Search depth limit reached for "'.concat(this._type,'" tree.')),null;var n=r.get("Kids");if(!Array.isArray(n))return null;for(var a=0,s=n.length-1;a<=s;){var o=a+s>>1,c=t.fetchIfRef(n[o]).get("Limits");if(e<t.fetchIfRef(c[0]))s=o-1;else{if(!(e>t.fetchIfRef(c[1]))){r=t.fetchIfRef(n[o]);break}a=o+1}}if(s<a)return null}var u=r.get(this._type);if(Array.isArray(u)){for(var l=0,f=u.length-2;l<=f;){var h=l+f>>1,p=h+(1&h),v=t.fetchIfRef(u[p]);if(e<v)f=p-2;else{if(!(v<e))return t.fetchIfRef(u[p+1]);l=p+2}}(0,_util.info)('Falling back to an exhaustive search, for key "'.concat(e,'", ')+'in "'.concat(this._type,'" tree.'));for(var m=0,g=u.length;m<g;m+=2){if(t.fetchIfRef(u[m])===e)return(0,_util.warn)('The "'.concat(e,'" key was found at an incorrect, ')+'i.e. out-of-order, position in "'.concat(this._type,'" tree.')),t.fetchIfRef(u[m+1])}}return null}}]),i}(),NameTree=function(e){_inherits(i,NameOrNumberTree);var r=_createSuper(i);function i(e,t){return _classCallCheck(this,i),r.call(this,e,t,"Names")}return _createClass(i)}(),NumberTree=function(e){_inherits(i,NameOrNumberTree);var r=_createSuper(i);function i(e,t){return _classCallCheck(this,i),r.call(this,e,t,"Nums")}return _createClass(i)}(),FileSpec=function(){function e(e,t){e&&(0,_primitives.isDict)(e)&&(this.xref=t,(this.root=e).has("FS")&&(this.fs=e.get("FS")),this.description=e.has("Desc")?(0,_util.stringToPDFString)(e.get("Desc")):"",e.has("RF")&&(0,_util.warn)("Related file specifications are not supported"),this.contentAvailable=!0,e.has("EF")||(this.contentAvailable=!1,(0,_util.warn)("Non-embedded file specifications are not supported")))}function r(e){return e.has("UF")?e.get("UF"):e.has("F")?e.get("F"):e.has("Unix")?e.get("Unix"):e.has("Mac")?e.get("Mac"):e.has("DOS")?e.get("DOS"):null}return e.prototype={get filename(){if(!this._filename&&this.root){var e=r(this.root)||"unnamed";this._filename=(0,_util.stringToPDFString)(e).replace(/\\\\/g,"\\").replace(/\\\//g,"/").replace(/\\/g,"/")}return this._filename},get content(){if(!this.contentAvailable)return null;!this.contentRef&&this.root&&(this.contentRef=r(this.root.get("EF")));var e=null;if(this.contentRef){var t=this.xref.fetchIfRef(this.contentRef);t&&(0,_primitives.isStream)(t)?e=t.getBytes():(0,_util.warn)("Embedded file specification points to non-existing/invalid content")}else(0,_util.warn)("Embedded file specification does not have a content");return e},get serializable(){return{filename:this.filename,content:this.content}}},e}();exports.FileSpec=FileSpec;var ObjectLoader=function(){function m(e,t){if(e instanceof _primitives.Dict)e=e.getRawValues();else if((0,_primitives.isStream)(e))e=e.dict.getRawValues();else if(!Array.isArray(e))return;var r,i,n=_createForOfIteratorHelper(e);try{for(n.s();!(r=n.n()).done;){var a=r.value;((i=a)instanceof _primitives.Ref||i instanceof _primitives.Dict||Array.isArray(i)||(0,_primitives.isStream)(i))&&t.push(a)}}catch(e){n.e(e)}finally{n.f()}}function e(e,t,r){this.dict=e,this.keys=t,this.xref=r,this.refSet=null}return e.prototype={load:function(){var o=this;return _asyncToGenerator(_regeneratorRuntime().mark(function e(){var t,r,i,n,a,s;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o.xref.stream.allChunksLoaded||o.xref.stream.allChunksLoaded())return e.abrupt("return",void 0);e.next=2;break;case 2:for(t=o.keys,r=o.dict,o.refSet=new _primitives.RefSet,i=[],n=0,a=t.length;n<a;n++)void 0!==(s=r.getRaw(t[n]))&&i.push(s);return e.abrupt("return",o._walk(i));case 7:case"end":return e.stop()}},e)}))()},_walk:function(p){var v=this;return _asyncToGenerator(_regeneratorRuntime().mark(function e(){var t,r,i,n,a,s,o,c,u,l,f,h;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=[];case 2:if(!p.length){e.next=25;break}if(!((i=p.pop())instanceof _primitives.Ref)){e.next=21;break}if(v.refSet.has(i))return e.abrupt("continue",2);e.next=7;break;case 7:e.prev=7,v.refSet.put(i),i=v.xref.fetch(i),e.next=21;break;case 12:if(e.prev=12,e.t0=e.catch(7),e.t0 instanceof _core_utils.MissingDataException){e.next=19;break}return(0,_util.warn)('ObjectLoader._walk - requesting all data: "'.concat(e.t0,'".')),v.refSet=null,n=v.xref.stream.manager,e.abrupt("return",n.requestAllChunks());case 19:t.push(i),r.push({begin:e.t0.begin,end:e.t0.end});case 21:if(i&&i.getBaseStreams){for(a=i.getBaseStreams(),s=!1,o=0,c=a.length;o<c;o++)(u=a[o]).allChunksLoaded&&!u.allChunksLoaded()&&(s=!0,r.push({begin:u.start,end:u.end}));s&&t.push(i)}m(i,p),e.next=2;break;case 25:if(r.length)return e.next=28,v.xref.stream.manager.requestRanges(r);e.next=30;break;case 28:for(l=0,f=t.length;l<f;l++)(h=t[l])instanceof _primitives.Ref&&v.refSet.remove(h);return e.abrupt("return",v._walk(t));case 30:return v.refSet=null,e.abrupt("return",void 0);case 32:case"end":return e.stop()}},e,null,[[7,12]])}))()}},e}();exports.ObjectLoader=ObjectLoader;