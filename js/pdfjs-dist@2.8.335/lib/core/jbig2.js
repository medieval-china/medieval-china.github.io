"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(n);if(i){var r=_getPrototypeOf(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Jbig2Image=void 0;var _util=require("../shared/util.js"),_core_utils=require("./core_utils.js"),_arithmetic_decoder=require("./arithmetic_decoder.js"),_ccitt=require("./ccitt.js"),Jbig2Error=function(e){_inherits(r,_util.BaseException);var t=_createSuper(r);function r(e){return _classCallCheck(this,r),t.call(this,"JBIG2 error: ".concat(e))}return _createClass(r)}(),Jbig2Image=function(){function t(){}function g(e,t,r){this.data=e,this.start=t,this.end=r}function X(e,t,i){var a=e.getContexts(t),o=1;function r(e){for(var t=0,r=0;r<e;r++){var n=i.readBit(a,o);o=o<256?o<<1|n:511&(o<<1|n)|256,t=t<<1|n}return t>>>0}var n=r(1),s=r(1)?r(1)?r(1)?r(1)?r(1)?r(32)+4436:r(12)+340:r(8)+84:r(6)+20:r(4)+4:r(2);return 0===n?s:0<s?-s:null}function Y(e,t,r){for(var n=e.getContexts("IAID"),i=1,a=0;a<r;a++){i=i<<1|t.readBit(n,i)}return r<31?i&(1<<r)-1:2147483647&i}t.prototype={getContexts:function(e){return e in this?this[e]:this[e]=new Int8Array(65536)}},g.prototype={get decoder(){var e=new _arithmetic_decoder.ArithmeticDecoder(this.data,this.start,this.end);return(0,_util.shadow)(this,"decoder",e)},get contextCache(){var e=new t;return(0,_util.shadow)(this,"contextCache",e)}};var w=["SymbolDictionary",null,null,null,"IntermediateTextRegion",null,"ImmediateTextRegion","ImmediateLosslessTextRegion",null,null,null,null,null,null,null,null,"PatternDictionary",null,null,null,"IntermediateHalftoneRegion",null,"ImmediateHalftoneRegion","ImmediateLosslessHalftoneRegion",null,null,null,null,null,null,null,null,null,null,null,null,"IntermediateGenericRegion",null,"ImmediateGenericRegion","ImmediateLosslessGenericRegion","IntermediateGenericRefinementRegion",null,"ImmediateGenericRefinementRegion","ImmediateLosslessGenericRefinementRegion",null,null,null,null,"PageInformation","EndOfPage","EndOfStripe","EndOfFile","Profiles","Tables",null,null,null,null,null,null,null,null,"Extension"],G=[[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:2,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-2,y:0},{x:-1,y:0}],[{x:-3,y:-1},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}]],T=[{coding:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}]},{coding:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}]}],W=[39717,1941,229,405],U=[32,8];function M(e,t,r,n,i,a,o,s){if(e)return $(new z(s.data,s.start,s.end),t,r,!1);if(0===n&&!a&&!i&&4===o.length&&3===o[0].x&&-1===o[0].y&&-3===o[1].x&&-1===o[1].y&&2===o[2].x&&-2===o[2].y&&-2===o[3].x&&-2===o[3].y)return function(e,t,r){var n,i,a,o,s,f,l,u=r.decoder,c=r.contextCache.getContexts("GB"),h=[];for(i=0;i<t;i++)for(s=h[i]=new Uint8Array(e),f=i<1?s:h[i-1],n=(l=i<2?s:h[i-2])[0]<<13|l[1]<<12|l[2]<<11|f[0]<<7|f[1]<<6|f[2]<<5|f[3]<<4,a=0;a<e;a++)s[a]=o=u.readBit(c,n),n=(31735&n)<<1|(a+3<e?l[a+3]<<11:0)|(a+4<e?f[a+4]<<4:0)|o;return h}(t,r,s);var f=!!a,l=G[n].concat(o);l.sort(function(e,t){return e.y-t.y||e.x-t.x});var u,c,h=l.length,d=new Int8Array(h),p=new Int8Array(h),m=[],g=0,y=0,b=0,v=0;for(c=0;c<h;c++)d[c]=l[c].x,p[c]=l[c].y,y=Math.min(y,l[c].x),b=Math.max(b,l[c].x),v=Math.min(v,l[c].y),c<h-1&&l[c].y===l[c+1].y&&l[c].x===l[c+1].x-1?g|=1<<h-1-c:m.push(c);var w=m.length,x=new Int8Array(w),_=new Int8Array(w),I=new Uint16Array(w);for(u=0;u<w;u++)c=m[u],x[u]=l[c].x,_[u]=l[c].y,I[u]=1<<h-1-c;for(var O,S,k,A,R,D=-y,B=-v,P=t-b,T=W[n],U=new Uint8Array(t),C=[],E=s.decoder,J=s.contextCache.getContexts("GB"),L=0,H=0,j=0;j<r;j++){if(i)if(L^=E.readBit(J,T)){C.push(U);continue}for(U=new Uint8Array(U),C.push(U),O=0;O<t;O++)if(f&&a[j][O])U[O]=0;else{if(D<=O&&O<P&&B<=j)for(H=H<<1&g,c=0;c<w;c++)S=j+_[c],k=O+x[c],(A=C[S][k])&&(H|=A=I[c]);else for(R=h-1,c=H=0;c<h;c++,R--)0<=(k=O+d[c])&&k<t&&0<=(S=j+p[c])&&(A=C[S][k])&&(H|=A<<R);var N=E.readBit(J,H);U[O]=N}}return C}function q(e,t,r,n,i,a,o,s,f){var l=T[r].coding;0===r&&(l=l.concat([s[0]]));var u,c=l.length,h=new Int32Array(c),d=new Int32Array(c);for(u=0;u<c;u++)h[u]=l[u].x,d[u]=l[u].y;var p=T[r].reference;0===r&&(p=p.concat([s[1]]));var m=p.length,g=new Int32Array(m),y=new Int32Array(m);for(u=0;u<m;u++)g[u]=p[u].x,y[u]=p[u].y;for(var b=n[0].length,v=n.length,w=U[r],x=[],_=f.decoder,I=f.contextCache.getContexts("GR"),O=0,S=0;S<t;S++){if(o)if(O^=_.readBit(I,w))throw new Jbig2Error("prediction is not supported");var k=new Uint8Array(e);x.push(k);for(var A=0;A<e;A++){var R,D,B=0;for(u=0;u<c;u++)R=S+d[u],D=A+h[u],R<0||D<0||e<=D?B<<=1:B=B<<1|x[R][D];for(u=0;u<m;u++)R=S+y[u]-a,D=A+g[u]-i,R<0||v<=R||D<0||b<=D?B<<=1:B=B<<1|n[R][D];var P=_.readBit(I,B);k[A]=P}}return x}function K(e,t,r,n,i,a,o,s,f,l,u,c,h,d,p,m,g,y,b){if(e&&t)throw new Jbig2Error("refinement with Huffman is not supported");var v,w,x=[];for(v=0;v<n;v++){if(w=new Uint8Array(r),i)for(var _=0;_<r;_++)w[_]=i;x.push(w)}var I=g.decoder,O=g.contextCache,S=e?-d.tableDeltaT.decode(b):-X(O,"IADT",I),k=0;for(v=0;v<a;){S+=e?d.tableDeltaT.decode(b):X(O,"IADT",I);for(var A=k+=e?d.tableFirstS.decode(b):X(O,"IAFS",I);;){var R=0;1<o&&(R=e?b.readBits(y):X(O,"IAIT",I));var D=o*S+R,B=e?d.symbolIDTable.decode(b):Y(O,I,f),P=t&&(e?b.readBit():X(O,"IARI",I)),T=s[B],U=T[0].length,C=T.length;if(P){var E=X(O,"IARDW",I),J=X(O,"IARDH",I);T=q(U+=E,C+=J,p,T,(E>>1)+X(O,"IARDX",I),(J>>1)+X(O,"IARDY",I),!1,m,g)}var L,H,j,N=D-(1&c?0:C-1),G=A-(2&c?U-1:0);if(l){for(L=0;L<C;L++)if(w=x[G+L]){j=T[L];var W=Math.min(r-N,U);switch(h){case 0:for(H=0;H<W;H++)w[N+H]|=j[H];break;case 2:for(H=0;H<W;H++)w[N+H]^=j[H];break;default:throw new Jbig2Error("operator ".concat(h," is not supported"))}}A+=C-1}else{for(H=0;H<C;H++)if(w=x[N+H])switch(j=T[H],h){case 0:for(L=0;L<U;L++)w[G+L]|=j[L];break;case 2:for(L=0;L<U;L++)w[G+L]^=j[L];break;default:throw new Jbig2Error("operator ".concat(h," is not supported"))}A+=U-1}v++;var z=e?d.tableDeltaS.decode(b):X(O,"IADS",I);if(null===z)break;A+=z+u}}return x}function u(e,t){var r={};r.number=(0,_core_utils.readUint32)(e,t);var n=e[t+4],i=63&n;if(!w[i])throw new Jbig2Error("invalid segment type: "+i);r.type=i,r.typeName=w[i],r.deferredNonRetain=!!(128&n);var a=!!(64&n),o=e[t+5],s=o>>5&7,f=[31&o],l=t+6;if(7===o){s=536870911&(0,_core_utils.readUint32)(e,l-1),l+=3;var u=s+7>>3;for(f[0]=e[l++];0<--u;)f.push(e[l++])}else if(5===o||6===o)throw new Jbig2Error("invalid referred-to flags");r.retainBits=f;var c=4;r.number<=256?c=1:r.number<=65536&&(c=2);var h,d,p=[];for(h=0;h<s;h++){var m=void 0;m=1===c?e[l]:2===c?(0,_core_utils.readUint16)(e,l):(0,_core_utils.readUint32)(e,l),p.push(m),l+=c}if(r.referredTo=p,a?(r.pageAssociation=(0,_core_utils.readUint32)(e,l),l+=4):r.pageAssociation=e[l++],r.length=(0,_core_utils.readUint32)(e,l),l+=4,4294967295===r.length){if(38!==i)throw new Jbig2Error("invalid unknown segment length");var g=O(e,l),y=!!(1&e[l+S]),b=new Uint8Array(6);for(y||(b[0]=255,b[1]=172),b[2]=g.height>>>24&255,b[3]=g.height>>16&255,b[4]=g.height>>8&255,b[5]=255&g.height,h=l,d=e.length;h<d;h++){for(var v=0;v<6&&b[v]===e[h+v];)v++;if(6===v){r.length=h+6;break}}if(4294967295===r.length)throw new Jbig2Error("segment end was not found")}return r.headerEnd=l,r}function b(e,t,r,n){for(var i=[],a=r;a<n;){var o=u(t,a);a=o.headerEnd;var s={header:o,data:t};if(e.randomAccess||(s.start=a,a+=o.length,s.end=a),i.push(s),51===o.type)break}if(e.randomAccess)for(var f=0,l=i.length;f<l;f++)i[f].start=a,a+=i[f].header.length,i[f].end=a;return i}function O(e,t){return{width:(0,_core_utils.readUint32)(e,t),height:(0,_core_utils.readUint32)(e,t+4),x:(0,_core_utils.readUint32)(e,t+8),y:(0,_core_utils.readUint32)(e,t+12),combinationOperator:7&e[t+16]}}var S=17;function i(e,t){var r,n,i,a,o=e.header,s=e.data,f=e.start,l=e.end;switch(o.type){case 0:var u={},c=(0,_core_utils.readUint16)(s,f);if(u.huffman=!!(1&c),u.refinement=!!(2&c),u.huffmanDHSelector=c>>2&3,u.huffmanDWSelector=c>>4&3,u.bitmapSizeSelector=c>>6&1,u.aggregationInstancesSelector=c>>7&1,u.bitmapCodingContextUsed=!!(256&c),u.bitmapCodingContextRetained=!!(512&c),u.template=c>>10&3,u.refinementTemplate=c>>12&1,f+=2,!u.huffman){for(a=0===u.template?4:1,n=[],i=0;i<a;i++)n.push({x:(0,_core_utils.readInt8)(s,f),y:(0,_core_utils.readInt8)(s,f+1)}),f+=2;u.at=n}if(u.refinement&&!u.refinementTemplate){for(n=[],i=0;i<2;i++)n.push({x:(0,_core_utils.readInt8)(s,f),y:(0,_core_utils.readInt8)(s,f+1)}),f+=2;u.refinementAt=n}u.numberOfExportedSymbols=(0,_core_utils.readUint32)(s,f),f+=4,u.numberOfNewSymbols=(0,_core_utils.readUint32)(s,f),f+=4,r=[u,o.number,o.referredTo,s,f,l];break;case 6:case 7:var h={};h.info=O(s,f),f+=S;var d=(0,_core_utils.readUint16)(s,f);if(f+=2,h.huffman=!!(1&d),h.refinement=!!(2&d),h.logStripSize=d>>2&3,h.stripSize=1<<h.logStripSize,h.referenceCorner=d>>4&3,h.transposed=!!(64&d),h.combinationOperator=d>>7&3,h.defaultPixelValue=d>>9&1,h.dsOffset=d<<17>>27,h.refinementTemplate=d>>15&1,h.huffman){var p=(0,_core_utils.readUint16)(s,f);f+=2,h.huffmanFS=3&p,h.huffmanDS=p>>2&3,h.huffmanDT=p>>4&3,h.huffmanRefinementDW=p>>6&3,h.huffmanRefinementDH=p>>8&3,h.huffmanRefinementDX=p>>10&3,h.huffmanRefinementDY=p>>12&3,h.huffmanRefinementSizeSelector=!!(16384&p)}if(h.refinement&&!h.refinementTemplate){for(n=[],i=0;i<2;i++)n.push({x:(0,_core_utils.readInt8)(s,f),y:(0,_core_utils.readInt8)(s,f+1)}),f+=2;h.refinementAt=n}h.numberOfSymbolInstances=(0,_core_utils.readUint32)(s,f),f+=4,r=[h,o.referredTo,s,f,l];break;case 16:var m={},g=s[f++];m.mmr=!!(1&g),m.template=g>>1&3,m.patternWidth=s[f++],m.patternHeight=s[f++],m.maxPatternIndex=(0,_core_utils.readUint32)(s,f),f+=4,r=[m,o.number,s,f,l];break;case 22:case 23:var y={};y.info=O(s,f),f+=S;var b=s[f++];y.mmr=!!(1&b),y.template=b>>1&3,y.enableSkip=!!(8&b),y.combinationOperator=b>>4&7,y.defaultPixelValue=b>>7&1,y.gridWidth=(0,_core_utils.readUint32)(s,f),f+=4,y.gridHeight=(0,_core_utils.readUint32)(s,f),f+=4,y.gridOffsetX=4294967295&(0,_core_utils.readUint32)(s,f),f+=4,y.gridOffsetY=4294967295&(0,_core_utils.readUint32)(s,f),f+=4,y.gridVectorX=(0,_core_utils.readUint16)(s,f),f+=2,y.gridVectorY=(0,_core_utils.readUint16)(s,f),f+=2,r=[y,o.referredTo,s,f,l];break;case 38:case 39:var v={};v.info=O(s,f),f+=S;var w=s[f++];if(v.mmr=!!(1&w),v.template=w>>1&3,v.prediction=!!(8&w),!v.mmr){for(a=0===v.template?4:1,n=[],i=0;i<a;i++)n.push({x:(0,_core_utils.readInt8)(s,f),y:(0,_core_utils.readInt8)(s,f+1)}),f+=2;v.at=n}r=[v,s,f,l];break;case 48:var x={width:(0,_core_utils.readUint32)(s,f),height:(0,_core_utils.readUint32)(s,f+4),resolutionX:(0,_core_utils.readUint32)(s,f+8),resolutionY:(0,_core_utils.readUint32)(s,f+12)};4294967295===x.height&&delete x.height;var _=s[f+16];(0,_core_utils.readUint16)(s,f+17),x.lossless=!!(1&_),x.refinement=!!(2&_),x.defaultPixelValue=_>>2&1,x.combinationOperator=_>>3&3,x.requiresBuffer=!!(32&_),x.combinationOperatorOverride=!!(64&_),r=[x];break;case 49:case 50:case 51:break;case 53:r=[o.number,s,f,l];break;case 62:break;default:throw new Jbig2Error("segment type ".concat(o.typeName,"(").concat(o.type,")")+" is not implemented")}var I="on"+o.typeName;I in t&&t[I].apply(t,r)}function v(e,t){for(var r=0,n=e.length;r<n;r++)i(e[r],t)}function x(){}function _(e){2===e.length?(this.isOOB=!0,this.rangeLow=0,this.prefixLength=e[0],this.rangeLength=0,this.prefixCode=e[1],this.isLowerRange=!1):(this.isOOB=!1,this.rangeLow=e[0],this.prefixLength=e[1],this.rangeLength=e[2],this.prefixCode=e[3],this.isLowerRange="lower"===e[4])}function a(e){this.children=[],e?(this.isLeaf=!0,this.rangeLength=e.rangeLength,this.rangeLow=e.rangeLow,this.isLowerRange=e.isLowerRange,this.isOOB=e.isOOB):this.isLeaf=!1}function I(e,t){t||this.assignPrefixCodes(e),this.rootNode=new a(null);for(var r=0,n=e.length;r<n;r++){var i=e[r];0<i.prefixLength&&this.rootNode.buildTree(i,i.prefixLength-1)}}x.prototype={onPageInformation:function(e){var t=(this.currentPageInfo=e).width+7>>3,r=new Uint8ClampedArray(t*e.height);if(e.defaultPixelValue)for(var n=0,i=r.length;n<i;n++)r[n]=255;this.buffer=r},drawBitmap:function(e,t){var r,n,i,a,o=this.currentPageInfo,s=e.width,f=e.height,l=o.width+7>>3,u=o.combinationOperatorOverride?e.combinationOperator:o.combinationOperator,c=this.buffer,h=128>>(7&e.x),d=e.y*l+(e.x>>3);switch(u){case 0:for(r=0;r<f;r++){for(i=h,a=d,n=0;n<s;n++)t[r][n]&&(c[a]|=i),(i>>=1)||(i=128,a++);d+=l}break;case 2:for(r=0;r<f;r++){for(i=h,a=d,n=0;n<s;n++)t[r][n]&&(c[a]^=i),(i>>=1)||(i=128,a++);d+=l}break;default:throw new Jbig2Error("operator ".concat(u," is not supported"))}},onImmediateGenericRegion:function(e,t,r,n){var i=e.info,a=new g(t,r,n),o=M(e.mmr,i.width,i.height,e.template,e.prediction,null,e.at,a);this.drawBitmap(i,o)},onImmediateLosslessGenericRegion:function(){this.onImmediateGenericRegion.apply(this,arguments)},onSymbolDictionary:function(e,t,r,n,i,a){var o,s;e.huffman&&(o=function(e,t,r){var n,i,a,o,s=0;switch(e.huffmanDHSelector){case 0:case 1:n=Q(e.huffmanDHSelector+4);break;case 3:n=k(s,t,r),s++;break;default:throw new Jbig2Error("invalid Huffman DH selector")}switch(e.huffmanDWSelector){case 0:case 1:i=Q(e.huffmanDWSelector+2);break;case 3:i=k(s,t,r),s++;break;default:throw new Jbig2Error("invalid Huffman DW selector")}e.bitmapSizeSelector?(a=k(s,t,r),s++):a=Q(1);o=e.aggregationInstancesSelector?k(s,t,r):Q(1);return{tableDeltaHeight:n,tableDeltaWidth:i,tableBitmapSize:a,tableAggregateInstances:o}}(e,r,this.customTables),s=new z(n,i,a));var f=this.symbols;f||(this.symbols=f={});for(var l=[],u=0,c=r.length;u<c;u++){var h=f[r[u]];h&&(l=l.concat(h))}var d=new g(n,i,a);f[t]=function(e,t,r,n,i,a,o,s,f,l,u,c){if(e&&t)throw new Jbig2Error("symbol refinement with Huffman is not supported");var h,d,p=[],m=0,g=(0,_core_utils.log2)(r.length+n),y=u.decoder,b=u.contextCache;for(e&&(h=Q(1),d=[],g=Math.max(g,1));p.length<n;){m+=e?a.tableDeltaHeight.decode(c):X(b,"IADH",y);for(var v=0,w=0,x=e?d.length:0;;){var _,I=e?a.tableDeltaWidth.decode(c):X(b,"IADW",y);if(null===I)break;if(w+=v+=I,t){var O=X(b,"IAAI",y);if(1<O)_=K(e,t,v,m,0,O,1,r.concat(p),g,0,0,1,0,a,f,l,u,0,c);else{var S=Y(b,y,g),k=X(b,"IARDX",y),A=X(b,"IARDY",y);_=q(v,m,f,S<r.length?r[S]:p[S-r.length],k,A,!1,l,u)}p.push(_)}else e?d.push(v):(_=M(!1,v,m,o,!1,null,s,u),p.push(_))}if(e&&!t){var R=a.tableBitmapSize.decode(c);c.byteAlign();var D=void 0;if(0===R)D=Z(c,w,m);else{var B=c.end,P=c.position+R;c.end=P,D=$(c,w,m,!1),c.end=B,c.position=P}var T=d.length;if(x===T-1)p.push(D);else{var U=void 0,C=void 0,E=0,J=void 0,L=void 0;for(U=x;U<T;U++){for(J=E+d[U],L=[],C=0;C<m;C++)L.push(D[C].subarray(E,J));p.push(L),E=J}}}}for(var H=[],j=[],N=!1,G=r.length+n;j.length<G;){for(var W=e?h.decode(c):X(b,"IAEX",y);W--;)j.push(N);N=!N}for(var z=0,V=r.length;z<V;z++)j[z]&&H.push(r[z]);for(var F=0;F<n;z++,F++)j[z]&&H.push(p[F]);return H}(e.huffman,e.refinement,l,e.numberOfNewSymbols,e.numberOfExportedSymbols,o,e.template,e.at,e.refinementTemplate,e.refinementAt,d,s)},onImmediateTextRegion:function(e,t,r,n,i){for(var a,o,s=e.info,f=this.symbols,l=[],u=0,c=t.length;u<c;u++){var h=f[t[u]];h&&(l=l.concat(h))}var d=(0,_core_utils.log2)(l.length);e.huffman&&(o=new z(r,n,i),a=function(e,t,r,n,i){for(var a=[],o=0;o<=34;o++){var s=i.readBits(4);a.push(new _([o,s,0,0]))}for(var f=new I(a,!1),l=a.length=0;l<n;){var u=f.decode(i);if(32<=u){var c=void 0,h=void 0,d=void 0;switch(u){case 32:if(0===l)throw new Jbig2Error("no previous value in symbol ID table");h=i.readBits(2)+3,c=a[l-1].prefixLength;break;case 33:h=i.readBits(3)+3,c=0;break;case 34:h=i.readBits(7)+11,c=0;break;default:throw new Jbig2Error("invalid code length in symbol ID table")}for(d=0;d<h;d++)a.push(new _([l,c,0,0])),l++}else a.push(new _([l,u,0,0])),l++}i.byteAlign();var p,m,g,y=new I(a,!1),b=0;switch(e.huffmanFS){case 0:case 1:p=Q(e.huffmanFS+6);break;case 3:p=k(b,t,r),b++;break;default:throw new Jbig2Error("invalid Huffman FS selector")}switch(e.huffmanDS){case 0:case 1:case 2:m=Q(e.huffmanDS+8);break;case 3:m=k(b,t,r),b++;break;default:throw new Jbig2Error("invalid Huffman DS selector")}switch(e.huffmanDT){case 0:case 1:case 2:g=Q(e.huffmanDT+11);break;case 3:g=k(b,t,r),b++;break;default:throw new Jbig2Error("invalid Huffman DT selector")}if(e.refinement)throw new Jbig2Error("refinement with Huffman is not supported");return{symbolIDTable:y,tableFirstS:p,tableDeltaS:m,tableDeltaT:g}}(e,t,this.customTables,l.length,o));var p=new g(r,n,i),m=K(e.huffman,e.refinement,s.width,s.height,e.defaultPixelValue,e.numberOfSymbolInstances,e.stripSize,l,d,e.transposed,e.dsOffset,e.referenceCorner,e.combinationOperator,a,e.refinementTemplate,e.refinementAt,p,e.logStripSize,o);this.drawBitmap(s,m)},onImmediateLosslessTextRegion:function(){this.onImmediateTextRegion.apply(this,arguments)},onPatternDictionary:function(e,t,r,n,i){var a=this.patterns;a||(this.patterns=a={});var o=new g(r,n,i);a[t]=function(e,t,r,n,i,a){var o=[];e||(o.push({x:-t,y:0}),0===i&&(o.push({x:-3,y:-1}),o.push({x:2,y:-2}),o.push({x:-2,y:-2})));for(var s=M(e,(n+1)*t,r,i,!1,null,o,a),f=[],l=0;l<=n;l++){for(var u=[],c=t*l,h=c+t,d=0;d<r;d++)u.push(s[d].subarray(c,h));f.push(u)}return f}(e.mmr,e.patternWidth,e.patternHeight,e.maxPatternIndex,e.template,o)},onImmediateHalftoneRegion:function(e,t,r,n,i){var a=this.patterns[t[0]],o=e.info,s=new g(r,n,i),f=function(e,t,r,n,i,a,o,s,f,l,u,c,h,d,p){if(o)throw new Jbig2Error("skip is not supported");if(0!==s)throw new Jbig2Error("operator "+s+" is not supported in halftone region");var m,g,y,b=[];for(m=0;m<i;m++){if(y=new Uint8Array(n),a)for(g=0;g<n;g++)y[g]=a;b.push(y)}var v=t.length,w=t[0],x=w[0].length,_=w.length,I=(0,_core_utils.log2)(v),O=[];e||(O.push({x:r<=1?3:2,y:-1}),0===r&&(O.push({x:-3,y:-1}),O.push({x:2,y:-2}),O.push({x:-2,y:-2})));var S,k,A,R,D,B,P,T,U,C,E,J=[];for(e&&(S=new z(p.data,p.start,p.end)),m=I-1;0<=m;m--)k=e?$(S,f,l,!0):M(!1,f,l,r,!1,null,O,p),J[m]=k;for(A=0;A<l;A++)for(R=0;R<f;R++){for(B=D=0,g=I-1;0<=g;g--)B|=(D=J[g][A][R]^D)<<g;if(P=t[B],U=c+A*h-R*d>>8,0<=(T=u+A*d+R*h>>8)&&T+x<=n&&0<=U&&U+_<=i)for(m=0;m<_;m++)for(E=b[U+m],C=P[m],g=0;g<x;g++)E[T+g]|=C[g];else{var L=void 0,H=void 0;for(m=0;m<_;m++)if(!((H=U+m)<0||i<=H))for(E=b[H],C=P[m],g=0;g<x;g++)0<=(L=T+g)&&L<n&&(E[L]|=C[g])}}return b}(e.mmr,a,e.template,o.width,o.height,e.defaultPixelValue,e.enableSkip,e.combinationOperator,e.gridWidth,e.gridHeight,e.gridOffsetX,e.gridOffsetY,e.gridVectorX,e.gridVectorY,s);this.drawBitmap(o,f)},onImmediateLosslessHalftoneRegion:function(){this.onImmediateHalftoneRegion.apply(this,arguments)},onTables:function(e,t,r,n){var i=this.customTables;i||(this.customTables=i={}),i[e]=function(e,t,r){var n,i,a=e[t],o=4294967295&(0,_core_utils.readUint32)(e,t+1),s=4294967295&(0,_core_utils.readUint32)(e,t+5),f=new z(e,t+9,r),l=1+(a>>1&7),u=1+(a>>4&7),c=[],h=o;for(;n=f.readBits(l),i=f.readBits(u),c.push(new _([h,n,i,0])),h+=1<<i,h<s;);n=f.readBits(l),c.push(new _([o-1,n,32,0,"lower"])),n=f.readBits(l),c.push(new _([s,n,32,0])),1&a&&(n=f.readBits(l),c.push(new _([n,0])));return new I(c,!1)}(t,r,n)}},a.prototype={buildTree:function(e,t){var r=e.prefixCode>>t&1;if(t<=0)this.children[r]=new a(e);else{var n=this.children[r];n||(this.children[r]=n=new a(null)),n.buildTree(e,t-1)}},decodeNode:function(e){if(this.isLeaf){if(this.isOOB)return null;var t=e.readBits(this.rangeLength);return this.rangeLow+(this.isLowerRange?-t:t)}var r=this.children[e.readBit()];if(!r)throw new Jbig2Error("invalid Huffman data");return r.decodeNode(e)}},I.prototype={decode:function(e){return this.rootNode.decodeNode(e)},assignPrefixCodes:function(e){for(var t=e.length,r=0,n=0;n<t;n++)r=Math.max(r,e[n].prefixLength);for(var i=new Uint32Array(r+1),a=0;a<t;a++)i[e[a].prefixLength]++;var o,s,f,l=1,u=0;for(i[0]=0;l<=r;){for(o=u=u+i[l-1]<<1,s=0;s<t;)(f=e[s]).prefixLength===l&&(f.prefixCode=o,o++),s++;l++}}};var o={};function Q(e){var t,r=o[e];if(r)return r;switch(e){case 1:t=[[0,1,4,0],[16,2,8,2],[272,3,16,6],[65808,3,32,7]];break;case 2:t=[[0,1,0,0],[1,2,0,2],[2,3,0,6],[3,4,3,14],[11,5,6,30],[75,6,32,62],[6,63]];break;case 3:t=[[-256,8,8,254],[0,1,0,0],[1,2,0,2],[2,3,0,6],[3,4,3,14],[11,5,6,30],[-257,8,32,255,"lower"],[75,7,32,126],[6,62]];break;case 4:t=[[1,1,0,0],[2,2,0,2],[3,3,0,6],[4,4,3,14],[12,5,6,30],[76,5,32,31]];break;case 5:t=[[-255,7,8,126],[1,1,0,0],[2,2,0,2],[3,3,0,6],[4,4,3,14],[12,5,6,30],[-256,7,32,127,"lower"],[76,6,32,62]];break;case 6:t=[[-2048,5,10,28],[-1024,4,9,8],[-512,4,8,9],[-256,4,7,10],[-128,5,6,29],[-64,5,5,30],[-32,4,5,11],[0,2,7,0],[128,3,7,2],[256,3,8,3],[512,4,9,12],[1024,4,10,13],[-2049,6,32,62,"lower"],[2048,6,32,63]];break;case 7:t=[[-1024,4,9,8],[-512,3,8,0],[-256,4,7,9],[-128,5,6,26],[-64,5,5,27],[-32,4,5,10],[0,4,5,11],[32,5,5,28],[64,5,6,29],[128,4,7,12],[256,3,8,1],[512,3,9,2],[1024,3,10,3],[-1025,5,32,30,"lower"],[2048,5,32,31]];break;case 8:t=[[-15,8,3,252],[-7,9,1,508],[-5,8,1,253],[-3,9,0,509],[-2,7,0,124],[-1,4,0,10],[0,2,1,0],[2,5,0,26],[3,6,0,58],[4,3,4,4],[20,6,1,59],[22,4,4,11],[38,4,5,12],[70,5,6,27],[134,5,7,28],[262,6,7,60],[390,7,8,125],[646,6,10,61],[-16,9,32,510,"lower"],[1670,9,32,511],[2,1]];break;case 9:t=[[-31,8,4,252],[-15,9,2,508],[-11,8,2,253],[-7,9,1,509],[-5,7,1,124],[-3,4,1,10],[-1,3,1,2],[1,3,1,3],[3,5,1,26],[5,6,1,58],[7,3,5,4],[39,6,2,59],[43,4,5,11],[75,4,6,12],[139,5,7,27],[267,5,8,28],[523,6,8,60],[779,7,9,125],[1291,6,11,61],[-32,9,32,510,"lower"],[3339,9,32,511],[2,0]];break;case 10:t=[[-21,7,4,122],[-5,8,0,252],[-4,7,0,123],[-3,5,0,24],[-2,2,2,0],[2,5,0,25],[3,6,0,54],[4,7,0,124],[5,8,0,253],[6,2,6,1],[70,5,5,26],[102,6,5,55],[134,6,6,56],[198,6,7,57],[326,6,8,58],[582,6,9,59],[1094,6,10,60],[2118,7,11,125],[-22,8,32,254,"lower"],[4166,8,32,255],[2,2]];break;case 11:t=[[1,1,0,0],[2,2,1,2],[4,4,0,12],[5,4,1,13],[7,5,1,28],[9,5,2,29],[13,6,2,60],[17,7,2,122],[21,7,3,123],[29,7,4,124],[45,7,5,125],[77,7,6,126],[141,7,32,127]];break;case 12:t=[[1,1,0,0],[2,2,0,2],[3,3,1,6],[5,5,0,28],[6,5,1,29],[8,6,1,60],[10,7,0,122],[11,7,1,123],[13,7,2,124],[17,7,3,125],[25,7,4,126],[41,8,5,254],[73,8,32,255]];break;case 13:t=[[1,1,0,0],[2,3,0,4],[3,4,0,12],[4,5,0,28],[5,4,1,13],[7,3,3,5],[15,6,1,58],[17,6,2,59],[21,6,3,60],[29,6,4,61],[45,6,5,62],[77,7,6,126],[141,7,32,127]];break;case 14:t=[[-2,3,0,4],[-1,3,0,5],[0,1,0,0],[1,3,0,6],[2,3,0,7]];break;case 15:t=[[-24,7,4,124],[-8,6,2,60],[-4,5,1,28],[-2,4,0,12],[-1,3,0,4],[0,1,0,0],[1,3,0,5],[2,4,0,13],[3,5,1,29],[5,6,2,61],[9,7,4,125],[-25,7,32,126,"lower"],[25,7,32,127]];break;default:throw new Jbig2Error("standard table B.".concat(e," does not exist"))}for(var n=0,i=t.length;n<i;n++)t[n]=new _(t[n]);return r=new I(t,!0),o[e]=r}function z(e,t,r){this.data=e,this.start=t,this.end=r,this.position=t,this.shift=-1,this.currentByte=0}function k(e,t,r){for(var n=0,i=0,a=t.length;i<a;i++){var o=r[t[i]];if(o){if(e===n)return o;n++}}throw new Jbig2Error("can't find custom Huffman table")}function Z(e,t,r){for(var n=[],i=0;i<r;i++){var a=new Uint8Array(t);n.push(a);for(var o=0;o<t;o++)a[o]=e.readBit();e.byteAlign()}return n}function $(e,t,r,n){for(var i,a={K:-1,Columns:t,Rows:r,BlackIs1:!0,EndOfBlock:n},o=new _ccitt.CCITTFaxDecoder(e,a),s=[],f=!1,l=0;l<r;l++){var u=new Uint8Array(t);s.push(u);for(var c=-1,h=0;h<t;h++)c<0&&(-1===(i=o.readNextChar())&&(f=!(i=0)),c=7),u[h]=i>>c&1,c--}if(n&&!f)for(var d=0;d<5&&-1!==o.readNextChar();d++);return s}function e(){}return z.prototype={readBit:function(){if(this.shift<0){if(this.position>=this.end)throw new Jbig2Error("end of data while reading bit");this.currentByte=this.data[this.position++],this.shift=7}var e=this.currentByte>>this.shift&1;return this.shift--,e},readBits:function(e){var t,r=0;for(t=e-1;0<=t;t--)r|=this.readBit()<<t;return r},byteAlign:function(){this.shift=-1},next:function(){return this.position>=this.end?-1:this.data[this.position++]}},e.prototype={parseChunks:function(e){return function(e){for(var t=new x,r=0,n=e.length;r<n;r++){var i=e[r];v(b({},i.data,i.start,i.end),t)}return t.buffer}(e)},parse:function(e){var t=function(e){var t=e.length,r=0;if(151!==e[r]||74!==e[r+1]||66!==e[r+2]||50!==e[r+3]||13!==e[r+4]||10!==e[r+5]||26!==e[r+6]||10!==e[r+7])throw new Jbig2Error("parseJbig2 - invalid header.");var n=Object.create(null);r+=8;var i=e[r++];n.randomAccess=!(1&i),2&i||(n.numberOfPages=(0,_core_utils.readUint32)(e,r),r+=4);var a=b(n,e,r,t),o=new x;v(a,o);for(var s=o.currentPageInfo,f=s.width,l=s.height,u=o.buffer,c=new Uint8ClampedArray(f*l),h=0,d=0,p=0;p<l;p++)for(var m=0,g=void 0,y=0;y<f;y++)m||(m=128,g=u[d++]),c[h++]=g&m?0:255,m>>=1;return{imgData:c,width:f,height:l}}(e),r=t.imgData,n=t.width,i=t.height;return this.width=n,this.height=i,r}},e}();exports.Jbig2Image=Jbig2Image;