"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var a,i,n,o,s=[],c=!0,l=!1;try{if(n=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(a=n.call(r)).done)&&(s.push(a.value),s.length!==t);c=!0);}catch(e){l=!0,i=e}finally{try{if(!c&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return s}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _regeneratorRuntime(){_regeneratorRuntime=function(){return o};var o={},e=Object.prototype,u=e.hasOwnProperty,f=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},i=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",a=t.toStringTag||"@@toStringTag";function n(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{n({},"")}catch(e){n=function(e,t,r){return e[t]=r}}function s(e,t,r,a){var n,o,s,c,i=t&&t.prototype instanceof p?t:p,l=Object.create(i.prototype),u=new x(a||[]);return f(l,"_invoke",{value:(n=e,o=r,s=u,c="suspendedStart",function(e,t){if("executing"===c)throw new Error("Generator is already running");if("completed"===c){if("throw"===e)throw t;return w()}for(s.method=e,s.arg=t;;){var r=s.delegate;if(r){var a=b(r,s);if(a){if(a===h)continue;return a}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===c)throw c="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);c="executing";var i=d(n,o,s);if("normal"===i.type){if(c=s.done?"completed":"suspendedYield",i.arg===h)continue;return{value:i.arg,done:s.done}}"throw"===i.type&&(c="completed",s.method="throw",s.arg=i.arg)}})}),l}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}o.wrap=s;var h={};function p(){}function c(){}function l(){}var g={};n(g,i,function(){return this});var m=Object.getPrototypeOf,v=m&&m(m(C([])));v&&v!==e&&u.call(v,i)&&(g=v);var _=l.prototype=p.prototype=Object.create(g);function S(e){["next","throw","return"].forEach(function(t){n(e,t,function(e){return this._invoke(t,e)})})}function y(c,l){var t;f(this,"_invoke",{value:function(r,a){function e(){return new l(function(e,t){!function t(e,r,a,i){var n=d(c[e],c,r);if("throw"!==n.type){var o=n.arg,s=o.value;return s&&"object"==_typeof(s)&&u.call(s,"__await")?l.resolve(s.__await).then(function(e){t("next",e,a,i)},function(e){t("throw",e,a,i)}):l.resolve(s).then(function(e){o.value=e,a(o)},function(e){return t("throw",e,a,i)})}i(n.arg)}(r,a,e,t)})}return t=t?t.then(e,e):e()}})}function b(e,t){var r=t.method,a=e.iterator[r];if(void 0===a)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h;var i=d(a,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var n=i.arg;return n?n.done?(t[e.resultName]=n.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):n:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function C(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function e(){for(;++r<t.length;)if(u.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return a.next=a}}return{next:w}}function w(){return{value:void 0,done:!0}}return f(_,"constructor",{value:c.prototype=l,configurable:!0}),f(l,"constructor",{value:c,configurable:!0}),c.displayName=n(l,a,"GeneratorFunction"),o.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===c||"GeneratorFunction"===(t.displayName||t.name))},o.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,n(e,a,"GeneratorFunction")),e.prototype=Object.create(_),e},o.awrap=function(e){return{__await:e}},S(y.prototype),n(y.prototype,r,function(){return this}),o.AsyncIterator=y,o.async=function(e,t,r,a,i){void 0===i&&(i=Promise);var n=new y(s(e,t,r,a),i);return o.isGeneratorFunction(t)?n:n.next().then(function(e){return e.done?e.value:n.next()})},S(_),n(_,a,"Generator"),n(_,i,function(){return this}),n(_,"toString",function(){return"[object Generator]"}),o.keys=function(e){var r=Object(e),a=[];for(var t in r)a.push(t);return a.reverse(),function e(){for(;a.length;){var t=a.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},o.values=C,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&u.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var a=this;function e(e,t){return n.type="throw",n.arg=r,a.next=e,t&&(a.method="next",a.arg=void 0),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t],n=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var o=u.call(i,"catchLoc"),s=u.call(i,"finallyLoc");if(o&&s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(o){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&u.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var n=i?i.completion:{};return n.type=e,n.arg=t,i?(this.method="next",this.next=i.finallyLoc,h):this.complete(n)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var a=r.completion;if("throw"===a.type){var i=a.arg;O(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},o}function asyncGeneratorStep(e,t,r,a,i,n,o){try{var s=e[n](o),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(a,i)}function _asyncToGenerator(s){return function(){var e=this,o=arguments;return new Promise(function(t,r){var a=s.apply(e,o);function i(e){asyncGeneratorStep(a,t,r,i,n,"next",e)}function n(e){asyncGeneratorStep(a,t,r,i,n,"throw",e)}i(void 0)})}}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,n=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,_toPropertyKey(a.key),a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var a=r.call(e,t||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PartialEvaluator=exports.EvaluatorPreprocessor=void 0;var _util=require("../shared/util.js"),_cmap=require("./cmap.js"),_primitives=require("./primitives.js"),_stream=require("./stream.js"),_fonts=require("./fonts.js"),_encodings=require("./encodings.js"),_unicode=require("./unicode.js"),_standard_fonts=require("./standard_fonts.js"),_pattern=require("./pattern.js"),_function=require("./function.js"),_parser=require("./parser.js"),_image_utils=require("./image_utils.js"),_bidi=require("./bidi.js"),_colorspace=require("./colorspace.js"),_glyphlist=require("./glyphlist.js"),_core_utils=require("./core_utils.js"),_metrics=require("./metrics.js"),_murmurhash=require("./murmurhash3.js"),_operator_list=require("./operator_list.js"),_image=require("./image.js"),DefaultPartialEvaluatorOptions=Object.freeze({maxImageSize:-1,disableFontFace:!1,ignoreErrors:!1,isEvalSupported:!0,fontExtraProperties:!1}),PatternType={TILING:1,SHADING:2},deferred=Promise.resolve();function normalizeBlendMode(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(Array.isArray(e)){for(var r=0,a=e.length;r<a;r++){var i=normalizeBlendMode(e[r],!0);if(i)return i}return(0,_util.warn)("Unsupported blend mode Array: ".concat(e)),"source-over"}if(!(0,_primitives.isName)(e))return t?null:"source-over";switch(e.name){case"Normal":case"Compatible":return"source-over";case"Multiply":return"multiply";case"Screen":return"screen";case"Overlay":return"overlay";case"Darken":return"darken";case"Lighten":return"lighten";case"ColorDodge":return"color-dodge";case"ColorBurn":return"color-burn";case"HardLight":return"hard-light";case"SoftLight":return"soft-light";case"Difference":return"difference";case"Exclusion":return"exclusion";case"Hue":return"hue";case"Saturation":return"saturation";case"Color":return"color";case"Luminosity":return"luminosity"}return t?null:((0,_util.warn)("Unsupported blend mode: ".concat(e.name)),"source-over")}var TimeSlotManager=function(){function e(){_classCallCheck(this,e),this.reset()}return _createClass(e,[{key:"check",value:function(){return!(++this.checked<e.CHECK_TIME_EVERY)&&(this.checked=0,this.endTime<=Date.now())}},{key:"reset",value:function(){this.endTime=Date.now()+e.TIME_SLOT_DURATION_MS,this.checked=0}}],[{key:"TIME_SLOT_DURATION_MS",get:function(){return(0,_util.shadow)(this,"TIME_SLOT_DURATION_MS",20)}},{key:"CHECK_TIME_EVERY",get:function(){return(0,_util.shadow)(this,"CHECK_TIME_EVERY",100)}}]),e}(),PartialEvaluator=function(){function S(e){var t=e.xref,r=e.handler,a=e.pageIndex,i=e.idFactory,n=e.fontCache,o=e.builtInCMapCache,s=e.globalImageCache,c=e.options,l=void 0===c?null:c;_classCallCheck(this,S),this.xref=t,this.handler=r,this.pageIndex=a,this.idFactory=i,this.fontCache=n,this.builtInCMapCache=o,this.globalImageCache=s,this.options=l||DefaultPartialEvaluatorOptions,this.parsingType3Font=!1,this._fetchBuiltInCMapBound=this.fetchBuiltInCMap.bind(this)}var t,r,a,i,s,n;return _createClass(S,[{key:"_pdfFunctionFactory",get:function(){var e=new _function.PDFFunctionFactory({xref:this.xref,isEvalSupported:this.options.isEvalSupported});return(0,_util.shadow)(this,"_pdfFunctionFactory",e)}},{key:"clone",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:DefaultPartialEvaluatorOptions,t=Object.create(this);return t.options=e,t}},{key:"hasBlendModes",value:function(e,t){if(!(e instanceof _primitives.Dict))return!1;if(e.objId&&t.has(e.objId))return!1;var r=new _primitives.RefSet(t);e.objId&&r.put(e.objId);for(var a=[e],i=this.xref;a.length;){var n=a.shift(),o=n.get("ExtGState");if(o instanceof _primitives.Dict){var s,c=_createForOfIteratorHelper(o.getRawValues());try{for(c.s();!(s=c.n()).done;){var l=s.value;if(l instanceof _primitives.Ref){if(r.has(l))continue;try{l=i.fetch(l)}catch(e){r.put(l),(0,_util.info)('hasBlendModes - ignoring ExtGState: "'.concat(e,'".'));continue}}if(l instanceof _primitives.Dict){l.objId&&r.put(l.objId);var u=l.get("BM");if(u instanceof _primitives.Name){if("Normal"!==u.name)return!0}else if(void 0!==u&&Array.isArray(u)){var f,d=_createForOfIteratorHelper(u);try{for(d.s();!(f=d.n()).done;){var h=f.value;if(h instanceof _primitives.Name&&"Normal"!==h.name)return!0}}catch(e){d.e(e)}finally{d.f()}}}}}catch(e){c.e(e)}finally{c.f()}}var p=n.get("XObject");if(p instanceof _primitives.Dict){var g,m=_createForOfIteratorHelper(p.getRawValues());try{for(m.s();!(g=m.n()).done;){var v=g.value;if(v instanceof _primitives.Ref){if(r.has(v))continue;try{v=i.fetch(v)}catch(e){r.put(v),(0,_util.info)('hasBlendModes - ignoring XObject: "'.concat(e,'".'));continue}}if((0,_primitives.isStream)(v)){v.dict.objId&&r.put(v.dict.objId);var _=v.dict.get("Resources");_ instanceof _primitives.Dict&&(_.objId&&r.has(_.objId)||(a.push(_),_.objId&&r.put(_.objId)))}}}catch(e){m.e(e)}finally{m.f()}}}return r.forEach(function(e){t.put(e)}),!1}},{key:"fetchBuiltInCMap",value:(n=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var r,a,i,n;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.builtInCMapCache.get(t))return e.abrupt("return",r);e.next=3;break;case 3:return a=this.handler.sendWithStream("FetchBuiltInCMap",{name:t}),i=a.getReader(),e.next=7,new Promise(function(a,e){!function r(){i.read().then(function(e){var t=e.value;e.done||(a(t),r())},e)}()});case 7:return(n=e.sent).compressionType!==_util.CMapCompressionType.NONE&&this.builtInCMapCache.set(t,n),e.abrupt("return",n);case 10:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"buildFormXObject",value:(s=_asyncToGenerator(_regeneratorRuntime().mark(function e(t,r,a,i,n,o,s){var c,l,u,f,d,h,p,g,m,v;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=r.dict,l=c.getArray("Matrix"),u=c.getArray("BBox"),u=Array.isArray(u)&&4===u.length?_util.Util.normalizeRect(u):null,f=null,c.has("OC"))return e.next=8,this.parseMarkedContentProps(c.get("OC"),t);e.next=10;break;case 8:f=e.sent,i.addOp(_util.OPS.beginMarkedContentProps,["OC",f]);case 10:if(!(d=c.get("Group"))){e.next=30;break}if(h={matrix:l,bbox:u,smask:a,isolated:!1,knockout:!1},p=d.get("S"),g=null,!(0,_primitives.isName)(p,"Transparency")){e.next=28;break}if(h.isolated=d.get("I")||!1,h.knockout=d.get("K")||!1,!d.has("CS")){e.next=28;break}if(m=d.getRaw("CS"),!(v=_colorspace.ColorSpace.getCached(m,this.xref,s))){e.next=25;break}g=v,e.next=28;break;case 25:return e.next=27,this.parseColorSpace({cs:m,resources:t,localColorSpaceCache:s});case 27:g=e.sent;case 28:a&&a.backdrop&&(g=g||_colorspace.ColorSpace.singletons.rgb,a.backdrop=g.getRgb(a.backdrop,0)),i.addOp(_util.OPS.beginGroup,[h]);case 30:return i.addOp(_util.OPS.paintFormXObjectBegin,[l,u]),e.abrupt("return",this.getOperatorList({stream:r,task:n,resources:c.get("Resources")||t,operatorList:i,initialState:o}).then(function(){i.addOp(_util.OPS.paintFormXObjectEnd,[]),d&&i.addOp(_util.OPS.endGroup,[h]),f&&i.addOp(_util.OPS.endMarkedContent,[])}));case 32:case"end":return e.stop()}},e,this)})),function(e,t,r,a,i,n,o){return s.apply(this,arguments)})},{key:"_sendImgData",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2],a=t?[t.data.buffer]:null;return this.parsingType3Font||r?this.handler.send("commonobj",[e,"Image",t],a):this.handler.send("obj",[e,this.pageIndex,"Image",t],a)}},{key:"buildPaintImageXObject",value:(i=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var r,a,i,n,o,s,c,l,u,f,d,h,p,g,m,v,_,S,y,b,P,O,x,C,w,A=this;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.resources,a=t.image,i=t.isInline,n=void 0!==i&&i,o=t.operatorList,s=t.cacheKey,c=t.localImageCache,l=t.localColorSpaceCache,u=a.dict,f=u.objId,d=u.get("Width","W"),h=u.get("Height","H"),d&&(0,_util.isNum)(d)&&h&&(0,_util.isNum)(h)){e.next=8;break}return(0,_util.warn)("Image dimensions are missing, or not numbers."),e.abrupt("return",void 0);case 8:if(-1!==(p=this.options.maxImageSize)&&p<d*h)return(0,_util.warn)("Image exceeded maximum allowed size and was removed."),e.abrupt("return",void 0);e.next=12;break;case 12:if(u.get("ImageMask","IM")||!1)return v=u.get("Width","W"),_=u.get("Height","H"),S=v+7>>3,y=a.getBytes(S*_,!0),b=u.getArray("Decode","D"),(g=_image.PDFImage.createMask({imgArray:y,width:v,height:_,imageIsFromDecodeStream:a instanceof _stream.DecodeStream,inverseDecode:!!b&&0<b[0]})).cached=!!s,m=[g],o.addOp(_util.OPS.paintImageMaskXObject,m),s&&c.set(s,f,{fn:_util.OPS.paintImageMaskXObject,args:m}),e.abrupt("return",void 0);e.next=25;break;case 25:if(P=u.get("SMask","SM")||!1,O=u.get("Mask")||!1,200,n&&!P&&!O&&d+h<200)return x=new _image.PDFImage({xref:this.xref,res:r,image:a,isInline:n,pdfFunctionFactory:this._pdfFunctionFactory,localColorSpaceCache:l}),g=x.createImageData(!0),o.addOp(_util.OPS.paintInlineImageXObject,[g]),e.abrupt("return",void 0);e.next=33;break;case 33:return C="img_".concat(this.idFactory.createObjId()),w=!1,this.parsingType3Font?C="".concat(this.idFactory.getDocId(),"_type3_").concat(C):f&&(w=this.globalImageCache.shouldCache(f,this.pageIndex))&&(C="".concat(this.idFactory.getDocId(),"_").concat(C)),o.addDependency(C),m=[C,d,h],_image.PDFImage.buildImage({xref:this.xref,res:r,image:a,isInline:n,pdfFunctionFactory:this._pdfFunctionFactory,localColorSpaceCache:l}).then(function(e){return g=e.createImageData(!1),s&&f&&w&&A.globalImageCache.addByteSize(f,g.data.length),A._sendImgData(C,g,w)}).catch(function(e){return(0,_util.warn)('Unable to decode image "'.concat(C,'": "').concat(e,'".')),A._sendImgData(C,null,w)}),o.addOp(_util.OPS.paintImageXObject,m),s&&(c.set(s,f,{fn:_util.OPS.paintImageXObject,args:m}),f&&((0,_util.assert)(!n,"Cannot cache an inline image globally."),this.globalImageCache.addPageIndex(f,this.pageIndex),w&&this.globalImageCache.setData(f,{objId:C,fn:_util.OPS.paintImageXObject,args:m,byteSize:0}))),e.abrupt("return",void 0);case 41:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"handleSMask",value:function(e,t,r,a,i,n){var o=e.get("G"),s={subtype:e.get("S").name,backdrop:e.get("BC")},c=e.get("TR");if((0,_function.isPDFFunction)(c)){for(var l=this._pdfFunctionFactory.create(c),u=new Uint8Array(256),f=new Float32Array(1),d=0;d<256;d++)f[0]=d/255,l(f,0,f,0),u[d]=255*f[0]|0;s.transferMap=u}return this.buildFormXObject(t,o,s,r,a,i.state.clone(),n)}},{key:"handleTransferFunction",value:function(e){var t;if(Array.isArray(e))t=e;else{if(!(0,_function.isPDFFunction)(e))return null;t=[e]}var r,a=[],i=0,n=0,o=_createForOfIteratorHelper(t);try{for(o.s();!(r=o.n()).done;){var s=r.value,c=this.xref.fetchIfRef(s);if(i++,(0,_primitives.isName)(c,"Identity"))a.push(null);else{if(!(0,_function.isPDFFunction)(c))return null;for(var l=this._pdfFunctionFactory.create(c),u=new Uint8Array(256),f=new Float32Array(1),d=0;d<256;d++)f[0]=d/255,l(f,0,f,0),u[d]=255*f[0]|0;a.push(u),n++}}}catch(e){o.e(e)}finally{o.f()}return 1!==i&&4!==i?null:0===n?null:a}},{key:"handleTilingType",value:function(r,a,e,t,i,n,o,s,c){var l=this,u=new _operator_list.OperatorList,f=_primitives.Dict.merge({xref:this.xref,dictArray:[i.get("Resources"),e]});return this.getOperatorList({stream:t,task:o,resources:f,operatorList:u}).then(function(){var e=u.getIR(),t=(0,_pattern.getTilingPatternIR)(e,i,a);n.addDependencies(u.dependencies),n.addOp(r,t),s&&c.set(s,i.objId,{operatorListIR:e,dict:i})}).catch(function(e){if(!(e instanceof _util.AbortException)){if(l.options.ignoreErrors)return l.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorTilingPattern}),void(0,_util.warn)('handleTilingType - ignoring pattern: "'.concat(e,'".'));throw e}})}},{key:"handleSetFont",value:function(e,t,r,a,i,n){var o=this,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,c=t&&t[0]instanceof _primitives.Name?t[0].name:null;return this.loadFont(c,r,e,s).then(function(t){return t.font.isType3Font?t.loadType3Data(o,e,i).then(function(){return a.addDependencies(t.type3Dependencies),t}).catch(function(e){return o.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorFontLoadType3}),new TranslatedFont({loadedName:"g_font_error",font:new _fonts.ErrorFont("Type3 font load error: ".concat(e)),dict:t.font,extraProperties:o.options.fontExtraProperties})}):t}).then(function(e){return n.font=e.font,e.send(o.handler),e.loadedName})}},{key:"handleText",value:function(e,t){var r=t.font,a=r.charsToGlyphs(e);r.data&&((!!(t.textRenderingMode&_util.TextRenderingMode.ADD_TO_PATH_FLAG)||"Pattern"===t.fillColorSpace.name||r.disableFontFace||this.options.disableFontFace)&&S.buildFontPaths(r,a,this.handler));return a}},{key:"ensureStateFont",value:function(e){if(!e.font){var t=new _util.FormatError("Missing setFont (Tf) operator before text rendering operator.");if(this.options.ignoreErrors)return this.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorFontState}),void(0,_util.warn)('ensureStateFont: "'.concat(t,'".'));throw t}}},{key:"setGState",value:(a=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var a,i,n,r,o,s,c,l,u,f,d,h,p,g,m,v,_=this;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(a=t.resources,i=t.gState,n=t.operatorList,r=t.cacheKey,o=t.task,s=t.stateManager,c=t.localGStateCache,l=t.localColorSpaceCache,u=i.objId,f=!0,d=[],h=i.getKeys(),p=Promise.resolve(),g=function(){var t=h[m],r=i.get(t);switch(t){case"Type":break;case"LW":case"LC":case"LJ":case"ML":case"D":case"RI":case"FL":case"CA":case"ca":d.push([t,r]);break;case"Font":f=!1,p=p.then(function(){return _.handleSetFont(a,null,r[0],n,o,s.state).then(function(e){n.addDependency(e),d.push([t,[e,r[1]]])})});break;case"BM":d.push([t,normalizeBlendMode(r)]);break;case"SMask":if((0,_primitives.isName)(r,"None")){d.push([t,!1]);break}(0,_primitives.isDict)(r)?(f=!1,p=p.then(function(){return _.handleSMask(r,a,n,o,s,l)}),d.push([t,!0])):(0,_util.warn)("Unsupported SMask type");break;case"TR":var e=_.handleTransferFunction(r);d.push([t,e]);break;case"OP":case"op":case"OPM":case"BG":case"BG2":case"UCR":case"UCR2":case"TR2":case"HT":case"SM":case"SA":case"AIS":case"TK":(0,_util.info)("graphic state operator "+t);break;default:(0,_util.info)("Unknown graphic state operator "+t)}},m=0,v=h.length;m<v;m++)g();return e.abrupt("return",p.then(function(){0<d.length&&n.addOp(_util.OPS.setGState,[d]),f&&c.set(r,u,d)}));case 9:case"end":return e.stop()}},e)})),function(e){return a.apply(this,arguments)})},{key:"loadFont",value:function(t,i,e){var r,n=this,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,o=function(){var e=_asyncToGenerator(_regeneratorRuntime().mark(function e(){return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new TranslatedFont({loadedName:"g_font_error",font:new _fonts.ErrorFont('Font "'.concat(t,'" is not available.')),dict:i,extraProperties:n.options.fontExtraProperties}));case 1:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),s=this.xref;if(i){if(!(0,_primitives.isRef)(i))throw new _util.FormatError('The "font" object should be a reference.');r=i}else{var c=e.get("Font");c&&(r=c.getRaw(t))}if(!r){var l='Font "'.concat(t||i&&i.toString(),'" is not available');if(!this.options.ignoreErrors&&!this.parsingType3Font)return(0,_util.warn)("".concat(l,".")),o();this.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorFontMissing}),(0,_util.warn)("".concat(l," -- attempting to fallback to a default font.")),r=a||S.fallbackFontDict}if(this.fontCache.has(r))return this.fontCache.get(r);if(i=s.fetchIfRef(r),!(0,_primitives.isDict)(i))return o();if(i.cacheKey&&this.fontCache.has(i.cacheKey))return this.fontCache.get(i.cacheKey);var u,f=(0,_util.createPromiseCapability)();try{u=this.preEvaluateFont(i)}catch(e){return(0,_util.warn)('loadFont - preEvaluateFont failed: "'.concat(e,'".')),o()}var d,h=u,p=h.descriptor,g=h.hash,m=(0,_primitives.isRef)(r);if(m&&(d="f".concat(r.toString())),g&&(0,_primitives.isDict)(p)){p.fontAliases||(p.fontAliases=Object.create(null));var v=p.fontAliases;if(v[g]){var _=v[g].aliasRef;if(m&&_&&this.fontCache.has(_))return this.fontCache.putAlias(r,_),this.fontCache.get(r)}else v[g]={fontID:this.idFactory.createFontId()};m&&(v[g].aliasRef=r),d=v[g].fontID}return m?this.fontCache.put(r,f.promise):(d||(d=this.idFactory.createFontId()),i.cacheKey="cacheKey_".concat(d),this.fontCache.put(i.cacheKey,f.promise)),(0,_util.assert)(d&&d.startsWith("f"),'The "fontID" must be (correctly) defined.'),i.loadedName="".concat(this.idFactory.getDocId(),"_").concat(d),this.translateFont(u).then(function(e){void 0!==e.fontType&&(s.stats.fontTypes[e.fontType]=!0);f.resolve(new TranslatedFont({loadedName:i.loadedName,font:e,dict:i,extraProperties:n.options.fontExtraProperties}))}).catch(function(e){n.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorFontTranslate}),(0,_util.warn)('loadFont - translateFont failed: "'.concat(e,'".'));try{var t=p&&p.get("FontFile3"),r=t&&t.get("Subtype"),a=(0,_fonts.getFontType)(u.type,r&&r.name);s.stats.fontTypes[a]=!0}catch(e){}f.resolve(new TranslatedFont({loadedName:i.loadedName,font:new _fonts.ErrorFont(e instanceof Error?e.message:e),dict:i,extraProperties:n.options.fontExtraProperties}))}),f.promise}},{key:"buildPath",value:function(e,t,r){var a=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=e.length-1;if(r||(r=[]),i<0||e.fnArray[i]!==_util.OPS.constructPath)a&&((0,_util.warn)('Encountered path operator "'.concat(t,'" inside of a text object.')),e.addOp(_util.OPS.save,null)),e.addOp(_util.OPS.constructPath,[[t],r]),a&&e.addOp(_util.OPS.restore,null);else{var n=e.argsArray[i];n[0].push(t),Array.prototype.push.apply(n[1],r)}}},{key:"parseColorSpace",value:function(e){var t=this,r=e.cs,a=e.resources,i=e.localColorSpaceCache;return _colorspace.ColorSpace.parseAsync({cs:r,xref:this.xref,resources:a,pdfFunctionFactory:this._pdfFunctionFactory,localColorSpaceCache:i}).catch(function(e){if(e instanceof _util.AbortException)return null;if(t.options.ignoreErrors)return t.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorColorSpace}),(0,_util.warn)('parseColorSpace - ignoring ColorSpace: "'.concat(e,'".')),null;throw e})}},{key:"handleColorN",value:function(e,t,r,a,i,n,o,s,c){var l=r.pop();if(l instanceof _primitives.Name){var u=l.name,f=c.getByName(u);if(f)try{var d=a.base?a.base.getRgb(r,0):null,h=(0,_pattern.getTilingPatternIR)(f.operatorListIR,f.dict,d);return void e.addOp(t,h)}catch(e){}var p=i.get(u);if(p){var g=(0,_primitives.isStream)(p)?p.dict:p,m=g.get("PatternType");if(m===PatternType.TILING){var v=a.base?a.base.getRgb(r,0):null;return this.handleTilingType(t,v,n,p,g,e,o,u,c)}if(m!==PatternType.SHADING)throw new _util.FormatError("Unknown PatternType: ".concat(m));var _=g.get("Shading"),S=g.getArray("Matrix");return p=_pattern.Pattern.parseShading(_,S,this.xref,n,this.handler,this._pdfFunctionFactory,s),void e.addOp(t,p.getIR())}}throw new _util.FormatError("Unknown PatternName: ".concat(l))}},{key:"parseMarkedContentProps",value:(r=_asyncToGenerator(_regeneratorRuntime().mark(function e(t,r){var a,i,n,o,s,c;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,_primitives.isName)(t)){e.next=5;break}i=r.get("Properties"),a=i.get(t.name),e.next=10;break;case 5:if(!(0,_primitives.isDict)(t)){e.next=9;break}a=t,e.next=10;break;case 9:throw new _util.FormatError("Optional content properties malformed.");case 10:if("OCG"===(n=a.get("Type").name))return e.abrupt("return",{type:n,id:a.objId});e.next=15;break;case 15:if("OCMD"!==n){e.next=27;break}if(o=a.get("OCGs"),Array.isArray(o)||(0,_primitives.isDict)(o))return s=[],Array.isArray(o)?a.get("OCGs").forEach(function(e){s.push(e.toString())}):s.push(o.objId),c=null,a.get("VE")&&(c=!0),e.abrupt("return",{type:n,ids:s,policy:(0,_primitives.isName)(a.get("P"))?a.get("P").name:null,expression:c});e.next=25;break;case 25:if((0,_primitives.isRef)(o))return e.abrupt("return",{type:n,id:o.toString()});e.next=27;break;case 27:return e.abrupt("return",null);case 28:case"end":return e.stop()}},e)})),function(e,t){return r.apply(this,arguments)})},{key:"getOperatorList",value:function(e){var t=this,r=e.stream,w=e.task,A=e.resources,F=e.operatorList,a=e.initialState,i=void 0===a?null:a,n=e.fallbackFontDict,k=void 0===n?null:n;if(A=A||_primitives.Dict.empty,i=i||new EvalState,!F)throw new Error('getOperatorList: missing "operatorList" parameter');var T=this,I=this.xref,M=!1,E=new _image_utils.LocalImageCache,R=new _image_utils.LocalColorSpaceCache,N=new _image_utils.LocalGStateCache,D=new _image_utils.LocalTilingPatternCache,L=A.get("XObject")||_primitives.Dict.empty,j=A.get("Pattern")||_primitives.Dict.empty,U=new StateManager(i),B=new EvaluatorPreprocessor(r,I,U),G=new TimeSlotManager;function W(e){for(var t=0,r=B.savedStatesDepth;t<r;t++)F.addOp(_util.OPS.restore,[])}return new Promise(function t(r,a){var e=function(e){Promise.all([e,F.ready]).then(function(){try{t(r,a)}catch(e){a(e)}},a)};w.ensureNotTerminated(),G.reset();for(var i,n,o,s,c,l={};!(i=G.check())&&(l.args=null,B.read(l));){var u=l.args,f=l.fn;switch(0|f){case _util.OPS.paintXObject:if(c=u[0].name){var d=E.getByName(c);if(d){F.addOp(d.fn,d.args),u=null;continue}}return void e(new Promise(function(e,t){if(!c)throw new _util.FormatError("XObject must be referred to by name.");var r=L.getRaw(c);if(r instanceof _primitives.Ref){var a=E.getByRef(r);if(a)return F.addOp(a.fn,a.args),void e();var i=T.globalImageCache.getData(r,T.pageIndex);if(i)return F.addDependency(i.objId),F.addOp(i.fn,i.args),void e();r=I.fetch(r)}if(!(0,_primitives.isStream)(r))throw new _util.FormatError("XObject should be a stream");var n=r.dict.get("Subtype");if(!(0,_primitives.isName)(n))throw new _util.FormatError("XObject should have a Name subtype");if("Form"===n.name)return U.save(),void T.buildFormXObject(A,r,null,F,w,U.state.clone(),R).then(function(){U.restore(),e()},t);if("Image"!==n.name){if("PS"!==n.name)throw new _util.FormatError("Unhandled XObject subtype ".concat(n.name));(0,_util.info)("Ignored XObject subtype PS"),e()}else T.buildPaintImageXObject({resources:A,image:r,operatorList:F,cacheKey:c,localImageCache:E,localColorSpaceCache:R}).then(e,t)}).catch(function(e){if(!(e instanceof _util.AbortException)){if(T.options.ignoreErrors)return T.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorXObject}),void(0,_util.warn)('getOperatorList - ignoring XObject: "'.concat(e,'".'));throw e}}));case _util.OPS.setFont:var h=u[1];return void e(T.handleSetFont(A,u,null,F,w,U.state,k).then(function(e){F.addDependency(e),F.addOp(_util.OPS.setFont,[e,h])}));case _util.OPS.beginText:M=!0;break;case _util.OPS.endText:M=!1;break;case _util.OPS.endInlineImage:var p=u[0].cacheKey;if(p){var g=E.getByName(p);if(g){F.addOp(g.fn,g.args),u=null;continue}}return void e(T.buildPaintImageXObject({resources:A,image:u[0],isInline:!0,operatorList:F,cacheKey:p,localImageCache:E,localColorSpaceCache:R}));case _util.OPS.showText:if(!U.state.font){T.ensureStateFont(U.state);continue}u[0]=T.handleText(u[0],U.state);break;case _util.OPS.showSpacedText:if(!U.state.font){T.ensureStateFont(U.state);continue}var m=u[0],v=[],_=m.length,S=U.state;for(n=0;n<_;++n){var y=m[n];(0,_util.isString)(y)?Array.prototype.push.apply(v,T.handleText(y,S)):(0,_util.isNum)(y)&&v.push(y)}u[0]=v,f=_util.OPS.showText;break;case _util.OPS.nextLineShowText:if(!U.state.font){T.ensureStateFont(U.state);continue}F.addOp(_util.OPS.nextLine),u[0]=T.handleText(u[0],U.state),f=_util.OPS.showText;break;case _util.OPS.nextLineSetSpacingShowText:if(!U.state.font){T.ensureStateFont(U.state);continue}F.addOp(_util.OPS.nextLine),F.addOp(_util.OPS.setWordSpacing,[u.shift()]),F.addOp(_util.OPS.setCharSpacing,[u.shift()]),u[0]=T.handleText(u[0],U.state),f=_util.OPS.showText;break;case _util.OPS.setTextRenderingMode:U.state.textRenderingMode=u[0];break;case _util.OPS.setFillColorSpace:var b=_colorspace.ColorSpace.getCached(u[0],I,R);if(b){U.state.fillColorSpace=b;continue}return void e(T.parseColorSpace({cs:u[0],resources:A,localColorSpaceCache:R}).then(function(e){e&&(U.state.fillColorSpace=e)}));case _util.OPS.setStrokeColorSpace:var P=_colorspace.ColorSpace.getCached(u[0],I,R);if(P){U.state.strokeColorSpace=P;continue}return void e(T.parseColorSpace({cs:u[0],resources:A,localColorSpaceCache:R}).then(function(e){e&&(U.state.strokeColorSpace=e)}));case _util.OPS.setFillColor:u=(s=U.state.fillColorSpace).getRgb(u,0),f=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeColor:u=(s=U.state.strokeColorSpace).getRgb(u,0),f=_util.OPS.setStrokeRGBColor;break;case _util.OPS.setFillGray:U.state.fillColorSpace=_colorspace.ColorSpace.singletons.gray,u=_colorspace.ColorSpace.singletons.gray.getRgb(u,0),f=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeGray:U.state.strokeColorSpace=_colorspace.ColorSpace.singletons.gray,u=_colorspace.ColorSpace.singletons.gray.getRgb(u,0),f=_util.OPS.setStrokeRGBColor;break;case _util.OPS.setFillCMYKColor:U.state.fillColorSpace=_colorspace.ColorSpace.singletons.cmyk,u=_colorspace.ColorSpace.singletons.cmyk.getRgb(u,0),f=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeCMYKColor:U.state.strokeColorSpace=_colorspace.ColorSpace.singletons.cmyk,u=_colorspace.ColorSpace.singletons.cmyk.getRgb(u,0),f=_util.OPS.setStrokeRGBColor;break;case _util.OPS.setFillRGBColor:U.state.fillColorSpace=_colorspace.ColorSpace.singletons.rgb,u=_colorspace.ColorSpace.singletons.rgb.getRgb(u,0);break;case _util.OPS.setStrokeRGBColor:U.state.strokeColorSpace=_colorspace.ColorSpace.singletons.rgb,u=_colorspace.ColorSpace.singletons.rgb.getRgb(u,0);break;case _util.OPS.setFillColorN:if("Pattern"===(s=U.state.fillColorSpace).name)return void e(T.handleColorN(F,_util.OPS.setFillColorN,u,s,j,A,w,R,D));u=s.getRgb(u,0),f=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeColorN:if("Pattern"===(s=U.state.strokeColorSpace).name)return void e(T.handleColorN(F,_util.OPS.setStrokeColorN,u,s,j,A,w,R,D));u=s.getRgb(u,0),f=_util.OPS.setStrokeRGBColor;break;case _util.OPS.shadingFill:var O=A.get("Shading");if(!O)throw new _util.FormatError("No shading resource found");var x=O.get(u[0].name);if(!x)throw new _util.FormatError("No shading object found");u=[_pattern.Pattern.parseShading(x,null,I,A,T.handler,T._pdfFunctionFactory,R).getIR()],f=_util.OPS.shadingFill;break;case _util.OPS.setGState:if(c=u[0].name){var C=N.getByName(c);if(C){0<C.length&&F.addOp(_util.OPS.setGState,[C]),u=null;continue}}return void e(new Promise(function(e,t){if(!c)throw new _util.FormatError("GState must be referred to by name.");var r=A.get("ExtGState");if(!(r instanceof _primitives.Dict))throw new _util.FormatError("ExtGState should be a dictionary.");var a=r.get(c);if(!(a instanceof _primitives.Dict))throw new _util.FormatError("GState should be a dictionary.");T.setGState({resources:A,gState:a,operatorList:F,cacheKey:c,task:w,stateManager:U,localGStateCache:N,localColorSpaceCache:R}).then(e,t)}).catch(function(e){if(!(e instanceof _util.AbortException)){if(T.options.ignoreErrors)return T.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorExtGState}),void(0,_util.warn)('getOperatorList - ignoring ExtGState: "'.concat(e,'".'));throw e}}));case _util.OPS.moveTo:case _util.OPS.lineTo:case _util.OPS.curveTo:case _util.OPS.curveTo2:case _util.OPS.curveTo3:case _util.OPS.closePath:case _util.OPS.rectangle:T.buildPath(F,f,u,M);continue;case _util.OPS.markPoint:case _util.OPS.markPointProps:case _util.OPS.beginCompat:case _util.OPS.endCompat:continue;case _util.OPS.beginMarkedContentProps:if(!(0,_primitives.isName)(u[0])){(0,_util.warn)("Expected name for beginMarkedContentProps arg0=".concat(u[0]));continue}if("OC"===u[0].name)return void e(T.parseMarkedContentProps(u[1],A).then(function(e){F.addOp(_util.OPS.beginMarkedContentProps,["OC",e])}).catch(function(e){if(!(e instanceof _util.AbortException)){if(T.options.ignoreErrors)return T.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorMarkedContent}),void(0,_util.warn)('getOperatorList - ignoring beginMarkedContentProps: "'.concat(e,'".'));throw e}}));u=[u[0].name];break;case _util.OPS.beginMarkedContent:case _util.OPS.endMarkedContent:default:if(null!==u){for(n=0,o=u.length;n<o&&!(u[n]instanceof _primitives.Dict);n++);if(n<o){(0,_util.warn)("getOperatorList - ignoring operator: "+f);continue}}}F.addOp(f,u)}i?e(deferred):(W(),r())}).catch(function(e){if(!(e instanceof _util.AbortException)){if(t.options.ignoreErrors)return t.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorOperatorList}),(0,_util.warn)('getOperatorList - ignoring errors during "'.concat(w.name,'" ')+'task: "'.concat(e,'".')),void W();throw e}})}},{key:"getTextContent",value:function(e){var t=this,r=e.stream,_=e.task,S=e.resources,a=e.stateManager,y=void 0===a?null:a,i=e.normalizeWhitespace,b=void 0!==i&&i,n=e.combineTextItems,P=void 0!==n&&n,O=e.sink,o=e.seenStyles,x=void 0===o?new Set:o;S=S||_primitives.Dict.empty,y=y||new StateManager(new TextState);var C,s=/\s/g,w={items:[],styles:Object.create(null)},A={initialized:!1,str:[],width:0,height:0,vertical:!1,lastAdvanceWidth:0,lastAdvanceHeight:0,textAdvanceScale:0,spaceWidth:0,fakeSpaceMin:1/0,fakeMultiSpaceMin:1/0,fakeMultiSpaceMax:-0,textRunBreakAllowed:!1,transform:null,fontName:null},c=.3,l=1.5,u=4,F=this,k=this.xref,T=null,I=new _image_utils.LocalImageCache,M=new _image_utils.LocalGStateCache,E=new EvaluatorPreprocessor(r,k,y);function R(){if(A.initialized)return A;var e=C.font,t=e.loadedName;x.has(t)||(x.add(t),w.styles[t]={fontFamily:e.fallbackName,ascent:e.ascent,descent:e.descent,vertical:e.vertical}),A.fontName=t;var r=[C.fontSize*C.textHScale,0,0,C.fontSize,0,C.textRise];if(e.isType3Font&&C.fontSize<=1&&!(0,_util.isArrayEqual)(C.fontMatrix,_util.FONT_IDENTITY_MATRIX)){var a=e.bbox[3]-e.bbox[1];0<a&&(r[3]*=a*C.fontMatrix[3])}var i=_util.Util.transform(C.ctm,_util.Util.transform(C.textMatrix,r));A.transform=i,e.vertical?(A.width=Math.hypot(i[0],i[1]),A.height=0,A.vertical=!0):(A.width=0,A.height=Math.hypot(i[2],i[3]),A.vertical=!1);var n=Math.hypot(C.textLineMatrix[0],C.textLineMatrix[1]),o=Math.hypot(C.ctm[0],C.ctm[1]);A.textAdvanceScale=o*n,A.lastAdvanceWidth=0,A.lastAdvanceHeight=0;var s=e.spaceWidth/1e3*C.fontSize;return s?(A.spaceWidth=s,A.fakeSpaceMin=s*c,A.fakeMultiSpaceMin=s*l,A.fakeMultiSpaceMax=s*u,A.textRunBreakAllowed=!e.isMonospace):(A.spaceWidth=0,A.fakeSpaceMin=1/0,A.fakeMultiSpaceMin=1/0,A.fakeMultiSpaceMax=0,A.textRunBreakAllowed=!1),A.initialized=!0,A}function f(e){var t=e.str.join(""),r=(0,_bidi.bidi)(t,-1,e.vertical);return{str:b?function(e){for(var t,r=0,a=e.length;r<a&&32<=(t=e.charCodeAt(r))&&t<=127;)r++;return r<a?e.replace(s," "):e}(r.str):r.str,dir:r.dir,width:e.width,height:e.height,transform:e.transform,fontName:e.fontName}}function N(e,t){return F.loadFont(e,t,S).then(function(e){C.font=e.font,C.fontMatrix=e.font.fontMatrix||_util.FONT_IDENTITY_MATRIX})}function D(e){for(var t=C.font,r=R(),a=0,i=0,n=t.charsToGlyphs(e),o=0;o<n.length;o++){var s=n[o],c=null;c=t.vertical&&s.vmetric?s.vmetric[0]:s.width;var l=s.unicode,u=(0,_unicode.getNormalizedUnicodes)();void 0!==u[l]&&(l=u[l]),l=(0,_unicode.reverseIfRtl)(l);var f=C.charSpacing;if(s.isSpace){var d=C.wordSpacing;f+=d,0<d&&L(d,r.str)}var h=0,p=0;if(t.vertical)i+=p=c*C.fontMatrix[0]*C.fontSize+f;else a+=h=(c*C.fontMatrix[0]*C.fontSize+f)*C.textHScale;C.translateTextMatrix(h,p),r.str.push(l)}return t.vertical?(r.lastAdvanceHeight=i,r.height+=Math.abs(i)):(r.lastAdvanceWidth=a,r.width+=a),r}function L(e,t){if(!(e<A.fakeSpaceMin))if(e<A.fakeMultiSpaceMin)t.push(" ");else for(var r=Math.round(e/A.spaceWidth);0<r--;)t.push(" ")}function j(){A.initialized&&(A.vertical?A.height*=A.textAdvanceScale:A.width*=A.textAdvanceScale,w.items.push(f(A)),A.initialized=!1,A.str.length=0)}function U(){var e=w.items.length;0<e&&(O.enqueue(w,e),w.items=[],w.styles=Object.create(null))}var B=new TimeSlotManager;return new Promise(function t(r,a){var e=function(e){U(),Promise.all([e,O.ready]).then(function(){try{t(r,a)}catch(e){a(e)}},a)};_.ensureNotTerminated(),B.reset();for(var i,n={},o=[];!(i=B.check())&&(o.length=0,n.args=o,E.read(n));){C=y.state;var s,c=n.fn;switch(o=n.args,0|c){case _util.OPS.setFont:var l=o[0].name,u=o[1];if(C.font&&l===C.fontName&&u===C.fontSize)break;return j(),C.fontName=l,C.fontSize=u,void e(N(l,null));case _util.OPS.setTextRise:j(),C.textRise=o[0];break;case _util.OPS.setHScale:j(),C.textHScale=o[0]/100;break;case _util.OPS.setLeading:j(),C.leading=o[0];break;case _util.OPS.moveText:var f=!!C.font&&0===(C.font.vertical?o[0]:o[1]);if(s=o[0]-o[1],P&&f&&A.initialized&&0<s&&s<=A.fakeMultiSpaceMax){C.translateTextLineMatrix(o[0],o[1]),A.width+=o[0]-A.lastAdvanceWidth,A.height+=o[1]-A.lastAdvanceHeight,L(o[0]-A.lastAdvanceWidth-(o[1]-A.lastAdvanceHeight),A.str);break}j(),C.translateTextLineMatrix(o[0],o[1]),C.textMatrix=C.textLineMatrix.slice();break;case _util.OPS.setLeadingMoveText:j(),C.leading=-o[1],C.translateTextLineMatrix(o[0],o[1]),C.textMatrix=C.textLineMatrix.slice();break;case _util.OPS.nextLine:j(),C.carriageReturn();break;case _util.OPS.setTextMatrix:if(s=C.calcTextLineMatrixAdvance(o[0],o[1],o[2],o[3],o[4],o[5]),P&&null!==s&&A.initialized&&0<s.value&&s.value<=A.fakeMultiSpaceMax){C.translateTextLineMatrix(s.width,s.height),A.width+=s.width-A.lastAdvanceWidth,A.height+=s.height-A.lastAdvanceHeight,L(s.width-A.lastAdvanceWidth-(s.height-A.lastAdvanceHeight),A.str);break}j(),C.setTextMatrix(o[0],o[1],o[2],o[3],o[4],o[5]),C.setTextLineMatrix(o[0],o[1],o[2],o[3],o[4],o[5]);break;case _util.OPS.setCharSpacing:C.charSpacing=o[0];break;case _util.OPS.setWordSpacing:C.wordSpacing=o[0];break;case _util.OPS.beginText:j(),C.textMatrix=_util.IDENTITY_MATRIX.slice(),C.textLineMatrix=_util.IDENTITY_MATRIX.slice();break;case _util.OPS.showSpacedText:if(!y.state.font){F.ensureStateFont(y.state);continue}for(var d,h=o[0],p=0,g=h.length;p<g;p++)if("string"==typeof h[p])D(h[p]);else if((0,_util.isNum)(h[p])){R(),s=h[p]*C.fontSize/1e3;var m=!1;C.font.vertical?(d=s,C.translateTextMatrix(0,d),(m=A.textRunBreakAllowed&&s>A.fakeMultiSpaceMax)||(A.height+=d)):(d=(s=-s)*C.textHScale,C.translateTextMatrix(d,0),(m=A.textRunBreakAllowed&&s>A.fakeMultiSpaceMax)||(A.width+=d)),m?j():0<s&&L(s,A.str)}break;case _util.OPS.showText:if(!y.state.font){F.ensureStateFont(y.state);continue}D(o[0]);break;case _util.OPS.nextLineShowText:if(!y.state.font){F.ensureStateFont(y.state);continue}j(),C.carriageReturn(),D(o[0]);break;case _util.OPS.nextLineSetSpacingShowText:if(!y.state.font){F.ensureStateFont(y.state);continue}j(),C.wordSpacing=o[0],C.charSpacing=o[1],C.carriageReturn(),D(o[2]);break;case _util.OPS.paintXObject:j(),T||(T=S.get("XObject")||_primitives.Dict.empty);var v=o[0].name;if(v&&I.getByName(v))break;return void e(new Promise(function(e,t){if(!v)throw new _util.FormatError("XObject must be referred to by name.");var r=T.getRaw(v);if(r instanceof _primitives.Ref){if(I.getByRef(r))return void e();if(F.globalImageCache.getData(r,F.pageIndex))return void e();r=k.fetch(r)}if(!(0,_primitives.isStream)(r))throw new _util.FormatError("XObject should be a stream");var a=r.dict.get("Subtype");if(!(0,_primitives.isName)(a))throw new _util.FormatError("XObject should have a Name subtype");if("Form"!==a.name)return I.set(v,r.dict.objId,!0),void e();var i=y.state.clone(),n=new StateManager(i),o=r.dict.getArray("Matrix");Array.isArray(o)&&6===o.length&&n.transform(o),U();var s={enqueueInvoked:!1,enqueue:function(e,t){this.enqueueInvoked=!0,O.enqueue(e,t)},get desiredSize(){return O.desiredSize},get ready(){return O.ready}};F.getTextContent({stream:r,task:_,resources:r.dict.get("Resources")||S,stateManager:n,normalizeWhitespace:b,combineTextItems:P,sink:s,seenStyles:x}).then(function(){s.enqueueInvoked||I.set(v,r.dict.objId,!0),e()},t)}).catch(function(e){if(!(e instanceof _util.AbortException)){if(!F.options.ignoreErrors)throw e;(0,_util.warn)('getTextContent - ignoring XObject: "'.concat(e,'".'))}}));case _util.OPS.setGState:if((v=o[0].name)&&M.getByName(v))break;return void e(new Promise(function(e,t){if(!v)throw new _util.FormatError("GState must be referred to by name.");var r=S.get("ExtGState");if(!(r instanceof _primitives.Dict))throw new _util.FormatError("ExtGState should be a dictionary.");var a=r.get(v);if(!(a instanceof _primitives.Dict))throw new _util.FormatError("GState should be a dictionary.");var i=a.get("Font");if(!i)return M.set(v,a.objId,!0),void e();j(),C.fontName=null,C.fontSize=i[1],N(null,i[0]).then(e,t)}).catch(function(e){if(!(e instanceof _util.AbortException)){if(!F.options.ignoreErrors)throw e;(0,_util.warn)('getTextContent - ignoring ExtGState: "'.concat(e,'".'))}}))}if(w.items.length>=O.desiredSize){i=!0;break}}i?e(deferred):(j(),U(),r())}).catch(function(e){if(!(e instanceof _util.AbortException)){if(t.options.ignoreErrors)return(0,_util.warn)('getTextContent - ignoring errors during "'.concat(_.name,'" ')+'task: "'.concat(e,'".')),j(),void U();throw e}})}},{key:"extractDataStructures",value:function(e,t,r){var a,i=this,n=this.xref,o=e.get("ToUnicode")||t.get("ToUnicode"),s=o?this.readToUnicode(o):Promise.resolve(void 0);if(r.composite){var c=e.get("CIDSystemInfo");(0,_primitives.isDict)(c)&&(r.cidSystemInfo={registry:(0,_util.stringToPDFString)(c.get("Registry")),ordering:(0,_util.stringToPDFString)(c.get("Ordering")),supplement:c.get("Supplement")});var l=e.get("CIDToGIDMap");(0,_primitives.isStream)(l)&&(a=l.getBytes())}var u,f=[],d=null;if(e.has("Encoding")){if(u=e.get("Encoding"),(0,_primitives.isDict)(u)){if(d=u.get("BaseEncoding"),d=(0,_primitives.isName)(d)?d.name:null,u.has("Differences"))for(var h=u.get("Differences"),p=0,g=0,m=h.length;g<m;g++){var v=n.fetchIfRef(h[g]);if((0,_util.isNum)(v))p=v;else{if(!(0,_primitives.isName)(v))throw new _util.FormatError("Invalid entry in 'Differences' array: ".concat(v));f[p++]=v.name}}}else{if(!(0,_primitives.isName)(u))throw new _util.FormatError("Encoding is not a Name nor a Dict");d=u.name}"MacRomanEncoding"!==d&&"MacExpertEncoding"!==d&&"WinAnsiEncoding"!==d&&(d=null)}if(d)r.defaultEncoding=(0,_encodings.getEncoding)(d).slice();else{var _=!!(r.flags&_fonts.FontFlags.Symbolic),S=!!(r.flags&_fonts.FontFlags.Nonsymbolic);u=_encodings.StandardEncoding,"TrueType"!==r.type||S||(u=_encodings.WinAnsiEncoding),_&&(u=_encodings.MacRomanEncoding,r.file||(/Symbol/i.test(r.name)?u=_encodings.SymbolSetEncoding:/Dingbats|Wingdings/i.test(r.name)&&(u=_encodings.ZapfDingbatsEncoding))),r.defaultEncoding=u}return r.differences=f,r.baseEncodingName=d,r.hasEncoding=!!d||0<f.length,r.dict=e,s.then(function(e){return r.toUnicode=e,i.buildToUnicode(r)}).then(function(e){return r.toUnicode=e,a&&(r.cidToGidMap=i.readCidToGidMap(a,e)),r})}},{key:"_buildSimpleFontToUnicode",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];(0,_util.assert)(!e.composite,"Must be a simple font.");var r=[],a=e.defaultEncoding.slice(),i=e.baseEncodingName,n=e.differences;for(var o in n){var s=n[o];".notdef"!==s&&(a[o]=s)}var c=(0,_glyphlist.getGlyphsUnicode)();for(var l in a){var u=a[l];if(""!==u)if(void 0!==c[u])r[l]=String.fromCharCode(c[u]);else{var f=0;switch(u[0]){case"G":3===u.length&&(f=parseInt(u.substring(1),16));break;case"g":5===u.length&&(f=parseInt(u.substring(1),16));break;case"C":case"c":if(3<=u.length&&u.length<=4){var d=u.substring(1);if(t){f=parseInt(d,16);break}if(f=+d,Number.isNaN(f)&&Number.isInteger(parseInt(d,16)))return this._buildSimpleFontToUnicode(e,!0)}break;default:var h=(0,_unicode.getUnicodeForGlyph)(u,c);-1!==h&&(f=h)}if(0<f&&f<=1114111&&Number.isInteger(f)){if(i&&f===+l){var p=(0,_encodings.getEncoding)(i);if(p&&(u=p[l])){r[l]=String.fromCharCode(c[u]);continue}}r[l]=String.fromCodePoint(f)}}}return new _fonts.ToUnicodeMap(r)}},{key:"buildToUnicode",value:function(t){if(t.hasIncludedToUnicodeMap=!!t.toUnicode&&0<t.toUnicode.length,t.hasIncludedToUnicodeMap)return!t.composite&&t.hasEncoding&&(t.fallbackToUnicode=this._buildSimpleFontToUnicode(t)),Promise.resolve(t.toUnicode);if(!t.composite)return Promise.resolve(this._buildSimpleFontToUnicode(t));if(!t.composite||(!t.cMap.builtInCMap||t.cMap instanceof _cmap.IdentityCMap)&&("Adobe"!==t.cidSystemInfo.registry||"GB1"!==t.cidSystemInfo.ordering&&"CNS1"!==t.cidSystemInfo.ordering&&"Japan1"!==t.cidSystemInfo.ordering&&"Korea1"!==t.cidSystemInfo.ordering))return Promise.resolve(new _fonts.IdentityToUnicodeMap(t.firstChar,t.lastChar));var e=t.cidSystemInfo.registry,r=t.cidSystemInfo.ordering,a=_primitives.Name.get(e+"-"+r+"-UCS2");return _cmap.CMapFactory.create({encoding:a,fetchBuiltInCMap:this._fetchBuiltInCMapBound,useCMap:null}).then(function(a){var e=t.cMap,i=[];return e.forEach(function(e,t){if(65535<t)throw new _util.FormatError("Max size of CID is 65,535");var r=a.lookup(t);r&&(i[e]=String.fromCharCode((r.charCodeAt(0)<<8)+r.charCodeAt(1)))}),new _fonts.ToUnicodeMap(i)})}},{key:"readToUnicode",value:function(e){var t=this,r=e;return(0,_primitives.isName)(r)?_cmap.CMapFactory.create({encoding:r,fetchBuiltInCMap:this._fetchBuiltInCMapBound,useCMap:null}).then(function(e){return e instanceof _cmap.IdentityCMap?new _fonts.IdentityToUnicodeMap(0,65535):new _fonts.ToUnicodeMap(e.getMap())}):(0,_primitives.isStream)(r)?_cmap.CMapFactory.create({encoding:r,fetchBuiltInCMap:this._fetchBuiltInCMapBound,useCMap:null}).then(function(e){if(e instanceof _cmap.IdentityCMap)return new _fonts.IdentityToUnicodeMap(0,65535);var o=new Array(e.length);return e.forEach(function(e,t){for(var r=[],a=0;a<t.length;a+=2){var i=t.charCodeAt(a)<<8|t.charCodeAt(a+1);if(55296==(63488&i)){a+=2;var n=t.charCodeAt(a)<<8|t.charCodeAt(a+1);r.push(((1023&i)<<10)+(1023&n)+65536)}else r.push(i)}o[e]=String.fromCodePoint.apply(String,r)}),new _fonts.ToUnicodeMap(o)},function(e){if(e instanceof _util.AbortException)return null;if(t.options.ignoreErrors)return t.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorFontToUnicode}),(0,_util.warn)('readToUnicode - ignoring ToUnicode data: "'.concat(e,'".')),null;throw e}):Promise.resolve(null)}},{key:"readCidToGidMap",value:function(e,t){for(var r=[],a=0,i=e.length;a<i;a++){var n=e[a++]<<8|e[a],o=a>>1;(0!==n||t.has(o))&&(r[o]=n)}return r}},{key:"extractWidths",value:function(e,t,r){var a,i,n,o,s,c,l,u,f=this.xref,d=[],h=0,p=[];if(r.composite){if(h=e.has("DW")?e.get("DW"):1e3,u=e.get("W"))for(i=0,n=u.length;i<n;i++)if(c=f.fetchIfRef(u[i++]),l=f.fetchIfRef(u[i]),Array.isArray(l))for(o=0,s=l.length;o<s;o++)d[c++]=f.fetchIfRef(l[o]);else{var g=f.fetchIfRef(u[++i]);for(o=c;o<=l;o++)d[o]=g}if(r.vertical){var m=e.getArray("DW2")||[880,-1e3];if(a=[m[1],.5*h,m[0]],m=e.get("W2"))for(i=0,n=m.length;i<n;i++)if(c=f.fetchIfRef(m[i++]),l=f.fetchIfRef(m[i]),Array.isArray(l))for(o=0,s=l.length;o<s;o++)p[c++]=[f.fetchIfRef(l[o++]),f.fetchIfRef(l[o++]),f.fetchIfRef(l[o])];else{var v=[f.fetchIfRef(m[++i]),f.fetchIfRef(m[++i]),f.fetchIfRef(m[++i])];for(o=c;o<=l;o++)p[o]=v}}}else{var _=r.firstChar;if(u=e.get("Widths")){for(o=_,i=0,n=u.length;i<n;i++)d[o++]=f.fetchIfRef(u[i]);h=parseFloat(t.get("MissingWidth"))||0}else{var S=e.get("BaseFont");if((0,_primitives.isName)(S)){var y=this.getBaseFontMetrics(S.name);d=this.buildCharCodeToWidth(y.widths,r),h=y.defaultWidth}}}var b=!0,P=h;for(var O in d){var x=d[O];if(x)if(P){if(P!==x){b=!1;break}}else P=x}b&&(r.flags|=_fonts.FontFlags.FixedPitch),r.defaultWidth=h,r.widths=d,r.defaultVMetrics=a,r.vmetrics=p}},{key:"isSerifFont",value:function(e){var t=e.split("-")[0];return t in(0,_standard_fonts.getSerifFonts)()||-1!==t.search(/serif/gi)}},{key:"getBaseFontMetrics",value:function(e){var t=0,r=Object.create(null),a=!1,i=(0,_standard_fonts.getStdFontMap)()[e]||e,n=(0,_metrics.getMetrics)();i in n||(i=this.isSerifFont(e)?"Times-Roman":"Helvetica");var o=n[i];return(0,_util.isNum)(o)?(t=o,a=!0):r=o(),{defaultWidth:t,monospace:a,widths:r}}},{key:"buildCharCodeToWidth",value:function(e,t){for(var r=Object.create(null),a=t.differences,i=t.defaultEncoding,n=0;n<256;n++)n in a&&e[a[n]]?r[n]=e[a[n]]:n in i&&e[i[n]]&&(r[n]=e[i[n]]);return r}},{key:"preEvaluateFont",value:function(e){var t=e,r=e.get("Subtype");if(!(0,_primitives.isName)(r))throw new _util.FormatError("invalid font Subtype");var a,i=!1;if("Type0"===r.name){var n=e.get("DescendantFonts");if(!n)throw new _util.FormatError("Descendant fonts are not specified");if(!((e=Array.isArray(n)?this.xref.fetchIfRef(n[0]):n)instanceof _primitives.Dict))throw new _util.FormatError("Descendant font is not a dictionary.");if(r=e.get("Subtype"),!(0,_primitives.isName)(r))throw new _util.FormatError("invalid font Subtype");i=!0}var o=e.get("FontDescriptor");if(o){var s=new _murmurhash.MurmurHash3_64,c=t.getRaw("Encoding");if((0,_primitives.isName)(c))s.update(c.name);else if((0,_primitives.isRef)(c))s.update(c.toString());else if((0,_primitives.isDict)(c)){var l,u=_createForOfIteratorHelper(c.getRawValues());try{for(u.s();!(l=u.n()).done;){var f=l.value;if((0,_primitives.isName)(f))s.update(f.name);else if((0,_primitives.isRef)(f))s.update(f.toString());else if(Array.isArray(f)){for(var d=f.length,h=new Array(d),p=0;p<d;p++){var g=f[p];(0,_primitives.isName)(g)?h[p]=g.name:((0,_util.isNum)(g)||(0,_primitives.isRef)(g))&&(h[p]=g.toString())}s.update(h.join())}}}catch(e){u.e(e)}finally{u.f()}}var m=e.get("FirstChar")||0,v=e.get("LastChar")||(i?65535:255);s.update("".concat(m,"-").concat(v));var _=e.get("ToUnicode")||t.get("ToUnicode");if((0,_primitives.isStream)(_)){var S=_.str||_;a=S.buffer?new Uint8Array(S.buffer.buffer,0,S.bufferLength):new Uint8Array(S.bytes.buffer,S.start,S.end-S.start),s.update(a)}else(0,_primitives.isName)(_)&&s.update(_.name);var y=e.get("Widths")||t.get("Widths");y&&(a=new Uint8Array(new Uint32Array(y).buffer),s.update(a))}return{descriptor:o,dict:e,baseDict:t,composite:i,type:r.name,hash:s?s.hexdigest():""}}},{key:"translateFont",value:(t=_asyncToGenerator(_regeneratorRuntime().mark(function e(t){var r,a,i,n,o,s,c,l,u,f,d,h,p,g,m,v,_,S,y,b,P,O,x,C,w,A=this;return _regeneratorRuntime().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.baseDict,a=t.dict,i=t.composite,n=t.descriptor,o=t.type,s=i?65535:255,l=a.get("FirstChar")||0,u=a.get("LastChar")||s,n){e.next=25;break}if("Type3"!==o){e.next=15;break}(n=new _primitives.Dict(null)).set("FontName",_primitives.Name.get(o)),n.set("FontBBox",a.getArray("FontBBox")||[0,0,0,0]),e.next=25;break;case 15:if(f=a.get("BaseFont"),(0,_primitives.isName)(f)){e.next=18;break}throw new _util.FormatError("Base font is not specified");case 18:return f=f.name.replace(/[,_]/g,"-"),d=this.getBaseFontMetrics(f),h=f.split("-")[0],p=(this.isSerifFont(h)?_fonts.FontFlags.Serif:0)|(d.monospace?_fonts.FontFlags.FixedPitch:0)|((0,_standard_fonts.getSymbolsFonts)()[h]?_fonts.FontFlags.Symbolic:_fonts.FontFlags.Nonsymbolic),c={type:o,name:f,widths:d.widths,defaultWidth:d.defaultWidth,flags:p,firstChar:l,lastChar:u},g=a.get("Widths"),e.abrupt("return",this.extractDataStructures(a,a,c).then(function(e){if(g){for(var t=[],r=l,a=0,i=g.length;a<i;a++)t[r++]=A.xref.fetchIfRef(g[a]);e.widths=t}else e.widths=A.buildCharCodeToWidth(d.widths,e);return new _fonts.Font(f,null,e)}));case 25:if(m=n.get("FontName"),v=a.get("BaseFont"),(0,_util.isString)(m)&&(m=_primitives.Name.get(m)),(0,_util.isString)(v)&&(v=_primitives.Name.get(v)),"Type3"!==o&&(_=m&&m.name,S=v&&v.name,_!==S&&((0,_util.info)("The FontDescriptor's FontName is \"".concat(_,'" but ')+"should be the same as the Font's BaseFont \"".concat(S,'".')),_&&S&&S.startsWith(_)&&(m=v))),m=m||v,(0,_primitives.isName)(m)){e.next=33;break}throw new _util.FormatError("invalid font name");case 33:e.prev=33,y=n.get("FontFile","FontFile2","FontFile3"),e.next=43;break;case 37:if(e.prev=37,e.t0=e.catch(33),this.options.ignoreErrors){e.next=41;break}throw e.t0;case 41:(0,_util.warn)('translateFont - fetching "'.concat(m.name,'" font file: "').concat(e.t0,'".')),y=new _stream.NullStream;case 43:if(y&&y.dict&&((b=y.dict.get("Subtype"))&&(b=b.name),P=y.dict.get("Length1"),O=y.dict.get("Length2"),x=y.dict.get("Length3")),c={type:o,name:m.name,subtype:b,file:y,length1:P,length2:O,length3:x,loadedName:r.loadedName,composite:i,fixedPitch:!1,fontMatrix:a.getArray("FontMatrix")||_util.FONT_IDENTITY_MATRIX,firstChar:l||0,lastChar:u||s,bbox:n.getArray("FontBBox"),ascent:n.get("Ascent"),descent:n.get("Descent"),xHeight:n.get("XHeight"),capHeight:n.get("CapHeight"),flags:n.get("Flags"),italicAngle:n.get("ItalicAngle"),isType3Font:!1},i)return C=r.get("Encoding"),(0,_primitives.isName)(C)&&(c.cidEncoding=C.name),e.next=50,_cmap.CMapFactory.create({encoding:C,fetchBuiltInCMap:this._fetchBuiltInCMapBound,useCMap:null});e.next=53;break;case 50:w=e.sent,c.cMap=w,c.vertical=c.cMap.vertical;case 53:return e.abrupt("return",this.extractDataStructures(a,r,c).then(function(e){return A.extractWidths(a,n,e),"Type3"===o&&(e.isType3Font=!0),new _fonts.Font(m.name,y,e)}));case 54:case"end":return e.stop()}},e,this,[[33,37]])})),function(e){return t.apply(this,arguments)})}],[{key:"buildFontPaths",value:function(t,e,r){function a(e){t.renderer.hasBuiltPath(e)||r.send("commonobj",["".concat(t.loadedName,"_path_").concat(e),"FontPath",t.renderer.getPathJs(e)])}var i,n=_createForOfIteratorHelper(e);try{for(n.s();!(i=n.n()).done;){var o=i.value;a(o.fontChar);var s=o.accent;s&&s.fontChar&&a(s.fontChar)}}catch(e){n.e(e)}finally{n.f()}}},{key:"fallbackFontDict",get:function(){var e=new _primitives.Dict;return e.set("BaseFont",_primitives.Name.get("PDFJS-FallbackFont")),e.set("Type",_primitives.Name.get("FallbackType")),e.set("Subtype",_primitives.Name.get("FallbackType")),e.set("Encoding",_primitives.Name.get("WinAnsiEncoding")),(0,_util.shadow)(this,"fallbackFontDict",e)}}]),S}();exports.PartialEvaluator=PartialEvaluator;var TranslatedFont=function(){function o(e){var t=e.loadedName,r=e.font,a=e.dict,i=e.extraProperties,n=void 0!==i&&i;_classCallCheck(this,o),this.loadedName=t,this.font=r,this.dict=a,this._extraProperties=n,this.type3Loaded=null,this.type3Dependencies=r.isType3Font?new Set:null,this.sent=!1}return _createClass(o,[{key:"send",value:function(e){this.sent||(this.sent=!0,e.send("commonobj",[this.loadedName,"Font",this.font.exportData(this._extraProperties)]))}},{key:"fallback",value:function(e){if(this.font.data){this.font.disableFontFace=!0;var t=this.font.glyphCacheValues;PartialEvaluator.buildFontPaths(this.font,t,e)}}},{key:"loadType3Data",value:function(e,t,r){var n=this;if(this.type3Loaded)return this.type3Loaded;if(!this.font.isType3Font)throw new Error("Must be a Type3 font.");var a=Object.create(e.options);a.ignoreErrors=!1;var o=e.clone(a);o.parsingType3Font=!0;var s,i=this.font,c=this.type3Dependencies,l=Promise.resolve(),u=this.dict.get("CharProcs"),f=this.dict.get("Resources")||t,d=Object.create(null),h=_createForOfIteratorHelper(u.getKeys());try{var p=function(){var i=s.value;l=l.then(function(){var e=u.get(i),a=new _operator_list.OperatorList;return o.getOperatorList({stream:e,task:r,resources:f,operatorList:a}).then(function(){a.fnArray[0]===_util.OPS.setCharWidthAndBounds&&n._removeType3ColorOperators(a),d[i]=a.getIR();var e,t=_createForOfIteratorHelper(a.dependencies);try{for(t.s();!(e=t.n()).done;){var r=e.value;c.add(r)}}catch(e){t.e(e)}finally{t.f()}}).catch(function(e){(0,_util.warn)('Type3 font resource "'.concat(i,'" is not available.'));var t=new _operator_list.OperatorList;d[i]=t.getIR()})})};for(h.s();!(s=h.n()).done;)p()}catch(e){h.e(e)}finally{h.f()}return this.type3Loaded=l.then(function(){i.charProcOperatorList=d}),this.type3Loaded}},{key:"_removeType3ColorOperators",value:function(e){for(var t=1,r=e.length;t<r;){switch(e.fnArray[t]){case _util.OPS.setStrokeColorSpace:case _util.OPS.setFillColorSpace:case _util.OPS.setStrokeColor:case _util.OPS.setStrokeColorN:case _util.OPS.setFillColor:case _util.OPS.setFillColorN:case _util.OPS.setStrokeGray:case _util.OPS.setFillGray:case _util.OPS.setStrokeRGBColor:case _util.OPS.setFillRGBColor:case _util.OPS.setStrokeCMYKColor:case _util.OPS.setFillCMYKColor:case _util.OPS.shadingFill:case _util.OPS.setRenderingIntent:e.fnArray.splice(t,1),e.argsArray.splice(t,1),r--;continue;case _util.OPS.setGState:for(var a=_slicedToArray(e.argsArray[t],1)[0],i=0,n=a.length;i<n;){switch(_slicedToArray(a[i],1)[0]){case"TR":case"TR2":case"HT":case"BG":case"BG2":case"UCR":case"UCR2":a.splice(i,1),n--;continue}i++}}t++}}}]),o}(),StateManager=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new EvalState;_classCallCheck(this,t),this.state=e,this.stateStack=[]}return _createClass(t,[{key:"save",value:function(){var e=this.state;this.stateStack.push(this.state),this.state=e.clone()}},{key:"restore",value:function(){var e=this.stateStack.pop();e&&(this.state=e)}},{key:"transform",value:function(e){this.state.ctm=_util.Util.transform(this.state.ctm,e)}}]),t}(),TextState=function(){function e(){_classCallCheck(this,e),this.ctm=new Float32Array(_util.IDENTITY_MATRIX),this.fontName=null,this.fontSize=0,this.font=null,this.fontMatrix=_util.FONT_IDENTITY_MATRIX,this.textMatrix=_util.IDENTITY_MATRIX.slice(),this.textLineMatrix=_util.IDENTITY_MATRIX.slice(),this.charSpacing=0,this.wordSpacing=0,this.leading=0,this.textHScale=1,this.textRise=0}return _createClass(e,[{key:"setTextMatrix",value:function(e,t,r,a,i,n){var o=this.textMatrix;o[0]=e,o[1]=t,o[2]=r,o[3]=a,o[4]=i,o[5]=n}},{key:"setTextLineMatrix",value:function(e,t,r,a,i,n){var o=this.textLineMatrix;o[0]=e,o[1]=t,o[2]=r,o[3]=a,o[4]=i,o[5]=n}},{key:"translateTextMatrix",value:function(e,t){var r=this.textMatrix;r[4]=r[0]*e+r[2]*t+r[4],r[5]=r[1]*e+r[3]*t+r[5]}},{key:"translateTextLineMatrix",value:function(e,t){var r=this.textLineMatrix;r[4]=r[0]*e+r[2]*t+r[4],r[5]=r[1]*e+r[3]*t+r[5]}},{key:"calcTextLineMatrixAdvance",value:function(e,t,r,a,i,n){var o=this.font;if(!o)return null;var s=this.textLineMatrix;if(e!==s[0]||t!==s[1]||r!==s[2]||a!==s[3])return null;var c=i-s[4],l=n-s[5];if(o.vertical&&0!==c||!o.vertical&&0!==l)return null;var u,f,d=e*a-t*r;return f=o.vertical?(u=-l*r/d,l*e/d):(u=c*a/d,-c*t/d),{width:u,height:f,value:o.vertical?f:u}}},{key:"calcRenderMatrix",value:function(e){var t=[this.fontSize*this.textHScale,0,0,this.fontSize,0,this.textRise];return _util.Util.transform(e,_util.Util.transform(this.textMatrix,t))}},{key:"carriageReturn",value:function(){this.translateTextLineMatrix(0,-this.leading),this.textMatrix=this.textLineMatrix.slice()}},{key:"clone",value:function(){var e=Object.create(this);return e.textMatrix=this.textMatrix.slice(),e.textLineMatrix=this.textLineMatrix.slice(),e.fontMatrix=this.fontMatrix.slice(),e}}]),e}(),EvalState=function(){function e(){_classCallCheck(this,e),this.ctm=new Float32Array(_util.IDENTITY_MATRIX),this.font=null,this.textRenderingMode=_util.TextRenderingMode.FILL,this.fillColorSpace=_colorspace.ColorSpace.singletons.gray,this.strokeColorSpace=_colorspace.ColorSpace.singletons.gray}return _createClass(e,[{key:"clone",value:function(){return Object.create(this)}}]),e}(),EvaluatorPreprocessor=function(){function u(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new StateManager;_classCallCheck(this,u),this.parser=new _parser.Parser({lexer:new _parser.Lexer(e,u.opMap),xref:t}),this.stateManager=r,this.nonProcessedArgs=[],this._numInvalidPathOPS=0}return _createClass(u,[{key:"savedStatesDepth",get:function(){return this.stateManager.stateStack.length}},{key:"read",value:function(e){for(var t=e.args;;){var r=this.parser.getObj();if(r instanceof _primitives.Cmd){var a=r.cmd,i=u.opMap[a];if(!i){(0,_util.warn)('Unknown command "'.concat(a,'".'));continue}var n=i.id,o=i.numArgs,s=null!==t?t.length:0;if(i.variableArgs)o<s&&(0,_util.info)("Command ".concat(a,": expected [0, ").concat(o,"] args, ")+"but received ".concat(s," args."));else{if(s!==o){for(var c=this.nonProcessedArgs;o<s;)c.push(t.shift()),s--;for(;s<o&&0!==c.length;)null===t&&(t=[]),t.unshift(c.pop()),s++}if(s<o){var l="command ".concat(a,": expected ").concat(o," args, ")+"but received ".concat(s," args.");if(n>=_util.OPS.moveTo&&n<=_util.OPS.endPath&&++this._numInvalidPathOPS>u.MAX_INVALID_PATH_OPS)throw new _util.FormatError("Invalid ".concat(l));(0,_util.warn)("Skipping ".concat(l)),null!==t&&(t.length=0);continue}}return this.preprocessCommand(n,t),e.fn=n,e.args=t,!0}if(r===_primitives.EOF)return!1;if(null!==r&&(null===t&&(t=[]),t.push(r),33<t.length))throw new _util.FormatError("Too many arguments")}}},{key:"preprocessCommand",value:function(e,t){switch(0|e){case _util.OPS.save:this.stateManager.save();break;case _util.OPS.restore:this.stateManager.restore();break;case _util.OPS.transform:this.stateManager.transform(t)}}}],[{key:"opMap",get:function(){var e=(0,_core_utils.getLookupTableFactory)(function(e){e.w={id:_util.OPS.setLineWidth,numArgs:1,variableArgs:!1},e.J={id:_util.OPS.setLineCap,numArgs:1,variableArgs:!1},e.j={id:_util.OPS.setLineJoin,numArgs:1,variableArgs:!1},e.M={id:_util.OPS.setMiterLimit,numArgs:1,variableArgs:!1},e.d={id:_util.OPS.setDash,numArgs:2,variableArgs:!1},e.ri={id:_util.OPS.setRenderingIntent,numArgs:1,variableArgs:!1},e.i={id:_util.OPS.setFlatness,numArgs:1,variableArgs:!1},e.gs={id:_util.OPS.setGState,numArgs:1,variableArgs:!1},e.q={id:_util.OPS.save,numArgs:0,variableArgs:!1},e.Q={id:_util.OPS.restore,numArgs:0,variableArgs:!1},e.cm={id:_util.OPS.transform,numArgs:6,variableArgs:!1},e.m={id:_util.OPS.moveTo,numArgs:2,variableArgs:!1},e.l={id:_util.OPS.lineTo,numArgs:2,variableArgs:!1},e.c={id:_util.OPS.curveTo,numArgs:6,variableArgs:!1},e.v={id:_util.OPS.curveTo2,numArgs:4,variableArgs:!1},e.y={id:_util.OPS.curveTo3,numArgs:4,variableArgs:!1},e.h={id:_util.OPS.closePath,numArgs:0,variableArgs:!1},e.re={id:_util.OPS.rectangle,numArgs:4,variableArgs:!1},e.S={id:_util.OPS.stroke,numArgs:0,variableArgs:!1},e.s={id:_util.OPS.closeStroke,numArgs:0,variableArgs:!1},e.f={id:_util.OPS.fill,numArgs:0,variableArgs:!1},e.F={id:_util.OPS.fill,numArgs:0,variableArgs:!1},e["f*"]={id:_util.OPS.eoFill,numArgs:0,variableArgs:!1},e.B={id:_util.OPS.fillStroke,numArgs:0,variableArgs:!1},e["B*"]={id:_util.OPS.eoFillStroke,numArgs:0,variableArgs:!1},e.b={id:_util.OPS.closeFillStroke,numArgs:0,variableArgs:!1},e["b*"]={id:_util.OPS.closeEOFillStroke,numArgs:0,variableArgs:!1},e.n={id:_util.OPS.endPath,numArgs:0,variableArgs:!1},e.W={id:_util.OPS.clip,numArgs:0,variableArgs:!1},e["W*"]={id:_util.OPS.eoClip,numArgs:0,variableArgs:!1},e.BT={id:_util.OPS.beginText,numArgs:0,variableArgs:!1},e.ET={id:_util.OPS.endText,numArgs:0,variableArgs:!1},e.Tc={id:_util.OPS.setCharSpacing,numArgs:1,variableArgs:!1},e.Tw={id:_util.OPS.setWordSpacing,numArgs:1,variableArgs:!1},e.Tz={id:_util.OPS.setHScale,numArgs:1,variableArgs:!1},e.TL={id:_util.OPS.setLeading,numArgs:1,variableArgs:!1},e.Tf={id:_util.OPS.setFont,numArgs:2,variableArgs:!1},e.Tr={id:_util.OPS.setTextRenderingMode,numArgs:1,variableArgs:!1},e.Ts={id:_util.OPS.setTextRise,numArgs:1,variableArgs:!1},e.Td={id:_util.OPS.moveText,numArgs:2,variableArgs:!1},e.TD={id:_util.OPS.setLeadingMoveText,numArgs:2,variableArgs:!1},e.Tm={id:_util.OPS.setTextMatrix,numArgs:6,variableArgs:!1},e["T*"]={id:_util.OPS.nextLine,numArgs:0,variableArgs:!1},e.Tj={id:_util.OPS.showText,numArgs:1,variableArgs:!1},e.TJ={id:_util.OPS.showSpacedText,numArgs:1,variableArgs:!1},e["'"]={id:_util.OPS.nextLineShowText,numArgs:1,variableArgs:!1},e['"']={id:_util.OPS.nextLineSetSpacingShowText,numArgs:3,variableArgs:!1},e.d0={id:_util.OPS.setCharWidth,numArgs:2,variableArgs:!1},e.d1={id:_util.OPS.setCharWidthAndBounds,numArgs:6,variableArgs:!1},e.CS={id:_util.OPS.setStrokeColorSpace,numArgs:1,variableArgs:!1},e.cs={id:_util.OPS.setFillColorSpace,numArgs:1,variableArgs:!1},e.SC={id:_util.OPS.setStrokeColor,numArgs:4,variableArgs:!0},e.SCN={id:_util.OPS.setStrokeColorN,numArgs:33,variableArgs:!0},e.sc={id:_util.OPS.setFillColor,numArgs:4,variableArgs:!0},e.scn={id:_util.OPS.setFillColorN,numArgs:33,variableArgs:!0},e.G={id:_util.OPS.setStrokeGray,numArgs:1,variableArgs:!1},e.g={id:_util.OPS.setFillGray,numArgs:1,variableArgs:!1},e.RG={id:_util.OPS.setStrokeRGBColor,numArgs:3,variableArgs:!1},e.rg={id:_util.OPS.setFillRGBColor,numArgs:3,variableArgs:!1},e.K={id:_util.OPS.setStrokeCMYKColor,numArgs:4,variableArgs:!1},e.k={id:_util.OPS.setFillCMYKColor,numArgs:4,variableArgs:!1},e.sh={id:_util.OPS.shadingFill,numArgs:1,variableArgs:!1},e.BI={id:_util.OPS.beginInlineImage,numArgs:0,variableArgs:!1},e.ID={id:_util.OPS.beginImageData,numArgs:0,variableArgs:!1},e.EI={id:_util.OPS.endInlineImage,numArgs:1,variableArgs:!1},e.Do={id:_util.OPS.paintXObject,numArgs:1,variableArgs:!1},e.MP={id:_util.OPS.markPoint,numArgs:1,variableArgs:!1},e.DP={id:_util.OPS.markPointProps,numArgs:2,variableArgs:!1},e.BMC={id:_util.OPS.beginMarkedContent,numArgs:1,variableArgs:!1},e.BDC={id:_util.OPS.beginMarkedContentProps,numArgs:2,variableArgs:!1},e.EMC={id:_util.OPS.endMarkedContent,numArgs:0,variableArgs:!1},e.BX={id:_util.OPS.beginCompat,numArgs:0,variableArgs:!1},e.EX={id:_util.OPS.endCompat,numArgs:0,variableArgs:!1},e.BM=null,e.BD=null,e.true=null,e.fa=null,e.fal=null,e.fals=null,e.false=null,e.nu=null,e.nul=null,e.null=null});return(0,_util.shadow)(this,"opMap",e())}},{key:"MAX_INVALID_PATH_OPS",get:function(){return(0,_util.shadow)(this,"MAX_INVALID_PATH_OPS",20)}}]),u}();exports.EvaluatorPreprocessor=EvaluatorPreprocessor;