"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var i=r.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(i){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(i);if(n){var r=_getPrototypeOf(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.JpxImage=void 0;var _util=require("../shared/util.js"),_core_utils=require("./core_utils.js"),_arithmetic_decoder=require("./arithmetic_decoder.js"),JpxError=function(e){_inherits(r,_util.BaseException);var t=_createSuper(r);function r(e){return _classCallCheck(this,r),t.call(this,"JPX error: ".concat(e))}return _createClass(r)}(),JpxImage=function(){var z={LL:0,LH:1,HL:1,HH:2};function e(){this.failOnCorruptedImage=!1}function O(e,t){e.x0=Math.ceil(t.XOsiz/e.XRsiz),e.x1=Math.ceil(t.Xsiz/e.XRsiz),e.y0=Math.ceil(t.YOsiz/e.YRsiz),e.y1=Math.ceil(t.Ysiz/e.YRsiz),e.width=e.x1-e.x0,e.height=e.y1-e.y0}function T(e,t){for(var r,i=e.SIZ,n=[],o=Math.ceil((i.Xsiz-i.XTOsiz)/i.XTsiz),a=Math.ceil((i.Ysiz-i.YTOsiz)/i.YTsiz),s=0;s<a;s++)for(var c=0;c<o;c++)(r={}).tx0=Math.max(i.XTOsiz+c*i.XTsiz,i.XOsiz),r.ty0=Math.max(i.YTOsiz+s*i.YTsiz,i.YOsiz),r.tx1=Math.min(i.XTOsiz+(c+1)*i.XTsiz,i.Xsiz),r.ty1=Math.min(i.YTOsiz+(s+1)*i.YTsiz,i.Ysiz),r.width=r.tx1-r.tx0,r.height=r.ty1-r.ty0,r.components=[],n.push(r);e.tiles=n;for(var l=0,u=i.Csiz;l<u;l++)for(var h=t[l],f=0,d=n.length;f<d;f++){var p={};r=n[f],p.tcx0=Math.ceil(r.tx0/h.XRsiz),p.tcy0=Math.ceil(r.ty0/h.YRsiz),p.tcx1=Math.ceil(r.tx1/h.XRsiz),p.tcy1=Math.ceil(r.ty1/h.YRsiz),p.width=p.tcx1-p.tcx0,p.height=p.tcy1-p.tcy0,r.components[l]=p}}function U(e,t,r){var i,n,o,a,s=r.xcb_,c=r.ycb_,l=1<<s,u=1<<c,h=t.tbx0>>s,f=t.tby0>>c,d=t.tbx1+l-1>>s,p=t.tby1+u-1>>c,m=t.resolution.precinctParameters,v=[],b=[];for(n=f;n<p;n++)for(i=h;i<d;i++){if((o={cbx:i,cby:n,tbx0:l*i,tby0:u*n,tbx1:l*(i+1),tby1:u*(n+1)}).tbx0_=Math.max(t.tbx0,o.tbx0),o.tby0_=Math.max(t.tby0,o.tby0),o.tbx1_=Math.min(t.tbx1,o.tbx1),o.tby1_=Math.min(t.tby1,o.tby1),a=Math.floor((o.tbx0_-t.tbx0)/m.precinctWidthInSubband)+Math.floor((o.tby0_-t.tby0)/m.precinctHeightInSubband)*m.numprecinctswide,o.precinctNumber=a,o.subbandType=t.type,o.Lblock=3,!(o.tbx1_<=o.tbx0_||o.tby1_<=o.tby0_)){v.push(o);var y=b[a];void 0!==y?(i<y.cbxMin?y.cbxMin=i:i>y.cbxMax&&(y.cbxMax=i),n<y.cbyMin?y.cbxMin=n:n>y.cbyMax&&(y.cbyMax=n)):b[a]=y={cbxMin:i,cbyMin:n,cbxMax:i,cbyMax:n},o.precinct=y}}t.codeblockParameters={codeblockWidth:s,codeblockHeight:c,numcodeblockwide:d-h+1,numcodeblockhigh:p-f+1},t.codeblocks=v,t.precincts=b}function v(e,t,r){for(var i=[],n=e.subbands,o=0,a=n.length;o<a;o++)for(var s=n[o].codeblocks,c=0,l=s.length;c<l;c++){var u=s[c];u.precinctNumber===t&&i.push(u)}return{layerNumber:r,codeblocks:i}}function L(e){for(var t=e.SIZ,r=e.currentTile.index,n=e.tiles[r],o=n.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,i=0;i<a;i++)s=Math.max(s,n.components[i].codingStyleParameters.decompositionLevelsCount);var c=0,l=0,u=0,h=0;this.nextPacket=function(){for(;c<o;c++){for(;l<=s;l++){for(;u<a;u++){var e=n.components[u];if(!(l>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[l],r=t.precinctParameters.numprecincts;h<r;){var i=v(t,h,c);return h++,i}h=0}}u=0}l=0}throw new JpxError("Out of packets")}}function I(e){for(var t=e.SIZ,r=e.currentTile.index,n=e.tiles[r],o=n.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,i=0;i<a;i++)s=Math.max(s,n.components[i].codingStyleParameters.decompositionLevelsCount);var c=0,l=0,u=0,h=0;this.nextPacket=function(){for(;c<=s;c++){for(;l<o;l++){for(;u<a;u++){var e=n.components[u];if(!(c>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[c],r=t.precinctParameters.numprecincts;h<r;){var i=v(t,h,l);return h++,i}h=0}}u=0}l=0}throw new JpxError("Out of packets")}}function A(e){var i,n,o,a,t=e.SIZ,r=e.currentTile.index,s=e.tiles[r],c=s.codingStyleDefaultParameters.layersCount,l=t.Csiz,u=0;for(o=0;o<l;o++){var h=s.components[o];u=Math.max(u,h.codingStyleParameters.decompositionLevelsCount)}var f=new Int32Array(u+1);for(n=0;n<=u;++n){var d=0;for(o=0;o<l;++o){var p=s.components[o].resolutions;n<p.length&&(d=Math.max(d,p[n].precinctParameters.numprecincts))}f[n]=d}a=o=n=i=0,this.nextPacket=function(){for(;n<=u;n++){for(;a<f[n];a++){for(;o<l;o++){var e=s.components[o];if(!(n>e.codingStyleParameters.decompositionLevelsCount)){var t=e.resolutions[n];if(!(t.precinctParameters.numprecincts<=a)){for(;i<c;){var r=v(t,a,i);return i++,r}i=0}}}o=0}a=0}throw new JpxError("Out of packets")}}function E(e){var t=e.SIZ,r=e.currentTile.index,a=e.tiles[r],s=a.codingStyleDefaultParameters.layersCount,c=t.Csiz,l=i(a),u=l,h=0,f=0,d=0,p=0,m=0;this.nextPacket=function(){for(;m<u.maxNumHigh;m++){for(;p<u.maxNumWide;p++){for(;d<c;d++){for(var e=a.components[d],t=e.codingStyleParameters.decompositionLevelsCount;f<=t;f++){var r=e.resolutions[f],i=l.components[d].resolutions[f],n=b(p,m,i,u,r);if(null!==n){for(;h<s;){var o=v(r,n,h);return h++,o}h=0}}f=0}d=0}p=0}throw new JpxError("Out of packets")}}function B(e){var t=e.SIZ,r=e.currentTile.index,s=e.tiles[r],c=s.codingStyleDefaultParameters.layersCount,l=t.Csiz,u=i(s),h=0,f=0,d=0,p=0,m=0;this.nextPacket=function(){for(;d<l;++d){for(var e=s.components[d],t=u.components[d],r=e.codingStyleParameters.decompositionLevelsCount;m<t.maxNumHigh;m++){for(;p<t.maxNumWide;p++){for(;f<=r;f++){var i=e.resolutions[f],n=t.resolutions[f],o=b(p,m,n,t,i);if(null!==o){for(;h<c;){var a=v(i,o,h);return h++,a}h=0}}f=0}p=0}m=0}throw new JpxError("Out of packets")}}function b(e,t,r,i,n){var o=e*i.minWidth,a=t*i.minHeight;if(o%r.width!=0||a%r.height!=0)return null;var s=a/r.width*n.precinctParameters.numprecinctswide;return o/r.height+s}function i(e){for(var t=e.components.length,r=Number.MAX_VALUE,i=Number.MAX_VALUE,n=0,o=0,a=new Array(t),s=0;s<t;s++){for(var c=e.components[s],l=c.codingStyleParameters.decompositionLevelsCount,u=new Array(l+1),h=Number.MAX_VALUE,f=Number.MAX_VALUE,d=0,p=0,m=1,v=l;0<=v;--v){var b=c.resolutions[v],y=m*b.precinctParameters.precinctWidth,g=m*b.precinctParameters.precinctHeight;h=Math.min(h,y),f=Math.min(f,g),d=Math.max(d,b.precinctParameters.numprecinctswide),p=Math.max(p,b.precinctParameters.numprecinctshigh),u[v]={width:y,height:g},m<<=1}r=Math.min(r,h),i=Math.min(i,f),n=Math.max(n,d),o=Math.max(o,p),a[s]={resolutions:u,minWidth:h,minHeight:f,maxNumWide:d,maxNumHigh:p}}return{components:a,minWidth:r,minHeight:i,maxNumWide:n,maxNumHigh:o}}function D(e){for(var t,r,i,n,o,a,s,c,l,u,h,f,d,p=e.SIZ,m=e.currentTile.index,v=e.tiles[m],b=p.Csiz,y=0;y<b;y++){for(var g=v.components[y],x=g.codingStyleParameters.decompositionLevelsCount,_=[],P=[],C=0;C<=x;C++){var w,M=(h=C,d=void 0,f=g.codingStyleParameters,d={},f.entropyCoderWithCustomPrecincts?(d.PPx=f.precinctsSizes[h].PPx,d.PPy=f.precinctsSizes[h].PPy):(d.PPx=15,d.PPy=15),d.xcb_=0<h?Math.min(f.xcb,d.PPx-1):Math.min(f.xcb,d.PPx),d.ycb_=0<h?Math.min(f.ycb,d.PPy-1):Math.min(f.ycb,d.PPy),d),S={},k=1<<x-C;if(S.trx0=Math.ceil(g.tcx0/k),S.try0=Math.ceil(g.tcy0/k),S.trx1=Math.ceil(g.tcx1/k),S.try1=Math.ceil(g.tcy1/k),S.resLevel=C,t=S,void 0,i=1<<(r=M).PPx,n=1<<r.PPy,o=0===t.resLevel,a=1<<r.PPx+(o?0:-1),s=1<<r.PPy+(o?0:-1),c=t.trx1>t.trx0?Math.ceil(t.trx1/i)-Math.floor(t.trx0/i):0,l=t.try1>t.try0?Math.ceil(t.try1/n)-Math.floor(t.try0/n):0,u=c*l,t.precinctParameters={precinctWidth:i,precinctHeight:n,numprecinctswide:c,numprecinctshigh:l,numprecincts:u,precinctWidthInSubband:a,precinctHeightInSubband:s},_.push(S),0===C)(w={type:"LL"}).tbx0=Math.ceil(g.tcx0/k),w.tby0=Math.ceil(g.tcy0/k),w.tbx1=Math.ceil(g.tcx1/k),w.tby1=Math.ceil(g.tcy1/k),w.resolution=S,U(0,w,M),P.push(w),S.subbands=[w];else{var z=1<<x-C+1,O=[];(w={}).type="HL",w.tbx0=Math.ceil(g.tcx0/z-.5),w.tby0=Math.ceil(g.tcy0/z),w.tbx1=Math.ceil(g.tcx1/z-.5),w.tby1=Math.ceil(g.tcy1/z),w.resolution=S,U(0,w,M),P.push(w),O.push(w),(w={}).type="LH",w.tbx0=Math.ceil(g.tcx0/z),w.tby0=Math.ceil(g.tcy0/z-.5),w.tbx1=Math.ceil(g.tcx1/z),w.tby1=Math.ceil(g.tcy1/z-.5),w.resolution=S,U(0,w,M),P.push(w),O.push(w),(w={type:"HH"}).tbx0=Math.ceil(g.tcx0/z-.5),w.tby0=Math.ceil(g.tcy0/z-.5),w.tbx1=Math.ceil(g.tcx1/z-.5),w.tby1=Math.ceil(g.tcy1/z-.5),w.resolution=S,U(0,w,M),P.push(w),O.push(w),S.subbands=O}}g.resolutions=_,g.subbands=P}var T=v.codingStyleDefaultParameters.progressionOrder;switch(T){case 0:v.packetsIterator=new L(e);break;case 1:v.packetsIterator=new I(e);break;case 2:v.packetsIterator=new A(e);break;case 3:v.packetsIterator=new E(e);break;case 4:v.packetsIterator=new B(e);break;default:throw new JpxError("Unsupported progression order ".concat(T))}}function X(e,r,i,t){var n,o=0,a=0,s=!1;function c(e){for(;a<e;){var t=r[i+o];o++,s?(n=n<<7|t,a+=7,s=!1):(n=n<<8|t,a+=8),255===t&&(s=!0)}return n>>>(a-=e)&(1<<e)-1}function l(e){return 255===r[i+o-1]&&r[i+o]===e?(u(1),!0):255===r[i+o]&&r[i+o+1]===e&&(u(2),!0)}function u(e){o+=e}function h(){a=0,s&&(o++,s=!1)}function f(){if(0===c(1))return 1;if(0===c(1))return 2;var e=c(2);return e<3?e+3:(e=c(5))<31?e+6:(e=c(7))+37}for(var d=e.currentTile.index,p=e.tiles[d],m=e.COD.sopMarkerUsed,v=e.COD.ephMarkerUsed,b=p.packetsIterator;o<t;){h(),m&&l(145)&&u(4);var y=b.nextPacket();if(c(1)){for(var g,x=y.layerNumber,_=[],P=0,C=y.codeblocks.length;P<C;P++){var w=(g=y.codeblocks[P]).precinct,M=g.cbx-w.cbxMin,S=g.cby-w.cbyMin,k=!1,z=!1;if(void 0!==g.included)k=!!c(1);else{var O,T;if(void 0!==(w=g.precinct).inclusionTree)O=w.inclusionTree;else{var U=w.cbxMax-w.cbxMin+1,L=w.cbyMax-w.cbyMin+1;O=new J(U,L,x),T=new Y(U,L),w.inclusionTree=O,w.zeroBitPlanesTree=T}if(O.reset(M,S,x))for(;;){if(!c(1)){O.incrementValue(x);break}if(!O.nextLevel()){k=z=g.included=!0;break}}}if(k){if(z){for((T=w.zeroBitPlanesTree).reset(M,S);;)if(c(1)){if(!T.nextLevel())break}else T.incrementValue();g.zeroBitPlanes=T.value}for(var I=f();c(1);)g.Lblock++;var A=(0,_core_utils.log2)(I),E=c((I<1<<A?A-1:A)+g.Lblock);_.push({codeblock:g,codingpasses:I,dataLength:E})}}for(h(),v&&l(146);0<_.length;){var B=_.shift();void 0===(g=B.codeblock).data&&(g.data=[]),g.data.push({data:r,start:i+o,end:i+o+B.dataLength,codingpasses:B.codingpasses}),o+=B.dataLength}}}return o}function H(e,t,r,i,n,o,a,s){for(var c=i.tbx0,l=i.tby0,u=i.tbx1-i.tbx0,h=i.codeblocks,f="H"===i.type.charAt(0)?1:0,d="H"===i.type.charAt(1)?t:0,p=0,m=h.length;p<m;++p){var v=h[p],b=v.tbx1_-v.tbx0_,y=v.tby1_-v.tby0_;if(0!==b&&0!==y&&void 0!==v.data){var g,x;g=new j(b,y,v.subbandType,v.zeroBitPlanes,o),x=2;var _,P,C,w=v.data,M=0,S=0;for(_=0,P=w.length;_<P;_++)M+=(C=w[_]).end-C.start,S+=C.codingpasses;var k=new Uint8Array(M),z=0;for(_=0,P=w.length;_<P;_++){var O=(C=w[_]).data.subarray(C.start,C.end);k.set(O,z),z+=O.length}var T=new _arithmetic_decoder.ArithmeticDecoder(k,0,M);for(g.setDecoder(T),_=0;_<S;_++){switch(x){case 0:g.runSignificancePropagationPass();break;case 1:g.runMagnitudeRefinementPass();break;case 2:g.runCleanupPass(),s&&g.checkSegmentationSymbol()}x=(x+1)%3}var U,L,I,A=v.tbx0_-c+(v.tby0_-l)*u,E=g.coefficentsSign,B=g.coefficentsMagnitude,D=g.bitsDecoded,X=a?0:.5;z=0;var H="LL"!==i.type;for(_=0;_<y;_++){var N=2*(A/u|0)*(t-u)+f+d;for(U=0;U<b;U++){if(0!==(L=B[z])){L=(L+X)*n,0!==E[z]&&(L=-L),I=D[z];var R=H?N+(A<<1):A;e[R]=a&&o<=I?L:L*(1<<o-I)}A++,z++}A+=u-b}}}}function N(e,t,r){for(var i=t.components[r],n=i.codingStyleParameters,o=i.quantizationParameters,a=n.decompositionLevelsCount,s=o.SPqcds,c=o.scalarExpounded,l=o.guardBits,u=n.segmentationSymbolUsed,h=e.components[r].precision,f=n.reversibleTransformation,d=f?new Z:new Q,p=[],m=0,v=0;v<=a;v++){for(var b=i.resolutions[v],y=b.trx1-b.trx0,g=b.try1-b.try0,x=new Float32Array(y*g),_=0,P=b.subbands.length;_<P;_++){var C,w;c?(C=s[m].mu,w=s[m].epsilon,m++):(C=s[0].mu,w=s[0].epsilon+(0<v?1-v:0));var M=b.subbands[_],S=z[M.type];H(x,y,0,M,f?1:Math.pow(2,h+S-w)*(1+C/2048),l+w-1,f,u)}p.push({width:y,height:g,items:x})}var k=d.calculate(p,i.tcx0,i.tcy0);return{left:i.tcx0,top:i.tcy0,width:k.width,height:k.height,items:k.items}}function R(e,t){for(var r=e.SIZ.Csiz,i=e.tiles[t],n=0;n<r;n++){var o=i.components[n],a=void 0!==e.currentTile.QCC[n]?e.currentTile.QCC[n]:e.currentTile.QCD;o.quantizationParameters=a;var s=void 0!==e.currentTile.COC[n]?e.currentTile.COC[n]:e.currentTile.COD;o.codingStyleParameters=s}i.codingStyleDefaultParameters=e.currentTile.COD}e.prototype={parse:function(e){if(65359!==(0,_core_utils.readUint16)(e,0))for(var t=0,r=e.length;t<r;){var i=8,n=(0,_core_utils.readUint32)(e,t),o=(0,_core_utils.readUint32)(e,t+4);if(t+=i,1===n&&(n=4294967296*(0,_core_utils.readUint32)(e,t)+(0,_core_utils.readUint32)(e,t+4),t+=8,i+=8),0===n&&(n=r-t+i),n<i)throw new JpxError("Invalid box field size");var a=n-i,s=!0;switch(o){case 1785737832:s=!1;break;case 1668246642:var c=e[t];if(1===c){var l=(0,_core_utils.readUint32)(e,t+3);switch(l){case 16:case 17:case 18:break;default:(0,_util.warn)("Unknown colorspace "+l)}}else 2===c&&(0,_util.info)("ICC profile not supported");break;case 1785737827:this.parseCodestream(e,t,t+a);break;case 1783636e3:218793738!==(0,_core_utils.readUint32)(e,t)&&(0,_util.warn)("Invalid JP2 signature");break;case 1783634458:case 1718909296:case 1920099697:case 1919251232:case 1768449138:break;default:var u=String.fromCharCode(o>>24&255,o>>16&255,o>>8&255,255&o);(0,_util.warn)("Unsupported header type "+o+" ("+u+")")}s&&(t+=a)}else this.parseCodestream(e,0,e.length)},parseImageProperties:function(e){for(var t=e.getByte();0<=t;){if(65361===(t<<8|(t=e.getByte()))){e.skip(4);var r=e.getInt32()>>>0,i=e.getInt32()>>>0,n=e.getInt32()>>>0,o=e.getInt32()>>>0;e.skip(16);var a=e.getUint16();return this.width=r-n,this.height=i-o,this.componentsCount=a,void(this.bitsPerComponent=8)}}throw new JpxError("No size marker found in JPX stream")},parseCodestream:function(e,t,r){var i={},n=!1;try{for(var o=t;o+1<r;){var a=(0,_core_utils.readUint16)(e,o);o+=2;var s,c,l,u,h,f,d=0;switch(a){case 65359:i.mainHeader=!0;break;case 65497:break;case 65361:d=(0,_core_utils.readUint16)(e,o);var p={};p.Xsiz=(0,_core_utils.readUint32)(e,o+4),p.Ysiz=(0,_core_utils.readUint32)(e,o+8),p.XOsiz=(0,_core_utils.readUint32)(e,o+12),p.YOsiz=(0,_core_utils.readUint32)(e,o+16),p.XTsiz=(0,_core_utils.readUint32)(e,o+20),p.YTsiz=(0,_core_utils.readUint32)(e,o+24),p.XTOsiz=(0,_core_utils.readUint32)(e,o+28),p.YTOsiz=(0,_core_utils.readUint32)(e,o+32);var m=(0,_core_utils.readUint16)(e,o+36);p.Csiz=m;var v=[];s=o+38;for(var b=0;b<m;b++){var y={precision:1+(127&e[s]),isSigned:!!(128&e[s]),XRsiz:e[s+1],YRsiz:e[s+2]};s+=3,O(y,p),v.push(y)}i.SIZ=p,i.components=v,T(i,v),i.QCC=[],i.COC=[];break;case 65372:d=(0,_core_utils.readUint16)(e,o);var g={};switch(s=o+2,31&(c=e[s++])){case 0:u=8,h=!0;break;case 1:h=!(u=16);break;case 2:u=16,h=!0;break;default:throw new Error("Invalid SQcd value "+c)}for(g.noQuantization=8===u,g.scalarExpounded=h,g.guardBits=c>>5,l=[];s<d+o;){var x={};8===u?(x.epsilon=e[s++]>>3,x.mu=0):(x.epsilon=e[s]>>3,x.mu=(7&e[s])<<8|e[s+1],s+=2),l.push(x)}g.SPqcds=l,i.mainHeader?i.QCD=g:(i.currentTile.QCD=g,i.currentTile.QCC=[]);break;case 65373:d=(0,_core_utils.readUint16)(e,o);var _,P={};switch(s=o+2,i.SIZ.Csiz<257?_=e[s++]:(_=(0,_core_utils.readUint16)(e,s),s+=2),31&(c=e[s++])){case 0:u=8,h=!0;break;case 1:h=!(u=16);break;case 2:u=16,h=!0;break;default:throw new Error("Invalid SQcd value "+c)}for(P.noQuantization=8===u,P.scalarExpounded=h,P.guardBits=c>>5,l=[];s<d+o;)x={},8===u?(x.epsilon=e[s++]>>3,x.mu=0):(x.epsilon=e[s]>>3,x.mu=(7&e[s])<<8|e[s+1],s+=2),l.push(x);P.SPqcds=l,i.mainHeader?i.QCC[_]=P:i.currentTile.QCC[_]=P;break;case 65362:d=(0,_core_utils.readUint16)(e,o);var C={};s=o+2;var w=e[s++];C.entropyCoderWithCustomPrecincts=!!(1&w),C.sopMarkerUsed=!!(2&w),C.ephMarkerUsed=!!(4&w),C.progressionOrder=e[s++],C.layersCount=(0,_core_utils.readUint16)(e,s),s+=2,C.multipleComponentTransform=e[s++],C.decompositionLevelsCount=e[s++],C.xcb=2+(15&e[s++]),C.ycb=2+(15&e[s++]);var M=e[s++];if(C.selectiveArithmeticCodingBypass=!!(1&M),C.resetContextProbabilities=!!(2&M),C.terminationOnEachCodingPass=!!(4&M),C.verticallyStripe=!!(8&M),C.predictableTermination=!!(16&M),C.segmentationSymbolUsed=!!(32&M),C.reversibleTransformation=e[s++],C.entropyCoderWithCustomPrecincts){for(var S=[];s<d+o;){var k=e[s++];S.push({PPx:15&k,PPy:k>>4})}C.precinctsSizes=S}var z=[];C.selectiveArithmeticCodingBypass&&z.push("selectiveArithmeticCodingBypass"),C.resetContextProbabilities&&z.push("resetContextProbabilities"),C.terminationOnEachCodingPass&&z.push("terminationOnEachCodingPass"),C.verticallyStripe&&z.push("verticallyStripe"),C.predictableTermination&&z.push("predictableTermination"),0<z.length&&(n=!0,(0,_util.warn)("JPX: Unsupported COD options (".concat(z.join(", "),")."))),i.mainHeader?i.COD=C:(i.currentTile.COD=C,i.currentTile.COC=[]);break;case 65424:d=(0,_core_utils.readUint16)(e,o),(f={}).index=(0,_core_utils.readUint16)(e,o+2),f.length=(0,_core_utils.readUint32)(e,o+4),f.dataEnd=f.length+o-2,f.partIndex=e[o+8],f.partsCount=e[o+9],i.mainHeader=!1,0===f.partIndex&&(f.COD=i.COD,f.COC=i.COC.slice(0),f.QCD=i.QCD,f.QCC=i.QCC.slice(0)),i.currentTile=f;break;case 65427:0===(f=i.currentTile).partIndex&&(R(i,f.index),D(i)),X(i,e,o,d=f.dataEnd-o);break;case 65363:(0,_util.warn)("JPX: Codestream code 0xFF53 (COC) is not implemented.");case 65365:case 65367:case 65368:case 65380:d=(0,_core_utils.readUint16)(e,o);break;default:throw new Error("Unknown codestream code: "+a.toString(16))}o+=d}}catch(e){if(n||this.failOnCorruptedImage)throw new JpxError(e.message);(0,_util.warn)('JPX: Trying to recover from: "'.concat(e.message,'".'))}this.tiles=function(e){for(var t=e.SIZ,r=e.components,i=t.Csiz,n=[],o=0,a=e.tiles.length;o<a;o++){var s,c=e.tiles[o],l=[];for(s=0;s<i;s++)l[s]=N(e,c,s);var u,h,f,d,p,m,v,b=l[0],y=new Uint8ClampedArray(b.items.length*i),g={left:b.left,top:b.top,width:b.width,height:b.height,items:y},x=0;if(c.codingStyleDefaultParameters.multipleComponentTransform){var _=4===i,P=l[0].items,C=l[1].items,w=l[2].items,M=_?l[3].items:null;u=r[0].precision-8,h=.5+(128<<u);var S=c.components[0],k=i-3;if(d=P.length,S.codingStyleParameters.reversibleTransformation)for(f=0;f<d;f++,x+=k){p=P[f]+h,m=C[f],v=w[f];var z=p-(v+m>>2);y[x++]=z+v>>u,y[x++]=z>>u,y[x++]=z+m>>u}else for(f=0;f<d;f++,x+=k)p=P[f]+h,m=C[f],v=w[f],y[x++]=p+1.402*v>>u,y[x++]=p-.34413*m-.71414*v>>u,y[x++]=p+1.772*m>>u;if(_)for(f=0,x=3;f<d;f++,x+=4)y[x]=M[f]+h>>u}else for(s=0;s<i;s++){var O=l[s].items;for(u=r[s].precision-8,h=.5+(128<<u),x=s,f=0,d=O.length;f<d;f++)y[x]=O[f]+h>>u,x+=i}n.push(g)}return n}(i),this.width=i.SIZ.Xsiz-i.SIZ.XOsiz,this.height=i.SIZ.Ysiz-i.SIZ.YOsiz,this.componentsCount=i.SIZ.Csiz}};var Y=function(){function e(e,t){var r=(0,_core_utils.log2)(Math.max(e,t))+1;this.levels=[];for(var i=0;i<r;i++){var n={width:e,height:t,items:[]};this.levels.push(n),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t){for(var r,i=0,n=0;i<this.levels.length;){var o=e+t*(r=this.levels[i]).width;if(void 0!==r.items[o]){n=r.items[o];break}r.index=o,e>>=1,t>>=1,i++}i--,(r=this.levels[i]).items[r.index]=n,this.currentLevel=i,delete this.value},incrementValue:function(){var e=this.levels[this.currentLevel];e.items[e.index]++},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];return--e<0?(this.value=r,!1):(this.currentLevel=e,(t=this.levels[e]).items[t.index]=r,!0)}},e}(),J=function(){function e(e,t,r){var i=(0,_core_utils.log2)(Math.max(e,t))+1;this.levels=[];for(var n=0;n<i;n++){for(var o=new Uint8Array(e*t),a=0,s=o.length;a<s;a++)o[a]=r;var c={width:e,height:t,items:o};this.levels.push(c),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t,r){for(var i=0;i<this.levels.length;){var n=this.levels[i],o=e+t*n.width;n.index=o;var a=n.items[o];if(255===a)break;if(r<a)return this.currentLevel=i,this.propagateValues(),!1;e>>=1,t>>=1,i++}return this.currentLevel=i-1,!0},incrementValue:function(e){var t=this.levels[this.currentLevel];t.items[t.index]=e+1,this.propagateValues()},propagateValues:function(){for(var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];0<=--e;)(t=this.levels[e]).items[t.index]=r},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];return t.items[t.index]=255,!(--e<0)&&(this.currentLevel=e,(t=this.levels[e]).items[t.index]=r,!0)}},e}(),j=function(){var u=new Uint8Array([0,5,8,0,3,7,8,0,4,7,8,0,0,0,0,0,1,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8]),h=new Uint8Array([0,3,4,0,5,7,7,0,8,8,8,0,0,0,0,0,1,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8]),f=new Uint8Array([0,1,2,0,1,2,2,0,2,2,2,0,0,0,0,0,3,4,5,0,4,5,5,0,5,5,5,0,0,0,0,0,6,7,7,0,7,7,7,0,7,7,7,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8]);function e(e,t,r,i,n){var o;this.width=e,this.height=t,o="HH"===r?f:"HL"===r?h:u,this.contextLabelTable=o;var a,s=e*t;this.neighborsSignificance=new Uint8Array(s),this.coefficentsSign=new Uint8Array(s),a=14<n?new Uint32Array(s):6<n?new Uint16Array(s):new Uint8Array(s),this.coefficentsMagnitude=a,this.processingFlags=new Uint8Array(s);var c=new Uint8Array(s);if(0!==i)for(var l=0;l<s;l++)c[l]=i;this.bitsDecoded=c,this.reset()}return e.prototype={setDecoder:function(e){this.decoder=e},reset:function(){this.contexts=new Int8Array(19),this.contexts[0]=8,this.contexts[17]=92,this.contexts[18]=6},setNeighborsSignificance:function(e,t,r){var i,n=this.neighborsSignificance,o=this.width,a=this.height,s=0<t,c=t+1<o;0<e&&(i=r-o,s&&(n[i-1]+=16),c&&(n[i+1]+=16),n[i]+=4),e+1<a&&(i=r+o,s&&(n[i-1]+=16),c&&(n[i+1]+=16),n[i]+=4),s&&(n[r-1]+=1),c&&(n[r+1]+=1),n[r]|=128},runSignificancePropagationPass:function(){for(var e=this.decoder,t=this.width,r=this.height,i=this.coefficentsMagnitude,n=this.coefficentsSign,o=this.neighborsSignificance,a=this.processingFlags,s=this.contexts,c=this.contextLabelTable,l=this.bitsDecoded,u=0;u<r;u+=4)for(var h=0;h<t;h++)for(var f=u*t+h,d=0;d<4;d++,f+=t){var p=u+d;if(r<=p)break;if(a[f]&=-2,!i[f]&&o[f]){var m=c[o[f]];if(e.readBit(s,m)){var v=this.decodeSignBit(p,h,f);n[f]=v,i[f]=1,this.setNeighborsSignificance(p,h,f),a[f]|=2}l[f]++,a[f]|=1}}},decodeSignBit:function(e,t,r){var i,n,o,a,s,c=this.width,l=this.height,u=this.coefficentsMagnitude,h=this.coefficentsSign;a=0<t&&0!==u[r-1];var f=3*(i=t+1<c&&0!==u[r+1]?(o=h[r+1],a?1-o-(n=h[r-1]):1-o-o):a?1-(n=h[r-1])-n:0);return a=0<e&&0!==u[r-c],0<=(i=e+1<l&&0!==u[r+c]?(o=h[r+c],a?1-o-(n=h[r-c])+f:1-o-o+f):a?1-(n=h[r-c])-n+f:f)?(s=9+i,this.decoder.readBit(this.contexts,s)):(s=9-i,1^this.decoder.readBit(this.contexts,s))},runMagnitudeRefinementPass:function(){for(var e,t=this.decoder,r=this.width,i=this.height,n=this.coefficentsMagnitude,o=this.neighborsSignificance,a=this.contexts,s=this.bitsDecoded,c=this.processingFlags,l=r*i,u=4*r,h=0;h<l;h=e){e=Math.min(l,h+u);for(var f=0;f<r;f++)for(var d=h+f;d<e;d+=r)if(n[d]&&0==(1&c[d])){var p=16;if(0!=(2&c[d]))c[d]^=2,p=0===(127&o[d])?15:14;var m=t.readBit(a,p);n[d]=n[d]<<1|m,s[d]++,c[d]|=1}}},runCleanupPass:function(){for(var e,t=this.decoder,r=this.width,i=this.height,n=this.neighborsSignificance,o=this.coefficentsMagnitude,a=this.coefficentsSign,s=this.contexts,c=this.contextLabelTable,l=this.bitsDecoded,u=this.processingFlags,h=r,f=2*r,d=3*r,p=0;p<i;p=e){e=Math.min(p+4,i);for(var m=p*r,v=p+3<i,b=0;b<r;b++){var y,g=m+b,x=0,_=g,P=p;if(v&&0===u[g]&&0===u[g+h]&&0===u[g+f]&&0===u[g+d]&&0===n[g]&&0===n[g+h]&&0===n[g+f]&&0===n[g+d]){if(!t.readBit(s,18)){l[g]++,l[g+h]++,l[g+f]++,l[g+d]++;continue}0!==(x=t.readBit(s,17)<<1|t.readBit(s,17))&&(P=p+x,_+=x*r),y=this.decodeSignBit(P,b,_),a[_]=y,o[_]=1,this.setNeighborsSignificance(P,b,_),u[_]|=2,_=g;for(var C=p;C<=P;C++,_+=r)l[_]++;x++}for(P=p+x;P<e;P++,_+=r)if(!o[_]&&0==(1&u[_])){var w=c[n[_]];1===t.readBit(s,w)&&(y=this.decodeSignBit(P,b,_),a[_]=y,o[_]=1,this.setNeighborsSignificance(P,b,_),u[_]|=2),l[_]++}}}},checkSegmentationSymbol:function(){var e=this.decoder,t=this.contexts;if(10!==(e.readBit(t,17)<<3|e.readBit(t,17)<<2|e.readBit(t,17)<<1|e.readBit(t,17)))throw new JpxError("Invalid segmentation symbol")}},e}(),t=function(){function e(){}return e.prototype.calculate=function(e,t,r){for(var i=e[0],n=1,o=e.length;n<o;n++)i=this.iterate(i,e[n],t,r);return i},e.prototype.extend=function(e,t,r){var i=t-1,n=t+1,o=t+r-2,a=t+r;e[i--]=e[n++],e[a++]=e[o--],e[i--]=e[n++],e[a++]=e[o--],e[i--]=e[n++],e[a++]=e[o--],e[i]=e[n],e[a]=e[o]},e.prototype.iterate=function(e,t,r,i){var n,o,a,s,c,l,u=e.width,h=e.height,f=e.items,d=t.width,p=t.height,m=t.items;for(n=a=0;n<h;n++)for(s=2*n*d,o=0;o<u;o++,a++,s+=2)m[s]=f[a];f=e.items=null;var v=new Float32Array(d+8);if(1===d){if(0!=(1&r))for(a=l=0;l<p;l++,a+=d)m[a]*=.5}else for(a=l=0;l<p;l++,a+=d)v.set(m.subarray(a,a+d),4),this.extend(v,4,d),this.filter(v,4,d),m.set(v.subarray(4,4+d),a);var b=16,y=[];for(n=0;n<b;n++)y.push(new Float32Array(p+8));var g,x=0;if(e=4+p,1===p){if(0!=(1&i))for(c=0;c<d;c++)m[c]*=.5}else for(c=0;c<d;c++){if(0===x){for(b=Math.min(d-c,b),a=c,s=4;s<e;a+=d,s++)for(g=0;g<b;g++)y[g][s]=m[a+g];x=b}var _=y[--x];if(this.extend(_,4,p),this.filter(_,4,p),0===x)for(a=c-b+1,s=4;s<e;a+=d,s++)for(g=0;g<b;g++)m[a+g]=y[g][s]}return{width:d,height:p,items:m}},e}(),Q=function(){function e(){t.call(this)}return(e.prototype=Object.create(t.prototype)).filter=function(e,t,r){var i,n,o,a,s=r>>1,c=-1.586134342059924,l=-.052980118572961,u=.882911075530934,h=.443506852043971,f=1.230174104914001;for(i=(t|=0)-3,n=s+4;n--;i+=2)e[i]*=.8128930661159609;for(o=h*e[(i=t-2)-1],n=s+3;n--&&(a=h*e[i+1],e[i]=f*e[i]-o-a,n--);i+=2)o=h*e[(i+=2)+1],e[i]=f*e[i]-o-a;for(o=u*e[(i=t-1)-1],n=s+2;n--&&(a=u*e[i+1],e[i]-=o+a,n--);i+=2)o=u*e[(i+=2)+1],e[i]-=o+a;for(o=l*e[(i=t)-1],n=s+1;n--&&(a=l*e[i+1],e[i]-=o+a,n--);i+=2)o=l*e[(i+=2)+1],e[i]-=o+a;if(0!==s)for(o=c*e[(i=t+1)-1],n=s;n--&&(a=c*e[i+1],e[i]-=o+a,n--);i+=2)o=c*e[(i+=2)+1],e[i]-=o+a},e}(),Z=function(){function e(){t.call(this)}return(e.prototype=Object.create(t.prototype)).filter=function(e,t,r){var i,n,o=r>>1;for(i=t|=0,n=o+1;n--;i+=2)e[i]-=e[i-1]+e[i+1]+2>>2;for(i=t+1,n=o;n--;i+=2)e[i]+=e[i-1]+e[i+1]>>1},e}();return e}();exports.JpxImage=JpxImage;