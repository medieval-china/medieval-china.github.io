"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var i=r.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=exports.Linearization=exports.Lexer=void 0;var _stream=require("./stream.js"),_util=require("../shared/util.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_ccitt_stream=require("./ccitt_stream.js"),_jbig2_stream=require("./jbig2_stream.js"),_jpeg_stream=require("./jpeg_stream.js"),_jpx_stream=require("./jpx_stream.js"),MAX_LENGTH_TO_CACHE=1e3,MAX_ADLER32_LENGTH=5552;function computeAdler32(e){for(var t=e.length,r=1,i=0,a=0;a<t;++a)i+=r+=255&e[a];return i%65521<<16|r%65521}var Parser=function(){function o(e){var t=e.lexer,r=e.xref,i=e.allowStreams,a=void 0!==i&&i,n=e.recoveryMode,s=void 0!==n&&n;_classCallCheck(this,o),this.lexer=t,this.xref=r,this.allowStreams=a,this.recoveryMode=s,this.imageCache=Object.create(null),this.refill()}return _createClass(o,[{key:"refill",value:function(){this.buf1=this.lexer.getObj(),this.buf2=this.lexer.getObj()}},{key:"shift",value:function(){this.buf2 instanceof _primitives.Cmd&&"ID"===this.buf2.cmd?(this.buf1=this.buf2,this.buf2=null):(this.buf1=this.buf2,this.buf2=this.lexer.getObj())}},{key:"tryShift",value:function(){try{return this.shift(),!0}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;return!1}}},{key:"getObj",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=this.buf1;if(this.shift(),t instanceof _primitives.Cmd)switch(t.cmd){case"BI":return this.makeInlineImage(e);case"[":for(var r=[];!(0,_primitives.isCmd)(this.buf1,"]")&&!(0,_primitives.isEOF)(this.buf1);)r.push(this.getObj(e));if((0,_primitives.isEOF)(this.buf1)){if(!this.recoveryMode)throw new _util.FormatError("End of file inside array");return r}return this.shift(),r;case"<<":for(var i=new _primitives.Dict(this.xref);!(0,_primitives.isCmd)(this.buf1,">>")&&!(0,_primitives.isEOF)(this.buf1);)if((0,_primitives.isName)(this.buf1)){var a=this.buf1.name;if(this.shift(),(0,_primitives.isEOF)(this.buf1))break;i.set(a,this.getObj(e))}else(0,_util.info)("Malformed dictionary: key must be a name object"),this.shift();if((0,_primitives.isEOF)(this.buf1)){if(!this.recoveryMode)throw new _util.FormatError("End of file inside dictionary");return i}return(0,_primitives.isCmd)(this.buf2,"stream")?this.allowStreams?this.makeStream(i,e):i:(this.shift(),i);default:return t}if(Number.isInteger(t)){if(Number.isInteger(this.buf1)&&(0,_primitives.isCmd)(this.buf2,"R")){var n=_primitives.Ref.get(t,this.buf1);return this.shift(),this.shift(),n}return t}return"string"==typeof t&&e?e.decryptString(t):t}},{key:"findDefaultInlineStreamEnd",value:function(e){for(var t,r,i=this.lexer,a=e.pos,n=0;-1!==(t=e.getByte());)if(0===n)n=69===t?1:0;else if(1===n)n=73===t?2:0;else if((0,_util.assert)(2===n,"findDefaultInlineStreamEnd - invalid state."),32===t||10===t||13===t){r=e.pos;for(var s=e.peekBytes(10),o=0,h=s.length;o<h;o++)if((0!==(t=s[o])||0===s[o+1])&&10!==t&&13!==t&&(t<32||127<t)){n=0;break}if(2!==n)continue;if(i.knownCommands){var c=i.peekObj();c instanceof _primitives.Cmd&&!i.knownCommands[c.cmd]&&(n=0)}else(0,_util.warn)("findDefaultInlineStreamEnd - `lexer.knownCommands` is undefined.");if(2===n)break}else n=0;-1===t&&((0,_util.warn)("findDefaultInlineStreamEnd: Reached the end of the stream without finding a valid EI marker"),r&&((0,_util.warn)('... trying to recover by using the last "EI" occurrence.'),e.skip(-(e.pos-r))));var u=4;return e.skip(-u),t=e.peekByte(),e.skip(u),(0,_core_utils.isWhiteSpace)(t)||u--,e.pos-u-a}},{key:"findDCTDecodeInlineStreamEnd",value:function(e){for(var t,r,i=e.pos,a=!1;-1!==(t=e.getByte());)if(255===t){switch(e.getByte()){case 0:break;case 255:e.skip(-1);break;case 217:a=!0;break;case 192:case 193:case 194:case 195:case 197:case 198:case 199:case 201:case 202:case 203:case 205:case 206:case 207:case 196:case 204:case 218:case 219:case 220:case 221:case 222:case 223:case 224:case 225:case 226:case 227:case 228:case 229:case 230:case 231:case 232:case 233:case 234:case 235:case 236:case 237:case 238:case 239:case 254:2<(r=e.getUint16())?e.skip(r-2):e.skip(-2)}if(a)break}var n=e.pos-i;return-1===t?((0,_util.warn)("Inline DCTDecode image stream: EOI marker not found, searching for /EI/ instead."),e.skip(-n),this.findDefaultInlineStreamEnd(e)):(this.inlineStreamSkipEI(e),n)}},{key:"findASCII85DecodeInlineStreamEnd",value:function(e){for(var t,r=e.pos;-1!==(t=e.getByte());)if(126===t){var i=e.pos;for(t=e.peekByte();(0,_core_utils.isWhiteSpace)(t);)e.skip(),t=e.peekByte();if(62===t){e.skip();break}if(e.pos>i){var a=e.peekBytes(2);if(69===a[0]&&73===a[1])break}}var n=e.pos-r;return-1===t?((0,_util.warn)("Inline ASCII85Decode image stream: EOD marker not found, searching for /EI/ instead."),e.skip(-n),this.findDefaultInlineStreamEnd(e)):(this.inlineStreamSkipEI(e),n)}},{key:"findASCIIHexDecodeInlineStreamEnd",value:function(e){for(var t,r=e.pos;-1!==(t=e.getByte())&&62!==t;);var i=e.pos-r;return-1===t?((0,_util.warn)("Inline ASCIIHexDecode image stream: EOD marker not found, searching for /EI/ instead."),e.skip(-i),this.findDefaultInlineStreamEnd(e)):(this.inlineStreamSkipEI(e),i)}},{key:"inlineStreamSkipEI",value:function(e){for(var t,r=0;-1!==(t=e.getByte());)if(0===r)r=69===t?1:0;else if(1===r)r=73===t?2:0;else if(2===r)break}},{key:"makeInlineImage",value:function(e){for(var t,r=this.lexer,i=r.stream,a=new _primitives.Dict(this.xref);!(0,_primitives.isCmd)(this.buf1,"ID")&&!(0,_primitives.isEOF)(this.buf1);){if(!(0,_primitives.isName)(this.buf1))throw new _util.FormatError("Dictionary key must be a name object");var n=this.buf1.name;if(this.shift(),(0,_primitives.isEOF)(this.buf1))break;a.set(n,this.getObj(e))}-1!==r.beginInlineImagePos&&(t=i.pos-r.beginInlineImagePos);var s,o=a.get("Filter","F");if((0,_primitives.isName)(o))s=o.name;else if(Array.isArray(o)){var h=this.xref.fetchIfRef(o[0]);(0,_primitives.isName)(h)&&(s=h.name)}var c,u=i.pos;c="DCTDecode"===s||"DCT"===s?this.findDCTDecodeInlineStreamEnd(i):"ASCII85Decode"===s||"A85"===s?this.findASCII85DecodeInlineStreamEnd(i):"ASCIIHexDecode"===s||"AHx"===s?this.findASCIIHexDecodeInlineStreamEnd(i):this.findDefaultInlineStreamEnd(i);var f,l=i.makeSubStream(u,c,a);if(c<MAX_LENGTH_TO_CACHE&&t<MAX_ADLER32_LENGTH){var m=l.getBytes();l.reset();var d=i.pos;i.pos=r.beginInlineImagePos;var p=i.getBytes(t);i.pos=d,f=computeAdler32(m)+"_"+computeAdler32(p);var g=this.imageCache[f];if(void 0!==g)return this.buf2=_primitives.Cmd.get("EI"),this.shift(),g.reset(),g}return e&&(l=e.createStream(l,c)),(l=this.filter(l,a,c)).dict=a,void 0!==f&&(l.cacheKey="inline_".concat(c,"_").concat(f),this.imageCache[f]=l),this.buf2=_primitives.Cmd.get("EI"),this.shift(),l}},{key:"_findStreamLength",value:function(e,t){var r=this.lexer.stream;r.pos=e;for(var i=t.length;r.pos<r.end;){var a=r.peekBytes(2048),n=a.length-i;if(n<=0)break;for(var s=0;s<n;){for(var o=0;o<i&&a[s+o]===t[o];)o++;if(i<=o)return r.pos+=s,r.pos-e;s++}r.pos+=n}return-1}},{key:"makeStream",value:function(e,t){var r=this.lexer,i=r.stream;r.skipToNextLine();var a=i.pos-1,n=e.get("Length");if(Number.isInteger(n)||((0,_util.info)('Bad length "'.concat(n,'" in stream')),n=0),i.pos=a+n,r.nextChar(),this.tryShift()&&(0,_primitives.isCmd)(this.buf2,"endstream"))this.shift();else{var s=new Uint8Array([101,110,100,115,116,114,101,97,109]),o=this._findStreamLength(a,s);if(o<0){for(var h=1;h<=1;h++){var c=s.length-h,u=s.slice(0,c),f=this._findStreamLength(a,u);if(0<=f){var l=i.peekBytes(c+1)[c];if(!(0,_core_utils.isWhiteSpace)(l))break;(0,_util.info)('Found "'.concat((0,_util.bytesToString)(u),'" when ')+"searching for endstream command."),o=f;break}}if(o<0)throw new _util.FormatError("Missing endstream command.")}n=o,r.nextChar(),this.shift(),this.shift()}return this.shift(),i=i.makeSubStream(a,n,e),t&&(i=t.createStream(i,n)),(i=this.filter(i,e,n)).dict=e,i}},{key:"filter",value:function(e,t,r){var i=t.get("Filter","F"),a=t.get("DecodeParms","DP");if((0,_primitives.isName)(i))return Array.isArray(a)&&(0,_util.warn)("/DecodeParms should not contain an Array, when /Filter contains a Name."),this.makeFilter(e,i.name,r,a);var n=r;if(Array.isArray(i))for(var s=i,o=a,h=0,c=s.length;h<c;++h){if(i=this.xref.fetchIfRef(s[h]),!(0,_primitives.isName)(i))throw new _util.FormatError('Bad filter name "'.concat(i,'"'));a=null,Array.isArray(o)&&h in o&&(a=this.xref.fetchIfRef(o[h])),e=this.makeFilter(e,i.name,n,a),n=null}return e}},{key:"makeFilter",value:function(e,t,r,i){if(0===r)return(0,_util.warn)('Empty "'.concat(t,'" stream.')),new _stream.NullStream;try{var a=this.xref.stats.streamTypes;if("FlateDecode"===t||"Fl"===t)return a[_util.StreamType.FLATE]=!0,i?new _stream.PredictorStream(new _stream.FlateStream(e,r),r,i):new _stream.FlateStream(e,r);if("LZWDecode"!==t&&"LZW"!==t)return"DCTDecode"===t||"DCT"===t?(a[_util.StreamType.DCT]=!0,new _jpeg_stream.JpegStream(e,r,e.dict,i)):"JPXDecode"===t||"JPX"===t?(a[_util.StreamType.JPX]=!0,new _jpx_stream.JpxStream(e,r,e.dict,i)):"ASCII85Decode"===t||"A85"===t?(a[_util.StreamType.A85]=!0,new _stream.Ascii85Stream(e,r)):"ASCIIHexDecode"===t||"AHx"===t?(a[_util.StreamType.AHX]=!0,new _stream.AsciiHexStream(e,r)):"CCITTFaxDecode"===t||"CCF"===t?(a[_util.StreamType.CCF]=!0,new _ccitt_stream.CCITTFaxStream(e,r,i)):"RunLengthDecode"===t||"RL"===t?(a[_util.StreamType.RLX]=!0,new _stream.RunLengthStream(e,r)):"JBIG2Decode"===t?(a[_util.StreamType.JBIG]=!0,new _jbig2_stream.Jbig2Stream(e,r,e.dict,i)):((0,_util.warn)('Filter "'.concat(t,'" is not supported.')),e);a[_util.StreamType.LZW]=!0;var n=1;return i?(i.has("EarlyChange")&&(n=i.get("EarlyChange")),new _stream.PredictorStream(new _stream.LZWStream(e,r,n),r,i)):new _stream.LZWStream(e,r,n)}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;return(0,_util.warn)('Invalid stream: "'.concat(e,'"')),new _stream.NullStream}}}]),o}();exports.Parser=Parser;var specialChars=[1,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,2,0,0,2,2,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];function toHexDigit(e){return 48<=e&&e<=57?15&e:65<=e&&e<=70||97<=e&&e<=102?9+(15&e):-1}var Lexer=function(){function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,r),this.stream=e,this.nextChar(),this.strBuf=[],this.knownCommands=t,this._hexStringNumWarn=0,this.beginInlineImagePos=-1}return _createClass(r,[{key:"nextChar",value:function(){return this.currentChar=this.stream.getByte()}},{key:"peekChar",value:function(){return this.stream.peekByte()}},{key:"getNumber",value:function(){var e=this.currentChar,t=!1,r=0,i=0;if(45===e?(i=-1,45===(e=this.nextChar())&&(e=this.nextChar())):43===e&&(i=1,e=this.nextChar()),10===e||13===e)for(;10===(e=this.nextChar())||13===e;);if(46===e&&(r=10,e=this.nextChar()),e<48||57<e){if(10===r&&0===i&&((0,_core_utils.isWhiteSpace)(e)||-1===e))return(0,_util.warn)("Lexer.getNumber - treating a single decimal point as zero."),0;throw new _util.FormatError("Invalid number: ".concat(String.fromCharCode(e)," (charCode ").concat(e,")"))}i=i||1;for(var a=e-48,n=0,s=1;0<=(e=this.nextChar());)if(48<=e&&e<=57){var o=e-48;t?n=10*n+o:(0!==r&&(r*=10),a=10*a+o)}else if(46===e){if(0!==r)break;r=1}else if(45===e)(0,_util.warn)("Badly formatted number: minus sign in the middle");else{if(69!==e&&101!==e)break;if(43===(e=this.peekChar())||45===e)s=45===e?-1:1,this.nextChar();else if(e<48||57<e)break;t=!0}return 0!==r&&(a/=r),t&&(a*=Math.pow(10,s*n)),i*a}},{key:"getString",value:function(){var e=1,t=!1,r=this.strBuf;r.length=0;for(var i=this.nextChar();;){var a=!1;switch(0|i){case-1:(0,_util.warn)("Unterminated string"),t=!0;break;case 40:++e,r.push("(");break;case 41:0==--e?(this.nextChar(),t=!0):r.push(")");break;case 92:switch(i=this.nextChar()){case-1:(0,_util.warn)("Unterminated string"),t=!0;break;case 110:r.push("\n");break;case 114:r.push("\r");break;case 116:r.push("\t");break;case 98:r.push("\b");break;case 102:r.push("\f");break;case 92:case 40:case 41:r.push(String.fromCharCode(i));break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:var n=15&i;a=!0,48<=(i=this.nextChar())&&i<=55&&(n=(n<<3)+(15&i),48<=(i=this.nextChar())&&i<=55&&(a=!1,n=(n<<3)+(15&i))),r.push(String.fromCharCode(n));break;case 13:10===this.peekChar()&&this.nextChar();break;case 10:break;default:r.push(String.fromCharCode(i))}break;default:r.push(String.fromCharCode(i))}if(t)break;a||(i=this.nextChar())}return r.join("")}},{key:"getName",value:function(){var e,t,r=this.strBuf;for(r.length=0;0<=(e=this.nextChar())&&!specialChars[e];)if(35===e){if(e=this.nextChar(),specialChars[e]){(0,_util.warn)("Lexer_getName: NUMBER SIGN (#) should be followed by a hexadecimal number."),r.push("#");break}var i=toHexDigit(e);if(-1!==i){t=e;var a=toHexDigit(e=this.nextChar());if(-1===a){if((0,_util.warn)("Lexer_getName: Illegal digit (".concat(String.fromCharCode(e),") ")+"in hexadecimal number."),r.push("#",String.fromCharCode(t)),specialChars[e])break;r.push(String.fromCharCode(e));continue}r.push(String.fromCharCode(i<<4|a))}else r.push("#",String.fromCharCode(e))}else r.push(String.fromCharCode(e));return 127<r.length&&(0,_util.warn)("Name token is longer than allowed by the spec: ".concat(r.length)),_primitives.Name.get(r.join(""))}},{key:"_hexStringWarn",value:function(e){5!=this._hexStringNumWarn++?5<this._hexStringNumWarn||(0,_util.warn)("getHexString - ignoring invalid character: ".concat(e)):(0,_util.warn)("getHexString - ignoring additional invalid characters.")}},{key:"getHexString",value:function(){var e=this.strBuf;e.length=0;var t,r,i=this.currentChar,a=!0;for(this._hexStringNumWarn=0;;){if(i<0){(0,_util.warn)("Unterminated hex string");break}if(62===i){this.nextChar();break}if(1!==specialChars[i]){if(a){if(-1===(t=toHexDigit(i))){this._hexStringWarn(i),i=this.nextChar();continue}}else{if(-1===(r=toHexDigit(i))){this._hexStringWarn(i),i=this.nextChar();continue}e.push(String.fromCharCode(t<<4|r))}a=!a,i=this.nextChar()}else i=this.nextChar()}return e.join("")}},{key:"getObj",value:function(){for(var e=!1,t=this.currentChar;;){if(t<0)return _primitives.EOF;if(e)10!==t&&13!==t||(e=!1);else if(37===t)e=!0;else if(1!==specialChars[t])break;t=this.nextChar()}switch(0|t){case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 43:case 45:case 46:return this.getNumber();case 40:return this.getString();case 47:return this.getName();case 91:return this.nextChar(),_primitives.Cmd.get("[");case 93:return this.nextChar(),_primitives.Cmd.get("]");case 60:return 60===(t=this.nextChar())?(this.nextChar(),_primitives.Cmd.get("<<")):this.getHexString();case 62:return 62===(t=this.nextChar())?(this.nextChar(),_primitives.Cmd.get(">>")):_primitives.Cmd.get(">");case 123:return this.nextChar(),_primitives.Cmd.get("{");case 125:return this.nextChar(),_primitives.Cmd.get("}");case 41:throw this.nextChar(),new _util.FormatError("Illegal character: ".concat(t))}for(var r=String.fromCharCode(t),i=this.knownCommands,a=i&&void 0!==i[r];0<=(t=this.nextChar())&&!specialChars[t];){var n=r+String.fromCharCode(t);if(a&&void 0===i[n])break;if(128===r.length)throw new _util.FormatError("Command token too long: ".concat(r.length));r=n,a=i&&void 0!==i[r]}return"true"===r||"false"!==r&&("null"===r?null:("BI"===r&&(this.beginInlineImagePos=this.stream.pos),_primitives.Cmd.get(r)))}},{key:"peekObj",value:function(){var e,t=this.stream.pos,r=this.currentChar,i=this.beginInlineImagePos;try{e=this.getObj()}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.warn)("peekObj: ".concat(e))}return this.stream.pos=t,this.currentChar=r,this.beginInlineImagePos=i,e}},{key:"skipToNextLine",value:function(){for(var e=this.currentChar;0<=e;){if(13===e){10===(e=this.nextChar())&&this.nextChar();break}if(10===e){this.nextChar();break}e=this.nextChar()}}}]),r}();exports.Lexer=Lexer;var Linearization=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"create",value:function(e){function t(e,t){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=e.get(t);if(Number.isInteger(i)&&(r?0<=i:0<i))return i;throw new Error('The "'.concat(t,'" parameter in the linearization ')+"dictionary is invalid.")}var r,i,a=new Parser({lexer:new Lexer(e),xref:null}),n=a.getObj(),s=a.getObj(),o=a.getObj(),h=a.getObj();if(!(Number.isInteger(n)&&Number.isInteger(s)&&(0,_primitives.isCmd)(o,"obj")&&(0,_primitives.isDict)(h)&&(0,_util.isNum)(r=h.get("Linearized"))&&0<r))return null;if((i=t(h,"L"))!==e.length)throw new Error('The "L" parameter in the linearization dictionary does not equal the stream length.');return{length:i,hints:function(e){var t,r=e.get("H");if(!Array.isArray(r)||2!==(t=r.length)&&4!==t)throw new Error("Hint array in the linearization dictionary is invalid.");for(var i=0;i<t;i++){var a=r[i];if(!(Number.isInteger(a)&&0<a))throw new Error("Hint (".concat(i,") in the linearization dictionary is invalid."))}return r}(h),objectNumberFirst:t(h,"O"),endFirst:t(h,"E"),numPages:t(h,"N"),mainXRefEntriesOffset:t(h,"T"),pageFirst:h.has("P")?t(h,"P",!0):0}}}]),e}();exports.Linearization=Linearization;