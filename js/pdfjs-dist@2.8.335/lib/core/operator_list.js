"use strict";function _createForOfIteratorHelper(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var a=0,i=function(){};return{s:i,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,s=!0,u=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return s=t.done,t},e:function(t){u=!0,n=t},f:function(){try{s||null==e.return||e.return()}finally{if(u)throw n}}}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,a=new Array(r);e<r;e++)a[e]=t[e];return a}Object.defineProperty(exports,"__esModule",{value:!0}),exports.OperatorList=void 0;var _util=require("../shared/util.js"),QueueOptimizer=function(){function t(t,r,e,a,i){for(var n=t,s=0,u=r.length-1;s<u;s++){var o=r[s];n=n[o]||(n[o]=[])}n[r[r.length-1]]={checkFn:e,iterateFn:a,processFn:i}}var s=[];function r(t){this.queue=t,this.state=null,this.context={iCurr:0,fnArray:t.fnArray,argsArray:t.argsArray},this.match=null,this.lastProcessed=0}return t(s,[_util.OPS.save,_util.OPS.transform,_util.OPS.paintInlineImageXObject,_util.OPS.restore],null,function(t,r){var e=t.fnArray,a=(r-(t.iCurr-3))%4;switch(a){case 0:return e[r]===_util.OPS.save;case 1:return e[r]===_util.OPS.transform;case 2:return e[r]===_util.OPS.paintInlineImageXObject;case 3:return e[r]===_util.OPS.restore}throw new Error("iterateInlineImageGroup - invalid pos: ".concat(a))},function(t,r){var e=t.fnArray,a=t.argsArray,i=t.iCurr,n=i-3,s=i-2,u=i-1,o=Math.min(Math.floor((r-n)/4),200);if(o<10)return r-(r-n)%4;for(var h=0,l=[],c=0,f=1,p=1,d=0;d<o;d++){var g=a[s+(d<<2)],y=a[u+(d<<2)][0];1e3<f+y.width&&(h=Math.max(h,f),p+=c+2,c=f=0),l.push({transform:g,x:f,y:p,w:y.width,h:y.height}),f+=y.width+2,c=Math.max(c,y.height)}for(var O=Math.max(h,f)+1,v=p+c+1,_=new Uint8ClampedArray(O*v*4),m=O<<2,A=0;A<o;A++){var S=a[u+(A<<2)][0].data,P=l[A].w<<2,w=0,b=l[A].x+l[A].y*O<<2;_.set(S.subarray(0,P),b-m);for(var I=0,x=l[A].h;I<x;I++)_.set(S.subarray(w,w+P),b),w+=P,b+=m;for(_.set(S.subarray(w-P,w),b);0<=b;)S[b-4]=S[b],S[b-3]=S[b+1],S[b-2]=S[b+2],S[b-1]=S[b+3],S[b+P]=S[b+P-4],S[b+P+1]=S[b+P-3],S[b+P+2]=S[b+P-2],S[b+P+3]=S[b+P-1],b-=m}return e.splice(n,4*o,_util.OPS.paintInlineImageXObjectGroup),a.splice(n,4*o,[{width:O,height:v,kind:_util.ImageKind.RGBA_32BPP,data:_},l]),n+1}),t(s,[_util.OPS.save,_util.OPS.transform,_util.OPS.paintImageMaskXObject,_util.OPS.restore],null,function(t,r){var e=t.fnArray,a=(r-(t.iCurr-3))%4;switch(a){case 0:return e[r]===_util.OPS.save;case 1:return e[r]===_util.OPS.transform;case 2:return e[r]===_util.OPS.paintImageMaskXObject;case 3:return e[r]===_util.OPS.restore}throw new Error("iterateImageMaskGroup - invalid pos: ".concat(a))},function(t,r){var e=t.fnArray,a=t.argsArray,i=t.iCurr,n=i-3,s=i-2,u=i-1,o=Math.floor((r-n)/4);if((o=function(t,r,e,a){var i,n=t+2;for(i=0;i<r;i++){var s=a[n+4*i],u=1===s.length&&s[0];if(!u||1!==u.width||1!==u.height||u.data.length&&(1!==u.data.length||0!==u.data[0]))break;e[n+4*i]=_util.OPS.paintSolidColorImageMask}return r-i}(n,o,e,a))<10)return r-(r-n)%4;var h,l,c=!1,f=a[u][0],p=a[s][0],d=a[s][1],g=a[s][2],y=a[s][3];if(d===g){c=!0,h=s+4;for(var O=u+4,v=1;v<o;v++,h+=4,O+=4)if(l=a[h],a[O][0]!==f||l[0]!==p||l[1]!==d||l[2]!==g||l[3]!==y){v<10?c=!1:o=v;break}}if(c){o=Math.min(o,1e3);var _=new Float32Array(2*o);h=s;for(var m=0;m<o;m++,h+=4)l=a[h],_[m<<1]=l[4],_[1+(m<<1)]=l[5];e.splice(n,4*o,_util.OPS.paintImageMaskXObjectRepeat),a.splice(n,4*o,[f,p,d,g,y,_])}else{o=Math.min(o,100);for(var A=[],S=0;S<o;S++){l=a[s+(S<<2)];var P=a[u+(S<<2)][0];A.push({data:P.data,width:P.width,height:P.height,transform:l})}e.splice(n,4*o,_util.OPS.paintImageMaskXObjectGroup),a.splice(n,4*o,[A])}return n+1}),t(s,[_util.OPS.save,_util.OPS.transform,_util.OPS.paintImageXObject,_util.OPS.restore],function(t){var r=t.argsArray,e=t.iCurr-2;return 0===r[e][1]&&0===r[e][2]},function(t,r){var e=t.fnArray,a=t.argsArray,i=(r-(t.iCurr-3))%4;switch(i){case 0:return e[r]===_util.OPS.save;case 1:if(e[r]!==_util.OPS.transform)return!1;var n=t.iCurr-2,s=a[n][0],u=a[n][3];return a[r][0]===s&&0===a[r][1]&&0===a[r][2]&&a[r][3]===u;case 2:if(e[r]!==_util.OPS.paintImageXObject)return!1;var o=a[t.iCurr-1][0];return a[r][0]===o;case 3:return e[r]===_util.OPS.restore}throw new Error("iterateImageGroup - invalid pos: ".concat(i))},function(t,r){var e=t.fnArray,a=t.argsArray,i=t.iCurr,n=i-3,s=i-2,u=a[i-1][0],o=a[s][0],h=a[s][3],l=Math.min(Math.floor((r-n)/4),1e3);if(l<3)return r-(r-n)%4;for(var c=new Float32Array(2*l),f=s,p=0;p<l;p++,f+=4){var d=a[f];c[p<<1]=d[4],c[1+(p<<1)]=d[5]}var g=[u,o,h,c];return e.splice(n,4*l,_util.OPS.paintImageXObjectRepeat),a.splice(n,4*l,g),n+1}),t(s,[_util.OPS.beginText,_util.OPS.setFont,_util.OPS.setTextMatrix,_util.OPS.showText,_util.OPS.endText],null,function(t,r){var e=t.fnArray,a=t.argsArray,i=(r-(t.iCurr-4))%5;switch(i){case 0:return e[r]===_util.OPS.beginText;case 1:return e[r]===_util.OPS.setFont;case 2:return e[r]===_util.OPS.setTextMatrix;case 3:if(e[r]!==_util.OPS.showText)return!1;var n=t.iCurr-3,s=a[n][0],u=a[n][1];return a[r][0]===s&&a[r][1]===u;case 4:return e[r]===_util.OPS.endText}throw new Error("iterateShowTextGroup - invalid pos: ".concat(i))},function(t,r){var e=t.fnArray,a=t.argsArray,i=t.iCurr,n=i-4,s=i-3,u=i-2,o=i-1,h=i,l=a[s][0],c=a[s][1],f=Math.min(Math.floor((r-n)/5),1e3);if(f<3)return r-(r-n)%5;var p=n;4<=n&&e[n-4]===e[s]&&e[n-3]===e[u]&&e[n-2]===e[o]&&e[n-1]===e[h]&&a[n-4][0]===l&&a[n-4][1]===c&&(f++,p-=5);for(var d=p+4,g=1;g<f;g++)e.splice(d,3),a.splice(d,3),d+=2;return d+1}),r.prototype={_optimize:function(){var t=this.queue.fnArray,r=this.lastProcessed,e=t.length,a=this.state,i=this.match;if(a||i||r+1!==e||s[t[r]]){for(var n=this.context;r<e;){if(i){if((0,i.iterateFn)(n,r)){r++;continue}if(r=(0,i.processFn)(n,r+1),a=i=null,(e=t.length)<=r)break}(a=(a||s)[t[r]])&&!Array.isArray(a)?(n.iCurr=r,r++,a=((!a.checkFn||(0,a.checkFn)(n))&&(i=a),null)):r++}this.state=a,this.match=i,this.lastProcessed=r}else this.lastProcessed=e},push:function(t,r){this.queue.fnArray.push(t),this.queue.argsArray.push(r),this._optimize()},flush:function(){for(;this.match;){var t=this.queue.fnArray.length;this.lastProcessed=(0,this.match.processFn)(this.context,t),this.match=null,this.state=null,this._optimize()}},reset:function(){this.state=null,this.match=null,this.lastProcessed=0}},r}(),NullOptimizer=function(){function t(t){this.queue=t}return t.prototype={push:function(t,r){this.queue.fnArray.push(t),this.queue.argsArray.push(r)},flush:function(){},reset:function(){}},t}(),OperatorList=function(){function s(t,r){this._streamSink=r,this.fnArray=[],this.argsArray=[],this.optimizer=r&&"oplist"!==t?new QueueOptimizer(this):new NullOptimizer(this),this.dependencies=new Set,this._totalLength=0,this.weight=0,this._resolved=r?null:Promise.resolve()}return s.prototype={get length(){return this.argsArray.length},get ready(){return this._resolved||this._streamSink.ready},get totalLength(){return this._totalLength+this.length},addOp:function(t,r){this.optimizer.push(t,r),this.weight++,this._streamSink&&(1e3<=this.weight?this.flush():995<=this.weight&&(t===_util.OPS.restore||t===_util.OPS.endText)&&this.flush())},addDependency:function(t){this.dependencies.has(t)||(this.dependencies.add(t),this.addOp(_util.OPS.dependency,[t]))},addDependencies:function(t){var r,e=_createForOfIteratorHelper(t);try{for(e.s();!(r=e.n()).done;){var a=r.value;this.addDependency(a)}}catch(t){e.e(t)}finally{e.f()}},addOpList:function(t){if(t instanceof s){var r,e=_createForOfIteratorHelper(t.dependencies);try{for(e.s();!(r=e.n()).done;){var a=r.value;this.dependencies.add(a)}}catch(t){e.e(t)}finally{e.f()}for(var i=0,n=t.length;i<n;i++)this.addOp(t.fnArray[i],t.argsArray[i])}else(0,_util.warn)('addOpList - ignoring invalid "opList" parameter.')},getIR:function(){return{fnArray:this.fnArray,argsArray:this.argsArray,length:this.length}},get _transfers(){for(var t=[],r=this.fnArray,e=this.argsArray,a=this.length,i=0;i<a;i++)switch(r[i]){case _util.OPS.paintInlineImageXObject:case _util.OPS.paintInlineImageXObjectGroup:case _util.OPS.paintImageMaskXObject:var n=e[i][0];n.cached||t.push(n.data.buffer)}return t},flush:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.optimizer.flush();var r=this.length;this._totalLength+=r,this._streamSink.enqueue({fnArray:this.fnArray,argsArray:this.argsArray,lastChunk:t,length:r},1,this._transfers),this.dependencies.clear(),this.fnArray.length=0,this.argsArray.length=0,this.weight=0,this.optimizer.reset()}},s}();exports.OperatorList=OperatorList;