"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(n);if(i){var r=_getPrototypeOf(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.CFFTopDict=exports.CFFStrings=exports.CFFStandardStrings=exports.CFFPrivateDict=exports.CFFParser=exports.CFFIndex=exports.CFFHeader=exports.CFFFDSelect=exports.CFFCompiler=exports.CFFCharset=exports.CFF=void 0;var _util=require("../shared/util.js"),_charsets=require("./charsets.js"),_encodings=require("./encodings.js"),MAX_SUBR_NESTING=10,CFFStandardStrings=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"];exports.CFFStandardStrings=CFFStandardStrings;var NUM_STANDARD_CFF_STRINGS=391,CFFParser=function(){var m=[null,{id:"hstem",min:2,stackClearing:!0,stem:!0},null,{id:"vstem",min:2,stackClearing:!0,stem:!0},{id:"vmoveto",min:1,stackClearing:!0},{id:"rlineto",min:2,resetStack:!0},{id:"hlineto",min:1,resetStack:!0},{id:"vlineto",min:1,resetStack:!0},{id:"rrcurveto",min:6,resetStack:!0},null,{id:"callsubr",min:1,undefStack:!0},{id:"return",min:0,undefStack:!0},null,null,{id:"endchar",min:0,stackClearing:!0},null,null,null,{id:"hstemhm",min:2,stackClearing:!0,stem:!0},{id:"hintmask",min:0,stackClearing:!0},{id:"cntrmask",min:0,stackClearing:!0},{id:"rmoveto",min:2,stackClearing:!0},{id:"hmoveto",min:1,stackClearing:!0},{id:"vstemhm",min:2,stackClearing:!0,stem:!0},{id:"rcurveline",min:8,resetStack:!0},{id:"rlinecurve",min:8,resetStack:!0},{id:"vvcurveto",min:4,resetStack:!0},{id:"hhcurveto",min:4,resetStack:!0},null,{id:"callgsubr",min:1,undefStack:!0},{id:"vhcurveto",min:4,resetStack:!0},{id:"hvcurveto",min:4,resetStack:!0}],p=[null,null,null,{id:"and",min:2,stackDelta:-1},{id:"or",min:2,stackDelta:-1},{id:"not",min:1,stackDelta:0},null,null,null,{id:"abs",min:1,stackDelta:0},{id:"add",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]+e[t-1]}},{id:"sub",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]-e[t-1]}},{id:"div",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]/e[t-1]}},null,{id:"neg",min:1,stackDelta:0,stackFn:function(e,t){e[t-1]=-e[t-1]}},{id:"eq",min:2,stackDelta:-1},null,null,{id:"drop",min:1,stackDelta:-1},null,{id:"put",min:2,stackDelta:-2},{id:"get",min:1,stackDelta:0},{id:"ifelse",min:4,stackDelta:-3},{id:"random",min:0,stackDelta:1},{id:"mul",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]*e[t-1]}},null,{id:"sqrt",min:1,stackDelta:0},{id:"dup",min:1,stackDelta:1},{id:"exch",min:2,stackDelta:0},{id:"index",min:2,stackDelta:0},{id:"roll",min:3,stackDelta:-2},null,null,null,{id:"hflex",min:7,resetStack:!0},{id:"flex",min:13,resetStack:!0},{id:"hflex1",min:9,resetStack:!0},{id:"flex1",min:11,resetStack:!0}];return function(){function n(e,t,r){_classCallCheck(this,n),this.bytes=e.getBytes(),this.properties=t,this.seacAnalysisEnabled=!!r}return _createClass(n,[{key:"parse",value:function(){var e=this.properties,t=new CFF;this.cff=t;var r=this.parseHeader(),n=this.parseIndex(r.endPos),i=this.parseIndex(n.endPos),a=this.parseIndex(i.endPos),s=this.parseIndex(a.endPos),l=this.parseDict(i.obj.get(0)),o=this.createDict(CFFTopDict,l,t.strings);t.header=r.obj,t.names=this.parseNameIndex(n.obj),t.strings=this.parseStringIndex(a.obj),t.topDict=o,t.globalSubrIndex=s.obj,this.parsePrivateDict(t.topDict),t.isCIDFont=o.hasName("ROS");var c=o.getByName("CharStrings"),u=this.parseIndex(c).obj,h=o.getByName("FontMatrix");h&&(e.fontMatrix=h);var d,f,m=o.getByName("FontBBox");if(m&&(e.ascent=Math.max(m[3],m[1]),e.descent=Math.min(m[1],m[3]),e.ascentScaled=!0),t.isCIDFont){for(var p=this.parseIndex(o.getByName("FDArray")).obj,g=0,v=p.count;g<v;++g){var y=p.get(g),F=this.createDict(CFFTopDict,this.parseDict(y),t.strings);this.parsePrivateDict(F),t.fdArray.push(F)}f=null,d=this.parseCharsets(o.getByName("charset"),u.count,t.strings,!0),t.fdSelect=this.parseFDSelect(o.getByName("FDSelect"),u.count)}else d=this.parseCharsets(o.getByName("charset"),u.count,t.strings,!1),f=this.parseEncoding(o.getByName("Encoding"),e,t.strings,d.charset);t.charset=d,t.encoding=f;var C=this.parseCharStrings({charStrings:u,localSubrIndex:o.privateDict.subrsIndex,globalSubrIndex:s.obj,fdSelect:t.fdSelect,fdArray:t.fdArray,privateDict:o.privateDict});return t.charStrings=C.charStrings,t.seacs=C.seacs,t.widths=C.widths,t}},{key:"parseHeader",value:function(){for(var e=this.bytes,t=e.length,r=0;r<t&&1!==e[r];)++r;if(t<=r)throw new _util.FormatError("Invalid CFF header");0!==r&&((0,_util.info)("cff data is shifted"),e=e.subarray(r),this.bytes=e);var n=e[0],i=e[1],a=e[2],s=e[3];return{obj:new CFFHeader(n,i,a,s),endPos:a}}},{key:"parseDict",value:function(s){var l=0;function e(){var e=s[l++];return 30===e?function(){var e="",t=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"],r=s.length;for(;l<r;){var n=s[l++],i=n>>4,a=15&n;if(15===i)break;if(e+=t[i],15===a)break;e+=t[a]}return parseFloat(e)}():28===e?e=((e=s[l++])<<24|s[l++]<<16)>>16:29===e?e=(e=(e=(e=s[l++])<<8|s[l++])<<8|s[l++])<<8|s[l++]:32<=e&&e<=246?e-139:247<=e&&e<=250?256*(e-247)+s[l++]+108:251<=e&&e<=254?-256*(e-251)-s[l++]-108:((0,_util.warn)('CFFParser_parseDict: "'+e+'" is a reserved command.'),NaN)}var t=[],r=[];l=0;for(var n=s.length;l<n;){var i=s[l];i<=21?(12===i&&(i=i<<8|s[++l]),r.push([i,t]),t=[],++l):t.push(e())}return r}},{key:"parseIndex",value:function(e){var t,r,n=new CFFIndex,i=this.bytes,a=i[e++]<<8|i[e++],s=[],l=e;if(0!==a){var o=i[e++],c=e+(a+1)*o-1;for(t=0,r=a+1;t<r;++t){for(var u=0,h=0;h<o;++h)u<<=8,u+=i[e++];s.push(c+u)}l=s[a]}for(t=0,r=s.length-1;t<r;++t){var d=s[t],f=s[t+1];n.add(i.subarray(d,f))}return{obj:n,endPos:l}}},{key:"parseNameIndex",value:function(e){for(var t=[],r=0,n=e.count;r<n;++r){var i=e.get(r);t.push((0,_util.bytesToString)(i))}return t}},{key:"parseStringIndex",value:function(e){for(var t=new CFFStrings,r=0,n=e.count;r<n;++r){var i=e.get(r);t.add((0,_util.bytesToString)(i))}return t}},{key:"createDict",value:function(e,t,r){for(var n=new e(r),i=0,a=t.length;i<a;++i){var s=t[i],l=s[0],o=s[1];n.setByKey(l,o)}return n}},{key:"parseCharString",value:function(e,t,r,n){if(!t||e.callDepth>MAX_SUBR_NESTING)return!1;for(var i=e.stackSize,a=e.stack,s=t.length,l=0;l<s;){var o=t[l++],c=null;if(12===o){var u=t[l++];0===u?(t[l-2]=139,t[l-1]=22,i=0):c=p[u]}else if(28===o)a[i]=(t[l]<<24|t[l+1]<<16)>>16,l+=2,i++;else if(14===o){if(4<=i&&(i-=4,this.seacAnalysisEnabled))return e.seac=a.slice(i,i+4),!1;c=m[o]}else if(32<=o&&o<=246)a[i]=o-139,i++;else if(247<=o&&o<=254)a[i]=o<251?(o-247<<8)+t[l]+108:-(o-251<<8)-t[l]-108,l++,i++;else if(255===o)a[i]=(t[l]<<24|t[l+1]<<16|t[l+2]<<8|t[l+3])/65536,l+=4,i++;else if(19===o||20===o)e.hints+=i>>1,l+=e.hints+7>>3,i%=2,c=m[o];else{if(10===o||29===o){var h=void 0;if(!(h=10===o?r:n))return c=m[o],(0,_util.warn)("Missing subrsIndex for "+c.id),!1;var d=32768;h.count<1240?d=107:h.count<33900&&(d=1131);var f=a[--i]+d;if(f<0||f>=h.count||isNaN(f))return c=m[o],(0,_util.warn)("Out of bounds subrIndex for "+c.id),!1;if(e.stackSize=i,e.callDepth++,!this.parseCharString(e,h.get(f),r,n))return!1;e.callDepth--,i=e.stackSize;continue}if(11===o)return e.stackSize=i,!0;c=m[o]}if(c){if(c.stem&&(e.hints+=i>>1,3===o||23===o?e.hasVStems=!0:!e.hasVStems||1!==o&&18!==o||((0,_util.warn)("CFF stem hints are in wrong order"),t[l-1]=1===o?3:23)),"min"in c&&!e.undefStack&&i<c.min)return(0,_util.warn)("Not enough parameters for "+c.id+"; actual: "+i+", expected: "+c.min),!1;e.firstStackClearing&&c.stackClearing&&(e.firstStackClearing=!1,2<=(i-=c.min)&&c.stem?i%=2:1<i&&(0,_util.warn)("Found too many parameters for stack-clearing command"),0<i&&0<=a[i-1]&&(e.width=a[i-1])),"stackDelta"in c?("stackFn"in c&&c.stackFn(a,i),i+=c.stackDelta):c.stackClearing?i=0:c.resetStack?(i=0,e.undefStack=!1):c.undefStack&&(i=0,e.undefStack=!0,e.firstStackClearing=!1)}}return e.stackSize=i,!0}},{key:"parseCharStrings",value:function(e){for(var t=e.charStrings,r=e.localSubrIndex,n=e.globalSubrIndex,i=e.fdSelect,a=e.fdArray,s=e.privateDict,l=[],o=[],c=t.count,u=0;u<c;u++){var h=t.get(u),d={callDepth:0,stackSize:0,stack:[],undefStack:!0,hints:0,firstStackClearing:!0,seac:null,width:null,hasVStems:!1},f=!0,m=null,p=s;if(i&&a.length){var g=i.getFDIndex(u);-1===g&&((0,_util.warn)("Glyph index is not in fd select."),f=!1),g>=a.length&&((0,_util.warn)("Invalid fd index for glyph index."),f=!1),f&&(m=(p=a[g].privateDict).subrsIndex)}else r&&(m=r);if(f&&(f=this.parseCharString(d,h,m,n)),null!==d.width){var v=p.getByName("nominalWidthX");o[u]=v+d.width}else{var y=p.getByName("defaultWidthX");o[u]=y}null!==d.seac&&(l[u]=d.seac),f||t.set(u,new Uint8Array([14]))}return{charStrings:t,seacs:l,widths:o}}},{key:"emptyPrivateDictionary",value:function(e){var t=this.createDict(CFFPrivateDict,[],e.strings);e.setByKey(18,[0,0]),e.privateDict=t}},{key:"parsePrivateDict",value:function(e){if(e.hasName("Private")){var t=e.getByName("Private");if(Array.isArray(t)&&2===t.length){var r=t[0],n=t[1];if(0===r||n>=this.bytes.length)this.emptyPrivateDictionary(e);else{var i=n+r,a=this.bytes.subarray(n,i),s=this.parseDict(a),l=this.createDict(CFFPrivateDict,s,e.strings);if((e.privateDict=l).getByName("Subrs")){var o=l.getByName("Subrs"),c=n+o;if(0===o||c>=this.bytes.length)this.emptyPrivateDictionary(e);else{var u=this.parseIndex(c);l.subrsIndex=u.obj}}}}else e.removeByName("Private")}else this.emptyPrivateDictionary(e)}},{key:"parseCharsets",value:function(e,t,r,n){if(0===e)return new CFFCharset(!0,CFFCharsetPredefinedTypes.ISO_ADOBE,_charsets.ISOAdobeCharset);if(1===e)return new CFFCharset(!0,CFFCharsetPredefinedTypes.EXPERT,_charsets.ExpertCharset);if(2===e)return new CFFCharset(!0,CFFCharsetPredefinedTypes.EXPERT_SUBSET,_charsets.ExpertSubsetCharset);var i,a,s,l=this.bytes,o=e,c=l[e++],u=[n?0:".notdef"];switch(t-=1,c){case 0:for(s=0;s<t;s++)i=l[e++]<<8|l[e++],u.push(n?i:r.get(i));break;case 1:for(;u.length<=t;)for(i=l[e++]<<8|l[e++],a=l[e++],s=0;s<=a;s++)u.push(n?i++:r.get(i++));break;case 2:for(;u.length<=t;)for(i=l[e++]<<8|l[e++],a=l[e++]<<8|l[e++],s=0;s<=a;s++)u.push(n?i++:r.get(i++));break;default:throw new _util.FormatError("Unknown charset format")}var h=e,d=l.subarray(o,h);return new CFFCharset(!1,c,u,d)}},{key:"parseEncoding",value:function(n,e,i,a){var t,s,r,l=Object.create(null),o=this.bytes,c=!1,u=null;if(0===n||1===n){c=!0;var h=(t=n)?_encodings.ExpertEncoding:_encodings.StandardEncoding;for(s=0,r=a.length;s<r;s++){var d=h.indexOf(a[s]);-1!==d&&(l[d]=s)}}else{var f=n;switch(127&(t=o[n++])){case 0:var m=o[n++];for(s=1;s<=m;s++)l[o[n++]]=s;break;case 1:var p=o[n++],g=1;for(s=0;s<p;s++)for(var v=o[n++],y=o[n++],F=v;F<=v+y;F++)l[F]=g++;break;default:throw new _util.FormatError("Unknown encoding format: ".concat(t," in CFF"))}var C=n;128&t&&(o[f]&=127,function(){var e=o[n++];for(s=0;s<e;s++){var t=o[n++],r=(o[n++]<<8)+(255&o[n++]);l[t]=a.indexOf(i.get(r))}}()),u=o.subarray(f,C)}return new CFFEncoding(c,t&=127,l,u)}},{key:"parseFDSelect",value:function(e,t){var r,n=this.bytes,i=n[e++],a=[];switch(i){case 0:for(r=0;r<t;++r){var s=n[e++];a.push(s)}break;case 3:var l=n[e++]<<8|n[e++];for(r=0;r<l;++r){var o=n[e++]<<8|n[e++];0===r&&0!==o&&((0,_util.warn)("parseFDSelect: The first range must have a first GID of 0 -- trying to recover."),o=0);for(var c=n[e++],u=n[e]<<8|n[e+1],h=o;h<u;++h)a.push(c)}e+=2;break;default:throw new _util.FormatError('parseFDSelect: Unknown format "'.concat(i,'".'))}if(a.length!==t)throw new _util.FormatError("parseFDSelect: Invalid font data.");return new CFFFDSelect(i,a)}}]),n}()}();exports.CFFParser=CFFParser;var CFF=function(){function e(){_classCallCheck(this,e),this.header=null,this.names=[],this.topDict=null,this.strings=new CFFStrings,this.globalSubrIndex=null,this.encoding=null,this.charset=null,this.charStrings=null,this.fdArray=[],this.fdSelect=null,this.isCIDFont=!1}return _createClass(e,[{key:"duplicateFirstGlyph",value:function(){if(65535<=this.charStrings.count)(0,_util.warn)("Not enough space in charstrings to duplicate first glyph.");else{var e=this.charStrings.get(0);this.charStrings.add(e),this.isCIDFont&&this.fdSelect.fdSelect.push(this.fdSelect.fdSelect[0])}}},{key:"hasGlyphId",value:function(e){return!(e<0||e>=this.charStrings.count)&&0<this.charStrings.get(e).length}}]),e}();exports.CFF=CFF;var CFFHeader=_createClass(function e(t,r,n,i){_classCallCheck(this,e),this.major=t,this.minor=r,this.hdrSize=n,this.offSize=i});exports.CFFHeader=CFFHeader;var CFFStrings=function(){function e(){_classCallCheck(this,e),this.strings=[]}return _createClass(e,[{key:"get",value:function(e){return 0<=e&&e<=NUM_STANDARD_CFF_STRINGS-1?CFFStandardStrings[e]:e-NUM_STANDARD_CFF_STRINGS<=this.strings.length?this.strings[e-NUM_STANDARD_CFF_STRINGS]:CFFStandardStrings[0]}},{key:"getSID",value:function(e){var t=CFFStandardStrings.indexOf(e);return-1!==t?t:-1!==(t=this.strings.indexOf(e))?t+NUM_STANDARD_CFF_STRINGS:-1}},{key:"add",value:function(e){this.strings.push(e)}},{key:"count",get:function(){return this.strings.length}}]),e}();exports.CFFStrings=CFFStrings;var CFFIndex=function(){function e(){_classCallCheck(this,e),this.objects=[],this.length=0}return _createClass(e,[{key:"add",value:function(e){this.length+=e.length,this.objects.push(e)}},{key:"set",value:function(e,t){this.length+=t.length-this.objects[e].length,this.objects[e]=t}},{key:"get",value:function(e){return this.objects[e]}},{key:"count",get:function(){return this.objects.length}}]),e}();exports.CFFIndex=CFFIndex;var CFFDict=function(){function r(e,t){_classCallCheck(this,r),this.keyToNameMap=e.keyToNameMap,this.nameToKeyMap=e.nameToKeyMap,this.defaults=e.defaults,this.types=e.types,this.opcodes=e.opcodes,this.order=e.order,this.strings=t,this.values=Object.create(null)}return _createClass(r,[{key:"setByKey",value:function(e,t){if(!(e in this.keyToNameMap))return!1;var r=t.length;if(0===r)return!0;for(var n=0;n<r;n++)if(isNaN(t[n]))return(0,_util.warn)('Invalid CFFDict value: "'+t+'" for key "'+e+'".'),!0;var i=this.types[e];return"num"!==i&&"sid"!==i&&"offset"!==i||(t=t[0]),this.values[e]=t,!0}},{key:"setByName",value:function(e,t){if(!(e in this.nameToKeyMap))throw new _util.FormatError('Invalid dictionary name "'.concat(e,'"'));this.values[this.nameToKeyMap[e]]=t}},{key:"hasName",value:function(e){return this.nameToKeyMap[e]in this.values}},{key:"getByName",value:function(e){if(!(e in this.nameToKeyMap))throw new _util.FormatError("Invalid dictionary name ".concat(e,'"'));var t=this.nameToKeyMap[e];return t in this.values?this.values[t]:this.defaults[t]}},{key:"removeByName",value:function(e){delete this.values[this.nameToKeyMap[e]]}}],[{key:"createTables",value:function(e){for(var t={keyToNameMap:{},nameToKeyMap:{},defaults:{},types:{},opcodes:{},order:[]},r=0,n=e.length;r<n;++r){var i=e[r],a=Array.isArray(i[0])?(i[0][0]<<8)+i[0][1]:i[0];t.keyToNameMap[a]=i[1],t.nameToKeyMap[i[1]]=a,t.types[a]=i[2],t.defaults[a]=i[3],t.opcodes[a]=Array.isArray(i[0])?i[0]:[i[0]],t.order.push(a)}return t}}]),r}(),CFFTopDict=function(){var i=[[[12,30],"ROS",["sid","sid","num"],null],[[12,20],"SyntheticBase","num",null],[0,"version","sid",null],[1,"Notice","sid",null],[[12,0],"Copyright","sid",null],[2,"FullName","sid",null],[3,"FamilyName","sid",null],[4,"Weight","sid",null],[[12,1],"isFixedPitch","num",0],[[12,2],"ItalicAngle","num",0],[[12,3],"UnderlinePosition","num",-100],[[12,4],"UnderlineThickness","num",50],[[12,5],"PaintType","num",0],[[12,6],"CharstringType","num",2],[[12,7],"FontMatrix",["num","num","num","num","num","num"],[.001,0,0,.001,0,0]],[13,"UniqueID","num",null],[5,"FontBBox",["num","num","num","num"],[0,0,0,0]],[[12,8],"StrokeWidth","num",0],[14,"XUID","array",null],[15,"charset","offset",0],[16,"Encoding","offset",0],[17,"CharStrings","offset",0],[18,"Private",["offset","offset"],null],[[12,21],"PostScript","sid",null],[[12,22],"BaseFontName","sid",null],[[12,23],"BaseFontBlend","delta",null],[[12,31],"CIDFontVersion","num",0],[[12,32],"CIDFontRevision","num",0],[[12,33],"CIDFontType","num",0],[[12,34],"CIDCount","num",8720],[[12,35],"UIDBase","num",null],[[12,37],"FDSelect","offset",null],[[12,36],"FDArray","offset",null],[[12,38],"FontName","sid",null]],a=null;return function(e){_inherits(n,CFFDict);var r=_createSuper(n);function n(e){var t;return _classCallCheck(this,n),null===a&&(a=CFFDict.createTables(i)),(t=r.call(this,a,e)).privateDict=null,t}return _createClass(n)}()}();exports.CFFTopDict=CFFTopDict;var CFFPrivateDict=function(){var i=[[6,"BlueValues","delta",null],[7,"OtherBlues","delta",null],[8,"FamilyBlues","delta",null],[9,"FamilyOtherBlues","delta",null],[[12,9],"BlueScale","num",.039625],[[12,10],"BlueShift","num",7],[[12,11],"BlueFuzz","num",1],[10,"StdHW","num",null],[11,"StdVW","num",null],[[12,12],"StemSnapH","delta",null],[[12,13],"StemSnapV","delta",null],[[12,14],"ForceBold","num",0],[[12,17],"LanguageGroup","num",0],[[12,18],"ExpansionFactor","num",.06],[[12,19],"initialRandomSeed","num",0],[20,"defaultWidthX","num",0],[21,"nominalWidthX","num",0],[19,"Subrs","offset",null]],a=null;return function(e){_inherits(n,CFFDict);var r=_createSuper(n);function n(e){var t;return _classCallCheck(this,n),null===a&&(a=CFFDict.createTables(i)),(t=r.call(this,a,e)).subrsIndex=null,t}return _createClass(n)}()}();exports.CFFPrivateDict=CFFPrivateDict;var CFFCharsetPredefinedTypes={ISO_ADOBE:0,EXPERT:1,EXPERT_SUBSET:2},CFFCharset=_createClass(function e(t,r,n,i){_classCallCheck(this,e),this.predefined=t,this.format=r,this.charset=n,this.raw=i});exports.CFFCharset=CFFCharset;var CFFEncoding=_createClass(function e(t,r,n,i){_classCallCheck(this,e),this.predefined=t,this.format=r,this.encoding=n,this.raw=i}),CFFFDSelect=function(){function r(e,t){_classCallCheck(this,r),this.format=e,this.fdSelect=t}return _createClass(r,[{key:"getFDIndex",value:function(e){return e<0||e>=this.fdSelect.length?-1:this.fdSelect[e]}}]),r}();exports.CFFFDSelect=CFFFDSelect;var CFFOffsetTracker=function(){function e(){_classCallCheck(this,e),this.offsets=Object.create(null)}return _createClass(e,[{key:"isTracking",value:function(e){return e in this.offsets}},{key:"track",value:function(e,t){if(e in this.offsets)throw new _util.FormatError("Already tracking location of ".concat(e));this.offsets[e]=t}},{key:"offset",value:function(e){for(var t in this.offsets)this.offsets[t]+=e}},{key:"setEntryLocation",value:function(e,t,r){if(!(e in this.offsets))throw new _util.FormatError("Not tracking location of ".concat(e));for(var n=r.data,i=this.offsets[e],a=0,s=t.length;a<s;++a){var l=5*a+i,o=l+1,c=l+2,u=l+3,h=l+4;if(29!==n[l]||0!==n[o]||0!==n[c]||0!==n[u]||0!==n[h])throw new _util.FormatError("writing to an offset that is not empty");var d=t[a];n[l]=29,n[o]=d>>24&255,n[c]=d>>16&255,n[u]=d>>8&255,n[h]=255&d}}}]),e}(),CFFCompiler=function(){function c(e){_classCallCheck(this,c),this.cff=e}return _createClass(c,[{key:"compile",value:function(){var e=this.cff,t={data:[],length:0,add:function(e){this.data=this.data.concat(e),this.length=this.data.length}},r=this.compileHeader(e.header);t.add(r);var n=this.compileNameIndex(e.names);if(t.add(n),e.isCIDFont&&e.topDict.hasName("FontMatrix")){var i=e.topDict.getByName("FontMatrix");e.topDict.removeByName("FontMatrix");for(var a=0,s=e.fdArray.length;a<s;a++){var l=e.fdArray[a],o=i.slice(0);l.hasName("FontMatrix")&&(o=_util.Util.transform(o,l.getByName("FontMatrix"))),l.setByName("FontMatrix",o)}}var c=e.topDict.getByName("XUID");c&&16<c.length&&e.topDict.removeByName("XUID"),e.topDict.setByName("charset",0);var u=this.compileTopDicts([e.topDict],t.length,e.isCIDFont);t.add(u.output);var h=u.trackers[0],d=this.compileStringIndex(e.strings.strings);t.add(d);var f=this.compileIndex(e.globalSubrIndex);if(t.add(f),e.encoding&&e.topDict.hasName("Encoding"))if(e.encoding.predefined)h.setEntryLocation("Encoding",[e.encoding.format],t);else{var m=this.compileEncoding(e.encoding);h.setEntryLocation("Encoding",[t.length],t),t.add(m)}var p=this.compileCharset(e.charset,e.charStrings.count,e.strings,e.isCIDFont);h.setEntryLocation("charset",[t.length],t),t.add(p);var g=this.compileCharStrings(e.charStrings);if(h.setEntryLocation("CharStrings",[t.length],t),t.add(g),e.isCIDFont){h.setEntryLocation("FDSelect",[t.length],t);var v=this.compileFDSelect(e.fdSelect);t.add(v),u=this.compileTopDicts(e.fdArray,t.length,!0),h.setEntryLocation("FDArray",[t.length],t),t.add(u.output);var y=u.trackers;this.compilePrivateDicts(e.fdArray,y,t)}return this.compilePrivateDicts([e.topDict],[h],t),t.add([0]),t.data}},{key:"encodeNumber",value:function(e){return Number.isInteger(e)?this.encodeInteger(e):this.encodeFloat(e)}},{key:"encodeFloat",value:function(e){var t=e.toString(),r=c.EncodeFloatRegExp.exec(t);if(r){var n=parseFloat("1e"+((r[2]?+r[2]:0)+r[1].length));t=(Math.round(e*n)/n).toString()}var i,a,s="";for(i=0,a=t.length;i<a;++i){var l=t[i];s+="e"===l?"-"===t[++i]?"c":"b":"."===l?"a":"-"===l?"e":l}var o=[30];for(i=0,a=(s+=1&s.length?"f":"ff").length;i<a;i+=2)o.push(parseInt(s.substring(i,i+2),16));return o}},{key:"encodeInteger",value:function(e){return-107<=e&&e<=107?[e+139]:108<=e&&e<=1131?[247+((e-=108)>>8),255&e]:-1131<=e&&e<=-108?[251+((e=-e-108)>>8),255&e]:-32768<=e&&e<=32767?[28,e>>8&255,255&e]:[29,e>>24&255,e>>16&255,e>>8&255,255&e]}},{key:"compileHeader",value:function(e){return[e.major,e.minor,4,e.offSize]}},{key:"compileNameIndex",value:function(e){for(var t=new CFFIndex,r=0,n=e.length;r<n;++r){for(var i=e[r],a=Math.min(i.length,127),s=new Array(a),l=0;l<a;l++){var o=i[l];(o<"!"||"~"<o||"["===o||"]"===o||"("===o||")"===o||"{"===o||"}"===o||"<"===o||">"===o||"/"===o||"%"===o)&&(o="_"),s[l]=o}""===(s=s.join(""))&&(s="Bad_Font_Name"),t.add((0,_util.stringToBytes)(s))}return this.compileIndex(t)}},{key:"compileTopDicts",value:function(e,t,r){for(var n=[],i=new CFFIndex,a=0,s=e.length;a<s;++a){var l=e[a];r&&(l.removeByName("CIDFontVersion"),l.removeByName("CIDFontRevision"),l.removeByName("CIDFontType"),l.removeByName("CIDCount"),l.removeByName("UIDBase"));var o=new CFFOffsetTracker,c=this.compileDict(l,o);n.push(o),i.add(c),o.offset(t)}return{trackers:n,output:i=this.compileIndex(i,n)}}},{key:"compilePrivateDicts",value:function(e,t,r){for(var n=0,i=e.length;n<i;++n){var a=e[n],s=a.privateDict;if(!s||!a.hasName("Private"))throw new _util.FormatError("There must be a private dictionary.");var l=new CFFOffsetTracker,o=this.compileDict(s,l),c=r.length;if(l.offset(c),o.length||(c=0),t[n].setEntryLocation("Private",[o.length,c],r),r.add(o),s.subrsIndex&&s.hasName("Subrs")){var u=this.compileIndex(s.subrsIndex);l.setEntryLocation("Subrs",[o.length],r),r.add(u)}}}},{key:"compileDict",value:function(e,t){for(var r=[],n=e.order,i=0;i<n.length;++i){var a=n[i];if(a in e.values){var s=e.values[a],l=e.types[a];if(Array.isArray(l)||(l=[l]),Array.isArray(s)||(s=[s]),0!==s.length){for(var o=0,c=l.length;o<c;++o){var u=l[o],h=s[o];switch(u){case"num":case"sid":r=r.concat(this.encodeNumber(h));break;case"offset":var d=e.keyToNameMap[a];t.isTracking(d)||t.track(d,r.length),r=r.concat([29,0,0,0,0]);break;case"array":case"delta":r=r.concat(this.encodeNumber(h));for(var f=1,m=s.length;f<m;++f)r=r.concat(this.encodeNumber(s[f]));break;default:throw new _util.FormatError("Unknown data type of ".concat(u))}}r=r.concat(e.opcodes[a])}}}return r}},{key:"compileStringIndex",value:function(e){for(var t=new CFFIndex,r=0,n=e.length;r<n;++r)t.add((0,_util.stringToBytes)(e[r]));return this.compileIndex(t)}},{key:"compileGlobalSubrIndex",value:function(){var e=this.cff.globalSubrIndex;this.out.writeByteArray(this.compileIndex(e))}},{key:"compileCharStrings",value:function(e){for(var t=new CFFIndex,r=0;r<e.count;r++){var n=e.get(r);0!==n.length?t.add(n):t.add(new Uint8Array([139,14]))}return this.compileIndex(t)}},{key:"compileCharset",value:function(e,t,r,n){var i,a=t-1;if(n)i=new Uint8Array([2,0,0,a>>8&255,255&a]);else for(var s=(i=new Uint8Array(1+2*a))[0]=0,l=e.charset.length,o=!1,c=1;c<i.length;c+=2){var u=0;if(s<l){var h=e.charset[s++];-1===(u=r.getSID(h))&&(u=0,o||(o=!0,(0,_util.warn)("Couldn't find ".concat(h," in CFF strings"))))}i[c]=u>>8&255,i[c+1]=255&u}return this.compileTypedArray(i)}},{key:"compileEncoding",value:function(e){return this.compileTypedArray(e.raw)}},{key:"compileFDSelect",value:function(e){var t,r,n=e.format;switch(n){case 0:for((t=new Uint8Array(1+e.fdSelect.length))[0]=n,r=0;r<e.fdSelect.length;r++)t[r+1]=e.fdSelect[r];break;case 3:var i=e.fdSelect[0],a=[n,0,0,0,0,i];for(r=1;r<e.fdSelect.length;r++){var s=e.fdSelect[r];s!==i&&(a.push(r>>8&255,255&r,s),i=s)}var l=(a.length-3)/3;a[1]=l>>8&255,a[2]=255&l,a.push(r>>8&255,255&r),t=new Uint8Array(a)}return this.compileTypedArray(t)}},{key:"compileTypedArray",value:function(e){for(var t=[],r=0,n=e.length;r<n;++r)t[r]=e[r];return t}},{key:"compileIndex",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=e.objects,n=r.length;if(0===n)return[0,0,0];var i,a,s=[n>>8&255,255&n],l=1;for(i=0;i<n;++i)l+=r[i].length;a=l<256?1:l<65536?2:l<16777216?3:4,s.push(a);var o=1;for(i=0;i<n+1;i++)1===a?s.push(255&o):2===a?s.push(o>>8&255,255&o):3===a?s.push(o>>16&255,o>>8&255,255&o):s.push(o>>>24&255,o>>16&255,o>>8&255,255&o),r[i]&&(o+=r[i].length);for(i=0;i<n;i++){t[i]&&t[i].offset(s.length);for(var c=0,u=r[i].length;c<u;c++)s.push(r[i][c])}return s}}],[{key:"EncodeFloatRegExp",get:function(){return(0,_util.shadow)(this,"EncodeFloatRegExp",/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/)}}]),c}();exports.CFFCompiler=CFFCompiler;