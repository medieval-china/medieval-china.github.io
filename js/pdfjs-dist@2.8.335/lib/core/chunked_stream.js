"use strict";function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s:s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){u=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(u)throw i}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChunkedStreamManager=exports.ChunkedStream=void 0;var _util=require("../shared/util.js"),_core_utils=require("./core_utils.js"),ChunkedStream=function(){function n(e,t,r){_classCallCheck(this,n),this.bytes=new Uint8Array(e),this.start=0,this.pos=0,this.end=e,this.chunkSize=t,this._loadedChunks=new Set,this.numChunks=Math.ceil(e/t),this.manager=r,this.progressiveDataLength=0,this.lastSuccessfulEnsureByteChunk=-1}return _createClass(n,[{key:"getMissingChunks",value:function(){for(var e=[],t=0,r=this.numChunks;t<r;++t)this._loadedChunks.has(t)||e.push(t);return e}},{key:"getBaseStreams",value:function(){return[this]}},{key:"numChunksLoaded",get:function(){return this._loadedChunks.size}},{key:"allChunksLoaded",value:function(){return this.numChunksLoaded===this.numChunks}},{key:"onReceiveData",value:function(e,t){var r=this.chunkSize;if(e%r!=0)throw new Error("Bad begin offset: ".concat(e));var n=e+t.byteLength;if(n%r!=0&&n!==this.bytes.length)throw new Error("Bad end offset: ".concat(n));this.bytes.set(new Uint8Array(t),e);for(var s=Math.floor(e/r),i=Math.floor((n-1)/r)+1,a=s;a<i;++a)this._loadedChunks.add(a)}},{key:"onReceiveProgressiveData",value:function(e){var t=this.progressiveDataLength,r=Math.floor(t/this.chunkSize);this.bytes.set(new Uint8Array(e),t),t+=e.byteLength;for(var n=(this.progressiveDataLength=t)>=this.end?this.numChunks:Math.floor(t/this.chunkSize),s=r;s<n;++s)this._loadedChunks.add(s)}},{key:"ensureByte",value:function(e){if(!(e<this.progressiveDataLength)){var t=Math.floor(e/this.chunkSize);if(t!==this.lastSuccessfulEnsureByteChunk){if(!this._loadedChunks.has(t))throw new _core_utils.MissingDataException(e,e+1);this.lastSuccessfulEnsureByteChunk=t}}}},{key:"ensureRange",value:function(e,t){if(!(t<=e||t<=this.progressiveDataLength))for(var r=this.chunkSize,n=Math.floor(e/r),s=Math.floor((t-1)/r)+1,i=n;i<s;++i)if(!this._loadedChunks.has(i))throw new _core_utils.MissingDataException(e,t)}},{key:"nextEmptyChunk",value:function(e){for(var t=this.numChunks,r=0;r<t;++r){var n=(e+r)%t;if(!this._loadedChunks.has(n))return n}return null}},{key:"hasChunk",value:function(e){return this._loadedChunks.has(e)}},{key:"length",get:function(){return this.end-this.start}},{key:"isEmpty",get:function(){return 0===this.length}},{key:"getByte",value:function(){var e=this.pos;return e>=this.end?-1:(e>=this.progressiveDataLength&&this.ensureByte(e),this.bytes[this.pos++])}},{key:"getUint16",value:function(){var e=this.getByte(),t=this.getByte();return-1===e||-1===t?-1:(e<<8)+t}},{key:"getInt32",value:function(){return(this.getByte()<<24)+(this.getByte()<<16)+(this.getByte()<<8)+this.getByte()}},{key:"getBytes",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=this.bytes,n=this.pos,s=this.end;if(!e){s>this.progressiveDataLength&&this.ensureRange(n,s);var i=r.subarray(n,s);return t?new Uint8ClampedArray(i):i}var a=n+e;s<a&&(a=s),a>this.progressiveDataLength&&this.ensureRange(n,a),this.pos=a;var u=r.subarray(n,a);return t?new Uint8ClampedArray(u):u}},{key:"peekByte",value:function(){var e=this.getByte();return-1!==e&&this.pos--,e}},{key:"peekBytes",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=this.getBytes(e,t);return this.pos-=r.length,r}},{key:"getByteRange",value:function(e,t){return e<0&&(e=0),t>this.end&&(t=this.end),t>this.progressiveDataLength&&this.ensureRange(e,t),this.bytes.subarray(e,t)}},{key:"skip",value:function(e){e||(e=1),this.pos+=e}},{key:"reset",value:function(){this.pos=this.start}},{key:"moveStart",value:function(){this.start=this.pos}},{key:"makeSubStream",value:function(e,t,r){function n(){}t?e+t>this.progressiveDataLength&&this.ensureRange(e,e+t):e>=this.progressiveDataLength&&this.ensureByte(e),(n.prototype=Object.create(this)).getMissingChunks=function(){for(var e=this.chunkSize,t=Math.floor(this.start/e),r=Math.floor((this.end-1)/e)+1,n=[],s=t;s<r;++s)this._loadedChunks.has(s)||n.push(s);return n},n.prototype.allChunksLoaded=function(){return this.numChunksLoaded===this.numChunks||0===this.getMissingChunks().length};var s=new n;return s.pos=s.start=e,s.end=e+t||this.end,s.dict=r,s}}]),n}();exports.ChunkedStream=ChunkedStream;var ChunkedStreamManager=function(){function r(e,t){_classCallCheck(this,r),this.length=t.length,this.chunkSize=t.rangeChunkSize,this.stream=new ChunkedStream(this.length,this.chunkSize,this),this.pdfNetworkStream=e,this.disableAutoFetch=t.disableAutoFetch,this.msgHandler=t.msgHandler,this.currRequestId=0,this._chunksNeededByRequest=new Map,this._requestsByChunk=new Map,this._promisesByRequest=new Map,this.progressiveDataLength=0,this.aborted=!1,this._loadedStreamCapability=(0,_util.createPromiseCapability)()}return _createClass(r,[{key:"onLoadedStream",value:function(){return this._loadedStreamCapability.promise}},{key:"sendRequest",value:function(t,e){var a=this,u=this.pdfNetworkStream.getRangeReader(t,e);u.isStreamingSupported||(u.onProgress=this.onProgress.bind(this));var h=[],o=0;new Promise(function(s,i){u.read().then(function e(t){try{if(!t.done){var r=t.value;return h.push(r),o+=(0,_util.arrayByteLength)(r),u.isStreamingSupported&&a.onProgress({loaded:o}),void u.read().then(e,i)}var n=(0,_util.arraysToBytes)(h);h=null,s(n)}catch(e){i(e)}},i)}).then(function(e){a.aborted||a.onReceiveData({chunk:e,begin:t})})}},{key:"requestAllChunks",value:function(){var e=this.stream.getMissingChunks();return this._requestChunks(e),this._loadedStreamCapability.promise}},{key:"_requestChunks",value:function(e){var t=this,r=this.currRequestId++,n=new Set;this._chunksNeededByRequest.set(r,n);var s,i=_createForOfIteratorHelper(e);try{for(i.s();!(s=i.n()).done;){var a=s.value;this.stream.hasChunk(a)||n.add(a)}}catch(e){i.e(e)}finally{i.f()}if(0===n.size)return Promise.resolve();var u=(0,_util.createPromiseCapability)();this._promisesByRequest.set(r,u);var h,o=[],l=_createForOfIteratorHelper(n);try{for(l.s();!(h=l.n()).done;){var c=h.value,f=this._requestsByChunk.get(c);f||(f=[],this._requestsByChunk.set(c,f),o.push(c)),f.push(r)}}catch(e){l.e(e)}finally{l.f()}if(0<o.length){var y,d=_createForOfIteratorHelper(this.groupChunks(o));try{for(d.s();!(y=d.n()).done;){var k=y.value,v=k.beginChunk*this.chunkSize,g=Math.min(k.endChunk*this.chunkSize,this.length);this.sendRequest(v,g)}}catch(e){d.e(e)}finally{d.f()}}return u.promise.catch(function(e){if(!t.aborted)throw e})}},{key:"getStream",value:function(){return this.stream}},{key:"requestRange",value:function(e,t){t=Math.min(t,this.length);for(var r=this.getBeginChunk(e),n=this.getEndChunk(t),s=[],i=r;i<n;++i)s.push(i);return this._requestChunks(s)}},{key:"requestRanges",value:function(){var e,t=[],r=_createForOfIteratorHelper(0<arguments.length&&void 0!==arguments[0]?arguments[0]:[]);try{for(r.s();!(e=r.n()).done;)for(var n=e.value,s=this.getBeginChunk(n.begin),i=this.getEndChunk(n.end),a=s;a<i;++a)t.includes(a)||t.push(a)}catch(e){r.e(e)}finally{r.f()}return t.sort(function(e,t){return e-t}),this._requestChunks(t)}},{key:"groupChunks",value:function(e){for(var t=[],r=-1,n=-1,s=0,i=e.length;s<i;++s){var a=e[s];r<0&&(r=a),0<=n&&n+1!==a&&(t.push({beginChunk:r,endChunk:n+1}),r=a),s+1===e.length&&t.push({beginChunk:r,endChunk:a+1}),n=a}return t}},{key:"onProgress",value:function(e){this.msgHandler.send("DocProgress",{loaded:this.stream.numChunksLoaded*this.chunkSize+e.loaded,total:this.length})}},{key:"onReceiveData",value:function(e){var t=e.chunk,r=void 0===e.begin,n=r?this.progressiveDataLength:e.begin,s=n+t.byteLength,i=Math.floor(n/this.chunkSize),a=s<this.length?Math.floor(s/this.chunkSize):Math.ceil(s/this.chunkSize);r?(this.stream.onReceiveProgressiveData(t),this.progressiveDataLength=s):this.stream.onReceiveData(n,t),this.stream.allChunksLoaded()&&this._loadedStreamCapability.resolve(this.stream);for(var u=[],h=i;h<a;++h){var o=this._requestsByChunk.get(h);if(o){this._requestsByChunk.delete(h);var l,c=_createForOfIteratorHelper(o);try{for(c.s();!(l=c.n()).done;){var f=l.value,y=this._chunksNeededByRequest.get(f);y.has(h)&&y.delete(h),0<y.size||u.push(f)}}catch(e){c.e(e)}finally{c.f()}}}if(!this.disableAutoFetch&&0===this._requestsByChunk.size){var d;if(1===this.stream.numChunksLoaded){var k=this.stream.numChunks-1;this.stream.hasChunk(k)||(d=k)}else d=this.stream.nextEmptyChunk(a);Number.isInteger(d)&&this._requestChunks([d])}for(var v=0,g=u;v<g.length;v++){var p=g[v],m=this._promisesByRequest.get(p);this._promisesByRequest.delete(p),m.resolve()}this.msgHandler.send("DocProgress",{loaded:this.stream.numChunksLoaded*this.chunkSize,total:this.length})}},{key:"onError",value:function(e){this._loadedStreamCapability.reject(e)}},{key:"getBeginChunk",value:function(e){return Math.floor(e/this.chunkSize)}},{key:"getEndChunk",value:function(e){return Math.floor((e-1)/this.chunkSize)+1}},{key:"abort",value:function(e){this.aborted=!0,this.pdfNetworkStream&&this.pdfNetworkStream.cancelAllRequests(e);var t,r=_createForOfIteratorHelper(this._promisesByRequest.values());try{for(r.s();!(t=r.n()).done;){t.value.reject(e)}}catch(e){r.e(e)}finally{r.f()}}}]),r}();exports.ChunkedStreamManager=ChunkedStreamManager;