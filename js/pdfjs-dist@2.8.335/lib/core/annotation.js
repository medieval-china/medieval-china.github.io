"use strict";function _get(){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var a=_superPropBase(t,e);if(a){var n=Object.getOwnPropertyDescriptor(a,e);return n.get?n.get.call(arguments.length<3?t:r):n.value}}).apply(this,arguments)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(a){var n=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(a);if(n){var r=_getPrototypeOf(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return _possibleConstructorReturn(this,t)}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _regeneratorRuntime(){_regeneratorRuntime=function(){return o};var o={},t=Object.prototype,u=t.hasOwnProperty,p=Object.defineProperty||function(t,e,r){t[e]=r.value},e="function"==typeof Symbol?Symbol:{},n=e.iterator||"@@iterator",r=e.asyncIterator||"@@asyncIterator",a=e.toStringTag||"@@toStringTag";function i(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{i({},"")}catch(t){i=function(t,e,r){return t[e]=r}}function s(t,e,r,a){var i,o,s,c,n=e&&e.prototype instanceof d?e:d,l=Object.create(n.prototype),u=new S(a||[]);return p(l,"_invoke",{value:(i=t,o=r,s=u,c="suspendedStart",function(t,e){if("executing"===c)throw new Error("Generator is already running");if("completed"===c){if("throw"===t)throw e;return F()}for(s.method=t,s.arg=e;;){var r=s.delegate;if(r){var a=b(r,s);if(a){if(a===f)continue;return a}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===c)throw c="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);c="executing";var n=h(i,o,s);if("normal"===n.type){if(c=s.done?"completed":"suspendedYield",n.arg===f)continue;return{value:n.arg,done:s.done}}"throw"===n.type&&(c="completed",s.method="throw",s.arg=n.arg)}})}),l}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}o.wrap=s;var f={};function d(){}function c(){}function l(){}var y={};i(y,n,function(){return this});var _=Object.getPrototypeOf,g=_&&_(_(T([])));g&&g!==t&&u.call(g,n)&&(y=g);var v=l.prototype=d.prototype=Object.create(y);function m(t){["next","throw","return"].forEach(function(e){i(t,e,function(t){return this._invoke(e,t)})})}function A(c,l){var e;p(this,"_invoke",{value:function(r,a){function t(){return new l(function(t,e){!function e(t,r,a,n){var i=h(c[t],c,r);if("throw"!==i.type){var o=i.arg,s=o.value;return s&&"object"==_typeof(s)&&u.call(s,"__await")?l.resolve(s.__await).then(function(t){e("next",t,a,n)},function(t){e("throw",t,a,n)}):l.resolve(s).then(function(t){o.value=t,a(o)},function(t){return e("throw",t,a,n)})}n(i.arg)}(r,a,t,e)})}return e=e?e.then(t,t):t()}})}function b(t,e){var r=e.method,a=t.iterator[r];if(void 0===a)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var n=h(a,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,f;var i=n.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,f):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,f)}function k(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function S(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function T(e){if(e){var t=e[n];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(u.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:F}}function F(){return{value:void 0,done:!0}}return p(v,"constructor",{value:c.prototype=l,configurable:!0}),p(l,"constructor",{value:c,configurable:!0}),c.displayName=i(l,a,"GeneratorFunction"),o.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===c||"GeneratorFunction"===(e.displayName||e.name))},o.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,i(t,a,"GeneratorFunction")),t.prototype=Object.create(v),t},o.awrap=function(t){return{__await:t}},m(A.prototype),i(A.prototype,r,function(){return this}),o.AsyncIterator=A,o.async=function(t,e,r,a,n){void 0===n&&(n=Promise);var i=new A(s(t,e,r,a),n);return o.isGeneratorFunction(e)?i:i.next().then(function(t){return t.done?t.value:i.next()})},m(v),i(v,a,"Generator"),i(v,n,function(){return this}),i(v,"toString",function(){return"[object Generator]"}),o.keys=function(t){var r=Object(t),a=[];for(var e in r)a.push(e);return a.reverse(),function t(){for(;a.length;){var e=a.pop();if(e in r)return t.value=e,t.done=!1,t}return t.done=!0,t}},o.values=T,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&u.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var a=this;function t(t,e){return i.type="throw",i.arg=r,a.next=t,e&&(a.method="next",a.arg=void 0),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e],i=n.completion;if("root"===n.tryLoc)return t("end");if(n.tryLoc<=this.prev){var o=u.call(n,"catchLoc"),s=u.call(n,"finallyLoc");if(o&&s){if(this.prev<n.catchLoc)return t(n.catchLoc,!0);if(this.prev<n.finallyLoc)return t(n.finallyLoc)}else if(o){if(this.prev<n.catchLoc)return t(n.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return t(n.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;0<=r;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&u.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var n=a;break}}n&&("break"===t||"continue"===t)&&n.tryLoc<=e&&e<=n.finallyLoc&&(n=null);var i=n?n.completion:{};return i.type=t,i.arg=e,n?(this.method="next",this.next=n.finallyLoc,f):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),x(r),f}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var a=r.completion;if("throw"===a.type){var n=a.arg;x(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:T(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},o}function asyncGeneratorStep(t,e,r,a,n,i,o){try{var s=t[i](o),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(a,n)}function _asyncToGenerator(s){return function(){var t=this,o=arguments;return new Promise(function(e,r){var a=s.apply(t,o);function n(t){asyncGeneratorStep(a,e,r,n,i,"next",t)}function i(t){asyncGeneratorStep(a,e,r,n,i,"throw",t)}n(void 0)})}}function _createForOfIteratorHelper(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var a=0,n=function(){};return{s:n,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw i}}}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,a=new Array(e);r<e;r++)a[r]=t[r];return a}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var a,n,i,o,s=[],c=!0,l=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(a=i.call(r)).done)&&(s.push(a.value),s.length!==e);c=!0);}catch(t){l=!0,n=t}finally{try{if(!c&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw n}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,_toPropertyKey(a.key),a)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);var a=r.call(t,e||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getQuadPoints=getQuadPoints,exports.MarkupAnnotation=exports.AnnotationFactory=exports.AnnotationBorderStyle=exports.Annotation=void 0;var _util=require("../shared/util.js"),_obj=require("./obj.js"),_core_utils=require("./core_utils.js"),_default_appearance=require("./default_appearance.js"),_primitives=require("./primitives.js"),_colorspace=require("./colorspace.js"),_operator_list=require("./operator_list.js"),_stream=require("./stream.js"),_writer=require("./writer.js"),AnnotationFactory=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"create",value:function(e,r,a,n,i){var o=this;return a.ensureCatalog("acroForm").then(function(t){return a.ensure(o,"_create",[e,r,a,n,t,i])})}},{key:"_create",value:function(t,e,r,a,n,i){var o=t.fetchIfRef(e);if((0,_primitives.isDict)(o)){var s=(0,_primitives.isRef)(e)?e.toString():"annot_".concat(a.createObjId()),c=o.get("Subtype"),l={xref:t,ref:e,dict:o,subtype:c=(0,_primitives.isName)(c)?c.name:null,id:s,pdfManager:r,acroForm:n instanceof _primitives.Dict?n:_primitives.Dict.empty,collectFields:i};switch(c){case"Link":return new LinkAnnotation(l);case"Text":return new TextAnnotation(l);case"Widget":var u=(0,_core_utils.getInheritableProperty)({dict:o,key:"FT"});switch(u=(0,_primitives.isName)(u)?u.name:null){case"Tx":return new TextWidgetAnnotation(l);case"Btn":return new ButtonWidgetAnnotation(l);case"Ch":return new ChoiceWidgetAnnotation(l)}return(0,_util.warn)('Unimplemented widget field type "'.concat(u,'", ')+"falling back to base field type."),new WidgetAnnotation(l);case"Popup":return new PopupAnnotation(l);case"FreeText":return new FreeTextAnnotation(l);case"Line":return new LineAnnotation(l);case"Square":return new SquareAnnotation(l);case"Circle":return new CircleAnnotation(l);case"PolyLine":return new PolylineAnnotation(l);case"Polygon":return new PolygonAnnotation(l);case"Caret":return new CaretAnnotation(l);case"Ink":return new InkAnnotation(l);case"Highlight":return new HighlightAnnotation(l);case"Underline":return new UnderlineAnnotation(l);case"Squiggly":return new SquigglyAnnotation(l);case"StrikeOut":return new StrikeOutAnnotation(l);case"Stamp":return new StampAnnotation(l);case"FileAttachment":return new FileAttachmentAnnotation(l);default:return i||(c?(0,_util.warn)('Unimplemented annotation type "'.concat(c,'", ')+"falling back to base annotation."):(0,_util.warn)("Annotation is missing the required /Subtype.")),new Annotation(l)}}}}]),t}();function getRgbColor(t){var e=new Uint8ClampedArray(3);if(!Array.isArray(t))return e;switch(t.length){case 0:return null;case 1:return _colorspace.ColorSpace.singletons.gray.getRgbItem(t,0,e,0),e;case 3:return _colorspace.ColorSpace.singletons.rgb.getRgbItem(t,0,e,0),e;case 4:return _colorspace.ColorSpace.singletons.cmyk.getRgbItem(t,0,e,0),e;default:return e}}function getQuadPoints(t,e){if(!t.has("QuadPoints"))return null;var r=t.getArray("QuadPoints");if(!Array.isArray(r)||0===r.length||0<r.length%8)return null;for(var a=[],n=0,i=r.length/8;n<i;n++){a.push([]);for(var o=8*n,s=8*n+8;o<s;o+=2){var c=r[o],l=r[o+1];if(null!==e&&(c<e[0]||c>e[2]||l<e[1]||l>e[3]))return null;a[n].push({x:c,y:l})}}return a.map(function(t){var e=_slicedToArray(t.reduce(function(t,e){var r=_slicedToArray(t,4),a=r[0],n=r[1],i=r[2],o=r[3];return[Math.min(a,e.x),Math.max(n,e.x),Math.min(i,e.y),Math.max(o,e.y)]},[Number.MAX_VALUE,Number.MIN_VALUE,Number.MAX_VALUE,Number.MIN_VALUE]),4),r=e[0],a=e[1],n=e[2],i=e[3];return[{x:r,y:i},{x:a,y:i},{x:r,y:n},{x:a,y:n}]})}function getTransformMatrix(t,e,r){var a=_slicedToArray(_util.Util.getAxialAlignedBoundingBox(e,r),4),n=a[0],i=a[1],o=a[2],s=a[3];if(n===o||i===s)return[1,0,0,1,t[0],t[1]];var c=(t[2]-t[0])/(o-n),l=(t[3]-t[1])/(s-i);return[c,0,0,l,t[0]-n*c,t[1]-i*l]}exports.AnnotationFactory=AnnotationFactory;var Annotation=function(){function s(t){_classCallCheck(this,s);var e=t.dict;if(this.setContents(e.get("Contents")),this.setModificationDate(e.get("M")),this.setFlags(e.get("F")),this.setRectangle(e.getArray("Rect")),this.setColor(e.getArray("C")),this.setBorderStyle(e),this.setAppearance(e),this._streams=[],this.appearance&&this._streams.push(this.appearance),this.data={annotationFlags:this.flags,borderStyle:this.borderStyle,color:this.color,contents:this.contents,hasAppearance:!!this.appearance,id:t.id,modificationDate:this.modificationDate,rect:this.rectangle,subtype:t.subtype},t.collectFields){var r=e.get("Kids");if(Array.isArray(r)){var a,n=[],i=_createForOfIteratorHelper(r);try{for(i.s();!(a=i.n()).done;){var o=a.value;(0,_primitives.isRef)(o)&&n.push(o.toString())}}catch(t){i.e(t)}finally{i.f()}0!==n.length&&(this.data.kidIds=n)}this.data.actions=(0,_core_utils.collectActions)(t.xref,e,_util.AnnotationActionEventType),this.data.fieldName=this._constructFieldName(e)}this._fallbackFontDict=null}var a;return _createClass(s,[{key:"_hasFlag",value:function(t,e){return!!(t&e)}},{key:"_isViewable",value:function(t){return!this._hasFlag(t,_util.AnnotationFlag.INVISIBLE)&&!this._hasFlag(t,_util.AnnotationFlag.NOVIEW)}},{key:"_isPrintable",value:function(t){return this._hasFlag(t,_util.AnnotationFlag.PRINT)&&!this._hasFlag(t,_util.AnnotationFlag.INVISIBLE)}},{key:"isHidden",value:function(t){var e=t&&t.get(this.data.id);return e&&void 0!==e.hidden?e.hidden:this._hasFlag(this.flags,_util.AnnotationFlag.HIDDEN)}},{key:"viewable",get:function(){return null!==this.data.quadPoints&&(0===this.flags||this._isViewable(this.flags))}},{key:"printable",get:function(){return null!==this.data.quadPoints&&(0!==this.flags&&this._isPrintable(this.flags))}},{key:"setContents",value:function(t){this.contents=(0,_util.stringToPDFString)(t||"")}},{key:"setModificationDate",value:function(t){this.modificationDate=(0,_util.isString)(t)?t:null}},{key:"setFlags",value:function(t){this.flags=Number.isInteger(t)&&0<t?t:0}},{key:"hasFlag",value:function(t){return this._hasFlag(this.flags,t)}},{key:"setRectangle",value:function(t){Array.isArray(t)&&4===t.length?this.rectangle=_util.Util.normalizeRect(t):this.rectangle=[0,0,0,0]}},{key:"setColor",value:function(t){this.color=getRgbColor(t)}},{key:"setBorderStyle",value:function(t){if(this.borderStyle=new AnnotationBorderStyle,(0,_primitives.isDict)(t))if(t.has("BS")){var e=t.get("BS"),r=e.get("Type");r&&!(0,_primitives.isName)(r,"Border")||(this.borderStyle.setWidth(e.get("W"),this.rectangle),this.borderStyle.setStyle(e.get("S")),this.borderStyle.setDashArray(e.getArray("D")))}else if(t.has("Border")){var a=t.getArray("Border");Array.isArray(a)&&3<=a.length&&(this.borderStyle.setHorizontalCornerRadius(a[0]),this.borderStyle.setVerticalCornerRadius(a[1]),this.borderStyle.setWidth(a[2],this.rectangle),4===a.length&&this.borderStyle.setDashArray(a[3]))}else this.borderStyle.setWidth(0)}},{key:"setAppearance",value:function(t){this.appearance=null;var e=t.get("AP");if((0,_primitives.isDict)(e)){var r=e.get("N");if((0,_primitives.isStream)(r))this.appearance=r;else if((0,_primitives.isDict)(r)){var a=t.get("AS");(0,_primitives.isName)(a)&&r.has(a.name)&&(this.appearance=r.get(a.name))}}}},{key:"loadResources",value:function(e){return this.appearance.dict.getAsync("Resources").then(function(t){if(t)return new _obj.ObjectLoader(t,e,t.xref).load().then(function(){return t})})}},{key:"getOperatorList",value:function(r,a,t,e){var n=this;if(!this.appearance)return Promise.resolve(new _operator_list.OperatorList);var i=this.appearance,o=this.data,s=i.dict,c=this.loadResources(["ExtGState","ColorSpace","Pattern","Shading","XObject","Font"]),l=s.getArray("BBox")||[0,0,1,1],u=s.getArray("Matrix")||[1,0,0,1,0,0],p=getTransformMatrix(o.rect,l,u);return c.then(function(t){var e=new _operator_list.OperatorList;return e.addOp(_util.OPS.beginAnnotation,[o.rect,p,u]),r.getOperatorList({stream:i,task:a,resources:t,operatorList:e,fallbackFontDict:n._fallbackFontDict}).then(function(){return e.addOp(_util.OPS.endAnnotation,[]),n.reset(),e})})}},{key:"save",value:(a=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r,a){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",null);case 1:case"end":return t.stop()}},t)})),function(t,e,r){return a.apply(this,arguments)})},{key:"getFieldObject",value:function(){return this.data.kidIds?{id:this.data.id,actions:this.data.actions,name:this.data.fieldName,type:"",kidIds:this.data.kidIds}:null}},{key:"reset",value:function(){var t,e=_createForOfIteratorHelper(this._streams);try{for(e.s();!(t=e.n()).done;){t.value.reset()}}catch(t){e.e(t)}finally{e.f()}}},{key:"_constructFieldName",value:function(t){if(!t.has("T")&&!t.has("Parent"))return(0,_util.warn)("Unknown field name, falling back to empty field name."),"";if(!t.has("Parent"))return(0,_util.stringToPDFString)(t.get("T"));var e=[];t.has("T")&&e.unshift((0,_util.stringToPDFString)(t.get("T")));var r=t,a=new _primitives.RefSet;for(t.objId&&a.put(t.objId);r.has("Parent")&&(r=r.get("Parent"))instanceof _primitives.Dict&&(!r.objId||!a.has(r.objId));)r.objId&&a.put(r.objId),r.has("T")&&e.unshift((0,_util.stringToPDFString)(r.get("T")));return e.join(".")}}]),s}();exports.Annotation=Annotation;var AnnotationBorderStyle=function(){function t(){_classCallCheck(this,t),this.width=1,this.style=_util.AnnotationBorderStyleType.SOLID,this.dashArray=[3],this.horizontalCornerRadius=0,this.verticalCornerRadius=0}return _createClass(t,[{key:"setWidth",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[0,0,0,0];if((0,_primitives.isName)(t))this.width=0;else if(Number.isInteger(t)){if(0<t){var r=(e[2]-e[0])/2,a=(e[3]-e[1])/2;0<r&&0<a&&(r<t||a<t)&&((0,_util.warn)("AnnotationBorderStyle.setWidth - ignoring width: ".concat(t)),t=1)}this.width=t}}},{key:"setStyle",value:function(t){if((0,_primitives.isName)(t))switch(t.name){case"S":this.style=_util.AnnotationBorderStyleType.SOLID;break;case"D":this.style=_util.AnnotationBorderStyleType.DASHED;break;case"B":this.style=_util.AnnotationBorderStyleType.BEVELED;break;case"I":this.style=_util.AnnotationBorderStyleType.INSET;break;case"U":this.style=_util.AnnotationBorderStyleType.UNDERLINE}}},{key:"setDashArray",value:function(t){if(Array.isArray(t)&&0<t.length){var e,r=!0,a=!0,n=_createForOfIteratorHelper(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(!(0<=+i)){r=!1;break}0<i&&(a=!1)}}catch(t){n.e(t)}finally{n.f()}r&&!a?this.dashArray=t:this.width=0}else t&&(this.width=0)}},{key:"setHorizontalCornerRadius",value:function(t){Number.isInteger(t)&&(this.horizontalCornerRadius=t)}},{key:"setVerticalCornerRadius",value:function(t){Number.isInteger(t)&&(this.verticalCornerRadius=t)}}]),t}();exports.AnnotationBorderStyle=AnnotationBorderStyle;var MarkupAnnotation=function(t){_inherits(s,Annotation);var o=_createSuper(s);function s(t){var e;_classCallCheck(this,s),e=o.call(this,t);var r=t.dict;if(r.has("IRT")){var a=r.getRaw("IRT");e.data.inReplyTo=(0,_primitives.isRef)(a)?a.toString():null;var n=r.get("RT");e.data.replyType=(0,_primitives.isName)(n)?n.name:_util.AnnotationReplyType.REPLY}if(e.data.replyType===_util.AnnotationReplyType.GROUP){var i=r.get("IRT");e.data.title=(0,_util.stringToPDFString)(i.get("T")||""),e.setContents(i.get("Contents")),e.data.contents=e.contents,i.has("CreationDate")?(e.setCreationDate(i.get("CreationDate")),e.data.creationDate=e.creationDate):e.data.creationDate=null,i.has("M")?(e.setModificationDate(i.get("M")),e.data.modificationDate=e.modificationDate):e.data.modificationDate=null,e.data.hasPopup=i.has("Popup"),i.has("C")?(e.setColor(i.getArray("C")),e.data.color=e.color):e.data.color=null}else e.data.title=(0,_util.stringToPDFString)(r.get("T")||""),e.setCreationDate(r.get("CreationDate")),e.data.creationDate=e.creationDate,e.data.hasPopup=r.has("Popup"),r.has("C")||(e.data.color=null);return e}return _createClass(s,[{key:"setCreationDate",value:function(t){this.creationDate=(0,_util.isString)(t)?t:null}},{key:"_setDefaultAppearance",value:function(t){var e=t.xref,r=t.extra,a=t.strokeColor,n=t.fillColor,i=t.blendMode,o=t.pointsCallback,s=Number.MAX_VALUE,c=Number.MAX_VALUE,l=Number.MIN_VALUE,u=Number.MIN_VALUE,p=["q"];r&&p.push(r),a&&p.push("".concat(a[0]," ").concat(a[1]," ").concat(a[2]," RG")),n&&p.push("".concat(n[0]," ").concat(n[1]," ").concat(n[2]," rg"));var h=this.data.quadPoints;h||(h=[[{x:this.rectangle[0],y:this.rectangle[3]},{x:this.rectangle[2],y:this.rectangle[3]},{x:this.rectangle[0],y:this.rectangle[1]},{x:this.rectangle[2],y:this.rectangle[1]}]]);var f,d=_createForOfIteratorHelper(h);try{for(d.s();!(f=d.n()).done;){var y=_slicedToArray(o(p,f.value),4),_=y[0],g=y[1],v=y[2],m=y[3];s=Math.min(s,_),l=Math.max(l,g),c=Math.min(c,v),u=Math.max(u,m)}}catch(t){d.e(t)}finally{d.f()}p.push("Q");var A=new _primitives.Dict(e),b=new _primitives.Dict(e);b.set("Subtype",_primitives.Name.get("Form"));var k=new _stream.StringStream(p.join(" "));k.dict=b,A.set("Fm0",k);var x=new _primitives.Dict(e);i&&x.set("BM",_primitives.Name.get(i));var S=new _primitives.Dict(e);S.set("GS0",x);var T=new _primitives.Dict(e);T.set("ExtGState",S),T.set("XObject",A);var F=new _primitives.Dict(e);F.set("Resources",T);var w=this.data.rect=[s,c,l,u];F.set("BBox",w),this.appearance=new _stream.StringStream("/GS0 gs /Fm0 Do"),this.appearance.dict=F,this._streams.push(this.appearance,k)}}]),s}();exports.MarkupAnnotation=MarkupAnnotation;var WidgetAnnotation=function(t){_inherits(h,Annotation);var r,a,n,p=_createSuper(h);function h(t){var e;_classCallCheck(this,h),e=p.call(this,t);var r=t.dict,a=e.data;e.ref=t.ref,a.annotationType=_util.AnnotationType.WIDGET,void 0===a.fieldName&&(a.fieldName=e._constructFieldName(r)),void 0===a.actions&&(a.actions=(0,_core_utils.collectActions)(t.xref,r,_util.AnnotationActionEventType));var n=(0,_core_utils.getInheritableProperty)({dict:r,key:"V",getArray:!0});a.fieldValue=e._decodeFormValue(n);var i=(0,_core_utils.getInheritableProperty)({dict:r,key:"DV",getArray:!0});a.defaultFieldValue=e._decodeFormValue(i),a.alternativeText=(0,_util.stringToPDFString)(r.get("TU")||"");var o=(0,_core_utils.getInheritableProperty)({dict:r,key:"DA"})||t.acroForm.get("DA");e._defaultAppearance=(0,_util.isString)(o)?o:"",a.defaultAppearanceData=(0,_default_appearance.parseDefaultAppearance)(e._defaultAppearance);var s=(0,_core_utils.getInheritableProperty)({dict:r,key:"FT"});a.fieldType=(0,_primitives.isName)(s)?s.name:null;var c=(0,_core_utils.getInheritableProperty)({dict:r,key:"DR"}),l=t.acroForm.get("DR"),u=e.appearance&&e.appearance.dict.get("Resources");return e._fieldResources={localResources:c,acroFormResources:l,appearanceResources:u,mergedResources:_primitives.Dict.merge({xref:t.xref,dictArray:[c,u,l],mergeSubDicts:!0})},a.fieldFlags=(0,_core_utils.getInheritableProperty)({dict:r,key:"Ff"}),(!Number.isInteger(a.fieldFlags)||a.fieldFlags<0)&&(a.fieldFlags=0),a.readOnly=e.hasFieldFlag(_util.AnnotationFieldFlag.READONLY),a.hidden=e._hasFlag(a.annotationFlags,_util.AnnotationFlag.HIDDEN),"Sig"===a.fieldType&&(a.fieldValue=null,e.setFlags(_util.AnnotationFlag.HIDDEN),a.hidden=!0),e}return _createClass(h,[{key:"_decodeFormValue",value:function(t){return Array.isArray(t)?t.filter(function(t){return(0,_util.isString)(t)}).map(function(t){return(0,_util.stringToPDFString)(t)}):(0,_primitives.isName)(t)?(0,_util.stringToPDFString)(t.name):(0,_util.isString)(t)?(0,_util.stringToPDFString)(t):null}},{key:"hasFieldFlag",value:function(t){return!!(this.data.fieldFlags&t)}},{key:"getOperatorList",value:function(o,s,c,l){var u=this;return c?Promise.resolve(new _operator_list.OperatorList):this._hasText?this._getAppearance(o,s,l).then(function(t){if(u.appearance&&null===t)return _get(_getPrototypeOf(h.prototype),"getOperatorList",u).call(u,o,s,c,l);var e=new _operator_list.OperatorList;if(!u._defaultAppearance||null===t)return e;var r=[1,0,0,1,0,0],a=[0,0,u.data.rect[2]-u.data.rect[0],u.data.rect[3]-u.data.rect[1]],n=getTransformMatrix(u.data.rect,a,r);e.addOp(_util.OPS.beginAnnotation,[u.data.rect,n,r]);var i=new _stream.StringStream(t);return o.getOperatorList({stream:i,task:s,resources:u._fieldResources.mergedResources,operatorList:e}).then(function(){return e.addOp(_util.OPS.endAnnotation,[]),e})}):_get(_getPrototypeOf(h.prototype),"getOperatorList",this).call(this,o,s,c,l)}},{key:"save",value:(n=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r,a){var n,i,o,s,c,l,u,p,h,f,d,y,_,g,v;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a){t.next=2;break}return t.abrupt("return",null);case 2:if(n=a.get(this.data.id),(i=n&&n.value)===this.data.fieldValue||void 0===i)return t.abrupt("return",null);t.next=6;break;case 6:return t.next=8,this._getAppearance(e,r,a);case 8:if(null===(o=t.sent))return t.abrupt("return",null);t.next=11;break;case 11:if(s=e.xref,c=s.fetchIfRef(this.ref),(0,_primitives.isDict)(c)){t.next=15;break}return t.abrupt("return",null);case 15:return l=[0,0,this.data.rect[2]-this.data.rect[0],this.data.rect[3]-this.data.rect[1]],u={path:(0,_util.stringToPDFString)(c.get("T")||""),value:i},p=s.getNewRef(),(h=new _primitives.Dict(s)).set("N",p),f=s.encrypt,y=d=null,f&&(d=f.createCipherTransform(this.ref.num,this.ref.gen),y=f.createCipherTransform(p.num,p.gen),o=y.encryptString(o)),c.set("V",(0,_util.isAscii)(i)?i:(0,_util.stringToUTF16BEString)(i)),c.set("AP",h),c.set("M","D:".concat((0,_util.getModificationDate)())),(_=new _primitives.Dict(s)).set("Length",o.length),_.set("Subtype",_primitives.Name.get("Form")),_.set("Resources",this._getSaveFieldResources(s)),_.set("BBox",l),g=["".concat(this.ref.num," ").concat(this.ref.gen," obj\n")],(0,_writer.writeDict)(c,g,d),g.push("\nendobj\n"),v=["".concat(p.num," ").concat(p.gen," obj\n")],(0,_writer.writeDict)(_,v,y),v.push(" stream\n"),v.push(o),v.push("\nendstream\nendobj\n"),t.abrupt("return",[{ref:this.ref,data:g.join(""),xfa:u},{ref:p,data:v.join(""),xfa:null}]);case 41:case"end":return t.stop()}},t,this)})),function(t,e,r){return n.apply(this,arguments)})},{key:"_getAppearance",value:(a=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r,a){var n,i,o,s,c,l,u,p,h,f,d,y,_,g,v,m,A,b;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD),!a||n)return t.abrupt("return",null);t.next=3;break;case 3:if(i=a.get(this.data.id),void 0===(o=i&&i.value))return t.abrupt("return",null);t.next=7;break;case 7:if(""===(o=o.trim()))return t.abrupt("return","");t.next=10;break;case 10:return s=-1,this.data.multiLine&&(s=o.split(/\r\n|\r|\n/).length),l=c=2,u=this.data.rect[3]-this.data.rect[1],p=this.data.rect[2]-this.data.rect[0],this._defaultAppearance||(this.data.defaultAppearanceData=(0,_default_appearance.parseDefaultAppearance)(this._defaultAppearance="/Helvetica 0 Tf 0 g")),h=this._computeFontSize(u,s),f=_slicedToArray(h,2),d=f[0],y=f[1],t.next=20,this._getFontData(e,r);case 20:if(_=t.sent,g=_.descent,isNaN(g)&&(g=0),v=c+Math.abs(g)*y,m=this.data.textAlignment,this.data.multiLine)return t.abrupt("return",this._getMultilineAppearance(d,o,_,y,p,u,m,l,v));t.next=27;break;case 27:if(A=_.encodeString(o).join(""),this.data.comb)return t.abrupt("return",this._getCombAppearance(d,_,A,p,l,v));t.next=30;break;case 30:if(0===m||2<m)return t.abrupt("return","/Tx BMC q BT "+d+" 1 0 0 1 ".concat(l," ").concat(v," Tm (").concat((0,_util.escapeString)(A),") Tj")+" ET Q EMC");t.next=32;break;case 32:return b=this._renderText(A,_,y,p,m,l,v),t.abrupt("return","/Tx BMC q BT "+d+" 1 0 0 1 0 0 Tm ".concat(b)+" ET Q EMC");case 34:case"end":return t.stop()}},t,this)})),function(t,e,r){return a.apply(this,arguments)})},{key:"_getFontData",value:(r=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r){var a,n,i,o,s;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=new _operator_list.OperatorList,n={font:null,clone:function(){return this}},i=this.data.defaultAppearanceData,o=i.fontName,s=i.fontSize,t.next=5,e.handleSetFont(this._fieldResources.mergedResources,[o&&_primitives.Name.get(o),s],null,a,r,n,null);case 5:return t.abrupt("return",n.font);case 6:case"end":return t.stop()}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"_computeFontSize",value:function(t,e){var r=this.data.defaultAppearanceData.fontSize;if(!r){var a=function(t){return Math.round(10*t)/10};if(-1===e)r=a(.8*t);else{var n=(r=10)/.8,i=Math.round(t/n);r=a(.8*(n=t/(i=Math.max(i,e))))}var o=this.data.defaultAppearanceData,s=o.fontName,c=o.fontColor;this._defaultAppearance=(0,_default_appearance.createDefaultAppearance)({fontSize:r,fontName:s,fontColor:c})}return[this._defaultAppearance,r]}},{key:"_renderText",value:function(t,e,r,a,n,i,o){var s,c,l=r/1e3,u=0,p=_createForOfIteratorHelper(e.charsToGlyphs(t));try{for(p.s();!(s=p.n()).done;){u+=s.value.width*l}}catch(t){p.e(t)}finally{p.f()}return c=(c=1===n?(a-u)/2:2===n?a-u-i:i).toFixed(2),o=o.toFixed(2),"".concat(c," ").concat(o," Td (").concat((0,_util.escapeString)(t),") Tj")}},{key:"_getSaveFieldResources",value:function(t){var e=this._fieldResources,r=e.localResources,a=e.appearanceResources,n=e.acroFormResources,i=this.data.defaultAppearanceData&&this.data.defaultAppearanceData.fontName;if(!i)return r||_primitives.Dict.empty;for(var o=0,s=[r,a];o<s.length;o++){var c=s[o];if(c instanceof _primitives.Dict){var l=c.get("Font");if(l instanceof _primitives.Dict&&l.has(i))return c}}if(n instanceof _primitives.Dict){var u=n.get("Font");if(u instanceof _primitives.Dict&&u.has(i)){var p=new _primitives.Dict(t);p.set(i,u.getRaw(i));var h=new _primitives.Dict(t);return h.set("Font",p),_primitives.Dict.merge({xref:t,dictArray:[h,r],mergeSubDicts:!0})}}return r||_primitives.Dict.empty}},{key:"getFieldObject",value:function(){return"Sig"===this.data.fieldType?{id:this.data.id,value:null,type:"signature"}:null}}]),h}(),TextWidgetAnnotation=function(t){_inherits(o,WidgetAnnotation);var i=_createSuper(o);function o(t){var e;_classCallCheck(this,o),(e=i.call(this,t))._hasText=!0;var r=t.dict;(0,_util.isString)(e.data.fieldValue)||(e.data.fieldValue="");var a=(0,_core_utils.getInheritableProperty)({dict:r,key:"Q"});(!Number.isInteger(a)||a<0||2<a)&&(a=null),e.data.textAlignment=a;var n=(0,_core_utils.getInheritableProperty)({dict:r,key:"MaxLen"});return(!Number.isInteger(n)||n<0)&&(n=null),e.data.maxLen=n,e.data.multiLine=e.hasFieldFlag(_util.AnnotationFieldFlag.MULTILINE),e.data.comb=e.hasFieldFlag(_util.AnnotationFieldFlag.COMB)&&!e.hasFieldFlag(_util.AnnotationFieldFlag.MULTILINE)&&!e.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD)&&!e.hasFieldFlag(_util.AnnotationFieldFlag.FILESELECT)&&null!==e.data.maxLen,e}return _createClass(o,[{key:"_getCombAppearance",value:function(t,e,r,a,n,i){var o,s=(a/this.data.maxLen).toFixed(2),c=[],l=_createForOfIteratorHelper(e.getCharPositions(r));try{for(l.s();!(o=l.n()).done;){var u=_slicedToArray(o.value,2),p=u[0],h=u[1];c.push("(".concat((0,_util.escapeString)(r.substring(p,h)),") Tj"))}}catch(t){l.e(t)}finally{l.f()}var f=c.join(" ".concat(s," 0 Td "));return"/Tx BMC q BT "+t+" 1 0 0 1 ".concat(n," ").concat(i," Tm ").concat(f)+" ET Q EMC"}},{key:"_getMultilineAppearance",value:function(t,e,r,a,n,i,o,s,c){var l,u=[],p=n-2*s,h=_createForOfIteratorHelper(e.split(/\r\n|\r|\n/));try{for(h.s();!(l=h.n()).done;){var f,d=l.value,y=_createForOfIteratorHelper(this._splitLine(d,r,a,p));try{for(y.s();!(f=y.n()).done;){var _=f.value,g=0===u.length?s:0;u.push(this._renderText(_,r,a,n,o,g,-a))}}catch(t){y.e(t)}finally{y.f()}}}catch(t){h.e(t)}finally{h.f()}var v=u.join("\n");return"/Tx BMC q BT "+t+" 1 0 0 1 0 ".concat(i," Tm ").concat(v)+" ET Q EMC"}},{key:"_splitLine",value:function(t,e,r,a){t=e.encodeString(t).join("");var n=e.charsToGlyphs(t);if(n.length<=1)return[t];for(var i=e.getCharPositions(t),o=r/1e3,s=[],c=-1,l=-1,u=-1,p=0,h=0,f=0,d=n.length;f<d;f++){var y=_slicedToArray(i[f],2),_=y[0],g=y[1],v=n[f],m=v.width*o;" "===v.unicode?u=a<h+m?(s.push(t.substring(p,_)),p=_,h=m,c=-1):(h+=m,c=_,l=g,f):a<h+m?h=-1!==c?(s.push(t.substring(p,l)),p=l,f=u+1,c=-1,0):(s.push(t.substring(p,_)),p=_,m):h+=m}return p<t.length&&s.push(t.substring(p,t.length)),s}},{key:"getFieldObject",value:function(){return{id:this.data.id,value:this.data.fieldValue,defaultValue:this.data.defaultFieldValue,multiline:this.data.multiLine,password:this.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD),charLimit:this.data.maxLen,comb:this.data.comb,editable:!this.data.readOnly,hidden:this.data.hidden,name:this.data.fieldName,rect:this.data.rect,actions:this.data.actions,type:"text"}}}]),o}(),ButtonWidgetAnnotation=function(t){_inherits(l,WidgetAnnotation);var a,n,i,r=_createSuper(l);function l(t){var e;return _classCallCheck(this,l),(e=r.call(this,t)).checkedAppearance=null,e.uncheckedAppearance=null,e.data.checkBox=!e.hasFieldFlag(_util.AnnotationFieldFlag.RADIO)&&!e.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),e.data.radioButton=e.hasFieldFlag(_util.AnnotationFieldFlag.RADIO)&&!e.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),e.data.pushButton=e.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),e.data.isTooltipOnly=!1,e.data.checkBox?e._processCheckBox(t):e.data.radioButton?e._processRadioButton(t):e.data.pushButton?e._processPushButton(t):(0,_util.warn)("Invalid field flags for button widget annotation"),e}return _createClass(l,[{key:"getOperatorList",value:function(t,e,r,a){if(this.data.pushButton)return _get(_getPrototypeOf(l.prototype),"getOperatorList",this).call(this,t,e,!1,a);if(a){var n,i=a.get(this.data.id),o=i&&i.value;if(void 0===o)return _get(_getPrototypeOf(l.prototype),"getOperatorList",this).call(this,t,e,r,a);if(n=o?this.checkedAppearance:this.uncheckedAppearance){var s=this.appearance;this.appearance=n;var c=_get(_getPrototypeOf(l.prototype),"getOperatorList",this).call(this,t,e,r,a);return this.appearance=s,c}return Promise.resolve(new _operator_list.OperatorList)}return _get(_getPrototypeOf(l.prototype),"getOperatorList",this).call(this,t,e,r,a)}},{key:"save",value:(i=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r,a){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.data.checkBox)return t.abrupt("return",this._saveCheckbox(e,r,a));t.next=2;break;case 2:if(this.data.radioButton)return t.abrupt("return",this._saveRadioButton(e,r,a));t.next=4;break;case 4:return t.abrupt("return",null);case 5:case"end":return t.stop()}},t,this)})),function(t,e,r){return i.apply(this,arguments)})},{key:"_saveCheckbox",value:(n=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r,a){var n,i,o,s,c,l,u,p;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a){t.next=2;break}return t.abrupt("return",null);case 2:if(n=a.get(this.data.id),void 0===(i=n&&n.value))return t.abrupt("return",null);t.next=6;break;case 6:if((this.data.fieldValue&&"Off"!==this.data.fieldValue)===i)return t.abrupt("return",null);t.next=9;break;case 9:if(o=e.xref.fetchIfRef(this.ref),(0,_primitives.isDict)(o)){t.next=12;break}return t.abrupt("return",null);case 12:return s={path:(0,_util.stringToPDFString)(o.get("T")||""),value:i?this.data.exportValue:""},c=_primitives.Name.get(i?this.data.exportValue:"Off"),o.set("V",c),o.set("AS",c),o.set("M","D:".concat((0,_util.getModificationDate)())),l=e.xref.encrypt,u=null,l&&(u=l.createCipherTransform(this.ref.num,this.ref.gen)),p=["".concat(this.ref.num," ").concat(this.ref.gen," obj\n")],(0,_writer.writeDict)(o,p,u),p.push("\nendobj\n"),t.abrupt("return",[{ref:this.ref,data:p.join(""),xfa:s}]);case 24:case"end":return t.stop()}},t,this)})),function(t,e,r){return n.apply(this,arguments)})},{key:"_saveRadioButton",value:(a=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,r,a){var n,i,o,s,c,l,u,p,h,f,d,y;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a){t.next=2;break}return t.abrupt("return",null);case 2:if(n=a.get(this.data.id),void 0===(i=n&&n.value))return t.abrupt("return",null);t.next=6;break;case 6:if(this.data.fieldValue===this.data.buttonValue===i)return t.abrupt("return",null);t.next=9;break;case 9:if(o=e.xref.fetchIfRef(this.ref),(0,_primitives.isDict)(o)){t.next=12;break}return t.abrupt("return",null);case 12:return s={path:(0,_util.stringToPDFString)(o.get("T")||""),value:i?this.data.buttonValue:""},c=_primitives.Name.get(i?this.data.buttonValue:"Off"),l=null,u=e.xref.encrypt,i&&((0,_primitives.isRef)(this.parent)?(p=e.xref.fetch(this.parent),h=null,u&&(h=u.createCipherTransform(this.parent.num,this.parent.gen)),p.set("V",c),l=["".concat(this.parent.num," ").concat(this.parent.gen," obj\n")],(0,_writer.writeDict)(p,l,h),l.push("\nendobj\n")):(0,_primitives.isDict)(this.parent)&&this.parent.set("V",c)),o.set("AS",c),o.set("M","D:".concat((0,_util.getModificationDate)())),f=null,u&&(f=u.createCipherTransform(this.ref.num,this.ref.gen)),d=["".concat(this.ref.num," ").concat(this.ref.gen," obj\n")],(0,_writer.writeDict)(o,d,f),d.push("\nendobj\n"),y=[{ref:this.ref,data:d.join(""),xfa:s}],null!==l&&y.push({ref:this.parent,data:l.join(""),xfa:null}),t.abrupt("return",y);case 27:case"end":return t.stop()}},t,this)})),function(t,e,r){return a.apply(this,arguments)})},{key:"_processCheckBox",value:function(t){var e=t.dict.get("AP");if((0,_primitives.isDict)(e)){var r=e.get("N");if((0,_primitives.isDict)(r)){var a=r.getKeys();a.includes("Off")||a.push("Off"),2===a.length&&(this.data.exportValue="Off"===a[0]?a[1]:a[0],this.checkedAppearance=r.get(this.data.exportValue),this.uncheckedAppearance=r.get("Off")||null,this._streams.push(this.checkedAppearance),this.uncheckedAppearance&&this._streams.push(this.uncheckedAppearance),this._fallbackFontDict=this.fallbackFontDict)}}}},{key:"_processRadioButton",value:function(t){this.data.fieldValue=this.data.buttonValue=null;var e=t.dict.get("Parent");if((0,_primitives.isDict)(e)){this.parent=t.dict.getRaw("Parent");var r=e.get("V");(0,_primitives.isName)(r)&&(this.data.fieldValue=this._decodeFormValue(r))}var a=t.dict.get("AP");if((0,_primitives.isDict)(a)){var n=a.get("N");if((0,_primitives.isDict)(n)){var i,o=_createForOfIteratorHelper(n.getKeys());try{for(o.s();!(i=o.n()).done;){var s=i.value;if("Off"!==s){this.data.buttonValue=this._decodeFormValue(s);break}}}catch(t){o.e(t)}finally{o.f()}this.checkedAppearance=n.get(this.data.buttonValue),this.uncheckedAppearance=n.get("Off")||null,this._streams.push(this.checkedAppearance),this.uncheckedAppearance&&this._streams.push(this.uncheckedAppearance),this._fallbackFontDict=this.fallbackFontDict}}}},{key:"_processPushButton",value:function(t){t.dict.has("A")||t.dict.has("AA")||this.data.alternativeText?(this.data.isTooltipOnly=!t.dict.has("A")&&!t.dict.has("AA"),_obj.Catalog.parseDestDictionary({destDict:t.dict,resultObj:this.data,docBaseUrl:t.pdfManager.docBaseUrl})):(0,_util.warn)("Push buttons without action dictionaries are not supported")}},{key:"getFieldObject",value:function(){var t,e="button";return this.data.checkBox?(e="checkbox",t=this.data.exportValue):this.data.radioButton&&(e="radiobutton",t=this.data.buttonValue),{id:this.data.id,value:this.data.fieldValue||"Off",defaultValue:this.data.defaultFieldValue,exportValues:t,editable:!this.data.readOnly,name:this.data.fieldName,rect:this.data.rect,hidden:this.data.hidden,actions:this.data.actions,type:e}}},{key:"fallbackFontDict",get:function(){var t=new _primitives.Dict;return t.set("BaseFont",_primitives.Name.get("ZapfDingbats")),t.set("Type",_primitives.Name.get("FallbackType")),t.set("Subtype",_primitives.Name.get("FallbackType")),t.set("Encoding",_primitives.Name.get("ZapfDingbatsEncoding")),(0,_util.shadow)(this,"fallbackFontDict",t)}}]),l}(),ChoiceWidgetAnnotation=function(t){_inherits(l,WidgetAnnotation);var c=_createSuper(l);function l(t){var e;_classCallCheck(this,l),(e=c.call(this,t)).data.options=[];var r=(0,_core_utils.getInheritableProperty)({dict:t.dict,key:"Opt"});if(Array.isArray(r))for(var a=t.xref,n=0,i=r.length;n<i;n++){var o=a.fetchIfRef(r[n]),s=Array.isArray(o);e.data.options[n]={exportValue:e._decodeFormValue(s?a.fetchIfRef(o[0]):o),displayValue:e._decodeFormValue(s?a.fetchIfRef(o[1]):o)}}return(0,_util.isString)(e.data.fieldValue)?e.data.fieldValue=[e.data.fieldValue]:e.data.fieldValue||(e.data.fieldValue=[]),e.data.combo=e.hasFieldFlag(_util.AnnotationFieldFlag.COMBO),e.data.multiSelect=e.hasFieldFlag(_util.AnnotationFieldFlag.MULTISELECT),e._hasText=!0,e}return _createClass(l,[{key:"getFieldObject",value:function(){var t=this.data.combo?"combobox":"listbox",e=0<this.data.fieldValue.length?this.data.fieldValue[0]:null;return{id:this.data.id,value:e,defaultValue:this.data.defaultFieldValue,editable:!this.data.readOnly,name:this.data.fieldName,rect:this.data.rect,numItems:this.data.fieldValue.length,multipleSelection:this.data.multiSelect,hidden:this.data.hidden,actions:this.data.actions,items:this.data.options,type:t}}}]),l}(),TextAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var e;_classCallCheck(this,n);e=a.call(this,t);var r=t.dict;return e.data.annotationType=_util.AnnotationType.TEXT,e.data.hasAppearance?e.data.name="NoIcon":(e.data.rect[1]=e.data.rect[3]-22,e.data.rect[2]=e.data.rect[0]+22,e.data.name=r.has("Name")?r.get("Name").name:"Note"),r.has("State")?(e.data.state=r.get("State")||null,e.data.stateModel=r.get("StateModel")||null):(e.data.state=null,e.data.stateModel=null),e}return _createClass(n)}(),LinkAnnotation=function(t){_inherits(n,Annotation);var a=_createSuper(n);function n(t){var e;_classCallCheck(this,n),(e=a.call(this,t)).data.annotationType=_util.AnnotationType.LINK;var r=getQuadPoints(t.dict,e.rectangle);return r&&(e.data.quadPoints=r),_obj.Catalog.parseDestDictionary({destDict:t.dict,resultObj:e.data,docBaseUrl:t.pdfManager.docBaseUrl}),e}return _createClass(n)}(),PopupAnnotation=function(t){_inherits(l,Annotation);var c=_createSuper(l);function l(t){var e;_classCallCheck(this,l),(e=c.call(this,t)).data.annotationType=_util.AnnotationType.POPUP;var r=t.dict.get("Parent");if(!r)return(0,_util.warn)("Popup annotation has a missing or invalid parent annotation."),_possibleConstructorReturn(e);var a=r.get("Subtype");e.data.parentType=(0,_primitives.isName)(a)?a.name:null;var n=t.dict.getRaw("Parent");e.data.parentId=(0,_primitives.isRef)(n)?n.toString():null;var i=r.getArray("Rect");Array.isArray(i)&&4===i.length?e.data.parentRect=_util.Util.normalizeRect(i):e.data.parentRect=[0,0,0,0];var o=r.get("RT");if((0,_primitives.isName)(o,_util.AnnotationReplyType.GROUP)&&(r=r.get("IRT")),r.has("M")?(e.setModificationDate(r.get("M")),e.data.modificationDate=e.modificationDate):e.data.modificationDate=null,r.has("C")?(e.setColor(r.getArray("C")),e.data.color=e.color):e.data.color=null,!e.viewable){var s=r.get("F");e._isViewable(s)&&e.setFlags(s)}return e.data.title=(0,_util.stringToPDFString)(r.get("T")||""),e.data.contents=(0,_util.stringToPDFString)(r.get("Contents")||""),e}return _createClass(l)}(),FreeTextAnnotation=function(t){_inherits(a,MarkupAnnotation);var r=_createSuper(a);function a(t){var e;return _classCallCheck(this,a),(e=r.call(this,t)).data.annotationType=_util.AnnotationType.FREETEXT,e}return _createClass(a)}(),LineAnnotation=function(t){_inherits(o,MarkupAnnotation);var i=_createSuper(o);function o(t){var e;_classCallCheck(this,o),(e=i.call(this,t)).data.annotationType=_util.AnnotationType.LINE;var r=t.dict.getArray("L");if(e.data.lineCoordinates=_util.Util.normalizeRect(r),!e.appearance){var a=e.color?Array.from(e.color).map(function(t){return t/255}):[0,0,0],n=e.borderStyle.width;(0,_util.isArrayEqual)(e.rectangle,[0,0,0,0])&&(e.rectangle=[e.data.lineCoordinates[0]-2*n,e.data.lineCoordinates[1]-2*n,e.data.lineCoordinates[2]+2*n,e.data.lineCoordinates[3]+2*n]),e._setDefaultAppearance({xref:t.xref,extra:"".concat(n," w"),strokeColor:a,pointsCallback:function(t,e){return t.push("".concat(r[0]," ").concat(r[1]," m")),t.push("".concat(r[2]," ").concat(r[3]," l")),t.push("S"),[e[0].x-n,e[1].x+n,e[3].y-n,e[1].y+n]}})}return e}return _createClass(o)}(),SquareAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var o;if(_classCallCheck(this,n),(o=a.call(this,t)).data.annotationType=_util.AnnotationType.SQUARE,!o.appearance){var e=o.color?Array.from(o.color).map(function(t){return t/255}):[0,0,0],s=null,r=t.dict.getArray("IC");r&&(r=getRgbColor(r),s=r?Array.from(r).map(function(t){return t/255}):null),o._setDefaultAppearance({xref:t.xref,extra:"".concat(o.borderStyle.width," w"),strokeColor:e,fillColor:s,pointsCallback:function(t,e){var r=e[2].x+o.borderStyle.width/2,a=e[2].y+o.borderStyle.width/2,n=e[3].x-e[2].x-o.borderStyle.width,i=e[1].y-e[3].y-o.borderStyle.width;return t.push("".concat(r," ").concat(a," ").concat(n," ").concat(i," re")),s?t.push("B"):t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}return o}return _createClass(n)}(),CircleAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var u;if(_classCallCheck(this,n),(u=a.call(this,t)).data.annotationType=_util.AnnotationType.CIRCLE,!u.appearance){var e=u.color?Array.from(u.color).map(function(t){return t/255}):[0,0,0],p=null,r=t.dict.getArray("IC");r&&(r=getRgbColor(r),p=r?Array.from(r).map(function(t){return t/255}):null);var h=4/3*Math.tan(Math.PI/8);u._setDefaultAppearance({xref:t.xref,extra:"".concat(u.borderStyle.width," w"),strokeColor:e,fillColor:p,pointsCallback:function(t,e){var r=e[0].x+u.borderStyle.width/2,a=e[0].y-u.borderStyle.width/2,n=e[3].x-u.borderStyle.width/2,i=e[3].y+u.borderStyle.width/2,o=r+(n-r)/2,s=a+(i-a)/2,c=(n-r)/2*h,l=(i-a)/2*h;return t.push("".concat(o," ").concat(i," m")),t.push("".concat(o+c," ").concat(i," ").concat(n," ").concat(s+l," ").concat(n," ").concat(s," c")),t.push("".concat(n," ").concat(s-l," ").concat(o+c," ").concat(a," ").concat(o," ").concat(a," c")),t.push("".concat(o-c," ").concat(a," ").concat(r," ").concat(s-l," ").concat(r," ").concat(s," c")),t.push("".concat(r," ").concat(s+l," ").concat(o-c," ").concat(i," ").concat(o," ").concat(i," c")),t.push("h"),p?t.push("B"):t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}return u}return _createClass(n)}(),PolylineAnnotation=function(t){_inherits(o,MarkupAnnotation);var i=_createSuper(o);function o(t){var e;_classCallCheck(this,o),(e=i.call(this,t)).data.annotationType=_util.AnnotationType.POLYLINE,e.data.vertices=[];var r=t.dict.getArray("Vertices");if(!Array.isArray(r))return _possibleConstructorReturn(e);for(var a=0,n=r.length;a<n;a+=2)e.data.vertices.push({x:r[a],y:r[a+1]});return e}return _createClass(o)}(),PolygonAnnotation=function(t){_inherits(a,PolylineAnnotation);var r=_createSuper(a);function a(t){var e;return _classCallCheck(this,a),(e=r.call(this,t)).data.annotationType=_util.AnnotationType.POLYGON,e}return _createClass(a)}(),CaretAnnotation=function(t){_inherits(a,MarkupAnnotation);var r=_createSuper(a);function a(t){var e;return _classCallCheck(this,a),(e=r.call(this,t)).data.annotationType=_util.AnnotationType.CARET,e}return _createClass(a)}(),InkAnnotation=function(t){_inherits(l,MarkupAnnotation);var c=_createSuper(l);function l(t){var e;_classCallCheck(this,l),(e=c.call(this,t)).data.annotationType=_util.AnnotationType.INK,e.data.inkLists=[];var r=t.dict.getArray("InkList");if(!Array.isArray(r))return _possibleConstructorReturn(e);for(var a=t.xref,n=0,i=r.length;n<i;++n){e.data.inkLists.push([]);for(var o=0,s=r[n].length;o<s;o+=2)e.data.inkLists[n].push({x:a.fetchIfRef(r[n][o]),y:a.fetchIfRef(r[n][o+1])})}return e}return _createClass(l)}(),HighlightAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var e;if(_classCallCheck(this,n),(e=a.call(this,t)).data.annotationType=_util.AnnotationType.HIGHLIGHT,e.data.quadPoints=getQuadPoints(t.dict,null)){if(!e.appearance){var r=e.color?Array.from(e.color).map(function(t){return t/255}):[1,1,0];e._setDefaultAppearance({xref:t.xref,fillColor:r,blendMode:"Multiply",pointsCallback:function(t,e){return t.push("".concat(e[0].x," ").concat(e[0].y," m")),t.push("".concat(e[1].x," ").concat(e[1].y," l")),t.push("".concat(e[3].x," ").concat(e[3].y," l")),t.push("".concat(e[2].x," ").concat(e[2].y," l")),t.push("f"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}}else e.data.hasPopup=!1;return e}return _createClass(n)}(),UnderlineAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var e;if(_classCallCheck(this,n),(e=a.call(this,t)).data.annotationType=_util.AnnotationType.UNDERLINE,e.data.quadPoints=getQuadPoints(t.dict,null)){if(!e.appearance){var r=e.color?Array.from(e.color).map(function(t){return t/255}):[0,0,0];e._setDefaultAppearance({xref:t.xref,extra:"[] 0 d 1 w",strokeColor:r,pointsCallback:function(t,e){return t.push("".concat(e[2].x," ").concat(e[2].y," m")),t.push("".concat(e[3].x," ").concat(e[3].y," l")),t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}}else e.data.hasPopup=!1;return e}return _createClass(n)}(),SquigglyAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var e;if(_classCallCheck(this,n),(e=a.call(this,t)).data.annotationType=_util.AnnotationType.SQUIGGLY,e.data.quadPoints=getQuadPoints(t.dict,null)){if(!e.appearance){var r=e.color?Array.from(e.color).map(function(t){return t/255}):[0,0,0];e._setDefaultAppearance({xref:t.xref,extra:"[] 0 d 1 w",strokeColor:r,pointsCallback:function(t,e){var r=(e[0].y-e[2].y)/6,a=r,n=e[2].x,i=e[2].y,o=e[3].x;for(t.push("".concat(n," ").concat(i+a," m"));n+=2,a=0===a?r:0,t.push("".concat(n," ").concat(i+a," l")),n<o;);return t.push("S"),[e[2].x,o,i-2*r,i+2*r]}})}}else e.data.hasPopup=!1;return e}return _createClass(n)}(),StrikeOutAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var e;if(_classCallCheck(this,n),(e=a.call(this,t)).data.annotationType=_util.AnnotationType.STRIKEOUT,e.data.quadPoints=getQuadPoints(t.dict,null)){if(!e.appearance){var r=e.color?Array.from(e.color).map(function(t){return t/255}):[0,0,0];e._setDefaultAppearance({xref:t.xref,extra:"[] 0 d 1 w",strokeColor:r,pointsCallback:function(t,e){return t.push("".concat((e[0].x+e[2].x)/2)+" ".concat((e[0].y+e[2].y)/2," m")),t.push("".concat((e[1].x+e[3].x)/2)+" ".concat((e[1].y+e[3].y)/2," l")),t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}}else e.data.hasPopup=!1;return e}return _createClass(n)}(),StampAnnotation=function(t){_inherits(a,MarkupAnnotation);var r=_createSuper(a);function a(t){var e;return _classCallCheck(this,a),(e=r.call(this,t)).data.annotationType=_util.AnnotationType.STAMP,e}return _createClass(a)}(),FileAttachmentAnnotation=function(t){_inherits(n,MarkupAnnotation);var a=_createSuper(n);function n(t){var e;_classCallCheck(this,n),e=a.call(this,t);var r=new _obj.FileSpec(t.dict.get("FS"),t.xref);return e.data.annotationType=_util.AnnotationType.FILEATTACHMENT,e.data.file=r.serializable,e}return _createClass(n)}();