"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,_toPropertyKey(a.key),a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var a=r.call(e,t||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Type1Parser=void 0;var _encodings=require("./encodings.js"),_core_utils=require("./core_utils.js"),_stream=require("./stream.js"),_util=require("../shared/util.js"),HINTING_ENABLED=!1,Type1CharString=function(){var d=[1],m=[3],v=[4],y=[5],C=[6],T=[7],x=[8],_=[12,35],S=[14],I=[21],N=[22],w=[30],B=[31];return function(){function e(){_classCallCheck(this,e),this.width=0,this.lsb=0,this.flexing=!1,this.output=[],this.stack=[]}return _createClass(e,[{key:"convert",value:function(e,t,r){for(var a,s,i,n=e.length,o=!1,h=0;h<n;h++){var c=e[h];if(c<32){switch(12===c&&(c=(c<<8)+e[++h]),c){case 1:if(!HINTING_ENABLED){this.stack=[];break}o=this.executeCommand(2,d);break;case 3:if(!HINTING_ENABLED){this.stack=[];break}o=this.executeCommand(2,m);break;case 4:if(this.flexing){if(this.stack.length<1){o=!0;break}var u=this.stack.pop();this.stack.push(0,u);break}o=this.executeCommand(1,v);break;case 5:o=this.executeCommand(2,y);break;case 6:o=this.executeCommand(1,C);break;case 7:o=this.executeCommand(1,T);break;case 8:o=this.executeCommand(6,x);break;case 9:this.stack=[];break;case 10:if(this.stack.length<1){o=!0;break}if(!t[i=this.stack.pop()]){o=!0;break}o=this.convert(t[i],t,r);break;case 11:return o;case 13:if(this.stack.length<2){o=!0;break}a=this.stack.pop(),s=this.stack.pop(),this.lsb=s,this.width=a,this.stack.push(a,s),o=this.executeCommand(2,N);break;case 14:this.output.push(S[0]);break;case 21:if(this.flexing)break;o=this.executeCommand(2,I);break;case 22:if(this.flexing){this.stack.push(0);break}o=this.executeCommand(1,N);break;case 30:o=this.executeCommand(4,w);break;case 31:o=this.executeCommand(4,B);break;case 3072:this.stack=[];break;case 3073:if(!HINTING_ENABLED){this.stack=[];break}o=this.executeCommand(2,m);break;case 3074:if(!HINTING_ENABLED){this.stack=[];break}o=this.executeCommand(2,d);break;case 3078:if(r){var l=this.stack[this.stack.length-5];this.seac=this.stack.splice(-4,4),this.seac[0]+=this.lsb-l,o=this.executeCommand(0,S)}else o=this.executeCommand(4,S);break;case 3079:if(this.stack.length<4){o=!0;break}this.stack.pop(),a=this.stack.pop();var k=this.stack.pop();s=this.stack.pop(),this.lsb=s,this.width=a,this.stack.push(a,s,k),o=this.executeCommand(3,I);break;case 3084:if(this.stack.length<2){o=!0;break}var p=this.stack.pop(),f=this.stack.pop();this.stack.push(f/p);break;case 3088:if(this.stack.length<2){o=!0;break}i=this.stack.pop();var g=this.stack.pop();if(0===i&&3===g){var b=this.stack.splice(this.stack.length-17,17);this.stack.push(b[2]+b[0],b[3]+b[1],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],b[12],b[13],b[14]),o=this.executeCommand(13,_,!0),this.flexing=!1,this.stack.push(b[15],b[16])}else 1===i&&0===g&&(this.flexing=!0);break;case 3089:break;case 3105:this.stack=[];break;default:(0,_util.warn)('Unknown type 1 charstring command of "'+c+'"')}if(o)break}else c<=246?c-=139:c=c<=250?256*(c-247)+e[++h]+108:c<=254?-256*(c-251)-e[++h]-108:(255&e[++h])<<24|(255&e[++h])<<16|(255&e[++h])<<8|(255&e[++h])<<0,this.stack.push(c)}return o}},{key:"executeCommand",value:function(e,t,r){var a=this.stack.length;if(a<e)return!0;for(var s=a-e,i=s;i<a;i++){var n=this.stack[i];Number.isInteger(n)?this.output.push(28,n>>8&255,255&n):(n=65536*n|0,this.output.push(255,n>>24&255,n>>16&255,n>>8&255,255&n))}return this.output.push.apply(this.output,t),r?this.stack.splice(s,e):this.stack.length=0,!1}}]),e}()}(),Type1Parser=function(){function l(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function n(e,t,r){if(r>=e.length)return new Uint8Array(0);var a,s,i=0|t;for(a=0;a<r;a++)i=52845*(e[a]+i)+22719&65535;var n=e.length-r,o=new Uint8Array(n);for(a=r,s=0;s<n;a++,s++){var h=e[a];o[s]=h^i>>8,i=52845*(h+i)+22719&65535}return o}function a(e){return 47===e||91===e||93===e||123===e||125===e||40===e||41===e}return function(){function i(e,t,r){if(_classCallCheck(this,i),t){var a=e.getBytes(),s=!((l(a[0])||(0,_core_utils.isWhiteSpace)(a[0]))&&l(a[1])&&l(a[2])&&l(a[3])&&l(a[4])&&l(a[5])&&l(a[6])&&l(a[7]));e=new _stream.Stream(s?n(a,55665,4):function(e,t,r){var a,s,i=0|t,n=e.length,o=new Uint8Array(n>>>1);for(s=a=0;a<n;a++){var h=e[a];if(l(h)){a++;for(var c=void 0;a<n&&!l(c=e[a]);)a++;if(a<n){var u=parseInt(String.fromCharCode(h,c),16);o[s++]=u^i>>8,i=52845*(u+i)+22719&65535}}}return o.slice(r,s)}(a,55665,4))}this.seacAnalysisEnabled=!!r,this.stream=e,this.nextChar()}return _createClass(i,[{key:"readNumberArray",value:function(){this.getToken();for(var e=[];;){var t=this.getToken();if(null===t||"]"===t||"}"===t)break;e.push(parseFloat(t||0))}return e}},{key:"readNumber",value:function(){var e=this.getToken();return parseFloat(e||0)}},{key:"readInt",value:function(){var e=this.getToken();return 0|parseInt(e||0,10)}},{key:"readBoolean",value:function(){return"true"===this.getToken()?1:0}},{key:"nextChar",value:function(){return this.currentChar=this.stream.getByte()}},{key:"getToken",value:function(){for(var e=!1,t=this.currentChar;;){if(-1===t)return null;if(e)10!==t&&13!==t||(e=!1);else if(37===t)e=!0;else if(!(0,_core_utils.isWhiteSpace)(t))break;t=this.nextChar()}if(a(t))return this.nextChar(),String.fromCharCode(t);for(var r="";r+=String.fromCharCode(t),0<=(t=this.nextChar())&&!(0,_core_utils.isWhiteSpace)(t)&&!a(t););return r}},{key:"readCharStrings",value:function(e,t){return-1===t?e:n(e,4330,t)}},{key:"extractFontProgram",value:function(e){var t=this.stream,r=[],a=[],s=Object.create(null);s.lenIV=4;for(var i,n,o,h,c,u={subrs:[],charstrings:[],properties:{privateData:s}};null!==(i=this.getToken());)if("/"===i)switch(i=this.getToken()){case"CharStrings":for(this.getToken(),this.getToken(),this.getToken(),this.getToken();null!==(i=this.getToken())&&"end"!==i;)if("/"===i){var l=this.getToken();n=this.readInt(),this.getToken(),o=0<n?t.getBytes(n):new Uint8Array(0),h=u.properties.privateData.lenIV,c=this.readCharStrings(o,h),this.nextChar(),"noaccess"===(i=this.getToken())&&this.getToken(),a.push({glyph:l,encoded:c})}break;case"Subrs":for(this.readInt(),this.getToken();"dup"===this.getToken();){var k=this.readInt();n=this.readInt(),this.getToken(),o=0<n?t.getBytes(n):new Uint8Array(0),h=u.properties.privateData.lenIV,c=this.readCharStrings(o,h),this.nextChar(),"noaccess"===(i=this.getToken())&&this.getToken(),r[k]=c}break;case"BlueValues":case"OtherBlues":case"FamilyBlues":case"FamilyOtherBlues":var p=this.readNumberArray();0<p.length&&p.length%2==0&&HINTING_ENABLED&&(u.properties.privateData[i]=p);break;case"StemSnapH":case"StemSnapV":u.properties.privateData[i]=this.readNumberArray();break;case"StdHW":case"StdVW":u.properties.privateData[i]=this.readNumberArray()[0];break;case"BlueShift":case"lenIV":case"BlueFuzz":case"BlueScale":case"LanguageGroup":case"ExpansionFactor":u.properties.privateData[i]=this.readNumber();break;case"ForceBold":u.properties.privateData[i]=this.readBoolean()}for(var f=0;f<a.length;f++){var g=a[f].glyph;c=a[f].encoded;var b=new Type1CharString,d=b.convert(c,r,this.seacAnalysisEnabled),m=b.output;d&&(m=[14]);var v={glyphName:g,charstring:m,width:b.width,lsb:b.lsb,seac:b.seac};if(".notdef"===g?u.charstrings.unshift(v):u.charstrings.push(v),e.builtInEncoding){var y=e.builtInEncoding.indexOf(g);-1<y&&void 0===e.widths[y]&&y>=e.firstChar&&y<=e.lastChar&&(e.widths[y]=b.width)}}return u}},{key:"extractFontHeader",value:function(e){for(var t;null!==(t=this.getToken());)if("/"===t)switch(t=this.getToken()){case"FontMatrix":var r=this.readNumberArray();e.fontMatrix=r;break;case"Encoding":var a=this.getToken(),s=void 0;if(/^\d+$/.test(a)){s=[];var i=0|parseInt(a,10);this.getToken();for(var n=0;n<i;n++){for(t=this.getToken();"dup"!==t&&"def"!==t;)if(null===(t=this.getToken()))return;if("def"===t)break;var o=this.readInt();this.getToken();var h=this.getToken();s[o]=h,this.getToken()}}else s=(0,_encodings.getEncoding)(a);e.builtInEncoding=s;break;case"FontBBox":var c=this.readNumberArray();e.ascent=Math.max(c[3],c[1]),e.descent=Math.min(c[1],c[3]),e.ascentScaled=!0}}}]),i}()}();exports.Type1Parser=Type1Parser;