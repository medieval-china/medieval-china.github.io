"use strict";function _regeneratorRuntime(){_regeneratorRuntime=function(){return o};var o={},t=Object.prototype,l=t.hasOwnProperty,f=Object.defineProperty||function(t,e,r){t[e]=r.value},e="function"==typeof Symbol?Symbol:{},i=e.iterator||"@@iterator",r=e.asyncIterator||"@@asyncIterator",n=e.toStringTag||"@@toStringTag";function a(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{a({},"")}catch(t){a=function(t,e,r){return t[e]=r}}function s(t,e,r,n){var a,o,s,u,i=e&&e.prototype instanceof y?e:y,c=Object.create(i.prototype),l=new P(n||[]);return f(c,"_invoke",{value:(a=t,o=r,s=l,u="suspendedStart",function(t,e){if("executing"===u)throw new Error("Generator is already running");if("completed"===u){if("throw"===t)throw e;return S()}for(s.method=t,s.arg=e;;){var r=s.delegate;if(r){var n=I(r,s);if(n){if(n===p)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===u)throw u="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);u="executing";var i=h(a,o,s);if("normal"===i.type){if(u=s.done?"completed":"suspendedYield",i.arg===p)continue;return{value:i.arg,done:s.done}}"throw"===i.type&&(u="completed",s.method="throw",s.arg=i.arg)}})}),c}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}o.wrap=s;var p={};function y(){}function u(){}function c(){}var d={};a(d,i,function(){return this});var g=Object.getPrototypeOf,v=g&&g(g(F([])));v&&v!==t&&l.call(v,i)&&(d=v);var _=c.prototype=y.prototype=Object.create(d);function m(t){["next","throw","return"].forEach(function(e){a(t,e,function(t){return this._invoke(e,t)})})}function b(u,c){var e;f(this,"_invoke",{value:function(r,n){function t(){return new c(function(t,e){!function e(t,r,n,i){var a=h(u[t],u,r);if("throw"!==a.type){var o=a.arg,s=o.value;return s&&"object"==_typeof(s)&&l.call(s,"__await")?c.resolve(s.__await).then(function(t){e("next",t,n,i)},function(t){e("throw",t,n,i)}):c.resolve(s).then(function(t){o.value=t,n(o)},function(t){return e("throw",t,n,i)})}i(a.arg)}(r,n,t,e)})}return e=e?e.then(t,t):t()}})}function I(t,e){var r=e.method,n=t.iterator[r];if(void 0===n)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=void 0,I(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),p;var i=h(n,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,p;var a=i.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,p):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,p)}function w(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(w,this),this.reset(!0)}function F(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,n=function t(){for(;++r<e.length;)if(l.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return n.next=n}}return{next:S}}function S(){return{value:void 0,done:!0}}return f(_,"constructor",{value:u.prototype=c,configurable:!0}),f(c,"constructor",{value:u,configurable:!0}),u.displayName=a(c,n,"GeneratorFunction"),o.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===u||"GeneratorFunction"===(e.displayName||e.name))},o.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,a(t,n,"GeneratorFunction")),t.prototype=Object.create(_),t},o.awrap=function(t){return{__await:t}},m(b.prototype),a(b.prototype,r,function(){return this}),o.AsyncIterator=b,o.async=function(t,e,r,n,i){void 0===i&&(i=Promise);var a=new b(s(t,e,r,n),i);return o.isGeneratorFunction(e)?a:a.next().then(function(t){return t.done?t.value:a.next()})},m(_),a(_,n,"Generator"),a(_,i,function(){return this}),a(_,"toString",function(){return"[object Generator]"}),o.keys=function(t){var r=Object(t),n=[];for(var e in r)n.push(e);return n.reverse(),function t(){for(;n.length;){var e=n.pop();if(e in r)return t.value=e,t.done=!1,t}return t.done=!0,t}},o.values=F,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&l.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function t(t,e){return a.type="throw",a.arg=r,n.next=t,e&&(n.method="next",n.arg=void 0),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var i=this.tryEntries[e],a=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var o=l.call(i,"catchLoc"),s=l.call(i,"finallyLoc");if(o&&s){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(o){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&l.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),x(r),p}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;x(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:F(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},o}function asyncGeneratorStep(t,e,r,n,i,a,o){try{var s=t[a](o),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,i)}function _asyncToGenerator(s){return function(){var t=this,o=arguments;return new Promise(function(e,r){var n=s.apply(t,o);function i(t){asyncGeneratorStep(n,e,r,i,a,"next",t)}function a(t){asyncGeneratorStep(n,e,r,i,a,"throw",t)}i(void 0)})}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,a,o,s=[],u=!0,c=!1;try{if(a=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=a.call(r)).done)&&(s.push(n.value),s.length!==e);u=!0);}catch(t){c=!0,i=t}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(n);if(i){var r=_getPrototypeOf(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return _possibleConstructorReturn(this,t)}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);var n=r.call(t,e||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFDocument=exports.Page=void 0;var _util=require("../shared/util.js"),_obj=require("./obj.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_stream=require("./stream.js"),_annotation=require("./annotation.js"),_crypto=require("./crypto.js"),_parser=require("./parser.js"),_operator_list=require("./operator_list.js"),_evaluator=require("./evaluator.js"),_factory=require("./xfa/factory.js"),DEFAULT_USER_UNIT=1,LETTER_SIZE_MEDIABOX=[0,0,612,792];function isAnnotationRenderable(t,e){return"display"===e&&t.viewable||"print"===e&&t.printable}var Page=function(){function p(t){var e=t.pdfManager,r=t.xref,n=t.pageIndex,i=t.pageDict,a=t.ref,o=t.globalIdFactory,s=t.fontCache,u=t.builtInCMapCache,c=t.globalImageCache,l=t.nonBlendModesSet,f=t.xfaFactory;_classCallCheck(this,p),this.pdfManager=e,this.pageIndex=n,this.pageDict=i,this.xref=r,this.ref=a,this.fontCache=s,this.builtInCMapCache=u,this.globalImageCache=c,this.nonBlendModesSet=l,this.evaluatorOptions=e.evaluatorOptions,this.resourcesPromise=null,this.xfaFactory=f;var h={obj:0};this._localIdFactory=function(t){_inherits(r,o);var e=_createSuper(r);function r(){return _classCallCheck(this,r),e.apply(this,arguments)}return _createClass(r,null,[{key:"createObjId",value:function(){return"p".concat(n,"_").concat(++h.obj)}}]),r}()}return _createClass(p,[{key:"_getInheritableProperty",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=(0,_core_utils.getInheritableProperty)({dict:this.pageDict,key:t,getArray:e,stopWhenFound:!1});return Array.isArray(r)?1!==r.length&&(0,_primitives.isDict)(r[0])?_primitives.Dict.merge({xref:this.xref,dictArray:r}):r[0]:r}},{key:"content",get:function(){return this.pageDict.get("Contents")}},{key:"resources",get:function(){return(0,_util.shadow)(this,"resources",this._getInheritableProperty("Resources")||_primitives.Dict.empty)}},{key:"_getBoundingBox",value:function(t){if(this.xfaData){var e=this.xfaData.attributes.style,r=e.width,n=e.height;return[0,0,parseInt(r),parseInt(n)]}var i=this._getInheritableProperty(t,!0);if(Array.isArray(i)&&4===i.length){if(i[2]-i[0]!=0&&i[3]-i[1]!=0)return i;(0,_util.warn)("Empty /".concat(t," entry."))}return null}},{key:"mediaBox",get:function(){return(0,_util.shadow)(this,"mediaBox",this._getBoundingBox("MediaBox")||LETTER_SIZE_MEDIABOX)}},{key:"cropBox",get:function(){return(0,_util.shadow)(this,"cropBox",this._getBoundingBox("CropBox")||this.mediaBox)}},{key:"userUnit",get:function(){var t=this.pageDict.get("UserUnit");return(!(0,_util.isNum)(t)||t<=0)&&(t=DEFAULT_USER_UNIT),(0,_util.shadow)(this,"userUnit",t)}},{key:"view",get:function(){var t,e=this.cropBox,r=this.mediaBox;if(e===r||(0,_util.isArrayEqual)(e,r))t=r;else{var n=_util.Util.intersect(e,r);n&&n[2]-n[0]!=0&&n[3]-n[1]!=0?t=n:(0,_util.warn)("Empty /CropBox and /MediaBox intersection.")}return(0,_util.shadow)(this,"view",t||r)}},{key:"rotate",get:function(){var t=this._getInheritableProperty("Rotate")||0;return t%90!=0?t=0:360<=t?t%=360:t<0&&(t=(t%360+360)%360),(0,_util.shadow)(this,"rotate",t)}},{key:"getContentStream",value:function(){var t,e=this.content;if(Array.isArray(e)){var r,n=this.xref,i=[],a=_createForOfIteratorHelper(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;i.push(n.fetchIfRef(o))}}catch(t){a.e(t)}finally{a.f()}t=new _stream.StreamsSequenceStream(i)}else t=(0,_primitives.isStream)(e)?e:new _stream.NullStream;return t}},{key:"xfaData",get:function(){return this.xfaFactory?(0,_util.shadow)(this,"xfaData",this.xfaFactory.getPage(this.pageIndex)):(0,_util.shadow)(this,"xfaData",null)}},{key:"save",value:function(t,a,o){var s=new _evaluator.PartialEvaluator({xref:this.xref,handler:t,pageIndex:this.pageIndex,idFactory:this._localIdFactory,fontCache:this.fontCache,builtInCMapCache:this.builtInCMapCache,globalImageCache:this.globalImageCache,options:this.evaluatorOptions});return this._parsedAnnotations.then(function(t){var e,r=[],n=_createForOfIteratorHelper(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;isAnnotationRenderable(i,"print")&&r.push(i.save(s,a,o).catch(function(t){return(0,_util.warn)("save - ignoring annotation data during "+'"'.concat(a.name,'" task: "').concat(t,'".')),null}))}}catch(t){n.e(t)}finally{n.f()}return Promise.all(r)})}},{key:"loadResources",value:function(t){var e=this;return this.resourcesPromise||(this.resourcesPromise=this.pdfManager.ensure(this,"resources")),this.resourcesPromise.then(function(){return new _obj.ObjectLoader(e.resources,t,e.xref).load()})}},{key:"getOperatorList",value:function(t){var n=this,i=t.handler,a=t.sink,u=t.task,c=t.intent,l=t.renderInteractiveForms,f=t.annotationStorage,e=this.pdfManager.ensure(this,"getContentStream"),r=this.loadResources(["ExtGState","ColorSpace","Pattern","Shading","XObject","Font"]),h=new _evaluator.PartialEvaluator({xref:this.xref,handler:i,pageIndex:this.pageIndex,idFactory:this._localIdFactory,fontCache:this.fontCache,builtInCMapCache:this.builtInCMapCache,globalImageCache:this.globalImageCache,options:this.evaluatorOptions}),o=Promise.all([e,r]).then(function(t){var e=_slicedToArray(t,1)[0],r=new _operator_list.OperatorList(c,a);return i.send("StartRenderPage",{transparency:h.hasBlendModes(n.resources,n.nonBlendModesSet),pageIndex:n.pageIndex,intent:c}),h.getOperatorList({stream:e,task:u,resources:n.resources,operatorList:r}).then(function(){return r})});return Promise.all([o,this._parsedAnnotations]).then(function(t){var e=_slicedToArray(t,2),i=e[0],r=e[1];if(0===r.length)return i.flush(!0),{length:i.totalLength};var n,a=[],o=_createForOfIteratorHelper(r);try{for(o.s();!(n=o.n()).done;){var s=n.value;isAnnotationRenderable(s,c)&&!s.isHidden(f)&&a.push(s.getOperatorList(h,u,l,f).catch(function(t){return(0,_util.warn)("getOperatorList - ignoring annotation data during "+'"'.concat(u.name,'" task: "').concat(t,'".')),null}))}}catch(t){o.e(t)}finally{o.f()}return Promise.all(a).then(function(t){i.addOp(_util.OPS.beginAnnotations,[]);var e,r=_createForOfIteratorHelper(t);try{for(r.s();!(e=r.n()).done;){var n=e.value;i.addOpList(n)}}catch(t){r.e(t)}finally{r.f()}return i.addOp(_util.OPS.endAnnotations,[]),i.flush(!0),{length:i.totalLength}})})}},{key:"extractTextContent",value:function(t){var r=this,n=t.handler,i=t.task,a=t.normalizeWhitespace,o=t.sink,s=t.combineTextItems,e=this.pdfManager.ensure(this,"getContentStream"),u=this.loadResources(["ExtGState","XObject","Font"]);return Promise.all([e,u]).then(function(t){var e=_slicedToArray(t,1)[0];return new _evaluator.PartialEvaluator({xref:r.xref,handler:n,pageIndex:r.pageIndex,idFactory:r._localIdFactory,fontCache:r.fontCache,builtInCMapCache:r.builtInCMapCache,globalImageCache:r.globalImageCache,options:r.evaluatorOptions}).getTextContent({stream:e,task:i,resources:r.resources,normalizeWhitespace:a,combineTextItems:s,sink:o})})}},{key:"getAnnotationsData",value:function(i){return this._parsedAnnotations.then(function(t){for(var e=[],r=0,n=t.length;r<n;r++)i&&!isAnnotationRenderable(t[r],i)||e.push(t[r].data);return e})}},{key:"annotations",get:function(){var t=this._getInheritableProperty("Annots");return(0,_util.shadow)(this,"annotations",Array.isArray(t)?t:[])}},{key:"_parsedAnnotations",get:function(){var i=this,t=this.pdfManager.ensure(this,"annotations").then(function(){var t,e=[],r=_createForOfIteratorHelper(i.annotations);try{for(r.s();!(t=r.n()).done;){var n=t.value;e.push(_annotation.AnnotationFactory.create(i.xref,n,i.pdfManager,i._localIdFactory,!1).catch(function(t){return(0,_util.warn)('_parsedAnnotations: "'.concat(t,'".')),null}))}}catch(t){r.e(t)}finally{r.f()}return Promise.all(e).then(function(t){return t.filter(function(t){return!!t})})});return(0,_util.shadow)(this,"_parsedAnnotations",t)}},{key:"jsActions",get:function(){var t=(0,_core_utils.collectActions)(this.xref,this.pageDict,_util.PageActionEventType);return(0,_util.shadow)(this,"jsActions",t)}}]),p}();exports.Page=Page;var PDF_HEADER_SIGNATURE=new Uint8Array([37,80,68,70,45]),STARTXREF_SIGNATURE=new Uint8Array([115,116,97,114,116,120,114,101,102]),ENDOBJ_SIGNATURE=new Uint8Array([101,110,100,111,98,106]),FINGERPRINT_FIRST_BYTES=1024,EMPTY_FINGERPRINT="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",PDF_HEADER_VERSION_REGEXP=/^[1-9]\.[0-9]$/;function find(t,e){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1024,n=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=e.length,a=t.peekBytes(r),o=a.length-i;if(o<=0)return!1;if(n)for(var s=i-1,u=a.length-1;s<=u;){for(var c=0;c<i&&a[u-c]===e[s-c];)c++;if(i<=c)return t.pos+=u-s,!0;u--}else for(var l=0;l<=o;){for(var f=0;f<i&&a[l+f]===e[f];)f++;if(i<=f)return t.pos+=l,!0;l++}return!1}var PDFDocument=function(){function i(e,t){var r;if(_classCallCheck(this,i),(0,_primitives.isStream)(t))r=t;else{if(!(0,_util.isArrayBuffer)(t))throw new Error("PDFDocument: Unknown argument type");r=new _stream.Stream(t)}if(r.length<=0)throw new _util.InvalidPDFException("The PDF file is empty, i.e. its size is zero bytes.");this.pdfManager=e,this.stream=r,this.xref=new _obj.XRef(r,e),this._pagePromises=[],this._version=null;var n={font:0};this._globalIdFactory=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"getDocId",value:function(){return"g_".concat(e.docId)}},{key:"createFontId",value:function(){return"f".concat(++n.font)}},{key:"createObjId",value:function(){(0,_util.unreachable)("Abstract method `createObjId` called.")}}]),t}()}var t;return _createClass(i,[{key:"parse",value:function(t){this.xref.parse(t),this.catalog=new _obj.Catalog(this.pdfManager,this.xref),this.catalog.version&&(this._version=this.catalog.version)}},{key:"linearization",get:function(){var t=null;try{t=_parser.Linearization.create(this.stream)}catch(t){if(t instanceof _core_utils.MissingDataException)throw t;(0,_util.info)(t)}return(0,_util.shadow)(this,"linearization",t)}},{key:"startXRef",get:function(){var t=this.stream,e=0;if(this.linearization)t.reset(),find(t,ENDOBJ_SIGNATURE)&&(e=t.pos+6-t.start);else{for(var r=STARTXREF_SIGNATURE.length,n=!1,i=t.end;!n&&0<i;)(i-=1024-r)<0&&(i=0),t.pos=i,n=find(t,STARTXREF_SIGNATURE,1024,!0);if(n){var a;for(t.skip(9);a=t.getByte(),(0,_core_utils.isWhiteSpace)(a););for(var o="";32<=a&&a<=57;)o+=String.fromCharCode(a),a=t.getByte();e=parseInt(o,10),isNaN(e)&&(e=0)}}return(0,_util.shadow)(this,"startXRef",e)}},{key:"checkHeader",value:function(){var t=this.stream;if(t.reset(),find(t,PDF_HEADER_SIGNATURE)){t.moveStart();for(var e,r="";32<(e=t.getByte())&&!(12<=r.length);)r+=String.fromCharCode(e);this._version||(this._version=r.substring(5))}}},{key:"parseStartXRef",value:function(){this.xref.setStartXRef(this.startXRef)}},{key:"numPages",get:function(){if(this.xfaFactory)return(0,_util.shadow)(this,"numPages",this.xfaFactory.numberPages);var t=this.linearization,e=t?t.numPages:this.catalog.numPages;return(0,_util.shadow)(this,"numPages",e)}},{key:"_hasOnlyDocumentSignatures",value:function(t){var i=this,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return!!Array.isArray(t)&&t.every(function(t){if(!((t=i.xref.fetchIfRef(t))instanceof _primitives.Dict))return!1;if(t.has("Kids"))return 10<++a?((0,_util.warn)("_hasOnlyDocumentSignatures: maximum recursion depth reached"),!1):i._hasOnlyDocumentSignatures(t.get("Kids"),a);var e=(0,_primitives.isName)(t.get("FT"),"Sig"),r=t.get("Rect"),n=Array.isArray(r)&&r.every(function(t){return 0===t});return e&&n})}},{key:"xfaData",get:function(){var t=this.catalog.acroForm;if(!t)return null;var e=t.get("XFA"),r={"xdp:xdp":"",template:"",datasets:"",config:"",connectionSet:"",localeSet:"",stylesheet:"","/xdp:xdp":""};if((0,_primitives.isStream)(e)&&!e.isEmpty)try{return r["xdp:xdp"]=(0,_util.stringToUTF8String)((0,_util.bytesToString)(e.getBytes())),r}catch(t){return(0,_util.warn)("XFA - Invalid utf-8 string."),null}if(!Array.isArray(e)||0===e.length)return null;for(var n=0,i=e.length;n<i;n+=2){var a=void 0;if(a=0===n?"xdp:xdp":n===i-2?"/xdp:xdp":e[n],r.hasOwnProperty(a)){var o=this.xref.fetchIfRef(e[n+1]);if((0,_primitives.isStream)(o)&&!o.isEmpty)try{r[a]=(0,_util.stringToUTF8String)((0,_util.bytesToString)(o.getBytes()))}catch(t){return(0,_util.warn)("XFA - Invalid utf-8 string."),null}}}return r}},{key:"xfaFactory",get:function(){if(this.pdfManager.enableXfa&&this.formInfo.hasXfa&&!this.formInfo.hasAcroForm){var t=this.xfaData;return(0,_util.shadow)(this,"xfaFactory",t?new _factory.XFAFactory(t):null)}return(0,_util.shadow)(this,"xfaFaxtory",null)}},{key:"isPureXfa",get:function(){return null!==this.xfaFactory}},{key:"formInfo",get:function(){var t={hasFields:!1,hasAcroForm:!1,hasXfa:!1},e=this.catalog.acroForm;if(!e)return(0,_util.shadow)(this,"formInfo",t);try{var r=e.get("Fields"),n=Array.isArray(r)&&0<r.length;t.hasFields=n;var i=e.get("XFA");t.hasXfa=Array.isArray(i)&&0<i.length||(0,_primitives.isStream)(i)&&!i.isEmpty;var a=!!(1&e.get("SigFlags"))&&this._hasOnlyDocumentSignatures(r);t.hasAcroForm=n&&!a}catch(t){if(t instanceof _core_utils.MissingDataException)throw t;(0,_util.warn)('Cannot fetch form information: "'.concat(t,'".'))}return(0,_util.shadow)(this,"formInfo",t)}},{key:"documentInfo",get:function(){var t={Title:_util.isString,Author:_util.isString,Subject:_util.isString,Keywords:_util.isString,Creator:_util.isString,Producer:_util.isString,CreationDate:_util.isString,ModDate:_util.isString,Trapped:_primitives.isName},e=this._version;"string"==typeof e&&PDF_HEADER_VERSION_REGEXP.test(e)||((0,_util.warn)("Invalid PDF header version number: ".concat(e)),e=null);var r,n={PDFFormatVersion:e,IsLinearized:!!this.linearization,IsAcroFormPresent:this.formInfo.hasAcroForm,IsXFAPresent:this.formInfo.hasXfa,IsCollectionPresent:!!this.catalog.collection};try{r=this.xref.trailer.get("Info")}catch(t){if(t instanceof _core_utils.MissingDataException)throw t;(0,_util.info)("The document information dictionary is invalid.")}if((0,_primitives.isDict)(r)){var i,a=_createForOfIteratorHelper(r.getKeys());try{for(a.s();!(i=a.n()).done;){var o=i.value,s=r.get(o);if(t[o])t[o](s)?n[o]="string"!=typeof s?s:(0,_util.stringToPDFString)(s):(0,_util.info)('Bad value in document info for "'.concat(o,'".'));else if("string"==typeof o){var u=void 0;if((0,_util.isString)(s))u=(0,_util.stringToPDFString)(s);else{if(!((0,_primitives.isName)(s)||(0,_util.isNum)(s)||(0,_util.isBool)(s))){(0,_util.info)('Unsupported value in document info for (custom) "'.concat(o,'".'));continue}u=s}n.Custom||(n.Custom=Object.create(null)),n.Custom[o]=u}}}catch(t){a.e(t)}finally{a.f()}}return(0,_util.shadow)(this,"documentInfo",n)}},{key:"fingerprint",get:function(){for(var t,e=this.xref.trailer.get("ID"),r=[],n=0,i=(t=Array.isArray(e)&&e[0]&&(0,_util.isString)(e[0])&&e[0]!==EMPTY_FINGERPRINT?(0,_util.stringToBytes)(e[0]):(0,_crypto.calculateMD5)(this.stream.getByteRange(0,FINGERPRINT_FIRST_BYTES),0,FINGERPRINT_FIRST_BYTES)).length;n<i;n++){var a=t[n].toString(16);r.push(a.padStart(2,"0"))}return(0,_util.shadow)(this,"fingerprint",r.join(""))}},{key:"_getLinearizationPage",value:function(e){var r=this.catalog,t=this.linearization,n=_primitives.Ref.get(t.objectNumberFirst,0);return this.xref.fetchAsync(n).then(function(t){if((0,_primitives.isDict)(t,"Page")||(0,_primitives.isDict)(t)&&!t.has("Type")&&t.has("Contents"))return n&&!r.pageKidsCountCache.has(n)&&r.pageKidsCountCache.put(n,1),[t,n];throw new _util.FormatError("The Linearization dictionary doesn't point to a valid Page dictionary.")}).catch(function(t){return(0,_util.info)(t),r.getPageDict(e)})}},{key:"getPage",value:function(i){var a=this;if(void 0!==this._pagePromises[i])return this._pagePromises[i];var o=this.catalog,t=this.linearization;if(this.xfaFactory)return Promise.resolve(new Page({pdfManager:this.pdfManager,xref:this.xref,pageIndex:i,pageDict:_primitives.Dict.empty,ref:null,globalIdFactory:this._globalIdFactory,fontCache:o.fontCache,builtInCMapCache:o.builtInCMapCache,globalImageCache:o.globalImageCache,nonBlendModesSet:o.nonBlendModesSet,xfaFactory:this.xfaFactory}));var e=t&&t.pageFirst===i?this._getLinearizationPage(i):o.getPageDict(i);return this._pagePromises[i]=e.then(function(t){var e=_slicedToArray(t,2),r=e[0],n=e[1];return new Page({pdfManager:a.pdfManager,xref:a.xref,pageIndex:i,pageDict:r,ref:n,globalIdFactory:a._globalIdFactory,fontCache:o.fontCache,builtInCMapCache:o.builtInCMapCache,globalImageCache:o.globalImageCache,nonBlendModesSet:o.nonBlendModesSet,xfaFactory:null})})}},{key:"checkFirstPage",value:function(){var r=this;return this.getPage(0).catch(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e instanceof _core_utils.XRefEntryException)return r._pagePromises.length=0,t.next=4,r.cleanup();t.next=5;break;case 4:throw new _core_utils.XRefParseException;case 5:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}())}},{key:"fontFallback",value:function(t,e){return this.catalog.fontFallback(t,e)}},{key:"cleanup",value:(t=_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,r=arguments;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=0<r.length&&void 0!==r[0]&&r[0],t.abrupt("return",this.catalog?this.catalog.cleanup(e):(0,_primitives.clearPrimitiveCaches)());case 2:case"end":return t.stop()}},t,this)})),function(){return t.apply(this,arguments)})},{key:"_collectFieldObjects",value:function(t,e,r){var n=this.xref.fetchIfRef(e);if(n.has("T")){var i=(0,_util.stringToPDFString)(n.get("T"));t=""===t?i:"".concat(t,".").concat(i)}if(r.has(t)||r.set(t,[]),r.get(t).push(_annotation.AnnotationFactory.create(this.xref,e,this.pdfManager,this._localIdFactory,!0).then(function(t){return t&&t.getFieldObject()}).catch(function(t){return(0,_util.warn)('_collectFieldObjects: "'.concat(t,'".')),null})),n.has("Kids")){var a,o=_createForOfIteratorHelper(n.get("Kids"));try{for(o.s();!(a=o.n()).done;){var s=a.value;this._collectFieldObjects(t,s,r)}}catch(t){o.e(t)}finally{o.f()}}}},{key:"fieldObjects",get:function(){if(!this.formInfo.hasFields)return(0,_util.shadow)(this,"fieldObjects",Promise.resolve(null));var t,n=Object.create(null),e=new Map,r=_createForOfIteratorHelper(this.catalog.acroForm.get("Fields"));try{for(r.s();!(t=r.n()).done;){var i=t.value;this._collectFieldObjects("",i,e)}}catch(t){r.e(t)}finally{r.f()}var a,o=[],s=_createForOfIteratorHelper(e);try{var u=function(){var t=_slicedToArray(a.value,2),e=t[0],r=t[1];o.push(Promise.all(r).then(function(t){0<(t=t.filter(function(t){return!!t})).length&&(n[e]=t)}))};for(s.s();!(a=s.n()).done;)u()}catch(t){s.e(t)}finally{s.f()}return(0,_util.shadow)(this,"fieldObjects",Promise.all(o).then(function(){return n}))}},{key:"hasJSActions",get:function(){var e=this;return(0,_util.shadow)(this,"hasJSActions",this.fieldObjects.then(function(t){return null!==t&&Object.values(t).some(function(t){return t.some(function(t){return null!==t.actions})})||!!e.catalog.jsActions}))}},{key:"calculationOrderIds",get:function(){var t=this.catalog.acroForm;if(!t||!t.has("CO"))return(0,_util.shadow)(this,"calculationOrderIds",null);var e=t.get("CO");if(!Array.isArray(e)||0===e.length)return(0,_util.shadow)(this,"calculationOrderIds",null);var r=e.filter(_primitives.isRef).map(function(t){return t.toString()});return 0===r.length?(0,_util.shadow)(this,"calculationOrderIds",null):(0,_util.shadow)(this,"calculationOrderIds",r)}}]),i}();exports.PDFDocument=PDFDocument;