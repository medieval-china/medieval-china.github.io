"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var r,n,o,i,c=[],s=!0,l=!1;try{if(o=(a=a.call(e)).next,0===t){if(Object(a)!==a)return;s=!1}else for(;!(s=(r=o.call(a)).done)&&(c.push(r.value),c.length!==t);s=!0);}catch(e){l=!0,n=e}finally{try{if(!s&&null!=a.return&&(i=a.return(),Object(i)!==i))return}finally{if(l)throw n}}return c}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0,n=function(){};return{s:n,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,c=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return i=e.done,e},e:function(e){c=!0,o=e},f:function(){try{i||null==a.return||a.return()}finally{if(c)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0===a)return("string"===t?String:Number)(e);var r=a.call(e,t||"default");if("object"!==_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Binder=void 0;var _xfa_object=require("./xfa_object.js"),_template=require("./template.js"),_som=require("./som.js"),_namespaces=require("./namespaces.js"),_util=require("../../shared/util.js");function createText(e){var t=new _template.Text({});return t[_xfa_object.$content]=e,t}var Binder=function(){function t(e){_classCallCheck(this,t),this.root=e,this.datasets=e.datasets,e.datasets&&e.datasets.data?(this.emptyMerge=!1,this.data=e.datasets.data):(this.emptyMerge=!0,this.data=new _xfa_object.XmlObject(_namespaces.NamespaceIds.datasets.id,"data")),this.root.form=this.form=e.template[_xfa_object.$clone]()}return _createClass(t,[{key:"_isConsumeData",value:function(){return!this.emptyMerge&&this._mergeMode}},{key:"_isMatchTemplate",value:function(){return!this._isConsumeData()}},{key:"bind",value:function(){return this._bindElement(this.form,this.data),this.form}},{key:"getData",value:function(){return this.data}},{key:"_bindValue",value:function(e,t,a){if(e[_xfa_object.$hasSettableValue]())if(t[_xfa_object.$isDataValue]()){var r=t[_xfa_object.$content].trim();e[_xfa_object.$setValue](createText(r)),e[_xfa_object.$data]=t}else if(e instanceof _template.Field&&e.ui&&e.ui.choiceList&&"multiSelect"===e.ui.choiceList.open){var n=t[_xfa_object.$getChildren]().map(function(e){return e[_xfa_object.$content].trim()}).join("\n");e[_xfa_object.$setValue](createText(n)),e[_xfa_object.$data]=t}else this._isConsumeData()&&(0,_util.warn)("XFA - Nodes haven't the same type.");else!t[_xfa_object.$isDataValue]()||this._isMatchTemplate()?(this._bindElement(e,t),e[_xfa_object.$data]=t):(0,_util.warn)("XFA - Nodes haven't the same type.")}},{key:"_findDataByNameToConsume",value:function(e,t,a){if(!e)return null;for(var r,n,o=0;o<3;o++){if(n=(r=t[_xfa_object.$getRealChildrenByNameIt](e,!1,!0)).next().value)return n;if(t[_xfa_object.$namespaceId]===_namespaces.NamespaceIds.datasets.id&&"data"===t[_xfa_object.$nodeName])break;t=t[_xfa_object.$getParent]()}if(!a)return null;for(r=this.datasets[_xfa_object.$getRealChildrenByNameIt](e,!1,!1);n=r.next().value;)if(n[_xfa_object.$global])return n;return(n=(r=this.data[_xfa_object.$getAttributeIt](e,!0)).next().value)&&n[_xfa_object.$isDataValue]()?n:null}},{key:"_setProperties",value:function(e,t){if(e.hasOwnProperty("setProperty")){var a,r=_createForOfIteratorHelper(e.setProperty.children);try{for(r.s();!(a=r.n()).done;){var n=a.value,o=n.ref,i=n.target;if(!n.connection&&o){var c=_slicedToArray((0,_som.searchNode)(this.root,t,o,!1,!1),1)[0];if(c)if(c[_xfa_object.$isDescendent](this.data)){var s=_slicedToArray((0,_som.searchNode)(this.root,e,i,!1,!1),1)[0];if(s)if(s[_xfa_object.$isDescendent](e)){var l=s[_xfa_object.$getParent]();if(s instanceof _template.SetProperty||l instanceof _template.SetProperty)(0,_util.warn)("XFA - Invalid target: cannot be a setProperty or one of its properties.");else if(s instanceof _template.BindItems||l instanceof _template.BindItems)(0,_util.warn)("XFA - Invalid target: cannot be a bindItems or one of its properties.");else{var f=c[_xfa_object.$text](),_=s[_xfa_object.$nodeName];if(s instanceof _xfa_object.XFAAttribute){var u=Object.create(null);u[_]=f;var d=Reflect.construct(Object.getPrototypeOf(l).constructor,[u]);l[_]=d[_]}else s.hasOwnProperty(_xfa_object.$content)?(s[_xfa_object.$data]=c,s[_xfa_object.$content]=f,s[_xfa_object.$finalize]()):(0,_util.warn)("XFA - Invalid node to use in setProperty")}}else(0,_util.warn)("XFA - Invalid target: must be a property or subproperty.");else(0,_util.warn)("XFA - Invalid target: ".concat(i,"."))}else(0,_util.warn)("XFA - Invalid node: must be a data node.");else(0,_util.warn)("XFA - Invalid reference: ".concat(o,"."))}}}catch(e){r.e(e)}finally{r.f()}}}},{key:"_bindItems",value:function(e,t){if(e.hasOwnProperty("items")&&e.hasOwnProperty("bindItems")&&!e.bindItems.isEmpty()){var a,r=_createForOfIteratorHelper(e.items.children);try{for(r.s();!(a=r.n()).done;){var n=a.value;e[_xfa_object.$removeChild](n)}}catch(e){r.e(e)}finally{r.f()}e.items.clear();var o=new _template.Items({}),i=new _template.Items({});e[_xfa_object.$appendChild](o),e.items.push(o),e[_xfa_object.$appendChild](i),e.items.push(i);var c,s=_createForOfIteratorHelper(e.bindItems.children);try{for(s.s();!(c=s.n()).done;){var l=c.value,f=l.ref,_=l.labelRef,u=l.valueRef;if(!l.connection&&f){var d=(0,_som.searchNode)(this.root,t,f,!1,!1);if(d){var b,m=_createForOfIteratorHelper(d);try{for(m.s();!(b=m.n()).done;){var h=b.value;if(h[_xfa_object.$isDescendent](this.datasets)){var p=_slicedToArray((0,_som.searchNode)(this.root,h,_,!0,!1),1)[0];if(p)if(p[_xfa_object.$isDescendent](this.datasets)){var y=_slicedToArray((0,_som.searchNode)(this.root,h,u,!0,!1),1)[0];if(y)if(y[_xfa_object.$isDescendent](this.datasets)){var v=createText(p[_xfa_object.$text]()),x=createText(y[_xfa_object.$text]());o[_xfa_object.$appendChild](v),o.text.push(v),i[_xfa_object.$appendChild](x),i.text.push(x)}else(0,_util.warn)("XFA - Invalid value: must be a datasets child.");else(0,_util.warn)("XFA - Invalid value: ".concat(u,"."))}else(0,_util.warn)("XFA - Invalid label: must be a datasets child.");else(0,_util.warn)("XFA - Invalid label: ".concat(_,"."))}else(0,_util.warn)("XFA - Invalid ref (".concat(f,"): must be a datasets child."))}}catch(e){m.e(e)}finally{m.f()}}else(0,_util.warn)("XFA - Invalid reference: ".concat(f,"."))}}}catch(e){s.e(e)}finally{s.f()}}}},{key:"_bindOccurrences",value:function(e,t,a){var r;if(1<t.length&&(r=e[_xfa_object.$clone]()),this._bindValue(e,t[0],a),this._setProperties(e,t[0]),this._bindItems(e,t[0]),1!==t.length)for(var n=e[_xfa_object.$getParent](),o=e[_xfa_object.$nodeName],i=n[_xfa_object.$indexOf](e),c=1,s=t.length;c<s;c++){var l=t[c],f=r[_xfa_object.$clone]();f.occur.min=1,f.occur.max=1,f.occur.initial=1,n[o].push(f),n[_xfa_object.$insertAt](i+c,f),this._bindValue(f,l,a),this._setProperties(f,l),this._bindItems(f,l)}}},{key:"_createOccurrences",value:function(e){if(this.emptyMerge){var t=e.occur;if(t&&!(t.initial<=1))for(var a=e[_xfa_object.$getParent](),r=e[_xfa_object.$nodeName],n=0,o=t.initial;n<o;n++){var i=e[_xfa_object.$clone]();i.occur.min=1,i.occur.max=1,i.occur.initial=1,a[r].push(i),a[_xfa_object.$appendChild](i)}}}},{key:"_getOccurInfo",value:function(e){var t=e.occur,a=e.name;if(!t||!a)return[1,1];var r=-1===t.max?1/0:t.max;return[t.min,r]}},{key:"_bindElement",value:function(e,t){var a=[];this._createOccurrences(e);var r,n=_createForOfIteratorHelper(e[_xfa_object.$getChildren]());try{for(n.s();!(r=n.n()).done;){var o=r.value;if(!o[_xfa_object.$data]){void 0===this._mergeMode&&"subform"===o[_xfa_object.$nodeName]&&(this._mergeMode="consumeData"===o.mergeMode);var i=!1,c=null,s=null,l=null;if(o.bind){switch(o.bind.match){case"none":continue;case"global":i=!0;break;case"dataRef":if(!o.bind.ref){(0,_util.warn)("XFA - ref is empty in node ".concat(o[_xfa_object.$nodeName],"."));continue}s=o.bind.ref}o.bind.picture&&(c=o.bind.picture[_xfa_object.$content])}var f=_slicedToArray(this._getOccurInfo(o),2),_=f[0],u=f[1];if(s)null===(l=(0,_som.searchNode)(this.root,t,s,!0,!1))?(l=(0,_som.createDataNode)(this.data,t,s),this._isConsumeData()&&(l[_xfa_object.$consumed]=!0),l=[l]):(this._isConsumeData()&&(l=l.filter(function(e){return!e[_xfa_object.$consumed]})),l.length>u?l=l.slice(0,u):0===l.length&&(l=null),l&&this._isConsumeData()&&l.forEach(function(e){e[_xfa_object.$consumed]=!0}));else{if(!o.name){this._bindElement(o,t);continue}if(this._isConsumeData()){for(var d=[];d.length<u;){var b=this._findDataByNameToConsume(o.name,t,i);if(!b)break;b[_xfa_object.$consumed]=!0,d.push(b)}l=0<d.length?d:null}else(l=t[_xfa_object.$getRealChildrenByNameIt](o.name,!1,!1).next().value)||(l=new _xfa_object.XmlObject(t[_xfa_object.$namespaceId],o.name),t[_xfa_object.$appendChild](l)),l=[l]}if(l){if(l.length<_){(0,_util.warn)("XFA - Must have at least ".concat(_," occurrences: ").concat(e[_xfa_object.$nodeName],"."));continue}this._bindOccurrences(o,l,c)}else 0<_?this._bindElement(o,t):a.push(o)}}}catch(e){n.e(e)}finally{n.f()}a.forEach(function(e){return e[_xfa_object.$getParent]()[_xfa_object.$removeChild](e)})}}]),t}();exports.Binder=Binder;