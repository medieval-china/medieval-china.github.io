"use strict";function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(u)throw o}}}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o,i,u=[],c=!0,l=!1;try{if(o=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(u.push(n.value),u.length!==t);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(l)throw a}}return u}}function _arrayWithHoles(e){if(Array.isArray(e))return e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.createDataNode=createDataNode,exports.searchNode=searchNode;var _xfa_object=require("./xfa_object.js"),_util=require("../../shared/util.js"),namePattern=/^[^.[]+/,indexPattern=/^[^\]]+/,operators={dot:0,dotDot:1,dotHash:2,dotBracket:3,dotParen:4},shortcuts=new Map([["$data",function(e,t){return e.datasets.data}],["$template",function(e,t){return e.template}],["$connectionSet",function(e,t){return e.connectionSet}],["$form",function(e,t){return e.form}],["$layout",function(e,t){return e.layout}],["$host",function(e,t){return e.host}],["$dataWindow",function(e,t){return e.dataWindow}],["$event",function(e,t){return e.event}],["!",function(e,t){return e.datasets}],["$xfa",function(e,t){return e}],["xfa",function(e,t){return e}],["$",function(e,t){return t}]]),somCache=new WeakMap;function parseIndex(e){return"*"===(e=e.trim())?1/0:parseInt(e,10)||0}function parseExpression(e,t){var r=e.match(namePattern);if(!r)return null;for(var n=_slicedToArray(r,1)[0],a=[{name:n,cacheName:"."+n,index:0,js:null,formCalc:null,operator:operators.dot}],o=n.length;o<e.length;){var i=o;if("["!==e.charAt(o++)){var u=void 0;switch(e.charAt(o)){case".":if(!t)return null;o++,u=operators.dotDot;break;case"#":o++,u=operators.dotHash;break;case"[":u=operators.dotBracket;break;case"(":u=operators.dotParen;break;default:u=operators.dot}if(!(r=e.slice(o).match(namePattern)))break;o+=(n=_slicedToArray(r,1)[0]).length,a.push({name:n,cacheName:e.slice(i,o),operator:u,index:0,js:null,formCalc:null})}else{if(!(r=e.slice(o).match(indexPattern)))return(0,_util.warn)("XFA - Invalid index in SOM expression"),null;a[a.length-1].index=parseIndex(r[0]),o+=r[0].length+1}}return a}function searchNode(d,p,e){var t=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],h=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],y=parseExpression(e,t);if(!y)return null;var m,r=shortcuts.get(y[0].name),b=0;r?(m=!0,d=[r(d,p)],b=1):(m=null===p,d=[p||d]);for(var n=function(e){var t,r=y[b],n=r.name,a=r.cacheName,o=r.operator,i=r.index,u=[],c=_createForOfIteratorHelper(d);try{for(c.s();!(t=c.n()).done;){var l=t.value;if(l instanceof _xfa_object.XFAObject){var f=void 0,s=void 0;if(h&&((s=somCache.get(l))||(s=new Map,somCache.set(l,s)),f=s.get(a)),!f){switch(o){case operators.dot:f=l[_xfa_object.$getChildrenByName](n,!1);break;case operators.dotDot:f=l[_xfa_object.$getChildrenByName](n,!0);break;case operators.dotHash:f=(f=l[_xfa_object.$getChildrenByClass](n))instanceof _xfa_object.XFAObjectArray?f.children:[f]}h&&s.set(a,f)}0<f.length&&u.push(f)}}}catch(e){c.e(e)}finally{c.f()}if(0===u.length&&!m&&0===b)return(p=p[_xfa_object.$getParent]())?(b=-1,d=[p],"continue"):{v:null};d=isFinite(i)?u.filter(function(e){return i<e.length}).map(function(e){return e[i]}):u.reduce(function(e,t){return e.concat(t)},[])},a=y.length;b<a;b++){var o=n();if("continue"!==o&&"object"===_typeof(o))return o.v}return 0===d.length?null:d}function createNodes(e,t){var r,n=null,a=_createForOfIteratorHelper(t);try{for(a.s();!(r=a.n()).done;){for(var o=r.value,i=o.name,u=o.index,c=0;c<=u;c++)n=new _xfa_object.XmlObject(e[_xfa_object.$namespaceId],i),e[_xfa_object.$appendChild](n);e=n}}catch(e){a.e(e)}finally{a.f()}return n}function createDataNode(e,t,r){var n=parseExpression(r);if(!n)return null;if(n.some(function(e){return e.operator===operators.dotDot}))return null;var a=shortcuts.get(n[0].name),o=0;a?(e=a(e,t),o=1):e=t||e;for(var i=n.length;o<i;o++){var u=n[o],c=u.cacheName,l=u.index;if(!isFinite(l))return n[o].index=0,createNodes(e,n.slice(o));var f=somCache.get(e);if(!f)return(0,_util.warn)("XFA - createDataNode must be called after searchNode."),null;var s=f.get(c);if(0===s.length)return createNodes(e,n.slice(o));if(!(l<s.length))return n[o].index=s.length-l,createNodes(e,n.slice(o));var d=s[l];if(!(d instanceof _xfa_object.XFAObject))return(0,_util.warn)("XFA - Cannot create a node."),null;e=d}return null}