"use strict";function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),r&&_setPrototypeOf(e,r)}function _setPrototypeOf(e,r){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,r){return e.__proto__=r,e})(e,r)}function _createSuper(i){var n=_isNativeReflectConstruct();return function(){var e,r=_getPrototypeOf(i);if(n){var t=_getPrototypeOf(this).constructor;e=Reflect.construct(r,arguments,t)}else e=r.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _possibleConstructorReturn(e,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,i=new Array(r);t<r;t++)i[t]=e[t];return i}function _iterableToArrayLimit(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var i,n,s,a,o=[],l=!0,c=!1;try{if(s=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;l=!1}else for(;!(l=(i=s.call(t)).done)&&(o.push(i.value),o.length!==r);l=!0);}catch(e){c=!0,n=e}finally{try{if(!l&&null!=t.return&&(a=t.return(),Object(a)!==a))return}finally{if(c)throw n}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"===_typeof(r)?r:String(r)}function _toPrimitive(e,r){if("object"!==_typeof(e)||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===r?String:Number)(e);var i=t.call(e,r||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=exports.Errors=void 0;var _formcalc_lexer=require("./formcalc_lexer.js"),Errors={assignment:"Invalid token in assignment.",block:"Invalid token in do ... end declaration.",elseif:"Invalid elseif declaration.",for:"Invalid token in for ... endfor declaration.",foreach:"Invalid token in foreach ... endfor declaration.",func:"Invalid token in func declaration.",if:"Invalid token if ... endif declaration.",index:"Invalid token in index.",params:"Invalid token in parameter list.",var:"Invalid token in var declaration.",while:"Invalid token while ... endwhile declaration."};exports.Errors=Errors;var BUILTINS=new Set(["abs","avg","ceil","count","floor","max","min","mod","round","sum","date","date2num","datefmt","isodate2num","isotime2num","localdatefmt","localtimefmt","num2date","num2gmtime","num2time","time","time2num","timefmt","apr","cterm","fv","ipmt","npv","pmt","ppmt","pv","rate","term","choose","exists","hasvalue","oneof","within","at","concat","decode","encode","format","left","len","lower","ltrim","parse","replace","right","rtrim","space","str","stuff","substr","uuid","upper","wordnum","get","post","put","eval","ref","unitvalue","unittype","acos","asin","atan","cos","deg2rad","exp","log","pi","pow","rad2deg","sin","sqrt","tan"]),LTR=!0,RTL=!1,Operators={dot:{id:0,prec:0,assoc:RTL,nargs:0,repr:"."},dotDot:{id:1,prec:0,assoc:RTL,nargs:0,repr:".."},dotHash:{id:2,prec:0,assoc:RTL,nargs:0,repr:".#"},call:{id:1,prec:1,assoc:LTR,nargs:0},minus:{id:4,nargs:1,prec:2,assoc:RTL,repr:"-",op:function(e){return-e}},plus:{id:5,nargs:1,prec:2,assoc:RTL,repr:"+",op:function(e){return+e}},not:{id:6,nargs:1,prec:2,assoc:RTL,repr:"!",op:function(e){return e?0:1}},mul:{id:7,nargs:2,prec:3,assoc:LTR,repr:"*",op:function(e,r){return e*r}},div:{id:8,nargs:2,prec:3,assoc:LTR,repr:"/",op:function(e,r){return e/r}},add:{id:9,nargs:2,prec:4,assoc:LTR,repr:"+",op:function(e,r){return e+r}},sub:{id:10,nargs:2,prec:4,assoc:LTR,repr:"-",op:function(e,r){return e-r}},lt:{id:11,nargs:2,prec:5,assoc:LTR,repr:"<",op:function(e,r){return e<r?1:0}},le:{id:12,nargs:2,prec:5,assoc:LTR,repr:"<=",op:function(e,r){return e<=r?1:0}},gt:{id:13,nargs:2,prec:5,assoc:LTR,repr:">",op:function(e,r){return r<e?1:0}},ge:{id:14,nargs:2,prec:5,assoc:LTR,repr:">=",op:function(e,r){return r<=e?1:0}},eq:{id:15,nargs:2,prec:6,assoc:LTR,repr:"===",op:function(e,r){return e===r?1:0}},ne:{id:16,nargs:2,prec:6,assoc:LTR,repr:"!==",op:function(e,r){return e!==r?1:0}},and:{id:17,nargs:2,prec:7,assoc:LTR,repr:"&&",op:function(e,r){return e&&r?1:0}},or:{id:18,nargs:2,prec:8,assoc:LTR,repr:"||",op:function(e,r){return e||r?1:0}},paren:{id:19,prec:9,assoc:RTL,nargs:0},subscript:{id:20,prec:9,assoc:RTL,nargs:0}},OPERATOR=!0,OPERAND=!1,SimpleExprParser=function(){function o(e){_classCallCheck(this,o),this.lexer=e,this.operands=[],this.operators=[],this.last=OPERATOR}return _createClass(o,[{key:"reset",value:function(){this.operands.length=0,this.operators.length=0,this.last=OPERATOR}},{key:"parse",value:function(e){for(e=e||this.lexer.next();;){switch(e.id){case _formcalc_lexer.TOKEN.and:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.and);break;case _formcalc_lexer.TOKEN.divide:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.div);break;case _formcalc_lexer.TOKEN.dot:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.dot);break;case _formcalc_lexer.TOKEN.dotDot:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.dotDot);break;case _formcalc_lexer.TOKEN.dotHash:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.dotHash);break;case _formcalc_lexer.TOKEN.dotStar:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.dot),this.pushOperand(new AstEveryOccurence);break;case _formcalc_lexer.TOKEN.eq:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.eq);break;case _formcalc_lexer.TOKEN.ge:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.ge);break;case _formcalc_lexer.TOKEN.gt:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.gt);break;case _formcalc_lexer.TOKEN.le:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.le);break;case _formcalc_lexer.TOKEN.leftBracket:if(this.last!==OPERAND)return[e,this.getNode()];this.flushWithOperator(Operators.subscript);var r=this.operands.pop(),t=o.parseIndex(this.lexer);this.operands.push(new AstSubscript(r,t)),this.last=OPERAND;break;case _formcalc_lexer.TOKEN.leftParen:if(this.last===OPERAND){var i=this.operands[this.operands.length-1];if(!(i instanceof AstIdentifier))return[e,this.getNode()];i.toLowerCase();var n=i.id;this.flushWithOperator(Operators.call);var s=this.operands.pop(),a=o.parseParams(this.lexer);s instanceof AstIdentifier&&BUILTINS.has(n)?this.operands.push(new AstBuiltinCall(n,a)):this.operands.push(new AstCall(s,a)),this.last=OPERAND}else this.operators.push(Operators.paren),this.last=OPERATOR;break;case _formcalc_lexer.TOKEN.lt:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.lt);break;case _formcalc_lexer.TOKEN.minus:this.last===OPERATOR?this.pushOperator(Operators.minus):this.pushOperator(Operators.sub);break;case _formcalc_lexer.TOKEN.ne:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.ne);break;case _formcalc_lexer.TOKEN.not:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.not);break;case _formcalc_lexer.TOKEN.null:if(this.last!==OPERATOR)return[e,this.getNode()];this.pushOperand(new AstNull);break;case _formcalc_lexer.TOKEN.number:if(this.last!==OPERATOR)return[e,this.getNode()];this.pushOperand(new AstNumber(e.value));break;case _formcalc_lexer.TOKEN.or:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.or);break;case _formcalc_lexer.TOKEN.plus:this.last===OPERATOR?this.pushOperator(Operators.plus):this.pushOperator(Operators.add);break;case _formcalc_lexer.TOKEN.rightBracket:if(!this.flushUntil(Operators.subscript.id))return[e,this.getNode()];break;case _formcalc_lexer.TOKEN.rightParen:if(!this.flushUntil(Operators.paren.id))return[e,this.getNode()];break;case _formcalc_lexer.TOKEN.string:if(this.last!==OPERATOR)return[e,this.getNode()];this.pushOperand(new AstString(e.value));break;case _formcalc_lexer.TOKEN.this:if(this.last!==OPERATOR)return[e,this.getNode()];this.pushOperand(new AstThis);break;case _formcalc_lexer.TOKEN.times:if(this.last!==OPERAND)return[e,this.getNode()];this.pushOperator(Operators.mul);break;case _formcalc_lexer.TOKEN.identifier:if(this.last!==OPERATOR)return[e,this.getNode()];this.pushOperand(new AstIdentifier(e.value));break;default:return[e,this.getNode()]}e=this.lexer.next()}}},{key:"pushOperator",value:function(e){this.flushWithOperator(e),this.operators.push(e),this.last=OPERATOR}},{key:"pushOperand",value:function(e){this.operands.push(e),this.last=OPERAND}},{key:"operate",value:function(e){if(1===e.nargs){var r=this.operands.pop();this.operands.push(AstUnaryOperator.getOperatorOrValue(e,r))}else{var t=this.operands.pop(),i=this.operands.pop();this.operands.push(AstBinaryOperator.getOperatorOrValue(e,i,t))}}},{key:"flushWithOperator",value:function(e){for(;;){var r=this.operators[this.operators.length-1];if(!(r&&0<=r.id&&o.checkPrecedence(r,e)))return;this.operators.pop(),this.operate(r)}}},{key:"flush",value:function(){for(;;){var e=this.operators.pop();if(!e)return;this.operate(e)}}},{key:"flushUntil",value:function(e){for(;;){var r=this.operators.pop();if(!r)return!1;if(r.id===e)return!0;this.operate(r)}}},{key:"getNode",value:function(){return this.flush(),this.operands.pop()}}],[{key:"parseParams",value:function(e){for(var r=new o(e),t=[];;){var i=_slicedToArray(r.parse(),2),n=i[0],s=i[1];if(s&&t.push(s),n.id===_formcalc_lexer.TOKEN.rightParen)return t;if(n.id!==_formcalc_lexer.TOKEN.comma)throw new Error(Errors.params);r.reset()}}},{key:"parseIndex",value:function(e){var r=e.next();if(r.id===_formcalc_lexer.TOKEN.times){if((r=e.next()).id!==_formcalc_lexer.TOKEN.rightBracket)throw new Error(Errors.index);return new AstEveryOccurence}var t=_slicedToArray(new o(e).parse(r),2),i=t[0],n=t[1];if(i.id!==_formcalc_lexer.TOKEN.rightBracket)throw new Error(Errors.index);return n}},{key:"checkPrecedence",value:function(e,r){return e.prec<r.prec||e.prec===r.prec&&e.assoc===LTR}}]),o}(),Leaf=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"dump",value:function(){throw new Error("Not implemented method")}},{key:"isSomPredicate",value:function(){return!1}},{key:"isDotExpression",value:function(){return!1}},{key:"isConstant",value:function(){return!1}},{key:"toNumber",value:function(){return 0}},{key:"toComparable",value:function(){return null}}]),e}(),AstCall=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).callee=e,t.params=r,t}return _createClass(n,[{key:"dump",value:function(){return{callee:this.callee.dump(),params:this.params.map(function(e){return e.dump()})}}}]),n}(),AstBuiltinCall=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).id=e,t.params=r,t}return _createClass(n,[{key:"dump",value:function(){return{builtin:this.id,params:this.params.map(function(e){return e.dump()})}}}]),n}(),AstSubscript=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).operand=e,t.index=r,t}return _createClass(n,[{key:"dump",value:function(){return{operand:this.operand.dump(),index:this.index.dump()}}}]),n}(),AstBinaryOperator=function(e){_inherits(a,Leaf);var s=_createSuper(a);function a(e,r,t,i){var n;return _classCallCheck(this,a),(n=s.call(this)).id=e,n.left=r,n.right=t,n.repr=i,n}return _createClass(a,[{key:"dump",value:function(){return{operator:this.repr,left:this.left.dump(),right:this.right.dump()}}},{key:"isDotExpression",value:function(){return Operators.id.dot<=this.id&&this.id<=Operators.id.dotHash}},{key:"isSomPredicate",value:function(){return this.isDotExpression()||Operators.id.lt<=this.id&&this.id<=Operators.id.or&&(this.left.isDotExpression()&&this.right.isConstant()||this.left.isConstant()&&this.right.isDotExpression()||this.left.isDotExpression()&&this.right.isDotExpression())}}],[{key:"getOperatorOrValue",value:function(e,r,t){return r.isConstant()&&t.isConstant()?!(Operators.lt.id<=e.id&&e.id<=Operators.ne.id)||r instanceof AstNumber||t instanceof AstNumber?new AstNumber(e.op(r.toNumber(),t.toNumber())):new AstNumber(e.op(r.toComparable(),t.toComparable())):new a(e.id,r,t,e.repr)}}]),a}(),AstUnaryOperator=function(e){_inherits(s,Leaf);var n=_createSuper(s);function s(e,r,t){var i;return _classCallCheck(this,s),(i=n.call(this)).id=e,i.arg=r,i.repr=t,i}return _createClass(s,[{key:"dump",value:function(){return{operator:this.repr,arg:this.arg.dump()}}}],[{key:"getOperatorOrValue",value:function(e,r){return r.isConstant()?new AstNumber(e.op(r.toNumber())):new s(e.id,r,e.repr)}}]),s}(),AstNumber=function(e){_inherits(i,Leaf);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).number=e,r}return _createClass(i,[{key:"dump",value:function(){return this.number}},{key:"isConstant",value:function(){return!0}},{key:"toNumber",value:function(){return this.number}}]),i}(),AstString=function(e){_inherits(i,Leaf);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).str=e,r}return _createClass(i,[{key:"dump",value:function(){return this.str}},{key:"isConstant",value:function(){return!0}},{key:"toNumber",value:function(){return isNaN(this.str)?0:parseFloat(this.str)}},{key:"toComparable",value:function(){return this.str}}]),i}(),AstThis=function(e){_inherits(t,Leaf);var r=_createSuper(t);function t(){return _classCallCheck(this,t),r.apply(this,arguments)}return _createClass(t,[{key:"dump",value:function(){return{special:"this"}}}]),t}(),AstIdentifier=function(e){_inherits(i,Leaf);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).id=e,r}return _createClass(i,[{key:"dump",value:function(){return{id:this.id}}},{key:"toLowerCase",value:function(){this.id=this.id.toLowerCase()}}]),i}(),AstNull=function(e){_inherits(t,Leaf);var r=_createSuper(t);function t(){return _classCallCheck(this,t),r.apply(this,arguments)}return _createClass(t,[{key:"dump",value:function(){return{special:null}}},{key:"isConstant",value:function(){return!0}},{key:"toComparable",value:function(){return null}}]),t}(),AstEveryOccurence=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"dump",value:function(){return{special:"*"}}}]),e}(),VarDecl=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).id=e,t.expr=r,t}return _createClass(n,[{key:"dump",value:function(){return{var:this.id,expr:this.expr.dump()}}}]),n}(),Assignment=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).id=e,t.expr=r,t}return _createClass(n,[{key:"dump",value:function(){return{assignment:this.id,expr:this.expr.dump()}}}]),n}(),FuncDecl=function(e){_inherits(s,Leaf);var n=_createSuper(s);function s(e,r,t){var i;return _classCallCheck(this,s),(i=n.call(this)).id=e,i.params=r,i.body=t,i}return _createClass(s,[{key:"dump",value:function(){return{func:this.id,params:this.params,body:this.body.dump()}}}]),s}(),IfDecl=function(e){_inherits(a,Leaf);var s=_createSuper(a);function a(e,r,t,i){var n;return _classCallCheck(this,a),(n=s.call(this)).condition=e,n.then=r,n.elseif=t,n.else=i,n}return _createClass(a,[{key:"dump",value:function(){return{decl:"if",condition:this.condition.dump(),then:this.then.dump(),elseif:this.elseif?this.elseif.map(function(e){return e.dump()}):null,else:this.else?this.else.dump():null}}}]),a}(),ElseIfDecl=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).condition=e,t.then=r,t}return _createClass(n,[{key:"dump",value:function(){return{decl:"elseif",condition:this.condition.dump(),then:this.then.dump()}}}]),n}(),WhileDecl=function(e){_inherits(n,Leaf);var i=_createSuper(n);function n(e,r){var t;return _classCallCheck(this,n),(t=i.call(this)).condition=e,t.body=r,t}return _createClass(n,[{key:"dump",value:function(){return{decl:"while",condition:this.condition.dump(),body:this.body.dump()}}}]),n}(),ForDecl=function(e){_inherits(o,Leaf);var a=_createSuper(o);function o(e,r,t,i,n){var s;return _classCallCheck(this,o),(s=a.call(this)).assignment=e,s.upto=r,s.end=t,s.step=i,s.body=n,s}return _createClass(o,[{key:"dump",value:function(){return{decl:"for",assignment:this.assignment.dump(),type:this.upto?"upto":"downto",end:this.end.dump(),step:this.step?this.step.dump():null,body:this.body.dump()}}}]),o}(),ForeachDecl=function(e){_inherits(s,Leaf);var n=_createSuper(s);function s(e,r,t){var i;return _classCallCheck(this,s),(i=n.call(this)).id=e,i.params=r,i.body=t,i}return _createClass(s,[{key:"dump",value:function(){return{decl:"foreach",id:this.id,params:this.params.map(function(e){return e.dump()}),body:this.body.dump()}}}]),s}(),BlockDecl=function(e){_inherits(i,Leaf);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).body=e,r}return _createClass(i,[{key:"dump",value:function(){return{decl:"block",body:this.body.dump()}}}]),i}(),ExprList=function(e){_inherits(i,Leaf);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).expressions=e,r}return _createClass(i,[{key:"dump",value:function(){return this.expressions.map(function(e){return e.dump()})}}]),i}(),BreakDecl=function(e){_inherits(t,Leaf);var r=_createSuper(t);function t(){return _classCallCheck(this,t),r.apply(this,arguments)}return _createClass(t,[{key:"dump",value:function(){return{special:"break"}}}]),t}(),ContinueDecl=function(e){_inherits(t,Leaf);var r=_createSuper(t);function t(){return _classCallCheck(this,t),r.apply(this,arguments)}return _createClass(t,[{key:"dump",value:function(){return{special:"continue"}}}]),t}(),Parser=function(){function r(e){_classCallCheck(this,r),this.lexer=new _formcalc_lexer.Lexer(e)}return _createClass(r,[{key:"parse",value:function(){var e=_slicedToArray(this.parseExprList(),2),r=e[0],t=e[1];if(r.id!==_formcalc_lexer.TOKEN.eof)throw new Error("Invalid token in Form code");return t}},{key:"parseExprList",value:function(){for(var e,r=[],t=null;;){var i=_slicedToArray(this.parseExpr(t),2);if(t=i[0],!(e=i[1]))return[t,new ExprList(r)];r.push(e)}}},{key:"parseExpr",value:function(e){switch((e=e||this.lexer.next()).id){case _formcalc_lexer.TOKEN.identifier:return this.parseAssigmentOrExpr(e);case _formcalc_lexer.TOKEN.break:return[null,new BreakDecl];case _formcalc_lexer.TOKEN.continue:return[null,new ContinueDecl];case _formcalc_lexer.TOKEN.do:return this.parseBlock();case _formcalc_lexer.TOKEN.for:return this.parseFor();case _formcalc_lexer.TOKEN.foreach:return this.parseForeach();case _formcalc_lexer.TOKEN.func:return this.parseFuncDecl();case _formcalc_lexer.TOKEN.if:return this.parseIf();case _formcalc_lexer.TOKEN.var:return this.parseVarDecl();case _formcalc_lexer.TOKEN.while:return this.parseWhile();default:return this.parseSimpleExpr(e)}}},{key:"parseAssigmentOrExpr",value:function(e){var r=e;if((e=this.lexer.next()).id===_formcalc_lexer.TOKEN.assign){var t=_slicedToArray(this.parseSimpleExpr(null),2),i=t[0],n=t[1];return[i,new Assignment(r.value,n)]}var s=new SimpleExprParser(this.lexer);return s.pushOperand(new AstIdentifier(r.value)),s.parse(e)}},{key:"parseBlock",value:function(){var e=_slicedToArray(this.parseExprList(),2),r=e[0],t=e[1];if((r||this.lexer.next()).id!==_formcalc_lexer.TOKEN.end)throw new Error(Errors.block);return[null,new BlockDecl(t)]}},{key:"parseVarDecl",value:function(){var e=this.lexer.next();if(e.id!==_formcalc_lexer.TOKEN.identifier)throw new Error(Errors.var);var r=e.value;if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.assign)return[e,new VarDecl(r,null)];var t=_slicedToArray(this.parseSimpleExpr(),2),i=t[0],n=t[1];return[i,new VarDecl(r,n)]}},{key:"parseFuncDecl",value:function(){var e=this.lexer.next();if(e.id!==_formcalc_lexer.TOKEN.identifier)throw new Error(Errors.func);var r=e.value,t=this.parseParamList();if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.do)throw new Error(Errors.func);var i=_slicedToArray(this.parseExprList(),2),n=i[0],s=i[1];if((e=n||this.lexer.next()).id!==_formcalc_lexer.TOKEN.endfunc)throw new Error(Errors.func);return[null,new FuncDecl(r,t,s)]}},{key:"parseParamList",value:function(){var e=[],r=this.lexer.next();if(r.id!==_formcalc_lexer.TOKEN.leftParen)throw new Error(Errors.func);if((r=this.lexer.next()).id===_formcalc_lexer.TOKEN.rightParen)return e;for(;;){if(r.id!==_formcalc_lexer.TOKEN.identifier)throw new Error(Errors.func);if(e.push(r.value),(r=this.lexer.next()).id===_formcalc_lexer.TOKEN.rightParen)return e;if(r.id!==_formcalc_lexer.TOKEN.comma)throw new Error(Errors.func);r=this.lexer.next()}}},{key:"parseSimpleExpr",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return new SimpleExprParser(this.lexer).parse(e)}},{key:"parseIf",value:function(){var e=[],r=this.lexer.next();if(r.id!==_formcalc_lexer.TOKEN.leftParen)throw new Error(Errors.if);var t=_slicedToArray(this.parseSimpleExpr(),2),i=t[0],n=t[1];if((r=i||this.lexer.next()).id!==_formcalc_lexer.TOKEN.rightParen)throw new Error(Errors.if);if((r=this.lexer.next()).id!==_formcalc_lexer.TOKEN.then)throw new Error(Errors.if);var s=_slicedToArray(this.parseExprList(),2),a=s[0],o=s[1];for(r=a||this.lexer.next();r.id===_formcalc_lexer.TOKEN.elseif;){if((r=this.lexer.next()).id!==_formcalc_lexer.TOKEN.leftParen)throw new Error(Errors.elseif);var l=_slicedToArray(this.parseSimpleExpr(),2),c=l[0],u=l[1];if((r=c||this.lexer.next()).id!==_formcalc_lexer.TOKEN.rightParen)throw new Error(Errors.elseif);if((r=this.lexer.next()).id!==_formcalc_lexer.TOKEN.then)throw new Error(Errors.elseif);var p=_slicedToArray(this.parseExprList(),2),f=p[0],h=p[1];e.push(new ElseIfDecl(u,h)),r=f||this.lexer.next()}if(0===e.length&&(e=null),r.id===_formcalc_lexer.TOKEN.endif)return[null,new IfDecl(n,o,e,null)];if(r.id!==_formcalc_lexer.TOKEN.else)throw new Error(Errors.if);var d=_slicedToArray(this.parseExprList(),2),_=d[0],m=d[1];if((r=_||this.lexer.next()).id!==_formcalc_lexer.TOKEN.endif)throw new Error(Errors.if);return[null,new IfDecl(n,o,e,m)]}},{key:"parseWhile",value:function(){var e=this.lexer.next();if(e.id!==_formcalc_lexer.TOKEN.leftParen)throw new Error(Errors.while);var r=_slicedToArray(this.parseSimpleExpr(),2),t=r[0],i=r[1];if((e=t||this.lexer.next()).id!==_formcalc_lexer.TOKEN.rightParen)throw new Error(Errors.while);if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.do)throw new Error(Errors.while);var n=_slicedToArray(this.parseExprList(),2),s=n[0],a=n[1];if((e=s||this.lexer.next()).id!==_formcalc_lexer.TOKEN.endwhile)throw new Error(Errors.while);return[null,new WhileDecl(i,a)]}},{key:"parseAssignment",value:function(){var e=this.lexer.next(),r=!1;if(e.id===_formcalc_lexer.TOKEN.var&&(r=!0,e=this.lexer.next()),e.id!==_formcalc_lexer.TOKEN.identifier)throw new Error(Errors.assignment);var t=e.value;if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.assign)throw new Error(Errors.assignment);var i=_slicedToArray(this.parseSimpleExpr(),2),n=i[0],s=i[1];return r?[n,new VarDecl(t,s)]:[n,new Assignment(t,s)]}},{key:"parseFor",value:function(){var e,r=null,t=!1,i=_slicedToArray(this.parseAssignment(),2),n=i[0],s=i[1];if((e=n||this.lexer.next()).id===_formcalc_lexer.TOKEN.upto)t=!0;else if(e.id!==_formcalc_lexer.TOKEN.downto)throw new Error(Errors.for);var a=_slicedToArray(this.parseSimpleExpr(),2),o=a[0],l=a[1];if((e=o||this.lexer.next()).id===_formcalc_lexer.TOKEN.step){var c=_slicedToArray(this.parseSimpleExpr(),2);e=c[0],r=c[1],e=e||this.lexer.next()}if(e.id!==_formcalc_lexer.TOKEN.do)throw new Error(Errors.for);var u=_slicedToArray(this.parseExprList(),2),p=u[0],f=u[1];if((e=p||this.lexer.next()).id!==_formcalc_lexer.TOKEN.endfor)throw new Error(Errors.for);return[null,new ForDecl(s,t,l,r,f)]}},{key:"parseForeach",value:function(){var e=this.lexer.next();if(e.id!==_formcalc_lexer.TOKEN.identifier)throw new Error(Errors.foreach);var r=e.value;if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.in)throw new Error(Errors.foreach);if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.leftParen)throw new Error(Errors.foreach);var t=SimpleExprParser.parseParams(this.lexer);if((e=this.lexer.next()).id!==_formcalc_lexer.TOKEN.do)throw new Error(Errors.foreach);var i=_slicedToArray(this.parseExprList(),2),n=i[0],s=i[1];if((e=n||this.lexer.next()).id!==_formcalc_lexer.TOKEN.endfor)throw new Error(Errors.foreach);return[null,new ForeachDecl(r,t,s)]}}]),r}();exports.Parser=Parser;