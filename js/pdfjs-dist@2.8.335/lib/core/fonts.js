"use strict";function _createForOfIteratorHelper(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw i}}}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,a,i,o,s=[],l=!0,c=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=i.call(r)).done)&&(s.push(n.value),s.length!==e);l=!0);}catch(t){c=!0,a=t}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(c)throw a}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFontType=getFontType,exports.ToUnicodeMap=exports.SEAC_ANALYSIS_ENABLED=exports.IdentityToUnicodeMap=exports.FontFlags=exports.Font=exports.ErrorFont=void 0;var _util=require("../shared/util.js"),_cff_parser=require("./cff_parser.js"),_glyphlist=require("./glyphlist.js"),_encodings=require("./encodings.js"),_standard_fonts=require("./standard_fonts.js"),_unicode=require("./unicode.js"),_core_utils=require("./core_utils.js"),_font_renderer=require("./font_renderer.js"),_cmap=require("./cmap.js"),_stream=require("./stream.js"),_type1_parser=require("./type1_parser.js"),PRIVATE_USE_AREAS=[[57344,63743],[1048576,1114109]],PDF_GLYPH_SPACE_UNITS=1e3,SEAC_ANALYSIS_ENABLED=!0;exports.SEAC_ANALYSIS_ENABLED=SEAC_ANALYSIS_ENABLED;var EXPORT_DATA_PROPERTIES=["ascent","bbox","black","bold","charProcOperatorList","composite","data","defaultVMetrics","defaultWidth","descent","fallbackName","fontMatrix","fontType","isMonospace","isSerifFont","isType3Font","italic","loadedName","mimetype","missingFile","name","remeasure","subtype","type","vertical"],EXPORT_DATA_EXTRA_PROPERTIES=["cMap","defaultEncoding","differences","isSymbolicFont","seacMap","toFontChar","toUnicode","vmetrics","widths"],FontFlags={FixedPitch:1,Serif:2,Symbolic:4,Script:8,Nonsymbolic:32,Italic:64,AllCap:65536,SmallCap:131072,ForceBold:262144};exports.FontFlags=FontFlags;var MacStandardGlyphOrdering=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function adjustWidths(t){if(t.fontMatrix&&t.fontMatrix[0]!==_util.FONT_IDENTITY_MATRIX[0]){var e=.001/t.fontMatrix[0],r=t.widths;for(var n in r)r[n]*=e;t.defaultWidth*=e}}function adjustToUnicode(t,e){if(!t.hasIncludedToUnicodeMap&&!(t.hasEncoding||e===t.defaultEncoding||t.toUnicode instanceof IdentityToUnicodeMap)){var r=[],n=(0,_glyphlist.getGlyphsUnicode)();for(var a in e){var i=e[a],o=(0,_unicode.getUnicodeForGlyph)(i,n);-1!==o&&(r[a]=String.fromCharCode(o))}t.toUnicode.amend(r)}}function getFontType(t,e){switch(t){case"Type1":return"Type1C"===e?_util.FontType.TYPE1C:_util.FontType.TYPE1;case"CIDFontType0":return"CIDFontType0C"===e?_util.FontType.CIDFONTTYPE0C:_util.FontType.CIDFONTTYPE0;case"OpenType":return _util.FontType.OPENTYPE;case"TrueType":return _util.FontType.TRUETYPE;case"CIDFontType2":return _util.FontType.CIDFONTTYPE2;case"MMType1":return _util.FontType.MMTYPE1;case"Type0":return _util.FontType.TYPE0;default:return _util.FontType.UNKNOWN}}function recoverGlyphName(t,e){if(void 0!==e[t])return t;var r=(0,_unicode.getUnicodeForGlyph)(t,e);if(-1!==r)for(var n in e)if(e[n]===r)return n;return(0,_util.info)("Unable to recover a standard glyph name for: "+t),t}var Glyph=function(){function t(t,e,r,n,a,i,o,s){this.fontChar=t,this.unicode=e,this.accent=r,this.width=n,this.vmetric=a,this.operatorListId=i,this.isSpace=o,this.isInFont=s}return t.prototype.matchesForCache=function(t,e,r,n,a,i,o,s){return this.fontChar===t&&this.unicode===e&&this.accent===r&&this.width===n&&this.vmetric===a&&this.operatorListId===i&&this.isSpace===o&&this.isInFont===s},t}(),ToUnicodeMap=function(){function t(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];this._map=t}return t.prototype={get length(){return this._map.length},forEach:function(t){for(var e in this._map)t(e,this._map[e].charCodeAt(0))},has:function(t){return void 0!==this._map[t]},get:function(t){return this._map[t]},charCodeOf:function(t){var e=this._map;if(e.length<=65536)return e.indexOf(t);for(var r in e)if(e[r]===t)return 0|r;return-1},amend:function(t){for(var e in t)this._map[e]=t[e]}},t}();exports.ToUnicodeMap=ToUnicodeMap;var IdentityToUnicodeMap=function(){function t(t,e){this.firstChar=t,this.lastChar=e}return t.prototype={get length(){return this.lastChar+1-this.firstChar},forEach:function(t){for(var e=this.firstChar,r=this.lastChar;e<=r;e++)t(e,e)},has:function(t){return this.firstChar<=t&&t<=this.lastChar},get:function(t){if(this.firstChar<=t&&t<=this.lastChar)return String.fromCharCode(t)},charCodeOf:function(t){return Number.isInteger(t)&&t>=this.firstChar&&t<=this.lastChar?t:-1},amend:function(t){(0,_util.unreachable)("Should not call amend()")}},t}();exports.IdentityToUnicodeMap=IdentityToUnicodeMap;var OpenTypeFileBuilder=function(){function p(t,e,r){t[e]=r>>8&255,t[e+1]=255&r}function g(t,e,r){t[e]=r>>24&255,t[e+1]=r>>16&255,t[e+2]=r>>8&255,t[e+3]=255&r}function y(t,e,r){var n,a;if(r instanceof Uint8Array)t.set(r,e);else if("string"==typeof r)for(n=0,a=r.length;n<a;n++)t[e++]=255&r.charCodeAt(n);else for(n=0,a=r.length;n<a;n++)t[e++]=255&r[n]}function v(t){this.sfnt=t,this.tables=Object.create(null)}v.getSearchParams=function(t,e){for(var r=1,n=0;r<(r^t);)r<<=1,n++;var a=r*e;return{range:a,entry:n,rangeShift:e*t-a}};return v.prototype={toArray:function(){var t=this.sfnt,e=this.tables,r=Object.keys(e);r.sort();var n,a,i,o,s,l=r.length,c=12+16*l,h=[c];for(n=0;n<l;n++){c+=((o=e[r[n]]).length+3&-4)>>>0,h.push(c)}var f=new Uint8Array(c);for(n=0;n<l;n++)o=e[r[n]],y(f,h[n],o);"true"===t&&(t=(0,_util.string32)(65536)),f[0]=255&t.charCodeAt(0),f[1]=255&t.charCodeAt(1),f[2]=255&t.charCodeAt(2),f[3]=255&t.charCodeAt(3),p(f,4,l);var d=v.getSearchParams(l,16);for(p(f,6,d.range),p(f,8,d.entry),p(f,10,d.rangeShift),c=12,n=0;n<l;n++){s=r[n],f[c]=255&s.charCodeAt(0),f[c+1]=255&s.charCodeAt(1),f[c+2]=255&s.charCodeAt(2),f[c+3]=255&s.charCodeAt(3);var u=0;for(a=h[n],i=h[n+1];a<i;a+=4){u=u+(0,_core_utils.readUint32)(f,a)>>>0}g(f,c+4,u),g(f,c+8,h[n]),g(f,c+12,e[s].length),c+=16}return f},addTable:function(t,e){if(t in this.tables)throw new Error("Table "+t+" already exists");this.tables[t]=e}},v}(),Font=function(){function t(t,e,r){var n;this.name=t,this.loadedName=r.loadedName,this.isType3Font=r.isType3Font,this.missingFile=!1,this.glyphCache=Object.create(null),this.isSerifFont=!!(r.flags&FontFlags.Serif),this.isSymbolicFont=!!(r.flags&FontFlags.Symbolic),this.isMonospace=!!(r.flags&FontFlags.FixedPitch);var a=r.type,i=r.subtype;this.type=a,this.subtype=i;var o="sans-serif";if(this.isMonospace?o="monospace":this.isSerifFont&&(o="serif"),this.fallbackName=o,this.differences=r.differences,this.widths=r.widths,this.defaultWidth=r.defaultWidth,this.composite=r.composite,this.cMap=r.cMap,this.capHeight=r.capHeight/PDF_GLYPH_SPACE_UNITS,this.ascent=r.ascent/PDF_GLYPH_SPACE_UNITS,this.descent=r.descent/PDF_GLYPH_SPACE_UNITS,this.fontMatrix=r.fontMatrix,this.bbox=r.bbox,this.defaultEncoding=r.defaultEncoding,this.toUnicode=r.toUnicode,this.fallbackToUnicode=r.fallbackToUnicode||new ToUnicodeMap,this.toFontChar=[],"Type3"!==r.type){if(this.cidEncoding=r.cidEncoding,this.vertical=!!r.vertical,this.vertical&&(this.vmetrics=r.vmetrics,this.defaultVMetrics=r.defaultVMetrics),!e||e.isEmpty)return e&&(0,_util.warn)('Font file is empty in "'+t+'" ('+this.loadedName+")"),void this.fallbackToSystemFont(r);var s=_slicedToArray(function(t,e){var r,n,a=e.type,i=e.subtype,o=e.composite;f=t,d=f.peekBytes(4),65536===(0,_core_utils.readUint32)(d,0)||"true"===(0,_util.bytesToString)(d)||at(t)?r=o?"CIDFontType2":"TrueType":(c=t,h=c.peekBytes(4),"OTTO"===(0,_util.bytesToString)(h)?r=o?"CIDFontType2":"OpenType":(s=t,l=s.peekBytes(2),37===l[0]&&33===l[1]||128===l[0]&&1===l[1]?r=o?"CIDFontType0":"MMType1"===a?"MMType1":"Type1":n=function(t){var e=t.peekBytes(4);if(1<=e[0]&&1<=e[3]&&e[3]<=4)return!0;return!1}(t)?o?(r="CIDFontType0","CIDFontType0C"):(r="MMType1"===a?"MMType1":"Type1","Type1C"):((0,_util.warn)("getFontFileType: Unable to detect correct font file Type/Subtype."),r=a,i)));var s,l;var c,h;var f,d;return[r,n]}(e,r),2);a=s[0],i=s[1],a===this.type&&i===this.subtype||(0,_util.info)("Inconsistent font file Type/SubType, expected: "+"".concat(this.type,"/").concat(this.subtype," but found: ").concat(a,"/").concat(i,"."));try{var l;switch(a){case"MMType1":(0,_util.info)("MMType1 font ("+t+"), falling back to Type1.");case"Type1":case"CIDFontType0":this.mimetype="font/opentype";var c="Type1C"===i||"CIDFontType0C"===i?new CFFFont(e,r):new Type1Font(t,e,r);adjustWidths(r),l=this.convert(t,c,r);break;case"OpenType":case"TrueType":case"CIDFontType2":this.mimetype="font/opentype",l=this.checkAndRepair(t,e,r),this.isOpenType&&(adjustWidths(r),a="OpenType");break;default:throw new _util.FormatError("Font ".concat(a," is not supported"))}}catch(t){return(0,_util.warn)(t),void this.fallbackToSystemFont(r)}this.data=l,this.fontType=getFontType(a,i),this.fontMatrix=r.fontMatrix,this.widths=r.widths,this.defaultWidth=r.defaultWidth,this.toUnicode=r.toUnicode,this.seacMap=r.seacMap}else{for(n=0;n<256;n++)this.toFontChar[n]=this.differences[n]||r.defaultEncoding[n];this.fontType=_util.FontType.TYPE3}}function rt(t,e){return(t<<8)+e}function nt(t,e){var r=(t<<8)+e;return 32768&r?r-65536:r}function U(t){return String.fromCharCode(t>>8&255,255&t)}function x(t){return 32767<t?t=32767:t<-32768&&(t=-32768),String.fromCharCode(t>>8&255,255&t)}function at(t){var e=t.peekBytes(4);return"ttcf"===(0,_util.bytesToString)(e)}function E(t,e,r){for(var n,a=[],i=0,o=t.length;i<o;i++)-1!==(n=(0,_unicode.getUnicodeForGlyph)(t[i],e))&&(a[i]=n);for(var s in r)-1!==(n=(0,_unicode.getUnicodeForGlyph)(r[s],e))&&(a[+s]=n);return a}function it(t,e,r){var n=Object.create(null),a=[],i=0,o=PRIVATE_USE_AREAS[i][0],s=PRIVATE_USE_AREAS[i][1];for(var l in t){var c=t[l|=0];if(e(c)){if(s<o){if(++i>=PRIVATE_USE_AREAS.length){(0,_util.warn)("Ran out of space in font private use area.");break}o=PRIVATE_USE_AREAS[i][0],s=PRIVATE_USE_AREAS[i][1]}var h=o++;0===c&&(c=r),n[h]=c,a[l]=h}}return{toFontChar:a,charCodeToGlyphId:n,nextAvailableFontCharCode:o}}function ot(t,e){var r,n,a,i,o=function(t,e){var r=[];for(var n in t)t[n]>=e||r.push({fontCharCode:0|n,glyphId:t[n]});0===r.length&&r.push({fontCharCode:0,glyphId:0}),r.sort(function(t,e){return t.fontCharCode-e.fontCharCode});for(var a=[],i=r.length,o=0;o<i;){var s=r[o].fontCharCode,l=[r[o].glyphId];++o;for(var c=s;o<i&&c+1===r[o].fontCharCode&&(l.push(r[o].glyphId),++o,65535!=++c););a.push([s,c,l])}return a}(t,e),s=65535<o[o.length-1][1]?2:1,l="\0\0"+U(s)+"\0\0"+(0,_util.string32)(4+8*s);for(r=o.length-1;0<=r&&!(o[r][0]<=65535);--r);var c=r+1;o[r][0]<65535&&65535===o[r][1]&&(o[r][1]=65534);var h,f,d,u,p=o[r][1]<65535?1:0,g=c+p,y=OpenTypeFileBuilder.getSearchParams(g,2),v="",m="",_="",T="",F="",C=0;for(r=0,n=c;r<n;r++){f=(h=o[r])[0],d=h[1],v+=U(f),m+=U(d);var b=!0;for(a=1,i=(u=h[2]).length;a<i;++a)if(u[a]!==u[a-1]+1){b=!1;break}if(b){_+=U(u[0]-f&65535),T+=U(0)}else{var S=2*(g-r)+2*C;for(C+=d-f+1,_+=U(0),T+=U(S),a=0,i=u.length;a<i;++a)F+=U(u[a])}}0<p&&(m+="Ã¿Ã¿",v+="Ã¿Ã¿",_+="\0",T+="\0\0");var E="\0\0"+U(2*g)+U(y.range)+U(y.entry)+U(y.rangeShift)+m+"\0\0"+v+_+T+F,I="",A="";if(1<s){for(l+="\0\0\n"+(0,_util.string32)(4+8*s+4+E.length),I="",r=0,n=o.length;r<n;r++){f=(h=o[r])[0];var w=(u=h[2])[0];for(a=1,i=u.length;a<i;++a)u[a]!==u[a-1]+1&&(d=h[0]+a-1,I+=(0,_util.string32)(f)+(0,_util.string32)(d)+(0,_util.string32)(w),f=d+1,w=u[a]);I+=(0,_util.string32)(f)+(0,_util.string32)(h[1])+(0,_util.string32)(w)}A="\0\f\0\0"+(0,_util.string32)(I.length+16)+"\0\0\0\0"+(0,_util.string32)(I.length/12)}return l+"\0"+U(E.length+4)+E+A+I}function st(t,e,r){r=r||{unitsPerEm:0,yMax:0,yMin:0,ascent:0,descent:0};var n=0,a=0,i=0,o=0,s=null,l=0;if(e){for(var c in e){((c|=0)<s||!s)&&(s=c),l<c&&(l=c);var h=(0,_unicode.getUnicodeRangeFor)(c);if(h<32)n|=1<<h;else if(h<64)a|=1<<h-32;else if(h<96)i|=1<<h-64;else{if(!(h<123))throw new _util.FormatError("Unicode ranges Bits > 123 are reserved for internal usage");o|=1<<h-96}}65535<l&&(l=65535)}else s=0,l=255;var f=t.bbox||[0,0,0,0],d=r.unitsPerEm||1/(t.fontMatrix||_util.FONT_IDENTITY_MATRIX)[0],u=t.ascentScaled?1:d/PDF_GLYPH_SPACE_UNITS,p=r.ascent||Math.round(u*(t.ascent||f[3])),g=r.descent||Math.round(u*(t.descent||f[1]));0<g&&0<t.descent&&f[1]<0&&(g=-g);var y=r.yMax||p,v=-r.yMin||-g;return"\0$Ã´\0\0\0ÂŠÂ»\0\0\0ÂŒÂŠÂ»\0\0ÃŸ\x001\0\0\0\0"+String.fromCharCode(t.fixedPitch?9:0)+"\0\0\0\0\0\0"+(0,_util.string32)(n)+(0,_util.string32)(a)+(0,_util.string32)(i)+(0,_util.string32)(o)+"*21*"+U(t.italicAngle?1:0)+U(s||t.firstChar)+U(l||t.lastChar)+U(p)+U(g)+"\0d"+U(y)+U(v)+"\0\0\0\0\0\0\0\0"+U(t.xHeight)+U(t.capHeight)+U(0)+U(s||t.firstChar)+"\0"}function lt(t){var e=Math.floor(t.italicAngle*Math.pow(2,16));return"\0\0\0"+(0,_util.string32)(e)+"\0\0\0\0"+(0,_util.string32)(t.fixedPitch)+"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}function ct(t,e){e||(e=[[],[]]);var r,n,a,i,o,s=[e[0][0]||"Original licence",e[0][1]||t,e[0][2]||"Unknown",e[0][3]||"uniqueID",e[0][4]||t,e[0][5]||"Version 0.11",e[0][6]||"",e[0][7]||"Unknown",e[0][8]||"Unknown",e[0][9]||"Unknown"],l=[];for(r=0,n=s.length;r<n;r++){var c=[];for(a=0,i=(o=e[1][r]||s[r]).length;a<i;a++)c.push(U(o.charCodeAt(a)));l.push(c.join(""))}var h=[s,l],f=["\0","\0"],d=["\0\0","\0"],u=["\0\0","\t"],p=s.length*f.length,g="\0\0"+U(p)+U(12*p+6),y=0;for(r=0,n=f.length;r<n;r++){var v=h[r];for(a=0,i=v.length;a<i;a++){o=v[a],g+=f[r]+d[r]+u[r]+U(a)+U(o.length)+U(y),y+=o.length}}return g+=s.join("")+l.join("")}return t.prototype={name:null,font:null,mimetype:null,disableFontFace:!1,get renderer(){var t=_font_renderer.FontRendererFactory.create(this,SEAC_ANALYSIS_ENABLED);return(0,_util.shadow)(this,"renderer",t)},exportData:function(){var t,e,r,n=0<arguments.length&&void 0!==arguments[0]&&arguments[0]?[].concat(EXPORT_DATA_PROPERTIES,EXPORT_DATA_EXTRA_PROPERTIES):EXPORT_DATA_PROPERTIES,a=Object.create(null),i=_createForOfIteratorHelper(n);try{for(i.s();!(r=i.n()).done;)void 0!==(e=this[t=r.value])&&(a[t]=e)}catch(t){i.e(t)}finally{i.f()}return a},fallbackToSystemFont:function(t){var a=this;this.missingFile=!0;var e=this.name,r=this.type,n=this.subtype,i=e.replace(/[,_]/g,"-").replace(/\s/g,""),o=(0,_standard_fonts.getStdFontMap)(),s=(0,_standard_fonts.getNonStdFontMap)(),l=!!o[i],c=!(!s[i]||!o[s[i]]);i=o[i]||s[i]||i,this.bold=-1!==i.search(/bold/gi),this.italic=-1!==i.search(/oblique/gi)||-1!==i.search(/italic/gi),this.black=-1!==e.search(/Black/g);var h=-1!==e.search(/Narrow/g);if(this.remeasure=(!l||h)&&0<Object.keys(this.widths).length,(l||c)&&"CIDFontType2"===r&&this.cidEncoding.startsWith("Identity-")){var f=(0,_standard_fonts.getGlyphMapForStandardFonts)(),d=t.cidToGidMap,u=[];for(var p in f)u[+p]=f[p];if(/Arial-?Black/i.test(e)){var g=(0,_standard_fonts.getSupplementalGlyphMapForArialBlack)();for(var y in g)u[+y]=g[y]}else if(/Calibri/i.test(e)){var v=(0,_standard_fonts.getSupplementalGlyphMapForCalibri)();for(var m in v)u[+m]=v[m]}if(d)for(var _ in u){var T=u[_];void 0!==d[T]&&(u[+_]=d[T])}this.toUnicode instanceof IdentityToUnicodeMap||this.toUnicode.forEach(function(t,e){u[+t]=e}),this.toFontChar=u,this.toUnicode=new ToUnicodeMap(u)}else if(/Symbol/i.test(i))this.toFontChar=E(_encodings.SymbolSetEncoding,(0,_glyphlist.getGlyphsUnicode)(),this.differences);else if(/Dingbats/i.test(i))/Wingdings/i.test(e)&&(0,_util.warn)("Non-embedded Wingdings font, falling back to ZapfDingbats."),this.toFontChar=E(_encodings.ZapfDingbatsEncoding,(0,_glyphlist.getDingbatsGlyphsUnicode)(),this.differences);else if(l)this.toFontChar=E(this.defaultEncoding,(0,_glyphlist.getGlyphsUnicode)(),this.differences);else{var F=(0,_glyphlist.getGlyphsUnicode)(),C=[];if(this.toUnicode.forEach(function(t,e){if(!a.composite){var r=a.differences[t]||a.defaultEncoding[t],n=(0,_unicode.getUnicodeForGlyph)(r,F);-1!==n&&(e=n)}C[+t]=e}),this.composite&&this.toUnicode instanceof IdentityToUnicodeMap&&/Verdana/i.test(e)){var b=(0,_standard_fonts.getGlyphMapForStandardFonts)();for(var S in b)C[+S]=b[S]}this.toFontChar=C}this.loadedName=i.split("-")[0],this.fontType=getFontType(r,n)},checkAndRepair:function(t,v,e){var i=["OS/2","cmap","head","hhea","hmtx","maxp","name","post","loca","glyf","fpgm","prep","cvt ","CFF "];function p(t,e){var r=Object.create(null);r["OS/2"]=null,r.cmap=null,r.head=null,r.hhea=null,r.hmtx=null,r.maxp=null,r.name=null,r.post=null;for(var n=0;n<e;n++){var a=o(t);i.includes(a.tag)&&(0!==a.length&&(r[a.tag]=a))}return r}function o(t){var e=(0,_util.bytesToString)(t.getBytes(4)),r=t.getInt32()>>>0,n=t.getInt32()>>>0,a=t.getInt32()>>>0,i=t.pos;t.pos=t.start?t.start:0,t.skip(n);var o=t.getBytes(a);return t.pos=i,"head"===e&&(o[8]=o[9]=o[10]=o[11]=0,o[17]|=32),{tag:e,checksum:r,length:a,offset:n,data:o}}function g(t){return{version:(0,_util.bytesToString)(t.getBytes(4)),numTables:t.getUint16(),searchRange:t.getUint16(),entrySelector:t.getUint16(),rangeShift:t.getUint16()}}function I(t,e,r,n,a,i){var o={length:0,sizeOfInstructions:0};if(r-e<=12)return o;var s,l,c,h=t.subarray(e,r),f=nt(h[0],h[1]);if(f<0)return c=f=-1,(s=h)[(l=0)+1]=c,s[l]=c>>>8,n.set(h,a),o.length=h.length,o;var d,u=10,p=0;for(d=0;d<f;d++){p=(h[u]<<8|h[u+1])+1,u+=2}var g=u,y=h[u]<<8|h[u+1],v=u+=2+(o.sizeOfInstructions=y),m=0;for(d=0;d<p;d++){var _=h[u++];192&_&&(h[u-1]=63&_);var T=2;2&_?T=1:16&_&&(T=0);var F=2;4&_?F=1:32&_&&(F=0);var C=T+F;if(m+=C,8&_){var b=h[u++];d+=b,m+=b*C}}if(0===m)return o;var S=u+m;return S>h.length||(!i&&0<y?(n.set(h.subarray(0,g),a),n.set([0,0],a+g),n.set(h.subarray(v,S),a+g+2),S-=y,3<h.length-S&&(S=S+3&-4),o.length=S):3<h.length-S?(S=S+3&-4,n.set(h.subarray(0,S),a),o.length=S):(n.set(h,a),o.length=h.length)),o}function y(t){var e=(v.start?v.start:0)+t.offset;v.pos=e;var r=[[],[]],n=t.length,a=e+n;if(0!==v.getUint16()||n<6)return r;var i,o,s=v.getUint16(),l=v.getUint16(),c=[];for(i=0;i<s&&v.pos+12<=a;i++){var h={platform:v.getUint16(),encoding:v.getUint16(),language:v.getUint16(),name:v.getUint16(),length:v.getUint16(),offset:v.getUint16()};(1===h.platform&&0===h.encoding&&0===h.language||3===h.platform&&1===h.encoding&&1033===h.language)&&c.push(h)}for(i=0,o=c.length;i<o;i++){var f=c[i];if(!(f.length<=0)){var d=e+l+f.offset;if(!(d+f.length>a)){v.pos=d;var u=f.name;if(f.encoding){for(var p="",g=0,y=f.length;g<y;g+=2)p+=String.fromCharCode(v.getUint16());r[1][u]=p}else r[0][u]=(0,_util.bytesToString)(v.getBytes(f.length))}}}return r}var r,n,a,s,S=[0,0,0,0,0,0,0,0,-2,-2,-2,-2,0,0,-2,-5,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,1,-1,-999,0,1,0,-1,-2,0,-1,-2,-1,-1,0,-1,-1,0,0,-999,-999,-1,-1,-1,-1,-2,-999,-2,-2,-999,0,-2,-2,0,0,-2,0,-2,0,0,0,-2,-1,-1,1,1,0,0,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,-1,-1,0,-999,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,-2,-999,-999,-999,-999,-999,-1,-1,-2,-2,0,0,0,0,-1,-1,-999,-2,-2,0,0,-1,-2,-2,0,0,0,-1,-1,-1,-2];function l(t,e){for(var r,n,a,i,o,s=t.data,l=0,c=0,h=0,f=[],d=[],u=[],p=e.tooComplexToFollowFunctions,g=!1,y=0,v=0,m=s.length;l<m;){var _=s[l++];if(64===_)if(n=s[l++],g||v)l+=n;else for(r=0;r<n;r++)f.push(s[l++]);else if(65===_)if(n=s[l++],g||v)l+=2*n;else for(r=0;r<n;r++)a=s[l++],f.push(a<<8|s[l++]);else if(176==(248&_))if(n=_-176+1,g||v)l+=n;else for(r=0;r<n;r++)f.push(s[l++]);else if(184==(248&_))if(n=_-184+1,g||v)l+=2*n;else for(r=0;r<n;r++)a=s[l++],f.push(a<<8|s[l++]);else if(43!==_||p)if(44!==_||p){if(45===_)if(g)g=!1,c=l;else{if(!(o=d.pop()))return(0,_util.warn)("TT: ENDF bad stack"),void(e.hintsValid=!1);i=u.pop(),s=o.data,l=o.i,e.functionsStackDeltas[i]=f.length-o.stackTop}else if(137===_)(g||v)&&((0,_util.warn)("TT: nested IDEFs not allowed"),p=!0),g=!0,h=l;else if(88===_)++y;else if(27===_)v=y;else if(89===_)v===y&&(v=0),--y;else if(28===_&&!g&&!v){var T=f[f.length-1];0<T&&(l+=T-1)}}else(g||v)&&((0,_util.warn)("TT: nested FDEFs not allowed"),p=!0),g=!0,h=l,i=f.pop(),e.functionsDefined[i]={data:s,i:l};else if(!g&&!v)if(i=f[f.length-1],isNaN(i))(0,_util.info)("TT: CALL empty stack (or invalid entry).");else if(e.functionsUsed[i]=!0,i in e.functionsStackDeltas){var F=f.length+e.functionsStackDeltas[i];if(F<0)return(0,_util.warn)("TT: CALL invalid functions stack delta."),void(e.hintsValid=!1);f.length=F}else if(i in e.functionsDefined&&!u.includes(i)){if(d.push({data:s,i:l,stackTop:f.length-1}),u.push(i),!(o=e.functionsDefined[i]))return(0,_util.warn)("TT: CALL non-existent function"),void(e.hintsValid=!1);s=o.data,l=o.i}if(!g&&!v){var C=0;for(_<=142?C=S[_]:192<=_&&_<=223?C=-1:224<=_&&(C=-2),113<=_&&_<=117&&(n=f.pop(),isNaN(n)||(C=2*-n));C<0&&0<f.length;)f.pop(),C++;for(;0<C;)f.push(NaN),C--}}e.tooComplexToFollowFunctions=p;var b=[s];l>s.length&&b.push(new Uint8Array(l-s.length)),c<h&&((0,_util.warn)("TT: complementing a missing function tail"),b.push(new Uint8Array([34,45]))),function(t,e){if(1<e.length){var r,n,a=0;for(r=0,n=e.length;r<n;r++)a+=e[r].length;a=a+3&-4;var i=new Uint8Array(a),o=0;for(r=0,n=e.length;r<n;r++)i.set(e[r],o),o+=e[r].length;t.data=i,t.length=a}}(t,b)}if(at(v=new _stream.Stream(new Uint8Array(v.getBytes())))){var c=function(t,e){for(var r=function(t){var e=(0,_util.bytesToString)(t.getBytes(4));(0,_util.assert)("ttcf"===e,"Must be a TrueType Collection font.");for(var r=t.getUint16(),n=t.getUint16(),a=t.getInt32()>>>0,i=[],o=0;o<a;o++)i.push(t.getInt32()>>>0);var s={ttcTag:e,majorVersion:r,minorVersion:n,numFonts:a,offsetTable:i};switch(r){case 1:return s;case 2:return s.dsigTag=t.getInt32()>>>0,s.dsigLength=t.getInt32()>>>0,s.dsigOffset=t.getInt32()>>>0,s}throw new _util.FormatError("Invalid TrueType Collection majorVersion: ".concat(r,"."))}(t),n=r.numFonts,a=r.offsetTable,i=0;i<n;i++){t.pos=(t.start||0)+a[i];var o=g(t),s=p(t,o.numTables);if(!s.name)throw new _util.FormatError('TrueType Collection font must contain a "name" table.');for(var l=y(s.name),c=0,h=l.length;c<h;c++)for(var f=0,d=l[c].length;f<d;f++){var u=l[c][f];if(u&&u.replace(/\s/g,"")===e)return{header:o,tables:s}}}throw new _util.FormatError('TrueType Collection does not contain "'.concat(e,'" font.'))}(v,this.name);r=c.header,n=c.tables}else r=g(v),n=p(v,r.numTables);var h=!n["CFF "];if(h){if(!n.loca)throw new _util.FormatError('Required "loca" table is not found');n.glyf||((0,_util.warn)('Required "glyf" table is not found -- trying to recover.'),n.glyf={tag:"glyf",data:new Uint8Array(0)}),this.isOpenType=!1}else{var f=e.composite&&(0<(e.cidToGidMap||[]).length||!(e.cMap instanceof _cmap.IdentityCMap));if("OTTO"===r.version&&!f||!n.head||!n.hhea||!n.maxp||!n.post)return s=new _stream.Stream(n["CFF "].data),a=new CFFFont(s,e),adjustWidths(e),this.convert(t,a,e);delete n.glyf,delete n.loca,delete n.fpgm,delete n.prep,delete n["cvt "],this.isOpenType=!0}if(!n.maxp)throw new _util.FormatError('Required "maxp" table is not found');v.pos=(v.start||0)+n.maxp.offset;var d=v.getInt32(),u=v.getUint16(),m=u+1,_=!0;65535<m&&(_=!1,m=u,(0,_util.warn)("Not enough space in glyfs to duplicate first glyph."));var T=0,F=0;65536<=d&&22<=n.maxp.length&&(v.pos+=8,2<v.getUint16()&&(n.maxp.data[14]=0,n.maxp.data[15]=2),v.pos+=4,T=v.getUint16(),v.pos+=4,F=v.getUint16());n.maxp.data[4]=m>>8,n.maxp.data[5]=255&m;var C=function(t,e,r,n){var a={functionsDefined:[],functionsUsed:[],functionsStackDeltas:[],tooComplexToFollowFunctions:!1,hintsValid:!0};if(t&&l(t,a),e&&l(e,a),t&&function(t,e){if(!t.tooComplexToFollowFunctions){if(t.functionsDefined.length>e)return(0,_util.warn)("TT: more functions defined than expected"),t.hintsValid=!1;for(var r=0,n=t.functionsUsed.length;r<n;r++){if(e<r)return(0,_util.warn)("TT: invalid function id: "+r),t.hintsValid=!1;if(t.functionsUsed[r]&&!t.functionsDefined[r])return(0,_util.warn)("TT: undefined function: "+r),t.hintsValid=!1}}}(a,n),r&&1&r.length){var i=new Uint8Array(r.length+1);i.set(r.data),r.data=i}return a.hintsValid}(n.fpgm,n.prep,n["cvt "],T);if(C||(delete n.fpgm,delete n.prep,delete n["cvt "]),function(t,e,r,n,a){if(e){t.pos=(t.start?t.start:0)+e.offset,t.pos+=4,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=8,t.pos+=2;var i=t.getUint16();n<i&&((0,_util.info)("The numOfMetrics ("+i+") should not be greater than the numGlyphs ("+n+")"),i=n,e.data[34]=(65280&i)>>8,e.data[35]=255&i);var o=n-i-(r.length-4*i>>1);if(0<o){var s=new Uint8Array(r.length+2*o);s.set(r.data),a&&(s[r.length]=r.data[2],s[r.length+1]=r.data[3]),r.data=s}}else r&&(r.data=null)}(v,n.hhea,n.hmtx,m,_),!n.head)throw new _util.FormatError('Required "head" table is not found');!function(t,e,r){var n,a,i,o,s=t.data,l=(n=s[0],a=s[1],i=s[2],o=s[3],(n<<24)+(a<<16)+(i<<8)+o);l>>16!=1&&((0,_util.info)("Attempting to fix invalid version in head table: "+l),s[0]=0,s[1]=1,s[2]=0,s[3]=0);var c=rt(s[50],s[51]);if(c<0||1<c){(0,_util.info)("Attempting to fix invalid indexToLocFormat in head table: "+c);var h=e+1;if(r===h<<1)s[50]=0,s[51]=0;else{if(r!==h<<2)throw new _util.FormatError("Could not fix indexToLocFormat: "+c);s[50]=0,s[51]=1}}}(n.head,u,h?n.loca.length:0);var b=Object.create(null);if(h){var E=rt(n.head.data[50],n.head.data[51]),A=function(t,e,r,n,a,i,o){var s,l,c;c=n?(s=4,l=function(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]},function(t,e,r){t[e]=r>>>24&255,t[e+1]=r>>16&255,t[e+2]=r>>8&255,t[e+3]=255&r}):(s=2,l=function(t,e){return t[e]<<9|t[e+1]<<1},function(t,e,r){t[e]=r>>9&255,t[e+1]=r>>1&255});var h=i?r+1:r,f=s*(1+h),d=new Uint8Array(f);d.set(t.data.subarray(0,f)),t.data=d;var u,p,g=e.data,y=g.length,v=new Uint8Array(y),m=[];for(p=u=0;u<r+1;u++,p+=s){var _=l(d,p);y<_&&(_=y),m.push({index:u,offset:_,endOffset:0})}for(m.sort(function(t,e){return t.offset-e.offset}),u=0;u<r;u++)m[u].endOffset=m[u+1].offset;m.sort(function(t,e){return t.index-e.index});var T=Object.create(null),F=0;for(c(d,0,F),u=0,p=s;u<r;u++,p+=s){var C=I(g,m[u].offset,m[u].endOffset,v,F,a),b=C.length;0===b&&(T[u]=!0),C.sizeOfInstructions>o&&(o=C.sizeOfInstructions),c(d,p,F+=b)}if(0===F){var S=new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,49,0]);for(u=0,p=s;u<h;u++,p+=s)c(d,p,S.length);e.data=S}else if(i){var E=l(d,s);v.length>E+F?e.data=v.subarray(0,E+F):(e.data=new Uint8Array(E+F),e.data.set(v.subarray(0,F))),e.data.set(v.subarray(0,E),F),c(t.data,d.length-s,F+E)}else e.data=v.subarray(0,F);return{missingGlyphs:T,maxSizeOfInstructions:o}}(n.loca,n.glyf,u,E,C,_,F);b=A.missingGlyphs,65536<=d&&22<=n.maxp.length&&(n.maxp.data[26]=A.maxSizeOfInstructions>>8,n.maxp.data[27]=255&A.maxSizeOfInstructions)}if(!n.hhea)throw new _util.FormatError('Required "hhea" table is not found');0===n.hhea.data[10]&&0===n.hhea.data[11]&&(n.hhea.data[10]=255,n.hhea.data[11]=255);var w={unitsPerEm:rt(n.head.data[18],n.head.data[19]),yMax:rt(n.head.data[42],n.head.data[43]),yMin:nt(n.head.data[38],n.head.data[39]),ascent:rt(n.hhea.data[4],n.hhea.data[5]),descent:nt(n.hhea.data[6],n.hhea.data[7])};this.ascent=w.ascent/w.unitsPerEm,this.descent=w.descent/w.unitsPerEm,n.post&&function(t,e,r){var n,a=(v.start?v.start:0)+t.offset,i=(v.pos=a)+t.length,o=v.getInt32();v.skip(28);var s,l=!0;switch(o){case 65536:n=MacStandardGlyphOrdering;break;case 131072:var c=v.getUint16();if(c!==r){l=!1;break}var h=[];for(s=0;s<c;++s){var f=v.getUint16();if(32768<=f){l=!1;break}h.push(f)}if(!l)break;for(var d=[],u=[];v.pos<i;){var p=v.getByte();for(u.length=p,s=0;s<p;++s)u[s]=String.fromCharCode(v.getByte());d.push(u.join(""))}for(n=[],s=0;s<c;++s){var g=h[s];g<258?n.push(MacStandardGlyphOrdering[g]):n.push(d[g-258])}break;case 196608:break;default:(0,_util.warn)("Unknown/unsupported post table version "+o),l=!1,e.defaultEncoding&&(n=e.defaultEncoding)}e.glyphNames=n}(n.post,e,u),n.post={tag:"post",data:lt(e)};var U=[];function x(t){return!b[t]}if(e.composite){var M=e.cidToGidMap||[],O=0===M.length;e.cMap.forEach(function(t,e){if(65535<e)throw new _util.FormatError("Max size of CID is 65,535");var r=-1;O?r=e:void 0!==M[e]&&(r=M[e]),0<=r&&r<u&&x(r)&&(U[t]=r)})}else{var N=function(t,e,r,n){if(!t)return(0,_util.warn)("No cmap table available."),{platformId:-1,encodingId:-1,mappings:[],hasShortCmap:!1};var a,i=(e.start?e.start:0)+t.offset;e.pos=i,e.skip(2);for(var o,s=e.getUint16(),l=!1,c=0;c<s;c++){var h=e.getUint16(),f=e.getUint16(),d=e.getInt32()>>>0,u=!1;if((!o||o.platformId!==h||o.encodingId!==f)&&(0!==h||0!==f&&1!==f&&3!==f?1===h&&0===f?u=!0:3!==h||1!==f||!n&&o?r&&3===h&&0===f&&(l=u=!0):(u=!0,r||(l=!0)):u=!0,u&&(o={platformId:h,encodingId:f,offset:d}),l))break}if(o&&(e.pos=i+o.offset),!o||-1===e.peekByte())return(0,_util.warn)("Could not find a preferred cmap table."),{platformId:-1,encodingId:-1,mappings:[],hasShortCmap:!1};var p=e.getUint16();e.skip(4);var g,y,v=!1,m=[];if(0===p){for(g=0;g<256;g++){var _=e.getByte();_&&m.push({charCode:g,glyphId:_})}v=!0}else if(4===p){var T=e.getUint16()>>1;e.skip(6);var F,C=[];for(F=0;F<T;F++)C.push({end:e.getUint16()});for(e.skip(2),F=0;F<T;F++)C[F].start=e.getUint16();for(F=0;F<T;F++)C[F].delta=e.getUint16();var b=0;for(F=0;F<T;F++){a=C[F];var S=e.getUint16();if(S){var E=(S>>1)-(T-F);a.offsetIndex=E,b=Math.max(b,E+a.end-a.start+1)}else a.offsetIndex=-1}var I=[];for(g=0;g<b;g++)I.push(e.getUint16());for(F=0;F<T;F++){i=(a=C[F]).start;var A=a.end,w=a.delta;for(E=a.offsetIndex,g=i;g<=A;g++)65535!==g&&(y=(y=E<0?g:I[E+g-i])+w&65535,m.push({charCode:g,glyphId:y}))}}else{if(6!==p)return(0,_util.warn)("cmap table has unsupported format: "+p),{platformId:-1,encodingId:-1,mappings:[],hasShortCmap:!1};var U=e.getUint16(),x=e.getUint16();for(g=0;g<x;g++){y=e.getUint16();var M=U+g;m.push({charCode:M,glyphId:y})}}for(m.sort(function(t,e){return t.charCode-e.charCode}),c=1;c<m.length;c++)m[c-1].charCode===m[c].charCode&&(m.splice(c,1),c--);return{platformId:o.platformId,encodingId:o.encodingId,mappings:m,hasShortCmap:v}}(n.cmap,v,this.isSymbolicFont,e.hasEncoding),k=N.platformId,P=N.encodingId,D=N.mappings,G=D.length,B=[];if(!e.hasEncoding||"MacRomanEncoding"!==e.baseEncodingName&&"WinAnsiEncoding"!==e.baseEncodingName||(B=(0,_encodings.getEncoding)(e.baseEncodingName)),e.hasEncoding&&!this.isSymbolicFont&&(3===k&&1===P||1===k&&0===P))for(var j=(0,_glyphlist.getGlyphsUnicode)(),R=0;R<256;R++){var L,q;if(L=this.differences&&R in this.differences?this.differences[R]:R in B&&""!==B[R]?B[R]:_encodings.StandardEncoding[R]){var Y;q=recoverGlyphName(L,j),3===k&&1===P?Y=j[q]:1===k&&0===P&&(Y=_encodings.MacRomanEncoding.indexOf(q));for(var V=0;V<G;++V)if(D[V].charCode===Y){U[R]=D[V].glyphId;break}}}else if(0===k)for(var W=0;W<G;++W)U[D[W].charCode]=D[W].glyphId;else for(var H=0;H<G;++H){var z=D[H].charCode;3===k&&61440<=z&&z<=61695&&(z&=255),U[z]=D[H].glyphId}if(e.glyphNames&&(B.length||this.differences.length))for(var X=0;X<256;++X)if(void 0===U[X]&&(L=this.differences[X]||B[X])){var Z=e.glyphNames.indexOf(L);0<Z&&x(Z)&&(U[X]=Z)}}0===U.length&&(U[0]=0);var K=m-1;_||(K=0);var $=it(U,x,K);if(this.toFontChar=$.toFontChar,n.cmap={tag:"cmap",data:ot($.charCodeToGlyphId,m)},n["OS/2"]&&function(t,e){e.pos=(e.start||0)+t.offset;var r=e.getUint16();e.skip(60);var n=e.getUint16();if(r<4&&768&n)return!1;var a=e.getUint16();return!(e.getUint16()<a||(e.skip(6),0===e.getUint16()||(t.data[8]=t.data[9]=0,0)))}(n["OS/2"],v)||(n["OS/2"]={tag:"OS/2",data:st(e,$.charCodeToGlyphId,w)}),!h)try{s=new _stream.Stream(n["CFF "].data),(a=new _cff_parser.CFFParser(s,e,SEAC_ANALYSIS_ENABLED).parse()).duplicateFirstGlyph();var J=new _cff_parser.CFFCompiler(a);n["CFF "].data=J.compile()}catch(t){(0,_util.warn)("Failed to compile font "+e.loadedName)}if(n.name){var Q=y(n.name);n.name.data=ct(t,Q)}else n.name={tag:"name",data:ct(this.name)};var tt=new OpenTypeFileBuilder(r.version);for(var et in n)tt.addTable(et,n[et].data);return tt.toArray()},convert:function(t,s,e){e.fixedPitch=!1,e.builtInEncoding&&adjustToUnicode(e,e.builtInEncoding);var r=1;s instanceof CFFFont&&(r=s.numGlyphs-1);var n=s.getGlyphMapping(e),a=it(n,s.hasGlyphId.bind(s),r);this.toFontChar=a.toFontChar;var l=s.numGlyphs;function i(t,e){var r=null;for(var n in t)e===t[n]&&(r||(r=[]),r.push(0|n));return r}function o(t,e){for(var r in t)if(e===t[r])return 0|r;return a.charCodeToGlyphId[a.nextAvailableFontCharCode]=e,a.nextAvailableFontCharCode++}var c=s.seacs;if(SEAC_ANALYSIS_ENABLED&&c&&c.length){var h=e.fontMatrix||_util.FONT_IDENTITY_MATRIX,f=s.getCharset(),d=Object.create(null);for(var u in c){var p=c[u|=0],g=_encodings.StandardEncoding[p[2]],y=_encodings.StandardEncoding[p[3]],v=f.indexOf(g),m=f.indexOf(y);if(!(v<0||m<0)){var _={x:p[0]*h[0]+p[1]*h[2]+h[4],y:p[0]*h[1]+p[1]*h[3]+h[5]},T=i(n,u);if(T)for(var F=0,C=T.length;F<C;F++){var b=T[F],S=a.charCodeToGlyphId,E=o(S,v),I=o(S,m);d[b]={baseFontCharCode:E,accentFontCharCode:I,accentOffset:_}}}}e.seacMap=d}var A=1/(e.fontMatrix||_util.FONT_IDENTITY_MATRIX)[0],w=new OpenTypeFileBuilder("OTTO");return w.addTable("CFF ",s.data),w.addTable("OS/2",st(e,a.charCodeToGlyphId)),w.addTable("cmap",ot(a.charCodeToGlyphId,l)),w.addTable("head","\0\0\0\0\0\0\0\0\0\0_<Ãµ\0\0"+x(A)+"\0\0\0\0Âž\v~'\0\0\0\0Âž\v~'\0\0"+x(e.descent)+"Ã¿"+x(e.ascent)+U(e.italicAngle?2:0)+"\0\0\0\0\0\0\0"),w.addTable("hhea","\0\0\0"+x(e.ascent)+x(e.descent)+"\0\0Ã¿Ã¿\0\0\0\0\0\0"+x(e.capHeight)+x(Math.tan(e.italicAngle)*e.xHeight)+"\0\0\0\0\0\0\0\0\0\0\0\0"+U(l)),w.addTable("hmtx",function(){for(var t=s.charstrings,e=s.cff?s.cff.widths:null,r="\0\0\0\0",n=1,a=l;n<a;n++){var i=0;if(t){var o=t[n-1];i="width"in o?o.width:0}else e&&(i=Math.ceil(e[n]||0));r+=U(i)+U(0)}return r}()),w.addTable("maxp","\0\0P\0"+U(l)),w.addTable("name",ct(t)),w.addTable("post",lt(e)),w.toArray()},get spaceWidth(){for(var t,e=["space","minus","one","i","I"],r=0,n=e.length;r<n;r++){var a=e[r];if(a in this.widths){t=this.widths[a];break}var i=(0,_glyphlist.getGlyphsUnicode)()[a],o=0;if(this.composite&&this.cMap.contains(i)&&(o=this.cMap.lookup(i)),!o&&this.toUnicode&&(o=this.toUnicode.charCodeOf(i)),o<=0&&(o=i),t=this.widths[o])break}return t=t||this.defaultWidth,(0,_util.shadow)(this,"spaceWidth",t)},_charToGlyph:function(t){var e,r,n,a=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=t;this.cMap&&this.cMap.contains(t)&&(i=this.cMap.lookup(t)),r=this.widths[i],r=(0,_util.isNum)(r)?r:this.defaultWidth;var o=this.vmetrics&&this.vmetrics[i],s=this.toUnicode.get(t)||this.fallbackToUnicode.get(t)||t;"number"==typeof s&&(s=String.fromCharCode(s));var l=t in this.toFontChar;if(e=this.toFontChar[t]||t,this.missingFile){var c=this.differences[t]||this.defaultEncoding[t];".notdef"!==c&&""!==c||"Type1"!==this.type||(e=32),e=(0,_unicode.mapSpecialUnicodeValues)(e)}this.isType3Font&&(n=e);var h=null;if(this.seacMap&&this.seacMap[t]){l=!0;var f=this.seacMap[t];e=f.baseFontCharCode,h={fontChar:String.fromCodePoint(f.accentFontCharCode),offset:f.accentOffset}}var d="";"number"==typeof e&&(e<=1114111?d=String.fromCodePoint(e):(0,_util.warn)("charToGlyph - invalid fontCharCode: ".concat(e)));var u=this.glyphCache[t];return u&&u.matchesForCache(d,s,h,r,o,n,a,l)||(u=new Glyph(d,s,h,r,o,n,a,l),this.glyphCache[t]=u),u},charsToGlyphs:function(t){var e,r,n,a=this.charsCache;if(a&&(e=a[t]))return e;a||(a=this.charsCache=Object.create(null)),e=[];var i,o=t,s=0;if(this.cMap)for(var l=Object.create(null);s<t.length;){this.cMap.readCharCode(t,s,l),n=l.charcode;var c=l.length;s+=c;var h=1===c&&32===t.charCodeAt(s-1);r=this._charToGlyph(n,h),e.push(r)}else for(s=0,i=t.length;s<i;++s)n=t.charCodeAt(s),r=this._charToGlyph(n,32===n),e.push(r);return a[o]=e},getCharPositions:function(t){var e=[];if(this.cMap)for(var r=Object.create(null),n=0;n<t.length;){this.cMap.readCharCode(t,n,r);var a=r.length;e.push([n,n+a]),n+=a}else for(var i=0,o=t.length;i<o;++i)e.push([i,i+1]);return e},get glyphCacheValues(){return Object.values(this.glyphCache)},encodeString:function(t){for(var e=[],r=[],n=function(){return e.length%2==1},a=0,i=t.length;a<i;a++){var o=t.codePointAt(a);if(55295<o&&(o<57344||65533<o)&&a++,this.toUnicode){var s=String.fromCodePoint(o),l=this.toUnicode.charCodeOf(s);if(-1!==l){n()&&(e.push(r.join("")),r.length=0);for(var c=(this.cMap?this.cMap.getCharCodeLength(l):1)-1;0<=c;c--)r.push(String.fromCharCode(l>>8*c&255));continue}}n()||(e.push(r.join("")),r.length=0),r.push(String.fromCodePoint(o))}return e.push(r.join("")),e}},t}();exports.Font=Font;var ErrorFont=function(){function t(t){this.error=t,this.loadedName="g_font_error",this.missingFile=!0}return t.prototype={charsToGlyphs:function(){return[]},encodeString:function(t){return[t]},exportData:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];return{error:this.error}}},t}();function type1FontGlyphMapping(t,e,r){var n,a,i,o=Object.create(null),s=!!(t.flags&FontFlags.Symbolic);if(t.baseEncodingName)for(i=(0,_encodings.getEncoding)(t.baseEncodingName),a=0;a<i.length;a++)n=r.indexOf(i[a]),o[a]=0<=n?n:0;else if(s)for(a in e)o[a]=e[a];else for(i=_encodings.StandardEncoding,a=0;a<i.length;a++)n=r.indexOf(i[a]),o[a]=0<=n?n:0;var l,c=t.differences;if(c)for(a in c){var h=c[a];if(-1===(n=r.indexOf(h))){l||(l=(0,_glyphlist.getGlyphsUnicode)());var f=recoverGlyphName(h,l);f!==h&&(n=r.indexOf(f))}o[a]=0<=n?n:0}return o}exports.ErrorFont=ErrorFont;var Type1Font=function(){function p(t,e,r){for(var n,a=t.length,i=e.length,o=a-i,s=r,l=!1;s<o;){for(n=0;n<i&&t[s+n]===e[n];)n++;if(i<=n){for(s+=n;s<a&&(0,_core_utils.isWhiteSpace)(t[s]);)s++;l=!0;break}s++}return{found:l,length:s}}function t(t,e,r){var n=r.length1,a=(r.length2,e.peekBytes(6)),i=128===a[0]&&1===a[1];i&&(e.skip(6),n=a[5]<<24|a[4]<<16|a[3]<<8|a[2]);var o=function(t,e){var r,n,a,i,o=[101,101,120,101,99],s=t.pos;try{n=(r=t.getBytes(e)).length}catch(t){if(t instanceof _core_utils.MissingDataException)throw t}if(n===e&&(a=p(r,o,e-2*o.length)).found&&a.length===e)return{stream:new _stream.Stream(r),length:e};for((0,_util.warn)('Invalid "Length1" property in Type1 font -- trying to recover.'),t.pos=s;0!==(a=p(t.peekBytes(2048),o,0)).length;)if(t.pos+=a.length,a.found){i=t.pos-s;break}return t.pos=s,i?{stream:new _stream.Stream(t.getBytes(i)),length:i}:((0,_util.warn)('Unable to recover "Length1" property in Type1 font -- using as is.'),{stream:new _stream.Stream(t.getBytes(e)),length:e})}(e,n);new _type1_parser.Type1Parser(o.stream,!1,SEAC_ANALYSIS_ENABLED).extractFontHeader(r),i&&((a=e.getBytes(6))[5],a[4],a[3],a[2]);var s,l=(s=e.getBytes(),{stream:new _stream.Stream(s),length:s.length}),c=new _type1_parser.Type1Parser(l.stream,!0,SEAC_ANALYSIS_ENABLED).extractFontProgram(r);for(var h in c.properties)r[h]=c.properties[h];var f=c.charstrings,d=this.getType2Charstrings(f),u=this.getType2Subrs(c.subrs);this.charstrings=f,this.data=this.wrap(t,d,this.charstrings,u,r),this.seacs=this.getSeacs(c.charstrings)}return t.prototype={get numGlyphs(){return this.charstrings.length+1},getCharset:function(){for(var t=[".notdef"],e=this.charstrings,r=0;r<e.length;r++)t.push(e[r].glyphName);return t},getGlyphMapping:function(t){var e=this.charstrings;if(t.composite){for(var r=Object.create(null),n=0,a=e.length;n<a;n++){r[t.cMap.charCodeOf(n)]=n+1}return r}var i,o=[".notdef"];for(i=0;i<e.length;i++)o.push(e[i].glyphName);var s=t.builtInEncoding;if(s){var l=Object.create(null);for(var c in s)0<=(i=o.indexOf(s[c]))&&(l[c]=i)}return type1FontGlyphMapping(t,l,o)},hasGlyphId:function(t){return!(t<0||t>=this.numGlyphs)&&(0===t||0<this.charstrings[t-1].charstring.length)},getSeacs:function(t){var e,r,n=[];for(e=0,r=t.length;e<r;e++){var a=t[e];a.seac&&(n[e+1]=a.seac)}return n},getType2Charstrings:function(t){for(var e=[],r=0,n=t.length;r<n;r++)e.push(t[r].charstring);return e},getType2Subrs:function(t){var e=0,r=t.length;e=r<1133?107:r<33769?1131:32768;var n,a=[];for(n=0;n<e;n++)a.push([11]);for(n=0;n<r;n++)a.push(t[n]);return a},wrap:function(t,e,r,n,a){var i=new _cff_parser.CFF;i.header=new _cff_parser.CFFHeader(1,0,4,4),i.names=[t];var o=new _cff_parser.CFFTopDict;o.setByName("version",391),o.setByName("Notice",392),o.setByName("FullName",393),o.setByName("FamilyName",394),o.setByName("Weight",395),o.setByName("Encoding",null),o.setByName("FontMatrix",a.fontMatrix),o.setByName("FontBBox",a.bbox),o.setByName("charset",null),o.setByName("CharStrings",null),o.setByName("Private",null),i.topDict=o;var s=new _cff_parser.CFFStrings;s.add("Version 0.11"),s.add("See original notice"),s.add(t),s.add(t),s.add("Medium"),i.strings=s,i.globalSubrIndex=new _cff_parser.CFFIndex;var l,c,h=e.length,f=[".notdef"];for(l=0;l<h;l++){var d=r[l].glyphName;-1===_cff_parser.CFFStandardStrings.indexOf(d)&&s.add(d),f.push(d)}i.charset=new _cff_parser.CFFCharset(!1,0,f);var u=new _cff_parser.CFFIndex;for(u.add([139,14]),l=0;l<h;l++)u.add(e[l]);i.charStrings=u;var p=new _cff_parser.CFFPrivateDict;p.setByName("Subrs",null);var g=["BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StemSnapH","StemSnapV","BlueShift","BlueFuzz","BlueScale","LanguageGroup","ExpansionFactor","ForceBold","StdHW","StdVW"];for(l=0,c=g.length;l<c;l++){var y=g[l];if(y in a.privateData){var v=a.privateData[y];if(Array.isArray(v))for(var m=v.length-1;0<m;m--)v[m]-=v[m-1];p.setByName(y,v)}}i.topDict.privateDict=p;var _=new _cff_parser.CFFIndex;for(l=0,c=n.length;l<c;l++)_.add(n[l]);return p.subrsIndex=_,new _cff_parser.CFFCompiler(i).compile()}},t}(),CFFFont=function(){function t(e,r){this.properties=r;var t=new _cff_parser.CFFParser(e,r,SEAC_ANALYSIS_ENABLED);this.cff=t.parse(),this.cff.duplicateFirstGlyph();var n=new _cff_parser.CFFCompiler(this.cff);this.seacs=this.cff.seacs;try{this.data=n.compile()}catch(t){(0,_util.warn)("Failed to compile font "+r.loadedName),this.data=e}}return t.prototype={get numGlyphs(){return this.cff.charStrings.count},getCharset:function(){return this.cff.charset.charset},getGlyphMapping:function(){var t,e,r=this.cff,n=this.properties,a=r.charset.charset;if(n.composite){if(t=Object.create(null),r.isCIDFont)for(e=0;e<a.length;e++){var i=a[e];t[n.cMap.charCodeOf(i)]=e}else for(e=0;e<r.charStrings.count;e++)t[n.cMap.charCodeOf(e)]=e;return t}return t=type1FontGlyphMapping(n,r.encoding?r.encoding.encoding:null,a)},hasGlyphId:function(t){return this.cff.hasGlyphId(t)}},t}();