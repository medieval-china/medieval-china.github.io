"use strict";function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t})(t,r)}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var t,r=_getPrototypeOf(n);if(i){var e=_getPrototypeOf(this).constructor;t=Reflect.construct(r,arguments,e)}else t=r.apply(this,arguments);return _possibleConstructorReturn(this,t)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var e=0;e<r.length;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,r,e){return r&&_defineProperties(t.prototype,r),e&&_defineProperties(t,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var r=_toPrimitive(t,"string");return"symbol"===_typeof(r)?r:String(r)}function _toPrimitive(t,r){if("object"!==_typeof(t)||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0===e)return("string"===r?String:Number)(t);var n=e.call(t,r||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPDFFunction=isPDFFunction,exports.PostScriptEvaluator=exports.PostScriptCompiler=exports.PDFFunctionFactory=void 0;var _primitives=require("./primitives.js"),_util=require("../shared/util.js"),_ps_parser=require("./ps_parser.js"),_image_utils=require("./image_utils.js"),PDFFunctionFactory=function(){function i(t){var r=t.xref,e=t.isEvalSupported,n=void 0===e||e;_classCallCheck(this,i),this.xref=r,this.isEvalSupported=!1!==n}return _createClass(i,[{key:"create",value:function(t){var r=this.getCached(t);if(r)return r;var e=PDFFunction.parse({xref:this.xref,isEvalSupported:this.isEvalSupported,fn:t instanceof _primitives.Ref?this.xref.fetch(t):t});return this._cache(t,e),e}},{key:"createFromArray",value:function(t){var r=this.getCached(t);if(r)return r;var e=PDFFunction.parseArray({xref:this.xref,isEvalSupported:this.isEvalSupported,fnObj:t instanceof _primitives.Ref?this.xref.fetch(t):t});return this._cache(t,e),e}},{key:"getCached",value:function(t){var r;if(t instanceof _primitives.Ref?r=t:t instanceof _primitives.Dict?r=t.objId:(0,_primitives.isStream)(t)&&(r=t.dict&&t.dict.objId),r){var e=this._localFunctionCache.getByRef(r);if(e)return e}return null}},{key:"_cache",value:function(t,r){if(!r)throw new Error('PDFFunctionFactory._cache - expected "parsedFunction" argument.');var e;t instanceof _primitives.Ref?e=t:t instanceof _primitives.Dict?e=t.objId:(0,_primitives.isStream)(t)&&(e=t.dict&&t.dict.objId),e&&this._localFunctionCache.set(null,e,r)}},{key:"_localFunctionCache",get:function(){return(0,_util.shadow)(this,"_localFunctionCache",new _image_utils.LocalFunctionCache)}}]),i}();function toNumberArray(t){if(!Array.isArray(t))return null;for(var r=t.length,e=0;e<r;e++)if("number"!=typeof t[e]){for(var n=new Array(r),i=0;i<r;i++)n[i]=+t[i];return n}return t}exports.PDFFunctionFactory=PDFFunctionFactory;var PDFFunction={getSampleArray:function(t,r,e,n){var i,a,o=1;for(i=0,a=t.length;i<a;i++)o*=t[i];o*=r;var s=new Array(o),u=0,p=0,c=1/(Math.pow(2,e)-1),l=n.getBytes((o*e+7)/8),f=0;for(i=0;i<o;i++){for(;u<e;)p<<=8,p|=l[f++],u+=8;u-=e,s[i]=(p>>u)*c,p&=(1<<u)-1}return s},getIR:function(t){var r=t.xref,e=t.isEvalSupported,n=t.fn,i=n.dict;i||(i=n);var a=[this.constructSampled,null,this.constructInterpolated,this.constructStiched,this.constructPostScript][i.get("FunctionType")];if(!a)throw new _util.FormatError("Unknown type of function");return a.call(this,{xref:r,isEvalSupported:e,fn:n,dict:i})},fromIR:function(t){var r=t.xref,e=t.isEvalSupported,n=t.IR;switch(n[0]){case 0:return this.constructSampledFromIR({xref:r,isEvalSupported:e,IR:n});case 2:return this.constructInterpolatedFromIR({xref:r,isEvalSupported:e,IR:n});case 3:return this.constructStichedFromIR({xref:r,isEvalSupported:e,IR:n});default:return this.constructPostScriptFromIR({xref:r,isEvalSupported:e,IR:n})}},parse:function(t){var r=t.xref,e=t.isEvalSupported,n=t.fn,i=this.getIR({xref:r,isEvalSupported:e,fn:n});return this.fromIR({xref:r,isEvalSupported:e,IR:i})},parseArray:function(t){var r=t.xref,e=t.isEvalSupported,n=t.fnObj;if(!Array.isArray(n))return this.parse({xref:r,isEvalSupported:e,fn:n});for(var o=[],i=0,a=n.length;i<a;i++)o.push(this.parse({xref:r,isEvalSupported:e,fn:r.fetchIfRef(n[i])}));return function(t,r,e,n){for(var i=0,a=o.length;i<a;i++)o[i](t,r,e,n+i)}},constructSampled:function(t){t.xref,t.isEvalSupported;var r=t.fn,e=t.dict;function n(t){for(var r=t.length,e=[],n=0,i=0;i<r;i+=2)e[n]=[t[i],t[i+1]],++n;return e}var i=toNumberArray(e.getArray("Domain")),a=toNumberArray(e.getArray("Range"));if(!i||!a)throw new _util.FormatError("No domain or range");var o=i.length/2,s=a.length/2;i=n(i),a=n(a);var u=toNumberArray(e.getArray("Size")),p=e.get("BitsPerSample"),c=e.get("Order")||1;1!==c&&(0,_util.info)("No support for cubic spline interpolation: "+c);var l=toNumberArray(e.getArray("Encode"));if(l)l=n(l);else{l=[];for(var f=0;f<o;++f)l.push([0,u[f]-1])}var h=toNumberArray(e.getArray("Decode"));return[0,o,i,l,h=h?n(h):a,this.getSampleArray(u,s,p,r),u,s,Math.pow(2,p)-1,a]},constructSampledFromIR:function(t){t.xref,t.isEvalSupported;var A=t.IR;function R(t,r,e,n,i){return n+(i-n)/(e-r)*(t-r)}return function(t,r,e,n){var i,a,o=A[1],s=A[2],u=A[3],p=A[4],c=A[5],l=A[6],f=A[7],h=A[9],v=1<<o,m=new Float64Array(v),y=new Uint32Array(v);for(a=0;a<v;a++)m[a]=1;var b=f,d=1;for(i=0;i<o;++i){var _=s[i][0],g=s[i][1],k=R(Math.min(Math.max(t[r+i],_),g),_,g,u[i][0],u[i][1]),S=l[i],x=(k=Math.min(Math.max(k,0),S-1))<S-1?Math.floor(k):k-1,w=x+1-k,P=k-x,C=x*b,F=C+b;for(a=0;a<v;a++)a&d?(m[a]*=P,y[a]+=F):(m[a]*=w,y[a]+=C);b*=S,d<<=1}for(a=0;a<f;++a){var E=0;for(i=0;i<v;i++)E+=c[y[i]+a]*m[i];E=R(E,0,1,p[a][0],p[a][1]),e[n+a]=Math.min(Math.max(E,h[a][0]),h[a][1])}}},constructInterpolated:function(t){t.xref,t.isEvalSupported,t.fn;for(var r=t.dict,e=toNumberArray(r.getArray("C0"))||[0],n=toNumberArray(r.getArray("C1"))||[1],i=r.get("N"),a=e.length,o=[],s=0;s<a;++s)o.push(n[s]-e[s]);return[2,e,o,i]},constructInterpolatedFromIR:function(t){t.xref,t.isEvalSupported;var r=t.IR,o=r[1],s=r[2],u=r[3],p=s.length;return function(t,r,e,n){for(var i=1===u?t[r]:Math.pow(t[r],u),a=0;a<p;++a)e[n+a]=o[a]+i*s[a]}},constructStiched:function(t){var r=t.xref,e=t.isEvalSupported,n=(t.fn,t.dict),i=toNumberArray(n.getArray("Domain"));if(!i)throw new _util.FormatError("No domain");if(1!=i.length/2)throw new _util.FormatError("Bad domain for stiched function");for(var a=n.get("Functions"),o=[],s=0,u=a.length;s<u;++s)o.push(this.parse({xref:r,isEvalSupported:e,fn:r.fetchIfRef(a[s])}));return[3,i,toNumberArray(n.getArray("Bounds")),toNumberArray(n.getArray("Encode")),o]},constructStichedFromIR:function(t){t.xref,t.isEvalSupported;var r=t.IR,v=r[1],m=r[2],y=r[3],b=r[4],d=new Float32Array(1);return function(t,r,e,n){for(var i,a,o,s=(i=t[r],a=v[0],(o=v[1])<i?i=o:i<a&&(i=a),i),u=0,p=m.length;u<p&&!(s<m[u]);++u);var c=v[0];0<u&&(c=m[u-1]);var l=v[1];u<m.length&&(l=m[u]);var f=y[2*u],h=y[2*u+1];d[0]=c===l?f:f+(s-c)*(h-f)/(l-c),b[u](d,0,e,n)}},constructPostScript:function(t){t.xref,t.isEvalSupported;var r=t.fn,e=t.dict,n=toNumberArray(e.getArray("Domain")),i=toNumberArray(e.getArray("Range"));if(!n)throw new _util.FormatError("No domain.");if(!i)throw new _util.FormatError("No range.");var a=new _ps_parser.PostScriptLexer(r);return[4,n,i,new _ps_parser.PostScriptParser(a).parse()]},constructPostScriptFromIR:function(t){t.xref;var r=t.isEvalSupported,e=t.IR,n=e[1],h=e[2],i=e[3];if(r&&_util.IsEvalSupportedCached.value){var a=(new PostScriptCompiler).compile(i,n,h);if(a)return new Function("src","srcOffset","dest","destOffset",a)}(0,_util.info)("Unable to compile PS function");var v=h.length>>1,m=n.length>>1,y=new PostScriptEvaluator(i),b=Object.create(null),d=8192,_=new Float32Array(m);return function(t,r,e,n){var i,a,o="",s=_;for(i=0;i<m;i++)a=t[r+i],o+=(s[i]=a)+"_";var u=b[o];if(void 0===u){var p=new Float32Array(v),c=y.execute(s),l=c.length-v;for(i=0;i<v;i++){a=c[l+i];var f=h[2*i];a<f?a=f:(f=h[2*i+1])<a&&(a=f),p[i]=a}0<d&&(d--,b[o]=p),e.set(p,n)}else e.set(u,n)}}};function isPDFFunction(t){var r;if("object"!==_typeof(t))return!1;if((0,_primitives.isDict)(t))r=t;else{if(!(0,_primitives.isStream)(t))return!1;r=t.dict}return r.has("FunctionType")}var PostScriptStack=function(){function r(t){_classCallCheck(this,r),this.stack=t?Array.prototype.slice.call(t,0):[]}return _createClass(r,[{key:"push",value:function(t){if(100<=this.stack.length)throw new Error("PostScript function stack overflow.");this.stack.push(t)}},{key:"pop",value:function(){if(this.stack.length<=0)throw new Error("PostScript function stack underflow.");return this.stack.pop()}},{key:"copy",value:function(t){if(100<=this.stack.length+t)throw new Error("PostScript function stack overflow.");for(var r=this.stack,e=r.length-t,n=t-1;0<=n;n--,e++)r.push(r[e])}},{key:"index",value:function(t){this.push(this.stack[this.stack.length-t-1])}},{key:"roll",value:function(t,r){var e,n,i,a=this.stack,o=a.length-t,s=a.length-1,u=o+(r-Math.floor(r/t)*t);for(e=o,n=s;e<n;e++,n--)i=a[e],a[e]=a[n],a[n]=i;for(e=o,n=u-1;e<n;e++,n--)i=a[e],a[e]=a[n],a[n]=i;for(e=u,n=s;e<n;e++,n--)i=a[e],a[e]=a[n],a[n]=i}}]),r}(),PostScriptEvaluator=function(){function r(t){_classCallCheck(this,r),this.operators=t}return _createClass(r,[{key:"execute",value:function(t){for(var r,e,n,i=new PostScriptStack(t),a=0,o=this.operators,s=o.length;a<s;)if("number"!=typeof(r=o[a++]))switch(r){case"jz":n=i.pop(),(e=i.pop())||(a=n);break;case"j":a=e=i.pop();break;case"abs":e=i.pop(),i.push(Math.abs(e));break;case"add":n=i.pop(),e=i.pop(),i.push(e+n);break;case"and":n=i.pop(),e=i.pop(),(0,_util.isBool)(e)&&(0,_util.isBool)(n)?i.push(e&&n):i.push(e&n);break;case"atan":e=i.pop(),i.push(Math.atan(e));break;case"bitshift":n=i.pop(),0<(e=i.pop())?i.push(e<<n):i.push(e>>n);break;case"ceiling":e=i.pop(),i.push(Math.ceil(e));break;case"copy":e=i.pop(),i.copy(e);break;case"cos":e=i.pop(),i.push(Math.cos(e));break;case"cvi":e=0|i.pop(),i.push(e);break;case"cvr":break;case"div":n=i.pop(),e=i.pop(),i.push(e/n);break;case"dup":i.copy(1);break;case"eq":n=i.pop(),e=i.pop(),i.push(e===n);break;case"exch":i.roll(2,1);break;case"exp":n=i.pop(),e=i.pop(),i.push(Math.pow(e,n));break;case"false":i.push(!1);break;case"floor":e=i.pop(),i.push(Math.floor(e));break;case"ge":n=i.pop(),e=i.pop(),i.push(n<=e);break;case"gt":n=i.pop(),e=i.pop(),i.push(n<e);break;case"idiv":n=i.pop(),e=i.pop(),i.push(e/n|0);break;case"index":e=i.pop(),i.index(e);break;case"le":n=i.pop(),e=i.pop(),i.push(e<=n);break;case"ln":e=i.pop(),i.push(Math.log(e));break;case"log":e=i.pop(),i.push(Math.log(e)/Math.LN10);break;case"lt":n=i.pop(),e=i.pop(),i.push(e<n);break;case"mod":n=i.pop(),e=i.pop(),i.push(e%n);break;case"mul":n=i.pop(),e=i.pop(),i.push(e*n);break;case"ne":n=i.pop(),e=i.pop(),i.push(e!==n);break;case"neg":e=i.pop(),i.push(-e);break;case"not":e=i.pop(),(0,_util.isBool)(e)?i.push(!e):i.push(~e);break;case"or":n=i.pop(),e=i.pop(),(0,_util.isBool)(e)&&(0,_util.isBool)(n)?i.push(e||n):i.push(e|n);break;case"pop":i.pop();break;case"roll":n=i.pop(),e=i.pop(),i.roll(e,n);break;case"round":e=i.pop(),i.push(Math.round(e));break;case"sin":e=i.pop(),i.push(Math.sin(e));break;case"sqrt":e=i.pop(),i.push(Math.sqrt(e));break;case"sub":n=i.pop(),e=i.pop(),i.push(e-n);break;case"true":i.push(!0);break;case"truncate":e=(e=i.pop())<0?Math.ceil(e):Math.floor(e),i.push(e);break;case"xor":n=i.pop(),e=i.pop(),(0,_util.isBool)(e)&&(0,_util.isBool)(n)?i.push(e!==n):i.push(e^n);break;default:throw new _util.FormatError("Unknown operator ".concat(r))}else i.push(r);return i.stack}}]),r}();exports.PostScriptEvaluator=PostScriptEvaluator;var PostScriptCompiler=function(){var r=function(){function r(t){_classCallCheck(this,r),this.type=t}return _createClass(r,[{key:"visit",value:function(t){(0,_util.unreachable)("abstract method")}}]),r}(),w=function(t){_inherits(a,r);var i=_createSuper(a);function a(t,r,e){var n;return _classCallCheck(this,a),(n=i.call(this,"args")).index=t,n.min=r,n.max=e,n}return _createClass(a,[{key:"visit",value:function(t){t.visitArgument(this)}}]),a}(),P=function(t){_inherits(n,r);var e=_createSuper(n);function n(t){var r;return _classCallCheck(this,n),(r=e.call(this,"literal")).number=t,r.min=t,r.max=t,r}return _createClass(n,[{key:"visit",value:function(t){t.visitLiteral(this)}}]),n}(),C=function(t){_inherits(s,r);var o=_createSuper(s);function s(t,r,e,n,i){var a;return _classCallCheck(this,s),(a=o.call(this,"binary")).op=t,a.arg1=r,a.arg2=e,a.min=n,a.max=i,a}return _createClass(s,[{key:"visit",value:function(t){t.visitBinaryOperation(this)}}]),s}(),F=function(t){_inherits(i,r);var n=_createSuper(i);function i(t,r){var e;return _classCallCheck(this,i),(e=n.call(this,"max")).arg=t,e.min=t.min,e.max=r,e}return _createClass(i,[{key:"visit",value:function(t){t.visitMin(this)}}]),i}(),E=function(t){_inherits(a,r);var i=_createSuper(a);function a(t,r,e){var n;return _classCallCheck(this,a),(n=i.call(this,"var")).index=t,n.min=r,n.max=e,n}return _createClass(a,[{key:"visit",value:function(t){t.visitVariable(this)}}]),a}(),A=function(t){_inherits(i,r);var n=_createSuper(i);function i(t,r){var e;return _classCallCheck(this,i),(e=n.call(this,"definition")).variable=t,e.arg=r,e}return _createClass(i,[{key:"visit",value:function(t){t.visitVariableDefinition(this)}}]),i}(),R=function(){function t(){_classCallCheck(this,t),this.parts=[]}return _createClass(t,[{key:"visitArgument",value:function(t){this.parts.push("Math.max(",t.min,", Math.min(",t.max,", src[srcOffset + ",t.index,"]))")}},{key:"visitVariable",value:function(t){this.parts.push("v",t.index)}},{key:"visitLiteral",value:function(t){this.parts.push(t.number)}},{key:"visitBinaryOperation",value:function(t){this.parts.push("("),t.arg1.visit(this),this.parts.push(" ",t.op," "),t.arg2.visit(this),this.parts.push(")")}},{key:"visitVariableDefinition",value:function(t){this.parts.push("var "),t.variable.visit(this),this.parts.push(" = "),t.arg.visit(this),this.parts.push(";")}},{key:"visitMin",value:function(t){this.parts.push("Math.min("),t.arg.visit(this),this.parts.push(", ",t.max,")")}},{key:"toString",value:function(){return this.parts.join("")}}]),t}();function I(t,r){if("literal"===r.type){if(0===r.number)return new P(0);if(1===r.number)return t;if("literal"===t.type)return new P(t.number*r.number)}if("literal"===t.type){if(0===t.number)return new P(0);if(1===t.number)return r}var e=Math.min(t.min*r.min,t.min*r.max,t.max*r.min,t.max*r.max),n=Math.max(t.min*r.min,t.min*r.max,t.max*r.min,t.max*r.max);return new C("*",t,r,e,n)}function M(t,r){if("literal"===r.type){if(0===r.number)return t;if("literal"===t.type)return new P(t.number-r.number)}return"binary"===r.type&&"-"===r.op&&"literal"===t.type&&1===t.number&&"literal"===r.arg1.type&&1===r.arg1.number?r.arg2:new C("-",t,r,t.min-r.max,t.max-r.min)}return function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"compile",value:function(t,r,o){for(var e,n,i,a,s,u,p,c,l,f,h,v,m=[],y=[],b=r.length>>1,d=o.length>>1,_=0,g=0;g<b;g++)m.push(new w(g,r[2*g],r[2*g+1]));for(var k=0,S=t.length;k<S;k++)if("number"!=typeof(c=t[k]))switch(c){case"add":if(m.length<2)return null;a=m.pop(),i=m.pop(),m.push((h=i,"literal"===(v=a).type&&0===v.number?h:"literal"===h.type&&0===h.number?v:"literal"===v.type&&"literal"===h.type?new P(h.number+v.number):new C("+",h,v,h.min+v.min,h.max+v.max)));break;case"cvr":if(m.length<1)return null;break;case"mul":if(m.length<2)return null;a=m.pop(),i=m.pop(),m.push(I(i,a));break;case"sub":if(m.length<2)return null;a=m.pop(),i=m.pop(),m.push(M(i,a));break;case"exch":if(m.length<2)return null;s=m.pop(),u=m.pop(),m.push(s,u);break;case"pop":if(m.length<1)return null;m.pop();break;case"index":if(m.length<1)return null;if("literal"!==(i=m.pop()).type)return null;if((e=i.number)<0||!Number.isInteger(e)||m.length<e)return null;if("literal"===(s=m[m.length-e-1]).type||"var"===s.type){m.push(s);break}p=new E(_++,s.min,s.max),m[m.length-e-1]=p,m.push(p),y.push(new A(p,s));break;case"dup":if(m.length<1)return null;if("number"==typeof t[k+1]&&"gt"===t[k+2]&&t[k+3]===k+7&&"jz"===t[k+4]&&"pop"===t[k+5]&&t[k+6]===t[k+1]){i=m.pop(),m.push((l=i,f=t[k+1],l.min>=f?new P(f):l.max<=f?l:new F(l,f))),k+=6;break}if("literal"===(s=m[m.length-1]).type||"var"===s.type){m.push(s);break}p=new E(_++,s.min,s.max),m[m.length-1]=p,m.push(p),y.push(new A(p,s));break;case"roll":if(m.length<2)return null;if(a=m.pop(),i=m.pop(),"literal"!==a.type||"literal"!==i.type)return null;if(n=a.number,(e=i.number)<=0||!Number.isInteger(e)||!Number.isInteger(n)||m.length<e)return null;if(0===(n=(n%e+e)%e))break;Array.prototype.push.apply(m,m.splice(m.length-e,e-n));break;default:return null}else m.push(new P(c));if(m.length!==d)return null;var x=[];return y.forEach(function(t){var r=new R;t.visit(r),x.push(r.toString())}),m.forEach(function(t,r){var e=new R;t.visit(e);var n=o[2*r],i=o[2*r+1],a=[e.toString()];n>t.min&&(a.unshift("Math.max(",n,", "),a.push(")")),i<t.max&&(a.unshift("Math.min(",i,", "),a.push(")")),a.unshift("dest[destOffset + ",r,"] = "),a.push(";"),x.push(a.join(""))}),x.join("\n")}}]),t}()}();exports.PostScriptCompiler=PostScriptCompiler;