"use strict";function _slicedToArray(t,r){return _arrayWithHoles(t)||_iterableToArrayLimit(t,r)||_unsupportedIterableToArray(t,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,a=new Array(r);e<r;e++)a[e]=t[e];return a}function _iterableToArrayLimit(t,r){var e=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=e){var a,n,o,i,s=[],h=!0,c=!1;try{if(o=(e=e.call(t)).next,0===r){if(Object(e)!==e)return;h=!1}else for(;!(h=(a=o.call(e)).done)&&(s.push(a.value),s.length!==r);h=!0);}catch(t){c=!0,n=t}finally{try{if(!h&&null!=e.return&&(i=e.return(),Object(i)!==i))return}finally{if(c)throw n}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getTilingPatternIR=getTilingPatternIR,exports.Pattern=void 0;var _util=require("../shared/util.js"),_colorspace=require("./colorspace.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),ShadingType={FUNCTION_BASED:1,AXIAL:2,RADIAL:3,FREE_FORM_MESH:4,LATTICE_FORM_MESH:5,COONS_PATCH_MESH:6,TENSOR_PATCH_MESH:7},Pattern=function(){function t(){(0,_util.unreachable)("should not call Pattern constructor")}return t.prototype={getPattern:function(t){(0,_util.unreachable)("Should not call Pattern.getStyle: ".concat(t))}},t.parseShading=function(t,r,e,a,n,o,i){var s=(0,_primitives.isStream)(t)?t.dict:t,h=s.get("ShadingType");try{switch(h){case ShadingType.AXIAL:case ShadingType.RADIAL:return new Shadings.RadialAxial(s,r,e,a,o,i);case ShadingType.FREE_FORM_MESH:case ShadingType.LATTICE_FORM_MESH:case ShadingType.COONS_PATCH_MESH:case ShadingType.TENSOR_PATCH_MESH:return new Shadings.Mesh(t,r,e,a,o,i);default:throw new _util.FormatError("Unsupported ShadingType: "+h)}}catch(t){if(t instanceof _core_utils.MissingDataException)throw t;return n.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.shadingPattern}),(0,_util.warn)(t),new Shadings.Dummy}},t}();exports.Pattern=Pattern;var Shadings={};function getTilingPatternIR(t,r,e){var a=r.getArray("Matrix"),n=_util.Util.normalizeRect(r.getArray("BBox")),o=r.get("XStep"),i=r.get("YStep"),s=r.get("PaintType"),h=r.get("TilingType");if(n[2]-n[0]==0||n[3]-n[1]==0)throw new _util.FormatError("Invalid getTilingPatternIR /BBox array: [".concat(n,"]."));return["TilingPattern",e,t,a,n,o,i,s,h]}Shadings.SMALL_NUMBER=1e-6,Shadings.RadialAxial=function(){function t(t,r,e,a,n,o){this.matrix=r,this.coordsArr=t.getArray("Coords"),this.shadingType=t.get("ShadingType"),this.type="Pattern";var i=_colorspace.ColorSpace.parse({cs:t.getRaw("ColorSpace")||t.getRaw("CS"),xref:e,resources:a,pdfFunctionFactory:n,localColorSpaceCache:o});this.cs=i;var s=t.getArray("BBox");Array.isArray(s)&&4===s.length?this.bbox=_util.Util.normalizeRect(s):this.bbox=null;var h=0,c=1;if(t.has("Domain")){var u=t.getArray("Domain");h=u[0],c=u[1]}var l=!1,g=!1;if(t.has("Extend")){var d=t.getArray("Extend");l=d[0],g=d[1]}if(!(this.shadingType!==ShadingType.RADIAL||l&&g)){var p=_slicedToArray(this.coordsArr,6),f=p[0],y=p[1],m=p[2],v=p[3],A=p[4],S=p[5],_=Math.hypot(f-v,y-A);m<=S+_&&S<=m+_&&(0,_util.warn)("Unsupported radial gradient.")}this.extendStart=l,this.extendEnd=g;var b=t.getRaw("Function"),w=n.createFromArray(b),T=(c-h)/10,C=this.colorStops=[];if(c<=h||T<=0)(0,_util.info)("Bad shading domain.");else{for(var R,x=new Float32Array(i.numComps),F=new Float32Array(1),E=0;E<=10;E++){F[0]=h+E*T,w(F,0,x,0),R=i.getRgb(x,0);var I=_util.Util.makeHexColor(R[0],R[1],R[2]);C.push([E/10,I])}var M="transparent";t.has("Background")&&(R=i.getRgb(t.get("Background"),0),M=_util.Util.makeHexColor(R[0],R[1],R[2])),l||(C.unshift([0,M]),C[1][0]+=Shadings.SMALL_NUMBER),g||(C[C.length-1][0]-=Shadings.SMALL_NUMBER,C.push([1,M])),this.colorStops=C}}return t.prototype={getIR:function(){var t,r,e,a,n,o=this.coordsArr,i=this.shadingType;i===ShadingType.AXIAL?(r=[o[0],o[1]],e=[o[2],o[3]],n=a=null,t="axial"):i===ShadingType.RADIAL?(r=[o[0],o[1]],e=[o[3],o[4]],a=o[2],n=o[5],t="radial"):(0,_util.unreachable)("getPattern type unknown: ".concat(i));var s=this.matrix;if(s&&(r=_util.Util.applyTransform(r,s),e=_util.Util.applyTransform(e,s),i===ShadingType.RADIAL)){var h=_util.Util.singularValueDecompose2dScale(s);a*=h[0],n*=h[1]}return["RadialAxial",t,this.bbox,this.colorStops,r,e,a,n]}},t}(),Shadings.Mesh=function(){function y(t,r){this.stream=t,this.context=r,this.buffer=0,this.bufferLength=0;var e=r.numComps;this.tmpCompsBuf=new Float32Array(e);var a=r.colorSpace.numComps;this.tmpCsCompsBuf=r.colorFn?new Float32Array(a):this.tmpCompsBuf}y.prototype={get hasData(){if(this.stream.end)return this.stream.pos<this.stream.end;if(0<this.bufferLength)return!0;var t=this.stream.getByte();return!(t<0)&&(this.buffer=t,this.bufferLength=8,!0)},readBits:function(t){var r=this.buffer,e=this.bufferLength;if(32===t){if(0===e)return(this.stream.getByte()<<24|this.stream.getByte()<<16|this.stream.getByte()<<8|this.stream.getByte())>>>0;r=r<<24|this.stream.getByte()<<16|this.stream.getByte()<<8|this.stream.getByte();var a=this.stream.getByte();return this.buffer=a&(1<<e)-1,(r<<8-e|(255&a)>>e)>>>0}if(8===t&&0===e)return this.stream.getByte();for(;e<t;)r=r<<8|this.stream.getByte(),e+=8;return e-=t,this.bufferLength=e,this.buffer=r&(1<<e)-1,r>>e},align:function(){this.buffer=0,this.bufferLength=0},readFlag:function(){return this.readBits(this.context.bitsPerFlag)},readCoordinate:function(){var t=this.context.bitsPerCoordinate,r=this.readBits(t),e=this.readBits(t),a=this.context.decode,n=t<32?1/((1<<t)-1):2.3283064365386963e-10;return[r*n*(a[1]-a[0])+a[0],e*n*(a[3]-a[2])+a[2]]},readComponents:function(){for(var t=this.context.numComps,r=this.context.bitsPerComponent,e=r<32?1/((1<<r)-1):2.3283064365386963e-10,a=this.context.decode,n=this.tmpCompsBuf,o=0,i=4;o<t;o++,i+=2){var s=this.readBits(r);n[o]=s*e*(a[i+1]-a[i])+a[i]}var h=this.tmpCsCompsBuf;return this.context.colorFn&&this.context.colorFn(n,0,h,0),this.context.colorSpace.getRgb(h,0)}};var r,L=3,U=20,k=20,H=(r=[],function(t){return r[t]||(r[t]=function(t){for(var r=[],e=0;e<=t;e++){var a=e/t,n=1-a;r.push(new Float32Array([n*n*n,3*a*n*n,3*a*a*n,a*a*a]))}return r}(t)),r[t]});function m(t,r){var e=t.figures[r];(0,_util.assert)("patch"===e.type,"Unexpected patch mesh figure");var a=t.coords,n=t.colors,o=e.coords,i=e.colors,s=Math.min(a[o[0]][0],a[o[3]][0],a[o[12]][0],a[o[15]][0]),h=Math.min(a[o[0]][1],a[o[3]][1],a[o[12]][1],a[o[15]][1]),c=Math.max(a[o[0]][0],a[o[3]][0],a[o[12]][0],a[o[15]][0]),u=Math.max(a[o[0]][1],a[o[3]][1],a[o[12]][1],a[o[15]][1]),l=Math.ceil((c-s)*k/(t.bounds[2]-t.bounds[0]));l=Math.max(L,Math.min(U,l));var g=Math.ceil((u-h)*k/(t.bounds[3]-t.bounds[1]));g=Math.max(L,Math.min(U,g));for(var d=l+1,p=new Int32Array((g+1)*d),f=new Int32Array((g+1)*d),y=0,m=new Uint8Array(3),v=new Uint8Array(3),A=n[i[0]],S=n[i[1]],_=n[i[2]],b=n[i[3]],w=H(g),T=H(l),C=0;C<=g;C++){m[0]=(A[0]*(g-C)+_[0]*C)/g|0,m[1]=(A[1]*(g-C)+_[1]*C)/g|0,m[2]=(A[2]*(g-C)+_[2]*C)/g|0,v[0]=(S[0]*(g-C)+b[0]*C)/g|0,v[1]=(S[1]*(g-C)+b[1]*C)/g|0,v[2]=(S[2]*(g-C)+b[2]*C)/g|0;for(var R=0;R<=l;R++,y++)if(0!==C&&C!==g||0!==R&&R!==l){for(var x=0,F=0,E=0,I=0;I<=3;I++)for(var M=0;M<=3;M++,E++){var B=w[C][I]*T[R][M];x+=a[o[E]][0]*B,F+=a[o[E]][1]*B}p[y]=a.length,a.push([x,F]),f[y]=n.length;var P=new Uint8Array(3);P[0]=(m[0]*(l-R)+v[0]*R)/l|0,P[1]=(m[1]*(l-R)+v[1]*R)/l|0,P[2]=(m[2]*(l-R)+v[2]*R)/l|0,n.push(P)}}p[0]=o[0],f[0]=i[0],p[l]=o[3],f[l]=i[1],p[d*g]=o[12],f[d*g]=i[2],p[d*g+l]=o[15],f[d*g+l]=i[3],t.figures[r]={type:"lattice",coords:p,colors:f,verticesPerRow:d}}function v(t){for(var r=t.coords[0][0],e=t.coords[0][1],a=r,n=e,o=1,i=t.coords.length;o<i;o++){var s=t.coords[o][0],h=t.coords[o][1];r=s<r?s:r,e=h<e?h:e,a=a<s?s:a,n=n<h?h:n}t.bounds=[r,e,a,n]}function t(t,r,e,a,n,o){if(!(0,_primitives.isStream)(t))throw new _util.FormatError("Mesh data is not a stream");var i=t.dict;this.matrix=r,this.shadingType=i.get("ShadingType"),this.type="Pattern";var s=i.getArray("BBox");Array.isArray(s)&&4===s.length?this.bbox=_util.Util.normalizeRect(s):this.bbox=null;var h=_colorspace.ColorSpace.parse({cs:i.getRaw("ColorSpace")||i.getRaw("CS"),xref:e,resources:a,pdfFunctionFactory:n,localColorSpaceCache:o});this.cs=h,this.background=i.has("Background")?h.getRgb(i.get("Background"),0):null;var c=i.getRaw("Function"),u=c?n.createFromArray(c):null;this.coords=[],this.colors=[],this.figures=[];var l=new y(t,{bitsPerCoordinate:i.get("BitsPerCoordinate"),bitsPerComponent:i.get("BitsPerComponent"),bitsPerFlag:i.get("BitsPerFlag"),decode:i.getArray("Decode"),colorFn:u,colorSpace:h,numComps:u?1:h.numComps}),g=!1;switch(this.shadingType){case ShadingType.FREE_FORM_MESH:!function(t,r){for(var e=t.coords,a=t.colors,n=[],o=[],i=0;r.hasData;){var s=r.readFlag(),h=r.readCoordinate(),c=r.readComponents();if(0===i){if(!(0<=s&&s<=2))throw new _util.FormatError("Unknown type4 flag");switch(s){case 0:i=3;break;case 1:o.push(o[o.length-2],o[o.length-1]),i=1;break;case 2:o.push(o[o.length-3],o[o.length-1]),i=1}n.push(s)}o.push(e.length),e.push(h),a.push(c),i--,r.align()}t.figures.push({type:"triangles",coords:new Int32Array(o),colors:new Int32Array(o)})}(this,l);break;case ShadingType.LATTICE_FORM_MESH:var d=0|i.get("VerticesPerRow");if(d<2)throw new _util.FormatError("Invalid VerticesPerRow");!function(t,r,e){for(var a=t.coords,n=t.colors,o=[];r.hasData;){var i=r.readCoordinate(),s=r.readComponents();o.push(a.length),a.push(i),n.push(s)}t.figures.push({type:"lattice",coords:new Int32Array(o),colors:new Int32Array(o),verticesPerRow:e})}(this,l,d);break;case ShadingType.COONS_PATCH_MESH:!function(t,r){for(var e=t.coords,a=t.colors,n=new Int32Array(16),o=new Int32Array(4);r.hasData;){var i=r.readFlag();if(!(0<=i&&i<=3))throw new _util.FormatError("Unknown type6 flag");for(var s=e.length,h=0,c=0!==i?8:12;h<c;h++)e.push(r.readCoordinate());for(var u=a.length,l=0,g=0!==i?2:4;l<g;l++)a.push(r.readComponents());var d=void 0,p=void 0,f=void 0,y=void 0;switch(i){case 0:n[12]=s+3,n[13]=s+4,n[14]=s+5,n[15]=s+6,n[8]=s+2,n[11]=s+7,n[4]=s+1,n[7]=s+8,n[0]=s,n[1]=s+11,n[2]=s+10,n[3]=s+9,o[2]=u+1,o[3]=u+2,o[0]=u,o[1]=u+3;break;case 1:d=n[12],p=n[13],f=n[14],y=n[15],n[12]=y,n[13]=s+0,n[14]=s+1,n[15]=s+2,n[8]=f,n[11]=s+3,n[4]=p,n[7]=s+4,n[0]=d,n[1]=s+7,n[2]=s+6,n[3]=s+5,d=o[2],p=o[3],o[2]=p,o[3]=u,o[0]=d,o[1]=u+1;break;case 2:d=n[15],p=n[11],n[12]=n[3],n[13]=s+0,n[14]=s+1,n[15]=s+2,n[8]=n[7],n[11]=s+3,n[4]=p,n[7]=s+4,n[0]=d,n[1]=s+7,n[2]=s+6,n[3]=s+5,d=o[3],o[2]=o[1],o[3]=u,o[0]=d,o[1]=u+1;break;case 3:n[12]=n[0],n[13]=s+0,n[14]=s+1,n[15]=s+2,n[8]=n[1],n[11]=s+3,n[4]=n[2],n[7]=s+4,n[0]=n[3],n[1]=s+7,n[2]=s+6,n[3]=s+5,o[2]=o[0],o[3]=u,o[0]=o[1],o[1]=u+1}n[5]=e.length,e.push([(-4*e[n[0]][0]-e[n[15]][0]+6*(e[n[4]][0]+e[n[1]][0])-2*(e[n[12]][0]+e[n[3]][0])+3*(e[n[13]][0]+e[n[7]][0]))/9,(-4*e[n[0]][1]-e[n[15]][1]+6*(e[n[4]][1]+e[n[1]][1])-2*(e[n[12]][1]+e[n[3]][1])+3*(e[n[13]][1]+e[n[7]][1]))/9]),n[6]=e.length,e.push([(-4*e[n[3]][0]-e[n[12]][0]+6*(e[n[2]][0]+e[n[7]][0])-2*(e[n[0]][0]+e[n[15]][0])+3*(e[n[4]][0]+e[n[14]][0]))/9,(-4*e[n[3]][1]-e[n[12]][1]+6*(e[n[2]][1]+e[n[7]][1])-2*(e[n[0]][1]+e[n[15]][1])+3*(e[n[4]][1]+e[n[14]][1]))/9]),n[9]=e.length,e.push([(-4*e[n[12]][0]-e[n[3]][0]+6*(e[n[8]][0]+e[n[13]][0])-2*(e[n[0]][0]+e[n[15]][0])+3*(e[n[11]][0]+e[n[1]][0]))/9,(-4*e[n[12]][1]-e[n[3]][1]+6*(e[n[8]][1]+e[n[13]][1])-2*(e[n[0]][1]+e[n[15]][1])+3*(e[n[11]][1]+e[n[1]][1]))/9]),n[10]=e.length,e.push([(-4*e[n[15]][0]-e[n[0]][0]+6*(e[n[11]][0]+e[n[14]][0])-2*(e[n[12]][0]+e[n[3]][0])+3*(e[n[2]][0]+e[n[8]][0]))/9,(-4*e[n[15]][1]-e[n[0]][1]+6*(e[n[11]][1]+e[n[14]][1])-2*(e[n[12]][1]+e[n[3]][1])+3*(e[n[2]][1]+e[n[8]][1]))/9]),t.figures.push({type:"patch",coords:new Int32Array(n),colors:new Int32Array(o)})}}(this,l),g=!0;break;case ShadingType.TENSOR_PATCH_MESH:!function(t,r){for(var e=t.coords,a=t.colors,n=new Int32Array(16),o=new Int32Array(4);r.hasData;){var i=r.readFlag();if(!(0<=i&&i<=3))throw new _util.FormatError("Unknown type7 flag");for(var s=e.length,h=0,c=0!==i?12:16;h<c;h++)e.push(r.readCoordinate());for(var u=a.length,l=0,g=0!==i?2:4;l<g;l++)a.push(r.readComponents());var d=void 0,p=void 0,f=void 0,y=void 0;switch(i){case 0:n[12]=s+3,n[13]=s+4,n[14]=s+5,n[15]=s+6,n[8]=s+2,n[9]=s+13,n[10]=s+14,n[11]=s+7,n[4]=s+1,n[5]=s+12,n[6]=s+15,n[7]=s+8,n[0]=s,n[1]=s+11,n[2]=s+10,n[3]=s+9,o[2]=u+1,o[3]=u+2,o[0]=u,o[1]=u+3;break;case 1:d=n[12],p=n[13],f=n[14],y=n[15],n[12]=y,n[13]=s+0,n[14]=s+1,n[15]=s+2,n[8]=f,n[9]=s+9,n[10]=s+10,n[11]=s+3,n[4]=p,n[5]=s+8,n[6]=s+11,n[7]=s+4,n[0]=d,n[1]=s+7,n[2]=s+6,n[3]=s+5,d=o[2],p=o[3],o[2]=p,o[3]=u,o[0]=d,o[1]=u+1;break;case 2:d=n[15],p=n[11],n[12]=n[3],n[13]=s+0,n[14]=s+1,n[15]=s+2,n[8]=n[7],n[9]=s+9,n[10]=s+10,n[11]=s+3,n[4]=p,n[5]=s+8,n[6]=s+11,n[7]=s+4,n[0]=d,n[1]=s+7,n[2]=s+6,n[3]=s+5,d=o[3],o[2]=o[1],o[3]=u,o[0]=d,o[1]=u+1;break;case 3:n[12]=n[0],n[13]=s+0,n[14]=s+1,n[15]=s+2,n[8]=n[1],n[9]=s+9,n[10]=s+10,n[11]=s+3,n[4]=n[2],n[5]=s+8,n[6]=s+11,n[7]=s+4,n[0]=n[3],n[1]=s+7,n[2]=s+6,n[3]=s+5,o[2]=o[0],o[3]=u,o[0]=o[1],o[1]=u+1}t.figures.push({type:"patch",coords:new Int32Array(n),colors:new Int32Array(o)})}}(this,l),g=!0;break;default:(0,_util.unreachable)("Unsupported mesh type.")}if(g){v(this);for(var p=0,f=this.figures.length;p<f;p++)m(this,p)}v(this),function(t){var r,e,a,n,o=t.coords,i=new Float32Array(2*o.length);for(a=r=0,e=o.length;r<e;r++){var s=o[r];i[a++]=s[0],i[a++]=s[1]}t.coords=i;var h=t.colors,c=new Uint8Array(3*h.length);for(a=r=0,e=h.length;r<e;r++){var u=h[r];c[a++]=u[0],c[a++]=u[1],c[a++]=u[2]}t.colors=c;var l=t.figures;for(r=0,e=l.length;r<e;r++){var g=l[r],d=g.coords,p=g.colors;for(a=0,n=d.length;a<n;a++)d[a]*=2,p[a]*=3}}(this)}return t.prototype={getIR:function(){return["Mesh",this.shadingType,this.coords,this.colors,this.figures,this.bounds,this.matrix,this.bbox,this.background]}},t}(),Shadings.Dummy=function(){function t(){this.type="Pattern"}return t.prototype={getIR:function(){return["Dummy"]}},t}();