"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0===a)return("string"===e?String:Number)(t);var i=a.call(t,e||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=a){var i,r,n,s,h=[],o=!0,l=!1;try{if(n=(a=a.call(t)).next,0===e){if(Object(a)!==a)return;o=!1}else for(;!(o=(i=n.call(a)).done)&&(h.push(i.value),h.length!==e);o=!0);}catch(t){l=!0,r=t}finally{try{if(!o&&null!=a.return&&(s=a.return(),Object(s)!==s))return}finally{if(l)throw r}}return h}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){a&&(t=a);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,s=!0,h=!1;return{s:function(){a=a.call(t)},n:function(){var t=a.next();return s=t.done,t},e:function(t){h=!0,n=t},f:function(){try{s||null==a.return||a.return()}finally{if(h)throw n}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,i=new Array(e);a<e;a++)i[a]=t[a];return i}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFFindController=exports.FindState=void 0;var _pdf=require("../pdf"),_pdf_find_utils=require("./pdf_find_utils.js"),_ui_utils=require("./ui_utils.js"),FindState={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3};exports.FindState=FindState;var FIND_TIMEOUT=250,MATCH_SCROLL_OFFSET_TOP=-50,MATCH_SCROLL_OFFSET_LEFT=-400,CHARACTERS_TO_NORMALIZE={"‘":"'","’":"'","‚":"'","‛":"'","“":'"',"”":'"',"„":'"',"‟":'"',"¼":"1/4","½":"1/2","¾":"3/4"},normalizationRegex=null;function normalize(t){if(!normalizationRegex){var e=Object.keys(CHARACTERS_TO_NORMALIZE).join("");normalizationRegex=new RegExp("[".concat(e,"]"),"g")}var r=null;return[t.replace(normalizationRegex,function(t,e){var a=CHARACTERS_TO_NORMALIZE[t],i=a.length-t.length;return 0!==i&&(r||(r=[])).push([e,i]),a}),r]}function getOriginalIndex(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(!e)return t;var a,i=0,r=_createForOfIteratorHelper(e);try{for(r.s();!(a=r.n()).done;){var n=_slicedToArray(a.value,2),s=n[0],h=n[1],o=s+i;if(t<=o)break;if(t<o+h){i+=t-o;break}i+=h}}catch(t){r.e(t)}finally{r.f()}return t-i}var PDFFindController=function(){function i(t){var e=t.linkService,a=t.eventBus;_classCallCheck(this,i),this._linkService=e,this._eventBus=a,this._reset(),a._on("findbarclose",this._onFindBarClose.bind(this))}return _createClass(i,[{key:"highlightMatches",get:function(){return this._highlightMatches}},{key:"pageMatches",get:function(){return this._pageMatches}},{key:"pageMatchesLength",get:function(){return this._pageMatchesLength}},{key:"selected",get:function(){return this._selected}},{key:"state",get:function(){return this._state}},{key:"setDocument",value:function(t){this._pdfDocument&&this._reset(),t&&(this._pdfDocument=t,this._firstPageCapability.resolve())}},{key:"executeCommand",value:function(a,t){var i=this;if(t){var r=this._pdfDocument;(null===this._state||this._shouldDirtyMatch(a,t))&&(this._dirtyMatch=!0),this._state=t,"findhighlightallchange"!==a&&this._updateUIState(FindState.PENDING),this._firstPageCapability.promise.then(function(){if(i._pdfDocument&&(!r||i._pdfDocument===r)){i._extractText();var t=!i._highlightMatches,e=!!i._findTimeout;i._findTimeout&&(clearTimeout(i._findTimeout),i._findTimeout=null),"find"===a?i._findTimeout=setTimeout(function(){i._nextMatch(),i._findTimeout=null},FIND_TIMEOUT):i._dirtyMatch?i._nextMatch():"findagain"===a?(i._nextMatch(),t&&i._state.highlightAll&&i._updateAllPages()):"findhighlightallchange"===a?(e?i._nextMatch():i._highlightMatches=!0,i._updateAllPages()):i._nextMatch()}})}}},{key:"scrollMatchIntoView",value:function(t){var e=t.element,a=void 0===e?null:e,i=t.pageIndex,r=void 0===i?-1:i,n=t.matchIndex,s=void 0===n?-1:n;if(this._scrollMatches&&a&&-1!==s&&s===this._selected.matchIdx&&-1!==r&&r===this._selected.pageIdx){this._scrollMatches=!1;var h={top:MATCH_SCROLL_OFFSET_TOP,left:MATCH_SCROLL_OFFSET_LEFT};(0,_ui_utils.scrollIntoView)(a,h,!0)}}},{key:"_reset",value:function(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],this._state=null,this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=Object.create(null),this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=(0,_pdf.createPromiseCapability)()}},{key:"_query",get:function(){if(this._state.query!==this._rawQuery){this._rawQuery=this._state.query;var t=_slicedToArray(normalize(this._state.query),1);this._normalizedQuery=t[0]}return this._normalizedQuery}},{key:"_shouldDirtyMatch",value:function(t,e){if(e.query!==this._state.query)return!0;switch(t){case"findagain":var a=this._selected.pageIdx+1,i=this._linkService;return 1<=a&&a<=i.pagesCount&&a!==i.page&&!i.isPageVisible(a);case"findhighlightallchange":return!1}return!0}},{key:"_prepareMatches",value:function(n,t,e){function a(t){var e=n[t],a=n[t+1];if(t<n.length-1&&e.match===a.match)return e.skipped=!0;for(var i=t-1;0<=i;i--){var r=n[i];if(!r.skipped){if(r.match+r.matchLength<e.match)break;if(r.match+r.matchLength>=e.match+e.matchLength)return e.skipped=!0}}return!1}n.sort(function(t,e){return t.match===e.match?t.matchLength-e.matchLength:t.match-e.match});for(var i=0,r=n.length;i<r;i++)a(i)||(t.push(n[i].match),e.push(n[i].matchLength))}},{key:"_isEntireWord",value:function(t,e,a){if(0<e){var i=t.charCodeAt(e),r=t.charCodeAt(e-1);if((0,_pdf_find_utils.getCharacterType)(i)===(0,_pdf_find_utils.getCharacterType)(r))return!1}var n=e+a-1;if(n<t.length-1){var s=t.charCodeAt(n),h=t.charCodeAt(n+1);if((0,_pdf_find_utils.getCharacterType)(s)===(0,_pdf_find_utils.getCharacterType)(h))return!1}return!0}},{key:"_calculatePhraseMatch",value:function(t,e,a,i,r){for(var n=[],s=[],h=t.length,o=-h;-1!==(o=a.indexOf(t,o+h));)if(!r||this._isEntireWord(a,o,h)){var l=getOriginalIndex(o,i),u=getOriginalIndex(o+h-1,i)-l+1;n.push(l),s.push(u)}this._pageMatches[e]=n,this._pageMatchesLength[e]=s}},{key:"_calculateWordMatch",value:function(t,e,a,i,r){for(var n=[],s=t.match(/\S+/g),h=0,o=s.length;h<o;h++)for(var l=s[h],u=l.length,c=-u;-1!==(c=a.indexOf(l,c+u));)if(!r||this._isEntireWord(a,c,u)){var _=getOriginalIndex(c,i),d=getOriginalIndex(c+u-1,i)-_+1;n.push({match:_,matchLength:d,skipped:!1})}this._pageMatchesLength[e]=[],this._pageMatches[e]=[],this._prepareMatches(n,this._pageMatches[e],this._pageMatchesLength[e])}},{key:"_calculateMatch",value:function(t){var e=this._pageContents[t],a=this._pageDiffs[t],i=this._query,r=this._state,n=r.caseSensitive,s=r.entireWord,h=r.phraseSearch;if(0!==i.length){n||(e=e.toLowerCase(),i=i.toLowerCase()),h?this._calculatePhraseMatch(i,t,e,a,s):this._calculateWordMatch(i,t,e,a,s),this._state.highlightAll&&this._updatePage(t),this._resumePageIdx===t&&(this._resumePageIdx=null,this._nextPageMatch());var o=this._pageMatches[t].length;0<o&&(this._matchesCountTotal+=o,this._updateUIResultsCount())}}},{key:"_extractText",value:function(){var o=this;if(!(0<this._extractTextPromises.length))for(var e=Promise.resolve(),t=function(s,t){var h=(0,_pdf.createPromiseCapability)();o._extractTextPromises[s]=h.promise,e=e.then(function(){return o._pdfDocument.getPage(s+1).then(function(t){return t.getTextContent({normalizeWhitespace:!0})}).then(function(t){for(var e=t.items,a=[],i=0,r=e.length;i<r;i++)a.push(e[i].str);var n=_slicedToArray(normalize(a.join("")),2);o._pageContents[s]=n[0],o._pageDiffs[s]=n[1],h.resolve(s)},function(t){console.error("Unable to get text content for page ".concat(s+1),t),o._pageContents[s]="",o._pageDiffs[s]=null,h.resolve(s)})})},a=0,i=this._linkService.pagesCount;a<i;a++)t(a)}},{key:"_updatePage",value:function(t){this._scrollMatches&&this._selected.pageIdx===t&&(this._linkService.page=t+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:t})}},{key:"_updateAllPages",value:function(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})}},{key:"_nextMatch",value:function(){var e=this,t=this._state.findPrevious,a=this._linkService.page-1,i=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=a,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,this._matchesCountTotal=0,this._updateAllPages();for(var r=0;r<i;r++)!0!==this._pendingFindMatches[r]&&(this._pendingFindMatches[r]=!0,this._extractTextPromises[r].then(function(t){delete e._pendingFindMatches[t],e._calculateMatch(t)}))}if(""!==this._query){if(!this._resumePageIdx){var n=this._offset;if(this._pagesToSearch=i,null!==n.matchIdx){var s=this._pageMatches[n.pageIdx].length;if(!t&&n.matchIdx+1<s||t&&0<n.matchIdx)return n.matchIdx=t?n.matchIdx-1:n.matchIdx+1,void this._updateMatch(!0);this._advanceOffsetPage(t)}this._nextPageMatch()}}else this._updateUIState(FindState.FOUND)}},{key:"_matchesReady",value:function(t){var e=this._offset,a=t.length,i=this._state.findPrevious;return a?(e.matchIdx=i?a-1:0,this._updateMatch(!0),!0):(this._advanceOffsetPage(i),!!(e.wrapped&&(e.matchIdx=null,this._pagesToSearch<0))&&(this._updateMatch(!1),!0))}},{key:"_nextPageMatch",value:function(){null!==this._resumePageIdx&&console.error("There can only be one pending page.");var t=null;do{var e=this._offset.pageIdx;if(!(t=this._pageMatches[e])){this._resumePageIdx=e;break}}while(!this._matchesReady(t))}},{key:"_advanceOffsetPage",value:function(t){var e=this._offset,a=this._linkService.pagesCount;e.pageIdx=t?e.pageIdx-1:e.pageIdx+1,e.matchIdx=null,this._pagesToSearch--,(e.pageIdx>=a||e.pageIdx<0)&&(e.pageIdx=t?a-1:0,e.wrapped=!0)}},{key:"_updateMatch",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],e=FindState.NOT_FOUND,a=this._offset.wrapped;if(this._offset.wrapped=!1,t){var i=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,e=a?FindState.WRAPPED:FindState.FOUND,-1!==i&&i!==this._selected.pageIdx&&this._updatePage(i)}this._updateUIState(e,this._state.findPrevious),-1!==this._selected.pageIdx&&(this._scrollMatches=!0,this._updatePage(this._selected.pageIdx))}},{key:"_onFindBarClose",value:function(t){var e=this,a=this._pdfDocument;this._firstPageCapability.promise.then(function(){!e._pdfDocument||a&&e._pdfDocument!==a||(e._findTimeout&&(clearTimeout(e._findTimeout),e._findTimeout=null),e._resumePageIdx&&(e._resumePageIdx=null,e._dirtyMatch=!0),e._updateUIState(FindState.FOUND),e._highlightMatches=!1,e._updateAllPages())})}},{key:"_requestMatchesCount",value:function(){var t=this._selected,e=t.pageIdx,a=t.matchIdx,i=0,r=this._matchesCountTotal;if(-1!==a){for(var n=0;n<e;n++){var s;i+=(null===(s=this._pageMatches[n])||void 0===s?void 0:s.length)||0}i+=a+1}return(i<1||r<i)&&(i=r=0),{current:i,total:r}}},{key:"_updateUIResultsCount",value:function(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:this._requestMatchesCount()})}},{key:"_updateUIState",value:function(t,e){var a,i;this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:t,previous:e,matchesCount:this._requestMatchesCount(),rawQuery:null!==(a=null===(i=this._state)||void 0===i?void 0:i.query)&&void 0!==a?a:null})}}]),i}();exports.PDFFindController=PDFFindController;