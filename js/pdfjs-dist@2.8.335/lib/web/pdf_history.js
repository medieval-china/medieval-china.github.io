"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function _iterableToArrayLimit(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,r,a,s,o=[],u=!0,h=!1;try{if(a=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;u=!1}else for(;!(u=(n=a.call(i)).done)&&(o.push(n.value),o.length!==e);u=!0);}catch(t){h=!0,r=t}finally{try{if(!u&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(h)throw r}}return o}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var n=i.call(t,e||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.isDestArraysEqual=isDestArraysEqual,exports.isDestHashesEqual=isDestHashesEqual,exports.PDFHistory=void 0;var _ui_utils=require("./ui_utils.js"),HASH_CHANGE_TIMEOUT=1e3,POSITION_UPDATED_THRESHOLD=50,UPDATE_VIEWAREA_TIMEOUT=1e3;function getCurrentHash(){return document.location.hash}var PDFHistory=function(){function r(t){var e=this,i=t.linkService,n=t.eventBus;_classCallCheck(this,r),this.linkService=i,this.eventBus=n,this._initialized=!1,this._fingerprint="",this.reset(),this._boundEvents=null,this._isViewerInPresentationMode=!1,this.eventBus._on("presentationmodechanged",function(t){e._isViewerInPresentationMode=t.state!==_ui_utils.PresentationModeState.NORMAL}),this.eventBus._on("pagesinit",function(){e._isPagesLoaded=!1,e.eventBus._on("pagesloaded",function(t){e._isPagesLoaded=!!t.pagesCount},{once:!0})})}return _createClass(r,[{key:"initialize",value:function(t){var e=t.fingerprint,i=t.resetHistory,n=void 0!==i&&i,r=t.updateUrl,a=void 0!==r&&r;if(e&&"string"==typeof e){this._initialized&&this.reset();var s=""!==this._fingerprint&&this._fingerprint!==e;this._fingerprint=e,this._updateUrl=!0===a,this._initialized=!0,this._bindEvents();var o=window.history.state;if(this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=getCurrentHash(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!this._isValidState(o,!0)||n){var u=this._parseCurrentHash(!0),h=u.hash,l=u.page,p=u.rotation;return!h||s||n?void this._pushOrReplaceState(null,!0):void this._pushOrReplaceState({hash:h,page:l,rotation:p},!0)}var _=o.destination;this._updateInternalState(_,o.uid,!0),void 0!==_.rotation&&(this._initialRotation=_.rotation),_.dest?(this._initialBookmark=JSON.stringify(_.dest),this._destination.page=null):_.hash?this._initialBookmark=_.hash:_.page&&(this._initialBookmark="page=".concat(_.page))}else console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.')}},{key:"reset",value:function(){this._initialized&&(this._pageHide(),this._initialized=!1,this._unbindEvents()),this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._initialBookmark=null,this._initialRotation=null}},{key:"push",value:function(t){var e=this,i=t.namedDest,n=void 0===i?null:i,r=t.explicitDest,a=t.pageNumber;if(this._initialized)if(n&&"string"!=typeof n)console.error("PDFHistory.push: "+'"'.concat(n,'" is not a valid namedDest parameter.'));else if(Array.isArray(r))if(this._isValidPage(a)||null===a&&!this._destination){var s=n||JSON.stringify(r);if(s){var o=!1;if(this._destination&&(isDestHashesEqual(this._destination.hash,s)||isDestArraysEqual(this._destination.dest,r))){if(this._destination.page)return;o=!0}this._popStateInProgress&&!o||(this._pushOrReplaceState({dest:r,hash:s,page:a,rotation:this.linkService.rotation},o),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(function(){e._popStateInProgress=!1})))}}else console.error("PDFHistory.push: "+'"'.concat(a,'" is not a valid pageNumber parameter.'));else console.error("PDFHistory.push: "+'"'.concat(r,'" is not a valid explicitDest parameter.'))}},{key:"pushPage",value:function(t){var e,i=this;this._initialized&&(this._isValidPage(t)?(null===(e=this._destination)||void 0===e?void 0:e.page)!==t&&(this._popStateInProgress||(this._pushOrReplaceState({dest:null,hash:"page=".concat(t),page:t,rotation:this.linkService.rotation}),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(function(){i._popStateInProgress=!1})))):console.error('PDFHistory.pushPage: "'.concat(t,'" is not a valid page number.')))}},{key:"pushCurrentPosition",value:function(){this._initialized&&!this._popStateInProgress&&this._tryPushCurrentPosition()}},{key:"back",value:function(){if(this._initialized&&!this._popStateInProgress){var t=window.history.state;this._isValidState(t)&&0<t.uid&&window.history.back()}}},{key:"forward",value:function(){if(this._initialized&&!this._popStateInProgress){var t=window.history.state;this._isValidState(t)&&t.uid<this._maxUid&&window.history.forward()}}},{key:"popStateInProgress",get:function(){return this._initialized&&(this._popStateInProgress||0<this._blockHashChange)}},{key:"initialBookmark",get:function(){return this._initialized?this._initialBookmark:null}},{key:"initialRotation",get:function(){return this._initialized?this._initialRotation:null}},{key:"_pushOrReplaceState",value:function(t){var e,i=1<arguments.length&&void 0!==arguments[1]&&arguments[1]||!this._destination,n={fingerprint:this._fingerprint,uid:i?this._uid:this._uid+1,destination:t};if(this._updateInternalState(t,n.uid),this._updateUrl&&null!=t&&t.hash){var r=document.location.href.split("#")[0];r.startsWith("file://")||(e="".concat(r,"#").concat(t.hash))}i?window.history.replaceState(n,"",e):window.history.pushState(n,"",e)}},{key:"_tryPushCurrentPosition",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(this._position){var e=this._position;if(t&&((e=Object.assign(Object.create(null),this._position)).temporary=!0),this._destination){if(this._destination.temporary)this._pushOrReplaceState(e,!0);else if(this._destination.hash!==e.hash&&(this._destination.page||!(POSITION_UPDATED_THRESHOLD<=0||this._numPositionUpdates<=POSITION_UPDATED_THRESHOLD))){var i=!1;if(this._destination.page>=e.first&&this._destination.page<=e.page){if(void 0!==this._destination.dest||!this._destination.first)return;i=!0}this._pushOrReplaceState(e,i)}}else this._pushOrReplaceState(e)}}},{key:"_isValidPage",value:function(t){return Number.isInteger(t)&&0<t&&t<=this.linkService.pagesCount}},{key:"_isValidState",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(!t)return!1;if(t.fingerprint!==this._fingerprint){if(!e)return!1;if("string"!=typeof t.fingerprint||t.fingerprint.length!==this._fingerprint.length)return!1;var i=_slicedToArray(performance.getEntriesByType("navigation"),1)[0];if("reload"!==(null==i?void 0:i.type))return!1}return!(!Number.isInteger(t.uid)||t.uid<0)&&(null!==t.destination&&"object"===_typeof(t.destination))}},{key:"_updateInternalState",value:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),i&&null!=t&&t.temporary&&delete t.temporary,this._destination=t,this._uid=e,this._maxUid=Math.max(this._maxUid,e),this._numPositionUpdates=0}},{key:"_parseCurrentHash",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],e=unescape(getCurrentHash()).substring(1),i=(0,_ui_utils.parseQueryString)(e),n=i.nameddest||"",r=0|i.page;return(!this._isValidPage(r)||t&&0<n.length)&&(r=null),{hash:e,page:r,rotation:this.linkService.rotation}}},{key:"_updateViewarea",value:function(t){var e=this,i=t.location;this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:this._isViewerInPresentationMode?"page=".concat(i.pageNumber):i.pdfOpenParams.substring(1),page:this.linkService.page,first:i.pageNumber,rotation:i.rotation},this._popStateInProgress||(0<POSITION_UPDATED_THRESHOLD&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,0<UPDATE_VIEWAREA_TIMEOUT&&(this._updateViewareaTimeout=setTimeout(function(){e._popStateInProgress||e._tryPushCurrentPosition(!0),e._updateViewareaTimeout=null},UPDATE_VIEWAREA_TIMEOUT)))}},{key:"_popState",value:function(t){var e=this,i=t.state,n=getCurrentHash(),r=this._currentHash!==n;if(this._currentHash=n,i){if(this._isValidState(i)){this._popStateInProgress=!0,r&&(this._blockHashChange++,(0,_ui_utils.waitOnEventOrTimeout)({target:window,name:"hashchange",delay:HASH_CHANGE_TIMEOUT}).then(function(){e._blockHashChange--}));var a=i.destination;this._updateInternalState(a,i.uid,!0),(0,_ui_utils.isValidRotation)(a.rotation)&&(this.linkService.rotation=a.rotation),a.dest?this.linkService.goToDestination(a.dest):a.hash?this.linkService.setHash(a.hash):a.page&&(this.linkService.page=a.page),Promise.resolve().then(function(){e._popStateInProgress=!1})}}else{this._uid++;var s=this._parseCurrentHash(),o=s.hash,u=s.page,h=s.rotation;this._pushOrReplaceState({hash:o,page:u,rotation:h},!0)}}},{key:"_pageHide",value:function(){this._destination&&!this._destination.temporary||this._tryPushCurrentPosition()}},{key:"_bindEvents",value:function(){this._boundEvents||(this._boundEvents={updateViewarea:this._updateViewarea.bind(this),popState:this._popState.bind(this),pageHide:this._pageHide.bind(this)},this.eventBus._on("updateviewarea",this._boundEvents.updateViewarea),window.addEventListener("popstate",this._boundEvents.popState),window.addEventListener("pagehide",this._boundEvents.pageHide))}},{key:"_unbindEvents",value:function(){this._boundEvents&&(this.eventBus._off("updateviewarea",this._boundEvents.updateViewarea),window.removeEventListener("popstate",this._boundEvents.popState),window.removeEventListener("pagehide",this._boundEvents.pageHide),this._boundEvents=null)}}]),r}();function isDestHashesEqual(t,e){return"string"==typeof t&&"string"==typeof e&&(t===e||(0,_ui_utils.parseQueryString)(t).nameddest===e)}function isDestArraysEqual(t,e){function n(t,e){if(_typeof(t)!==_typeof(e))return!1;if(Array.isArray(t)||Array.isArray(e))return!1;if(null===t||"object"!==_typeof(t)||null===e)return t===e||Number.isNaN(t)&&Number.isNaN(e);if(Object.keys(t).length!==Object.keys(e).length)return!1;for(var i in t)if(!n(t[i],e[i]))return!1;return!0}if(!Array.isArray(t)||!Array.isArray(e))return!1;if(t.length!==e.length)return!1;for(var i=0,r=t.length;i<r;i++)if(!n(t[i],e[i]))return!1;return!0}exports.PDFHistory=PDFHistory;