"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);var n=i.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFThumbnailViewer=void 0;var _ui_utils=require("./ui_utils.js"),_pdf_thumbnail_view=require("./pdf_thumbnail_view.js"),_pdf_rendering_queue=require("./pdf_rendering_queue.js"),THUMBNAIL_SCROLL_MARGIN=-19,THUMBNAIL_SELECTED_CLASS="selected",PDFThumbnailViewer=function(){function o(e){var t=this,i=e.container,n=e.eventBus,r=e.linkService,s=e.renderingQueue,a=e.l10n;_classCallCheck(this,o),this.container=i,this.linkService=r,this.renderingQueue=s,this.l10n=a,this.scroll=(0,_ui_utils.watchScroll)(this.container,this._scrollUpdated.bind(this)),this._resetView(),n._on("optionalcontentconfigchanged",function(){t._setImageDisabled=!0})}return _createClass(o,[{key:"_scrollUpdated",value:function(){this.renderingQueue.renderHighestPriority()}},{key:"getThumbnail",value:function(e){return this._thumbnails[e]}},{key:"_getVisibleThumbs",value:function(){return(0,_ui_utils.getVisibleElements)({scrollEl:this.container,views:this._thumbnails})}},{key:"scrollThumbnailIntoView",value:function(t){if(this.pdfDocument){var e=this._thumbnails[t-1];if(e){if(t!==this._currentPageNumber)this._thumbnails[this._currentPageNumber-1].div.classList.remove(THUMBNAIL_SELECTED_CLASS),e.div.classList.add(THUMBNAIL_SELECTED_CLASS);var i=this._getVisibleThumbs(),n=i.views.length;if(0<n){var r=i.first.id,s=1<n?i.last.id:r,a=!1;t<=r||s<=t?a=!0:i.views.some(function(e){return e.id===t&&(a=e.percent<100,!0)}),a&&(0,_ui_utils.scrollIntoView)(e.div,{top:THUMBNAIL_SCROLL_MARGIN})}this._currentPageNumber=t}else console.error('scrollThumbnailIntoView: Invalid "pageNumber" parameter.')}}},{key:"pagesRotation",get:function(){return this._pagesRotation},set:function(e){if(!(0,_ui_utils.isValidRotation)(e))throw new Error("Invalid thumbnails rotation angle.");if(this.pdfDocument&&this._pagesRotation!==e){this._pagesRotation=e;for(var t=0,i=this._thumbnails.length;t<i;t++)this._thumbnails[t].update(e)}}},{key:"cleanup",value:function(){for(var e=0,t=this._thumbnails.length;e<t;e++)this._thumbnails[e]&&this._thumbnails[e].renderingState!==_pdf_rendering_queue.RenderingStates.FINISHED&&this._thumbnails[e].reset();_pdf_thumbnail_view.TempImageFactory.destroyCanvas()}},{key:"_resetView",value:function(){this._thumbnails=[],this._currentPageNumber=1,this._pageLabels=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._pagesRequests=new WeakMap,this._setImageDisabled=!1,this.container.textContent=""}},{key:"setDocument",value:function(o){var u=this;if(this.pdfDocument&&(this._cancelRendering(),this._resetView()),this.pdfDocument=o){var e=o.getPage(1),l=o.getOptionalContentConfig();e.then(function(e){u._optionalContentConfigPromise=l;for(var t=o.numPages,i=e.getViewport({scale:1}),n=function(){return u._setImageDisabled},r=1;r<=t;++r){var s=new _pdf_thumbnail_view.PDFThumbnailView({container:u.container,id:r,defaultViewport:i.clone(),optionalContentConfigPromise:l,linkService:u.linkService,renderingQueue:u.renderingQueue,checkSetImageDisabled:n,disableCanvasToImageConversion:!1,l10n:u.l10n});u._thumbnails.push(s)}var a=u._thumbnails[0];a&&a.setPdfPage(e),u._thumbnails[u._currentPageNumber-1].div.classList.add(THUMBNAIL_SELECTED_CLASS)}).catch(function(e){console.error("Unable to initialize thumbnail viewer",e)})}}},{key:"_cancelRendering",value:function(){for(var e=0,t=this._thumbnails.length;e<t;e++)this._thumbnails[e]&&this._thumbnails[e].cancelRendering()}},{key:"setPageLabels",value:function(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("PDFThumbnailViewer_setPageLabels: Invalid page labels.")):this._pageLabels=null;for(var t=0,i=this._thumbnails.length;t<i;t++){var n,r;this._thumbnails[t].setPageLabel(null!==(n=null===(r=this._pageLabels)||void 0===r?void 0:r[t])&&void 0!==n?n:null)}}}},{key:"_ensurePdfPageLoaded",value:function(t){var i=this;if(t.pdfPage)return Promise.resolve(t.pdfPage);if(this._pagesRequests.has(t))return this._pagesRequests.get(t);var e=this.pdfDocument.getPage(t.id).then(function(e){return t.pdfPage||t.setPdfPage(e),i._pagesRequests.delete(t),e}).catch(function(e){console.error("Unable to get page for thumb view",e),i._pagesRequests.delete(t)});return this._pagesRequests.set(t,e),e}},{key:"forceRendering",value:function(){var e=this,t=this._getVisibleThumbs(),i=this.renderingQueue.getHighestPriority(t,this._thumbnails,this.scroll.down);return!!i&&(this._ensurePdfPageLoaded(i).then(function(){e.renderingQueue.renderView(i)}),!0)}}]),o}();exports.PDFThumbnailViewer=PDFThumbnailViewer;