"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var i=n.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextLayerBuilder=exports.DefaultTextLayerFactory=void 0;var _pdf=require("../pdf"),EXPAND_DIVS_TIMEOUT=300,TextLayerBuilder=function(){function d(e){var t=e.textLayerDiv,n=e.eventBus,i=e.pageIndex,r=e.viewport,a=e.findController,o=void 0===a?null:a,s=e.enhanceTextSelection,l=void 0!==s&&s;_classCallCheck(this,d),this.textLayerDiv=t,this.eventBus=n,this.textContent=null,this.textContentItemsStr=[],this.textContentStream=null,this.renderingDone=!1,this.pageIdx=i,this.pageNumber=this.pageIdx+1,this.matches=[],this.viewport=r,this.textDivs=[],this.findController=o,this.textLayerRenderTask=null,this.enhanceTextSelection=l,this._onUpdateTextLayerMatches=null,this._bindMouse()}return _createClass(d,[{key:"_finishRendering",value:function(){if(this.renderingDone=!0,!this.enhanceTextSelection){var e=document.createElement("div");e.className="endOfContent",this.textLayerDiv.appendChild(e)}this.eventBus.dispatch("textlayerrendered",{source:this,pageNumber:this.pageNumber,numTextDivs:this.textDivs.length})}},{key:"render",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;if((this.textContent||this.textContentStream)&&!this.renderingDone){this.cancel(),this.textDivs=[];var n=document.createDocumentFragment();this.textLayerRenderTask=(0,_pdf.renderTextLayer)({textContent:this.textContent,textContentStream:this.textContentStream,container:n,viewport:this.viewport,textDivs:this.textDivs,textContentItemsStr:this.textContentItemsStr,timeout:e,enhanceTextSelection:this.enhanceTextSelection}),this.textLayerRenderTask.promise.then(function(){t.textLayerDiv.appendChild(n),t._finishRendering(),t._updateMatches()},function(e){}),this._onUpdateTextLayerMatches||(this._onUpdateTextLayerMatches=function(e){e.pageIndex!==t.pageIdx&&-1!==e.pageIndex||t._updateMatches()},this.eventBus._on("updatetextlayermatches",this._onUpdateTextLayerMatches))}}},{key:"cancel",value:function(){this.textLayerRenderTask&&(this.textLayerRenderTask.cancel(),this.textLayerRenderTask=null),this._onUpdateTextLayerMatches&&(this.eventBus._off("updatetextlayermatches",this._onUpdateTextLayerMatches),this._onUpdateTextLayerMatches=null)}},{key:"setTextContentStream",value:function(e){this.cancel(),this.textContentStream=e}},{key:"setTextContent",value:function(e){this.cancel(),this.textContent=e}},{key:"_convertMatches",value:function(e,t){if(!e)return[];for(var n=this.textContentItemsStr,i=0,r=0,a=n.length-1,o=[],s=0,l=e.length;s<l;s++){for(var d=e[s];i!==a&&d>=r+n[i].length;)r+=n[i].length,i++;i===n.length&&console.error("Could not find a matching mapping");var h={begin:{divIdx:i,offset:d-r}};for(d+=t[s];i!==a&&d>r+n[i].length;)r+=n[i].length,i++;h.end={divIdx:i,offset:d-r},o.push(h)}return o}},{key:"_renderMatches",value:function(e){if(0!==e.length){var t=this.findController,n=this.pageIdx,l=this.textContentItemsStr,d=this.textDivs,i=n===t.selected.pageIdx,r=t.selected.matchIdx,a=null,o={divIdx:-1,offset:void 0},s=r,h=s+1;if(t.state.highlightAll)s=0,h=e.length;else if(!i)return;for(var c=s;c<h;c++){var u=e[c],f=u.begin,x=u.end,v=i&&c===r,p=v?" selected":"";if(v&&t.scrollMatchIntoView({element:d[f.divIdx],pageIndex:n,matchIndex:r}),a&&f.divIdx===a.divIdx?T(a.divIdx,a.offset,f.offset):(null!==a&&T(a.divIdx,a.offset,o.offset),m(f)),f.divIdx===x.divIdx)T(f.divIdx,f.offset,x.offset,"highlight"+p);else{T(f.divIdx,f.offset,o.offset,"highlight begin"+p);for(var y=f.divIdx+1,g=x.divIdx;y<g;y++)d[y].className="highlight middle"+p;m(x,"highlight end"+p)}a=x}a&&T(a.divIdx,a.offset,o.offset)}function m(e,t){var n=e.divIdx;d[n].textContent="",T(n,0,e.offset,t)}function T(e,t,n,i){var r=d[e],a=l[e].substring(t,n),o=document.createTextNode(a);if(i){var s=document.createElement("span");return s.className=i,s.appendChild(o),void r.appendChild(s)}r.appendChild(o)}}},{key:"_updateMatches",value:function(){if(this.renderingDone){for(var e=this.findController,t=this.matches,n=this.pageIdx,i=this.textContentItemsStr,r=this.textDivs,a=-1,o=0,s=t.length;o<s;o++){for(var l=t[o],d=Math.max(a,l.begin.divIdx),h=l.end.divIdx;d<=h;d++){var c=r[d];c.textContent=i[d],c.className=""}a=l.end.divIdx+1}if(null!=e&&e.highlightMatches){var u=e.pageMatches[n]||null,f=e.pageMatchesLength[n]||null;this.matches=this._convertMatches(u,f),this._renderMatches(this.matches)}}}},{key:"_bindMouse",value:function(){var a=this,o=this.textLayerDiv,s=null;o.addEventListener("mousedown",function(e){if(a.enhanceTextSelection&&a.textLayerRenderTask)return a.textLayerRenderTask.expandTextDivs(!0),void(s&&(clearTimeout(s),s=null));var t=o.querySelector(".endOfContent");if(t){var n=e.target!==o;if(n=n&&"none"!==window.getComputedStyle(t).getPropertyValue("-moz-user-select")){var i=o.getBoundingClientRect(),r=Math.max(0,(e.pageY-i.top)/i.height);t.style.top=(100*r).toFixed(2)+"%"}t.classList.add("active")}}),o.addEventListener("mouseup",function(){if(a.enhanceTextSelection&&a.textLayerRenderTask)s=setTimeout(function(){a.textLayerRenderTask&&a.textLayerRenderTask.expandTextDivs(!1),s=null},EXPAND_DIVS_TIMEOUT);else{var e=o.querySelector(".endOfContent");e&&(e.style.top="",e.classList.remove("active"))}})}}]),d}();exports.TextLayerBuilder=TextLayerBuilder;var DefaultTextLayerFactory=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"createTextLayerBuilder",value:function(e,t,n){var i=3<arguments.length&&void 0!==arguments[3]&&arguments[3],r=4<arguments.length?arguments[4]:void 0;return new TextLayerBuilder({textLayerDiv:e,pageIndex:t,viewport:n,enhanceTextSelection:i,eventBus:r})}}]),e}();exports.DefaultTextLayerFactory=DefaultTextLayerFactory;