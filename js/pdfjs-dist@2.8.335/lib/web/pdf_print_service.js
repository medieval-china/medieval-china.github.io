"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFPrintService=PDFPrintService;var _app=require("./app.js"),_viewer_compatibility=require("./viewer_compatibility.js"),activeService=null,overlayManager=null;function renderPage(e,r,t,i,n,a){var o=activeService.scratchCanvas,c=n/72;o.width=Math.floor(i.width*c),o.height=Math.floor(i.height*c);var s=o.getContext("2d");return s.save(),s.fillStyle="rgb(255, 255, 255)",s.fillRect(0,0,o.width,o.height),s.restore(),r.getPage(t).then(function(e){var t={canvasContext:s,transform:[c,0,0,c,0,0],viewport:e.getViewport({scale:1,rotation:i.rotation}),intent:"print",annotationStorage:r.annotationStorage,optionalContentConfigPromise:a};return e.render(t).promise})}function PDFPrintService(e,t,r,i){var n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,a=5<arguments.length?arguments[5]:void 0;this.pdfDocument=e,this.pagesOverview=t,this.printContainer=r,this._printResolution=i||150,this._optionalContentConfigPromise=n||e.getOptionalContentConfig(),this.l10n=a,this.currentPage=-1,this.scratchCanvas=document.createElement("canvas")}PDFPrintService.prototype={layout:function(){this.throwIfInactive();var e=document.querySelector("body");e.setAttribute("data-pdfjsprinting",!0),this.pagesOverview.every(function(e){return e.width===this.pagesOverview[0].width&&e.height===this.pagesOverview[0].height},this)||console.warn("Not all pages have the same size. The printed result may be incorrect!"),this.pageStyleSheet=document.createElement("style");var t=this.pagesOverview[0];this.pageStyleSheet.textContent="@page { size: "+t.width+"pt "+t.height+"pt;}",e.appendChild(this.pageStyleSheet)},destroy:function(){activeService===this&&(this.printContainer.textContent="",document.querySelector("body").removeAttribute("data-pdfjsprinting"),this.pageStyleSheet&&(this.pageStyleSheet.remove(),this.pageStyleSheet=null),this.scratchCanvas.width=this.scratchCanvas.height=0,this.scratchCanvas=null,activeService=null,ensureOverlay().then(function(){"printServiceOverlay"===overlayManager.active&&overlayManager.close("printServiceOverlay")}))},renderPages:function(){var n=this,a=this.pagesOverview.length;return new Promise(function e(t,r){if(n.throwIfInactive(),++n.currentPage>=a)return renderProgress(a,a,n.l10n),void t();var i=n.currentPage;renderProgress(i,a,n.l10n),renderPage(n,n.pdfDocument,i+1,n.pagesOverview[i],n._printResolution,n._optionalContentConfigPromise).then(n.useRenderedPage.bind(n)).then(function(){e(t,r)},r)})},useRenderedPage:function(){this.throwIfInactive();var r=document.createElement("img"),e=this.scratchCanvas;"toBlob"in e&&!_viewer_compatibility.viewerCompatibilityParams.disableCreateObjectURL?e.toBlob(function(e){r.src=URL.createObjectURL(e)}):r.src=e.toDataURL();var t=document.createElement("div");return t.appendChild(r),this.printContainer.appendChild(t),new Promise(function(e,t){r.onload=e,r.onerror=t})},performPrint:function(){var t=this;return this.throwIfInactive(),new Promise(function(e){setTimeout(function(){t.active?(print.call(window),setTimeout(e,20)):e()},0)})},get active(){return this===activeService},throwIfInactive:function(){if(!this.active)throw new Error("This print request was cancelled or completed.")}};var overlayPromise,print=window.print;function dispatchEvent(e){var t=document.createEvent("CustomEvent");t.initCustomEvent(e,!1,!1,"custom"),window.dispatchEvent(t)}function abort(){activeService&&(activeService.destroy(),dispatchEvent("afterprint"))}function renderProgress(e,t,r){var i=document.getElementById("printServiceOverlay"),n=Math.round(100*e/t),a=i.querySelector("progress"),o=i.querySelector(".relative-progress");a.value=n,r.get("print_progress_percent",{progress:n}).then(function(e){o.textContent=e})}if(window.print=function(){if(activeService)console.warn("Ignored window.print() because of a pending print job.");else{ensureOverlay().then(function(){activeService&&overlayManager.open("printServiceOverlay")});try{dispatchEvent("beforeprint")}finally{if(!activeService)return console.error("Expected print service to be initialized."),void ensureOverlay().then(function(){"printServiceOverlay"===overlayManager.active&&overlayManager.close("printServiceOverlay")});var e=activeService;activeService.renderPages().then(function(){return e.performPrint()}).catch(function(){}).then(function(){e.active&&abort()})}}},window.addEventListener("keydown",function(e){80!==e.keyCode||!e.ctrlKey&&!e.metaKey||e.altKey||e.shiftKey&&!window.chrome&&!window.opera||(window.print(),e.preventDefault(),e.stopImmediatePropagation?e.stopImmediatePropagation():e.stopPropagation())},!0),"onbeforeprint"in window){var stopPropagationIfNeeded=function(e){"custom"!==e.detail&&e.stopImmediatePropagation&&e.stopImmediatePropagation()};window.addEventListener("beforeprint",stopPropagationIfNeeded),window.addEventListener("afterprint",stopPropagationIfNeeded)}function ensureOverlay(){if(!overlayPromise){if(!(overlayManager=_app.PDFViewerApplication.overlayManager))throw new Error("The overlay manager has not yet been initialized.");overlayPromise=overlayManager.register("printServiceOverlay",document.getElementById("printServiceOverlay"),abort,!0),document.getElementById("printCancel").onclick=abort}return overlayPromise}_app.PDFPrintServiceFactory.instance={supportsPrinting:!0,createPrintService:function(e,t,r,i,n,a){if(activeService)throw new Error("The print service is created and active.");return activeService=new PDFPrintService(e,t,r,i,n,a)}};